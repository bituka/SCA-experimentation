(function () {
    var root = this;
    var previousUnderscore = root._;
    var ArrayProto = Array.prototype, ObjProto = Object.prototype, FuncProto = Function.prototype;
    var push = ArrayProto.push, slice = ArrayProto.slice, concat = ArrayProto.concat, toString = ObjProto.toString, hasOwnProperty = ObjProto.hasOwnProperty;
    var nativeIsArray = Array.isArray, nativeKeys = Object.keys, nativeBind = FuncProto.bind;
    var _ = function (obj) {
        if (obj instanceof _)
            return obj;
        if (!(this instanceof _))
            return new _(obj);
        this._wrapped = obj;
    };
    if (typeof exports !== 'undefined') {
        if (typeof module !== 'undefined' && module.exports) {
            exports = module.exports = _;
        }
        exports._ = _;
    } else {
        root._ = _;
    }
    _.VERSION = '1.7.0';
    var createCallback = function (func, context, argCount) {
        if (context === void 0)
            return func;
        switch (argCount == null ? 3 : argCount) {
        case 1:
            return function (value) {
                return func.call(context, value);
            };
        case 2:
            return function (value, other) {
                return func.call(context, value, other);
            };
        case 3:
            return function (value, index, collection) {
                return func.call(context, value, index, collection);
            };
        case 4:
            return function (accumulator, value, index, collection) {
                return func.call(context, accumulator, value, index, collection);
            };
        }
        return function () {
            return func.apply(context, arguments);
        };
    };
    _.iteratee = function (value, context, argCount) {
        if (value == null)
            return _.identity;
        if (_.isFunction(value))
            return createCallback(value, context, argCount);
        if (_.isObject(value))
            return _.matches(value);
        return _.property(value);
    };
    _.each = _.forEach = function (obj, iteratee, context) {
        if (obj == null)
            return obj;
        iteratee = createCallback(iteratee, context);
        var i, length = obj.length;
        if (length === +length) {
            for (i = 0; i < length; i++) {
                iteratee(obj[i], i, obj);
            }
        } else {
            var keys = _.keys(obj);
            for (i = 0, length = keys.length; i < length; i++) {
                iteratee(obj[keys[i]], keys[i], obj);
            }
        }
        return obj;
    };
    _.map = _.collect = function (obj, iteratee, context) {
        if (obj == null)
            return [];
        iteratee = _.iteratee(iteratee, context);
        var keys = obj.length !== +obj.length && _.keys(obj), length = (keys || obj).length, results = Array(length), currentKey;
        for (var index = 0; index < length; index++) {
            currentKey = keys ? keys[index] : index;
            results[index] = iteratee(obj[currentKey], currentKey, obj);
        }
        return results;
    };
    var reduceError = 'Reduce of empty array with no initial value';
    _.reduce = _.foldl = _.inject = function (obj, iteratee, memo, context) {
        if (obj == null)
            obj = [];
        iteratee = createCallback(iteratee, context, 4);
        var keys = obj.length !== +obj.length && _.keys(obj), length = (keys || obj).length, index = 0, currentKey;
        if (arguments.length < 3) {
            if (!length)
                throw new TypeError(reduceError);
            memo = obj[keys ? keys[index++] : index++];
        }
        for (; index < length; index++) {
            currentKey = keys ? keys[index] : index;
            memo = iteratee(memo, obj[currentKey], currentKey, obj);
        }
        return memo;
    };
    _.reduceRight = _.foldr = function (obj, iteratee, memo, context) {
        if (obj == null)
            obj = [];
        iteratee = createCallback(iteratee, context, 4);
        var keys = obj.length !== +obj.length && _.keys(obj), index = (keys || obj).length, currentKey;
        if (arguments.length < 3) {
            if (!index)
                throw new TypeError(reduceError);
            memo = obj[keys ? keys[--index] : --index];
        }
        while (index--) {
            currentKey = keys ? keys[index] : index;
            memo = iteratee(memo, obj[currentKey], currentKey, obj);
        }
        return memo;
    };
    _.find = _.detect = function (obj, predicate, context) {
        var result;
        predicate = _.iteratee(predicate, context);
        _.some(obj, function (value, index, list) {
            if (predicate(value, index, list)) {
                result = value;
                return true;
            }
        });
        return result;
    };
    _.filter = _.select = function (obj, predicate, context) {
        var results = [];
        if (obj == null)
            return results;
        predicate = _.iteratee(predicate, context);
        _.each(obj, function (value, index, list) {
            if (predicate(value, index, list))
                results.push(value);
        });
        return results;
    };
    _.reject = function (obj, predicate, context) {
        return _.filter(obj, _.negate(_.iteratee(predicate)), context);
    };
    _.every = _.all = function (obj, predicate, context) {
        if (obj == null)
            return true;
        predicate = _.iteratee(predicate, context);
        var keys = obj.length !== +obj.length && _.keys(obj), length = (keys || obj).length, index, currentKey;
        for (index = 0; index < length; index++) {
            currentKey = keys ? keys[index] : index;
            if (!predicate(obj[currentKey], currentKey, obj))
                return false;
        }
        return true;
    };
    _.some = _.any = function (obj, predicate, context) {
        if (obj == null)
            return false;
        predicate = _.iteratee(predicate, context);
        var keys = obj.length !== +obj.length && _.keys(obj), length = (keys || obj).length, index, currentKey;
        for (index = 0; index < length; index++) {
            currentKey = keys ? keys[index] : index;
            if (predicate(obj[currentKey], currentKey, obj))
                return true;
        }
        return false;
    };
    _.contains = _.include = function (obj, target) {
        if (obj == null)
            return false;
        if (obj.length !== +obj.length)
            obj = _.values(obj);
        return _.indexOf(obj, target) >= 0;
    };
    _.invoke = function (obj, method) {
        var args = slice.call(arguments, 2);
        var isFunc = _.isFunction(method);
        return _.map(obj, function (value) {
            return (isFunc ? method : value[method]).apply(value, args);
        });
    };
    _.pluck = function (obj, key) {
        return _.map(obj, _.property(key));
    };
    _.where = function (obj, attrs) {
        return _.filter(obj, _.matches(attrs));
    };
    _.findWhere = function (obj, attrs) {
        return _.find(obj, _.matches(attrs));
    };
    _.max = function (obj, iteratee, context) {
        var result = -Infinity, lastComputed = -Infinity, value, computed;
        if (iteratee == null && obj != null) {
            obj = obj.length === +obj.length ? obj : _.values(obj);
            for (var i = 0, length = obj.length; i < length; i++) {
                value = obj[i];
                if (value > result) {
                    result = value;
                }
            }
        } else {
            iteratee = _.iteratee(iteratee, context);
            _.each(obj, function (value, index, list) {
                computed = iteratee(value, index, list);
                if (computed > lastComputed || computed === -Infinity && result === -Infinity) {
                    result = value;
                    lastComputed = computed;
                }
            });
        }
        return result;
    };
    _.min = function (obj, iteratee, context) {
        var result = Infinity, lastComputed = Infinity, value, computed;
        if (iteratee == null && obj != null) {
            obj = obj.length === +obj.length ? obj : _.values(obj);
            for (var i = 0, length = obj.length; i < length; i++) {
                value = obj[i];
                if (value < result) {
                    result = value;
                }
            }
        } else {
            iteratee = _.iteratee(iteratee, context);
            _.each(obj, function (value, index, list) {
                computed = iteratee(value, index, list);
                if (computed < lastComputed || computed === Infinity && result === Infinity) {
                    result = value;
                    lastComputed = computed;
                }
            });
        }
        return result;
    };
    _.shuffle = function (obj) {
        var set = obj && obj.length === +obj.length ? obj : _.values(obj);
        var length = set.length;
        var shuffled = Array(length);
        for (var index = 0, rand; index < length; index++) {
            rand = _.random(0, index);
            if (rand !== index)
                shuffled[index] = shuffled[rand];
            shuffled[rand] = set[index];
        }
        return shuffled;
    };
    _.sample = function (obj, n, guard) {
        if (n == null || guard) {
            if (obj.length !== +obj.length)
                obj = _.values(obj);
            return obj[_.random(obj.length - 1)];
        }
        return _.shuffle(obj).slice(0, Math.max(0, n));
    };
    _.sortBy = function (obj, iteratee, context) {
        iteratee = _.iteratee(iteratee, context);
        return _.pluck(_.map(obj, function (value, index, list) {
            return {
                value: value,
                index: index,
                criteria: iteratee(value, index, list)
            };
        }).sort(function (left, right) {
            var a = left.criteria;
            var b = right.criteria;
            if (a !== b) {
                if (a > b || a === void 0)
                    return 1;
                if (a < b || b === void 0)
                    return -1;
            }
            return left.index - right.index;
        }), 'value');
    };
    var group = function (behavior) {
        return function (obj, iteratee, context) {
            var result = {};
            iteratee = _.iteratee(iteratee, context);
            _.each(obj, function (value, index) {
                var key = iteratee(value, index, obj);
                behavior(result, value, key);
            });
            return result;
        };
    };
    _.groupBy = group(function (result, value, key) {
        if (_.has(result, key))
            result[key].push(value);
        else
            result[key] = [value];
    });
    _.indexBy = group(function (result, value, key) {
        result[key] = value;
    });
    _.countBy = group(function (result, value, key) {
        if (_.has(result, key))
            result[key]++;
        else
            result[key] = 1;
    });
    _.sortedIndex = function (array, obj, iteratee, context) {
        iteratee = _.iteratee(iteratee, context, 1);
        var value = iteratee(obj);
        var low = 0, high = array.length;
        while (low < high) {
            var mid = low + high >>> 1;
            if (iteratee(array[mid]) < value)
                low = mid + 1;
            else
                high = mid;
        }
        return low;
    };
    _.toArray = function (obj) {
        if (!obj)
            return [];
        if (_.isArray(obj))
            return slice.call(obj);
        if (obj.length === +obj.length)
            return _.map(obj, _.identity);
        return _.values(obj);
    };
    _.size = function (obj) {
        if (obj == null)
            return 0;
        return obj.length === +obj.length ? obj.length : _.keys(obj).length;
    };
    _.partition = function (obj, predicate, context) {
        predicate = _.iteratee(predicate, context);
        var pass = [], fail = [];
        _.each(obj, function (value, key, obj) {
            (predicate(value, key, obj) ? pass : fail).push(value);
        });
        return [
            pass,
            fail
        ];
    };
    _.first = _.head = _.take = function (array, n, guard) {
        if (array == null)
            return void 0;
        if (n == null || guard)
            return array[0];
        if (n < 0)
            return [];
        return slice.call(array, 0, n);
    };
    _.initial = function (array, n, guard) {
        return slice.call(array, 0, Math.max(0, array.length - (n == null || guard ? 1 : n)));
    };
    _.last = function (array, n, guard) {
        if (array == null)
            return void 0;
        if (n == null || guard)
            return array[array.length - 1];
        return slice.call(array, Math.max(array.length - n, 0));
    };
    _.rest = _.tail = _.drop = function (array, n, guard) {
        return slice.call(array, n == null || guard ? 1 : n);
    };
    _.compact = function (array) {
        return _.filter(array, _.identity);
    };
    var flatten = function (input, shallow, strict, output) {
        if (shallow && _.every(input, _.isArray)) {
            return concat.apply(output, input);
        }
        for (var i = 0, length = input.length; i < length; i++) {
            var value = input[i];
            if (!_.isArray(value) && !_.isArguments(value)) {
                if (!strict)
                    output.push(value);
            } else if (shallow) {
                push.apply(output, value);
            } else {
                flatten(value, shallow, strict, output);
            }
        }
        return output;
    };
    _.flatten = function (array, shallow) {
        return flatten(array, shallow, false, []);
    };
    _.without = function (array) {
        return _.difference(array, slice.call(arguments, 1));
    };
    _.uniq = _.unique = function (array, isSorted, iteratee, context) {
        if (array == null)
            return [];
        if (!_.isBoolean(isSorted)) {
            context = iteratee;
            iteratee = isSorted;
            isSorted = false;
        }
        if (iteratee != null)
            iteratee = _.iteratee(iteratee, context);
        var result = [];
        var seen = [];
        for (var i = 0, length = array.length; i < length; i++) {
            var value = array[i];
            if (isSorted) {
                if (!i || seen !== value)
                    result.push(value);
                seen = value;
            } else if (iteratee) {
                var computed = iteratee(value, i, array);
                if (_.indexOf(seen, computed) < 0) {
                    seen.push(computed);
                    result.push(value);
                }
            } else if (_.indexOf(result, value) < 0) {
                result.push(value);
            }
        }
        return result;
    };
    _.union = function () {
        return _.uniq(flatten(arguments, true, true, []));
    };
    _.intersection = function (array) {
        if (array == null)
            return [];
        var result = [];
        var argsLength = arguments.length;
        for (var i = 0, length = array.length; i < length; i++) {
            var item = array[i];
            if (_.contains(result, item))
                continue;
            for (var j = 1; j < argsLength; j++) {
                if (!_.contains(arguments[j], item))
                    break;
            }
            if (j === argsLength)
                result.push(item);
        }
        return result;
    };
    _.difference = function (array) {
        var rest = flatten(slice.call(arguments, 1), true, true, []);
        return _.filter(array, function (value) {
            return !_.contains(rest, value);
        });
    };
    _.zip = function (array) {
        if (array == null)
            return [];
        var length = _.max(arguments, 'length').length;
        var results = Array(length);
        for (var i = 0; i < length; i++) {
            results[i] = _.pluck(arguments, i);
        }
        return results;
    };
    _.object = function (list, values) {
        if (list == null)
            return {};
        var result = {};
        for (var i = 0, length = list.length; i < length; i++) {
            if (values) {
                result[list[i]] = values[i];
            } else {
                result[list[i][0]] = list[i][1];
            }
        }
        return result;
    };
    _.indexOf = function (array, item, isSorted) {
        if (array == null)
            return -1;
        var i = 0, length = array.length;
        if (isSorted) {
            if (typeof isSorted == 'number') {
                i = isSorted < 0 ? Math.max(0, length + isSorted) : isSorted;
            } else {
                i = _.sortedIndex(array, item);
                return array[i] === item ? i : -1;
            }
        }
        for (; i < length; i++)
            if (array[i] === item)
                return i;
        return -1;
    };
    _.lastIndexOf = function (array, item, from) {
        if (array == null)
            return -1;
        var idx = array.length;
        if (typeof from == 'number') {
            idx = from < 0 ? idx + from + 1 : Math.min(idx, from + 1);
        }
        while (--idx >= 0)
            if (array[idx] === item)
                return idx;
        return -1;
    };
    _.range = function (start, stop, step) {
        if (arguments.length <= 1) {
            stop = start || 0;
            start = 0;
        }
        step = step || 1;
        var length = Math.max(Math.ceil((stop - start) / step), 0);
        var range = Array(length);
        for (var idx = 0; idx < length; idx++, start += step) {
            range[idx] = start;
        }
        return range;
    };
    var Ctor = function () {
    };
    _.bind = function (func, context) {
        var args, bound;
        if (nativeBind && func.bind === nativeBind)
            return nativeBind.apply(func, slice.call(arguments, 1));
        if (!_.isFunction(func))
            throw new TypeError('Bind must be called on a function');
        args = slice.call(arguments, 2);
        bound = function () {
            if (!(this instanceof bound))
                return func.apply(context, args.concat(slice.call(arguments)));
            Ctor.prototype = func.prototype;
            var self = new Ctor();
            Ctor.prototype = null;
            var result = func.apply(self, args.concat(slice.call(arguments)));
            if (_.isObject(result))
                return result;
            return self;
        };
        return bound;
    };
    _.partial = function (func) {
        var boundArgs = slice.call(arguments, 1);
        return function () {
            var position = 0;
            var args = boundArgs.slice();
            for (var i = 0, length = args.length; i < length; i++) {
                if (args[i] === _)
                    args[i] = arguments[position++];
            }
            while (position < arguments.length)
                args.push(arguments[position++]);
            return func.apply(this, args);
        };
    };
    _.bindAll = function (obj) {
        var i, length = arguments.length, key;
        if (length <= 1)
            throw new Error('bindAll must be passed function names');
        for (i = 1; i < length; i++) {
            key = arguments[i];
            obj[key] = _.bind(obj[key], obj);
        }
        return obj;
    };
    _.memoize = function (func, hasher) {
        var memoize = function (key) {
            var cache = memoize.cache;
            var address = hasher ? hasher.apply(this, arguments) : key;
            if (!_.has(cache, address))
                cache[address] = func.apply(this, arguments);
            return cache[address];
        };
        memoize.cache = {};
        return memoize;
    };
    _.delay = function (func, wait) {
        var args = slice.call(arguments, 2);
        return setTimeout(function () {
            return func.apply(null, args);
        }, wait);
    };
    _.defer = function (func) {
        return _.delay.apply(_, [
            func,
            1
        ].concat(slice.call(arguments, 1)));
    };
    _.throttle = function (func, wait, options) {
        var context, args, result;
        var timeout = null;
        var previous = 0;
        if (!options)
            options = {};
        var later = function () {
            previous = options.leading === false ? 0 : _.now();
            timeout = null;
            result = func.apply(context, args);
            if (!timeout)
                context = args = null;
        };
        return function () {
            var now = _.now();
            if (!previous && options.leading === false)
                previous = now;
            var remaining = wait - (now - previous);
            context = this;
            args = arguments;
            if (remaining <= 0 || remaining > wait) {
                clearTimeout(timeout);
                timeout = null;
                previous = now;
                result = func.apply(context, args);
                if (!timeout)
                    context = args = null;
            } else if (!timeout && options.trailing !== false) {
                timeout = setTimeout(later, remaining);
            }
            return result;
        };
    };
    _.debounce = function (func, wait, immediate) {
        var timeout, args, context, timestamp, result;
        var later = function () {
            var last = _.now() - timestamp;
            if (last < wait && last > 0) {
                timeout = setTimeout(later, wait - last);
            } else {
                timeout = null;
                if (!immediate) {
                    result = func.apply(context, args);
                    if (!timeout)
                        context = args = null;
                }
            }
        };
        return function () {
            context = this;
            args = arguments;
            timestamp = _.now();
            var callNow = immediate && !timeout;
            if (!timeout)
                timeout = setTimeout(later, wait);
            if (callNow) {
                result = func.apply(context, args);
                context = args = null;
            }
            return result;
        };
    };
    _.wrap = function (func, wrapper) {
        return _.partial(wrapper, func);
    };
    _.negate = function (predicate) {
        return function () {
            return !predicate.apply(this, arguments);
        };
    };
    _.compose = function () {
        var args = arguments;
        var start = args.length - 1;
        return function () {
            var i = start;
            var result = args[start].apply(this, arguments);
            while (i--)
                result = args[i].call(this, result);
            return result;
        };
    };
    _.after = function (times, func) {
        return function () {
            if (--times < 1) {
                return func.apply(this, arguments);
            }
        };
    };
    _.before = function (times, func) {
        var memo;
        return function () {
            if (--times > 0) {
                memo = func.apply(this, arguments);
            } else {
                func = null;
            }
            return memo;
        };
    };
    _.once = _.partial(_.before, 2);
    _.keys = function (obj) {
        if (!_.isObject(obj))
            return [];
        if (nativeKeys)
            return nativeKeys(obj);
        var keys = [];
        for (var key in obj)
            if (_.has(obj, key))
                keys.push(key);
        return keys;
    };
    _.values = function (obj) {
        var keys = _.keys(obj);
        var length = keys.length;
        var values = Array(length);
        for (var i = 0; i < length; i++) {
            values[i] = obj[keys[i]];
        }
        return values;
    };
    _.pairs = function (obj) {
        var keys = _.keys(obj);
        var length = keys.length;
        var pairs = Array(length);
        for (var i = 0; i < length; i++) {
            pairs[i] = [
                keys[i],
                obj[keys[i]]
            ];
        }
        return pairs;
    };
    _.invert = function (obj) {
        var result = {};
        var keys = _.keys(obj);
        for (var i = 0, length = keys.length; i < length; i++) {
            result[obj[keys[i]]] = keys[i];
        }
        return result;
    };
    _.functions = _.methods = function (obj) {
        var names = [];
        for (var key in obj) {
            if (_.isFunction(obj[key]))
                names.push(key);
        }
        return names.sort();
    };
    _.extend = function (obj) {
        if (!_.isObject(obj))
            return obj;
        var source, prop;
        for (var i = 1, length = arguments.length; i < length; i++) {
            source = arguments[i];
            for (prop in source) {
                if (hasOwnProperty.call(source, prop)) {
                    obj[prop] = source[prop];
                }
            }
        }
        return obj;
    };
    _.pick = function (obj, iteratee, context) {
        var result = {}, key;
        if (obj == null)
            return result;
        if (_.isFunction(iteratee)) {
            iteratee = createCallback(iteratee, context);
            for (key in obj) {
                var value = obj[key];
                if (iteratee(value, key, obj))
                    result[key] = value;
            }
        } else {
            var keys = concat.apply([], slice.call(arguments, 1));
            obj = new Object(obj);
            for (var i = 0, length = keys.length; i < length; i++) {
                key = keys[i];
                if (key in obj)
                    result[key] = obj[key];
            }
        }
        return result;
    };
    _.omit = function (obj, iteratee, context) {
        if (_.isFunction(iteratee)) {
            iteratee = _.negate(iteratee);
        } else {
            var keys = _.map(concat.apply([], slice.call(arguments, 1)), String);
            iteratee = function (value, key) {
                return !_.contains(keys, key);
            };
        }
        return _.pick(obj, iteratee, context);
    };
    _.defaults = function (obj) {
        if (!_.isObject(obj))
            return obj;
        for (var i = 1, length = arguments.length; i < length; i++) {
            var source = arguments[i];
            for (var prop in source) {
                if (obj[prop] === void 0)
                    obj[prop] = source[prop];
            }
        }
        return obj;
    };
    _.clone = function (obj) {
        if (!_.isObject(obj))
            return obj;
        return _.isArray(obj) ? obj.slice() : _.extend({}, obj);
    };
    _.tap = function (obj, interceptor) {
        interceptor(obj);
        return obj;
    };
    var eq = function (a, b, aStack, bStack) {
        if (a === b)
            return a !== 0 || 1 / a === 1 / b;
        if (a == null || b == null)
            return a === b;
        if (a instanceof _)
            a = a._wrapped;
        if (b instanceof _)
            b = b._wrapped;
        var className = toString.call(a);
        if (className !== toString.call(b))
            return false;
        switch (className) {
        case '[object RegExp]':
        case '[object String]':
            return '' + a === '' + b;
        case '[object Number]':
            if (+a !== +a)
                return +b !== +b;
            return +a === 0 ? 1 / +a === 1 / b : +a === +b;
        case '[object Date]':
        case '[object Boolean]':
            return +a === +b;
        }
        if (typeof a != 'object' || typeof b != 'object')
            return false;
        var length = aStack.length;
        while (length--) {
            if (aStack[length] === a)
                return bStack[length] === b;
        }
        var aCtor = a.constructor, bCtor = b.constructor;
        if (aCtor !== bCtor && 'constructor' in a && 'constructor' in b && !(_.isFunction(aCtor) && aCtor instanceof aCtor && _.isFunction(bCtor) && bCtor instanceof bCtor)) {
            return false;
        }
        aStack.push(a);
        bStack.push(b);
        var size, result;
        if (className === '[object Array]') {
            size = a.length;
            result = size === b.length;
            if (result) {
                while (size--) {
                    if (!(result = eq(a[size], b[size], aStack, bStack)))
                        break;
                }
            }
        } else {
            var keys = _.keys(a), key;
            size = keys.length;
            result = _.keys(b).length === size;
            if (result) {
                while (size--) {
                    key = keys[size];
                    if (!(result = _.has(b, key) && eq(a[key], b[key], aStack, bStack)))
                        break;
                }
            }
        }
        aStack.pop();
        bStack.pop();
        return result;
    };
    _.isEqual = function (a, b) {
        return eq(a, b, [], []);
    };
    _.isEmpty = function (obj) {
        if (obj == null)
            return true;
        if (_.isArray(obj) || _.isString(obj) || _.isArguments(obj))
            return obj.length === 0;
        for (var key in obj)
            if (_.has(obj, key))
                return false;
        return true;
    };
    _.isElement = function (obj) {
        return !!(obj && obj.nodeType === 1);
    };
    _.isArray = nativeIsArray || function (obj) {
        return toString.call(obj) === '[object Array]';
    };
    _.isObject = function (obj) {
        var type = typeof obj;
        return type === 'function' || type === 'object' && !!obj;
    };
    _.each([
        'Arguments',
        'Function',
        'String',
        'Number',
        'Date',
        'RegExp'
    ], function (name) {
        _['is' + name] = function (obj) {
            return toString.call(obj) === '[object ' + name + ']';
        };
    });
    if (!_.isArguments(arguments)) {
        _.isArguments = function (obj) {
            return _.has(obj, 'callee');
        };
    }
    if (typeof /./ !== 'function') {
        _.isFunction = function (obj) {
            return typeof obj == 'function' || false;
        };
    }
    _.isFinite = function (obj) {
        return isFinite(obj) && !isNaN(parseFloat(obj));
    };
    _.isNaN = function (obj) {
        return _.isNumber(obj) && obj !== +obj;
    };
    _.isBoolean = function (obj) {
        return obj === true || obj === false || toString.call(obj) === '[object Boolean]';
    };
    _.isNull = function (obj) {
        return obj === null;
    };
    _.isUndefined = function (obj) {
        return obj === void 0;
    };
    _.has = function (obj, key) {
        return obj != null && hasOwnProperty.call(obj, key);
    };
    _.noConflict = function () {
        root._ = previousUnderscore;
        return this;
    };
    _.identity = function (value) {
        return value;
    };
    _.constant = function (value) {
        return function () {
            return value;
        };
    };
    _.noop = function () {
    };
    _.property = function (key) {
        return function (obj) {
            return obj[key];
        };
    };
    _.matches = function (attrs) {
        var pairs = _.pairs(attrs), length = pairs.length;
        return function (obj) {
            if (obj == null)
                return !length;
            obj = new Object(obj);
            for (var i = 0; i < length; i++) {
                var pair = pairs[i], key = pair[0];
                if (pair[1] !== obj[key] || !(key in obj))
                    return false;
            }
            return true;
        };
    };
    _.times = function (n, iteratee, context) {
        var accum = Array(Math.max(0, n));
        iteratee = createCallback(iteratee, context, 1);
        for (var i = 0; i < n; i++)
            accum[i] = iteratee(i);
        return accum;
    };
    _.random = function (min, max) {
        if (max == null) {
            max = min;
            min = 0;
        }
        return min + Math.floor(Math.random() * (max - min + 1));
    };
    _.now = Date.now || function () {
        return new Date().getTime();
    };
    var escapeMap = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        '\'': '&#x27;',
        '`': '&#x60;'
    };
    var unescapeMap = _.invert(escapeMap);
    var createEscaper = function (map) {
        var escaper = function (match) {
            return map[match];
        };
        var source = '(?:' + _.keys(map).join('|') + ')';
        var testRegexp = RegExp(source);
        var replaceRegexp = RegExp(source, 'g');
        return function (string) {
            string = string == null ? '' : '' + string;
            return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
        };
    };
    _.escape = createEscaper(escapeMap);
    _.unescape = createEscaper(unescapeMap);
    _.result = function (object, property) {
        if (object == null)
            return void 0;
        var value = object[property];
        return _.isFunction(value) ? object[property]() : value;
    };
    var idCounter = 0;
    _.uniqueId = function (prefix) {
        var id = ++idCounter + '';
        return prefix ? prefix + id : id;
    };
    _.templateSettings = {
        evaluate: /<%([\s\S]+?)%>/g,
        interpolate: /<%=([\s\S]+?)%>/g,
        escape: /<%-([\s\S]+?)%>/g
    };
    var noMatch = /(.)^/;
    var escapes = {
        '\'': '\'',
        '\\': '\\',
        '\r': 'r',
        '\n': 'n',
        '\u2028': 'u2028',
        '\u2029': 'u2029'
    };
    var escaper = /\\|'|\r|\n|\u2028|\u2029/g;
    var escapeChar = function (match) {
        return '\\' + escapes[match];
    };
    _.template = function (text, settings, oldSettings) {
        if (!settings && oldSettings)
            settings = oldSettings;
        settings = _.defaults({}, settings, _.templateSettings);
        var matcher = RegExp([
            (settings.escape || noMatch).source,
            (settings.interpolate || noMatch).source,
            (settings.evaluate || noMatch).source
        ].join('|') + '|$', 'g');
        var index = 0;
        var source = '__p+=\'';
        text.replace(matcher, function (match, escape, interpolate, evaluate, offset) {
            source += text.slice(index, offset).replace(escaper, escapeChar);
            index = offset + match.length;
            if (escape) {
                source += '\'+\n((__t=(' + escape + '))==null?\'\':_.escape(__t))+\n\'';
            } else if (interpolate) {
                source += '\'+\n((__t=(' + interpolate + '))==null?\'\':__t)+\n\'';
            } else if (evaluate) {
                source += '\';\n' + evaluate + '\n__p+=\'';
            }
            return match;
        });
        source += '\';\n';
        if (!settings.variable)
            source = 'with(obj||{}){\n' + source + '}\n';
        source = 'var __t,__p=\'\',__j=Array.prototype.join,' + 'print=function(){__p+=__j.call(arguments,\'\');};\n' + source + 'return __p;\n';
        try {
            var render = new Function(settings.variable || 'obj', '_', source);
        } catch (e) {
            e.source = source;
            throw e;
        }
        var template = function (data) {
            return render.call(this, data, _);
        };
        var argument = settings.variable || 'obj';
        template.source = 'function(' + argument + '){\n' + source + '}';
        return template;
    };
    _.chain = function (obj) {
        var instance = _(obj);
        instance._chain = true;
        return instance;
    };
    var result = function (obj) {
        return this._chain ? _(obj).chain() : obj;
    };
    _.mixin = function (obj) {
        _.each(_.functions(obj), function (name) {
            var func = _[name] = obj[name];
            _.prototype[name] = function () {
                var args = [this._wrapped];
                push.apply(args, arguments);
                return result.call(this, func.apply(_, args));
            };
        });
    };
    _.mixin(_);
    _.each([
        'pop',
        'push',
        'reverse',
        'shift',
        'sort',
        'splice',
        'unshift'
    ], function (name) {
        var method = ArrayProto[name];
        _.prototype[name] = function () {
            var obj = this._wrapped;
            method.apply(obj, arguments);
            if ((name === 'shift' || name === 'splice') && obj.length === 0)
                delete obj[0];
            return result.call(this, obj);
        };
    });
    _.each([
        'concat',
        'join',
        'slice'
    ], function (name) {
        var method = ArrayProto[name];
        _.prototype[name] = function () {
            return result.call(this, method.apply(this._wrapped, arguments));
        };
    });
    _.prototype.value = function () {
        return this._wrapped;
    };
    if (typeof define === 'function' && define.amd) {
        define('underscore', [], function () {
            return _;
        });
    }
}.call(this));
define('jQuery', [], function () {
    (function (global, factory) {
        if (typeof module === 'object' && typeof module.exports === 'object') {
            module.exports = global.document ? factory(global, true) : function (w) {
                if (!w.document) {
                    throw new Error('jQuery requires a window with a document');
                }
                return factory(w);
            };
        } else {
            factory(global);
        }
    }(typeof window !== 'undefined' ? window : this, function (window, noGlobal) {
        var deletedIds = [];
        var slice = deletedIds.slice;
        var concat = deletedIds.concat;
        var push = deletedIds.push;
        var indexOf = deletedIds.indexOf;
        var class2type = {};
        var toString = class2type.toString;
        var hasOwn = class2type.hasOwnProperty;
        var support = {};
        var version = '1.11.1', jQuery = function (selector, context) {
                return new jQuery.fn.init(selector, context);
            }, rtrim = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, rmsPrefix = /^-ms-/, rdashAlpha = /-([\da-z])/gi, fcamelCase = function (all, letter) {
                return letter.toUpperCase();
            };
        jQuery.fn = jQuery.prototype = {
            jquery: version,
            constructor: jQuery,
            selector: '',
            length: 0,
            toArray: function () {
                return slice.call(this);
            },
            get: function (num) {
                return num != null ? num < 0 ? this[num + this.length] : this[num] : slice.call(this);
            },
            pushStack: function (elems) {
                var ret = jQuery.merge(this.constructor(), elems);
                ret.prevObject = this;
                ret.context = this.context;
                return ret;
            },
            each: function (callback, args) {
                return jQuery.each(this, callback, args);
            },
            map: function (callback) {
                return this.pushStack(jQuery.map(this, function (elem, i) {
                    return callback.call(elem, i, elem);
                }));
            },
            slice: function () {
                return this.pushStack(slice.apply(this, arguments));
            },
            first: function () {
                return this.eq(0);
            },
            last: function () {
                return this.eq(-1);
            },
            eq: function (i) {
                var len = this.length, j = +i + (i < 0 ? len : 0);
                return this.pushStack(j >= 0 && j < len ? [this[j]] : []);
            },
            end: function () {
                return this.prevObject || this.constructor(null);
            },
            push: push,
            sort: deletedIds.sort,
            splice: deletedIds.splice
        };
        jQuery.extend = jQuery.fn.extend = function () {
            var src, copyIsArray, copy, name, options, clone, target = arguments[0] || {}, i = 1, length = arguments.length, deep = false;
            if (typeof target === 'boolean') {
                deep = target;
                target = arguments[i] || {};
                i++;
            }
            if (typeof target !== 'object' && !jQuery.isFunction(target)) {
                target = {};
            }
            if (i === length) {
                target = this;
                i--;
            }
            for (; i < length; i++) {
                if ((options = arguments[i]) != null) {
                    for (name in options) {
                        src = target[name];
                        copy = options[name];
                        if (target === copy) {
                            continue;
                        }
                        if (deep && copy && (jQuery.isPlainObject(copy) || (copyIsArray = jQuery.isArray(copy)))) {
                            if (copyIsArray) {
                                copyIsArray = false;
                                clone = src && jQuery.isArray(src) ? src : [];
                            } else {
                                clone = src && jQuery.isPlainObject(src) ? src : {};
                            }
                            target[name] = jQuery.extend(deep, clone, copy);
                        } else if (copy !== undefined) {
                            target[name] = copy;
                        }
                    }
                }
            }
            return target;
        };
        jQuery.extend({
            expando: 'jQuery' + (version + Math.random()).replace(/\D/g, ''),
            isReady: true,
            error: function (msg) {
                throw new Error(msg);
            },
            noop: function () {
            },
            isFunction: function (obj) {
                return jQuery.type(obj) === 'function';
            },
            isArray: Array.isArray || function (obj) {
                return jQuery.type(obj) === 'array';
            },
            isWindow: function (obj) {
                return obj != null && obj == obj.window;
            },
            isNumeric: function (obj) {
                return !jQuery.isArray(obj) && obj - parseFloat(obj) >= 0;
            },
            isEmptyObject: function (obj) {
                var name;
                for (name in obj) {
                    return false;
                }
                return true;
            },
            isPlainObject: function (obj) {
                var key;
                if (!obj || jQuery.type(obj) !== 'object' || obj.nodeType || jQuery.isWindow(obj)) {
                    return false;
                }
                try {
                    if (obj.constructor && !hasOwn.call(obj, 'constructor') && !hasOwn.call(obj.constructor.prototype, 'isPrototypeOf')) {
                        return false;
                    }
                } catch (e) {
                    return false;
                }
                if (support.ownLast) {
                    for (key in obj) {
                        return hasOwn.call(obj, key);
                    }
                }
                for (key in obj) {
                }
                return key === undefined || hasOwn.call(obj, key);
            },
            type: function (obj) {
                if (obj == null) {
                    return obj + '';
                }
                return typeof obj === 'object' || typeof obj === 'function' ? class2type[toString.call(obj)] || 'object' : typeof obj;
            },
            globalEval: function (data) {
                if (data && jQuery.trim(data)) {
                    (window.execScript || function (data) {
                        window['eval'].call(window, data);
                    })(data);
                }
            },
            camelCase: function (string) {
                return string.replace(rmsPrefix, 'ms-').replace(rdashAlpha, fcamelCase);
            },
            nodeName: function (elem, name) {
                return elem.nodeName && elem.nodeName.toLowerCase() === name.toLowerCase();
            },
            each: function (obj, callback, args) {
                var value, i = 0, length = obj.length, isArray = isArraylike(obj);
                if (args) {
                    if (isArray) {
                        for (; i < length; i++) {
                            value = callback.apply(obj[i], args);
                            if (value === false) {
                                break;
                            }
                        }
                    } else {
                        for (i in obj) {
                            value = callback.apply(obj[i], args);
                            if (value === false) {
                                break;
                            }
                        }
                    }
                } else {
                    if (isArray) {
                        for (; i < length; i++) {
                            value = callback.call(obj[i], i, obj[i]);
                            if (value === false) {
                                break;
                            }
                        }
                    } else {
                        for (i in obj) {
                            value = callback.call(obj[i], i, obj[i]);
                            if (value === false) {
                                break;
                            }
                        }
                    }
                }
                return obj;
            },
            trim: function (text) {
                return text == null ? '' : (text + '').replace(rtrim, '');
            },
            makeArray: function (arr, results) {
                var ret = results || [];
                if (arr != null) {
                    if (isArraylike(Object(arr))) {
                        jQuery.merge(ret, typeof arr === 'string' ? [arr] : arr);
                    } else {
                        push.call(ret, arr);
                    }
                }
                return ret;
            },
            inArray: function (elem, arr, i) {
                var len;
                if (arr) {
                    if (indexOf) {
                        return indexOf.call(arr, elem, i);
                    }
                    len = arr.length;
                    i = i ? i < 0 ? Math.max(0, len + i) : i : 0;
                    for (; i < len; i++) {
                        if (i in arr && arr[i] === elem) {
                            return i;
                        }
                    }
                }
                return -1;
            },
            merge: function (first, second) {
                var len = +second.length, j = 0, i = first.length;
                while (j < len) {
                    first[i++] = second[j++];
                }
                if (len !== len) {
                    while (second[j] !== undefined) {
                        first[i++] = second[j++];
                    }
                }
                first.length = i;
                return first;
            },
            grep: function (elems, callback, invert) {
                var callbackInverse, matches = [], i = 0, length = elems.length, callbackExpect = !invert;
                for (; i < length; i++) {
                    callbackInverse = !callback(elems[i], i);
                    if (callbackInverse !== callbackExpect) {
                        matches.push(elems[i]);
                    }
                }
                return matches;
            },
            map: function (elems, callback, arg) {
                var value, i = 0, length = elems.length, isArray = isArraylike(elems), ret = [];
                if (isArray) {
                    for (; i < length; i++) {
                        value = callback(elems[i], i, arg);
                        if (value != null) {
                            ret.push(value);
                        }
                    }
                } else {
                    for (i in elems) {
                        value = callback(elems[i], i, arg);
                        if (value != null) {
                            ret.push(value);
                        }
                    }
                }
                return concat.apply([], ret);
            },
            guid: 1,
            proxy: function (fn, context) {
                var args, proxy, tmp;
                if (typeof context === 'string') {
                    tmp = fn[context];
                    context = fn;
                    fn = tmp;
                }
                if (!jQuery.isFunction(fn)) {
                    return undefined;
                }
                args = slice.call(arguments, 2);
                proxy = function () {
                    return fn.apply(context || this, args.concat(slice.call(arguments)));
                };
                proxy.guid = fn.guid = fn.guid || jQuery.guid++;
                return proxy;
            },
            now: function () {
                return +new Date();
            },
            support: support
        });
        jQuery.each('Boolean Number String Function Array Date RegExp Object Error'.split(' '), function (i, name) {
            class2type['[object ' + name + ']'] = name.toLowerCase();
        });
        function isArraylike(obj) {
            var length = obj.length, type = jQuery.type(obj);
            if (type === 'function' || jQuery.isWindow(obj)) {
                return false;
            }
            if (obj.nodeType === 1 && length) {
                return true;
            }
            return type === 'array' || length === 0 || typeof length === 'number' && length > 0 && length - 1 in obj;
        }
        var Sizzle = function (window) {
            var i, support, Expr, getText, isXML, tokenize, compile, select, outermostContext, sortInput, hasDuplicate, setDocument, document, docElem, documentIsHTML, rbuggyQSA, rbuggyMatches, matches, contains, expando = 'sizzle' + -new Date(), preferredDoc = window.document, dirruns = 0, done = 0, classCache = createCache(), tokenCache = createCache(), compilerCache = createCache(), sortOrder = function (a, b) {
                    if (a === b) {
                        hasDuplicate = true;
                    }
                    return 0;
                }, strundefined = typeof undefined, MAX_NEGATIVE = 1 << 31, hasOwn = {}.hasOwnProperty, arr = [], pop = arr.pop, push_native = arr.push, push = arr.push, slice = arr.slice, indexOf = arr.indexOf || function (elem) {
                    var i = 0, len = this.length;
                    for (; i < len; i++) {
                        if (this[i] === elem) {
                            return i;
                        }
                    }
                    return -1;
                }, booleans = 'checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped', whitespace = '[\\x20\\t\\r\\n\\f]', characterEncoding = '(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+', identifier = characterEncoding.replace('w', 'w#'), attributes = '\\[' + whitespace + '*(' + characterEncoding + ')(?:' + whitespace + '*([*^$|!~]?=)' + whitespace + '*(?:\'((?:\\\\.|[^\\\\\'])*)\'|"((?:\\\\.|[^\\\\"])*)"|(' + identifier + '))|)' + whitespace + '*\\]', pseudos = ':(' + characterEncoding + ')(?:\\((' + '(\'((?:\\\\.|[^\\\\\'])*)\'|"((?:\\\\.|[^\\\\"])*)")|' + '((?:\\\\.|[^\\\\()[\\]]|' + attributes + ')*)|' + '.*' + ')\\)|)', rtrim = new RegExp('^' + whitespace + '+|((?:^|[^\\\\])(?:\\\\.)*)' + whitespace + '+$', 'g'), rcomma = new RegExp('^' + whitespace + '*,' + whitespace + '*'), rcombinators = new RegExp('^' + whitespace + '*([>+~]|' + whitespace + ')' + whitespace + '*'), rattributeQuotes = new RegExp('=' + whitespace + '*([^\\]\'"]*?)' + whitespace + '*\\]', 'g'), rpseudo = new RegExp(pseudos), ridentifier = new RegExp('^' + identifier + '$'), matchExpr = {
                    'ID': new RegExp('^#(' + characterEncoding + ')'),
                    'CLASS': new RegExp('^\\.(' + characterEncoding + ')'),
                    'TAG': new RegExp('^(' + characterEncoding.replace('w', 'w*') + ')'),
                    'ATTR': new RegExp('^' + attributes),
                    'PSEUDO': new RegExp('^' + pseudos),
                    'CHILD': new RegExp('^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\(' + whitespace + '*(even|odd|(([+-]|)(\\d*)n|)' + whitespace + '*(?:([+-]|)' + whitespace + '*(\\d+)|))' + whitespace + '*\\)|)', 'i'),
                    'bool': new RegExp('^(?:' + booleans + ')$', 'i'),
                    'needsContext': new RegExp('^' + whitespace + '*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\(' + whitespace + '*((?:-\\d)?\\d*)' + whitespace + '*\\)|)(?=[^-]|$)', 'i')
                }, rinputs = /^(?:input|select|textarea|button)$/i, rheader = /^h\d$/i, rnative = /^[^{]+\{\s*\[native \w/, rquickExpr = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/, rsibling = /[+~]/, rescape = /'|\\/g, runescape = new RegExp('\\\\([\\da-f]{1,6}' + whitespace + '?|(' + whitespace + ')|.)', 'ig'), funescape = function (_, escaped, escapedWhitespace) {
                    var high = '0x' + escaped - 65536;
                    return high !== high || escapedWhitespace ? escaped : high < 0 ? String.fromCharCode(high + 65536) : String.fromCharCode(high >> 10 | 55296, high & 1023 | 56320);
                };
            try {
                push.apply(arr = slice.call(preferredDoc.childNodes), preferredDoc.childNodes);
                arr[preferredDoc.childNodes.length].nodeType;
            } catch (e) {
                push = {
                    apply: arr.length ? function (target, els) {
                        push_native.apply(target, slice.call(els));
                    } : function (target, els) {
                        var j = target.length, i = 0;
                        while (target[j++] = els[i++]) {
                        }
                        target.length = j - 1;
                    }
                };
            }
            function Sizzle(selector, context, results, seed) {
                var match, elem, m, nodeType, i, groups, old, nid, newContext, newSelector;
                if ((context ? context.ownerDocument || context : preferredDoc) !== document) {
                    setDocument(context);
                }
                context = context || document;
                results = results || [];
                if (!selector || typeof selector !== 'string') {
                    return results;
                }
                if ((nodeType = context.nodeType) !== 1 && nodeType !== 9) {
                    return [];
                }
                if (documentIsHTML && !seed) {
                    if (match = rquickExpr.exec(selector)) {
                        if (m = match[1]) {
                            if (nodeType === 9) {
                                elem = context.getElementById(m);
                                if (elem && elem.parentNode) {
                                    if (elem.id === m) {
                                        results.push(elem);
                                        return results;
                                    }
                                } else {
                                    return results;
                                }
                            } else {
                                if (context.ownerDocument && (elem = context.ownerDocument.getElementById(m)) && contains(context, elem) && elem.id === m) {
                                    results.push(elem);
                                    return results;
                                }
                            }
                        } else if (match[2]) {
                            push.apply(results, context.getElementsByTagName(selector));
                            return results;
                        } else if ((m = match[3]) && support.getElementsByClassName && context.getElementsByClassName) {
                            push.apply(results, context.getElementsByClassName(m));
                            return results;
                        }
                    }
                    if (support.qsa && (!rbuggyQSA || !rbuggyQSA.test(selector))) {
                        nid = old = expando;
                        newContext = context;
                        newSelector = nodeType === 9 && selector;
                        if (nodeType === 1 && context.nodeName.toLowerCase() !== 'object') {
                            groups = tokenize(selector);
                            if (old = context.getAttribute('id')) {
                                nid = old.replace(rescape, '\\$&');
                            } else {
                                context.setAttribute('id', nid);
                            }
                            nid = '[id=\'' + nid + '\'] ';
                            i = groups.length;
                            while (i--) {
                                groups[i] = nid + toSelector(groups[i]);
                            }
                            newContext = rsibling.test(selector) && testContext(context.parentNode) || context;
                            newSelector = groups.join(',');
                        }
                        if (newSelector) {
                            try {
                                push.apply(results, newContext.querySelectorAll(newSelector));
                                return results;
                            } catch (qsaError) {
                            } finally {
                                if (!old) {
                                    context.removeAttribute('id');
                                }
                            }
                        }
                    }
                }
                return select(selector.replace(rtrim, '$1'), context, results, seed);
            }
            function createCache() {
                var keys = [];
                function cache(key, value) {
                    if (keys.push(key + ' ') > Expr.cacheLength) {
                        delete cache[keys.shift()];
                    }
                    return cache[key + ' '] = value;
                }
                return cache;
            }
            function markFunction(fn) {
                fn[expando] = true;
                return fn;
            }
            function assert(fn) {
                var div = document.createElement('div');
                try {
                    return !!fn(div);
                } catch (e) {
                    return false;
                } finally {
                    if (div.parentNode) {
                        div.parentNode.removeChild(div);
                    }
                    div = null;
                }
            }
            function addHandle(attrs, handler) {
                var arr = attrs.split('|'), i = attrs.length;
                while (i--) {
                    Expr.attrHandle[arr[i]] = handler;
                }
            }
            function siblingCheck(a, b) {
                var cur = b && a, diff = cur && a.nodeType === 1 && b.nodeType === 1 && (~b.sourceIndex || MAX_NEGATIVE) - (~a.sourceIndex || MAX_NEGATIVE);
                if (diff) {
                    return diff;
                }
                if (cur) {
                    while (cur = cur.nextSibling) {
                        if (cur === b) {
                            return -1;
                        }
                    }
                }
                return a ? 1 : -1;
            }
            function createInputPseudo(type) {
                return function (elem) {
                    var name = elem.nodeName.toLowerCase();
                    return name === 'input' && elem.type === type;
                };
            }
            function createButtonPseudo(type) {
                return function (elem) {
                    var name = elem.nodeName.toLowerCase();
                    return (name === 'input' || name === 'button') && elem.type === type;
                };
            }
            function createPositionalPseudo(fn) {
                return markFunction(function (argument) {
                    argument = +argument;
                    return markFunction(function (seed, matches) {
                        var j, matchIndexes = fn([], seed.length, argument), i = matchIndexes.length;
                        while (i--) {
                            if (seed[j = matchIndexes[i]]) {
                                seed[j] = !(matches[j] = seed[j]);
                            }
                        }
                    });
                });
            }
            function testContext(context) {
                return context && typeof context.getElementsByTagName !== strundefined && context;
            }
            support = Sizzle.support = {};
            isXML = Sizzle.isXML = function (elem) {
                var documentElement = elem && (elem.ownerDocument || elem).documentElement;
                return documentElement ? documentElement.nodeName !== 'HTML' : false;
            };
            setDocument = Sizzle.setDocument = function (node) {
                var hasCompare, doc = node ? node.ownerDocument || node : preferredDoc, parent = doc.defaultView;
                if (doc === document || doc.nodeType !== 9 || !doc.documentElement) {
                    return document;
                }
                document = doc;
                docElem = doc.documentElement;
                documentIsHTML = !isXML(doc);
                if (parent && parent !== parent.top) {
                    if (parent.addEventListener) {
                        parent.addEventListener('unload', function () {
                            setDocument();
                        }, false);
                    } else if (parent.attachEvent) {
                        parent.attachEvent('onunload', function () {
                            setDocument();
                        });
                    }
                }
                support.attributes = assert(function (div) {
                    div.className = 'i';
                    return !div.getAttribute('className');
                });
                support.getElementsByTagName = assert(function (div) {
                    div.appendChild(doc.createComment(''));
                    return !div.getElementsByTagName('*').length;
                });
                support.getElementsByClassName = rnative.test(doc.getElementsByClassName) && assert(function (div) {
                    div.innerHTML = '<div class=\'a\'></div><div class=\'a i\'></div>';
                    div.firstChild.className = 'i';
                    return div.getElementsByClassName('i').length === 2;
                });
                support.getById = assert(function (div) {
                    docElem.appendChild(div).id = expando;
                    return !doc.getElementsByName || !doc.getElementsByName(expando).length;
                });
                if (support.getById) {
                    Expr.find['ID'] = function (id, context) {
                        if (typeof context.getElementById !== strundefined && documentIsHTML) {
                            var m = context.getElementById(id);
                            return m && m.parentNode ? [m] : [];
                        }
                    };
                    Expr.filter['ID'] = function (id) {
                        var attrId = id.replace(runescape, funescape);
                        return function (elem) {
                            return elem.getAttribute('id') === attrId;
                        };
                    };
                } else {
                    delete Expr.find['ID'];
                    Expr.filter['ID'] = function (id) {
                        var attrId = id.replace(runescape, funescape);
                        return function (elem) {
                            var node = typeof elem.getAttributeNode !== strundefined && elem.getAttributeNode('id');
                            return node && node.value === attrId;
                        };
                    };
                }
                Expr.find['TAG'] = support.getElementsByTagName ? function (tag, context) {
                    if (typeof context.getElementsByTagName !== strundefined) {
                        return context.getElementsByTagName(tag);
                    }
                } : function (tag, context) {
                    var elem, tmp = [], i = 0, results = context.getElementsByTagName(tag);
                    if (tag === '*') {
                        while (elem = results[i++]) {
                            if (elem.nodeType === 1) {
                                tmp.push(elem);
                            }
                        }
                        return tmp;
                    }
                    return results;
                };
                Expr.find['CLASS'] = support.getElementsByClassName && function (className, context) {
                    if (typeof context.getElementsByClassName !== strundefined && documentIsHTML) {
                        return context.getElementsByClassName(className);
                    }
                };
                rbuggyMatches = [];
                rbuggyQSA = [];
                if (support.qsa = rnative.test(doc.querySelectorAll)) {
                    assert(function (div) {
                        div.innerHTML = '<select msallowclip=\'\'><option selected=\'\'></option></select>';
                        if (div.querySelectorAll('[msallowclip^=\'\']').length) {
                            rbuggyQSA.push('[*^$]=' + whitespace + '*(?:\'\'|"")');
                        }
                        if (!div.querySelectorAll('[selected]').length) {
                            rbuggyQSA.push('\\[' + whitespace + '*(?:value|' + booleans + ')');
                        }
                        if (!div.querySelectorAll(':checked').length) {
                            rbuggyQSA.push(':checked');
                        }
                    });
                    assert(function (div) {
                        var input = doc.createElement('input');
                        input.setAttribute('type', 'hidden');
                        div.appendChild(input).setAttribute('name', 'D');
                        if (div.querySelectorAll('[name=d]').length) {
                            rbuggyQSA.push('name' + whitespace + '*[*^$|!~]?=');
                        }
                        if (!div.querySelectorAll(':enabled').length) {
                            rbuggyQSA.push(':enabled', ':disabled');
                        }
                        div.querySelectorAll('*,:x');
                        rbuggyQSA.push(',.*:');
                    });
                }
                if (support.matchesSelector = rnative.test(matches = docElem.matches || docElem.webkitMatchesSelector || docElem.mozMatchesSelector || docElem.oMatchesSelector || docElem.msMatchesSelector)) {
                    assert(function (div) {
                        support.disconnectedMatch = matches.call(div, 'div');
                        matches.call(div, '[s!=\'\']:x');
                        rbuggyMatches.push('!=', pseudos);
                    });
                }
                rbuggyQSA = rbuggyQSA.length && new RegExp(rbuggyQSA.join('|'));
                rbuggyMatches = rbuggyMatches.length && new RegExp(rbuggyMatches.join('|'));
                hasCompare = rnative.test(docElem.compareDocumentPosition);
                contains = hasCompare || rnative.test(docElem.contains) ? function (a, b) {
                    var adown = a.nodeType === 9 ? a.documentElement : a, bup = b && b.parentNode;
                    return a === bup || !!(bup && bup.nodeType === 1 && (adown.contains ? adown.contains(bup) : a.compareDocumentPosition && a.compareDocumentPosition(bup) & 16));
                } : function (a, b) {
                    if (b) {
                        while (b = b.parentNode) {
                            if (b === a) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                sortOrder = hasCompare ? function (a, b) {
                    if (a === b) {
                        hasDuplicate = true;
                        return 0;
                    }
                    var compare = !a.compareDocumentPosition - !b.compareDocumentPosition;
                    if (compare) {
                        return compare;
                    }
                    compare = (a.ownerDocument || a) === (b.ownerDocument || b) ? a.compareDocumentPosition(b) : 1;
                    if (compare & 1 || !support.sortDetached && b.compareDocumentPosition(a) === compare) {
                        if (a === doc || a.ownerDocument === preferredDoc && contains(preferredDoc, a)) {
                            return -1;
                        }
                        if (b === doc || b.ownerDocument === preferredDoc && contains(preferredDoc, b)) {
                            return 1;
                        }
                        return sortInput ? indexOf.call(sortInput, a) - indexOf.call(sortInput, b) : 0;
                    }
                    return compare & 4 ? -1 : 1;
                } : function (a, b) {
                    if (a === b) {
                        hasDuplicate = true;
                        return 0;
                    }
                    var cur, i = 0, aup = a.parentNode, bup = b.parentNode, ap = [a], bp = [b];
                    if (!aup || !bup) {
                        return a === doc ? -1 : b === doc ? 1 : aup ? -1 : bup ? 1 : sortInput ? indexOf.call(sortInput, a) - indexOf.call(sortInput, b) : 0;
                    } else if (aup === bup) {
                        return siblingCheck(a, b);
                    }
                    cur = a;
                    while (cur = cur.parentNode) {
                        ap.unshift(cur);
                    }
                    cur = b;
                    while (cur = cur.parentNode) {
                        bp.unshift(cur);
                    }
                    while (ap[i] === bp[i]) {
                        i++;
                    }
                    return i ? siblingCheck(ap[i], bp[i]) : ap[i] === preferredDoc ? -1 : bp[i] === preferredDoc ? 1 : 0;
                };
                return doc;
            };
            Sizzle.matches = function (expr, elements) {
                return Sizzle(expr, null, null, elements);
            };
            Sizzle.matchesSelector = function (elem, expr) {
                if ((elem.ownerDocument || elem) !== document) {
                    setDocument(elem);
                }
                expr = expr.replace(rattributeQuotes, '=\'$1\']');
                if (support.matchesSelector && documentIsHTML && (!rbuggyMatches || !rbuggyMatches.test(expr)) && (!rbuggyQSA || !rbuggyQSA.test(expr))) {
                    try {
                        var ret = matches.call(elem, expr);
                        if (ret || support.disconnectedMatch || elem.document && elem.document.nodeType !== 11) {
                            return ret;
                        }
                    } catch (e) {
                    }
                }
                return Sizzle(expr, document, null, [elem]).length > 0;
            };
            Sizzle.contains = function (context, elem) {
                if ((context.ownerDocument || context) !== document) {
                    setDocument(context);
                }
                return contains(context, elem);
            };
            Sizzle.attr = function (elem, name) {
                if ((elem.ownerDocument || elem) !== document) {
                    setDocument(elem);
                }
                var fn = Expr.attrHandle[name.toLowerCase()], val = fn && hasOwn.call(Expr.attrHandle, name.toLowerCase()) ? fn(elem, name, !documentIsHTML) : undefined;
                return val !== undefined ? val : support.attributes || !documentIsHTML ? elem.getAttribute(name) : (val = elem.getAttributeNode(name)) && val.specified ? val.value : null;
            };
            Sizzle.error = function (msg) {
                throw new Error('Syntax error, unrecognized expression: ' + msg);
            };
            Sizzle.uniqueSort = function (results) {
                var elem, duplicates = [], j = 0, i = 0;
                hasDuplicate = !support.detectDuplicates;
                sortInput = !support.sortStable && results.slice(0);
                results.sort(sortOrder);
                if (hasDuplicate) {
                    while (elem = results[i++]) {
                        if (elem === results[i]) {
                            j = duplicates.push(i);
                        }
                    }
                    while (j--) {
                        results.splice(duplicates[j], 1);
                    }
                }
                sortInput = null;
                return results;
            };
            getText = Sizzle.getText = function (elem) {
                var node, ret = '', i = 0, nodeType = elem.nodeType;
                if (!nodeType) {
                    while (node = elem[i++]) {
                        ret += getText(node);
                    }
                } else if (nodeType === 1 || nodeType === 9 || nodeType === 11) {
                    if (typeof elem.textContent === 'string') {
                        return elem.textContent;
                    } else {
                        for (elem = elem.firstChild; elem; elem = elem.nextSibling) {
                            ret += getText(elem);
                        }
                    }
                } else if (nodeType === 3 || nodeType === 4) {
                    return elem.nodeValue;
                }
                return ret;
            };
            Expr = Sizzle.selectors = {
                cacheLength: 50,
                createPseudo: markFunction,
                match: matchExpr,
                attrHandle: {},
                find: {},
                relative: {
                    '>': {
                        dir: 'parentNode',
                        first: true
                    },
                    ' ': { dir: 'parentNode' },
                    '+': {
                        dir: 'previousSibling',
                        first: true
                    },
                    '~': { dir: 'previousSibling' }
                },
                preFilter: {
                    'ATTR': function (match) {
                        match[1] = match[1].replace(runescape, funescape);
                        match[3] = (match[3] || match[4] || match[5] || '').replace(runescape, funescape);
                        if (match[2] === '~=') {
                            match[3] = ' ' + match[3] + ' ';
                        }
                        return match.slice(0, 4);
                    },
                    'CHILD': function (match) {
                        match[1] = match[1].toLowerCase();
                        if (match[1].slice(0, 3) === 'nth') {
                            if (!match[3]) {
                                Sizzle.error(match[0]);
                            }
                            match[4] = +(match[4] ? match[5] + (match[6] || 1) : 2 * (match[3] === 'even' || match[3] === 'odd'));
                            match[5] = +(match[7] + match[8] || match[3] === 'odd');
                        } else if (match[3]) {
                            Sizzle.error(match[0]);
                        }
                        return match;
                    },
                    'PSEUDO': function (match) {
                        var excess, unquoted = !match[6] && match[2];
                        if (matchExpr['CHILD'].test(match[0])) {
                            return null;
                        }
                        if (match[3]) {
                            match[2] = match[4] || match[5] || '';
                        } else if (unquoted && rpseudo.test(unquoted) && (excess = tokenize(unquoted, true)) && (excess = unquoted.indexOf(')', unquoted.length - excess) - unquoted.length)) {
                            match[0] = match[0].slice(0, excess);
                            match[2] = unquoted.slice(0, excess);
                        }
                        return match.slice(0, 3);
                    }
                },
                filter: {
                    'TAG': function (nodeNameSelector) {
                        var nodeName = nodeNameSelector.replace(runescape, funescape).toLowerCase();
                        return nodeNameSelector === '*' ? function () {
                            return true;
                        } : function (elem) {
                            return elem.nodeName && elem.nodeName.toLowerCase() === nodeName;
                        };
                    },
                    'CLASS': function (className) {
                        var pattern = classCache[className + ' '];
                        return pattern || (pattern = new RegExp('(^|' + whitespace + ')' + className + '(' + whitespace + '|$)')) && classCache(className, function (elem) {
                            return pattern.test(typeof elem.className === 'string' && elem.className || typeof elem.getAttribute !== strundefined && elem.getAttribute('class') || '');
                        });
                    },
                    'ATTR': function (name, operator, check) {
                        return function (elem) {
                            var result = Sizzle.attr(elem, name);
                            if (result == null) {
                                return operator === '!=';
                            }
                            if (!operator) {
                                return true;
                            }
                            result += '';
                            return operator === '=' ? result === check : operator === '!=' ? result !== check : operator === '^=' ? check && result.indexOf(check) === 0 : operator === '*=' ? check && result.indexOf(check) > -1 : operator === '$=' ? check && result.slice(-check.length) === check : operator === '~=' ? (' ' + result + ' ').indexOf(check) > -1 : operator === '|=' ? result === check || result.slice(0, check.length + 1) === check + '-' : false;
                        };
                    },
                    'CHILD': function (type, what, argument, first, last) {
                        var simple = type.slice(0, 3) !== 'nth', forward = type.slice(-4) !== 'last', ofType = what === 'of-type';
                        return first === 1 && last === 0 ? function (elem) {
                            return !!elem.parentNode;
                        } : function (elem, context, xml) {
                            var cache, outerCache, node, diff, nodeIndex, start, dir = simple !== forward ? 'nextSibling' : 'previousSibling', parent = elem.parentNode, name = ofType && elem.nodeName.toLowerCase(), useCache = !xml && !ofType;
                            if (parent) {
                                if (simple) {
                                    while (dir) {
                                        node = elem;
                                        while (node = node[dir]) {
                                            if (ofType ? node.nodeName.toLowerCase() === name : node.nodeType === 1) {
                                                return false;
                                            }
                                        }
                                        start = dir = type === 'only' && !start && 'nextSibling';
                                    }
                                    return true;
                                }
                                start = [forward ? parent.firstChild : parent.lastChild];
                                if (forward && useCache) {
                                    outerCache = parent[expando] || (parent[expando] = {});
                                    cache = outerCache[type] || [];
                                    nodeIndex = cache[0] === dirruns && cache[1];
                                    diff = cache[0] === dirruns && cache[2];
                                    node = nodeIndex && parent.childNodes[nodeIndex];
                                    while (node = ++nodeIndex && node && node[dir] || (diff = nodeIndex = 0) || start.pop()) {
                                        if (node.nodeType === 1 && ++diff && node === elem) {
                                            outerCache[type] = [
                                                dirruns,
                                                nodeIndex,
                                                diff
                                            ];
                                            break;
                                        }
                                    }
                                } else if (useCache && (cache = (elem[expando] || (elem[expando] = {}))[type]) && cache[0] === dirruns) {
                                    diff = cache[1];
                                } else {
                                    while (node = ++nodeIndex && node && node[dir] || (diff = nodeIndex = 0) || start.pop()) {
                                        if ((ofType ? node.nodeName.toLowerCase() === name : node.nodeType === 1) && ++diff) {
                                            if (useCache) {
                                                (node[expando] || (node[expando] = {}))[type] = [
                                                    dirruns,
                                                    diff
                                                ];
                                            }
                                            if (node === elem) {
                                                break;
                                            }
                                        }
                                    }
                                }
                                diff -= last;
                                return diff === first || diff % first === 0 && diff / first >= 0;
                            }
                        };
                    },
                    'PSEUDO': function (pseudo, argument) {
                        var args, fn = Expr.pseudos[pseudo] || Expr.setFilters[pseudo.toLowerCase()] || Sizzle.error('unsupported pseudo: ' + pseudo);
                        if (fn[expando]) {
                            return fn(argument);
                        }
                        if (fn.length > 1) {
                            args = [
                                pseudo,
                                pseudo,
                                '',
                                argument
                            ];
                            return Expr.setFilters.hasOwnProperty(pseudo.toLowerCase()) ? markFunction(function (seed, matches) {
                                var idx, matched = fn(seed, argument), i = matched.length;
                                while (i--) {
                                    idx = indexOf.call(seed, matched[i]);
                                    seed[idx] = !(matches[idx] = matched[i]);
                                }
                            }) : function (elem) {
                                return fn(elem, 0, args);
                            };
                        }
                        return fn;
                    }
                },
                pseudos: {
                    'not': markFunction(function (selector) {
                        var input = [], results = [], matcher = compile(selector.replace(rtrim, '$1'));
                        return matcher[expando] ? markFunction(function (seed, matches, context, xml) {
                            var elem, unmatched = matcher(seed, null, xml, []), i = seed.length;
                            while (i--) {
                                if (elem = unmatched[i]) {
                                    seed[i] = !(matches[i] = elem);
                                }
                            }
                        }) : function (elem, context, xml) {
                            input[0] = elem;
                            matcher(input, null, xml, results);
                            return !results.pop();
                        };
                    }),
                    'has': markFunction(function (selector) {
                        return function (elem) {
                            return Sizzle(selector, elem).length > 0;
                        };
                    }),
                    'contains': markFunction(function (text) {
                        return function (elem) {
                            return (elem.textContent || elem.innerText || getText(elem)).indexOf(text) > -1;
                        };
                    }),
                    'lang': markFunction(function (lang) {
                        if (!ridentifier.test(lang || '')) {
                            Sizzle.error('unsupported lang: ' + lang);
                        }
                        lang = lang.replace(runescape, funescape).toLowerCase();
                        return function (elem) {
                            var elemLang;
                            do {
                                if (elemLang = documentIsHTML ? elem.lang : elem.getAttribute('xml:lang') || elem.getAttribute('lang')) {
                                    elemLang = elemLang.toLowerCase();
                                    return elemLang === lang || elemLang.indexOf(lang + '-') === 0;
                                }
                            } while ((elem = elem.parentNode) && elem.nodeType === 1);
                            return false;
                        };
                    }),
                    'target': function (elem) {
                        var hash = window.location && window.location.hash;
                        return hash && hash.slice(1) === elem.id;
                    },
                    'root': function (elem) {
                        return elem === docElem;
                    },
                    'focus': function (elem) {
                        return elem === document.activeElement && (!document.hasFocus || document.hasFocus()) && !!(elem.type || elem.href || ~elem.tabIndex);
                    },
                    'enabled': function (elem) {
                        return elem.disabled === false;
                    },
                    'disabled': function (elem) {
                        return elem.disabled === true;
                    },
                    'checked': function (elem) {
                        var nodeName = elem.nodeName.toLowerCase();
                        return nodeName === 'input' && !!elem.checked || nodeName === 'option' && !!elem.selected;
                    },
                    'selected': function (elem) {
                        if (elem.parentNode) {
                            elem.parentNode.selectedIndex;
                        }
                        return elem.selected === true;
                    },
                    'empty': function (elem) {
                        for (elem = elem.firstChild; elem; elem = elem.nextSibling) {
                            if (elem.nodeType < 6) {
                                return false;
                            }
                        }
                        return true;
                    },
                    'parent': function (elem) {
                        return !Expr.pseudos['empty'](elem);
                    },
                    'header': function (elem) {
                        return rheader.test(elem.nodeName);
                    },
                    'input': function (elem) {
                        return rinputs.test(elem.nodeName);
                    },
                    'button': function (elem) {
                        var name = elem.nodeName.toLowerCase();
                        return name === 'input' && elem.type === 'button' || name === 'button';
                    },
                    'text': function (elem) {
                        var attr;
                        return elem.nodeName.toLowerCase() === 'input' && elem.type === 'text' && ((attr = elem.getAttribute('type')) == null || attr.toLowerCase() === 'text');
                    },
                    'first': createPositionalPseudo(function () {
                        return [0];
                    }),
                    'last': createPositionalPseudo(function (matchIndexes, length) {
                        return [length - 1];
                    }),
                    'eq': createPositionalPseudo(function (matchIndexes, length, argument) {
                        return [argument < 0 ? argument + length : argument];
                    }),
                    'even': createPositionalPseudo(function (matchIndexes, length) {
                        var i = 0;
                        for (; i < length; i += 2) {
                            matchIndexes.push(i);
                        }
                        return matchIndexes;
                    }),
                    'odd': createPositionalPseudo(function (matchIndexes, length) {
                        var i = 1;
                        for (; i < length; i += 2) {
                            matchIndexes.push(i);
                        }
                        return matchIndexes;
                    }),
                    'lt': createPositionalPseudo(function (matchIndexes, length, argument) {
                        var i = argument < 0 ? argument + length : argument;
                        for (; --i >= 0;) {
                            matchIndexes.push(i);
                        }
                        return matchIndexes;
                    }),
                    'gt': createPositionalPseudo(function (matchIndexes, length, argument) {
                        var i = argument < 0 ? argument + length : argument;
                        for (; ++i < length;) {
                            matchIndexes.push(i);
                        }
                        return matchIndexes;
                    })
                }
            };
            Expr.pseudos['nth'] = Expr.pseudos['eq'];
            for (i in {
                    radio: true,
                    checkbox: true,
                    file: true,
                    password: true,
                    image: true
                }) {
                Expr.pseudos[i] = createInputPseudo(i);
            }
            for (i in {
                    submit: true,
                    reset: true
                }) {
                Expr.pseudos[i] = createButtonPseudo(i);
            }
            function setFilters() {
            }
            setFilters.prototype = Expr.filters = Expr.pseudos;
            Expr.setFilters = new setFilters();
            tokenize = Sizzle.tokenize = function (selector, parseOnly) {
                var matched, match, tokens, type, soFar, groups, preFilters, cached = tokenCache[selector + ' '];
                if (cached) {
                    return parseOnly ? 0 : cached.slice(0);
                }
                soFar = selector;
                groups = [];
                preFilters = Expr.preFilter;
                while (soFar) {
                    if (!matched || (match = rcomma.exec(soFar))) {
                        if (match) {
                            soFar = soFar.slice(match[0].length) || soFar;
                        }
                        groups.push(tokens = []);
                    }
                    matched = false;
                    if (match = rcombinators.exec(soFar)) {
                        matched = match.shift();
                        tokens.push({
                            value: matched,
                            type: match[0].replace(rtrim, ' ')
                        });
                        soFar = soFar.slice(matched.length);
                    }
                    for (type in Expr.filter) {
                        if ((match = matchExpr[type].exec(soFar)) && (!preFilters[type] || (match = preFilters[type](match)))) {
                            matched = match.shift();
                            tokens.push({
                                value: matched,
                                type: type,
                                matches: match
                            });
                            soFar = soFar.slice(matched.length);
                        }
                    }
                    if (!matched) {
                        break;
                    }
                }
                return parseOnly ? soFar.length : soFar ? Sizzle.error(selector) : tokenCache(selector, groups).slice(0);
            };
            function toSelector(tokens) {
                var i = 0, len = tokens.length, selector = '';
                for (; i < len; i++) {
                    selector += tokens[i].value;
                }
                return selector;
            }
            function addCombinator(matcher, combinator, base) {
                var dir = combinator.dir, checkNonElements = base && dir === 'parentNode', doneName = done++;
                return combinator.first ? function (elem, context, xml) {
                    while (elem = elem[dir]) {
                        if (elem.nodeType === 1 || checkNonElements) {
                            return matcher(elem, context, xml);
                        }
                    }
                } : function (elem, context, xml) {
                    var oldCache, outerCache, newCache = [
                            dirruns,
                            doneName
                        ];
                    if (xml) {
                        while (elem = elem[dir]) {
                            if (elem.nodeType === 1 || checkNonElements) {
                                if (matcher(elem, context, xml)) {
                                    return true;
                                }
                            }
                        }
                    } else {
                        while (elem = elem[dir]) {
                            if (elem.nodeType === 1 || checkNonElements) {
                                outerCache = elem[expando] || (elem[expando] = {});
                                if ((oldCache = outerCache[dir]) && oldCache[0] === dirruns && oldCache[1] === doneName) {
                                    return newCache[2] = oldCache[2];
                                } else {
                                    outerCache[dir] = newCache;
                                    if (newCache[2] = matcher(elem, context, xml)) {
                                        return true;
                                    }
                                }
                            }
                        }
                    }
                };
            }
            function elementMatcher(matchers) {
                return matchers.length > 1 ? function (elem, context, xml) {
                    var i = matchers.length;
                    while (i--) {
                        if (!matchers[i](elem, context, xml)) {
                            return false;
                        }
                    }
                    return true;
                } : matchers[0];
            }
            function multipleContexts(selector, contexts, results) {
                var i = 0, len = contexts.length;
                for (; i < len; i++) {
                    Sizzle(selector, contexts[i], results);
                }
                return results;
            }
            function condense(unmatched, map, filter, context, xml) {
                var elem, newUnmatched = [], i = 0, len = unmatched.length, mapped = map != null;
                for (; i < len; i++) {
                    if (elem = unmatched[i]) {
                        if (!filter || filter(elem, context, xml)) {
                            newUnmatched.push(elem);
                            if (mapped) {
                                map.push(i);
                            }
                        }
                    }
                }
                return newUnmatched;
            }
            function setMatcher(preFilter, selector, matcher, postFilter, postFinder, postSelector) {
                if (postFilter && !postFilter[expando]) {
                    postFilter = setMatcher(postFilter);
                }
                if (postFinder && !postFinder[expando]) {
                    postFinder = setMatcher(postFinder, postSelector);
                }
                return markFunction(function (seed, results, context, xml) {
                    var temp, i, elem, preMap = [], postMap = [], preexisting = results.length, elems = seed || multipleContexts(selector || '*', context.nodeType ? [context] : context, []), matcherIn = preFilter && (seed || !selector) ? condense(elems, preMap, preFilter, context, xml) : elems, matcherOut = matcher ? postFinder || (seed ? preFilter : preexisting || postFilter) ? [] : results : matcherIn;
                    if (matcher) {
                        matcher(matcherIn, matcherOut, context, xml);
                    }
                    if (postFilter) {
                        temp = condense(matcherOut, postMap);
                        postFilter(temp, [], context, xml);
                        i = temp.length;
                        while (i--) {
                            if (elem = temp[i]) {
                                matcherOut[postMap[i]] = !(matcherIn[postMap[i]] = elem);
                            }
                        }
                    }
                    if (seed) {
                        if (postFinder || preFilter) {
                            if (postFinder) {
                                temp = [];
                                i = matcherOut.length;
                                while (i--) {
                                    if (elem = matcherOut[i]) {
                                        temp.push(matcherIn[i] = elem);
                                    }
                                }
                                postFinder(null, matcherOut = [], temp, xml);
                            }
                            i = matcherOut.length;
                            while (i--) {
                                if ((elem = matcherOut[i]) && (temp = postFinder ? indexOf.call(seed, elem) : preMap[i]) > -1) {
                                    seed[temp] = !(results[temp] = elem);
                                }
                            }
                        }
                    } else {
                        matcherOut = condense(matcherOut === results ? matcherOut.splice(preexisting, matcherOut.length) : matcherOut);
                        if (postFinder) {
                            postFinder(null, results, matcherOut, xml);
                        } else {
                            push.apply(results, matcherOut);
                        }
                    }
                });
            }
            function matcherFromTokens(tokens) {
                var checkContext, matcher, j, len = tokens.length, leadingRelative = Expr.relative[tokens[0].type], implicitRelative = leadingRelative || Expr.relative[' '], i = leadingRelative ? 1 : 0, matchContext = addCombinator(function (elem) {
                        return elem === checkContext;
                    }, implicitRelative, true), matchAnyContext = addCombinator(function (elem) {
                        return indexOf.call(checkContext, elem) > -1;
                    }, implicitRelative, true), matchers = [function (elem, context, xml) {
                            return !leadingRelative && (xml || context !== outermostContext) || ((checkContext = context).nodeType ? matchContext(elem, context, xml) : matchAnyContext(elem, context, xml));
                        }];
                for (; i < len; i++) {
                    if (matcher = Expr.relative[tokens[i].type]) {
                        matchers = [addCombinator(elementMatcher(matchers), matcher)];
                    } else {
                        matcher = Expr.filter[tokens[i].type].apply(null, tokens[i].matches);
                        if (matcher[expando]) {
                            j = ++i;
                            for (; j < len; j++) {
                                if (Expr.relative[tokens[j].type]) {
                                    break;
                                }
                            }
                            return setMatcher(i > 1 && elementMatcher(matchers), i > 1 && toSelector(tokens.slice(0, i - 1).concat({ value: tokens[i - 2].type === ' ' ? '*' : '' })).replace(rtrim, '$1'), matcher, i < j && matcherFromTokens(tokens.slice(i, j)), j < len && matcherFromTokens(tokens = tokens.slice(j)), j < len && toSelector(tokens));
                        }
                        matchers.push(matcher);
                    }
                }
                return elementMatcher(matchers);
            }
            function matcherFromGroupMatchers(elementMatchers, setMatchers) {
                var bySet = setMatchers.length > 0, byElement = elementMatchers.length > 0, superMatcher = function (seed, context, xml, results, outermost) {
                        var elem, j, matcher, matchedCount = 0, i = '0', unmatched = seed && [], setMatched = [], contextBackup = outermostContext, elems = seed || byElement && Expr.find['TAG']('*', outermost), dirrunsUnique = dirruns += contextBackup == null ? 1 : Math.random() || 0.1, len = elems.length;
                        if (outermost) {
                            outermostContext = context !== document && context;
                        }
                        for (; i !== len && (elem = elems[i]) != null; i++) {
                            if (byElement && elem) {
                                j = 0;
                                while (matcher = elementMatchers[j++]) {
                                    if (matcher(elem, context, xml)) {
                                        results.push(elem);
                                        break;
                                    }
                                }
                                if (outermost) {
                                    dirruns = dirrunsUnique;
                                }
                            }
                            if (bySet) {
                                if (elem = !matcher && elem) {
                                    matchedCount--;
                                }
                                if (seed) {
                                    unmatched.push(elem);
                                }
                            }
                        }
                        matchedCount += i;
                        if (bySet && i !== matchedCount) {
                            j = 0;
                            while (matcher = setMatchers[j++]) {
                                matcher(unmatched, setMatched, context, xml);
                            }
                            if (seed) {
                                if (matchedCount > 0) {
                                    while (i--) {
                                        if (!(unmatched[i] || setMatched[i])) {
                                            setMatched[i] = pop.call(results);
                                        }
                                    }
                                }
                                setMatched = condense(setMatched);
                            }
                            push.apply(results, setMatched);
                            if (outermost && !seed && setMatched.length > 0 && matchedCount + setMatchers.length > 1) {
                                Sizzle.uniqueSort(results);
                            }
                        }
                        if (outermost) {
                            dirruns = dirrunsUnique;
                            outermostContext = contextBackup;
                        }
                        return unmatched;
                    };
                return bySet ? markFunction(superMatcher) : superMatcher;
            }
            compile = Sizzle.compile = function (selector, match) {
                var i, setMatchers = [], elementMatchers = [], cached = compilerCache[selector + ' '];
                if (!cached) {
                    if (!match) {
                        match = tokenize(selector);
                    }
                    i = match.length;
                    while (i--) {
                        cached = matcherFromTokens(match[i]);
                        if (cached[expando]) {
                            setMatchers.push(cached);
                        } else {
                            elementMatchers.push(cached);
                        }
                    }
                    cached = compilerCache(selector, matcherFromGroupMatchers(elementMatchers, setMatchers));
                    cached.selector = selector;
                }
                return cached;
            };
            select = Sizzle.select = function (selector, context, results, seed) {
                var i, tokens, token, type, find, compiled = typeof selector === 'function' && selector, match = !seed && tokenize(selector = compiled.selector || selector);
                results = results || [];
                if (match.length === 1) {
                    tokens = match[0] = match[0].slice(0);
                    if (tokens.length > 2 && (token = tokens[0]).type === 'ID' && support.getById && context.nodeType === 9 && documentIsHTML && Expr.relative[tokens[1].type]) {
                        context = (Expr.find['ID'](token.matches[0].replace(runescape, funescape), context) || [])[0];
                        if (!context) {
                            return results;
                        } else if (compiled) {
                            context = context.parentNode;
                        }
                        selector = selector.slice(tokens.shift().value.length);
                    }
                    i = matchExpr['needsContext'].test(selector) ? 0 : tokens.length;
                    while (i--) {
                        token = tokens[i];
                        if (Expr.relative[type = token.type]) {
                            break;
                        }
                        if (find = Expr.find[type]) {
                            if (seed = find(token.matches[0].replace(runescape, funescape), rsibling.test(tokens[0].type) && testContext(context.parentNode) || context)) {
                                tokens.splice(i, 1);
                                selector = seed.length && toSelector(tokens);
                                if (!selector) {
                                    push.apply(results, seed);
                                    return results;
                                }
                                break;
                            }
                        }
                    }
                }
                (compiled || compile(selector, match))(seed, context, !documentIsHTML, results, rsibling.test(selector) && testContext(context.parentNode) || context);
                return results;
            };
            support.sortStable = expando.split('').sort(sortOrder).join('') === expando;
            support.detectDuplicates = !!hasDuplicate;
            setDocument();
            support.sortDetached = assert(function (div1) {
                return div1.compareDocumentPosition(document.createElement('div')) & 1;
            });
            if (!assert(function (div) {
                    div.innerHTML = '<a href=\'#\'></a>';
                    return div.firstChild.getAttribute('href') === '#';
                })) {
                addHandle('type|href|height|width', function (elem, name, isXML) {
                    if (!isXML) {
                        return elem.getAttribute(name, name.toLowerCase() === 'type' ? 1 : 2);
                    }
                });
            }
            if (!support.attributes || !assert(function (div) {
                    div.innerHTML = '<input/>';
                    div.firstChild.setAttribute('value', '');
                    return div.firstChild.getAttribute('value') === '';
                })) {
                addHandle('value', function (elem, name, isXML) {
                    if (!isXML && elem.nodeName.toLowerCase() === 'input') {
                        return elem.defaultValue;
                    }
                });
            }
            if (!assert(function (div) {
                    return div.getAttribute('disabled') == null;
                })) {
                addHandle(booleans, function (elem, name, isXML) {
                    var val;
                    if (!isXML) {
                        return elem[name] === true ? name.toLowerCase() : (val = elem.getAttributeNode(name)) && val.specified ? val.value : null;
                    }
                });
            }
            return Sizzle;
        }(window);
        jQuery.find = Sizzle;
        jQuery.expr = Sizzle.selectors;
        jQuery.expr[':'] = jQuery.expr.pseudos;
        jQuery.unique = Sizzle.uniqueSort;
        jQuery.text = Sizzle.getText;
        jQuery.isXMLDoc = Sizzle.isXML;
        jQuery.contains = Sizzle.contains;
        var rneedsContext = jQuery.expr.match.needsContext;
        var rsingleTag = /^<(\w+)\s*\/?>(?:<\/\1>|)$/;
        var risSimple = /^.[^:#\[\.,]*$/;
        function winnow(elements, qualifier, not) {
            if (jQuery.isFunction(qualifier)) {
                return jQuery.grep(elements, function (elem, i) {
                    return !!qualifier.call(elem, i, elem) !== not;
                });
            }
            if (qualifier.nodeType) {
                return jQuery.grep(elements, function (elem) {
                    return elem === qualifier !== not;
                });
            }
            if (typeof qualifier === 'string') {
                if (risSimple.test(qualifier)) {
                    return jQuery.filter(qualifier, elements, not);
                }
                qualifier = jQuery.filter(qualifier, elements);
            }
            return jQuery.grep(elements, function (elem) {
                return jQuery.inArray(elem, qualifier) >= 0 !== not;
            });
        }
        jQuery.filter = function (expr, elems, not) {
            var elem = elems[0];
            if (not) {
                expr = ':not(' + expr + ')';
            }
            return elems.length === 1 && elem.nodeType === 1 ? jQuery.find.matchesSelector(elem, expr) ? [elem] : [] : jQuery.find.matches(expr, jQuery.grep(elems, function (elem) {
                return elem.nodeType === 1;
            }));
        };
        jQuery.fn.extend({
            find: function (selector) {
                var i, ret = [], self = this, len = self.length;
                if (typeof selector !== 'string') {
                    return this.pushStack(jQuery(selector).filter(function () {
                        for (i = 0; i < len; i++) {
                            if (jQuery.contains(self[i], this)) {
                                return true;
                            }
                        }
                    }));
                }
                for (i = 0; i < len; i++) {
                    jQuery.find(selector, self[i], ret);
                }
                ret = this.pushStack(len > 1 ? jQuery.unique(ret) : ret);
                ret.selector = this.selector ? this.selector + ' ' + selector : selector;
                return ret;
            },
            filter: function (selector) {
                return this.pushStack(winnow(this, selector || [], false));
            },
            not: function (selector) {
                return this.pushStack(winnow(this, selector || [], true));
            },
            is: function (selector) {
                return !!winnow(this, typeof selector === 'string' && rneedsContext.test(selector) ? jQuery(selector) : selector || [], false).length;
            }
        });
        var rootjQuery, document = window.document, rquickExpr = /^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/, init = jQuery.fn.init = function (selector, context) {
                var match, elem;
                if (!selector) {
                    return this;
                }
                if (typeof selector === 'string') {
                    if (selector.charAt(0) === '<' && selector.charAt(selector.length - 1) === '>' && selector.length >= 3) {
                        match = [
                            null,
                            selector,
                            null
                        ];
                    } else {
                        match = rquickExpr.exec(selector);
                    }
                    if (match && (match[1] || !context)) {
                        if (match[1]) {
                            context = context instanceof jQuery ? context[0] : context;
                            jQuery.merge(this, jQuery.parseHTML(match[1], context && context.nodeType ? context.ownerDocument || context : document, true));
                            if (rsingleTag.test(match[1]) && jQuery.isPlainObject(context)) {
                                for (match in context) {
                                    if (jQuery.isFunction(this[match])) {
                                        this[match](context[match]);
                                    } else {
                                        this.attr(match, context[match]);
                                    }
                                }
                            }
                            return this;
                        } else {
                            elem = document.getElementById(match[2]);
                            if (elem && elem.parentNode) {
                                if (elem.id !== match[2]) {
                                    return rootjQuery.find(selector);
                                }
                                this.length = 1;
                                this[0] = elem;
                            }
                            this.context = document;
                            this.selector = selector;
                            return this;
                        }
                    } else if (!context || context.jquery) {
                        return (context || rootjQuery).find(selector);
                    } else {
                        return this.constructor(context).find(selector);
                    }
                } else if (selector.nodeType) {
                    this.context = this[0] = selector;
                    this.length = 1;
                    return this;
                } else if (jQuery.isFunction(selector)) {
                    return typeof rootjQuery.ready !== 'undefined' ? rootjQuery.ready(selector) : selector(jQuery);
                }
                if (selector.selector !== undefined) {
                    this.selector = selector.selector;
                    this.context = selector.context;
                }
                return jQuery.makeArray(selector, this);
            };
        init.prototype = jQuery.fn;
        rootjQuery = jQuery(document);
        var rparentsprev = /^(?:parents|prev(?:Until|All))/, guaranteedUnique = {
                children: true,
                contents: true,
                next: true,
                prev: true
            };
        jQuery.extend({
            dir: function (elem, dir, until) {
                var matched = [], cur = elem[dir];
                while (cur && cur.nodeType !== 9 && (until === undefined || cur.nodeType !== 1 || !jQuery(cur).is(until))) {
                    if (cur.nodeType === 1) {
                        matched.push(cur);
                    }
                    cur = cur[dir];
                }
                return matched;
            },
            sibling: function (n, elem) {
                var r = [];
                for (; n; n = n.nextSibling) {
                    if (n.nodeType === 1 && n !== elem) {
                        r.push(n);
                    }
                }
                return r;
            }
        });
        jQuery.fn.extend({
            has: function (target) {
                var i, targets = jQuery(target, this), len = targets.length;
                return this.filter(function () {
                    for (i = 0; i < len; i++) {
                        if (jQuery.contains(this, targets[i])) {
                            return true;
                        }
                    }
                });
            },
            closest: function (selectors, context) {
                var cur, i = 0, l = this.length, matched = [], pos = rneedsContext.test(selectors) || typeof selectors !== 'string' ? jQuery(selectors, context || this.context) : 0;
                for (; i < l; i++) {
                    for (cur = this[i]; cur && cur !== context; cur = cur.parentNode) {
                        if (cur.nodeType < 11 && (pos ? pos.index(cur) > -1 : cur.nodeType === 1 && jQuery.find.matchesSelector(cur, selectors))) {
                            matched.push(cur);
                            break;
                        }
                    }
                }
                return this.pushStack(matched.length > 1 ? jQuery.unique(matched) : matched);
            },
            index: function (elem) {
                if (!elem) {
                    return this[0] && this[0].parentNode ? this.first().prevAll().length : -1;
                }
                if (typeof elem === 'string') {
                    return jQuery.inArray(this[0], jQuery(elem));
                }
                return jQuery.inArray(elem.jquery ? elem[0] : elem, this);
            },
            add: function (selector, context) {
                return this.pushStack(jQuery.unique(jQuery.merge(this.get(), jQuery(selector, context))));
            },
            addBack: function (selector) {
                return this.add(selector == null ? this.prevObject : this.prevObject.filter(selector));
            }
        });
        function sibling(cur, dir) {
            do {
                cur = cur[dir];
            } while (cur && cur.nodeType !== 1);
            return cur;
        }
        jQuery.each({
            parent: function (elem) {
                var parent = elem.parentNode;
                return parent && parent.nodeType !== 11 ? parent : null;
            },
            parents: function (elem) {
                return jQuery.dir(elem, 'parentNode');
            },
            parentsUntil: function (elem, i, until) {
                return jQuery.dir(elem, 'parentNode', until);
            },
            next: function (elem) {
                return sibling(elem, 'nextSibling');
            },
            prev: function (elem) {
                return sibling(elem, 'previousSibling');
            },
            nextAll: function (elem) {
                return jQuery.dir(elem, 'nextSibling');
            },
            prevAll: function (elem) {
                return jQuery.dir(elem, 'previousSibling');
            },
            nextUntil: function (elem, i, until) {
                return jQuery.dir(elem, 'nextSibling', until);
            },
            prevUntil: function (elem, i, until) {
                return jQuery.dir(elem, 'previousSibling', until);
            },
            siblings: function (elem) {
                return jQuery.sibling((elem.parentNode || {}).firstChild, elem);
            },
            children: function (elem) {
                return jQuery.sibling(elem.firstChild);
            },
            contents: function (elem) {
                return jQuery.nodeName(elem, 'iframe') ? elem.contentDocument || elem.contentWindow.document : jQuery.merge([], elem.childNodes);
            }
        }, function (name, fn) {
            jQuery.fn[name] = function (until, selector) {
                var ret = jQuery.map(this, fn, until);
                if (name.slice(-5) !== 'Until') {
                    selector = until;
                }
                if (selector && typeof selector === 'string') {
                    ret = jQuery.filter(selector, ret);
                }
                if (this.length > 1) {
                    if (!guaranteedUnique[name]) {
                        ret = jQuery.unique(ret);
                    }
                    if (rparentsprev.test(name)) {
                        ret = ret.reverse();
                    }
                }
                return this.pushStack(ret);
            };
        });
        var rnotwhite = /\S+/g;
        var optionsCache = {};
        function createOptions(options) {
            var object = optionsCache[options] = {};
            jQuery.each(options.match(rnotwhite) || [], function (_, flag) {
                object[flag] = true;
            });
            return object;
        }
        jQuery.Callbacks = function (options) {
            options = typeof options === 'string' ? optionsCache[options] || createOptions(options) : jQuery.extend({}, options);
            var firing, memory, fired, firingLength, firingIndex, firingStart, list = [], stack = !options.once && [], fire = function (data) {
                    memory = options.memory && data;
                    fired = true;
                    firingIndex = firingStart || 0;
                    firingStart = 0;
                    firingLength = list.length;
                    firing = true;
                    for (; list && firingIndex < firingLength; firingIndex++) {
                        if (list[firingIndex].apply(data[0], data[1]) === false && options.stopOnFalse) {
                            memory = false;
                            break;
                        }
                    }
                    firing = false;
                    if (list) {
                        if (stack) {
                            if (stack.length) {
                                fire(stack.shift());
                            }
                        } else if (memory) {
                            list = [];
                        } else {
                            self.disable();
                        }
                    }
                }, self = {
                    add: function () {
                        if (list) {
                            var start = list.length;
                            (function add(args) {
                                jQuery.each(args, function (_, arg) {
                                    var type = jQuery.type(arg);
                                    if (type === 'function') {
                                        if (!options.unique || !self.has(arg)) {
                                            list.push(arg);
                                        }
                                    } else if (arg && arg.length && type !== 'string') {
                                        add(arg);
                                    }
                                });
                            }(arguments));
                            if (firing) {
                                firingLength = list.length;
                            } else if (memory) {
                                firingStart = start;
                                fire(memory);
                            }
                        }
                        return this;
                    },
                    remove: function () {
                        if (list) {
                            jQuery.each(arguments, function (_, arg) {
                                var index;
                                while ((index = jQuery.inArray(arg, list, index)) > -1) {
                                    list.splice(index, 1);
                                    if (firing) {
                                        if (index <= firingLength) {
                                            firingLength--;
                                        }
                                        if (index <= firingIndex) {
                                            firingIndex--;
                                        }
                                    }
                                }
                            });
                        }
                        return this;
                    },
                    has: function (fn) {
                        return fn ? jQuery.inArray(fn, list) > -1 : !!(list && list.length);
                    },
                    empty: function () {
                        list = [];
                        firingLength = 0;
                        return this;
                    },
                    disable: function () {
                        list = stack = memory = undefined;
                        return this;
                    },
                    disabled: function () {
                        return !list;
                    },
                    lock: function () {
                        stack = undefined;
                        if (!memory) {
                            self.disable();
                        }
                        return this;
                    },
                    locked: function () {
                        return !stack;
                    },
                    fireWith: function (context, args) {
                        if (list && (!fired || stack)) {
                            args = args || [];
                            args = [
                                context,
                                args.slice ? args.slice() : args
                            ];
                            if (firing) {
                                stack.push(args);
                            } else {
                                fire(args);
                            }
                        }
                        return this;
                    },
                    fire: function () {
                        self.fireWith(this, arguments);
                        return this;
                    },
                    fired: function () {
                        return !!fired;
                    }
                };
            return self;
        };
        jQuery.extend({
            Deferred: function (func) {
                var tuples = [
                        [
                            'resolve',
                            'done',
                            jQuery.Callbacks('once memory'),
                            'resolved'
                        ],
                        [
                            'reject',
                            'fail',
                            jQuery.Callbacks('once memory'),
                            'rejected'
                        ],
                        [
                            'notify',
                            'progress',
                            jQuery.Callbacks('memory')
                        ]
                    ], state = 'pending', promise = {
                        state: function () {
                            return state;
                        },
                        always: function () {
                            deferred.done(arguments).fail(arguments);
                            return this;
                        },
                        then: function () {
                            var fns = arguments;
                            return jQuery.Deferred(function (newDefer) {
                                jQuery.each(tuples, function (i, tuple) {
                                    var fn = jQuery.isFunction(fns[i]) && fns[i];
                                    deferred[tuple[1]](function () {
                                        var returned = fn && fn.apply(this, arguments);
                                        if (returned && jQuery.isFunction(returned.promise)) {
                                            returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify);
                                        } else {
                                            newDefer[tuple[0] + 'With'](this === promise ? newDefer.promise() : this, fn ? [returned] : arguments);
                                        }
                                    });
                                });
                                fns = null;
                            }).promise();
                        },
                        promise: function (obj) {
                            return obj != null ? jQuery.extend(obj, promise) : promise;
                        }
                    }, deferred = {};
                promise.pipe = promise.then;
                jQuery.each(tuples, function (i, tuple) {
                    var list = tuple[2], stateString = tuple[3];
                    promise[tuple[1]] = list.add;
                    if (stateString) {
                        list.add(function () {
                            state = stateString;
                        }, tuples[i ^ 1][2].disable, tuples[2][2].lock);
                    }
                    deferred[tuple[0]] = function () {
                        deferred[tuple[0] + 'With'](this === deferred ? promise : this, arguments);
                        return this;
                    };
                    deferred[tuple[0] + 'With'] = list.fireWith;
                });
                promise.promise(deferred);
                if (func) {
                    func.call(deferred, deferred);
                }
                return deferred;
            },
            when: function (subordinate) {
                var i = 0, resolveValues = slice.call(arguments), length = resolveValues.length, remaining = length !== 1 || subordinate && jQuery.isFunction(subordinate.promise) ? length : 0, deferred = remaining === 1 ? subordinate : jQuery.Deferred(), updateFunc = function (i, contexts, values) {
                        return function (value) {
                            contexts[i] = this;
                            values[i] = arguments.length > 1 ? slice.call(arguments) : value;
                            if (values === progressValues) {
                                deferred.notifyWith(contexts, values);
                            } else if (!--remaining) {
                                deferred.resolveWith(contexts, values);
                            }
                        };
                    }, progressValues, progressContexts, resolveContexts;
                if (length > 1) {
                    progressValues = new Array(length);
                    progressContexts = new Array(length);
                    resolveContexts = new Array(length);
                    for (; i < length; i++) {
                        if (resolveValues[i] && jQuery.isFunction(resolveValues[i].promise)) {
                            resolveValues[i].promise().done(updateFunc(i, resolveContexts, resolveValues)).fail(deferred.reject).progress(updateFunc(i, progressContexts, progressValues));
                        } else {
                            --remaining;
                        }
                    }
                }
                if (!remaining) {
                    deferred.resolveWith(resolveContexts, resolveValues);
                }
                return deferred.promise();
            }
        });
        var readyList;
        jQuery.fn.ready = function (fn) {
            jQuery.ready.promise().done(fn);
            return this;
        };
        jQuery.extend({
            isReady: false,
            readyWait: 1,
            holdReady: function (hold) {
                if (hold) {
                    jQuery.readyWait++;
                } else {
                    jQuery.ready(true);
                }
            },
            ready: function (wait) {
                if (wait === true ? --jQuery.readyWait : jQuery.isReady) {
                    return;
                }
                if (!document.body) {
                    return setTimeout(jQuery.ready);
                }
                jQuery.isReady = true;
                if (wait !== true && --jQuery.readyWait > 0) {
                    return;
                }
                readyList.resolveWith(document, [jQuery]);
                if (jQuery.fn.triggerHandler) {
                    jQuery(document).triggerHandler('ready');
                    jQuery(document).off('ready');
                }
            }
        });
        function detach() {
            if (document.addEventListener) {
                document.removeEventListener('DOMContentLoaded', completed, false);
                window.removeEventListener('load', completed, false);
            } else {
                document.detachEvent('onreadystatechange', completed);
                window.detachEvent('onload', completed);
            }
        }
        function completed() {
            if (document.addEventListener || event.type === 'load' || document.readyState === 'complete') {
                detach();
                jQuery.ready();
            }
        }
        jQuery.ready.promise = function (obj) {
            if (!readyList) {
                readyList = jQuery.Deferred();
                if (document.readyState === 'complete') {
                    setTimeout(jQuery.ready);
                } else if (document.addEventListener) {
                    document.addEventListener('DOMContentLoaded', completed, false);
                    window.addEventListener('load', completed, false);
                } else {
                    document.attachEvent('onreadystatechange', completed);
                    window.attachEvent('onload', completed);
                    var top = false;
                    try {
                        top = window.frameElement == null && document.documentElement;
                    } catch (e) {
                    }
                    if (top && top.doScroll) {
                        (function doScrollCheck() {
                            if (!jQuery.isReady) {
                                try {
                                    top.doScroll('left');
                                } catch (e) {
                                    return setTimeout(doScrollCheck, 50);
                                }
                                detach();
                                jQuery.ready();
                            }
                        }());
                    }
                }
            }
            return readyList.promise(obj);
        };
        var strundefined = typeof undefined;
        var i;
        for (i in jQuery(support)) {
            break;
        }
        support.ownLast = i !== '0';
        support.inlineBlockNeedsLayout = false;
        jQuery(function () {
            var val, div, body, container;
            body = document.getElementsByTagName('body')[0];
            if (!body || !body.style) {
                return;
            }
            div = document.createElement('div');
            container = document.createElement('div');
            container.style.cssText = 'position:absolute;border:0;width:0;height:0;top:0;left:-9999px';
            body.appendChild(container).appendChild(div);
            if (typeof div.style.zoom !== strundefined) {
                div.style.cssText = 'display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1';
                support.inlineBlockNeedsLayout = val = div.offsetWidth === 3;
                if (val) {
                    body.style.zoom = 1;
                }
            }
            body.removeChild(container);
        });
        (function () {
            var div = document.createElement('div');
            if (support.deleteExpando == null) {
                support.deleteExpando = true;
                try {
                    delete div.test;
                } catch (e) {
                    support.deleteExpando = false;
                }
            }
            div = null;
        }());
        jQuery.acceptData = function (elem) {
            var noData = jQuery.noData[(elem.nodeName + ' ').toLowerCase()], nodeType = +elem.nodeType || 1;
            return nodeType !== 1 && nodeType !== 9 ? false : !noData || noData !== true && elem.getAttribute('classid') === noData;
        };
        var rbrace = /^(?:\{[\w\W]*\}|\[[\w\W]*\])$/, rmultiDash = /([A-Z])/g;
        function dataAttr(elem, key, data) {
            if (data === undefined && elem.nodeType === 1) {
                var name = 'data-' + key.replace(rmultiDash, '-$1').toLowerCase();
                data = elem.getAttribute(name);
                if (typeof data === 'string') {
                    try {
                        data = data === 'true' ? true : data === 'false' ? false : data === 'null' ? null : +data + '' === data ? +data : rbrace.test(data) ? jQuery.parseJSON(data) : data;
                    } catch (e) {
                    }
                    jQuery.data(elem, key, data);
                } else {
                    data = undefined;
                }
            }
            return data;
        }
        function isEmptyDataObject(obj) {
            var name;
            for (name in obj) {
                if (name === 'data' && jQuery.isEmptyObject(obj[name])) {
                    continue;
                }
                if (name !== 'toJSON') {
                    return false;
                }
            }
            return true;
        }
        function internalData(elem, name, data, pvt) {
            if (!jQuery.acceptData(elem)) {
                return;
            }
            var ret, thisCache, internalKey = jQuery.expando, isNode = elem.nodeType, cache = isNode ? jQuery.cache : elem, id = isNode ? elem[internalKey] : elem[internalKey] && internalKey;
            if ((!id || !cache[id] || !pvt && !cache[id].data) && data === undefined && typeof name === 'string') {
                return;
            }
            if (!id) {
                if (isNode) {
                    id = elem[internalKey] = deletedIds.pop() || jQuery.guid++;
                } else {
                    id = internalKey;
                }
            }
            if (!cache[id]) {
                cache[id] = isNode ? {} : { toJSON: jQuery.noop };
            }
            if (typeof name === 'object' || typeof name === 'function') {
                if (pvt) {
                    cache[id] = jQuery.extend(cache[id], name);
                } else {
                    cache[id].data = jQuery.extend(cache[id].data, name);
                }
            }
            thisCache = cache[id];
            if (!pvt) {
                if (!thisCache.data) {
                    thisCache.data = {};
                }
                thisCache = thisCache.data;
            }
            if (data !== undefined) {
                thisCache[jQuery.camelCase(name)] = data;
            }
            if (typeof name === 'string') {
                ret = thisCache[name];
                if (ret == null) {
                    ret = thisCache[jQuery.camelCase(name)];
                }
            } else {
                ret = thisCache;
            }
            return ret;
        }
        function internalRemoveData(elem, name, pvt) {
            if (!jQuery.acceptData(elem)) {
                return;
            }
            var thisCache, i, isNode = elem.nodeType, cache = isNode ? jQuery.cache : elem, id = isNode ? elem[jQuery.expando] : jQuery.expando;
            if (!cache[id]) {
                return;
            }
            if (name) {
                thisCache = pvt ? cache[id] : cache[id].data;
                if (thisCache) {
                    if (!jQuery.isArray(name)) {
                        if (name in thisCache) {
                            name = [name];
                        } else {
                            name = jQuery.camelCase(name);
                            if (name in thisCache) {
                                name = [name];
                            } else {
                                name = name.split(' ');
                            }
                        }
                    } else {
                        name = name.concat(jQuery.map(name, jQuery.camelCase));
                    }
                    i = name.length;
                    while (i--) {
                        delete thisCache[name[i]];
                    }
                    if (pvt ? !isEmptyDataObject(thisCache) : !jQuery.isEmptyObject(thisCache)) {
                        return;
                    }
                }
            }
            if (!pvt) {
                delete cache[id].data;
                if (!isEmptyDataObject(cache[id])) {
                    return;
                }
            }
            if (isNode) {
                jQuery.cleanData([elem], true);
            } else if (support.deleteExpando || cache != cache.window) {
                delete cache[id];
            } else {
                cache[id] = null;
            }
        }
        jQuery.extend({
            cache: {},
            noData: {
                'applet ': true,
                'embed ': true,
                'object ': 'clsid:D27CDB6E-AE6D-11cf-96B8-444553540000'
            },
            hasData: function (elem) {
                elem = elem.nodeType ? jQuery.cache[elem[jQuery.expando]] : elem[jQuery.expando];
                return !!elem && !isEmptyDataObject(elem);
            },
            data: function (elem, name, data) {
                return internalData(elem, name, data);
            },
            removeData: function (elem, name) {
                return internalRemoveData(elem, name);
            },
            _data: function (elem, name, data) {
                return internalData(elem, name, data, true);
            },
            _removeData: function (elem, name) {
                return internalRemoveData(elem, name, true);
            }
        });
        jQuery.fn.extend({
            data: function (key, value) {
                var i, name, data, elem = this[0], attrs = elem && elem.attributes;
                if (key === undefined) {
                    if (this.length) {
                        data = jQuery.data(elem);
                        if (elem.nodeType === 1 && !jQuery._data(elem, 'parsedAttrs')) {
                            i = attrs.length;
                            while (i--) {
                                if (attrs[i]) {
                                    name = attrs[i].name;
                                    if (name.indexOf('data-') === 0) {
                                        name = jQuery.camelCase(name.slice(5));
                                        dataAttr(elem, name, data[name]);
                                    }
                                }
                            }
                            jQuery._data(elem, 'parsedAttrs', true);
                        }
                    }
                    return data;
                }
                if (typeof key === 'object') {
                    return this.each(function () {
                        jQuery.data(this, key);
                    });
                }
                return arguments.length > 1 ? this.each(function () {
                    jQuery.data(this, key, value);
                }) : elem ? dataAttr(elem, key, jQuery.data(elem, key)) : undefined;
            },
            removeData: function (key) {
                return this.each(function () {
                    jQuery.removeData(this, key);
                });
            }
        });
        jQuery.extend({
            queue: function (elem, type, data) {
                var queue;
                if (elem) {
                    type = (type || 'fx') + 'queue';
                    queue = jQuery._data(elem, type);
                    if (data) {
                        if (!queue || jQuery.isArray(data)) {
                            queue = jQuery._data(elem, type, jQuery.makeArray(data));
                        } else {
                            queue.push(data);
                        }
                    }
                    return queue || [];
                }
            },
            dequeue: function (elem, type) {
                type = type || 'fx';
                var queue = jQuery.queue(elem, type), startLength = queue.length, fn = queue.shift(), hooks = jQuery._queueHooks(elem, type), next = function () {
                        jQuery.dequeue(elem, type);
                    };
                if (fn === 'inprogress') {
                    fn = queue.shift();
                    startLength--;
                }
                if (fn) {
                    if (type === 'fx') {
                        queue.unshift('inprogress');
                    }
                    delete hooks.stop;
                    fn.call(elem, next, hooks);
                }
                if (!startLength && hooks) {
                    hooks.empty.fire();
                }
            },
            _queueHooks: function (elem, type) {
                var key = type + 'queueHooks';
                return jQuery._data(elem, key) || jQuery._data(elem, key, {
                    empty: jQuery.Callbacks('once memory').add(function () {
                        jQuery._removeData(elem, type + 'queue');
                        jQuery._removeData(elem, key);
                    })
                });
            }
        });
        jQuery.fn.extend({
            queue: function (type, data) {
                var setter = 2;
                if (typeof type !== 'string') {
                    data = type;
                    type = 'fx';
                    setter--;
                }
                if (arguments.length < setter) {
                    return jQuery.queue(this[0], type);
                }
                return data === undefined ? this : this.each(function () {
                    var queue = jQuery.queue(this, type, data);
                    jQuery._queueHooks(this, type);
                    if (type === 'fx' && queue[0] !== 'inprogress') {
                        jQuery.dequeue(this, type);
                    }
                });
            },
            dequeue: function (type) {
                return this.each(function () {
                    jQuery.dequeue(this, type);
                });
            },
            clearQueue: function (type) {
                return this.queue(type || 'fx', []);
            },
            promise: function (type, obj) {
                var tmp, count = 1, defer = jQuery.Deferred(), elements = this, i = this.length, resolve = function () {
                        if (!--count) {
                            defer.resolveWith(elements, [elements]);
                        }
                    };
                if (typeof type !== 'string') {
                    obj = type;
                    type = undefined;
                }
                type = type || 'fx';
                while (i--) {
                    tmp = jQuery._data(elements[i], type + 'queueHooks');
                    if (tmp && tmp.empty) {
                        count++;
                        tmp.empty.add(resolve);
                    }
                }
                resolve();
                return defer.promise(obj);
            }
        });
        var pnum = /[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source;
        var cssExpand = [
            'Top',
            'Right',
            'Bottom',
            'Left'
        ];
        var isHidden = function (elem, el) {
            elem = el || elem;
            return jQuery.css(elem, 'display') === 'none' || !jQuery.contains(elem.ownerDocument, elem);
        };
        var access = jQuery.access = function (elems, fn, key, value, chainable, emptyGet, raw) {
            var i = 0, length = elems.length, bulk = key == null;
            if (jQuery.type(key) === 'object') {
                chainable = true;
                for (i in key) {
                    jQuery.access(elems, fn, i, key[i], true, emptyGet, raw);
                }
            } else if (value !== undefined) {
                chainable = true;
                if (!jQuery.isFunction(value)) {
                    raw = true;
                }
                if (bulk) {
                    if (raw) {
                        fn.call(elems, value);
                        fn = null;
                    } else {
                        bulk = fn;
                        fn = function (elem, key, value) {
                            return bulk.call(jQuery(elem), value);
                        };
                    }
                }
                if (fn) {
                    for (; i < length; i++) {
                        fn(elems[i], key, raw ? value : value.call(elems[i], i, fn(elems[i], key)));
                    }
                }
            }
            return chainable ? elems : bulk ? fn.call(elems) : length ? fn(elems[0], key) : emptyGet;
        };
        var rcheckableType = /^(?:checkbox|radio)$/i;
        (function () {
            var input = document.createElement('input'), div = document.createElement('div'), fragment = document.createDocumentFragment();
            div.innerHTML = '  <link/><table></table><a href=\'/a\'>a</a><input type=\'checkbox\'/>';
            support.leadingWhitespace = div.firstChild.nodeType === 3;
            support.tbody = !div.getElementsByTagName('tbody').length;
            support.htmlSerialize = !!div.getElementsByTagName('link').length;
            support.html5Clone = document.createElement('nav').cloneNode(true).outerHTML !== '<:nav></:nav>';
            input.type = 'checkbox';
            input.checked = true;
            fragment.appendChild(input);
            support.appendChecked = input.checked;
            div.innerHTML = '<textarea>x</textarea>';
            support.noCloneChecked = !!div.cloneNode(true).lastChild.defaultValue;
            fragment.appendChild(div);
            div.innerHTML = '<input type=\'radio\' checked=\'checked\' name=\'t\'/>';
            support.checkClone = div.cloneNode(true).cloneNode(true).lastChild.checked;
            support.noCloneEvent = true;
            if (div.attachEvent) {
                div.attachEvent('onclick', function () {
                    support.noCloneEvent = false;
                });
                div.cloneNode(true).click();
            }
            if (support.deleteExpando == null) {
                support.deleteExpando = true;
                try {
                    delete div.test;
                } catch (e) {
                    support.deleteExpando = false;
                }
            }
        }());
        (function () {
            var i, eventName, div = document.createElement('div');
            for (i in {
                    submit: true,
                    change: true,
                    focusin: true
                }) {
                eventName = 'on' + i;
                if (!(support[i + 'Bubbles'] = eventName in window)) {
                    div.setAttribute(eventName, 't');
                    support[i + 'Bubbles'] = div.attributes[eventName].expando === false;
                }
            }
            div = null;
        }());
        var rformElems = /^(?:input|select|textarea)$/i, rkeyEvent = /^key/, rmouseEvent = /^(?:mouse|pointer|contextmenu)|click/, rfocusMorph = /^(?:focusinfocus|focusoutblur)$/, rtypenamespace = /^([^.]*)(?:\.(.+)|)$/;
        function returnTrue() {
            return true;
        }
        function returnFalse() {
            return false;
        }
        function safeActiveElement() {
            try {
                return document.activeElement;
            } catch (err) {
            }
        }
        jQuery.event = {
            global: {},
            add: function (elem, types, handler, data, selector) {
                var tmp, events, t, handleObjIn, special, eventHandle, handleObj, handlers, type, namespaces, origType, elemData = jQuery._data(elem);
                if (!elemData) {
                    return;
                }
                if (handler.handler) {
                    handleObjIn = handler;
                    handler = handleObjIn.handler;
                    selector = handleObjIn.selector;
                }
                if (!handler.guid) {
                    handler.guid = jQuery.guid++;
                }
                if (!(events = elemData.events)) {
                    events = elemData.events = {};
                }
                if (!(eventHandle = elemData.handle)) {
                    eventHandle = elemData.handle = function (e) {
                        return typeof jQuery !== strundefined && (!e || jQuery.event.triggered !== e.type) ? jQuery.event.dispatch.apply(eventHandle.elem, arguments) : undefined;
                    };
                    eventHandle.elem = elem;
                }
                types = (types || '').match(rnotwhite) || [''];
                t = types.length;
                while (t--) {
                    tmp = rtypenamespace.exec(types[t]) || [];
                    type = origType = tmp[1];
                    namespaces = (tmp[2] || '').split('.').sort();
                    if (!type) {
                        continue;
                    }
                    special = jQuery.event.special[type] || {};
                    type = (selector ? special.delegateType : special.bindType) || type;
                    special = jQuery.event.special[type] || {};
                    handleObj = jQuery.extend({
                        type: type,
                        origType: origType,
                        data: data,
                        handler: handler,
                        guid: handler.guid,
                        selector: selector,
                        needsContext: selector && jQuery.expr.match.needsContext.test(selector),
                        namespace: namespaces.join('.')
                    }, handleObjIn);
                    if (!(handlers = events[type])) {
                        handlers = events[type] = [];
                        handlers.delegateCount = 0;
                        if (!special.setup || special.setup.call(elem, data, namespaces, eventHandle) === false) {
                            if (elem.addEventListener) {
                                elem.addEventListener(type, eventHandle, false);
                            } else if (elem.attachEvent) {
                                elem.attachEvent('on' + type, eventHandle);
                            }
                        }
                    }
                    if (special.add) {
                        special.add.call(elem, handleObj);
                        if (!handleObj.handler.guid) {
                            handleObj.handler.guid = handler.guid;
                        }
                    }
                    if (selector) {
                        handlers.splice(handlers.delegateCount++, 0, handleObj);
                    } else {
                        handlers.push(handleObj);
                    }
                    jQuery.event.global[type] = true;
                }
                elem = null;
            },
            remove: function (elem, types, handler, selector, mappedTypes) {
                var j, handleObj, tmp, origCount, t, events, special, handlers, type, namespaces, origType, elemData = jQuery.hasData(elem) && jQuery._data(elem);
                if (!elemData || !(events = elemData.events)) {
                    return;
                }
                types = (types || '').match(rnotwhite) || [''];
                t = types.length;
                while (t--) {
                    tmp = rtypenamespace.exec(types[t]) || [];
                    type = origType = tmp[1];
                    namespaces = (tmp[2] || '').split('.').sort();
                    if (!type) {
                        for (type in events) {
                            jQuery.event.remove(elem, type + types[t], handler, selector, true);
                        }
                        continue;
                    }
                    special = jQuery.event.special[type] || {};
                    type = (selector ? special.delegateType : special.bindType) || type;
                    handlers = events[type] || [];
                    tmp = tmp[2] && new RegExp('(^|\\.)' + namespaces.join('\\.(?:.*\\.|)') + '(\\.|$)');
                    origCount = j = handlers.length;
                    while (j--) {
                        handleObj = handlers[j];
                        if ((mappedTypes || origType === handleObj.origType) && (!handler || handler.guid === handleObj.guid) && (!tmp || tmp.test(handleObj.namespace)) && (!selector || selector === handleObj.selector || selector === '**' && handleObj.selector)) {
                            handlers.splice(j, 1);
                            if (handleObj.selector) {
                                handlers.delegateCount--;
                            }
                            if (special.remove) {
                                special.remove.call(elem, handleObj);
                            }
                        }
                    }
                    if (origCount && !handlers.length) {
                        if (!special.teardown || special.teardown.call(elem, namespaces, elemData.handle) === false) {
                            jQuery.removeEvent(elem, type, elemData.handle);
                        }
                        delete events[type];
                    }
                }
                if (jQuery.isEmptyObject(events)) {
                    delete elemData.handle;
                    jQuery._removeData(elem, 'events');
                }
            },
            trigger: function (event, data, elem, onlyHandlers) {
                var handle, ontype, cur, bubbleType, special, tmp, i, eventPath = [elem || document], type = hasOwn.call(event, 'type') ? event.type : event, namespaces = hasOwn.call(event, 'namespace') ? event.namespace.split('.') : [];
                cur = tmp = elem = elem || document;
                if (elem.nodeType === 3 || elem.nodeType === 8) {
                    return;
                }
                if (rfocusMorph.test(type + jQuery.event.triggered)) {
                    return;
                }
                if (type.indexOf('.') >= 0) {
                    namespaces = type.split('.');
                    type = namespaces.shift();
                    namespaces.sort();
                }
                ontype = type.indexOf(':') < 0 && 'on' + type;
                event = event[jQuery.expando] ? event : new jQuery.Event(type, typeof event === 'object' && event);
                event.isTrigger = onlyHandlers ? 2 : 3;
                event.namespace = namespaces.join('.');
                event.namespace_re = event.namespace ? new RegExp('(^|\\.)' + namespaces.join('\\.(?:.*\\.|)') + '(\\.|$)') : null;
                event.result = undefined;
                if (!event.target) {
                    event.target = elem;
                }
                data = data == null ? [event] : jQuery.makeArray(data, [event]);
                special = jQuery.event.special[type] || {};
                if (!onlyHandlers && special.trigger && special.trigger.apply(elem, data) === false) {
                    return;
                }
                if (!onlyHandlers && !special.noBubble && !jQuery.isWindow(elem)) {
                    bubbleType = special.delegateType || type;
                    if (!rfocusMorph.test(bubbleType + type)) {
                        cur = cur.parentNode;
                    }
                    for (; cur; cur = cur.parentNode) {
                        eventPath.push(cur);
                        tmp = cur;
                    }
                    if (tmp === (elem.ownerDocument || document)) {
                        eventPath.push(tmp.defaultView || tmp.parentWindow || window);
                    }
                }
                i = 0;
                while ((cur = eventPath[i++]) && !event.isPropagationStopped()) {
                    event.type = i > 1 ? bubbleType : special.bindType || type;
                    handle = (jQuery._data(cur, 'events') || {})[event.type] && jQuery._data(cur, 'handle');
                    if (handle) {
                        handle.apply(cur, data);
                    }
                    handle = ontype && cur[ontype];
                    if (handle && handle.apply && jQuery.acceptData(cur)) {
                        event.result = handle.apply(cur, data);
                        if (event.result === false) {
                            event.preventDefault();
                        }
                    }
                }
                event.type = type;
                if (!onlyHandlers && !event.isDefaultPrevented()) {
                    if ((!special._default || special._default.apply(eventPath.pop(), data) === false) && jQuery.acceptData(elem)) {
                        if (ontype && elem[type] && !jQuery.isWindow(elem)) {
                            tmp = elem[ontype];
                            if (tmp) {
                                elem[ontype] = null;
                            }
                            jQuery.event.triggered = type;
                            try {
                                elem[type]();
                            } catch (e) {
                            }
                            jQuery.event.triggered = undefined;
                            if (tmp) {
                                elem[ontype] = tmp;
                            }
                        }
                    }
                }
                return event.result;
            },
            dispatch: function (event) {
                event = jQuery.event.fix(event);
                var i, ret, handleObj, matched, j, handlerQueue = [], args = slice.call(arguments), handlers = (jQuery._data(this, 'events') || {})[event.type] || [], special = jQuery.event.special[event.type] || {};
                args[0] = event;
                event.delegateTarget = this;
                if (special.preDispatch && special.preDispatch.call(this, event) === false) {
                    return;
                }
                handlerQueue = jQuery.event.handlers.call(this, event, handlers);
                i = 0;
                while ((matched = handlerQueue[i++]) && !event.isPropagationStopped()) {
                    event.currentTarget = matched.elem;
                    j = 0;
                    while ((handleObj = matched.handlers[j++]) && !event.isImmediatePropagationStopped()) {
                        if (!event.namespace_re || event.namespace_re.test(handleObj.namespace)) {
                            event.handleObj = handleObj;
                            event.data = handleObj.data;
                            ret = ((jQuery.event.special[handleObj.origType] || {}).handle || handleObj.handler).apply(matched.elem, args);
                            if (ret !== undefined) {
                                if ((event.result = ret) === false) {
                                    event.preventDefault();
                                    event.stopPropagation();
                                }
                            }
                        }
                    }
                }
                if (special.postDispatch) {
                    special.postDispatch.call(this, event);
                }
                return event.result;
            },
            handlers: function (event, handlers) {
                var sel, handleObj, matches, i, handlerQueue = [], delegateCount = handlers.delegateCount, cur = event.target;
                if (delegateCount && cur.nodeType && (!event.button || event.type !== 'click')) {
                    for (; cur != this; cur = cur.parentNode || this) {
                        if (cur.nodeType === 1 && (cur.disabled !== true || event.type !== 'click')) {
                            matches = [];
                            for (i = 0; i < delegateCount; i++) {
                                handleObj = handlers[i];
                                sel = handleObj.selector + ' ';
                                if (matches[sel] === undefined) {
                                    matches[sel] = handleObj.needsContext ? jQuery(sel, this).index(cur) >= 0 : jQuery.find(sel, this, null, [cur]).length;
                                }
                                if (matches[sel]) {
                                    matches.push(handleObj);
                                }
                            }
                            if (matches.length) {
                                handlerQueue.push({
                                    elem: cur,
                                    handlers: matches
                                });
                            }
                        }
                    }
                }
                if (delegateCount < handlers.length) {
                    handlerQueue.push({
                        elem: this,
                        handlers: handlers.slice(delegateCount)
                    });
                }
                return handlerQueue;
            },
            fix: function (event) {
                if (event[jQuery.expando]) {
                    return event;
                }
                var i, prop, copy, type = event.type, originalEvent = event, fixHook = this.fixHooks[type];
                if (!fixHook) {
                    this.fixHooks[type] = fixHook = rmouseEvent.test(type) ? this.mouseHooks : rkeyEvent.test(type) ? this.keyHooks : {};
                }
                copy = fixHook.props ? this.props.concat(fixHook.props) : this.props;
                event = new jQuery.Event(originalEvent);
                i = copy.length;
                while (i--) {
                    prop = copy[i];
                    event[prop] = originalEvent[prop];
                }
                if (!event.target) {
                    event.target = originalEvent.srcElement || document;
                }
                if (event.target.nodeType === 3) {
                    event.target = event.target.parentNode;
                }
                event.metaKey = !!event.metaKey;
                return fixHook.filter ? fixHook.filter(event, originalEvent) : event;
            },
            props: 'altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which'.split(' '),
            fixHooks: {},
            keyHooks: {
                props: 'char charCode key keyCode'.split(' '),
                filter: function (event, original) {
                    if (event.which == null) {
                        event.which = original.charCode != null ? original.charCode : original.keyCode;
                    }
                    return event;
                }
            },
            mouseHooks: {
                props: 'button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement'.split(' '),
                filter: function (event, original) {
                    var body, eventDoc, doc, button = original.button, fromElement = original.fromElement;
                    if (event.pageX == null && original.clientX != null) {
                        eventDoc = event.target.ownerDocument || document;
                        doc = eventDoc.documentElement;
                        body = eventDoc.body;
                        event.pageX = original.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) - (doc && doc.clientLeft || body && body.clientLeft || 0);
                        event.pageY = original.clientY + (doc && doc.scrollTop || body && body.scrollTop || 0) - (doc && doc.clientTop || body && body.clientTop || 0);
                    }
                    if (!event.relatedTarget && fromElement) {
                        event.relatedTarget = fromElement === event.target ? original.toElement : fromElement;
                    }
                    if (!event.which && button !== undefined) {
                        event.which = button & 1 ? 1 : button & 2 ? 3 : button & 4 ? 2 : 0;
                    }
                    return event;
                }
            },
            special: {
                load: { noBubble: true },
                focus: {
                    trigger: function () {
                        if (this !== safeActiveElement() && this.focus) {
                            try {
                                this.focus();
                                return false;
                            } catch (e) {
                            }
                        }
                    },
                    delegateType: 'focusin'
                },
                blur: {
                    trigger: function () {
                        if (this === safeActiveElement() && this.blur) {
                            this.blur();
                            return false;
                        }
                    },
                    delegateType: 'focusout'
                },
                click: {
                    trigger: function () {
                        if (jQuery.nodeName(this, 'input') && this.type === 'checkbox' && this.click) {
                            this.click();
                            return false;
                        }
                    },
                    _default: function (event) {
                        return jQuery.nodeName(event.target, 'a');
                    }
                },
                beforeunload: {
                    postDispatch: function (event) {
                        if (event.result !== undefined && event.originalEvent) {
                            event.originalEvent.returnValue = event.result;
                        }
                    }
                }
            },
            simulate: function (type, elem, event, bubble) {
                var e = jQuery.extend(new jQuery.Event(), event, {
                    type: type,
                    isSimulated: true,
                    originalEvent: {}
                });
                if (bubble) {
                    jQuery.event.trigger(e, null, elem);
                } else {
                    jQuery.event.dispatch.call(elem, e);
                }
                if (e.isDefaultPrevented()) {
                    event.preventDefault();
                }
            }
        };
        jQuery.removeEvent = document.removeEventListener ? function (elem, type, handle) {
            if (elem.removeEventListener) {
                elem.removeEventListener(type, handle, false);
            }
        } : function (elem, type, handle) {
            var name = 'on' + type;
            if (elem.detachEvent) {
                if (typeof elem[name] === strundefined) {
                    elem[name] = null;
                }
                elem.detachEvent(name, handle);
            }
        };
        jQuery.Event = function (src, props) {
            if (!(this instanceof jQuery.Event)) {
                return new jQuery.Event(src, props);
            }
            if (src && src.type) {
                this.originalEvent = src;
                this.type = src.type;
                this.isDefaultPrevented = src.defaultPrevented || src.defaultPrevented === undefined && src.returnValue === false ? returnTrue : returnFalse;
            } else {
                this.type = src;
            }
            if (props) {
                jQuery.extend(this, props);
            }
            this.timeStamp = src && src.timeStamp || jQuery.now();
            this[jQuery.expando] = true;
        };
        jQuery.Event.prototype = {
            isDefaultPrevented: returnFalse,
            isPropagationStopped: returnFalse,
            isImmediatePropagationStopped: returnFalse,
            preventDefault: function () {
                var e = this.originalEvent;
                this.isDefaultPrevented = returnTrue;
                if (!e) {
                    return;
                }
                if (e.preventDefault) {
                    e.preventDefault();
                } else {
                    e.returnValue = false;
                }
            },
            stopPropagation: function () {
                var e = this.originalEvent;
                this.isPropagationStopped = returnTrue;
                if (!e) {
                    return;
                }
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                e.cancelBubble = true;
            },
            stopImmediatePropagation: function () {
                var e = this.originalEvent;
                this.isImmediatePropagationStopped = returnTrue;
                if (e && e.stopImmediatePropagation) {
                    e.stopImmediatePropagation();
                }
                this.stopPropagation();
            }
        };
        jQuery.each({
            mouseenter: 'mouseover',
            mouseleave: 'mouseout',
            pointerenter: 'pointerover',
            pointerleave: 'pointerout'
        }, function (orig, fix) {
            jQuery.event.special[orig] = {
                delegateType: fix,
                bindType: fix,
                handle: function (event) {
                    var ret, target = this, related = event.relatedTarget, handleObj = event.handleObj;
                    if (!related || related !== target && !jQuery.contains(target, related)) {
                        event.type = handleObj.origType;
                        ret = handleObj.handler.apply(this, arguments);
                        event.type = fix;
                    }
                    return ret;
                }
            };
        });
        if (!support.submitBubbles) {
            jQuery.event.special.submit = {
                setup: function () {
                    if (jQuery.nodeName(this, 'form')) {
                        return false;
                    }
                    jQuery.event.add(this, 'click._submit keypress._submit', function (e) {
                        var elem = e.target, form = jQuery.nodeName(elem, 'input') || jQuery.nodeName(elem, 'button') ? elem.form : undefined;
                        if (form && !jQuery._data(form, 'submitBubbles')) {
                            jQuery.event.add(form, 'submit._submit', function (event) {
                                event._submit_bubble = true;
                            });
                            jQuery._data(form, 'submitBubbles', true);
                        }
                    });
                },
                postDispatch: function (event) {
                    if (event._submit_bubble) {
                        delete event._submit_bubble;
                        if (this.parentNode && !event.isTrigger) {
                            jQuery.event.simulate('submit', this.parentNode, event, true);
                        }
                    }
                },
                teardown: function () {
                    if (jQuery.nodeName(this, 'form')) {
                        return false;
                    }
                    jQuery.event.remove(this, '._submit');
                }
            };
        }
        if (!support.changeBubbles) {
            jQuery.event.special.change = {
                setup: function () {
                    if (rformElems.test(this.nodeName)) {
                        if (this.type === 'checkbox' || this.type === 'radio') {
                            jQuery.event.add(this, 'propertychange._change', function (event) {
                                if (event.originalEvent.propertyName === 'checked') {
                                    this._just_changed = true;
                                }
                            });
                            jQuery.event.add(this, 'click._change', function (event) {
                                if (this._just_changed && !event.isTrigger) {
                                    this._just_changed = false;
                                }
                                jQuery.event.simulate('change', this, event, true);
                            });
                        }
                        return false;
                    }
                    jQuery.event.add(this, 'beforeactivate._change', function (e) {
                        var elem = e.target;
                        if (rformElems.test(elem.nodeName) && !jQuery._data(elem, 'changeBubbles')) {
                            jQuery.event.add(elem, 'change._change', function (event) {
                                if (this.parentNode && !event.isSimulated && !event.isTrigger) {
                                    jQuery.event.simulate('change', this.parentNode, event, true);
                                }
                            });
                            jQuery._data(elem, 'changeBubbles', true);
                        }
                    });
                },
                handle: function (event) {
                    var elem = event.target;
                    if (this !== elem || event.isSimulated || event.isTrigger || elem.type !== 'radio' && elem.type !== 'checkbox') {
                        return event.handleObj.handler.apply(this, arguments);
                    }
                },
                teardown: function () {
                    jQuery.event.remove(this, '._change');
                    return !rformElems.test(this.nodeName);
                }
            };
        }
        if (!support.focusinBubbles) {
            jQuery.each({
                focus: 'focusin',
                blur: 'focusout'
            }, function (orig, fix) {
                var handler = function (event) {
                    jQuery.event.simulate(fix, event.target, jQuery.event.fix(event), true);
                };
                jQuery.event.special[fix] = {
                    setup: function () {
                        var doc = this.ownerDocument || this, attaches = jQuery._data(doc, fix);
                        if (!attaches) {
                            doc.addEventListener(orig, handler, true);
                        }
                        jQuery._data(doc, fix, (attaches || 0) + 1);
                    },
                    teardown: function () {
                        var doc = this.ownerDocument || this, attaches = jQuery._data(doc, fix) - 1;
                        if (!attaches) {
                            doc.removeEventListener(orig, handler, true);
                            jQuery._removeData(doc, fix);
                        } else {
                            jQuery._data(doc, fix, attaches);
                        }
                    }
                };
            });
        }
        jQuery.fn.extend({
            on: function (types, selector, data, fn, one) {
                var type, origFn;
                if (typeof types === 'object') {
                    if (typeof selector !== 'string') {
                        data = data || selector;
                        selector = undefined;
                    }
                    for (type in types) {
                        this.on(type, selector, data, types[type], one);
                    }
                    return this;
                }
                if (data == null && fn == null) {
                    fn = selector;
                    data = selector = undefined;
                } else if (fn == null) {
                    if (typeof selector === 'string') {
                        fn = data;
                        data = undefined;
                    } else {
                        fn = data;
                        data = selector;
                        selector = undefined;
                    }
                }
                if (fn === false) {
                    fn = returnFalse;
                } else if (!fn) {
                    return this;
                }
                if (one === 1) {
                    origFn = fn;
                    fn = function (event) {
                        jQuery().off(event);
                        return origFn.apply(this, arguments);
                    };
                    fn.guid = origFn.guid || (origFn.guid = jQuery.guid++);
                }
                return this.each(function () {
                    jQuery.event.add(this, types, fn, data, selector);
                });
            },
            one: function (types, selector, data, fn) {
                return this.on(types, selector, data, fn, 1);
            },
            off: function (types, selector, fn) {
                var handleObj, type;
                if (types && types.preventDefault && types.handleObj) {
                    handleObj = types.handleObj;
                    jQuery(types.delegateTarget).off(handleObj.namespace ? handleObj.origType + '.' + handleObj.namespace : handleObj.origType, handleObj.selector, handleObj.handler);
                    return this;
                }
                if (typeof types === 'object') {
                    for (type in types) {
                        this.off(type, selector, types[type]);
                    }
                    return this;
                }
                if (selector === false || typeof selector === 'function') {
                    fn = selector;
                    selector = undefined;
                }
                if (fn === false) {
                    fn = returnFalse;
                }
                return this.each(function () {
                    jQuery.event.remove(this, types, fn, selector);
                });
            },
            trigger: function (type, data) {
                return this.each(function () {
                    jQuery.event.trigger(type, data, this);
                });
            },
            triggerHandler: function (type, data) {
                var elem = this[0];
                if (elem) {
                    return jQuery.event.trigger(type, data, elem, true);
                }
            }
        });
        function createSafeFragment(document) {
            var list = nodeNames.split('|'), safeFrag = document.createDocumentFragment();
            if (safeFrag.createElement) {
                while (list.length) {
                    safeFrag.createElement(list.pop());
                }
            }
            return safeFrag;
        }
        var nodeNames = 'abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|' + 'header|hgroup|mark|meter|nav|output|progress|section|summary|time|video', rinlinejQuery = / jQuery\d+="(?:null|\d+)"/g, rnoshimcache = new RegExp('<(?:' + nodeNames + ')[\\s/>]', 'i'), rleadingWhitespace = /^\s+/, rxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi, rtagName = /<([\w:]+)/, rtbody = /<tbody/i, rhtml = /<|&#?\w+;/, rnoInnerhtml = /<(?:script|style|link)/i, rchecked = /checked\s*(?:[^=]|=\s*.checked.)/i, rscriptType = /^$|\/(?:java|ecma)script/i, rscriptTypeMasked = /^true\/(.*)/, rcleanScript = /^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g, wrapMap = {
                option: [
                    1,
                    '<select multiple=\'multiple\'>',
                    '</select>'
                ],
                legend: [
                    1,
                    '<fieldset>',
                    '</fieldset>'
                ],
                area: [
                    1,
                    '<map>',
                    '</map>'
                ],
                param: [
                    1,
                    '<object>',
                    '</object>'
                ],
                thead: [
                    1,
                    '<table>',
                    '</table>'
                ],
                tr: [
                    2,
                    '<table><tbody>',
                    '</tbody></table>'
                ],
                col: [
                    2,
                    '<table><tbody></tbody><colgroup>',
                    '</colgroup></table>'
                ],
                td: [
                    3,
                    '<table><tbody><tr>',
                    '</tr></tbody></table>'
                ],
                _default: support.htmlSerialize ? [
                    0,
                    '',
                    ''
                ] : [
                    1,
                    'X<div>',
                    '</div>'
                ]
            }, safeFragment = createSafeFragment(document), fragmentDiv = safeFragment.appendChild(document.createElement('div'));
        wrapMap.optgroup = wrapMap.option;
        wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;
        wrapMap.th = wrapMap.td;
        function getAll(context, tag) {
            var elems, elem, i = 0, found = typeof context.getElementsByTagName !== strundefined ? context.getElementsByTagName(tag || '*') : typeof context.querySelectorAll !== strundefined ? context.querySelectorAll(tag || '*') : undefined;
            if (!found) {
                for (found = [], elems = context.childNodes || context; (elem = elems[i]) != null; i++) {
                    if (!tag || jQuery.nodeName(elem, tag)) {
                        found.push(elem);
                    } else {
                        jQuery.merge(found, getAll(elem, tag));
                    }
                }
            }
            return tag === undefined || tag && jQuery.nodeName(context, tag) ? jQuery.merge([context], found) : found;
        }
        function fixDefaultChecked(elem) {
            if (rcheckableType.test(elem.type)) {
                elem.defaultChecked = elem.checked;
            }
        }
        function manipulationTarget(elem, content) {
            return jQuery.nodeName(elem, 'table') && jQuery.nodeName(content.nodeType !== 11 ? content : content.firstChild, 'tr') ? elem.getElementsByTagName('tbody')[0] || elem.appendChild(elem.ownerDocument.createElement('tbody')) : elem;
        }
        function disableScript(elem) {
            elem.type = (jQuery.find.attr(elem, 'type') !== null) + '/' + elem.type;
            return elem;
        }
        function restoreScript(elem) {
            var match = rscriptTypeMasked.exec(elem.type);
            if (match) {
                elem.type = match[1];
            } else {
                elem.removeAttribute('type');
            }
            return elem;
        }
        function setGlobalEval(elems, refElements) {
            var elem, i = 0;
            for (; (elem = elems[i]) != null; i++) {
                jQuery._data(elem, 'globalEval', !refElements || jQuery._data(refElements[i], 'globalEval'));
            }
        }
        function cloneCopyEvent(src, dest) {
            if (dest.nodeType !== 1 || !jQuery.hasData(src)) {
                return;
            }
            var type, i, l, oldData = jQuery._data(src), curData = jQuery._data(dest, oldData), events = oldData.events;
            if (events) {
                delete curData.handle;
                curData.events = {};
                for (type in events) {
                    for (i = 0, l = events[type].length; i < l; i++) {
                        jQuery.event.add(dest, type, events[type][i]);
                    }
                }
            }
            if (curData.data) {
                curData.data = jQuery.extend({}, curData.data);
            }
        }
        function fixCloneNodeIssues(src, dest) {
            var nodeName, e, data;
            if (dest.nodeType !== 1) {
                return;
            }
            nodeName = dest.nodeName.toLowerCase();
            if (!support.noCloneEvent && dest[jQuery.expando]) {
                data = jQuery._data(dest);
                for (e in data.events) {
                    jQuery.removeEvent(dest, e, data.handle);
                }
                dest.removeAttribute(jQuery.expando);
            }
            if (nodeName === 'script' && dest.text !== src.text) {
                disableScript(dest).text = src.text;
                restoreScript(dest);
            } else if (nodeName === 'object') {
                if (dest.parentNode) {
                    dest.outerHTML = src.outerHTML;
                }
                if (support.html5Clone && (src.innerHTML && !jQuery.trim(dest.innerHTML))) {
                    dest.innerHTML = src.innerHTML;
                }
            } else if (nodeName === 'input' && rcheckableType.test(src.type)) {
                dest.defaultChecked = dest.checked = src.checked;
                if (dest.value !== src.value) {
                    dest.value = src.value;
                }
            } else if (nodeName === 'option') {
                dest.defaultSelected = dest.selected = src.defaultSelected;
            } else if (nodeName === 'input' || nodeName === 'textarea') {
                dest.defaultValue = src.defaultValue;
            }
        }
        jQuery.extend({
            clone: function (elem, dataAndEvents, deepDataAndEvents) {
                var destElements, node, clone, i, srcElements, inPage = jQuery.contains(elem.ownerDocument, elem);
                if (support.html5Clone || jQuery.isXMLDoc(elem) || !rnoshimcache.test('<' + elem.nodeName + '>')) {
                    clone = elem.cloneNode(true);
                } else {
                    fragmentDiv.innerHTML = elem.outerHTML;
                    fragmentDiv.removeChild(clone = fragmentDiv.firstChild);
                }
                if ((!support.noCloneEvent || !support.noCloneChecked) && (elem.nodeType === 1 || elem.nodeType === 11) && !jQuery.isXMLDoc(elem)) {
                    destElements = getAll(clone);
                    srcElements = getAll(elem);
                    for (i = 0; (node = srcElements[i]) != null; ++i) {
                        if (destElements[i]) {
                            fixCloneNodeIssues(node, destElements[i]);
                        }
                    }
                }
                if (dataAndEvents) {
                    if (deepDataAndEvents) {
                        srcElements = srcElements || getAll(elem);
                        destElements = destElements || getAll(clone);
                        for (i = 0; (node = srcElements[i]) != null; i++) {
                            cloneCopyEvent(node, destElements[i]);
                        }
                    } else {
                        cloneCopyEvent(elem, clone);
                    }
                }
                destElements = getAll(clone, 'script');
                if (destElements.length > 0) {
                    setGlobalEval(destElements, !inPage && getAll(elem, 'script'));
                }
                destElements = srcElements = node = null;
                return clone;
            },
            buildFragment: function (elems, context, scripts, selection) {
                var j, elem, contains, tmp, tag, tbody, wrap, l = elems.length, safe = createSafeFragment(context), nodes = [], i = 0;
                for (; i < l; i++) {
                    elem = elems[i];
                    if (elem || elem === 0) {
                        if (jQuery.type(elem) === 'object') {
                            jQuery.merge(nodes, elem.nodeType ? [elem] : elem);
                        } else if (!rhtml.test(elem)) {
                            nodes.push(context.createTextNode(elem));
                        } else {
                            tmp = tmp || safe.appendChild(context.createElement('div'));
                            tag = (rtagName.exec(elem) || [
                                '',
                                ''
                            ])[1].toLowerCase();
                            wrap = wrapMap[tag] || wrapMap._default;
                            tmp.innerHTML = wrap[1] + elem.replace(rxhtmlTag, '<$1></$2>') + wrap[2];
                            j = wrap[0];
                            while (j--) {
                                tmp = tmp.lastChild;
                            }
                            if (!support.leadingWhitespace && rleadingWhitespace.test(elem)) {
                                nodes.push(context.createTextNode(rleadingWhitespace.exec(elem)[0]));
                            }
                            if (!support.tbody) {
                                elem = tag === 'table' && !rtbody.test(elem) ? tmp.firstChild : wrap[1] === '<table>' && !rtbody.test(elem) ? tmp : 0;
                                j = elem && elem.childNodes.length;
                                while (j--) {
                                    if (jQuery.nodeName(tbody = elem.childNodes[j], 'tbody') && !tbody.childNodes.length) {
                                        elem.removeChild(tbody);
                                    }
                                }
                            }
                            jQuery.merge(nodes, tmp.childNodes);
                            tmp.textContent = '';
                            while (tmp.firstChild) {
                                tmp.removeChild(tmp.firstChild);
                            }
                            tmp = safe.lastChild;
                        }
                    }
                }
                if (tmp) {
                    safe.removeChild(tmp);
                }
                if (!support.appendChecked) {
                    jQuery.grep(getAll(nodes, 'input'), fixDefaultChecked);
                }
                i = 0;
                while (elem = nodes[i++]) {
                    if (selection && jQuery.inArray(elem, selection) !== -1) {
                        continue;
                    }
                    contains = jQuery.contains(elem.ownerDocument, elem);
                    tmp = getAll(safe.appendChild(elem), 'script');
                    if (contains) {
                        setGlobalEval(tmp);
                    }
                    if (scripts) {
                        j = 0;
                        while (elem = tmp[j++]) {
                            if (rscriptType.test(elem.type || '')) {
                                scripts.push(elem);
                            }
                        }
                    }
                }
                tmp = null;
                return safe;
            },
            cleanData: function (elems, acceptData) {
                var elem, type, id, data, i = 0, internalKey = jQuery.expando, cache = jQuery.cache, deleteExpando = support.deleteExpando, special = jQuery.event.special;
                for (; (elem = elems[i]) != null; i++) {
                    if (acceptData || jQuery.acceptData(elem)) {
                        id = elem[internalKey];
                        data = id && cache[id];
                        if (data) {
                            if (data.events) {
                                for (type in data.events) {
                                    if (special[type]) {
                                        jQuery.event.remove(elem, type);
                                    } else {
                                        jQuery.removeEvent(elem, type, data.handle);
                                    }
                                }
                            }
                            if (cache[id]) {
                                delete cache[id];
                                if (deleteExpando) {
                                    delete elem[internalKey];
                                } else if (typeof elem.removeAttribute !== strundefined) {
                                    elem.removeAttribute(internalKey);
                                } else {
                                    elem[internalKey] = null;
                                }
                                deletedIds.push(id);
                            }
                        }
                    }
                }
            }
        });
        jQuery.fn.extend({
            text: function (value) {
                return access(this, function (value) {
                    return value === undefined ? jQuery.text(this) : this.empty().append((this[0] && this[0].ownerDocument || document).createTextNode(value));
                }, null, value, arguments.length);
            },
            append: function () {
                return this.domManip(arguments, function (elem) {
                    if (this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9) {
                        var target = manipulationTarget(this, elem);
                        target.appendChild(elem);
                    }
                });
            },
            prepend: function () {
                return this.domManip(arguments, function (elem) {
                    if (this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9) {
                        var target = manipulationTarget(this, elem);
                        target.insertBefore(elem, target.firstChild);
                    }
                });
            },
            before: function () {
                return this.domManip(arguments, function (elem) {
                    if (this.parentNode) {
                        this.parentNode.insertBefore(elem, this);
                    }
                });
            },
            after: function () {
                return this.domManip(arguments, function (elem) {
                    if (this.parentNode) {
                        this.parentNode.insertBefore(elem, this.nextSibling);
                    }
                });
            },
            remove: function (selector, keepData) {
                var elem, elems = selector ? jQuery.filter(selector, this) : this, i = 0;
                for (; (elem = elems[i]) != null; i++) {
                    if (!keepData && elem.nodeType === 1) {
                        jQuery.cleanData(getAll(elem));
                    }
                    if (elem.parentNode) {
                        if (keepData && jQuery.contains(elem.ownerDocument, elem)) {
                            setGlobalEval(getAll(elem, 'script'));
                        }
                        elem.parentNode.removeChild(elem);
                    }
                }
                return this;
            },
            empty: function () {
                var elem, i = 0;
                for (; (elem = this[i]) != null; i++) {
                    if (elem.nodeType === 1) {
                        jQuery.cleanData(getAll(elem, false));
                    }
                    while (elem.firstChild) {
                        elem.removeChild(elem.firstChild);
                    }
                    if (elem.options && jQuery.nodeName(elem, 'select')) {
                        elem.options.length = 0;
                    }
                }
                return this;
            },
            clone: function (dataAndEvents, deepDataAndEvents) {
                dataAndEvents = dataAndEvents == null ? false : dataAndEvents;
                deepDataAndEvents = deepDataAndEvents == null ? dataAndEvents : deepDataAndEvents;
                return this.map(function () {
                    return jQuery.clone(this, dataAndEvents, deepDataAndEvents);
                });
            },
            html: function (value) {
                return access(this, function (value) {
                    var elem = this[0] || {}, i = 0, l = this.length;
                    if (value === undefined) {
                        return elem.nodeType === 1 ? elem.innerHTML.replace(rinlinejQuery, '') : undefined;
                    }
                    if (typeof value === 'string' && !rnoInnerhtml.test(value) && (support.htmlSerialize || !rnoshimcache.test(value)) && (support.leadingWhitespace || !rleadingWhitespace.test(value)) && !wrapMap[(rtagName.exec(value) || [
                            '',
                            ''
                        ])[1].toLowerCase()]) {
                        value = value.replace(rxhtmlTag, '<$1></$2>');
                        try {
                            for (; i < l; i++) {
                                elem = this[i] || {};
                                if (elem.nodeType === 1) {
                                    jQuery.cleanData(getAll(elem, false));
                                    elem.innerHTML = value;
                                }
                            }
                            elem = 0;
                        } catch (e) {
                        }
                    }
                    if (elem) {
                        this.empty().append(value);
                    }
                }, null, value, arguments.length);
            },
            replaceWith: function () {
                var arg = arguments[0];
                this.domManip(arguments, function (elem) {
                    arg = this.parentNode;
                    jQuery.cleanData(getAll(this));
                    if (arg) {
                        arg.replaceChild(elem, this);
                    }
                });
                return arg && (arg.length || arg.nodeType) ? this : this.remove();
            },
            detach: function (selector) {
                return this.remove(selector, true);
            },
            domManip: function (args, callback) {
                args = concat.apply([], args);
                var first, node, hasScripts, scripts, doc, fragment, i = 0, l = this.length, set = this, iNoClone = l - 1, value = args[0], isFunction = jQuery.isFunction(value);
                if (isFunction || l > 1 && typeof value === 'string' && !support.checkClone && rchecked.test(value)) {
                    return this.each(function (index) {
                        var self = set.eq(index);
                        if (isFunction) {
                            args[0] = value.call(this, index, self.html());
                        }
                        self.domManip(args, callback);
                    });
                }
                if (l) {
                    fragment = jQuery.buildFragment(args, this[0].ownerDocument, false, this);
                    first = fragment.firstChild;
                    if (fragment.childNodes.length === 1) {
                        fragment = first;
                    }
                    if (first) {
                        scripts = jQuery.map(getAll(fragment, 'script'), disableScript);
                        hasScripts = scripts.length;
                        for (; i < l; i++) {
                            node = fragment;
                            if (i !== iNoClone) {
                                node = jQuery.clone(node, true, true);
                                if (hasScripts) {
                                    jQuery.merge(scripts, getAll(node, 'script'));
                                }
                            }
                            callback.call(this[i], node, i);
                        }
                        if (hasScripts) {
                            doc = scripts[scripts.length - 1].ownerDocument;
                            jQuery.map(scripts, restoreScript);
                            for (i = 0; i < hasScripts; i++) {
                                node = scripts[i];
                                if (rscriptType.test(node.type || '') && !jQuery._data(node, 'globalEval') && jQuery.contains(doc, node)) {
                                    if (node.src) {
                                        if (jQuery._evalUrl) {
                                            jQuery._evalUrl(node.src);
                                        }
                                    } else {
                                        jQuery.globalEval((node.text || node.textContent || node.innerHTML || '').replace(rcleanScript, ''));
                                    }
                                }
                            }
                        }
                        fragment = first = null;
                    }
                }
                return this;
            }
        });
        jQuery.each({
            appendTo: 'append',
            prependTo: 'prepend',
            insertBefore: 'before',
            insertAfter: 'after',
            replaceAll: 'replaceWith'
        }, function (name, original) {
            jQuery.fn[name] = function (selector) {
                var elems, i = 0, ret = [], insert = jQuery(selector), last = insert.length - 1;
                for (; i <= last; i++) {
                    elems = i === last ? this : this.clone(true);
                    jQuery(insert[i])[original](elems);
                    push.apply(ret, elems.get());
                }
                return this.pushStack(ret);
            };
        });
        var iframe, elemdisplay = {};
        function actualDisplay(name, doc) {
            var style, elem = jQuery(doc.createElement(name)).appendTo(doc.body), display = window.getDefaultComputedStyle && (style = window.getDefaultComputedStyle(elem[0])) ? style.display : jQuery.css(elem[0], 'display');
            elem.detach();
            return display;
        }
        function defaultDisplay(nodeName) {
            var doc = document, display = elemdisplay[nodeName];
            if (!display) {
                display = actualDisplay(nodeName, doc);
                if (display === 'none' || !display) {
                    iframe = (iframe || jQuery('<iframe frameborder=\'0\' width=\'0\' height=\'0\'/>')).appendTo(doc.documentElement);
                    doc = (iframe[0].contentWindow || iframe[0].contentDocument).document;
                    doc.write();
                    doc.close();
                    display = actualDisplay(nodeName, doc);
                    iframe.detach();
                }
                elemdisplay[nodeName] = display;
            }
            return display;
        }
        (function () {
            var shrinkWrapBlocksVal;
            support.shrinkWrapBlocks = function () {
                if (shrinkWrapBlocksVal != null) {
                    return shrinkWrapBlocksVal;
                }
                shrinkWrapBlocksVal = false;
                var div, body, container;
                body = document.getElementsByTagName('body')[0];
                if (!body || !body.style) {
                    return;
                }
                div = document.createElement('div');
                container = document.createElement('div');
                container.style.cssText = 'position:absolute;border:0;width:0;height:0;top:0;left:-9999px';
                body.appendChild(container).appendChild(div);
                if (typeof div.style.zoom !== strundefined) {
                    div.style.cssText = '-webkit-box-sizing:content-box;-moz-box-sizing:content-box;' + 'box-sizing:content-box;display:block;margin:0;border:0;' + 'padding:1px;width:1px;zoom:1';
                    div.appendChild(document.createElement('div')).style.width = '5px';
                    shrinkWrapBlocksVal = div.offsetWidth !== 3;
                }
                body.removeChild(container);
                return shrinkWrapBlocksVal;
            };
        }());
        var rmargin = /^margin/;
        var rnumnonpx = new RegExp('^(' + pnum + ')(?!px)[a-z%]+$', 'i');
        var getStyles, curCSS, rposition = /^(top|right|bottom|left)$/;
        if (window.getComputedStyle) {
            getStyles = function (elem) {
                return elem.ownerDocument.defaultView.getComputedStyle(elem, null);
            };
            curCSS = function (elem, name, computed) {
                var width, minWidth, maxWidth, ret, style = elem.style;
                computed = computed || getStyles(elem);
                ret = computed ? computed.getPropertyValue(name) || computed[name] : undefined;
                if (computed) {
                    if (ret === '' && !jQuery.contains(elem.ownerDocument, elem)) {
                        ret = jQuery.style(elem, name);
                    }
                    if (rnumnonpx.test(ret) && rmargin.test(name)) {
                        width = style.width;
                        minWidth = style.minWidth;
                        maxWidth = style.maxWidth;
                        style.minWidth = style.maxWidth = style.width = ret;
                        ret = computed.width;
                        style.width = width;
                        style.minWidth = minWidth;
                        style.maxWidth = maxWidth;
                    }
                }
                return ret === undefined ? ret : ret + '';
            };
        } else if (document.documentElement.currentStyle) {
            getStyles = function (elem) {
                return elem.currentStyle;
            };
            curCSS = function (elem, name, computed) {
                var left, rs, rsLeft, ret, style = elem.style;
                computed = computed || getStyles(elem);
                ret = computed ? computed[name] : undefined;
                if (ret == null && style && style[name]) {
                    ret = style[name];
                }
                if (rnumnonpx.test(ret) && !rposition.test(name)) {
                    left = style.left;
                    rs = elem.runtimeStyle;
                    rsLeft = rs && rs.left;
                    if (rsLeft) {
                        rs.left = elem.currentStyle.left;
                    }
                    style.left = name === 'fontSize' ? '1em' : ret;
                    ret = style.pixelLeft + 'px';
                    style.left = left;
                    if (rsLeft) {
                        rs.left = rsLeft;
                    }
                }
                return ret === undefined ? ret : ret + '' || 'auto';
            };
        }
        function addGetHookIf(conditionFn, hookFn) {
            return {
                get: function () {
                    var condition = conditionFn();
                    if (condition == null) {
                        return;
                    }
                    if (condition) {
                        delete this.get;
                        return;
                    }
                    return (this.get = hookFn).apply(this, arguments);
                }
            };
        }
        (function () {
            var div, style, a, pixelPositionVal, boxSizingReliableVal, reliableHiddenOffsetsVal, reliableMarginRightVal;
            div = document.createElement('div');
            div.innerHTML = '  <link/><table></table><a href=\'/a\'>a</a><input type=\'checkbox\'/>';
            a = div.getElementsByTagName('a')[0];
            style = a && a.style;
            if (!style) {
                return;
            }
            style.cssText = 'float:left;opacity:.5';
            support.opacity = style.opacity === '0.5';
            support.cssFloat = !!style.cssFloat;
            div.style.backgroundClip = 'content-box';
            div.cloneNode(true).style.backgroundClip = '';
            support.clearCloneStyle = div.style.backgroundClip === 'content-box';
            support.boxSizing = style.boxSizing === '' || style.MozBoxSizing === '' || style.WebkitBoxSizing === '';
            jQuery.extend(support, {
                reliableHiddenOffsets: function () {
                    if (reliableHiddenOffsetsVal == null) {
                        computeStyleTests();
                    }
                    return reliableHiddenOffsetsVal;
                },
                boxSizingReliable: function () {
                    if (boxSizingReliableVal == null) {
                        computeStyleTests();
                    }
                    return boxSizingReliableVal;
                },
                pixelPosition: function () {
                    if (pixelPositionVal == null) {
                        computeStyleTests();
                    }
                    return pixelPositionVal;
                },
                reliableMarginRight: function () {
                    if (reliableMarginRightVal == null) {
                        computeStyleTests();
                    }
                    return reliableMarginRightVal;
                }
            });
            function computeStyleTests() {
                var div, body, container, contents;
                body = document.getElementsByTagName('body')[0];
                if (!body || !body.style) {
                    return;
                }
                div = document.createElement('div');
                container = document.createElement('div');
                container.style.cssText = 'position:absolute;border:0;width:0;height:0;top:0;left:-9999px';
                body.appendChild(container).appendChild(div);
                div.style.cssText = '-webkit-box-sizing:border-box;-moz-box-sizing:border-box;' + 'box-sizing:border-box;display:block;margin-top:1%;top:1%;' + 'border:1px;padding:1px;width:4px;position:absolute';
                pixelPositionVal = boxSizingReliableVal = false;
                reliableMarginRightVal = true;
                if (window.getComputedStyle) {
                    pixelPositionVal = (window.getComputedStyle(div, null) || {}).top !== '1%';
                    boxSizingReliableVal = (window.getComputedStyle(div, null) || { width: '4px' }).width === '4px';
                    contents = div.appendChild(document.createElement('div'));
                    contents.style.cssText = div.style.cssText = '-webkit-box-sizing:content-box;-moz-box-sizing:content-box;' + 'box-sizing:content-box;display:block;margin:0;border:0;padding:0';
                    contents.style.marginRight = contents.style.width = '0';
                    div.style.width = '1px';
                    reliableMarginRightVal = !parseFloat((window.getComputedStyle(contents, null) || {}).marginRight);
                }
                div.innerHTML = '<table><tr><td></td><td>t</td></tr></table>';
                contents = div.getElementsByTagName('td');
                contents[0].style.cssText = 'margin:0;border:0;padding:0;display:none';
                reliableHiddenOffsetsVal = contents[0].offsetHeight === 0;
                if (reliableHiddenOffsetsVal) {
                    contents[0].style.display = '';
                    contents[1].style.display = 'none';
                    reliableHiddenOffsetsVal = contents[0].offsetHeight === 0;
                }
                body.removeChild(container);
            }
        }());
        jQuery.swap = function (elem, options, callback, args) {
            var ret, name, old = {};
            for (name in options) {
                old[name] = elem.style[name];
                elem.style[name] = options[name];
            }
            ret = callback.apply(elem, args || []);
            for (name in options) {
                elem.style[name] = old[name];
            }
            return ret;
        };
        var ralpha = /alpha\([^)]*\)/i, ropacity = /opacity\s*=\s*([^)]*)/, rdisplayswap = /^(none|table(?!-c[ea]).+)/, rnumsplit = new RegExp('^(' + pnum + ')(.*)$', 'i'), rrelNum = new RegExp('^([+-])=(' + pnum + ')', 'i'), cssShow = {
                position: 'absolute',
                visibility: 'hidden',
                display: 'block'
            }, cssNormalTransform = {
                letterSpacing: '0',
                fontWeight: '400'
            }, cssPrefixes = [
                'Webkit',
                'O',
                'Moz',
                'ms'
            ];
        function vendorPropName(style, name) {
            if (name in style) {
                return name;
            }
            var capName = name.charAt(0).toUpperCase() + name.slice(1), origName = name, i = cssPrefixes.length;
            while (i--) {
                name = cssPrefixes[i] + capName;
                if (name in style) {
                    return name;
                }
            }
            return origName;
        }
        function showHide(elements, show) {
            var display, elem, hidden, values = [], index = 0, length = elements.length;
            for (; index < length; index++) {
                elem = elements[index];
                if (!elem.style) {
                    continue;
                }
                values[index] = jQuery._data(elem, 'olddisplay');
                display = elem.style.display;
                if (show) {
                    if (!values[index] && display === 'none') {
                        elem.style.display = '';
                    }
                    if (elem.style.display === '' && isHidden(elem)) {
                        values[index] = jQuery._data(elem, 'olddisplay', defaultDisplay(elem.nodeName));
                    }
                } else {
                    hidden = isHidden(elem);
                    if (display && display !== 'none' || !hidden) {
                        jQuery._data(elem, 'olddisplay', hidden ? display : jQuery.css(elem, 'display'));
                    }
                }
            }
            for (index = 0; index < length; index++) {
                elem = elements[index];
                if (!elem.style) {
                    continue;
                }
                if (!show || elem.style.display === 'none' || elem.style.display === '') {
                    elem.style.display = show ? values[index] || '' : 'none';
                }
            }
            return elements;
        }
        function setPositiveNumber(elem, value, subtract) {
            var matches = rnumsplit.exec(value);
            return matches ? Math.max(0, matches[1] - (subtract || 0)) + (matches[2] || 'px') : value;
        }
        function augmentWidthOrHeight(elem, name, extra, isBorderBox, styles) {
            var i = extra === (isBorderBox ? 'border' : 'content') ? 4 : name === 'width' ? 1 : 0, val = 0;
            for (; i < 4; i += 2) {
                if (extra === 'margin') {
                    val += jQuery.css(elem, extra + cssExpand[i], true, styles);
                }
                if (isBorderBox) {
                    if (extra === 'content') {
                        val -= jQuery.css(elem, 'padding' + cssExpand[i], true, styles);
                    }
                    if (extra !== 'margin') {
                        val -= jQuery.css(elem, 'border' + cssExpand[i] + 'Width', true, styles);
                    }
                } else {
                    val += jQuery.css(elem, 'padding' + cssExpand[i], true, styles);
                    if (extra !== 'padding') {
                        val += jQuery.css(elem, 'border' + cssExpand[i] + 'Width', true, styles);
                    }
                }
            }
            return val;
        }
        function getWidthOrHeight(elem, name, extra) {
            var valueIsBorderBox = true, val = name === 'width' ? elem.offsetWidth : elem.offsetHeight, styles = getStyles(elem), isBorderBox = support.boxSizing && jQuery.css(elem, 'boxSizing', false, styles) === 'border-box';
            if (val <= 0 || val == null) {
                val = curCSS(elem, name, styles);
                if (val < 0 || val == null) {
                    val = elem.style[name];
                }
                if (rnumnonpx.test(val)) {
                    return val;
                }
                valueIsBorderBox = isBorderBox && (support.boxSizingReliable() || val === elem.style[name]);
                val = parseFloat(val) || 0;
            }
            return val + augmentWidthOrHeight(elem, name, extra || (isBorderBox ? 'border' : 'content'), valueIsBorderBox, styles) + 'px';
        }
        jQuery.extend({
            cssHooks: {
                opacity: {
                    get: function (elem, computed) {
                        if (computed) {
                            var ret = curCSS(elem, 'opacity');
                            return ret === '' ? '1' : ret;
                        }
                    }
                }
            },
            cssNumber: {
                'columnCount': true,
                'fillOpacity': true,
                'flexGrow': true,
                'flexShrink': true,
                'fontWeight': true,
                'lineHeight': true,
                'opacity': true,
                'order': true,
                'orphans': true,
                'widows': true,
                'zIndex': true,
                'zoom': true
            },
            cssProps: { 'float': support.cssFloat ? 'cssFloat' : 'styleFloat' },
            style: function (elem, name, value, extra) {
                if (!elem || elem.nodeType === 3 || elem.nodeType === 8 || !elem.style) {
                    return;
                }
                var ret, type, hooks, origName = jQuery.camelCase(name), style = elem.style;
                name = jQuery.cssProps[origName] || (jQuery.cssProps[origName] = vendorPropName(style, origName));
                hooks = jQuery.cssHooks[name] || jQuery.cssHooks[origName];
                if (value !== undefined) {
                    type = typeof value;
                    if (type === 'string' && (ret = rrelNum.exec(value))) {
                        value = (ret[1] + 1) * ret[2] + parseFloat(jQuery.css(elem, name));
                        type = 'number';
                    }
                    if (value == null || value !== value) {
                        return;
                    }
                    if (type === 'number' && !jQuery.cssNumber[origName]) {
                        value += 'px';
                    }
                    if (!support.clearCloneStyle && value === '' && name.indexOf('background') === 0) {
                        style[name] = 'inherit';
                    }
                    if (!hooks || !('set' in hooks) || (value = hooks.set(elem, value, extra)) !== undefined) {
                        try {
                            style[name] = value;
                        } catch (e) {
                        }
                    }
                } else {
                    if (hooks && 'get' in hooks && (ret = hooks.get(elem, false, extra)) !== undefined) {
                        return ret;
                    }
                    return style[name];
                }
            },
            css: function (elem, name, extra, styles) {
                var num, val, hooks, origName = jQuery.camelCase(name);
                name = jQuery.cssProps[origName] || (jQuery.cssProps[origName] = vendorPropName(elem.style, origName));
                hooks = jQuery.cssHooks[name] || jQuery.cssHooks[origName];
                if (hooks && 'get' in hooks) {
                    val = hooks.get(elem, true, extra);
                }
                if (val === undefined) {
                    val = curCSS(elem, name, styles);
                }
                if (val === 'normal' && name in cssNormalTransform) {
                    val = cssNormalTransform[name];
                }
                if (extra === '' || extra) {
                    num = parseFloat(val);
                    return extra === true || jQuery.isNumeric(num) ? num || 0 : val;
                }
                return val;
            }
        });
        jQuery.each([
            'height',
            'width'
        ], function (i, name) {
            jQuery.cssHooks[name] = {
                get: function (elem, computed, extra) {
                    if (computed) {
                        return rdisplayswap.test(jQuery.css(elem, 'display')) && elem.offsetWidth === 0 ? jQuery.swap(elem, cssShow, function () {
                            return getWidthOrHeight(elem, name, extra);
                        }) : getWidthOrHeight(elem, name, extra);
                    }
                },
                set: function (elem, value, extra) {
                    var styles = extra && getStyles(elem);
                    return setPositiveNumber(elem, value, extra ? augmentWidthOrHeight(elem, name, extra, support.boxSizing && jQuery.css(elem, 'boxSizing', false, styles) === 'border-box', styles) : 0);
                }
            };
        });
        if (!support.opacity) {
            jQuery.cssHooks.opacity = {
                get: function (elem, computed) {
                    return ropacity.test((computed && elem.currentStyle ? elem.currentStyle.filter : elem.style.filter) || '') ? 0.01 * parseFloat(RegExp.$1) + '' : computed ? '1' : '';
                },
                set: function (elem, value) {
                    var style = elem.style, currentStyle = elem.currentStyle, opacity = jQuery.isNumeric(value) ? 'alpha(opacity=' + value * 100 + ')' : '', filter = currentStyle && currentStyle.filter || style.filter || '';
                    style.zoom = 1;
                    if ((value >= 1 || value === '') && jQuery.trim(filter.replace(ralpha, '')) === '' && style.removeAttribute) {
                        style.removeAttribute('filter');
                        if (value === '' || currentStyle && !currentStyle.filter) {
                            return;
                        }
                    }
                    style.filter = ralpha.test(filter) ? filter.replace(ralpha, opacity) : filter + ' ' + opacity;
                }
            };
        }
        jQuery.cssHooks.marginRight = addGetHookIf(support.reliableMarginRight, function (elem, computed) {
            if (computed) {
                return jQuery.swap(elem, { 'display': 'inline-block' }, curCSS, [
                    elem,
                    'marginRight'
                ]);
            }
        });
        jQuery.each({
            margin: '',
            padding: '',
            border: 'Width'
        }, function (prefix, suffix) {
            jQuery.cssHooks[prefix + suffix] = {
                expand: function (value) {
                    var i = 0, expanded = {}, parts = typeof value === 'string' ? value.split(' ') : [value];
                    for (; i < 4; i++) {
                        expanded[prefix + cssExpand[i] + suffix] = parts[i] || parts[i - 2] || parts[0];
                    }
                    return expanded;
                }
            };
            if (!rmargin.test(prefix)) {
                jQuery.cssHooks[prefix + suffix].set = setPositiveNumber;
            }
        });
        jQuery.fn.extend({
            css: function (name, value) {
                return access(this, function (elem, name, value) {
                    var styles, len, map = {}, i = 0;
                    if (jQuery.isArray(name)) {
                        styles = getStyles(elem);
                        len = name.length;
                        for (; i < len; i++) {
                            map[name[i]] = jQuery.css(elem, name[i], false, styles);
                        }
                        return map;
                    }
                    return value !== undefined ? jQuery.style(elem, name, value) : jQuery.css(elem, name);
                }, name, value, arguments.length > 1);
            },
            show: function () {
                return showHide(this, true);
            },
            hide: function () {
                return showHide(this);
            },
            toggle: function (state) {
                if (typeof state === 'boolean') {
                    return state ? this.show() : this.hide();
                }
                return this.each(function () {
                    if (isHidden(this)) {
                        jQuery(this).show();
                    } else {
                        jQuery(this).hide();
                    }
                });
            }
        });
        function Tween(elem, options, prop, end, easing) {
            return new Tween.prototype.init(elem, options, prop, end, easing);
        }
        jQuery.Tween = Tween;
        Tween.prototype = {
            constructor: Tween,
            init: function (elem, options, prop, end, easing, unit) {
                this.elem = elem;
                this.prop = prop;
                this.easing = easing || 'swing';
                this.options = options;
                this.start = this.now = this.cur();
                this.end = end;
                this.unit = unit || (jQuery.cssNumber[prop] ? '' : 'px');
            },
            cur: function () {
                var hooks = Tween.propHooks[this.prop];
                return hooks && hooks.get ? hooks.get(this) : Tween.propHooks._default.get(this);
            },
            run: function (percent) {
                var eased, hooks = Tween.propHooks[this.prop];
                if (this.options.duration) {
                    this.pos = eased = jQuery.easing[this.easing](percent, this.options.duration * percent, 0, 1, this.options.duration);
                } else {
                    this.pos = eased = percent;
                }
                this.now = (this.end - this.start) * eased + this.start;
                if (this.options.step) {
                    this.options.step.call(this.elem, this.now, this);
                }
                if (hooks && hooks.set) {
                    hooks.set(this);
                } else {
                    Tween.propHooks._default.set(this);
                }
                return this;
            }
        };
        Tween.prototype.init.prototype = Tween.prototype;
        Tween.propHooks = {
            _default: {
                get: function (tween) {
                    var result;
                    if (tween.elem[tween.prop] != null && (!tween.elem.style || tween.elem.style[tween.prop] == null)) {
                        return tween.elem[tween.prop];
                    }
                    result = jQuery.css(tween.elem, tween.prop, '');
                    return !result || result === 'auto' ? 0 : result;
                },
                set: function (tween) {
                    if (jQuery.fx.step[tween.prop]) {
                        jQuery.fx.step[tween.prop](tween);
                    } else if (tween.elem.style && (tween.elem.style[jQuery.cssProps[tween.prop]] != null || jQuery.cssHooks[tween.prop])) {
                        jQuery.style(tween.elem, tween.prop, tween.now + tween.unit);
                    } else {
                        tween.elem[tween.prop] = tween.now;
                    }
                }
            }
        };
        Tween.propHooks.scrollTop = Tween.propHooks.scrollLeft = {
            set: function (tween) {
                if (tween.elem.nodeType && tween.elem.parentNode) {
                    tween.elem[tween.prop] = tween.now;
                }
            }
        };
        jQuery.easing = {
            linear: function (p) {
                return p;
            },
            swing: function (p) {
                return 0.5 - Math.cos(p * Math.PI) / 2;
            }
        };
        jQuery.fx = Tween.prototype.init;
        jQuery.fx.step = {};
        var fxNow, timerId, rfxtypes = /^(?:toggle|show|hide)$/, rfxnum = new RegExp('^(?:([+-])=|)(' + pnum + ')([a-z%]*)$', 'i'), rrun = /queueHooks$/, animationPrefilters = [defaultPrefilter], tweeners = {
                '*': [function (prop, value) {
                        var tween = this.createTween(prop, value), target = tween.cur(), parts = rfxnum.exec(value), unit = parts && parts[3] || (jQuery.cssNumber[prop] ? '' : 'px'), start = (jQuery.cssNumber[prop] || unit !== 'px' && +target) && rfxnum.exec(jQuery.css(tween.elem, prop)), scale = 1, maxIterations = 20;
                        if (start && start[3] !== unit) {
                            unit = unit || start[3];
                            parts = parts || [];
                            start = +target || 1;
                            do {
                                scale = scale || '.5';
                                start = start / scale;
                                jQuery.style(tween.elem, prop, start + unit);
                            } while (scale !== (scale = tween.cur() / target) && scale !== 1 && --maxIterations);
                        }
                        if (parts) {
                            start = tween.start = +start || +target || 0;
                            tween.unit = unit;
                            tween.end = parts[1] ? start + (parts[1] + 1) * parts[2] : +parts[2];
                        }
                        return tween;
                    }]
            };
        function createFxNow() {
            setTimeout(function () {
                fxNow = undefined;
            });
            return fxNow = jQuery.now();
        }
        function genFx(type, includeWidth) {
            var which, attrs = { height: type }, i = 0;
            includeWidth = includeWidth ? 1 : 0;
            for (; i < 4; i += 2 - includeWidth) {
                which = cssExpand[i];
                attrs['margin' + which] = attrs['padding' + which] = type;
            }
            if (includeWidth) {
                attrs.opacity = attrs.width = type;
            }
            return attrs;
        }
        function createTween(value, prop, animation) {
            var tween, collection = (tweeners[prop] || []).concat(tweeners['*']), index = 0, length = collection.length;
            for (; index < length; index++) {
                if (tween = collection[index].call(animation, prop, value)) {
                    return tween;
                }
            }
        }
        function defaultPrefilter(elem, props, opts) {
            var prop, value, toggle, tween, hooks, oldfire, display, checkDisplay, anim = this, orig = {}, style = elem.style, hidden = elem.nodeType && isHidden(elem), dataShow = jQuery._data(elem, 'fxshow');
            if (!opts.queue) {
                hooks = jQuery._queueHooks(elem, 'fx');
                if (hooks.unqueued == null) {
                    hooks.unqueued = 0;
                    oldfire = hooks.empty.fire;
                    hooks.empty.fire = function () {
                        if (!hooks.unqueued) {
                            oldfire();
                        }
                    };
                }
                hooks.unqueued++;
                anim.always(function () {
                    anim.always(function () {
                        hooks.unqueued--;
                        if (!jQuery.queue(elem, 'fx').length) {
                            hooks.empty.fire();
                        }
                    });
                });
            }
            if (elem.nodeType === 1 && ('height' in props || 'width' in props)) {
                opts.overflow = [
                    style.overflow,
                    style.overflowX,
                    style.overflowY
                ];
                display = jQuery.css(elem, 'display');
                checkDisplay = display === 'none' ? jQuery._data(elem, 'olddisplay') || defaultDisplay(elem.nodeName) : display;
                if (checkDisplay === 'inline' && jQuery.css(elem, 'float') === 'none') {
                    if (!support.inlineBlockNeedsLayout || defaultDisplay(elem.nodeName) === 'inline') {
                        style.display = 'inline-block';
                    } else {
                        style.zoom = 1;
                    }
                }
            }
            if (opts.overflow) {
                style.overflow = 'hidden';
                if (!support.shrinkWrapBlocks()) {
                    anim.always(function () {
                        style.overflow = opts.overflow[0];
                        style.overflowX = opts.overflow[1];
                        style.overflowY = opts.overflow[2];
                    });
                }
            }
            for (prop in props) {
                value = props[prop];
                if (rfxtypes.exec(value)) {
                    delete props[prop];
                    toggle = toggle || value === 'toggle';
                    if (value === (hidden ? 'hide' : 'show')) {
                        if (value === 'show' && dataShow && dataShow[prop] !== undefined) {
                            hidden = true;
                        } else {
                            continue;
                        }
                    }
                    orig[prop] = dataShow && dataShow[prop] || jQuery.style(elem, prop);
                } else {
                    display = undefined;
                }
            }
            if (!jQuery.isEmptyObject(orig)) {
                if (dataShow) {
                    if ('hidden' in dataShow) {
                        hidden = dataShow.hidden;
                    }
                } else {
                    dataShow = jQuery._data(elem, 'fxshow', {});
                }
                if (toggle) {
                    dataShow.hidden = !hidden;
                }
                if (hidden) {
                    jQuery(elem).show();
                } else {
                    anim.done(function () {
                        jQuery(elem).hide();
                    });
                }
                anim.done(function () {
                    var prop;
                    jQuery._removeData(elem, 'fxshow');
                    for (prop in orig) {
                        jQuery.style(elem, prop, orig[prop]);
                    }
                });
                for (prop in orig) {
                    tween = createTween(hidden ? dataShow[prop] : 0, prop, anim);
                    if (!(prop in dataShow)) {
                        dataShow[prop] = tween.start;
                        if (hidden) {
                            tween.end = tween.start;
                            tween.start = prop === 'width' || prop === 'height' ? 1 : 0;
                        }
                    }
                }
            } else if ((display === 'none' ? defaultDisplay(elem.nodeName) : display) === 'inline') {
                style.display = display;
            }
        }
        function propFilter(props, specialEasing) {
            var index, name, easing, value, hooks;
            for (index in props) {
                name = jQuery.camelCase(index);
                easing = specialEasing[name];
                value = props[index];
                if (jQuery.isArray(value)) {
                    easing = value[1];
                    value = props[index] = value[0];
                }
                if (index !== name) {
                    props[name] = value;
                    delete props[index];
                }
                hooks = jQuery.cssHooks[name];
                if (hooks && 'expand' in hooks) {
                    value = hooks.expand(value);
                    delete props[name];
                    for (index in value) {
                        if (!(index in props)) {
                            props[index] = value[index];
                            specialEasing[index] = easing;
                        }
                    }
                } else {
                    specialEasing[name] = easing;
                }
            }
        }
        function Animation(elem, properties, options) {
            var result, stopped, index = 0, length = animationPrefilters.length, deferred = jQuery.Deferred().always(function () {
                    delete tick.elem;
                }), tick = function () {
                    if (stopped) {
                        return false;
                    }
                    var currentTime = fxNow || createFxNow(), remaining = Math.max(0, animation.startTime + animation.duration - currentTime), temp = remaining / animation.duration || 0, percent = 1 - temp, index = 0, length = animation.tweens.length;
                    for (; index < length; index++) {
                        animation.tweens[index].run(percent);
                    }
                    deferred.notifyWith(elem, [
                        animation,
                        percent,
                        remaining
                    ]);
                    if (percent < 1 && length) {
                        return remaining;
                    } else {
                        deferred.resolveWith(elem, [animation]);
                        return false;
                    }
                }, animation = deferred.promise({
                    elem: elem,
                    props: jQuery.extend({}, properties),
                    opts: jQuery.extend(true, { specialEasing: {} }, options),
                    originalProperties: properties,
                    originalOptions: options,
                    startTime: fxNow || createFxNow(),
                    duration: options.duration,
                    tweens: [],
                    createTween: function (prop, end) {
                        var tween = jQuery.Tween(elem, animation.opts, prop, end, animation.opts.specialEasing[prop] || animation.opts.easing);
                        animation.tweens.push(tween);
                        return tween;
                    },
                    stop: function (gotoEnd) {
                        var index = 0, length = gotoEnd ? animation.tweens.length : 0;
                        if (stopped) {
                            return this;
                        }
                        stopped = true;
                        for (; index < length; index++) {
                            animation.tweens[index].run(1);
                        }
                        if (gotoEnd) {
                            deferred.resolveWith(elem, [
                                animation,
                                gotoEnd
                            ]);
                        } else {
                            deferred.rejectWith(elem, [
                                animation,
                                gotoEnd
                            ]);
                        }
                        return this;
                    }
                }), props = animation.props;
            propFilter(props, animation.opts.specialEasing);
            for (; index < length; index++) {
                result = animationPrefilters[index].call(animation, elem, props, animation.opts);
                if (result) {
                    return result;
                }
            }
            jQuery.map(props, createTween, animation);
            if (jQuery.isFunction(animation.opts.start)) {
                animation.opts.start.call(elem, animation);
            }
            jQuery.fx.timer(jQuery.extend(tick, {
                elem: elem,
                anim: animation,
                queue: animation.opts.queue
            }));
            return animation.progress(animation.opts.progress).done(animation.opts.done, animation.opts.complete).fail(animation.opts.fail).always(animation.opts.always);
        }
        jQuery.Animation = jQuery.extend(Animation, {
            tweener: function (props, callback) {
                if (jQuery.isFunction(props)) {
                    callback = props;
                    props = ['*'];
                } else {
                    props = props.split(' ');
                }
                var prop, index = 0, length = props.length;
                for (; index < length; index++) {
                    prop = props[index];
                    tweeners[prop] = tweeners[prop] || [];
                    tweeners[prop].unshift(callback);
                }
            },
            prefilter: function (callback, prepend) {
                if (prepend) {
                    animationPrefilters.unshift(callback);
                } else {
                    animationPrefilters.push(callback);
                }
            }
        });
        jQuery.speed = function (speed, easing, fn) {
            var opt = speed && typeof speed === 'object' ? jQuery.extend({}, speed) : {
                complete: fn || !fn && easing || jQuery.isFunction(speed) && speed,
                duration: speed,
                easing: fn && easing || easing && !jQuery.isFunction(easing) && easing
            };
            opt.duration = jQuery.fx.off ? 0 : typeof opt.duration === 'number' ? opt.duration : opt.duration in jQuery.fx.speeds ? jQuery.fx.speeds[opt.duration] : jQuery.fx.speeds._default;
            if (opt.queue == null || opt.queue === true) {
                opt.queue = 'fx';
            }
            opt.old = opt.complete;
            opt.complete = function () {
                if (jQuery.isFunction(opt.old)) {
                    opt.old.call(this);
                }
                if (opt.queue) {
                    jQuery.dequeue(this, opt.queue);
                }
            };
            return opt;
        };
        jQuery.fn.extend({
            fadeTo: function (speed, to, easing, callback) {
                return this.filter(isHidden).css('opacity', 0).show().end().animate({ opacity: to }, speed, easing, callback);
            },
            animate: function (prop, speed, easing, callback) {
                var empty = jQuery.isEmptyObject(prop), optall = jQuery.speed(speed, easing, callback), doAnimation = function () {
                        var anim = Animation(this, jQuery.extend({}, prop), optall);
                        if (empty || jQuery._data(this, 'finish')) {
                            anim.stop(true);
                        }
                    };
                doAnimation.finish = doAnimation;
                return empty || optall.queue === false ? this.each(doAnimation) : this.queue(optall.queue, doAnimation);
            },
            stop: function (type, clearQueue, gotoEnd) {
                var stopQueue = function (hooks) {
                    var stop = hooks.stop;
                    delete hooks.stop;
                    stop(gotoEnd);
                };
                if (typeof type !== 'string') {
                    gotoEnd = clearQueue;
                    clearQueue = type;
                    type = undefined;
                }
                if (clearQueue && type !== false) {
                    this.queue(type || 'fx', []);
                }
                return this.each(function () {
                    var dequeue = true, index = type != null && type + 'queueHooks', timers = jQuery.timers, data = jQuery._data(this);
                    if (index) {
                        if (data[index] && data[index].stop) {
                            stopQueue(data[index]);
                        }
                    } else {
                        for (index in data) {
                            if (data[index] && data[index].stop && rrun.test(index)) {
                                stopQueue(data[index]);
                            }
                        }
                    }
                    for (index = timers.length; index--;) {
                        if (timers[index].elem === this && (type == null || timers[index].queue === type)) {
                            timers[index].anim.stop(gotoEnd);
                            dequeue = false;
                            timers.splice(index, 1);
                        }
                    }
                    if (dequeue || !gotoEnd) {
                        jQuery.dequeue(this, type);
                    }
                });
            },
            finish: function (type) {
                if (type !== false) {
                    type = type || 'fx';
                }
                return this.each(function () {
                    var index, data = jQuery._data(this), queue = data[type + 'queue'], hooks = data[type + 'queueHooks'], timers = jQuery.timers, length = queue ? queue.length : 0;
                    data.finish = true;
                    jQuery.queue(this, type, []);
                    if (hooks && hooks.stop) {
                        hooks.stop.call(this, true);
                    }
                    for (index = timers.length; index--;) {
                        if (timers[index].elem === this && timers[index].queue === type) {
                            timers[index].anim.stop(true);
                            timers.splice(index, 1);
                        }
                    }
                    for (index = 0; index < length; index++) {
                        if (queue[index] && queue[index].finish) {
                            queue[index].finish.call(this);
                        }
                    }
                    delete data.finish;
                });
            }
        });
        jQuery.each([
            'toggle',
            'show',
            'hide'
        ], function (i, name) {
            var cssFn = jQuery.fn[name];
            jQuery.fn[name] = function (speed, easing, callback) {
                return speed == null || typeof speed === 'boolean' ? cssFn.apply(this, arguments) : this.animate(genFx(name, true), speed, easing, callback);
            };
        });
        jQuery.each({
            slideDown: genFx('show'),
            slideUp: genFx('hide'),
            slideToggle: genFx('toggle'),
            fadeIn: { opacity: 'show' },
            fadeOut: { opacity: 'hide' },
            fadeToggle: { opacity: 'toggle' }
        }, function (name, props) {
            jQuery.fn[name] = function (speed, easing, callback) {
                return this.animate(props, speed, easing, callback);
            };
        });
        jQuery.timers = [];
        jQuery.fx.tick = function () {
            var timer, timers = jQuery.timers, i = 0;
            fxNow = jQuery.now();
            for (; i < timers.length; i++) {
                timer = timers[i];
                if (!timer() && timers[i] === timer) {
                    timers.splice(i--, 1);
                }
            }
            if (!timers.length) {
                jQuery.fx.stop();
            }
            fxNow = undefined;
        };
        jQuery.fx.timer = function (timer) {
            jQuery.timers.push(timer);
            if (timer()) {
                jQuery.fx.start();
            } else {
                jQuery.timers.pop();
            }
        };
        jQuery.fx.interval = 13;
        jQuery.fx.start = function () {
            if (!timerId) {
                timerId = setInterval(jQuery.fx.tick, jQuery.fx.interval);
            }
        };
        jQuery.fx.stop = function () {
            clearInterval(timerId);
            timerId = null;
        };
        jQuery.fx.speeds = {
            slow: 600,
            fast: 200,
            _default: 400
        };
        jQuery.fn.delay = function (time, type) {
            time = jQuery.fx ? jQuery.fx.speeds[time] || time : time;
            type = type || 'fx';
            return this.queue(type, function (next, hooks) {
                var timeout = setTimeout(next, time);
                hooks.stop = function () {
                    clearTimeout(timeout);
                };
            });
        };
        (function () {
            var input, div, select, a, opt;
            div = document.createElement('div');
            div.setAttribute('className', 't');
            div.innerHTML = '  <link/><table></table><a href=\'/a\'>a</a><input type=\'checkbox\'/>';
            a = div.getElementsByTagName('a')[0];
            select = document.createElement('select');
            opt = select.appendChild(document.createElement('option'));
            input = div.getElementsByTagName('input')[0];
            a.style.cssText = 'top:1px';
            support.getSetAttribute = div.className !== 't';
            support.style = /top/.test(a.getAttribute('style'));
            support.hrefNormalized = a.getAttribute('href') === '/a';
            support.checkOn = !!input.value;
            support.optSelected = opt.selected;
            support.enctype = !!document.createElement('form').enctype;
            select.disabled = true;
            support.optDisabled = !opt.disabled;
            input = document.createElement('input');
            input.setAttribute('value', '');
            support.input = input.getAttribute('value') === '';
            input.value = 't';
            input.setAttribute('type', 'radio');
            support.radioValue = input.value === 't';
        }());
        var rreturn = /\r/g;
        jQuery.fn.extend({
            val: function (value) {
                var hooks, ret, isFunction, elem = this[0];
                if (!arguments.length) {
                    if (elem) {
                        hooks = jQuery.valHooks[elem.type] || jQuery.valHooks[elem.nodeName.toLowerCase()];
                        if (hooks && 'get' in hooks && (ret = hooks.get(elem, 'value')) !== undefined) {
                            return ret;
                        }
                        ret = elem.value;
                        return typeof ret === 'string' ? ret.replace(rreturn, '') : ret == null ? '' : ret;
                    }
                    return;
                }
                isFunction = jQuery.isFunction(value);
                return this.each(function (i) {
                    var val;
                    if (this.nodeType !== 1) {
                        return;
                    }
                    if (isFunction) {
                        val = value.call(this, i, jQuery(this).val());
                    } else {
                        val = value;
                    }
                    if (val == null) {
                        val = '';
                    } else if (typeof val === 'number') {
                        val += '';
                    } else if (jQuery.isArray(val)) {
                        val = jQuery.map(val, function (value) {
                            return value == null ? '' : value + '';
                        });
                    }
                    hooks = jQuery.valHooks[this.type] || jQuery.valHooks[this.nodeName.toLowerCase()];
                    if (!hooks || !('set' in hooks) || hooks.set(this, val, 'value') === undefined) {
                        this.value = val;
                    }
                });
            }
        });
        jQuery.extend({
            valHooks: {
                option: {
                    get: function (elem) {
                        var val = jQuery.find.attr(elem, 'value');
                        return val != null ? val : jQuery.trim(jQuery.text(elem));
                    }
                },
                select: {
                    get: function (elem) {
                        var value, option, options = elem.options, index = elem.selectedIndex, one = elem.type === 'select-one' || index < 0, values = one ? null : [], max = one ? index + 1 : options.length, i = index < 0 ? max : one ? index : 0;
                        for (; i < max; i++) {
                            option = options[i];
                            if ((option.selected || i === index) && (support.optDisabled ? !option.disabled : option.getAttribute('disabled') === null) && (!option.parentNode.disabled || !jQuery.nodeName(option.parentNode, 'optgroup'))) {
                                value = jQuery(option).val();
                                if (one) {
                                    return value;
                                }
                                values.push(value);
                            }
                        }
                        return values;
                    },
                    set: function (elem, value) {
                        var optionSet, option, options = elem.options, values = jQuery.makeArray(value), i = options.length;
                        while (i--) {
                            option = options[i];
                            if (jQuery.inArray(jQuery.valHooks.option.get(option), values) >= 0) {
                                try {
                                    option.selected = optionSet = true;
                                } catch (_) {
                                    option.scrollHeight;
                                }
                            } else {
                                option.selected = false;
                            }
                        }
                        if (!optionSet) {
                            elem.selectedIndex = -1;
                        }
                        return options;
                    }
                }
            }
        });
        jQuery.each([
            'radio',
            'checkbox'
        ], function () {
            jQuery.valHooks[this] = {
                set: function (elem, value) {
                    if (jQuery.isArray(value)) {
                        return elem.checked = jQuery.inArray(jQuery(elem).val(), value) >= 0;
                    }
                }
            };
            if (!support.checkOn) {
                jQuery.valHooks[this].get = function (elem) {
                    return elem.getAttribute('value') === null ? 'on' : elem.value;
                };
            }
        });
        var nodeHook, boolHook, attrHandle = jQuery.expr.attrHandle, ruseDefault = /^(?:checked|selected)$/i, getSetAttribute = support.getSetAttribute, getSetInput = support.input;
        jQuery.fn.extend({
            attr: function (name, value) {
                return access(this, jQuery.attr, name, value, arguments.length > 1);
            },
            removeAttr: function (name) {
                return this.each(function () {
                    jQuery.removeAttr(this, name);
                });
            }
        });
        jQuery.extend({
            attr: function (elem, name, value) {
                var hooks, ret, nType = elem.nodeType;
                if (!elem || nType === 3 || nType === 8 || nType === 2) {
                    return;
                }
                if (typeof elem.getAttribute === strundefined) {
                    return jQuery.prop(elem, name, value);
                }
                if (nType !== 1 || !jQuery.isXMLDoc(elem)) {
                    name = name.toLowerCase();
                    hooks = jQuery.attrHooks[name] || (jQuery.expr.match.bool.test(name) ? boolHook : nodeHook);
                }
                if (value !== undefined) {
                    if (value === null) {
                        jQuery.removeAttr(elem, name);
                    } else if (hooks && 'set' in hooks && (ret = hooks.set(elem, value, name)) !== undefined) {
                        return ret;
                    } else {
                        elem.setAttribute(name, value + '');
                        return value;
                    }
                } else if (hooks && 'get' in hooks && (ret = hooks.get(elem, name)) !== null) {
                    return ret;
                } else {
                    ret = jQuery.find.attr(elem, name);
                    return ret == null ? undefined : ret;
                }
            },
            removeAttr: function (elem, value) {
                var name, propName, i = 0, attrNames = value && value.match(rnotwhite);
                if (attrNames && elem.nodeType === 1) {
                    while (name = attrNames[i++]) {
                        propName = jQuery.propFix[name] || name;
                        if (jQuery.expr.match.bool.test(name)) {
                            if (getSetInput && getSetAttribute || !ruseDefault.test(name)) {
                                elem[propName] = false;
                            } else {
                                elem[jQuery.camelCase('default-' + name)] = elem[propName] = false;
                            }
                        } else {
                            jQuery.attr(elem, name, '');
                        }
                        elem.removeAttribute(getSetAttribute ? name : propName);
                    }
                }
            },
            attrHooks: {
                type: {
                    set: function (elem, value) {
                        if (!support.radioValue && value === 'radio' && jQuery.nodeName(elem, 'input')) {
                            var val = elem.value;
                            elem.setAttribute('type', value);
                            if (val) {
                                elem.value = val;
                            }
                            return value;
                        }
                    }
                }
            }
        });
        boolHook = {
            set: function (elem, value, name) {
                if (value === false) {
                    jQuery.removeAttr(elem, name);
                } else if (getSetInput && getSetAttribute || !ruseDefault.test(name)) {
                    elem.setAttribute(!getSetAttribute && jQuery.propFix[name] || name, name);
                } else {
                    elem[jQuery.camelCase('default-' + name)] = elem[name] = true;
                }
                return name;
            }
        };
        jQuery.each(jQuery.expr.match.bool.source.match(/\w+/g), function (i, name) {
            var getter = attrHandle[name] || jQuery.find.attr;
            attrHandle[name] = getSetInput && getSetAttribute || !ruseDefault.test(name) ? function (elem, name, isXML) {
                var ret, handle;
                if (!isXML) {
                    handle = attrHandle[name];
                    attrHandle[name] = ret;
                    ret = getter(elem, name, isXML) != null ? name.toLowerCase() : null;
                    attrHandle[name] = handle;
                }
                return ret;
            } : function (elem, name, isXML) {
                if (!isXML) {
                    return elem[jQuery.camelCase('default-' + name)] ? name.toLowerCase() : null;
                }
            };
        });
        if (!getSetInput || !getSetAttribute) {
            jQuery.attrHooks.value = {
                set: function (elem, value, name) {
                    if (jQuery.nodeName(elem, 'input')) {
                        elem.defaultValue = value;
                    } else {
                        return nodeHook && nodeHook.set(elem, value, name);
                    }
                }
            };
        }
        if (!getSetAttribute) {
            nodeHook = {
                set: function (elem, value, name) {
                    var ret = elem.getAttributeNode(name);
                    if (!ret) {
                        elem.setAttributeNode(ret = elem.ownerDocument.createAttribute(name));
                    }
                    ret.value = value += '';
                    if (name === 'value' || value === elem.getAttribute(name)) {
                        return value;
                    }
                }
            };
            attrHandle.id = attrHandle.name = attrHandle.coords = function (elem, name, isXML) {
                var ret;
                if (!isXML) {
                    return (ret = elem.getAttributeNode(name)) && ret.value !== '' ? ret.value : null;
                }
            };
            jQuery.valHooks.button = {
                get: function (elem, name) {
                    var ret = elem.getAttributeNode(name);
                    if (ret && ret.specified) {
                        return ret.value;
                    }
                },
                set: nodeHook.set
            };
            jQuery.attrHooks.contenteditable = {
                set: function (elem, value, name) {
                    nodeHook.set(elem, value === '' ? false : value, name);
                }
            };
            jQuery.each([
                'width',
                'height'
            ], function (i, name) {
                jQuery.attrHooks[name] = {
                    set: function (elem, value) {
                        if (value === '') {
                            elem.setAttribute(name, 'auto');
                            return value;
                        }
                    }
                };
            });
        }
        if (!support.style) {
            jQuery.attrHooks.style = {
                get: function (elem) {
                    return elem.style.cssText || undefined;
                },
                set: function (elem, value) {
                    return elem.style.cssText = value + '';
                }
            };
        }
        var rfocusable = /^(?:input|select|textarea|button|object)$/i, rclickable = /^(?:a|area)$/i;
        jQuery.fn.extend({
            prop: function (name, value) {
                return access(this, jQuery.prop, name, value, arguments.length > 1);
            },
            removeProp: function (name) {
                name = jQuery.propFix[name] || name;
                return this.each(function () {
                    try {
                        this[name] = undefined;
                        delete this[name];
                    } catch (e) {
                    }
                });
            }
        });
        jQuery.extend({
            propFix: {
                'for': 'htmlFor',
                'class': 'className'
            },
            prop: function (elem, name, value) {
                var ret, hooks, notxml, nType = elem.nodeType;
                if (!elem || nType === 3 || nType === 8 || nType === 2) {
                    return;
                }
                notxml = nType !== 1 || !jQuery.isXMLDoc(elem);
                if (notxml) {
                    name = jQuery.propFix[name] || name;
                    hooks = jQuery.propHooks[name];
                }
                if (value !== undefined) {
                    return hooks && 'set' in hooks && (ret = hooks.set(elem, value, name)) !== undefined ? ret : elem[name] = value;
                } else {
                    return hooks && 'get' in hooks && (ret = hooks.get(elem, name)) !== null ? ret : elem[name];
                }
            },
            propHooks: {
                tabIndex: {
                    get: function (elem) {
                        var tabindex = jQuery.find.attr(elem, 'tabindex');
                        return tabindex ? parseInt(tabindex, 10) : rfocusable.test(elem.nodeName) || rclickable.test(elem.nodeName) && elem.href ? 0 : -1;
                    }
                }
            }
        });
        if (!support.hrefNormalized) {
            jQuery.each([
                'href',
                'src'
            ], function (i, name) {
                jQuery.propHooks[name] = {
                    get: function (elem) {
                        return elem.getAttribute(name, 4);
                    }
                };
            });
        }
        if (!support.optSelected) {
            jQuery.propHooks.selected = {
                get: function (elem) {
                    var parent = elem.parentNode;
                    if (parent) {
                        parent.selectedIndex;
                        if (parent.parentNode) {
                            parent.parentNode.selectedIndex;
                        }
                    }
                    return null;
                }
            };
        }
        jQuery.each([
            'tabIndex',
            'readOnly',
            'maxLength',
            'cellSpacing',
            'cellPadding',
            'rowSpan',
            'colSpan',
            'useMap',
            'frameBorder',
            'contentEditable'
        ], function () {
            jQuery.propFix[this.toLowerCase()] = this;
        });
        if (!support.enctype) {
            jQuery.propFix.enctype = 'encoding';
        }
        var rclass = /[\t\r\n\f]/g;
        jQuery.fn.extend({
            addClass: function (value) {
                var classes, elem, cur, clazz, j, finalValue, i = 0, len = this.length, proceed = typeof value === 'string' && value;
                if (jQuery.isFunction(value)) {
                    return this.each(function (j) {
                        jQuery(this).addClass(value.call(this, j, this.className));
                    });
                }
                if (proceed) {
                    classes = (value || '').match(rnotwhite) || [];
                    for (; i < len; i++) {
                        elem = this[i];
                        cur = elem.nodeType === 1 && (elem.className ? (' ' + elem.className + ' ').replace(rclass, ' ') : ' ');
                        if (cur) {
                            j = 0;
                            while (clazz = classes[j++]) {
                                if (cur.indexOf(' ' + clazz + ' ') < 0) {
                                    cur += clazz + ' ';
                                }
                            }
                            finalValue = jQuery.trim(cur);
                            if (elem.className !== finalValue) {
                                elem.className = finalValue;
                            }
                        }
                    }
                }
                return this;
            },
            removeClass: function (value) {
                var classes, elem, cur, clazz, j, finalValue, i = 0, len = this.length, proceed = arguments.length === 0 || typeof value === 'string' && value;
                if (jQuery.isFunction(value)) {
                    return this.each(function (j) {
                        jQuery(this).removeClass(value.call(this, j, this.className));
                    });
                }
                if (proceed) {
                    classes = (value || '').match(rnotwhite) || [];
                    for (; i < len; i++) {
                        elem = this[i];
                        cur = elem.nodeType === 1 && (elem.className ? (' ' + elem.className + ' ').replace(rclass, ' ') : '');
                        if (cur) {
                            j = 0;
                            while (clazz = classes[j++]) {
                                while (cur.indexOf(' ' + clazz + ' ') >= 0) {
                                    cur = cur.replace(' ' + clazz + ' ', ' ');
                                }
                            }
                            finalValue = value ? jQuery.trim(cur) : '';
                            if (elem.className !== finalValue) {
                                elem.className = finalValue;
                            }
                        }
                    }
                }
                return this;
            },
            toggleClass: function (value, stateVal) {
                var type = typeof value;
                if (typeof stateVal === 'boolean' && type === 'string') {
                    return stateVal ? this.addClass(value) : this.removeClass(value);
                }
                if (jQuery.isFunction(value)) {
                    return this.each(function (i) {
                        jQuery(this).toggleClass(value.call(this, i, this.className, stateVal), stateVal);
                    });
                }
                return this.each(function () {
                    if (type === 'string') {
                        var className, i = 0, self = jQuery(this), classNames = value.match(rnotwhite) || [];
                        while (className = classNames[i++]) {
                            if (self.hasClass(className)) {
                                self.removeClass(className);
                            } else {
                                self.addClass(className);
                            }
                        }
                    } else if (type === strundefined || type === 'boolean') {
                        if (this.className) {
                            jQuery._data(this, '__className__', this.className);
                        }
                        this.className = this.className || value === false ? '' : jQuery._data(this, '__className__') || '';
                    }
                });
            },
            hasClass: function (selector) {
                var className = ' ' + selector + ' ', i = 0, l = this.length;
                for (; i < l; i++) {
                    if (this[i].nodeType === 1 && (' ' + this[i].className + ' ').replace(rclass, ' ').indexOf(className) >= 0) {
                        return true;
                    }
                }
                return false;
            }
        });
        jQuery.each(('blur focus focusin focusout load resize scroll unload click dblclick ' + 'mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave ' + 'change select submit keydown keypress keyup error contextmenu').split(' '), function (i, name) {
            jQuery.fn[name] = function (data, fn) {
                return arguments.length > 0 ? this.on(name, null, data, fn) : this.trigger(name);
            };
        });
        jQuery.fn.extend({
            hover: function (fnOver, fnOut) {
                return this.mouseenter(fnOver).mouseleave(fnOut || fnOver);
            },
            bind: function (types, data, fn) {
                return this.on(types, null, data, fn);
            },
            unbind: function (types, fn) {
                return this.off(types, null, fn);
            },
            delegate: function (selector, types, data, fn) {
                return this.on(types, selector, data, fn);
            },
            undelegate: function (selector, types, fn) {
                return arguments.length === 1 ? this.off(selector, '**') : this.off(types, selector || '**', fn);
            }
        });
        var nonce = jQuery.now();
        var rquery = /\?/;
        var rvalidtokens = /(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;
        jQuery.parseJSON = function (data) {
            if (window.JSON && window.JSON.parse) {
                return window.JSON.parse(data + '');
            }
            var requireNonComma, depth = null, str = jQuery.trim(data + '');
            return str && !jQuery.trim(str.replace(rvalidtokens, function (token, comma, open, close) {
                if (requireNonComma && comma) {
                    depth = 0;
                }
                if (depth === 0) {
                    return token;
                }
                requireNonComma = open || comma;
                depth += !close - !open;
                return '';
            })) ? Function('return ' + str)() : jQuery.error('Invalid JSON: ' + data);
        };
        jQuery.parseXML = function (data) {
            var xml, tmp;
            if (!data || typeof data !== 'string') {
                return null;
            }
            try {
                if (window.DOMParser) {
                    tmp = new DOMParser();
                    xml = tmp.parseFromString(data, 'text/xml');
                } else {
                    xml = new ActiveXObject('Microsoft.XMLDOM');
                    xml.async = 'false';
                    xml.loadXML(data);
                }
            } catch (e) {
                xml = undefined;
            }
            if (!xml || !xml.documentElement || xml.getElementsByTagName('parsererror').length) {
                jQuery.error('Invalid XML: ' + data);
            }
            return xml;
        };
        var ajaxLocParts, ajaxLocation, rhash = /#.*$/, rts = /([?&])_=[^&]*/, rheaders = /^(.*?):[ \t]*([^\r\n]*)\r?$/gm, rlocalProtocol = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/, rnoContent = /^(?:GET|HEAD)$/, rprotocol = /^\/\//, rurl = /^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/, prefilters = {}, transports = {}, allTypes = '*/'.concat('*');
        try {
            ajaxLocation = location.href;
        } catch (e) {
            ajaxLocation = document.createElement('a');
            ajaxLocation.href = '';
            ajaxLocation = ajaxLocation.href;
        }
        ajaxLocParts = rurl.exec(ajaxLocation.toLowerCase()) || [];
        function addToPrefiltersOrTransports(structure) {
            return function (dataTypeExpression, func) {
                if (typeof dataTypeExpression !== 'string') {
                    func = dataTypeExpression;
                    dataTypeExpression = '*';
                }
                var dataType, i = 0, dataTypes = dataTypeExpression.toLowerCase().match(rnotwhite) || [];
                if (jQuery.isFunction(func)) {
                    while (dataType = dataTypes[i++]) {
                        if (dataType.charAt(0) === '+') {
                            dataType = dataType.slice(1) || '*';
                            (structure[dataType] = structure[dataType] || []).unshift(func);
                        } else {
                            (structure[dataType] = structure[dataType] || []).push(func);
                        }
                    }
                }
            };
        }
        function inspectPrefiltersOrTransports(structure, options, originalOptions, jqXHR) {
            var inspected = {}, seekingTransport = structure === transports;
            function inspect(dataType) {
                var selected;
                inspected[dataType] = true;
                jQuery.each(structure[dataType] || [], function (_, prefilterOrFactory) {
                    var dataTypeOrTransport = prefilterOrFactory(options, originalOptions, jqXHR);
                    if (typeof dataTypeOrTransport === 'string' && !seekingTransport && !inspected[dataTypeOrTransport]) {
                        options.dataTypes.unshift(dataTypeOrTransport);
                        inspect(dataTypeOrTransport);
                        return false;
                    } else if (seekingTransport) {
                        return !(selected = dataTypeOrTransport);
                    }
                });
                return selected;
            }
            return inspect(options.dataTypes[0]) || !inspected['*'] && inspect('*');
        }
        function ajaxExtend(target, src) {
            var deep, key, flatOptions = jQuery.ajaxSettings.flatOptions || {};
            for (key in src) {
                if (src[key] !== undefined) {
                    (flatOptions[key] ? target : deep || (deep = {}))[key] = src[key];
                }
            }
            if (deep) {
                jQuery.extend(true, target, deep);
            }
            return target;
        }
        function ajaxHandleResponses(s, jqXHR, responses) {
            var firstDataType, ct, finalDataType, type, contents = s.contents, dataTypes = s.dataTypes;
            while (dataTypes[0] === '*') {
                dataTypes.shift();
                if (ct === undefined) {
                    ct = s.mimeType || jqXHR.getResponseHeader('Content-Type');
                }
            }
            if (ct) {
                for (type in contents) {
                    if (contents[type] && contents[type].test(ct)) {
                        dataTypes.unshift(type);
                        break;
                    }
                }
            }
            if (dataTypes[0] in responses) {
                finalDataType = dataTypes[0];
            } else {
                for (type in responses) {
                    if (!dataTypes[0] || s.converters[type + ' ' + dataTypes[0]]) {
                        finalDataType = type;
                        break;
                    }
                    if (!firstDataType) {
                        firstDataType = type;
                    }
                }
                finalDataType = finalDataType || firstDataType;
            }
            if (finalDataType) {
                if (finalDataType !== dataTypes[0]) {
                    dataTypes.unshift(finalDataType);
                }
                return responses[finalDataType];
            }
        }
        function ajaxConvert(s, response, jqXHR, isSuccess) {
            var conv2, current, conv, tmp, prev, converters = {}, dataTypes = s.dataTypes.slice();
            if (dataTypes[1]) {
                for (conv in s.converters) {
                    converters[conv.toLowerCase()] = s.converters[conv];
                }
            }
            current = dataTypes.shift();
            while (current) {
                if (s.responseFields[current]) {
                    jqXHR[s.responseFields[current]] = response;
                }
                if (!prev && isSuccess && s.dataFilter) {
                    response = s.dataFilter(response, s.dataType);
                }
                prev = current;
                current = dataTypes.shift();
                if (current) {
                    if (current === '*') {
                        current = prev;
                    } else if (prev !== '*' && prev !== current) {
                        conv = converters[prev + ' ' + current] || converters['* ' + current];
                        if (!conv) {
                            for (conv2 in converters) {
                                tmp = conv2.split(' ');
                                if (tmp[1] === current) {
                                    conv = converters[prev + ' ' + tmp[0]] || converters['* ' + tmp[0]];
                                    if (conv) {
                                        if (conv === true) {
                                            conv = converters[conv2];
                                        } else if (converters[conv2] !== true) {
                                            current = tmp[0];
                                            dataTypes.unshift(tmp[1]);
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        if (conv !== true) {
                            if (conv && s['throws']) {
                                response = conv(response);
                            } else {
                                try {
                                    response = conv(response);
                                } catch (e) {
                                    return {
                                        state: 'parsererror',
                                        error: conv ? e : 'No conversion from ' + prev + ' to ' + current
                                    };
                                }
                            }
                        }
                    }
                }
            }
            return {
                state: 'success',
                data: response
            };
        }
        jQuery.extend({
            active: 0,
            lastModified: {},
            etag: {},
            ajaxSettings: {
                url: ajaxLocation,
                type: 'GET',
                isLocal: rlocalProtocol.test(ajaxLocParts[1]),
                global: true,
                processData: true,
                async: true,
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                accepts: {
                    '*': allTypes,
                    text: 'text/plain',
                    html: 'text/html',
                    xml: 'application/xml, text/xml',
                    json: 'application/json, text/javascript'
                },
                contents: {
                    xml: /xml/,
                    html: /html/,
                    json: /json/
                },
                responseFields: {
                    xml: 'responseXML',
                    text: 'responseText',
                    json: 'responseJSON'
                },
                converters: {
                    '* text': String,
                    'text html': true,
                    'text json': jQuery.parseJSON,
                    'text xml': jQuery.parseXML
                },
                flatOptions: {
                    url: true,
                    context: true
                }
            },
            ajaxSetup: function (target, settings) {
                return settings ? ajaxExtend(ajaxExtend(target, jQuery.ajaxSettings), settings) : ajaxExtend(jQuery.ajaxSettings, target);
            },
            ajaxPrefilter: addToPrefiltersOrTransports(prefilters),
            ajaxTransport: addToPrefiltersOrTransports(transports),
            ajax: function (url, options) {
                if (typeof url === 'object') {
                    options = url;
                    url = undefined;
                }
                options = options || {};
                var parts, i, cacheURL, responseHeadersString, timeoutTimer, fireGlobals, transport, responseHeaders, s = jQuery.ajaxSetup({}, options), callbackContext = s.context || s, globalEventContext = s.context && (callbackContext.nodeType || callbackContext.jquery) ? jQuery(callbackContext) : jQuery.event, deferred = jQuery.Deferred(), completeDeferred = jQuery.Callbacks('once memory'), statusCode = s.statusCode || {}, requestHeaders = {}, requestHeadersNames = {}, state = 0, strAbort = 'canceled', jqXHR = {
                        readyState: 0,
                        getResponseHeader: function (key) {
                            var match;
                            if (state === 2) {
                                if (!responseHeaders) {
                                    responseHeaders = {};
                                    while (match = rheaders.exec(responseHeadersString)) {
                                        responseHeaders[match[1].toLowerCase()] = match[2];
                                    }
                                }
                                match = responseHeaders[key.toLowerCase()];
                            }
                            return match == null ? null : match;
                        },
                        getAllResponseHeaders: function () {
                            return state === 2 ? responseHeadersString : null;
                        },
                        setRequestHeader: function (name, value) {
                            var lname = name.toLowerCase();
                            if (!state) {
                                name = requestHeadersNames[lname] = requestHeadersNames[lname] || name;
                                requestHeaders[name] = value;
                            }
                            return this;
                        },
                        overrideMimeType: function (type) {
                            if (!state) {
                                s.mimeType = type;
                            }
                            return this;
                        },
                        statusCode: function (map) {
                            var code;
                            if (map) {
                                if (state < 2) {
                                    for (code in map) {
                                        statusCode[code] = [
                                            statusCode[code],
                                            map[code]
                                        ];
                                    }
                                } else {
                                    jqXHR.always(map[jqXHR.status]);
                                }
                            }
                            return this;
                        },
                        abort: function (statusText) {
                            var finalText = statusText || strAbort;
                            if (transport) {
                                transport.abort(finalText);
                            }
                            done(0, finalText);
                            return this;
                        }
                    };
                deferred.promise(jqXHR).complete = completeDeferred.add;
                jqXHR.success = jqXHR.done;
                jqXHR.error = jqXHR.fail;
                s.url = ((url || s.url || ajaxLocation) + '').replace(rhash, '').replace(rprotocol, ajaxLocParts[1] + '//');
                s.type = options.method || options.type || s.method || s.type;
                s.dataTypes = jQuery.trim(s.dataType || '*').toLowerCase().match(rnotwhite) || [''];
                if (s.crossDomain == null) {
                    parts = rurl.exec(s.url.toLowerCase());
                    s.crossDomain = !!(parts && (parts[1] !== ajaxLocParts[1] || parts[2] !== ajaxLocParts[2] || (parts[3] || (parts[1] === 'http:' ? '80' : '443')) !== (ajaxLocParts[3] || (ajaxLocParts[1] === 'http:' ? '80' : '443'))));
                }
                if (s.data && s.processData && typeof s.data !== 'string') {
                    s.data = jQuery.param(s.data, s.traditional);
                }
                inspectPrefiltersOrTransports(prefilters, s, options, jqXHR);
                if (state === 2) {
                    return jqXHR;
                }
                fireGlobals = s.global;
                if (fireGlobals && jQuery.active++ === 0) {
                    jQuery.event.trigger('ajaxStart');
                }
                s.type = s.type.toUpperCase();
                s.hasContent = !rnoContent.test(s.type);
                cacheURL = s.url;
                if (!s.hasContent) {
                    if (s.data) {
                        cacheURL = s.url += (rquery.test(cacheURL) ? '&' : '?') + s.data;
                        delete s.data;
                    }
                    if (s.cache === false) {
                        s.url = rts.test(cacheURL) ? cacheURL.replace(rts, '$1_=' + nonce++) : cacheURL + (rquery.test(cacheURL) ? '&' : '?') + '_=' + nonce++;
                    }
                }
                if (s.ifModified) {
                    if (jQuery.lastModified[cacheURL]) {
                        jqXHR.setRequestHeader('If-Modified-Since', jQuery.lastModified[cacheURL]);
                    }
                    if (jQuery.etag[cacheURL]) {
                        jqXHR.setRequestHeader('If-None-Match', jQuery.etag[cacheURL]);
                    }
                }
                if (s.data && s.hasContent && s.contentType !== false || options.contentType) {
                    jqXHR.setRequestHeader('Content-Type', s.contentType);
                }
                jqXHR.setRequestHeader('Accept', s.dataTypes[0] && s.accepts[s.dataTypes[0]] ? s.accepts[s.dataTypes[0]] + (s.dataTypes[0] !== '*' ? ', ' + allTypes + '; q=0.01' : '') : s.accepts['*']);
                for (i in s.headers) {
                    jqXHR.setRequestHeader(i, s.headers[i]);
                }
                if (s.beforeSend && (s.beforeSend.call(callbackContext, jqXHR, s) === false || state === 2)) {
                    return jqXHR.abort();
                }
                strAbort = 'abort';
                for (i in {
                        success: 1,
                        error: 1,
                        complete: 1
                    }) {
                    jqXHR[i](s[i]);
                }
                transport = inspectPrefiltersOrTransports(transports, s, options, jqXHR);
                if (!transport) {
                    done(-1, 'No Transport');
                } else {
                    jqXHR.readyState = 1;
                    if (fireGlobals) {
                        globalEventContext.trigger('ajaxSend', [
                            jqXHR,
                            s
                        ]);
                    }
                    if (s.async && s.timeout > 0) {
                        timeoutTimer = setTimeout(function () {
                            jqXHR.abort('timeout');
                        }, s.timeout);
                    }
                    try {
                        state = 1;
                        transport.send(requestHeaders, done);
                    } catch (e) {
                        if (state < 2) {
                            done(-1, e);
                        } else {
                            throw e;
                        }
                    }
                }
                function done(status, nativeStatusText, responses, headers) {
                    var isSuccess, success, error, response, modified, statusText = nativeStatusText;
                    if (state === 2) {
                        return;
                    }
                    state = 2;
                    if (timeoutTimer) {
                        clearTimeout(timeoutTimer);
                    }
                    transport = undefined;
                    responseHeadersString = headers || '';
                    jqXHR.readyState = status > 0 ? 4 : 0;
                    status = jqXHR.getResponseHeader('Custom-Header-Status') || status;
                    isSuccess = status >= 200 && status < 300 || status === 304;
                    if (responses) {
                        response = ajaxHandleResponses(s, jqXHR, responses);
                    }
                    response = ajaxConvert(s, response, jqXHR, isSuccess);
                    if (isSuccess) {
                        if (s.ifModified) {
                            modified = jqXHR.getResponseHeader('Last-Modified');
                            if (modified) {
                                jQuery.lastModified[cacheURL] = modified;
                            }
                            modified = jqXHR.getResponseHeader('etag');
                            if (modified) {
                                jQuery.etag[cacheURL] = modified;
                            }
                        }
                        if (status === 204 || s.type === 'HEAD') {
                            statusText = 'nocontent';
                        } else if (status === 304) {
                            statusText = 'notmodified';
                        } else {
                            statusText = response.state;
                            success = response.data;
                            error = response.error;
                            isSuccess = !error;
                        }
                    } else {
                        error = statusText;
                        if (status || !statusText) {
                            statusText = 'error';
                            if (status < 0) {
                                status = 0;
                            }
                        }
                    }
                    jqXHR.status = status;
                    jqXHR.statusText = (nativeStatusText || statusText) + '';
                    if (isSuccess) {
                        deferred.resolveWith(callbackContext, [
                            success,
                            statusText,
                            jqXHR
                        ]);
                    } else {
                        deferred.rejectWith(callbackContext, [
                            jqXHR,
                            statusText,
                            error
                        ]);
                    }
                    jqXHR.statusCode(statusCode);
                    statusCode = undefined;
                    if (fireGlobals) {
                        globalEventContext.trigger(isSuccess ? 'ajaxSuccess' : 'ajaxError', [
                            jqXHR,
                            s,
                            isSuccess ? success : error
                        ]);
                    }
                    completeDeferred.fireWith(callbackContext, [
                        jqXHR,
                        statusText
                    ]);
                    if (fireGlobals) {
                        globalEventContext.trigger('ajaxComplete', [
                            jqXHR,
                            s
                        ]);
                        if (!--jQuery.active) {
                            jQuery.event.trigger('ajaxStop');
                        }
                    }
                }
                return jqXHR;
            },
            getJSON: function (url, data, callback) {
                return jQuery.get(url, data, callback, 'json');
            },
            getScript: function (url, callback) {
                return jQuery.get(url, undefined, callback, 'script');
            }
        });
        jQuery.each([
            'get',
            'post'
        ], function (i, method) {
            jQuery[method] = function (url, data, callback, type) {
                if (jQuery.isFunction(data)) {
                    type = type || callback;
                    callback = data;
                    data = undefined;
                }
                return jQuery.ajax({
                    url: url,
                    type: method,
                    dataType: type,
                    data: data,
                    success: callback
                });
            };
        });
        jQuery.each([
            'ajaxStart',
            'ajaxStop',
            'ajaxComplete',
            'ajaxError',
            'ajaxSuccess',
            'ajaxSend'
        ], function (i, type) {
            jQuery.fn[type] = function (fn) {
                return this.on(type, fn);
            };
        });
        jQuery._evalUrl = function (url) {
            return jQuery.ajax({
                url: url,
                type: 'GET',
                dataType: 'script',
                async: false,
                global: false,
                'throws': true
            });
        };
        jQuery.fn.extend({
            wrapAll: function (html) {
                if (jQuery.isFunction(html)) {
                    return this.each(function (i) {
                        jQuery(this).wrapAll(html.call(this, i));
                    });
                }
                if (this[0]) {
                    var wrap = jQuery(html, this[0].ownerDocument).eq(0).clone(true);
                    if (this[0].parentNode) {
                        wrap.insertBefore(this[0]);
                    }
                    wrap.map(function () {
                        var elem = this;
                        while (elem.firstChild && elem.firstChild.nodeType === 1) {
                            elem = elem.firstChild;
                        }
                        return elem;
                    }).append(this);
                }
                return this;
            },
            wrapInner: function (html) {
                if (jQuery.isFunction(html)) {
                    return this.each(function (i) {
                        jQuery(this).wrapInner(html.call(this, i));
                    });
                }
                return this.each(function () {
                    var self = jQuery(this), contents = self.contents();
                    if (contents.length) {
                        contents.wrapAll(html);
                    } else {
                        self.append(html);
                    }
                });
            },
            wrap: function (html) {
                var isFunction = jQuery.isFunction(html);
                return this.each(function (i) {
                    jQuery(this).wrapAll(isFunction ? html.call(this, i) : html);
                });
            },
            unwrap: function () {
                return this.parent().each(function () {
                    if (!jQuery.nodeName(this, 'body')) {
                        jQuery(this).replaceWith(this.childNodes);
                    }
                }).end();
            }
        });
        jQuery.expr.filters.hidden = function (elem) {
            return elem.offsetWidth <= 0 && elem.offsetHeight <= 0 || !support.reliableHiddenOffsets() && (elem.style && elem.style.display || jQuery.css(elem, 'display')) === 'none';
        };
        jQuery.expr.filters.visible = function (elem) {
            return !jQuery.expr.filters.hidden(elem);
        };
        var r20 = /%20/g, rbracket = /\[\]$/, rCRLF = /\r?\n/g, rsubmitterTypes = /^(?:submit|button|image|reset|file)$/i, rsubmittable = /^(?:input|select|textarea|keygen)/i;
        function buildParams(prefix, obj, traditional, add) {
            var name;
            if (jQuery.isArray(obj)) {
                jQuery.each(obj, function (i, v) {
                    if (traditional || rbracket.test(prefix)) {
                        add(prefix, v);
                    } else {
                        buildParams(prefix + '[' + (typeof v === 'object' ? i : '') + ']', v, traditional, add);
                    }
                });
            } else if (!traditional && jQuery.type(obj) === 'object') {
                for (name in obj) {
                    buildParams(prefix + '[' + name + ']', obj[name], traditional, add);
                }
            } else {
                add(prefix, obj);
            }
        }
        jQuery.param = function (a, traditional) {
            var prefix, s = [], add = function (key, value) {
                    value = jQuery.isFunction(value) ? value() : value == null ? '' : value;
                    s[s.length] = encodeURIComponent(key) + '=' + encodeURIComponent(value);
                };
            if (traditional === undefined) {
                traditional = jQuery.ajaxSettings && jQuery.ajaxSettings.traditional;
            }
            if (jQuery.isArray(a) || a.jquery && !jQuery.isPlainObject(a)) {
                jQuery.each(a, function () {
                    add(this.name, this.value);
                });
            } else {
                for (prefix in a) {
                    buildParams(prefix, a[prefix], traditional, add);
                }
            }
            return s.join('&').replace(r20, '+');
        };
        jQuery.fn.extend({
            serialize: function () {
                return jQuery.param(this.serializeArray());
            },
            serializeArray: function () {
                return this.map(function () {
                    var elements = jQuery.prop(this, 'elements');
                    return elements ? jQuery.makeArray(elements) : this;
                }).filter(function () {
                    var type = this.type;
                    return this.name && !jQuery(this).is(':disabled') && rsubmittable.test(this.nodeName) && !rsubmitterTypes.test(type) && (this.checked || !rcheckableType.test(type));
                }).map(function (i, elem) {
                    var val = jQuery(this).val();
                    return val == null ? null : jQuery.isArray(val) ? jQuery.map(val, function (val) {
                        return {
                            name: elem.name,
                            value: val.replace(rCRLF, '\r\n')
                        };
                    }) : {
                        name: elem.name,
                        value: val.replace(rCRLF, '\r\n')
                    };
                }).get();
            }
        });
        jQuery.ajaxSettings.xhr = window.ActiveXObject !== undefined ? function () {
            return !this.isLocal && /^(get|post|head|put|delete|options)$/i.test(this.type) && createStandardXHR() || createActiveXHR();
        } : createStandardXHR;
        var xhrId = 0, xhrCallbacks = {}, xhrSupported = jQuery.ajaxSettings.xhr();
        if (window.ActiveXObject) {
            jQuery(window).on('unload', function () {
                for (var key in xhrCallbacks) {
                    xhrCallbacks[key](undefined, true);
                }
            });
        }
        support.cors = !!xhrSupported && 'withCredentials' in xhrSupported;
        xhrSupported = support.ajax = !!xhrSupported;
        if (xhrSupported) {
            jQuery.ajaxTransport(function (options) {
                if (!options.crossDomain || support.cors) {
                    var callback;
                    return {
                        send: function (headers, complete) {
                            var i, xhr = options.xhr(), id = ++xhrId;
                            xhr.open(options.type, options.url, options.async, options.username, options.password);
                            if (options.xhrFields) {
                                for (i in options.xhrFields) {
                                    xhr[i] = options.xhrFields[i];
                                }
                            }
                            if (options.mimeType && xhr.overrideMimeType) {
                                xhr.overrideMimeType(options.mimeType);
                            }
                            if (!options.crossDomain && !headers['X-Requested-With']) {
                                headers['X-Requested-With'] = 'XMLHttpRequest';
                            }
                            for (i in headers) {
                                if (headers[i] !== undefined) {
                                    xhr.setRequestHeader(i, headers[i] + '');
                                }
                            }
                            xhr.send(options.hasContent && options.data || null);
                            callback = function (_, isAbort) {
                                var status, statusText, responses;
                                if (callback && (isAbort || xhr.readyState === 4)) {
                                    delete xhrCallbacks[id];
                                    callback = undefined;
                                    xhr.onreadystatechange = jQuery.noop;
                                    if (isAbort) {
                                        if (xhr.readyState !== 4) {
                                            xhr.abort();
                                        }
                                    } else {
                                        responses = {};
                                        status = xhr.status;
                                        if (typeof xhr.responseText === 'string') {
                                            responses.text = xhr.responseText;
                                        }
                                        try {
                                            statusText = xhr.statusText;
                                        } catch (e) {
                                            statusText = '';
                                        }
                                        if (!status && options.isLocal && !options.crossDomain) {
                                            status = responses.text ? 200 : 404;
                                        } else if (status === 1223) {
                                            status = 204;
                                        }
                                    }
                                }
                                if (responses) {
                                    complete(status, statusText, responses, xhr.getAllResponseHeaders());
                                }
                            };
                            if (!options.async) {
                                callback();
                            } else if (xhr.readyState === 4) {
                                setTimeout(callback);
                            } else {
                                xhr.onreadystatechange = xhrCallbacks[id] = callback;
                            }
                        },
                        abort: function () {
                            if (callback) {
                                callback(undefined, true);
                            }
                        }
                    };
                }
            });
        }
        function createStandardXHR() {
            try {
                return new window.XMLHttpRequest();
            } catch (e) {
            }
        }
        function createActiveXHR() {
            try {
                return new window.ActiveXObject('Microsoft.XMLHTTP');
            } catch (e) {
            }
        }
        jQuery.ajaxSetup({
            accepts: { script: 'text/javascript, application/javascript, application/ecmascript, application/x-ecmascript' },
            contents: { script: /(?:java|ecma)script/ },
            converters: {
                'text script': function (text) {
                    jQuery.globalEval(text);
                    return text;
                }
            }
        });
        jQuery.ajaxPrefilter('script', function (s) {
            if (s.cache === undefined) {
                s.cache = false;
            }
            if (s.crossDomain) {
                s.type = 'GET';
                s.global = false;
            }
        });
        jQuery.ajaxTransport('script', function (s) {
            if (s.crossDomain) {
                var script, head = document.head || jQuery('head')[0] || document.documentElement;
                return {
                    send: function (_, callback) {
                        script = document.createElement('script');
                        script.async = true;
                        if (s.scriptCharset) {
                            script.charset = s.scriptCharset;
                        }
                        script.src = s.url;
                        script.onload = script.onreadystatechange = function (_, isAbort) {
                            if (isAbort || !script.readyState || /loaded|complete/.test(script.readyState)) {
                                script.onload = script.onreadystatechange = null;
                                if (script.parentNode) {
                                    script.parentNode.removeChild(script);
                                }
                                script = null;
                                if (!isAbort) {
                                    callback(200, 'success');
                                }
                            }
                        };
                        head.insertBefore(script, head.firstChild);
                    },
                    abort: function () {
                        if (script) {
                            script.onload(undefined, true);
                        }
                    }
                };
            }
        });
        var oldCallbacks = [], rjsonp = /(=)\?(?=&|$)|\?\?/;
        jQuery.ajaxSetup({
            jsonp: 'callback',
            jsonpCallback: function () {
                var callback = oldCallbacks.pop() || jQuery.expando + '_' + nonce++;
                this[callback] = true;
                return callback;
            }
        });
        jQuery.ajaxPrefilter('json jsonp', function (s, originalSettings, jqXHR) {
            var callbackName, overwritten, responseContainer, jsonProp = s.jsonp !== false && (rjsonp.test(s.url) ? 'url' : typeof s.data === 'string' && !(s.contentType || '').indexOf('application/x-www-form-urlencoded') && rjsonp.test(s.data) && 'data');
            if (jsonProp || s.dataTypes[0] === 'jsonp') {
                callbackName = s.jsonpCallback = jQuery.isFunction(s.jsonpCallback) ? s.jsonpCallback() : s.jsonpCallback;
                if (jsonProp) {
                    s[jsonProp] = s[jsonProp].replace(rjsonp, '$1' + callbackName);
                } else if (s.jsonp !== false) {
                    s.url += (rquery.test(s.url) ? '&' : '?') + s.jsonp + '=' + callbackName;
                }
                s.converters['script json'] = function () {
                    if (!responseContainer) {
                        jQuery.error(callbackName + ' was not called');
                    }
                    return responseContainer[0];
                };
                s.dataTypes[0] = 'json';
                overwritten = window[callbackName];
                window[callbackName] = function () {
                    responseContainer = arguments;
                };
                jqXHR.always(function () {
                    window[callbackName] = overwritten;
                    if (s[callbackName]) {
                        s.jsonpCallback = originalSettings.jsonpCallback;
                        oldCallbacks.push(callbackName);
                    }
                    if (responseContainer && jQuery.isFunction(overwritten)) {
                        overwritten(responseContainer[0]);
                    }
                    responseContainer = overwritten = undefined;
                });
                return 'script';
            }
        });
        jQuery.parseHTML = function (data, context, keepScripts) {
            if (!data || typeof data !== 'string') {
                return null;
            }
            if (typeof context === 'boolean') {
                keepScripts = context;
                context = false;
            }
            context = context || document;
            var parsed = rsingleTag.exec(data), scripts = !keepScripts && [];
            if (parsed) {
                return [context.createElement(parsed[1])];
            }
            parsed = jQuery.buildFragment([data], context, scripts);
            if (scripts && scripts.length) {
                jQuery(scripts).remove();
            }
            return jQuery.merge([], parsed.childNodes);
        };
        var _load = jQuery.fn.load;
        jQuery.fn.load = function (url, params, callback) {
            if (typeof url !== 'string' && _load) {
                return _load.apply(this, arguments);
            }
            var selector, response, type, self = this, off = url.indexOf(' ');
            if (off >= 0) {
                selector = jQuery.trim(url.slice(off, url.length));
                url = url.slice(0, off);
            }
            if (jQuery.isFunction(params)) {
                callback = params;
                params = undefined;
            } else if (params && typeof params === 'object') {
                type = 'POST';
            }
            if (self.length > 0) {
                jQuery.ajax({
                    url: url,
                    type: type,
                    dataType: 'html',
                    data: params
                }).done(function (responseText) {
                    response = arguments;
                    self.html(selector ? jQuery('<div>').append(jQuery.parseHTML(responseText)).find(selector) : responseText);
                }).complete(callback && function (jqXHR, status) {
                    self.each(callback, response || [
                        jqXHR.responseText,
                        status,
                        jqXHR
                    ]);
                });
            }
            return this;
        };
        jQuery.expr.filters.animated = function (elem) {
            return jQuery.grep(jQuery.timers, function (fn) {
                return elem === fn.elem;
            }).length;
        };
        var docElem = window.document.documentElement;
        function getWindow(elem) {
            return jQuery.isWindow(elem) ? elem : elem.nodeType === 9 ? elem.defaultView || elem.parentWindow : false;
        }
        jQuery.offset = {
            setOffset: function (elem, options, i) {
                var curPosition, curLeft, curCSSTop, curTop, curOffset, curCSSLeft, calculatePosition, position = jQuery.css(elem, 'position'), curElem = jQuery(elem), props = {};
                if (position === 'static') {
                    elem.style.position = 'relative';
                }
                curOffset = curElem.offset();
                curCSSTop = jQuery.css(elem, 'top');
                curCSSLeft = jQuery.css(elem, 'left');
                calculatePosition = (position === 'absolute' || position === 'fixed') && jQuery.inArray('auto', [
                    curCSSTop,
                    curCSSLeft
                ]) > -1;
                if (calculatePosition) {
                    curPosition = curElem.position();
                    curTop = curPosition.top;
                    curLeft = curPosition.left;
                } else {
                    curTop = parseFloat(curCSSTop) || 0;
                    curLeft = parseFloat(curCSSLeft) || 0;
                }
                if (jQuery.isFunction(options)) {
                    options = options.call(elem, i, curOffset);
                }
                if (options.top != null) {
                    props.top = options.top - curOffset.top + curTop;
                }
                if (options.left != null) {
                    props.left = options.left - curOffset.left + curLeft;
                }
                if ('using' in options) {
                    options.using.call(elem, props);
                } else {
                    curElem.css(props);
                }
            }
        };
        jQuery.fn.extend({
            offset: function (options) {
                if (arguments.length) {
                    return options === undefined ? this : this.each(function (i) {
                        jQuery.offset.setOffset(this, options, i);
                    });
                }
                var docElem, win, box = {
                        top: 0,
                        left: 0
                    }, elem = this[0], doc = elem && elem.ownerDocument;
                if (!doc) {
                    return;
                }
                docElem = doc.documentElement;
                if (!jQuery.contains(docElem, elem)) {
                    return box;
                }
                if (typeof elem.getBoundingClientRect !== strundefined) {
                    box = elem.getBoundingClientRect();
                }
                win = getWindow(doc);
                return {
                    top: box.top + (win.pageYOffset || docElem.scrollTop) - (docElem.clientTop || 0),
                    left: box.left + (win.pageXOffset || docElem.scrollLeft) - (docElem.clientLeft || 0)
                };
            },
            position: function () {
                if (!this[0]) {
                    return;
                }
                var offsetParent, offset, parentOffset = {
                        top: 0,
                        left: 0
                    }, elem = this[0];
                if (jQuery.css(elem, 'position') === 'fixed') {
                    offset = elem.getBoundingClientRect();
                } else {
                    offsetParent = this.offsetParent();
                    offset = this.offset();
                    if (!jQuery.nodeName(offsetParent[0], 'html')) {
                        parentOffset = offsetParent.offset();
                    }
                    parentOffset.top += jQuery.css(offsetParent[0], 'borderTopWidth', true);
                    parentOffset.left += jQuery.css(offsetParent[0], 'borderLeftWidth', true);
                }
                return {
                    top: offset.top - parentOffset.top - jQuery.css(elem, 'marginTop', true),
                    left: offset.left - parentOffset.left - jQuery.css(elem, 'marginLeft', true)
                };
            },
            offsetParent: function () {
                return this.map(function () {
                    var offsetParent = this.offsetParent || docElem;
                    while (offsetParent && (!jQuery.nodeName(offsetParent, 'html') && jQuery.css(offsetParent, 'position') === 'static')) {
                        offsetParent = offsetParent.offsetParent;
                    }
                    return offsetParent || docElem;
                });
            }
        });
        jQuery.each({
            scrollLeft: 'pageXOffset',
            scrollTop: 'pageYOffset'
        }, function (method, prop) {
            var top = /Y/.test(prop);
            jQuery.fn[method] = function (val) {
                return access(this, function (elem, method, val) {
                    var win = getWindow(elem);
                    if (val === undefined) {
                        return win ? prop in win ? win[prop] : win.document.documentElement[method] : elem[method];
                    }
                    if (win) {
                        win.scrollTo(!top ? val : jQuery(win).scrollLeft(), top ? val : jQuery(win).scrollTop());
                    } else {
                        elem[method] = val;
                    }
                }, method, val, arguments.length, null);
            };
        });
        jQuery.each([
            'top',
            'left'
        ], function (i, prop) {
            jQuery.cssHooks[prop] = addGetHookIf(support.pixelPosition, function (elem, computed) {
                if (computed) {
                    computed = curCSS(elem, prop);
                    return rnumnonpx.test(computed) ? jQuery(elem).position()[prop] + 'px' : computed;
                }
            });
        });
        jQuery.each({
            Height: 'height',
            Width: 'width'
        }, function (name, type) {
            jQuery.each({
                padding: 'inner' + name,
                content: type,
                '': 'outer' + name
            }, function (defaultExtra, funcName) {
                jQuery.fn[funcName] = function (margin, value) {
                    var chainable = arguments.length && (defaultExtra || typeof margin !== 'boolean'), extra = defaultExtra || (margin === true || value === true ? 'margin' : 'border');
                    return access(this, function (elem, type, value) {
                        var doc;
                        if (jQuery.isWindow(elem)) {
                            return elem.document.documentElement['client' + name];
                        }
                        if (elem.nodeType === 9) {
                            doc = elem.documentElement;
                            return Math.max(elem.body['scroll' + name], doc['scroll' + name], elem.body['offset' + name], doc['offset' + name], doc['client' + name]);
                        }
                        return value === undefined ? jQuery.css(elem, type, extra) : jQuery.style(elem, type, value, extra);
                    }, type, chainable ? margin : undefined, chainable, null);
                };
            });
        });
        jQuery.fn.size = function () {
            return this.length;
        };
        jQuery.fn.andSelf = jQuery.fn.addBack;
        if (typeof define === 'function' && define.amd) {
            define('jquery', [], function () {
                return jQuery;
            });
        }
        var _jQuery = window.jQuery, _$ = window.$;
        jQuery.noConflict = function (deep) {
            if (window.$ === jQuery) {
                window.$ = _$;
            }
            if (deep && window.jQuery === jQuery) {
                window.jQuery = _jQuery;
            }
            return jQuery;
        };
        if (typeof noGlobal === strundefined) {
            window.jQuery = window.$ = jQuery;
        }
        return jQuery;
    }));
    return jQuery;
});
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define('Backbone', [
            'underscore',
            'jQuery',
            'exports'
        ], function (_, $, exports) {
            root.Backbone = factory(root, exports, _, $);
        });
    } else if (typeof exports !== 'undefined') {
        var _ = require('underscore');
        factory(root, exports, _);
    } else {
        root.Backbone = factory(root, {}, root._, root.jQuery || root.Zepto || root.ender || root.$);
    }
}(this, function (root, Backbone, _, $) {
    var previousBackbone = root.Backbone;
    var array = [];
    var push = array.push;
    var slice = array.slice;
    var splice = array.splice;
    Backbone.VERSION = '1.1.2';
    Backbone.$ = $;
    Backbone.noConflict = function () {
        root.Backbone = previousBackbone;
        return this;
    };
    Backbone.emulateHTTP = false;
    Backbone.emulateJSON = false;
    var Events = Backbone.Events = {
        on: function (name, callback, context) {
            if (!eventsApi(this, 'on', name, [
                    callback,
                    context
                ]) || !callback)
                return this;
            this._events || (this._events = {});
            var events = this._events[name] || (this._events[name] = []);
            events.push({
                callback: callback,
                context: context,
                ctx: context || this
            });
            return this;
        },
        once: function (name, callback, context) {
            if (!eventsApi(this, 'once', name, [
                    callback,
                    context
                ]) || !callback)
                return this;
            var self = this;
            var once = _.once(function () {
                self.off(name, once);
                callback.apply(this, arguments);
            });
            once._callback = callback;
            return this.on(name, once, context);
        },
        off: function (name, callback, context) {
            var retain, ev, events, names, i, l, j, k;
            if (!this._events || !eventsApi(this, 'off', name, [
                    callback,
                    context
                ]))
                return this;
            if (!name && !callback && !context) {
                this._events = void 0;
                return this;
            }
            names = name ? [name] : _.keys(this._events);
            for (i = 0, l = names.length; i < l; i++) {
                name = names[i];
                if (events = this._events[name]) {
                    this._events[name] = retain = [];
                    if (callback || context) {
                        for (j = 0, k = events.length; j < k; j++) {
                            ev = events[j];
                            if (callback && callback !== ev.callback && callback !== ev.callback._callback || context && context !== ev.context) {
                                retain.push(ev);
                            }
                        }
                    }
                    if (!retain.length)
                        delete this._events[name];
                }
            }
            return this;
        },
        trigger: function (name) {
            if (!this._events)
                return this;
            var args = slice.call(arguments, 1);
            if (!eventsApi(this, 'trigger', name, args))
                return this;
            var events = this._events[name];
            var allEvents = this._events.all;
            if (events)
                triggerEvents(events, args);
            if (allEvents)
                triggerEvents(allEvents, arguments);
            return this;
        },
        stopListening: function (obj, name, callback) {
            var listeningTo = this._listeningTo;
            if (!listeningTo)
                return this;
            var remove = !name && !callback;
            if (!callback && typeof name === 'object')
                callback = this;
            if (obj)
                (listeningTo = {})[obj._listenId] = obj;
            for (var id in listeningTo) {
                obj = listeningTo[id];
                obj.off(name, callback, this);
                if (remove || _.isEmpty(obj._events))
                    delete this._listeningTo[id];
            }
            return this;
        }
    };
    var eventSplitter = /\s+/;
    var eventsApi = function (obj, action, name, rest) {
        if (!name)
            return true;
        if (typeof name === 'object') {
            for (var key in name) {
                obj[action].apply(obj, [
                    key,
                    name[key]
                ].concat(rest));
            }
            return false;
        }
        if (eventSplitter.test(name)) {
            var names = name.split(eventSplitter);
            for (var i = 0, l = names.length; i < l; i++) {
                obj[action].apply(obj, [names[i]].concat(rest));
            }
            return false;
        }
        return true;
    };
    var triggerEvents = function (events, args) {
        var ev, i = -1, l = events.length, a1 = args[0], a2 = args[1], a3 = args[2];
        switch (args.length) {
        case 0:
            while (++i < l)
                (ev = events[i]).callback.call(ev.ctx);
            return;
        case 1:
            while (++i < l)
                (ev = events[i]).callback.call(ev.ctx, a1);
            return;
        case 2:
            while (++i < l)
                (ev = events[i]).callback.call(ev.ctx, a1, a2);
            return;
        case 3:
            while (++i < l)
                (ev = events[i]).callback.call(ev.ctx, a1, a2, a3);
            return;
        default:
            while (++i < l)
                (ev = events[i]).callback.apply(ev.ctx, args);
            return;
        }
    };
    var listenMethods = {
        listenTo: 'on',
        listenToOnce: 'once'
    };
    _.each(listenMethods, function (implementation, method) {
        Events[method] = function (obj, name, callback) {
            var listeningTo = this._listeningTo || (this._listeningTo = {});
            var id = obj._listenId || (obj._listenId = _.uniqueId('l'));
            listeningTo[id] = obj;
            if (!callback && typeof name === 'object')
                callback = this;
            obj[implementation](name, callback, this);
            return this;
        };
    });
    Events.bind = Events.on;
    Events.unbind = Events.off;
    _.extend(Backbone, Events);
    var Model = Backbone.Model = function (attributes, options) {
        var attrs = attributes || {};
        options || (options = {});
        this.cid = _.uniqueId('c');
        this.attributes = {};
        if (options.collection)
            this.collection = options.collection;
        if (options.parse)
            attrs = this.parse(attrs, options) || {};
        attrs = _.defaults({}, attrs, _.result(this, 'defaults'));
        this.set(attrs, options);
        this.changed = {};
        this.initialize.apply(this, arguments);
    };
    _.extend(Model.prototype, Events, {
        changed: null,
        validationError: null,
        idAttribute: 'id',
        initialize: function () {
        },
        toJSON: function (options) {
            return _.clone(this.attributes);
        },
        sync: function () {
            return Backbone.sync.apply(this, arguments);
        },
        get: function (attr) {
            return this.attributes[attr];
        },
        escape: function (attr) {
            return _.escape(this.get(attr));
        },
        has: function (attr) {
            return this.get(attr) != null;
        },
        set: function (key, val, options) {
            var attr, attrs, unset, changes, silent, changing, prev, current;
            if (key == null)
                return this;
            if (typeof key === 'object') {
                attrs = key;
                options = val;
            } else {
                (attrs = {})[key] = val;
            }
            options || (options = {});
            if (!this._validate(attrs, options))
                return false;
            unset = options.unset;
            silent = options.silent;
            changes = [];
            changing = this._changing;
            this._changing = true;
            if (!changing) {
                this._previousAttributes = _.clone(this.attributes);
                this.changed = {};
            }
            current = this.attributes, prev = this._previousAttributes;
            if (this.idAttribute in attrs)
                this.id = attrs[this.idAttribute];
            for (attr in attrs) {
                val = attrs[attr];
                if (!_.isEqual(current[attr], val))
                    changes.push(attr);
                if (!_.isEqual(prev[attr], val)) {
                    this.changed[attr] = val;
                } else {
                    delete this.changed[attr];
                }
                unset ? delete current[attr] : current[attr] = val;
            }
            if (!silent) {
                if (changes.length)
                    this._pending = options;
                for (var i = 0, l = changes.length; i < l; i++) {
                    this.trigger('change:' + changes[i], this, current[changes[i]], options);
                }
            }
            if (changing)
                return this;
            if (!silent) {
                while (this._pending) {
                    options = this._pending;
                    this._pending = false;
                    this.trigger('change', this, options);
                }
            }
            this._pending = false;
            this._changing = false;
            return this;
        },
        unset: function (attr, options) {
            return this.set(attr, void 0, _.extend({}, options, { unset: true }));
        },
        clear: function (options) {
            var attrs = {};
            for (var key in this.attributes)
                attrs[key] = void 0;
            return this.set(attrs, _.extend({}, options, { unset: true }));
        },
        hasChanged: function (attr) {
            if (attr == null)
                return !_.isEmpty(this.changed);
            return _.has(this.changed, attr);
        },
        changedAttributes: function (diff) {
            if (!diff)
                return this.hasChanged() ? _.clone(this.changed) : false;
            var val, changed = false;
            var old = this._changing ? this._previousAttributes : this.attributes;
            for (var attr in diff) {
                if (_.isEqual(old[attr], val = diff[attr]))
                    continue;
                (changed || (changed = {}))[attr] = val;
            }
            return changed;
        },
        previous: function (attr) {
            if (attr == null || !this._previousAttributes)
                return null;
            return this._previousAttributes[attr];
        },
        previousAttributes: function () {
            return _.clone(this._previousAttributes);
        },
        fetch: function (options) {
            options = options ? _.clone(options) : {};
            if (options.parse === void 0)
                options.parse = true;
            var model = this;
            var success = options.success;
            options.success = function (resp) {
                if (!model.set(model.parse(resp, options), options))
                    return false;
                if (success)
                    success(model, resp, options);
                model.trigger('sync', model, resp, options);
            };
            wrapError(this, options);
            return this.sync('read', this, options);
        },
        save: function (key, val, options) {
            var attrs, method, xhr, attributes = this.attributes;
            if (key == null || typeof key === 'object') {
                attrs = key;
                options = val;
            } else {
                (attrs = {})[key] = val;
            }
            options = _.extend({ validate: true }, options);
            if (attrs && !options.wait) {
                if (!this.set(attrs, options))
                    return false;
            } else {
                if (!this._validate(attrs, options))
                    return false;
            }
            if (attrs && options.wait) {
                this.attributes = _.extend({}, attributes, attrs);
            }
            if (options.parse === void 0)
                options.parse = true;
            var model = this;
            var success = options.success;
            options.success = function (resp) {
                model.attributes = attributes;
                var serverAttrs = model.parse(resp, options);
                if (options.wait)
                    serverAttrs = _.extend(attrs || {}, serverAttrs);
                if (_.isObject(serverAttrs) && !model.set(serverAttrs, options)) {
                    return false;
                }
                if (success)
                    success(model, resp, options);
                model.trigger('sync', model, resp, options);
            };
            wrapError(this, options);
            method = this.isNew() ? 'create' : options.patch ? 'patch' : 'update';
            if (method === 'patch')
                options.attrs = attrs;
            xhr = this.sync(method, this, options);
            if (attrs && options.wait)
                this.attributes = attributes;
            return xhr;
        },
        destroy: function (options) {
            options = options ? _.clone(options) : {};
            var model = this;
            var success = options.success;
            var destroy = function () {
                model.trigger('destroy', model, model.collection, options);
            };
            options.success = function (resp) {
                if (options.wait || model.isNew())
                    destroy();
                if (success)
                    success(model, resp, options);
                if (!model.isNew())
                    model.trigger('sync', model, resp, options);
            };
            if (this.isNew()) {
                options.success();
                return false;
            }
            wrapError(this, options);
            var xhr = this.sync('delete', this, options);
            if (!options.wait)
                destroy();
            return xhr;
        },
        url: function () {
            var base = _.result(this, 'urlRoot') || _.result(this.collection, 'url') || urlError();
            if (this.isNew())
                return base;
            return base.replace(/([^\/])$/, '$1/') + encodeURIComponent(this.id);
        },
        parse: function (resp, options) {
            return resp;
        },
        clone: function () {
            return new this.constructor(this.attributes);
        },
        isNew: function () {
            return !this.has(this.idAttribute);
        },
        isValid: function (options) {
            return this._validate({}, _.extend(options || {}, { validate: true }));
        },
        _validate: function (attrs, options) {
            if (!options.validate || !this.validate)
                return true;
            attrs = _.extend({}, this.attributes, attrs);
            var error = this.validationError = this.validate(attrs, options) || null;
            if (!error)
                return true;
            this.trigger('invalid', this, error, _.extend(options, { validationError: error }));
            return false;
        }
    });
    var modelMethods = [
        'keys',
        'values',
        'pairs',
        'invert',
        'pick',
        'omit'
    ];
    _.each(modelMethods, function (method) {
        Model.prototype[method] = function () {
            var args = slice.call(arguments);
            args.unshift(this.attributes);
            return _[method].apply(_, args);
        };
    });
    var Collection = Backbone.Collection = function (models, options) {
        options || (options = {});
        if (options.model)
            this.model = options.model;
        if (options.comparator !== void 0)
            this.comparator = options.comparator;
        this._reset();
        this.initialize.apply(this, arguments);
        if (models)
            this.reset(models, _.extend({ silent: true }, options));
    };
    var setOptions = {
        add: true,
        remove: true,
        merge: true
    };
    var addOptions = {
        add: true,
        remove: false
    };
    _.extend(Collection.prototype, Events, {
        model: Model,
        initialize: function () {
        },
        toJSON: function (options) {
            return this.map(function (model) {
                return model.toJSON(options);
            });
        },
        sync: function () {
            return Backbone.sync.apply(this, arguments);
        },
        add: function (models, options) {
            return this.set(models, _.extend({ merge: false }, options, addOptions));
        },
        remove: function (models, options) {
            var singular = !_.isArray(models);
            models = singular ? [models] : _.clone(models);
            options || (options = {});
            var i, l, index, model;
            for (i = 0, l = models.length; i < l; i++) {
                model = models[i] = this.get(models[i]);
                if (!model)
                    continue;
                delete this._byId[model.id];
                delete this._byId[model.cid];
                index = this.indexOf(model);
                this.models.splice(index, 1);
                this.length--;
                if (!options.silent) {
                    options.index = index;
                    model.trigger('remove', model, this, options);
                }
                this._removeReference(model, options);
            }
            return singular ? models[0] : models;
        },
        set: function (models, options) {
            options = _.defaults({}, options, setOptions);
            if (options.parse)
                models = this.parse(models, options);
            var singular = !_.isArray(models);
            models = singular ? models ? [models] : [] : _.clone(models);
            var i, l, id, model, attrs, existing, sort;
            var at = options.at;
            var targetModel = this.model;
            var sortable = this.comparator && at == null && options.sort !== false;
            var sortAttr = _.isString(this.comparator) ? this.comparator : null;
            var toAdd = [], toRemove = [], modelMap = {};
            var add = options.add, merge = options.merge, remove = options.remove;
            var order = !sortable && add && remove ? [] : false;
            for (i = 0, l = models.length; i < l; i++) {
                attrs = models[i] || {};
                if (attrs instanceof Model) {
                    id = model = attrs;
                } else {
                    id = attrs[targetModel.prototype.idAttribute || 'id'];
                }
                if (existing = this.get(id)) {
                    if (remove)
                        modelMap[existing.cid] = true;
                    if (merge) {
                        attrs = attrs === model ? model.attributes : attrs;
                        if (options.parse)
                            attrs = existing.parse(attrs, options);
                        existing.set(attrs, options);
                        if (sortable && !sort && existing.hasChanged(sortAttr))
                            sort = true;
                    }
                    models[i] = existing;
                } else if (add) {
                    model = models[i] = this._prepareModel(attrs, options);
                    if (!model)
                        continue;
                    toAdd.push(model);
                    this._addReference(model, options);
                }
                model = existing || model;
                if (order && (model.isNew() || !modelMap[model.id]))
                    order.push(model);
                modelMap[model.id] = true;
            }
            if (remove) {
                for (i = 0, l = this.length; i < l; ++i) {
                    if (!modelMap[(model = this.models[i]).cid])
                        toRemove.push(model);
                }
                if (toRemove.length)
                    this.remove(toRemove, options);
            }
            if (toAdd.length || order && order.length) {
                if (sortable)
                    sort = true;
                this.length += toAdd.length;
                if (at != null) {
                    for (i = 0, l = toAdd.length; i < l; i++) {
                        this.models.splice(at + i, 0, toAdd[i]);
                    }
                } else {
                    if (order)
                        this.models.length = 0;
                    var orderedModels = order || toAdd;
                    for (i = 0, l = orderedModels.length; i < l; i++) {
                        this.models.push(orderedModels[i]);
                    }
                }
            }
            if (sort)
                this.sort({ silent: true });
            if (!options.silent) {
                for (i = 0, l = toAdd.length; i < l; i++) {
                    (model = toAdd[i]).trigger('add', model, this, options);
                }
                if (sort || order && order.length)
                    this.trigger('sort', this, options);
            }
            return singular ? models[0] : models;
        },
        reset: function (models, options) {
            options || (options = {});
            for (var i = 0, l = this.models.length; i < l; i++) {
                this._removeReference(this.models[i], options);
            }
            options.previousModels = this.models;
            this._reset();
            models = this.add(models, _.extend({ silent: true }, options));
            if (!options.silent)
                this.trigger('reset', this, options);
            return models;
        },
        push: function (model, options) {
            return this.add(model, _.extend({ at: this.length }, options));
        },
        pop: function (options) {
            var model = this.at(this.length - 1);
            this.remove(model, options);
            return model;
        },
        unshift: function (model, options) {
            return this.add(model, _.extend({ at: 0 }, options));
        },
        shift: function (options) {
            var model = this.at(0);
            this.remove(model, options);
            return model;
        },
        slice: function () {
            return slice.apply(this.models, arguments);
        },
        get: function (obj) {
            if (obj == null)
                return void 0;
            return this._byId[obj] || this._byId[obj.id] || this._byId[obj.cid];
        },
        at: function (index) {
            return this.models[index];
        },
        where: function (attrs, first) {
            if (_.isEmpty(attrs))
                return first ? void 0 : [];
            return this[first ? 'find' : 'filter'](function (model) {
                for (var key in attrs) {
                    if (attrs[key] !== model.get(key))
                        return false;
                }
                return true;
            });
        },
        findWhere: function (attrs) {
            return this.where(attrs, true);
        },
        sort: function (options) {
            if (!this.comparator)
                throw new Error('Cannot sort a set without a comparator');
            options || (options = {});
            if (_.isString(this.comparator) || this.comparator.length === 1) {
                this.models = this.sortBy(this.comparator, this);
            } else {
                this.models.sort(_.bind(this.comparator, this));
            }
            if (!options.silent)
                this.trigger('sort', this, options);
            return this;
        },
        pluck: function (attr) {
            return _.invoke(this.models, 'get', attr);
        },
        fetch: function (options) {
            options = options ? _.clone(options) : {};
            if (options.parse === void 0)
                options.parse = true;
            var success = options.success;
            var collection = this;
            options.success = function (resp) {
                var method = options.reset ? 'reset' : 'set';
                collection[method](resp, options);
                if (success)
                    success(collection, resp, options);
                collection.trigger('sync', collection, resp, options);
            };
            wrapError(this, options);
            return this.sync('read', this, options);
        },
        create: function (model, options) {
            options = options ? _.clone(options) : {};
            if (!(model = this._prepareModel(model, options)))
                return false;
            if (!options.wait)
                this.add(model, options);
            var collection = this;
            var success = options.success;
            options.success = function (model, resp) {
                if (options.wait)
                    collection.add(model, options);
                if (success)
                    success(model, resp, options);
            };
            model.save(null, options);
            return model;
        },
        parse: function (resp, options) {
            return resp;
        },
        clone: function () {
            return new this.constructor(this.models);
        },
        _reset: function () {
            this.length = 0;
            this.models = [];
            this._byId = {};
        },
        _prepareModel: function (attrs, options) {
            if (attrs instanceof Model)
                return attrs;
            options = options ? _.clone(options) : {};
            options.collection = this;
            var model = new this.model(attrs, options);
            if (!model.validationError)
                return model;
            this.trigger('invalid', this, model.validationError, options);
            return false;
        },
        _addReference: function (model, options) {
            this._byId[model.cid] = model;
            if (model.id != null)
                this._byId[model.id] = model;
            if (!model.collection)
                model.collection = this;
            model.on('all', this._onModelEvent, this);
        },
        _removeReference: function (model, options) {
            if (this === model.collection)
                delete model.collection;
            model.off('all', this._onModelEvent, this);
        },
        _onModelEvent: function (event, model, collection, options) {
            if ((event === 'add' || event === 'remove') && collection !== this)
                return;
            if (event === 'destroy')
                this.remove(model, options);
            if (model && event === 'change:' + model.idAttribute) {
                delete this._byId[model.previous(model.idAttribute)];
                if (model.id != null)
                    this._byId[model.id] = model;
            }
            this.trigger.apply(this, arguments);
        }
    });
    var methods = [
        'forEach',
        'each',
        'map',
        'collect',
        'reduce',
        'foldl',
        'inject',
        'reduceRight',
        'foldr',
        'find',
        'detect',
        'filter',
        'select',
        'reject',
        'every',
        'all',
        'some',
        'any',
        'include',
        'contains',
        'invoke',
        'max',
        'min',
        'toArray',
        'size',
        'first',
        'head',
        'take',
        'initial',
        'rest',
        'tail',
        'drop',
        'last',
        'without',
        'difference',
        'indexOf',
        'shuffle',
        'lastIndexOf',
        'isEmpty',
        'chain',
        'sample'
    ];
    _.each(methods, function (method) {
        Collection.prototype[method] = function () {
            var args = slice.call(arguments);
            args.unshift(this.models);
            return _[method].apply(_, args);
        };
    });
    var attributeMethods = [
        'groupBy',
        'countBy',
        'sortBy',
        'indexBy'
    ];
    _.each(attributeMethods, function (method) {
        Collection.prototype[method] = function (value, context) {
            var iterator = _.isFunction(value) ? value : function (model) {
                return model.get(value);
            };
            return _[method](this.models, iterator, context);
        };
    });
    var View = Backbone.View = function (options) {
        this.cid = _.uniqueId('view');
        this._configure(options || {});
        this._ensureElement();
        this.initialize.apply(this, arguments);
        this.delegateEvents();
    };
    var delegateEventSplitter = /^(\S+)\s*(.*)$/;
    var viewOptions = [
        'model',
        'collection',
        'el',
        'id',
        'attributes',
        'className',
        'tagName',
        'events'
    ];
    _.extend(View.prototype, Events, {
        tagName: 'div',
        $: function (selector) {
            return this.$el.find(selector);
        },
        initialize: function () {
        },
        render: function () {
            return this;
        },
        remove: function () {
            this.$el.remove();
            this.stopListening();
            return this;
        },
        setElement: function (element, delegate) {
            if (this.$el)
                this.undelegateEvents();
            this.$el = element instanceof Backbone.$ ? element : Backbone.$(element);
            this.el = this.$el[0];
            if (delegate !== false)
                this.delegateEvents();
            return this;
        },
        delegateEvents: function (events) {
            if (!(events || (events = _.result(this, 'events'))))
                return this;
            this.undelegateEvents();
            for (var key in events) {
                var method = events[key];
                if (!_.isFunction(method))
                    method = this[events[key]];
                if (!method)
                    continue;
                var match = key.match(delegateEventSplitter);
                var eventName = match[1], selector = match[2];
                method = _.bind(method, this);
                eventName += '.delegateEvents' + this.cid;
                if (selector === '') {
                    this.$el.on(eventName, method);
                } else {
                    this.$el.on(eventName, selector, method);
                }
            }
            return this;
        },
        undelegateEvents: function () {
            this.$el.off('.delegateEvents' + this.cid);
            return this;
        },
        _configure: function (options) {
            if (this.options)
                options = _.extend({}, _.result(this, 'options'), options);
            _.extend(this, _.pick(options, viewOptions));
            this.options = options;
        },
        _ensureElement: function () {
            if (!this.el) {
                var attrs = _.extend({}, _.result(this, 'attributes'));
                if (this.id)
                    attrs.id = _.result(this, 'id');
                if (this.className)
                    attrs['class'] = _.result(this, 'className');
                var $el = Backbone.$('<' + _.result(this, 'tagName') + '>').attr(attrs);
                this.setElement($el, false);
            } else {
                this.setElement(_.result(this, 'el'), false);
            }
        }
    });
    Backbone.sync = function (method, model, options) {
        var type = methodMap[method];
        _.defaults(options || (options = {}), {
            emulateHTTP: Backbone.emulateHTTP,
            emulateJSON: Backbone.emulateJSON
        });
        var params = {
            type: type,
            dataType: 'json'
        };
        if (!options.url) {
            params.url = _.result(model, 'url') || urlError();
        }
        if (options.data == null && model && (method === 'create' || method === 'update' || method === 'patch')) {
            params.contentType = 'application/json';
            params.data = JSON.stringify(options.attrs || model.toJSON(options));
        }
        if (options.emulateJSON) {
            params.contentType = 'application/x-www-form-urlencoded';
            params.data = params.data ? { model: params.data } : {};
        }
        if (options.emulateHTTP && (type === 'PUT' || type === 'DELETE' || type === 'PATCH')) {
            params.type = 'POST';
            if (options.emulateJSON)
                params.data._method = type;
            var beforeSend = options.beforeSend;
            options.beforeSend = function (xhr) {
                xhr.setRequestHeader('X-HTTP-Method-Override', type);
                if (beforeSend)
                    return beforeSend.apply(this, arguments);
            };
        }
        if (params.type !== 'GET' && !options.emulateJSON) {
            params.processData = false;
        }
        if (params.type === 'PATCH' && noXhrPatch) {
            params.xhr = function () {
                return new ActiveXObject('Microsoft.XMLHTTP');
            };
        }
        var xhr = options.xhr = Backbone.ajax(_.extend(params, options));
        model.trigger('request', model, xhr, options);
        return xhr;
    };
    var noXhrPatch = typeof window !== 'undefined' && !!window.ActiveXObject && !(window.XMLHttpRequest && new XMLHttpRequest().dispatchEvent);
    var methodMap = {
        'create': 'POST',
        'update': 'PUT',
        'patch': 'PATCH',
        'delete': 'DELETE',
        'read': 'GET'
    };
    Backbone.ajax = function () {
        return Backbone.$.ajax.apply(Backbone.$, arguments);
    };
    var Router = Backbone.Router = function (options) {
        options || (options = {});
        if (options.routes)
            this.routes = options.routes;
        this._bindRoutes();
        this.initialize.apply(this, arguments);
    };
    var optionalParam = /\((.*?)\)/g;
    var namedParam = /(\(\?)?:\w+/g;
    var splatParam = /\*\w+/g;
    var escapeRegExp = /[\-{}\[\]+?.,\\\^$|#\s]/g;
    _.extend(Router.prototype, Events, {
        initialize: function () {
        },
        route: function (route, name, callback) {
            if (!_.isRegExp(route))
                route = this._routeToRegExp(route);
            if (_.isFunction(name)) {
                callback = name;
                name = '';
            }
            if (!callback)
                callback = this[name];
            var router = this;
            Backbone.history.route(route, function (fragment) {
                var args = router._extractParameters(route, fragment);
                router.execute(callback, args);
                router.trigger.apply(router, ['route:' + name].concat(args));
                router.trigger('route', name, args);
                Backbone.history.trigger('route', router, name, args);
            });
            return this;
        },
        execute: function (callback, args) {
            if (callback)
                callback.apply(this, args);
        },
        navigate: function (fragment, options) {
            Backbone.history.navigate(fragment, options);
            return this;
        },
        _bindRoutes: function () {
            if (!this.routes)
                return;
            this.routes = _.result(this, 'routes');
            var route, routes = _.keys(this.routes);
            while ((route = routes.pop()) != null) {
                this.route(route, this.routes[route]);
            }
        },
        _routeToRegExp: function (route) {
            route = route.replace(escapeRegExp, '\\$&').replace(optionalParam, '(?:$1)?').replace(namedParam, function (match, optional) {
                return optional ? match : '([^/?]+)';
            }).replace(splatParam, '([^?]*?)');
            return new RegExp('^' + route + '(?:\\?([\\s\\S]*))?$');
        },
        _extractParameters: function (route, fragment) {
            var params = route.exec(fragment).slice(1);
            return _.map(params, function (param, i) {
                if (i === params.length - 1)
                    return param || null;
                return param ? decodeURIComponent(param) : null;
            });
        }
    });
    var History = Backbone.History = function () {
        this.handlers = [];
        _.bindAll(this, 'checkUrl');
        if (typeof window !== 'undefined') {
            this.location = window.location;
            this.history = window.history;
        }
    };
    var routeStripper = /^[#\/]|\s+$/g;
    var rootStripper = /^\/+|\/+$/g;
    var isExplorer = /msie [\w.]+/;
    var trailingSlash = /\/$/;
    var pathStripper = /#.*$/;
    History.started = false;
    _.extend(History.prototype, Events, {
        interval: 50,
        atRoot: function () {
            return this.location.pathname.replace(/[^\/]$/, '$&/') === this.root;
        },
        getHash: function (window) {
            var match = (window || this).location.href.match(/#(.*)$/);
            return match ? match[1] : '';
        },
        getFragment: function (fragment, forcePushState) {
            if (fragment == null) {
                if (this._hasPushState || !this._wantsHashChange || forcePushState) {
                    fragment = decodeURI(this.location.pathname + this.location.search);
                    var root = this.root.replace(trailingSlash, '');
                    if (!fragment.indexOf(root))
                        fragment = fragment.slice(root.length);
                } else {
                    fragment = this.getHash();
                }
            }
            return fragment.replace(routeStripper, '');
        },
        start: function (options) {
            if (History.started)
                throw new Error('Backbone.history has already been started');
            History.started = true;
            this.options = _.extend({ root: '/' }, this.options, options);
            this.root = this.options.root;
            this._wantsHashChange = this.options.hashChange !== false;
            this._wantsPushState = !!this.options.pushState;
            this._hasPushState = !!(this.options.pushState && this.history && this.history.pushState);
            var fragment = this.getFragment();
            var docMode = document.documentMode;
            var oldIE = isExplorer.exec(navigator.userAgent.toLowerCase()) && (!docMode || docMode <= 7);
            this.root = ('/' + this.root + '/').replace(rootStripper, '/');
            if (oldIE && this._wantsHashChange) {
                var frame = Backbone.$('<iframe src="javascript:0" tabindex="-1">');
                this.iframe = frame.hide().appendTo('body')[0].contentWindow;
                this.navigate(fragment);
            }
            if (this._hasPushState) {
                Backbone.$(window).on('popstate', this.checkUrl);
            } else if (this._wantsHashChange && 'onhashchange' in window && !oldIE) {
                Backbone.$(window).on('hashchange', this.checkUrl);
            } else if (this._wantsHashChange) {
                this._checkUrlInterval = setInterval(this.checkUrl, this.interval);
            }
            this.fragment = fragment;
            var loc = this.location;
            if (this._wantsHashChange && this._wantsPushState) {
                if (!this._hasPushState && !this.atRoot()) {
                    this.fragment = this.getFragment(null, true);
                    this.location.replace(this.root + '#' + this.fragment);
                    return true;
                } else if (this._hasPushState && this.atRoot() && loc.hash) {
                    this.fragment = this.getHash().replace(routeStripper, '');
                    this.history.replaceState({}, document.title, this.root + this.fragment);
                }
            }
            if (!this.options.silent)
                return this.loadUrl();
        },
        stop: function () {
            Backbone.$(window).off('popstate', this.checkUrl).off('hashchange', this.checkUrl);
            if (this._checkUrlInterval)
                clearInterval(this._checkUrlInterval);
            History.started = false;
        },
        route: function (route, callback) {
            this.handlers.unshift({
                route: route,
                callback: callback
            });
        },
        checkUrl: function (e) {
            var current = this.getFragment();
            if (current === this.fragment && this.iframe) {
                current = this.getFragment(this.getHash(this.iframe));
            }
            if (current === this.fragment)
                return false;
            if (this.iframe)
                this.navigate(current);
            this.loadUrl();
        },
        loadUrl: function (fragment) {
            fragment = this.fragment = this.getFragment(fragment);
            return _.any(this.handlers, function (handler) {
                if (handler.route.test(fragment)) {
                    handler.callback(fragment);
                    return true;
                }
            });
        },
        navigate: function (fragment, options) {
            if (!History.started)
                return false;
            if (!options || options === true)
                options = { trigger: !!options };
            var url = this.root + (fragment = this.getFragment(fragment || ''));
            fragment = fragment.replace(pathStripper, '');
            if (this.fragment === fragment)
                return;
            this.fragment = fragment;
            if (fragment === '' && url !== '/')
                url = url.slice(0, -1);
            if (this._hasPushState) {
                this.history[options.replace ? 'replaceState' : 'pushState']({}, document.title, url);
            } else if (this._wantsHashChange) {
                this._updateHash(this.location, fragment, options.replace);
                if (this.iframe && fragment !== this.getFragment(this.getHash(this.iframe))) {
                    if (!options.replace)
                        this.iframe.document.open().close();
                    this._updateHash(this.iframe.location, fragment, options.replace);
                }
            } else {
                return this.location.assign(url);
            }
            if (options.trigger)
                return this.loadUrl(fragment);
        },
        _updateHash: function (location, fragment, replace) {
            if (replace) {
                var href = location.href.replace(/(javascript:|#).*$/, '');
                location.replace(href + '#' + fragment);
            } else {
                location.hash = '#' + fragment;
            }
        }
    });
    Backbone.history = new History();
    var extend = function (protoProps, staticProps) {
        var parent = this;
        var child;
        if (protoProps && _.has(protoProps, 'constructor')) {
            child = protoProps.constructor;
        } else {
            child = function () {
                return parent.apply(this, arguments);
            };
        }
        _.extend(child, parent, staticProps);
        var Surrogate = function () {
            this.constructor = child;
        };
        Surrogate.prototype = parent.prototype;
        child.prototype = new Surrogate();
        if (protoProps)
            _.extend(child.prototype, protoProps);
        child.__super__ = parent.prototype;
        return child;
    };
    Model.extend = Collection.extend = Router.extend = View.extend = History.extend = extend;
    var urlError = function () {
        throw new Error('A "url" property or function must be specified');
    };
    var wrapError = function (model, options) {
        var error = options.error;
        options.error = function (resp) {
            if (error)
                error(model, resp, options);
            model.trigger('error', model, resp, options);
        };
    };
    return Backbone;
}));
define('String.format', function () {
    'use strict';
    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/\$\((\d+)\)/g, function (match, number) {
            return typeof args[number] !== 'undefined' ? args[number] : match;
        });
    };
});
define('Backbone.Validation', ['Backbone'], function () {
    Backbone.Validation = function (_) {
        'use strict';
        var defaultOptions = {
            forceUpdate: false,
            selector: 'name',
            labelFormatter: 'sentenceCase',
            valid: Function.prototype,
            invalid: Function.prototype
        };
        var formatFunctions = {
            formatLabel: function (attrName, model) {
                return defaultLabelFormatters[defaultOptions.labelFormatter](attrName, model);
            },
            format: function () {
                var args = Array.prototype.slice.call(arguments), text = args.shift();
                return text.replace(/\{(\d+)\}/g, function (match, number) {
                    return typeof args[number] !== 'undefined' ? args[number] : match;
                });
            }
        };
        var flatten = function (obj, into, prefix) {
            into = into || {};
            prefix = prefix || '';
            _.each(obj, function (val, key) {
                if (obj.hasOwnProperty(key)) {
                    if (val && typeof val === 'object' && !(val instanceof Array || val instanceof Date || val instanceof RegExp || val instanceof Backbone.Model || val instanceof Backbone.Collection)) {
                        flatten(val, into, prefix + key + '.');
                    } else {
                        into[prefix + key] = val;
                    }
                }
            });
            return into;
        };
        var Validation = function () {
            var getValidatedAttrs = function (model) {
                return _.reduce(_.keys(_.result(model, 'validation') || {}), function (memo, key) {
                    memo[key] = void 0;
                    return memo;
                }, {});
            };
            var getValidators = function (model, attr) {
                var attrValidationSet = model.validation ? _.result(model, 'validation')[attr] || {} : {};
                if (_.isFunction(attrValidationSet) || _.isString(attrValidationSet)) {
                    attrValidationSet = { fn: attrValidationSet };
                }
                if (!_.isArray(attrValidationSet)) {
                    attrValidationSet = [attrValidationSet];
                }
                return _.reduce(attrValidationSet, function (memo, attrValidation) {
                    _.each(_.without(_.keys(attrValidation), 'msg'), function (validator) {
                        memo.push({
                            fn: defaultValidators[validator],
                            val: attrValidation[validator],
                            msg: attrValidation.msg
                        });
                    });
                    return memo;
                }, []);
            };
            var validateAttr = function (model, attr, value, computed) {
                return _.reduce(getValidators(model, attr), function (memo, validator) {
                    var ctx = _.extend({}, formatFunctions, defaultValidators), result = validator.fn.call(ctx, value, attr, validator.val, model, computed);
                    if (result === false || memo === false) {
                        return false;
                    }
                    if (result && !memo) {
                        return _.result(validator, 'msg') || result;
                    }
                    return memo;
                }, '');
            };
            var validateModel = function (model, attrs) {
                var error, invalidAttrs = {}, isValid = true, computed = _.clone(attrs), flattened = flatten(attrs);
                _.each(flattened, function (val, attr) {
                    error = validateAttr(model, attr, val, computed);
                    if (error) {
                        invalidAttrs[attr] = error;
                        isValid = false;
                    }
                });
                return {
                    invalidAttrs: invalidAttrs,
                    isValid: isValid
                };
            };
            var mixin = function (view, options) {
                return {
                    preValidate: function (attr, value) {
                        var self = this, result = {}, error;
                        if (_.isObject(attr)) {
                            _.each(attr, function (value, key) {
                                error = self.preValidate(key, value);
                                if (error) {
                                    result[key] = error;
                                }
                            });
                            return _.isEmpty(result) ? undefined : result;
                        } else {
                            return validateAttr(this, attr, value, _.extend({}, this.attributes));
                        }
                    },
                    isValid: function (option) {
                        var flattened = flatten(this.attributes);
                        if (_.isString(option)) {
                            return !validateAttr(this, option, flattened[option], _.extend({}, this.attributes));
                        }
                        if (_.isArray(option)) {
                            return _.reduce(option, function (memo, attr) {
                                return memo && !validateAttr(this, attr, flattened[attr], _.extend({}, this.attributes));
                            }, true, this);
                        }
                        if (option === true) {
                            this.validate();
                        }
                        return this.validation ? this._isValid : true;
                    },
                    validate: function (attrs, setOptions) {
                        var model = this, validateAll = !attrs, opt = _.extend({}, options, setOptions), validatedAttrs = getValidatedAttrs(model), allAttrs = _.extend({}, validatedAttrs, model.attributes, attrs), changedAttrs = flatten(attrs || allAttrs), result = validateModel(model, allAttrs);
                        model._isValid = result.isValid;
                        _.each(validatedAttrs, function (val, attr) {
                            var invalid = result.invalidAttrs.hasOwnProperty(attr);
                            if (!invalid) {
                                opt.valid(view, attr, opt.selector);
                            }
                        });
                        _.each(validatedAttrs, function (val, attr) {
                            var invalid = result.invalidAttrs.hasOwnProperty(attr), changed = changedAttrs.hasOwnProperty(attr);
                            if (invalid && (changed || validateAll)) {
                                opt.invalid(view, attr, result.invalidAttrs[attr], opt.selector);
                            }
                        });
                        _.defer(function () {
                            model.trigger('validated', model._isValid, model, result.invalidAttrs);
                            model.trigger('validated:' + (model._isValid ? 'valid' : 'invalid'), model, result.invalidAttrs);
                        });
                        if (!opt.forceUpdate && _.intersection(_.keys(result.invalidAttrs), _.keys(changedAttrs)).length > 0) {
                            return result.invalidAttrs;
                        }
                    }
                };
            };
            var bindModel = function (view, model, options) {
                _.extend(model, mixin(view, options));
            };
            var unbindModel = function (model) {
                delete model.validate;
                delete model.preValidate;
                delete model.isValid;
            };
            var collectionAdd = function (model) {
                bindModel(this.view, model, this.options);
            };
            var collectionRemove = function (model) {
                unbindModel(model);
            };
            return {
                version: '0.9.1',
                configure: function (options) {
                    _.extend(defaultOptions, options);
                },
                bind: function (view, options) {
                    options = _.extend({}, defaultOptions, defaultCallbacks, options);
                    var model = options.model || view.model, collection = options.collection || view.collection;
                    if (typeof model === 'undefined' && typeof collection === 'undefined') {
                        throw 'Before you execute the binding your view must have a model or a collection.\n' + 'See http://thedersen.com/projects/backbone-validation/#using-form-model-validation for more information.';
                    }
                    if (model) {
                        bindModel(view, model, options);
                    } else if (collection) {
                        collection.each(function (model) {
                            bindModel(view, model, options);
                        });
                        collection.bind('add', collectionAdd, {
                            view: view,
                            options: options
                        });
                        collection.bind('remove', collectionRemove);
                    }
                },
                unbind: function (view, options) {
                    options = _.extend({}, options);
                    var model = options.model || view.model, collection = options.collection || view.collection;
                    if (model) {
                        unbindModel(model);
                    } else if (collection) {
                        collection.each(function (model) {
                            unbindModel(model);
                        });
                        collection.unbind('add', collectionAdd);
                        collection.unbind('remove', collectionRemove);
                    }
                },
                mixin: mixin(null, defaultOptions)
            };
        }();
        var defaultCallbacks = Validation.callbacks = {
            valid: function (view, attr, selector) {
                view.$('[' + selector + '~="' + attr + '"]').removeClass('invalid').removeAttr('data-error');
            },
            invalid: function (view, attr, error, selector) {
                view.$('[' + selector + '~="' + attr + '"]').addClass('invalid').attr('data-error', error);
            }
        };
        var defaultPatterns = Validation.patterns = {
            digits: /^\d+$/,
            number: /^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/,
            email: /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,
            netsuiteEmail: /^[-a-z0-9!#$%&'*+\/=?^_`{|}~]+(?:\.[-a-z0-9!#$%&'*+\/=?^_`{|}~]+)*@(?:[a-z0-9]+(?:-+[a-z0-9]+)*\.)+(?:zw|zone|zm|za|yt|yokohama|ye|yandex|yachts|xyz|xxx|xn--zfr164b|xn--ygbi2ammx|xn--yfro4i67o|xn--xkc2dl3a5ee0h|xn--xkc2al3hye2a|xn--wgbl6a|xn--wgbh1c|xn--unup4y|xn--ses554g|xn--s9brj9c|xn--rhqv96g|xn--q9jyb4c|xn--pgbs0dh|xn--p1ai|xn--ogbpf8fl|xn--o3cw4h|xn--nqv7fs00ema|xn--nqv7f|xn--ngbc5azd|xn--mgbx4cd0ab|xn--mgberp4a5d4ar|xn--mgbc0a9azcg|xn--mgbbh1a71e|xn--mgbayh7gpa|xn--mgbab2bd|xn--mgbaam7a8h|xn--mgba3a4f16a|xn--mgb9awbf|xn--lgbbat1ad8j|xn--l1acc|xn--kput3i|xn--kpry57d|xn--kprw13d|xn--j6w193g|xn--j1amh|xn--io0a7i|xn--i1b6b1a6a2e|xn--h2brj9c|xn--gecrj9c|xn--fzc2c9e2c|xn--fpcrj9c3d|xn--fiqz9s|xn--fiqs8s|xn--fiq64b|xn--fiq228c5hs|xn--d1acj3b|xn--czru2d|xn--czr694b|xn--clchc0ea0b2g2a9gcd|xn--cg4bki|xn--c1avg|xn--90a3ac|xn--80aswg|xn--80asehdb|xn--80ao21a|xn--80adxhks|xn--6qq986b3xl|xn--6frz82g|xn--55qx5d|xn--55qw42g|xn--4gbrim|xn--45brj9c|xn--3e0b707e|xn--3ds443g|xn--3bst00m|wtf|wtc|ws|works|williamhill|wiki|wien|whoswho|wf|wed|website|webcam|watch|wang|vu|voyage|voto|voting|vote|vodka|vn|vlaanderen|vision|villas|viajes|vi|vg|vet|versicherung|ventures|vegas|ve|vc|vacations|va|uz|uy|us|uno|university|uk|ug|ua|tz|tw|tv|tt|travel|training|trade|tr|tp|toys|town|top|tools|tokyo|today|to|tn|tm|tl|tk|tj|tirol|tips|tienda|th|tg|tf|tel|technology|td|tc|tax|tattoo|sz|systems|sy|sx|sv|suzuki|surgery|surf|support|supply|supplies|su|st|sr|spiegel|space|soy|solutions|solar|sohu|software|social|so|sn|sm|sl|sk|sj|singles|si|shoes|shiksha|sh|sg|sexy|services|se|sd|scot|schule|schmidt|scb|sc|sb|saarland|sa|ryukyu|rw|ruhr|ru|rs|rodeo|rocks|ro|rio|rich|reviews|rest|republican|report|repair|rentals|ren|reisen|reise|rehab|red|recipes|realtor|re|quebec|qpon|qa|py|pw|pub|pt|ps|properties|productions|pro|press|praxi|pr|post|pn|pm|plumbing|place|pl|pk|pink|pictures|pics|physio|photos|photography|photo|ph|pg|pf|pe|parts|partners|paris|pa|ovh|organic|org|onl|ong|om|okinawa|nz|nyc|nu|nrw|nra|nr|np|no|nl|ninja|ni|nhk|ngo|ng|nf|neustar|net|ne|nc|navy|name|nagoya|na|mz|my|mx|mw|mv|museum|mu|mt|ms|mr|mq|mp|motorcycles|moscow|mortgage|monash|moe|moda|mobi|mo|mn|mm|ml|mk|mini|mil|miami|mh|mg|menu|melbourne|meet|media|me|md|mc|marketing|market|mango|management|maison|ma|ly|lv|luxury|luxe|lu|lt|ls|lr|lotto|london|loans|lk|link|limo|limited|lighting|life|li|lgbt|lease|lc|lb|lawyer|land|lacaixa|la|kz|ky|kw|kred|krd|kr|kp|koeln|kn|km|kiwi|kitchen|kim|ki|kh|kg|ke|kaufen|juegos|jp|joburg|jobs|jo|jm|jetzt|je|it|is|ir|iq|io|investments|international|int|insure|institute|ink|info|industries|in|immobilien|im|il|ie|id|hu|ht|hr|house|host|horse|homes|holiday|holdings|hn|hm|hk|hiv|hiphop|healthcare|haus|hamburg|gy|gw|guru|guitars|guide|gu|gt|gs|gripe|green|gratis|graphics|gr|gq|gp|gov|gop|gn|gmo|gm|globo|global|glass|gl|gives|gift|gi|gh|gg|gf|gent|ge|gd|gb|gallery|gal|ga|futbol|furniture|fund|frogans|fr|foundation|foo|fo|fm|florist|flights|fk|fj|fitness|fishing|fish|financial|finance|fi|feedback|farm|fail|exposed|expert|exchange|events|eus|eu|et|estate|es|er|equipment|enterprises|engineering|engineer|email|eg|ee|education|edu|ec|dz|durban|domains|do|dnp|dm|dk|dj|discount|directory|direct|digital|diamonds|desi|dentist|dental|democrat|degree|deals|de|dating|dance|cz|cy|cx|cw|cv|cuisinella|cu|cruises|creditcard|credit|cr|country|corp|coop|cool|cooking|contractors|consulting|construction|condos|computer|company|community|com|cologne|college|coffee|codes|co|cn|cm|club|clothing|clinic|cleaning|claims|cl|ck|city|citic|ci|church|christmas|cheap|ch|cg|cf|ceo|center|cd|cc|catering|cat|cash|careers|career|care|cards|capital|capetown|cancerresearch|camp|camera|cab|ca|bzh|bz|by|bw|bv|buzz|builders|build|bt|bs|brussels|br|boutique|bo|bn|bmw|bm|blue|blackfriday|black|bj|biz|bio|bike|bid|bi|bh|bg|bf|best|berlin|beer|be|bd|bb|bayern|bargains|bar|ba|az|axa|ax|aw|autos|audio|auction|au|attorney|at|associates|asia|as|arpa|army|archi|ar|aq|ao|an|am|al|airforce|ai|agency|ag|af|aero|ae|ad|actor|active|accountants|academy|ac)$/i,
            url: /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i
        };
        var defaultMessages = Validation.messages = {
            required: '{0} is required',
            acceptance: '{0} must be accepted',
            min: '{0} must be greater than or equal to {1}',
            max: '{0} must be less than or equal to {1}',
            range: '{0} must be between {1} and {2}',
            length: '{0} must be {1} characters',
            minLength: '{0} must be at least {1} characters',
            maxLength: '{0} must be at most {1} characters',
            rangeLength: '{0} must be between {1} and {2} characters',
            oneOf: '{0} must be one of: {1}',
            equalTo: '{0} must be the same as {1}',
            digits: '{0} must only contain digits',
            number: '{0} must be a number',
            email: '{0} must be a valid email',
            url: '{0} must be a valid url',
            inlinePattern: '{0} is invalid'
        };
        var defaultLabelFormatters = Validation.labelFormatters = {
            none: function (attrName) {
                return attrName;
            },
            sentenceCase: function (attrName) {
                return attrName.replace(/(?:^\w|[A-Z]|\b\w)/g, function (match, index) {
                    return index === 0 ? match.toUpperCase() : ' ' + match.toLowerCase();
                }).replace(/_/g, ' ');
            },
            label: function (attrName, model) {
                return model.labels && model.labels[attrName] || defaultLabelFormatters.sentenceCase(attrName, model);
            }
        };
        var defaultValidators = Validation.validators = function () {
            var trim = String.prototype.trim ? function (text) {
                return text === null ? '' : String.prototype.trim.call(text);
            } : function (text) {
                var trimLeft = /^\s+/, trimRight = /\s+$/;
                return text === null ? '' : text.toString().replace(trimLeft, '').replace(trimRight, '');
            };
            var isNumber = function (value) {
                return _.isNumber(value) || _.isString(value) && value.match(defaultPatterns.number);
            };
            var hasValue = function (value) {
                return !(_.isNull(value) || _.isUndefined(value) || _.isString(value) && trim(value) === '' || _.isArray(value) && _.isEmpty(value));
            };
            return {
                fn: function (value, attr, fn, model, computed) {
                    if (_.isString(fn)) {
                        fn = model[fn];
                    }
                    return fn.call(model, value, attr, computed);
                },
                required: function (value, attr, required, model, computed) {
                    var isRequired = _.isFunction(required) ? required.call(model, value, attr, computed) : required;
                    if (!isRequired && !hasValue(value)) {
                        return false;
                    }
                    if (isRequired && !hasValue(value)) {
                        return this.format(defaultMessages.required, this.formatLabel(attr, model));
                    }
                },
                acceptance: function (value, attr, accept, model) {
                    if (value !== 'true' && (!_.isBoolean(value) || value === false)) {
                        return this.format(defaultMessages.acceptance, this.formatLabel(attr, model));
                    }
                },
                min: function (value, attr, minValue, model) {
                    if (!isNumber(value) || value < minValue) {
                        return this.format(defaultMessages.min, this.formatLabel(attr, model), minValue);
                    }
                },
                max: function (value, attr, maxValue, model) {
                    if (!isNumber(value) || value > maxValue) {
                        return this.format(defaultMessages.max, this.formatLabel(attr, model), maxValue);
                    }
                },
                range: function (value, attr, range, model) {
                    if (!isNumber(value) || value < range[0] || value > range[1]) {
                        return this.format(defaultMessages.range, this.formatLabel(attr, model), range[0], range[1]);
                    }
                },
                length: function (value, attr, length, model) {
                    if (!_.isString(value) || value.length !== length) {
                        return this.format(defaultMessages.length, this.formatLabel(attr, model), length);
                    }
                },
                minLength: function (value, attr, minLength, model) {
                    if (!_.isString(value) || value.length < minLength) {
                        return this.format(defaultMessages.minLength, this.formatLabel(attr, model), minLength);
                    }
                },
                maxLength: function (value, attr, maxLength, model) {
                    if (!_.isString(value) || value.length > maxLength) {
                        return this.format(defaultMessages.maxLength, this.formatLabel(attr, model), maxLength);
                    }
                },
                rangeLength: function (value, attr, range, model) {
                    if (!_.isString(value) || value.length < range[0] || value.length > range[1]) {
                        return this.format(defaultMessages.rangeLength, this.formatLabel(attr, model), range[0], range[1]);
                    }
                },
                oneOf: function (value, attr, values, model) {
                    if (!_.include(values, value)) {
                        return this.format(defaultMessages.oneOf, this.formatLabel(attr, model), values.join(', '));
                    }
                },
                equalTo: function (value, attr, equalTo, model, computed) {
                    if (value !== computed[equalTo]) {
                        return this.format(defaultMessages.equalTo, this.formatLabel(attr, model), this.formatLabel(equalTo, model));
                    }
                },
                pattern: function (value, attr, pattern, model) {
                    if (!hasValue(value) || !value.toString().match(defaultPatterns[pattern] || pattern)) {
                        return this.format(defaultMessages[pattern] || defaultMessages.inlinePattern, this.formatLabel(attr, model), pattern);
                    }
                }
            };
        }();
        _.each(defaultValidators, function (validator, key) {
            defaultValidators[key] = _.bind(defaultValidators[key], _.extend({}, formatFunctions, defaultValidators));
        });
        return Validation;
    }(_);
    return;
});
define('Utils', [
    'jQuery',
    'underscore',
    'Backbone',
    'String.format',
    'Backbone.Validation'
], function (jQuery, _, Backbone) {
    'use strict';
    function deepCopy(obj) {
        if (_.isFunction(obj)) {
            return null;
        }
        var copy = {};
        if (obj instanceof Backbone.Model) {
            obj = obj.attributes || {};
        } else if (obj instanceof Backbone.Collection) {
            obj = obj.models || [];
        }
        if (_.isArray(obj)) {
            copy = [];
            _.each(obj, function (value) {
                !_.isFunction(value) && copy.push(_.deepCopy(value));
            });
        } else if (_.isObject(obj)) {
            _.each(obj, function (value, attr) {
                if (!_.isFunction(value) && attr.indexOf('_') !== 0) {
                    copy[attr] = _.deepCopy(value);
                }
            });
        } else {
            copy = obj;
        }
        return copy;
    }
    var trim = jQuery.trim;
    function formatPhone(phone, format) {
        var extentionSearch = phone.search(/[A-Za-z#]/), extention = ~extentionSearch ? ' ' + phone.substring(extentionSearch) : '', phoneNumber = ~extentionSearch ? ' ' + phone.substring(0, extentionSearch) : phone;
        format = format || SC.ENVIRONMENT.siteSettings.phoneformat;
        if (/^[0-9()-.\s]+$/.test(phoneNumber) && format) {
            var format_tokens = {}, phoneDigits = phoneNumber.replace(/[()-.\s]/g, '');
            switch (format) {
            case '(123) 456-7890':
                format_tokens = {
                    c: ' ',
                    ab: '(',
                    aa: ') ',
                    d: '-'
                };
                break;
            case '123 456 7890':
                format_tokens = {
                    c: ' ',
                    ab: '',
                    aa: ' ',
                    d: ' '
                };
                break;
            case '123-456-7890':
                format_tokens = {
                    c: ' ',
                    ab: '',
                    aa: '-',
                    d: '-'
                };
                break;
            case '123.456.7890':
                format_tokens = {
                    c: ' ',
                    ab: '',
                    aa: '.',
                    d: '.'
                };
                break;
            default:
                return phone;
            }
            switch (phoneDigits.length) {
            case 7:
                return phoneDigits.substring(0, 3) + format_tokens.d + phoneDigits.substring(3) + extention;
            case 10:
                return format_tokens.ab + phoneDigits.substring(0, 3) + format_tokens.aa + phoneDigits.substring(3, 6) + format_tokens.d + phoneDigits.substring(6) + extention;
            case 11:
                return phoneDigits.substring(0, 1) + format_tokens.c + format_tokens.ab + phoneDigits.substring(1, 4) + format_tokens.aa + phoneDigits.substring(4, 7) + format_tokens.d + phoneDigits.substring(7) + extention;
            default:
                return phone;
            }
        }
        return phone;
    }
    function dateToString(date) {
        var month = '' + (date.getMonth() + 1), day = '' + date.getDate();
        if (month.length === 1) {
            month = '0' + month;
        }
        if (day.length === 1) {
            day = '0' + day;
        }
        return date.getFullYear() + '-' + month + '-' + day;
    }
    function stringToDate(str_date, options) {
        options = _.extend({
            format: 'YYYY-MM-dd',
            plusMonth: -1,
            dateSplitCharacter: '-'
        }, options || {});
        var date_parts = str_date ? str_date.split(options.dateSplitCharacter) : [], format_parts = options.format ? options.format.split('-') : [], year_index = _.indexOf(format_parts, 'YYYY') >= 0 ? _.indexOf(format_parts, 'YYYY') : 2, month_index = _.indexOf(format_parts, 'MM') >= 0 ? _.indexOf(format_parts, 'MM') : 1, day_index = _.indexOf(format_parts, 'dd') >= 0 ? _.indexOf(format_parts, 'dd') : 0, year = parseInt(date_parts[year_index], 10), month = parseInt(date_parts[month_index], 10) + (options.plusMonth || 0), day = parseInt(date_parts[day_index], 10), result = new Date(year, month, day);
        if (!(result.getMonth() !== month || day !== result.getDate() || result.getFullYear() !== year)) {
            return result;
        }
    }
    function isDateValid(date) {
        if (Object.prototype.toString.call(date) === '[object Date]') {
            if (isNaN(date.getTime())) {
                return false;
            } else {
                var dtDay = date.getDate(), dtMonth = date.getMonth() + 1, dtYear = date.getFullYear(), pattern = /^\d{4}$/;
                if (!pattern.test(dtYear)) {
                    return false;
                } else if (dtMonth < 1 || dtMonth > 12) {
                    return false;
                } else if (dtDay < 1 || dtDay > 31) {
                    return false;
                } else if ((dtMonth === 4 || dtMonth === 6 || dtMonth === 9 || dtMonth === 11) && dtDay === 31) {
                    return false;
                } else if (dtMonth === 2) {
                    var isleap = dtYear % 4 === 0 && (dtYear % 100 !== 0 || dtYear % 400 === 0);
                    if (dtDay > 29 || dtDay === 29 && !isleap) {
                        return false;
                    }
                }
                return true;
            }
        } else {
            return false;
        }
    }
    function validateSecurityCode(value) {
        var ccsn = trim(value);
        if (!ccsn) {
            return _('Security Number is required').translate();
        }
        if (!(Backbone.Validation.patterns.number.test(ccsn) && (ccsn.length === 3 || ccsn.length === 4))) {
            return _('Security Number is invalid').translate();
        }
    }
    function validatePhone(phone) {
        var minLength = 7;
        if (_.isNumber(phone)) {
            if (phone < Math.pow(10, minLength - 1)) {
                return _('Phone Number is invalid').translate();
            }
        } else if (phone) {
            var value = phone.replace(/[()-.\s]/g, '');
            while (value.length && value.substring(0, 1) === '0') {
                value = value.substring(1, value.length);
            }
            if (parseInt(value, 10).toString() !== value || value.length < minLength) {
                return _('Phone Number is invalid').translate();
            }
        } else {
            return _('Phone is required').translate();
        }
    }
    function validateState(value, valName, form) {
        var countries = SC.ENVIRONMENT.siteSettings.countries || {};
        if (countries[form.country] && countries[form.country].states && value === '') {
            return _('State is required').translate();
        }
    }
    function validateZipCode(value, valName, form) {
        var countries = SC.ENVIRONMENT.siteSettings.countries || {};
        value = trim(value);
        if (!value && (!form.country || countries[form.country] && countries[form.country].isziprequired === 'T')) {
            return _('Zip Code is required').translate();
        }
    }
    function translate(text) {
        if (!text) {
            return '';
        }
        text = text.toString();
        var args = Array.prototype.slice.call(arguments), parameters, result = SC.Translations && SC.Translations[text] ? SC.Translations[text] : text;
        if (args.length && result) {
            if (_.isArray(args[1]) && args[1].length) {
                parameters = args[1];
            } else {
                parameters = _.map(args.slice(1), function (param) {
                    return _.escape(param);
                });
            }
            result = result.format.apply(result, parameters);
        }
        return result;
    }
    function getFullPathForElement(el) {
        var names = [], c, e;
        while (el.parentNode) {
            if (el.id) {
                names.unshift('#' + el.id);
                break;
            } else if (el === document.body) {
                names.unshift('HTML > BODY');
                break;
            } else if (el === (document.head || document.getElementsByTagName('head')[0])) {
                names.unshift('HTML > HEAD');
                break;
            } else if (el === el.ownerDocument.documentElement) {
                names.unshift(el.tagName);
                break;
            } else {
                e = el;
                for (c = 1; e.previousElementSibling; c++) {
                    e = e.previousElementSibling;
                }
                names.unshift(el.tagName + ':nth-child(' + c + ')');
                el = el.parentNode;
            }
        }
        return names.join(' > ');
    }
    function formatCurrency(value, symbol) {
        var value_float = parseFloat(value), negative = value_float < 0, groupseparator = ',', decimalseparator = '.', negativeprefix = '(', negativesuffix = ')', thousand_string = '', beforeValue = true, sessionInfo = SC.getSessionInfo && SC.getSessionInfo('currentCurrency');
        if (isNaN(value_float)) {
            return value;
        }
        value_float = parseInt((Math.abs(value_float) + 0.005) * 100, 10) / 100;
        var value_string = value_float.toString(), settings = SC && SC.ENVIRONMENT && SC.ENVIRONMENT.siteSettings ? SC.ENVIRONMENT.siteSettings : {};
        if (Object.prototype.hasOwnProperty.call(window, 'groupseparator')) {
            groupseparator = window.groupseparator;
        } else if (Object.prototype.hasOwnProperty.call(settings, 'groupseparator')) {
            groupseparator = settings.groupseparator;
        }
        if (Object.prototype.hasOwnProperty.call(window, 'decimalseparator')) {
            decimalseparator = window.decimalseparator;
        } else if (Object.prototype.hasOwnProperty.call(settings, 'decimalseparator')) {
            decimalseparator = settings.decimalseparator;
        }
        if (Object.prototype.hasOwnProperty.call(window, 'negativeprefix')) {
            negativeprefix = window.negativeprefix;
        } else if (Object.prototype.hasOwnProperty.call(settings, 'negativeprefix')) {
            negativeprefix = settings.negativeprefix;
        }
        if (Object.prototype.hasOwnProperty.call(window, 'negativesuffix')) {
            negativesuffix = window.negativesuffix;
        } else if (Object.prototype.hasOwnProperty.call(settings, 'negativesuffix')) {
            negativesuffix = settings.negativesuffix;
        }
        value_string = value_string.replace('.', decimalseparator);
        var decimal_position = value_string.indexOf(decimalseparator);
        if (!~decimal_position) {
            value_string += decimalseparator + '00';
            decimal_position = value_string.indexOf(decimalseparator);
        } else if (value_string.indexOf(decimalseparator) === value_string.length - 2) {
            value_string += '0';
        }
        for (var i = value_string.length - 1; i >= 0; i--) {
            thousand_string = (i > 0 && i < decimal_position && (decimal_position - i) % 3 === 0 ? groupseparator : '') + value_string[i] + thousand_string;
        }
        if (!symbol) {
            if (typeof session !== 'undefined' && session.getShopperCurrency) {
                beforeValue = session.getShopperCurrency().beforeValue;
                symbol = session.getShopperCurrency().symbol;
            } else if (settings.shopperCurrency) {
                beforeValue = settings.shopperCurrency.beforeValue;
                symbol = settings.shopperCurrency.symbol;
            } else if (sessionInfo) {
                beforeValue = sessionInfo.beforeValue;
                symbol = sessionInfo.symbol;
            }
            if (!symbol) {
                symbol = '$';
            }
        }
        value_string = beforeValue || _.isUndefined(beforeValue) ? symbol + thousand_string : thousand_string + symbol;
        return negative ? negativeprefix + value_string + negativesuffix : value_string;
    }
    function formatQuantity(number) {
        var result = [], parts = ('' + number).split('.'), integerPart = parts[0].split('').reverse();
        for (var i = 0; i < integerPart.length; i++) {
            if (i > 0 && i % 3 === 0 && integerPart[i] !== '-') {
                result.unshift(',');
            }
            result.unshift(integerPart[i]);
        }
        if (parts.length > 1) {
            result.push('.');
            result.push(parts[1]);
        }
        return result.join('');
    }
    function highlightKeyword(text, keyword) {
        text = text || '';
        text = _.escape(text);
        if (!keyword) {
            return text;
        }
        keyword = trim(keyword).replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&');
        return text.replace(new RegExp('(' + keyword + ')', 'ig'), function ($1, match) {
            return '<strong>' + match + '</strong>';
        });
    }
    function collectionToString(options) {
        var temp = [];
        _.each(options.collection, function (item) {
            temp.push(options.getValue(item));
        });
        return temp.join(options.joinWith);
    }
    function addParamsToUrl(baseUrl, params, avoidDoubleRedirect) {
        if (avoidDoubleRedirect) {
            var new_params = {};
            _.each(params, function (param_value, param_key) {
                new_params['__' + param_key] = param_value;
            });
            params = new_params;
        }
        if (baseUrl && !_.isEmpty(params)) {
            var paramString = jQuery.param(params), join_string = ~baseUrl.indexOf('?') ? '&' : '?';
            return baseUrl + join_string + paramString;
        }
        return baseUrl;
    }
    function parseUrlOptions(options_string) {
        options_string = options_string || '';
        if (~options_string.indexOf('?')) {
            options_string = _.last(options_string.split('?'));
        }
        if (~options_string.indexOf('#')) {
            options_string = _.first(options_string.split('#'));
        }
        var options = {};
        if (options_string.length > 0) {
            var tokens = options_string.split(/\&/g), current_token;
            while (tokens.length > 0) {
                current_token = tokens.shift().split(/\=/g);
                if (current_token[0].length === 0) {
                    continue;
                }
                options[current_token[0]] = decodeURIComponent(current_token[1]);
            }
        }
        return options;
    }
    function hyphenate(string) {
        return string.replace(/[\W]/g, '-');
    }
    var objectToAtrributesKeyMap = [
        'href',
        'id',
        'title',
        'data',
        'data-hashtag',
        'data-touchpoint',
        'data-permissions'
    ];
    function objectToAtrributes(obj, prefix) {
        prefix = prefix || '';
        return _.reduce(obj, function (memo, value, key) {
            var prefixKey = prefix + key;
            if (_.contains(objectToAtrributesKeyMap, prefixKey) === false) {
                return memo;
            }
            if (_.isObject(value)) {
                return memo + objectToAtrributes(obj[key], key + '-');
            } else if (_.isArray(value) === true) {
                return memo + ' ' + _.escape(prefixKey) + '="' + _.escape(value.join(' ')) + '"';
            } else {
                return memo + ' ' + _.escape(prefixKey) + '="' + _.escape(value) + '"';
            }
        }, '');
    }
    function isTargetActionable(event) {
        var target = jQuery(event.target), targetTagName = target.prop('tagName').toLowerCase(), targetParentTagName = target.parent().prop('tagName').toLowerCase(), isCheckbox = target.prop('type') === 'checkbox';
        return targetTagName === 'a' || targetParentTagName === 'a' || targetTagName === 'i' || targetParentTagName === 'button' || targetTagName === 'button' || targetTagName === 'input' && isCheckbox === false;
    }
    function resizeImage(sizes, url, size) {
        var resize = _.where(sizes, { name: size })[0];
        url = url || '';
        if (!!resize) {
            return url + (~url.indexOf('?') ? '&' : '?') + resize.urlsuffix;
        }
        return url;
    }
    function getThemeAbsoluteUrlOfNonManagedResources(default_value, file) {
        if (!file) {
            file = '';
            if (SC.ENVIRONMENT.isExtended) {
                file = SC.ENVIRONMENT.themeAssetsPath || '';
            } else if (SC.ENVIRONMENT.BuildTimeInf && SC.ENVIRONMENT.BuildTimeInf.isSCLite) {
                if (SC.CONFIGURATION.unmanagedResourcesFolderName) {
                    file = 'site/' + SC.CONFIGURATION.unmanagedResourcesFolderName + '/';
                } else {
                    file = 'default/';
                }
            }
            file += default_value;
        }
        var absoulute_path = getAbsoluteUrl('');
        return file.indexOf(absoulute_path) !== 0 ? getAbsoluteUrl(file) : file;
    }
    function getAbsoluteUrl(file) {
        var base_url = SC && SC.ENVIRONMENT && SC.ENVIRONMENT.baseUrl || '', fileReplace = file ? file : '';
        return base_url ? base_url.replace('{{file}}', fileReplace) : file;
    }
    function getAbsoluteUrlOfNonManagedResources(file) {
        return getAbsoluteUrl(file);
    }
    function getDownloadPdfUrl(params) {
        params = params || {};
        params.n = SC && SC.ENVIRONMENT && SC.ENVIRONMENT.siteSettings && SC.ENVIRONMENT.siteSettings.siteid || '';
        if (_.isSingleDomain()) {
            return _.addParamsToUrl(_.getAbsoluteUrl('download.ssp'), params);
        } else {
            var origin = window.location.origin ? window.location.origin : window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
            return _.addParamsToUrl(origin + _.getAbsoluteUrl('download.ssp'), params);
        }
    }
    function getWindow() {
        return window;
    }
    function doPost(url) {
        var form = jQuery('<form id="do-post" method="POST" action="' + url + '"></form>').hide();
        var do_post = jQuery('#do-post');
        if (do_post && do_post[0]) {
            do_post[0].action = url;
            do_post[0].method = 'POST';
        } else {
            jQuery('html').append(form);
            do_post = jQuery('#do-post');
        }
        do_post[0].submit();
    }
    function getPathFromObject(object, path, default_value) {
        if (!path) {
            return object;
        } else if (object) {
            var tokens = path.split('.'), prev = object, n = 0;
            while (!_.isUndefined(prev) && n < tokens.length) {
                prev = prev[tokens[n++]];
            }
            if (!_.isUndefined(prev)) {
                return prev;
            }
        }
        return default_value;
    }
    function setPathFromObject(object, path, value) {
        if (!path) {
            return;
        } else if (!object) {
            return;
        }
        var tokens = path.split('.'), prev = object;
        for (var token_idx = 0; token_idx < tokens.length - 1; ++token_idx) {
            var current_token = tokens[token_idx];
            if (_.isUndefined(prev[current_token])) {
                prev[current_token] = {};
            }
            prev = prev[current_token];
        }
        prev[_.last(tokens)] = value;
    }
    function ellipsis(selector) {
        if (!jQuery(selector).data('ellipsis')) {
            var values = [
                    '',
                    '.',
                    '..',
                    '...',
                    '..',
                    '.'
                ], count = 0, timer = null, element = jQuery(selector);
            element.data('ellipsis', true);
            element.css('visibility', 'hidden');
            element.html('...');
            element.css('width', element.css('width'));
            element.css('display', 'inline-block');
            element.html('');
            element.css('visibility', 'visible');
            timer = setInterval(function () {
                if (jQuery(selector).length) {
                    element.html(values[count % values.length]);
                    count++;
                } else {
                    clearInterval(timer);
                    element = null;
                }
            }, 250);
        }
    }
    function reorderUrlParams(url) {
        var params = [], url_array = url.split('?');
        if (url_array.length > 1) {
            params = url_array[1].split('&');
            return url_array[0] + '?' + params.sort().join('&');
        }
        return url_array[0];
    }
    function isShoppingDomain() {
        return SC.ENVIRONMENT.siteSettings.shoppingSupported;
    }
    function isCheckoutDomain() {
        return SC.ENVIRONMENT.siteSettings.checkoutSupported;
    }
    function isSingleDomain() {
        return SC.ENVIRONMENT.siteSettings.isSingleDomain;
    }
    function isInShopping() {
        return _.isShoppingDomain() && (SC.ENVIRONMENT.SCTouchpoint === 'shopping' || SC.ENVIRONMENT.siteSettings.sitetype === 'STANDARD');
    }
    function isInCheckout() {
        return !_.isSingleDomain() ? _.isCheckoutDomain() : _.isCheckoutDomain() && (SC.ENVIRONMENT.SCTouchpoint === 'checkout' || SC.ENVIRONMENT.SCTouchpoint === 'myaccount');
    }
    function getSessionParams(url) {
        var params = {}, ck = getParameterByName(url, 'ck'), cktime = getParameterByName(url, 'cktime');
        if (ck && cktime) {
            params.ck = ck;
            params.cktime = cktime;
        }
        return params;
    }
    function getParameterByName(url, param_name) {
        param_name = param_name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + param_name + '=([^&#]*)'), results = regex.exec(url);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    function isPageGenerator() {
        return _.result(SC, 'isPageGenerator') || _.result(SC, 'isPageGenerator');
    }
    var SCRIPT_REGEX = /<\s*script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;
    function removeScripts(text) {
        if (isPageGenerator() && text) {
            text = text.replace(/(<!--[\s\S]*?-->)/g, ' $1 ');
            while (SCRIPT_REGEX.test(text)) {
                text = text.replace(SCRIPT_REGEX, '');
            }
        }
        return text || '';
    }
    function minifyMarkup(text) {
        return text.replace(/\>\s+</g, '><').replace(/<!--[\s\S]*?-->/g, '').replace(/\s+/g, ' ');
    }
    function oldIE(version) {
        var ie_version = version || 7;
        var isExplorer = /msie [\w.]+/, docMode = document.documentMode;
        return isExplorer.exec(navigator.userAgent.toLowerCase()) && (!docMode || docMode <= ie_version);
    }
    var requireModules;
    if (_.isFunction(window.require)) {
        requireModules = window.require;
    } else if (window.SCM) {
        requireModules = function (moduleName) {
            return window.SCM[moduleName];
        };
    } else {
        requireModules = function () {
            console.error('Impossible to retrieve dependencies');
        };
    }
    var viewport_width = 0, viewport_height = 0;
    function resetViewportWidth() {
        viewport_width = 0;
    }
    function getViewportWidth() {
        return viewport_width || (viewport_width = jQuery(window).width());
    }
    function getViewportHeight() {
        return viewport_height || (viewport_height = jQuery(window).height());
    }
    function selectByViewportWidth(options, defaultValue) {
        var device = getDeviceType();
        return options[device] || defaultValue;
    }
    function getDeviceType(widthToCheck) {
        var width = widthToCheck ? widthToCheck : Utils.getViewportWidth();
        if (width < 768) {
            return 'phone';
        } else if (width < 992) {
            return 'tablet';
        } else {
            return 'desktop';
        }
    }
    function isPhoneDevice() {
        return getDeviceType() === 'phone';
    }
    function isTabletDevice() {
        return getDeviceType() === 'tablet';
    }
    function isDesktopDevice() {
        return getDeviceType() === 'desktop';
    }
    function isNativeDatePickerSupported() {
        var input = document.createElement('input');
        input.setAttribute('type', 'date');
        return input.type !== 'text';
    }
    function initBxSlider($element, options) {
        if ($element.bxSlider && !oldIE() && !SC.isPageGenerator()) {
            $element.bxSlider(options);
        }
        return $element;
    }
    function countItems(lines) {
        var item_count = 0;
        _.each(lines.models ? lines.models : lines, function (line) {
            item_count += line.get('quantity');
        });
        return item_count;
    }
    function getExponentialDelay(options) {
        var settings = options.settings || {
            base: 1.5,
            y: 0.8,
            retries: 2
        };
        return (Math.pow(settings.base, options.x) - settings.y) * 1000;
    }
    function imageFlatten(images) {
        if ('url' in images && 'altimagetext' in images) {
            return [images];
        }
        return _.flatten(_.map(images, function (item) {
            if (_.isArray(item)) {
                return item;
            }
            return imageFlatten(item);
        }));
    }
    var Utils = SC.Utils = {
        translate: translate,
        formatPhone: formatPhone,
        dateToString: dateToString,
        isDateValid: isDateValid,
        stringToDate: stringToDate,
        validatePhone: validatePhone,
        trim: trim,
        validateState: validateState,
        validateZipCode: validateZipCode,
        validateSecurityCode: validateSecurityCode,
        formatCurrency: formatCurrency,
        formatQuantity: formatQuantity,
        highlightKeyword: highlightKeyword,
        getFullPathForElement: getFullPathForElement,
        collectionToString: collectionToString,
        countItems: countItems,
        addParamsToUrl: addParamsToUrl,
        parseUrlOptions: parseUrlOptions,
        objectToAtrributes: objectToAtrributes,
        isTargetActionable: isTargetActionable,
        resizeImage: resizeImage,
        hyphenate: hyphenate,
        getAbsoluteUrl: getAbsoluteUrl,
        getAbsoluteUrlOfNonManagedResources: getAbsoluteUrlOfNonManagedResources,
        getThemeAbsoluteUrlOfNonManagedResources: getThemeAbsoluteUrlOfNonManagedResources,
        getWindow: getWindow,
        getDownloadPdfUrl: getDownloadPdfUrl,
        doPost: doPost,
        getPathFromObject: getPathFromObject,
        setPathFromObject: setPathFromObject,
        ellipsis: ellipsis,
        reorderUrlParams: reorderUrlParams,
        getSessionParams: getSessionParams,
        getParameterByName: getParameterByName,
        isPageGenerator: isPageGenerator,
        removeScripts: removeScripts,
        minifyMarkup: minifyMarkup,
        oldIE: oldIE,
        requireModules: requireModules,
        getViewportWidth: getViewportWidth,
        getViewportHeight: getViewportHeight,
        isPhoneDevice: isPhoneDevice,
        isTabletDevice: isTabletDevice,
        isDesktopDevice: isDesktopDevice,
        isNativeDatePickerSupported: isNativeDatePickerSupported,
        selectByViewportWidth: selectByViewportWidth,
        isShoppingDomain: isShoppingDomain,
        isCheckoutDomain: isCheckoutDomain,
        isSingleDomain: isSingleDomain,
        isInShopping: isInShopping,
        isInCheckout: isInCheckout,
        resetViewportWidth: resetViewportWidth,
        getDeviceType: getDeviceType,
        initBxSlider: initBxSlider,
        getExponentialDelay: getExponentialDelay,
        imageFlatten: imageFlatten,
        deepCopy: deepCopy
    };
    _.mixin(Utils);
    return Utils;
});
define('SC.Configuration', [
    'product_views_option_radio.tpl',
    'product_views_option_tile.tpl',
    'product_views_option_text.tpl',
    'product_views_option_color.tpl',
    'product_views_option_dropdown.tpl',
    'product_views_option_facets_color.tpl',
    'product_views_option_facets_tile.tpl',
    'transaction_line_views_selected_option.tpl',
    'transaction_line_views_selected_option_color.tpl',
    'underscore',
    'jQuery',
    'Utils'
], function (product_views_option_radio_tpl, product_views_option_tile_tpl, product_views_option_text_tpl, product_views_option_color_tpl, product_views_option_dropdown_tpl, product_views_option_facets_color_tpl, product_views_option_facets_tile_tpl, transaction_line_views_selected_option_tpl, transaction_line_views_selected_option_color_tpl, _, jQuery, Utils) {
    'use strict';
    var baseConfiguration = SC.CONFIGURATION || {};
    baseConfiguration.ItemOptions = baseConfiguration.ItemOptions || {};
    baseConfiguration.ItemOptions.defaultTemplates = baseConfiguration.ItemOptions.defaultTemplates || {
        selectorByType: {
            select: product_views_option_tile_tpl,
            'default': product_views_option_text_tpl
        },
        selectedByType: { 'default': transaction_line_views_selected_option_tpl },
        facetCellByType: { 'default': product_views_option_facets_color_tpl }
    };
    var item_option_templates = {
        'transaction_line_views_selected_option_color.tpl': transaction_line_views_selected_option_color_tpl,
        'transaction_line_views_selected_option.tpl': transaction_line_views_selected_option_tpl,
        'product_views_option_color.tpl': product_views_option_color_tpl,
        'product_views_option_dropdown.tpl': product_views_option_dropdown_tpl,
        'product_views_option_radio.tpl': product_views_option_radio_tpl,
        'product_views_option_text.tpl': product_views_option_text_tpl,
        'product_views_option_tile.tpl': product_views_option_tile_tpl,
        'product_views_option_facets_color.tpl': product_views_option_facets_color_tpl,
        'product_views_option_facets_tile.tpl': product_views_option_facets_tile_tpl
    };
    _.each(baseConfiguration.ItemOptions.optionsConfiguration || [], function (item_option) {
        if (item_option.templateSelected && item_option_templates[item_option.templateSelected]) {
            item_option.templates = item_option.templates || {};
            item_option.templates.selected = item_option_templates[item_option.templateSelected];
        }
        if (item_option.templateSelector && item_option_templates[item_option.templateSelector]) {
            item_option.templates = item_option.templates || {};
            item_option.templates.selector = item_option_templates[item_option.templateSelector];
        }
        if (item_option.templateFacetCell && item_option_templates[item_option.templateFacetCell]) {
            item_option.templates = item_option.templates || {};
            item_option.templates.facetCell = item_option_templates[item_option.templateFacetCell];
        }
    });
    var Configuration = {
        searchPrefs: {
            keywordsFormatter: function (keywords) {
                if (keywords === '||') {
                    return '';
                }
                var anyLocationRegex = /[\(\)\[\]\{\~\}\!\"\:\/]{1}/g, beginingRegex = /^[\*\-\+]{1}/g, replaceWith = '';
                return keywords.replace(anyLocationRegex, replaceWith).replace(beginingRegex, replaceWith);
            }
        },
        bxSliderDefaults: {
            minSlides: 2,
            slideWidth: 228,
            maxSlides: 5,
            forceStart: true,
            pager: false,
            touchEnabled: true,
            nextText: '<a class="item-relations-related-carousel-next"><span class="control-text">' + _('next').translate() + '</span> <i class="carousel-next-arrow"></i></a>',
            prevText: '<a class="item-relations-related-carousel-prev"><i class="carousel-prev-arrow"></i> <span class="control-text">' + _('prev').translate() + '</span></a>',
            controls: true,
            preloadImages: 'all'
        },
        siteSettings: SC && SC.ENVIRONMENT && SC.ENVIRONMENT.siteSettings || {},
        get: function (path, defaultValue) {
            return _.getPathFromObject(this, path, defaultValue);
        },
        getRegistrationType: function () {
            if (Configuration.get('siteSettings.registration.registrationmandatory') === 'T') {
                return 'disabled';
            } else {
                if (Configuration.get('siteSettings.registration.registrationoptional') === 'T') {
                    return 'optional';
                } else {
                    if (Configuration.get('siteSettings.registration.registrationallowed') === 'T') {
                        return 'required';
                    } else {
                        return 'existing';
                    }
                }
            }
        }
    };
    jQuery.extend(true, baseConfiguration, Configuration);
    var imageSizeMapping = {};
    _.each(baseConfiguration.imageSizeMapping, function (item) {
        imageSizeMapping[item.id] = item.value;
    });
    baseConfiguration.imageSizeMapping = imageSizeMapping;
    var searchApiMasterOptions = {};
    _.each(baseConfiguration.searchApiMasterOptions, function (item) {
        searchApiMasterOptions[item.id] = {
            fieldset: item.fieldset,
            include: item.include
        };
    });
    baseConfiguration.searchApiMasterOptions = searchApiMasterOptions;
    var addThisOptions = {};
    _.each(baseConfiguration.addThis && baseConfiguration.addThis.options, function (item) {
        addThisOptions[item.key] = item.value;
    });
    baseConfiguration.addThis && (baseConfiguration.addThis.options = addThisOptions);
    var addThisServicesToShow = {};
    _.each(baseConfiguration.addThis && baseConfiguration.addThis.servicesToShow, function (item) {
        addThisServicesToShow[item.key] = item.value;
    });
    baseConfiguration.addThis && (baseConfiguration.addThis.servicesToShow = addThisServicesToShow);
    _.each(baseConfiguration.paymentmethods, function (item) {
        try {
            if (item.regex) {
                item.regex = new RegExp(item.regex);
            }
        } catch (ex) {
        }
    });
    if (baseConfiguration.productReviews && baseConfiguration.productReviews.sortOptions) {
        _.each(baseConfiguration.productReviews.sortOptions, function (sortOptions) {
            try {
                sortOptions.params = JSON.parse(sortOptions.params || '{}') || {};
            } catch (ex) {
            }
        });
    }
    if (baseConfiguration.productReviews && baseConfiguration.productReviews.filterOptions) {
        _.each(baseConfiguration.productReviews.filterOptions, function (filterOptions) {
            try {
                filterOptions.params = JSON.parse(filterOptions.params || '{}') || {};
            } catch (ex) {
            }
        });
    }
    var currentLocale = SC && SC.ENVIRONMENT && SC.ENVIRONMENT.currentLanguage && SC.ENVIRONMENT.currentLanguage.locale;
    _.each(baseConfiguration.extraTranslations, function (item) {
        if (item[currentLocale]) {
            SC.Translations[item.key] = item[currentLocale];
        }
    });
    baseConfiguration.navigationData = baseConfiguration.navigationData || [];
    _.each(baseConfiguration.navigationData, function (entry) {
        if (!entry) {
            return;
        } else {
            if (entry.placeholder) {
                entry.text = '';
            }
            entry['class'] = 'header-menu-level' + entry.level + '-anchor';
        }
        if (entry.parentId) {
            var parent = _.find(baseConfiguration.navigationData, function (e) {
                return e.id === entry.parentId;
            });
            parent = parent || {};
            parent.categories = parent.categories || [];
            parent.categories.push(entry);
        }
        if (entry.classnames) {
            entry['class'] += ' ' + entry.classnames;
        }
    });
    for (var i = 0; i < baseConfiguration.navigationData.length; i++) {
        var entry = baseConfiguration.navigationData[i];
        if (!entry || entry.level > 1) {
            baseConfiguration.navigationData.splice(i, 1);
            i--;
        }
    }
    Utils.setPathFromObject(baseConfiguration, 'forms.address.showAddressLine2', Utils.getPathFromObject(baseConfiguration, 'forms.address.showAddressLineTwo', true));
    return baseConfiguration;
});
define('Session', [
    'underscore',
    'Utils'
], function (_) {
    'use strict';
    return {
        get: function (path, default_value) {
            var session_info = SC && SC.getSessionInfo && SC.getSessionInfo() || {};
            return _.getPathFromObject(session_info, path, default_value);
        },
        set: function (path, value) {
            var session_info = SC && SC.getSessionInfo && SC.getSessionInfo() || {};
            session_info[path] = value;
        },
        getSearchApiParams: function () {
            var search_api_params = {}, locale = this.get('language.locale', ''), language = '', country = '', currency = this.get('currency.code', '') ? this.get('currency.code', '') : this.get('currency', '');
            if (~locale.indexOf('_')) {
                var locale_tokens = locale.split('_');
                language = locale_tokens[0];
                country = locale_tokens[1];
            } else {
                language = locale;
            }
            if (language) {
                search_api_params.language = language;
            }
            if (country) {
                search_api_params.country = country;
            }
            if (currency) {
                search_api_params.currency = currency;
            }
            search_api_params.pricelevel = this.get('priceLevel', '');
            if (_.parseUrlOptions(location.search).nocache === 'T') {
                search_api_params.nocache = 'T';
            }
            return search_api_params;
        }
    };
});
define('SC.Shopping.Configuration', [
    'SC.Configuration',
    'Session',
    'underscore',
    'jQuery',
    'Backbone',
    'Utils'
], function (BaseConfiguration, Session, _, jQuery, Backbone, Utils) {
    'use strict';
    var Configuration = {
        currentTouchpoint: 'home',
        modulesConfig: {
            'ProductDetails': { startRouter: true },
            'Cart': {
                startRouter: true,
                saveForLater: true
            }
        },
        loginToSeePrices: { hiddenFacetNames: ['onlinecustomerprice'] },
        colors: BaseConfiguration.get('colors'),
        searchTitlePrefix: _('').translate(),
        searchTitleSuffix: _('').translate()
    };
    var seo_title = function (layout) {
            var title = layout.$('[itemprop="name"]:eq(0)').text();
            return title && title.length ? jQuery.trim(title) : '';
        }, seo_url = function () {
            return window.location.protocol + '//' + window.location.hostname + '/' + Backbone.history.fragment;
        }, seo_domain = function () {
            return Session.get('touchpoints.home');
        }, seo_image = function (layout, number) {
            var $image = layout.$('[data-type="social-image"], [itemprop="image"]'), my_number = typeof number === 'undefined' ? 0 : number, resized_image = $image.get(my_number) ? $image.get(my_number).src : Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', BaseConfiguration.get.apply(Configuration, ['imageNotAvailable']));
            return encodeURI(resized_image);
        }, seo_site_name = function () {
            return SC.ENVIRONMENT.siteSettings.displayname;
        }, seo_description = function (layout) {
            var social_description = layout.$('[data-type="social-description"], [itemprop="description"]').first().text();
            social_description = jQuery.trim(social_description).replace(/\s+/g, ' ');
            return social_description && social_description.length ? social_description : '';
        }, seo_twitter_description = function (layout) {
            var description = seo_description(layout);
            return description && description.length ? description.substring(0, 200) : '';
        }, seo_provider_name = function () {
            return SC.ENVIRONMENT.siteSettings.displayname;
        }, seo_price = function (layout) {
            var price = layout.$('[itemprop="price"]:eq(0)').text();
            price = jQuery.trim(price);
            return price && price.length ? price : '';
        }, seo_price_standard_amount = function (layout) {
            var the_num = seo_price(layout);
            return the_num && the_num.length ? the_num.replace(/^\D+/g, '') : '';
        }, seo_price_currency = function (layout) {
            var price_currency = layout.$('[itemprop="priceCurrency"]').attr('content');
            price_currency = jQuery.trim(price_currency);
            return price_currency && price_currency.length ? price_currency : '';
        }, seo_availability = function (layout) {
            var $availability_href = layout.$('[itemprop="availability"]'), result = '', param = '';
            $availability_href = jQuery.trim($availability_href.attr('href'));
            result = $availability_href.split('/');
            param = result[result.length - 1];
            return param && param.length ? param : '';
        }, seo_rating = function (layout) {
            var rating = layout.$('[itemprop="ratingValue"]:eq(0)').attr('content');
            return rating && rating.length ? rating : '';
        }, seo_rating_scale = function (layout) {
            var rating_scale = layout.$('[itemprop="bestRating"]:eq(0)').attr('content');
            return rating_scale && rating_scale.length ? rating_scale : '';
        }, seo_rating_count = function (layout) {
            var rating_count = layout.$('[itemprop="reviewCount"]:eq(0)').text();
            return rating_count && rating_count.length ? jQuery.trim(rating_count) : '';
        }, seo_twitter_site = function () {
            return '';
        }, seo_twitter_creator = function () {
            return '';
        }, seo_twitter_label_one = function () {
            return 'PRICE';
        }, seo_twitter_price = function (layout) {
            return jQuery.trim(seo_price(layout) + ' ' + seo_price_currency(layout));
        }, seo_twitter_label_two = function () {
            return 'AVAILABILITY';
        }, seo_twitter_image_cero = function (layout) {
            return seo_image(layout, 0);
        }, seo_twitter_image_one = function (layout) {
            return seo_image(layout, 1);
        }, seo_twitter_image_two = function (layout) {
            return seo_image(layout, 2);
        }, seo_twitter_image_three = function (layout) {
            return seo_image(layout, 3);
        }, seo_google_plus_authorship_author = function () {
        }, seo_google_plus_authorship_publisher = function () {
        };
    _.extend(Configuration, {
        linkTagGooglePlusAuthorship: {
            'author': seo_google_plus_authorship_author,
            'publisher': seo_google_plus_authorship_publisher
        },
        metaTagMappingOg: {
            'og:title': seo_title,
            'og:type': function () {
                return 'product';
            },
            'og:url': seo_url,
            'og:image': seo_image,
            'og:site_name': seo_site_name,
            'og:description': seo_description,
            'og:provider_name': seo_provider_name,
            'og:price:standard_amount': seo_price_standard_amount,
            'og:price:currency': seo_price_currency,
            'og:availability': seo_availability,
            'og:rating': seo_rating,
            'og:rating_scale': seo_rating_scale,
            'og:rating_count': seo_rating_count
        },
        metaTagMappingTwitterProductCard: {
            'twitter:card': function () {
                return 'product';
            },
            'twitter:site': seo_twitter_site,
            'twitter:creator': seo_twitter_creator,
            'twitter:title': seo_title,
            'twitter:description': seo_twitter_description,
            'twitter:image:src': seo_image,
            'twitter:domain': seo_domain,
            'twitter:data1': seo_twitter_price,
            'twitter:label1': seo_twitter_label_one,
            'twitter:data2': seo_availability,
            'twitter:label2': seo_twitter_label_two
        },
        metaTagMappingTwitterGalleryCard: {
            'twitter:card': function () {
                return 'gallery';
            },
            'twitter:title': seo_title,
            'twitter:description': seo_twitter_description,
            'twitter:image0:src': seo_twitter_image_cero,
            'twitter:image1:src': seo_twitter_image_one,
            'twitter:image2:src': seo_twitter_image_two,
            'twitter:image3:src': seo_twitter_image_three
        }
    });
    jQuery.extend(true, BaseConfiguration, Configuration);
    return BaseConfiguration;
});
define('GlobalViews.Message.View', [
    'global_views_message.tpl',
    'Backbone',
    'underscore'
], function (global_views_message_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_message_tpl,
        event: { 'click [data-action="close-message"]': 'closeMessage' },
        show: function show($placeholder, time) {
            $placeholder.empty();
            this.render();
            $placeholder.html(this.$el).show();
            if (time && time > 0) {
                setTimeout(function () {
                    $placeholder.fadeOut(function () {
                        $placeholder.empty();
                    });
                }, time);
            }
        },
        closeMessage: function closeMessage(e) {
            return _.isFunction(this.options.closeMessageHandler) && this.options.closeMessageHandler(e);
        },
        childViews: {
            'global-views-message-childview-message': function () {
                return this.options.childView;
            }
        },
        getContext: function getContext() {
            var has_error_code = !!this.options.message.errorCode, message = has_error_code ? this.options.message.message : this.options.message, errorCode = this.options.message.errorCode;
            return {
                message: message,
                hasErrorCode: has_error_code,
                errorCode: errorCode,
                closable: !!this.options.closable,
                type: this.options.type ? 'global-views-message-' + this.options.type : '',
                showMultipleMessage: !!_.isObject(this.options.message) && !has_error_code,
                messages: _.isArray(this.options.message) ? this.options.message : [this.options.message],
                showStringMessage: !this.options.childView
            };
        }
    });
});
define('PluginContainer', ['underscore'], function (_) {
    'use strict';
    var PluginContainer = function () {
        this.initialize();
    };
    _(PluginContainer.prototype).extend({
        initialize: function () {
            this.plugins = [];
        },
        executeAll: function () {
            var args = Array.prototype.slice.call(arguments, 0);
            _(this.plugins).each(function (p) {
                args[0] = p.execute.apply(p, args) || args[0];
            });
            return args[0];
        },
        executeAllWithContext: function () {
            var context = arguments[0], args = Array.prototype.slice.call(arguments, 1);
            _(this.plugins).each(function (p) {
                args[0] = p.execute.apply(context || p, args) || args[0];
            });
            return args[0];
        },
        _getPluginName: function (plugin) {
            return _(plugin).isString() ? plugin : plugin.name;
        },
        install: function (plugin) {
            this.plugins.push(plugin);
            this.plugins = _(this.plugins).sort(function (a, b) {
                return a.priority < b.priority ? 1 : -1;
            });
        },
        uninstall: function uninstall(plugin) {
            var name = this._getPluginName(plugin);
            this.plugins = _(this.plugins).reject(function (p) {
                return p.name === name;
            });
        }
    });
    return PluginContainer;
});
define('SC.CancelableEvents', [
    'underscore',
    'jQuery'
], function (_, jQuery) {
    'use strict';
    return {
        cancelableOn: function cancelableOn(event_name, handler) {
            this._cancelableOn(this, event_name, handler);
        },
        cancelableOff: function cancelableOff(event_name, handler) {
            if (!_.isString(event_name) || !_.isFunction(handler)) {
                var error = new Error('Parameter "event_name" and "handler" must be String and Function respectively');
                error.name = 'INVALID_PARAM';
                throw error;
            }
            this._cancelableOff(this, event_name, handler);
        },
        _cancelableOff: function _cancelableOff(events_container_entity, event_name, handler) {
            if (!events_container_entity || !events_container_entity._cancelableEvents || !events_container_entity._cancelableEvents[event_name] || !events_container_entity._cancelableEvents[event_name].length) {
                return events_container_entity;
            }
            events_container_entity._cancelableEvents[event_name] = _.reject(events_container_entity._cancelableEvents[event_name], function (event_object) {
                return event_object.fn === handler;
            });
            return events_container_entity;
        },
        _cancelableOn: function _cancelableOn(events_container_entity, event_name, handler) {
            events_container_entity._cancelableEvents = events_container_entity._cancelableEvents || {};
            var event_handlers = events_container_entity._cancelableEvents[event_name] = events_container_entity._cancelableEvents[event_name] || [];
            event_handlers.push({ fn: handler });
            return events_container_entity;
        },
        cancelableTrigger: function cancelableTrigger(event_name) {
            var args = Array.prototype.slice.call(arguments).slice(1);
            return this._cancelableTrigger(this, event_name, args, true);
        },
        cancelableTriggerUnsafe: function cancelableTriggerUnsafe(event_name) {
            var args = Array.prototype.slice.call(arguments).slice(1);
            return this._cancelableTrigger(this, event_name, args, false);
        },
        _cancelableTrigger: function _cancelableTrigger(events_container_entity, event_name, args, safe_parameters) {
            var self = this;
            if (!events_container_entity || !events_container_entity._cancelableEvents || !events_container_entity._cancelableEvents[event_name] || !events_container_entity._cancelableEvents[event_name].length) {
                return jQuery.Deferred().resolve();
            } else {
                var event_handler_promises = _.map(events_container_entity._cancelableEvents[event_name], function (event_handler_container) {
                    try {
                        return event_handler_container.fn.apply(null, safe_parameters ? _.map(args, self._getSafeParameter) : args);
                    } catch (e) {
                        console.error('Exception on event handler for event ' + event_name, e);
                        return jQuery.Deferred().reject(e);
                    }
                });
                return jQuery.when.apply(jQuery, event_handler_promises);
            }
        },
        _getSafeParameter: function _getSafeParameter(original_intent) {
            return _.isUndefined(original_intent) ? original_intent : JSON.parse(JSON.stringify(original_intent));
        }
    };
});
define('Backbone.View', [
    'Backbone',
    'GlobalViews.Message.View',
    'underscore',
    'jQuery',
    'PluginContainer',
    'SC.CancelableEvents'
], function (Backbone, GlobalViewsMessageView, _, jQuery, PluginContainer, SCCancelableEvents) {
    'use strict';
    var proto = Backbone.View.prototype, view = Backbone.View;
    Backbone.View.beforeInitialize = new PluginContainer();
    Backbone.View.afterInitialize = new PluginContainer();
    Backbone.View = function (options) {
        this.cid = _.uniqueId('view');
        this._configure(options || {});
        this._ensureElement();
        this.constructor.beforeInitialize.executeAllWithContext(this, arguments);
        this.initialize.apply(this, arguments);
        this.constructor.afterInitialize.executeAllWithContext(this, arguments);
        this.delegateEvents();
    };
    _.extend(Backbone.View, view);
    Backbone.View.prototype = proto;
    _.extend(Backbone.View.prototype, {
        errorMessage: 'Sorry, the information you provided is either incomplete or needs to be corrected.',
        showContent: function (dont_scroll) {
            return this.options.application && this.options.application.getLayout().showContent(this, dont_scroll);
        },
        showInModal: function (options) {
            return this.options.application && this.options.application.getLayout().showInModal(this, options);
        },
        showInPush: function (options) {
            return this.options.application && this.options.application.getLayout().showInPush(this, options);
        },
        getMetaDescription: function () {
            return this.metaDescription;
        },
        getMetaKeywords: function () {
            return this.metaKeywords;
        },
        getAddToHead: function () {
            return this.addToHead;
        },
        getMetaTags: function () {
            return jQuery('<head/>').html(this.metaTags || '').children('meta');
        },
        getTitle: function () {
            return this.title;
        },
        getPageDescription: function () {
            return this.attributes ? this.attributes.id || this.attributes['class'] || '' : '';
        },
        getCanonical: function () {
            var canonical = window.location.protocol + '//' + window.location.hostname + '/' + Backbone.history.fragment, index_of_query = canonical.indexOf('?');
            return !~index_of_query ? canonical : canonical.substring(0, index_of_query);
        },
        getRelPrev: jQuery.noop,
        getRelNext: jQuery.noop,
        _destroy: function () {
        },
        destroy: function (softDestroy) {
            this._destroy(softDestroy);
        },
        showConfirmationMessage: function (message, fixed) {
            var confirmation_message = this.$('[data-confirm-message]'), global_view_message = new GlobalViewsMessageView({
                    message: message,
                    type: 'success',
                    closable: true
                });
            confirmation_message.html(global_view_message.render().$el.html());
            if (!fixed) {
                setTimeout(function () {
                    confirmation_message.fadeOut(3000);
                }, 5000);
            }
        },
        showWarningMessage: function (message) {
            var global_view_message = new GlobalViewsMessageView({
                message: message,
                type: 'warning',
                closable: true
            });
            this.$('[data-confirm-message]').html(global_view_message.render().$el.html());
        },
        disableElementsOnPromise: function (promise, selector) {
            var $target = this.$(selector);
            console.warn('Use of deprecated method View.disableElementsOnPromise');
            if ($target.length === 0) {
                return;
            }
            $target.attr('disabled', true);
            promise.always(function () {
                $target.attr('disabled', false);
            });
        },
        getContext: function () {
            return {};
        }
    }, SCCancelableEvents);
    _.extend(Backbone.View, {
        _isEventSelectorValid: function _isEventSelectorValid(event_selector) {
            var event_name = [
                'blur',
                'change',
                'click',
                'contextmenu',
                'dblclick',
                'error',
                'focus',
                'focusin',
                'focusout',
                'keydown',
                'keypress',
                'keyup',
                'load',
                'mousedown',
                'mousemove',
                'mouseout',
                'mouseover',
                'mouseup',
                'resize',
                'scroll',
                'select',
                'submit',
                'touchend',
                'touchmove',
                'touchstart',
                'unload'
            ];
            var event_selector_structure_re = /([a-zA-Z]+) \[data\-action="([^"]+)"\]/, matches = event_selector_structure_re.exec(event_selector);
            return matches && _.indexOf(event_name, matches[1]) >= 0 && !!matches[2].length;
        },
        addExtraEventHandler: function addExtraEventHandler(event_selector, callback) {
            var error = {};
            this.prototype.events = this.prototype.events || {};
            if (!this._isEventSelectorValid(event_selector)) {
                error = new Error('The specified event_selector parameter does not respect the required format.');
                error.name = 'INVALID_PARAM';
                throw error;
            }
            if (this.prototype.events[event_selector]) {
                error = new Error('Duplicated event selector. Please specify a different one.');
                error.name = 'DUPLICATED_EVENT_SELECTOR';
                throw error;
            }
            this.prototype.events[event_selector] = _.bind(callback, null);
            this.prototype.events[event_selector].custom = true;
        },
        removeExtraEventHandler: function removeExtraEventHandler(event_selector) {
            var error = {};
            this.prototype.events = this.prototype.events || {};
            if (!this.prototype.events[event_selector] || !this.prototype.events[event_selector].custom) {
                error = new Error('The specified event selector does not exists or is not custom.');
                error.name = 'INVALID_PARAM';
                throw error;
            }
            delete this.prototype.events[event_selector];
        }
    });
    return Backbone.View;
});
define('Backbone.CompositeView', [
    'Backbone.View',
    'Backbone',
    'jQuery',
    'underscore',
    'Utils',
    'PluginContainer'
], function (BackboneView, Backbone, jQuery, _, Utils, PluginContainer) {
    'use strict';
    var compositeView = {
        destroyCompositeView: function destroyCompositeView() {
            var self = this;
            _(this.childViewInstances).each(function (container, container_name) {
                _.each(container, function (generator, view_name) {
                    self.removeChildViewInstance(container_name, view_name);
                });
            });
        },
        renderChild: function renderChild(elementOrViewName) {
            if (typeof elementOrViewName !== 'string') {
                elementOrViewName = jQuery(elementOrViewName).data('view');
            }
            if (elementOrViewName) {
                this.renderChildViewContainer(elementOrViewName, true);
            }
            return this.getChildViewInstance(elementOrViewName);
        },
        renderCompositeView: function renderCompositeView() {
            this.trigger('beforeCompositeViewRender', this);
            this._createChildViewInstances();
            this._renderChildViewInstances();
            Backbone.View.afterCompositeViewRender.executeAll(this);
            this.trigger('afterCompositeViewRender', this);
        },
        _renderChildViewInstances: function _renderChildViewInstances() {
            var self = this;
            _.each(this.childViewInstances, function (child_views, container_name) {
                self.renderChildViewContainer(container_name);
            });
        },
        _renderChildViewInstance: function _renderChildViewInstance(child_view_instance, placeholder, number_views) {
            if (child_view_instance) {
                this._setCustomTemplate(child_view_instance);
                if (number_views === 1 && !child_view_instance.isCCT) {
                    this._finishRender(child_view_instance, this.$el.find(placeholder));
                } else {
                    child_view_instance.render();
                    this.$(placeholder).append(child_view_instance.$el);
                }
            }
        },
        renderChildViewContainer: function renderChildViewContainer(container_name, create_child) {
            var self = this, generators = _.values(this.childViewInstances[container_name]);
            generators.sort(function (a, b) {
                return a.childViewIndex - b.childViewIndex;
            });
            _.each(generators, function (generator) {
                if (create_child) {
                    self.createChildViewInstance(generator);
                }
                var placeholder = self._getPlaceholder(generator.childViewSelector);
                self._renderChildViewInstance(generator.childViewInstance, placeholder, generators.length);
            });
        },
        _getPlaceholder: function _getPlaceholder(selector) {
            var placeholder = '';
            _.each(selector, function (value, key) {
                placeholder += '[' + key + '="' + value + '"]';
            });
            return placeholder;
        },
        _createChildViewInstances: function _createChildViewInstances() {
            var self = this;
            _.each(this.childViewInstances, function (child_views) {
                _.each(child_views, function (generator) {
                    var placeholder = self._getPlaceholder(generator.childViewSelector), $element = self.$(placeholder);
                    if ($element.length) {
                        if (generator.childViewConstructor) {
                            self.createChildViewInstance(generator, $element.data());
                        }
                    }
                });
            });
        },
        createChildViewInstance: function createChildViewInstance(generator, element_data) {
            element_data = element_data || {};
            var options = _.extend({}, element_data, this.options);
            if (generator.childViewInstance) {
                generator.childViewInstance._destroy(true);
            }
            if (generator.childViewConstructor.extend === Backbone.View.extend) {
                generator.childViewInstance = new generator.childViewConstructor(options);
            } else {
                generator.childViewInstance = generator.childViewConstructor.call(this, options);
                if (_.isFunction(generator.childViewInstance)) {
                    generator.childViewInstance = generator.childViewInstance();
                }
            }
            if (generator.childViewInstance) {
                generator.childViewInstance.parentView = generator.childViewInstance.parentView || this;
                generator.childViewInstance.hasParent = true;
                generator.childViewInstance.placeholderData = element_data || {};
                generator.childViewInstance._originalTemplate = generator.childViewInstance.template;
                this._setCustomTemplate(generator.childViewInstance);
            }
            return generator.childViewInstance;
        },
        addChildViewInstances: function addChildViewInstances(child_views, render) {
            var self = this;
            _.each(child_views, function (child_view, child_view_container) {
                if (!self.childViewInstances[child_view_container]) {
                    self.childViewInstances[child_view_container] = {};
                }
                if (_.isFunction(child_view)) {
                    self.childViewInstances[child_view_container][child_view_container] = {
                        childViewIndex: 10,
                        childViewConstructor: child_view,
                        childViewInstance: null,
                        childViewSelector: { 'data-view': child_view_container }
                    };
                } else {
                    _.each(child_view, function (child_view_generator, child_view_name) {
                        self.childViewInstances[child_view_container][child_view_name] = {
                            childViewIndex: child_view_generator.childViewIndex || 10,
                            childViewConstructor: child_view_generator.childViewConstructor,
                            childViewInstance: child_view_generator.childViewInstance,
                            childViewSelector: child_view_generator.childViewSelector || { 'data-view': child_view_container }
                        };
                        if (child_view_generator.childViewInstance) {
                            var placeholder = self._getPlaceholder(child_view_generator.childViewSelector);
                            child_view_generator.childViewInstance.parentView = child_view_generator.childViewInstance.parentView || self;
                            child_view_generator.childViewInstance.hasParent = true;
                            child_view_generator.childViewInstance.placeholderData = self.$(placeholder).data() || {};
                            child_view_generator.childViewInstance._originalTemplate = child_view_generator.childViewInstance.template;
                            self._setCustomTemplate(child_view_generator.childViewInstance);
                        }
                    });
                }
                if (render) {
                    self.renderChildViewContainer(child_view_container);
                }
            });
        },
        getChildViewInstance: function getChildViewInstance(container_name, child_view_name) {
            child_view_name = child_view_name || container_name;
            return this.childViewInstances[container_name] && this.childViewInstances[container_name][child_view_name] && this.childViewInstances[container_name][child_view_name].childViewInstance;
        },
        getChildViewInstances: function getChildViewInstances(container_name) {
            var all_child_views = [];
            if (container_name) {
                _.each(this.childViewInstances[container_name], function (child_view_generator) {
                    if (child_view_generator.childViewInstance) {
                        all_child_views.push(child_view_generator.childViewInstance);
                    }
                });
            } else {
                _.each(this.childViewInstances, function (child_views) {
                    _.each(child_views, function (child_view_generator) {
                        if (child_view_generator.childViewInstance) {
                            all_child_views.push(child_view_generator.childViewInstance);
                        }
                    });
                });
            }
            return all_child_views;
        },
        updateChildViewInstances: function updateChildViewInstances(child_views, render) {
            var self = this, promises = [];
            _.each(child_views, function (child_view, container_name) {
                _.each(child_view, function (generator, child_view_name) {
                    promises.push(self.removeChildViewInstance(container_name, child_view_name));
                });
            });
            return jQuery.when(promises).then(function () {
                self.addChildViewInstances(child_views, render);
            });
        },
        removeChildViewInstance: function removeChildViewInstance(container_name, child_view_name, destroy) {
            if (this.childViewInstances[container_name] && this.childViewInstances[container_name][child_view_name]) {
                var child_view_instance = this.childViewInstances[container_name][child_view_name].childViewInstance;
                destroy && delete this.childViewInstances[container_name][child_view_name];
                if (child_view_instance) {
                    child_view_instance.$el.detach();
                    return child_view_instance.destroy();
                }
            }
        },
        _getCustomTemplatePrefix: function _getCustomTemplatePrefix() {
            return [
                'cell-',
                'row-',
                'child-',
                ''
            ];
        },
        _setCustomTemplate: function _setCustomTemplate(child_view) {
            var template_prefix = this._getCustomTemplatePrefix();
            _.each(template_prefix, function (prefix) {
                var template_name = child_view.placeholderData[prefix + 'template'];
                var definitive_template_name = Utils.selectByViewportWidth({
                    phone: child_view.placeholderData[prefix + 'phoneTemplate'],
                    tablet: child_view.placeholderData[prefix + 'tabletTemplate'],
                    desktop: template_name
                }, template_name);
                if (definitive_template_name) {
                    child_view[prefix ? prefix + 'Template' : 'template'] = Utils.requireModules(definitive_template_name + '.tpl');
                } else {
                    child_view[prefix ? prefix + 'Template' : 'template'] = child_view._originalTemplate;
                }
            });
        },
        _finishRender: function _finishRender(child_view, $placeholder) {
            child_view.$el = $placeholder;
            var placeholder_class = $placeholder.attr('class');
            child_view.className = (child_view.className || '') + ' ' + (placeholder_class || '');
            child_view.render();
        },
        setChildViewIndex: function setChildViewIndex(container_name, view_name, index, render) {
            if (this.childViewsInstances[container_name] && this.childViewsInstances[container_name][view_name]) {
                this.childViewsInstances[container_name][view_name].childViewIndex = index;
                if (render) {
                    this.render();
                }
            }
        },
        contextData: {},
        getContextData: function (contexts) {
            var contextData = {}, i = contexts.length;
            while (i--) {
                if (this.contextData[contexts[i]]) {
                    contextData[contexts[i]] = _.bind(this.contextData[contexts[i]], this);
                    contexts.splice(i, 1);
                }
            }
            if (contexts.length && this.parentView) {
                return _.extend(this.parentView.getContextData(contexts), contextData);
            }
            return contextData;
        }
    };
    _.extend(Backbone.View.prototype, compositeView);
    Backbone.View.afterCompositeViewRender = new PluginContainer();
    Backbone.View.addExtraChildrenViews = function addExtraChildrenViews(option_views) {
        console.warn('DEPRECATED: "Backbone.View.addExtraChildrenViews(params)" is deprecated. Use "Backbone.CompositeView.addChildViews(params)" instead');
        this.addChildViews(option_views);
    };
    Backbone.View.setChildViewIndex = function setChildViewIndex(container_name, view_name, index) {
        if (this.childViews[container_name]) {
            if (_.isFunction(this.childViews[container_name])) {
                this._normalizeChildView(container_name);
            }
            if (this.childViews[container_name][view_name]) {
                this.childViews[container_name][view_name].childViewIndex = index;
            }
        }
    };
    Backbone.View._normalizeChildView = function _normalizeChildView(container_name) {
        var childViewConstructor = this.childViews[container_name];
        this.childViews[container_name] = {};
        this.childViews[container_name][container_name] = {
            childViewIndex: 10,
            childViewConstructor: childViewConstructor
        };
    };
    Backbone.View.addChildViews = function addChildViews(child_views) {
        var self = this;
        this.childViews = _.extend({}, this.prototype.childViews, this.childViews);
        _.each(child_views, function (child_view, child_view_container) {
            if (self.childViews[child_view_container]) {
                if (_.isFunction(self.childViews[child_view_container])) {
                    self._normalizeChildView(child_view_container);
                }
            } else {
                self.childViews[child_view_container] = {};
            }
            if (_.isFunction(child_view)) {
                self.childViews[child_view_container][child_view_container] = {
                    childViewIndex: 10,
                    childViewConstructor: child_view
                };
            } else {
                _.each(child_view, function (child_view_generator, child_view_name) {
                    self.childViews[child_view_container][child_view_name] = child_view_generator;
                });
            }
        });
    };
    Backbone.View.removeChildView = function removeChildView(container_name, child_view_name) {
        if (_.isFunction(this.childViews[container_name])) {
            delete this.childViews[container_name];
        } else if (this.childViews[container_name] && this.childViews[container_name][child_view_name]) {
            delete this.childViews[container_name][child_view_name];
        }
    };
    Backbone.View.beforeInitialize.install({
        name: 'compositeView',
        priority: 1,
        execute: function () {
            var childViews = _.extend({}, this.childViews, this.constructor.childViews);
            this.childViewInstances = {};
            this.addChildViewInstances(childViews);
            if (this.options) {
                if (this.options.extraChildViews) {
                    console.warn('DEPRECATED: "options.extraChildViews" is deprecated. Use "options.childViews" instead');
                    this.addChildViewInstances(this.options.extraChildViews);
                }
                if (this.options.childViews) {
                    this.addChildViewInstances(this.options.childViews);
                }
            }
        }
    });
    return { add: jQuery.noop };
});
define('GlobalViews.Modal.View', [
    'global_views_modal.tpl',
    'Backbone.CompositeView',
    'Backbone',
    'underscore'
], function (global_views_modal_tpl, BackboneCompositeView, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_modal_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        childViews: {
            'Child.View': function () {
                return this.options.childViewIstance;
            }
        },
        getContext: function () {
            return {
                pageHeader: this.options.pageHeader || ' ',
                showPageHeader: _.isUndefined(this.options.childViewIstance.showModalPageHeader) ? !!this.options.pageHeader : this.options.childViewIstance.showModalPageHeader,
                modalDialogClass: this.options.childViewIstance.modalClass || ''
            };
        }
    });
});
define('Address.Model', [
    'underscore',
    'Backbone',
    'Utils'
], function (_, Backbone) {
    'use strict';
    function isCompanyRequired() {
        return SC && SC.ENVIRONMENT && SC.ENVIRONMENT.siteSettings && SC.ENVIRONMENT.siteSettings.registration && SC.ENVIRONMENT.siteSettings.registration.companyfieldmandatory === 'T';
    }
    function isPhoneRequired() {
        return SC && SC.CONFIGURATION && SC.CONFIGURATION.addresses && SC.CONFIGURATION.addresses.isPhoneMandatory;
    }
    return Backbone.Model.extend({
        urlRoot: 'services/Address.Service.ss',
        validation: {
            fullname: {
                required: true,
                msg: _('Full Name is required').translate()
            },
            addr1: {
                required: true,
                msg: _('Address is required').translate()
            },
            company: {
                required: isCompanyRequired(),
                msg: _('Company is required').translate()
            },
            country: {
                required: true,
                msg: _('Country is required').translate()
            },
            state: { fn: _.validateState },
            city: {
                required: true,
                msg: _('City is required').translate()
            },
            zip: { fn: _.validateZipCode },
            phone: {
                required: isPhoneRequired(),
                fn: _.validatePhone
            }
        },
        getInvalidAttributes: function () {
            var attributes_to_validate = _.keys(this.validation), attribute_name, invalid_attributes = [];
            this.get('isvalid') !== 'T' && this.isValid(true) && _.extend(this, Backbone.Validation.mixin);
            _.each(attributes_to_validate, function (attribute) {
                if (!this.isValid(attribute)) {
                    attribute_name = null;
                    switch (attribute) {
                    case 'fullname':
                        attribute_name = _('Full Name').translate();
                        break;
                    case 'addr1':
                        attribute_name = _('Address').translate();
                        break;
                    case 'city':
                        attribute_name = _('City').translate();
                        break;
                    case 'zip':
                        attribute_name = _('Zip Code').translate();
                        break;
                    case 'country':
                        attribute_name = _('Country').translate();
                        break;
                    case 'phone':
                        attribute_name = _('Phone Number').translate();
                        break;
                    case 'state':
                        attribute_name = _('State').translate();
                        break;
                    }
                    if (attribute_name) {
                        invalid_attributes.push(attribute_name);
                    }
                }
            }, this);
            return invalid_attributes;
        }
    });
});
define('Address.Collection', [
    'Address.Model',
    'Backbone'
], function (Model, Backbone) {
    'use strict';
    return Backbone.Collection.extend({
        model: Model,
        url: 'services/Address.Service.ss',
        comparator: function (model) {
            return model.get('defaultbilling') === 'T' || model.get('defaultshipping') === 'T' ? 0 : 1;
        }
    });
});
define('CreditCard.Model', [
    'Backbone',
    'underscore',
    'jQuery',
    'Utils'
], function (Backbone, _, jQuery) {
    'use strict';
    function validateExpirationDate(value, name, data) {
        var current = new Date(), selected_date = new Date(data.expyear, data.expmonth - 1).getTime();
        if (!value || _.isNaN(selected_date) || new Date(current.getFullYear(), current.getMonth()).getTime() > selected_date) {
            return _('Please select a date in the future').translate();
        }
    }
    return Backbone.Model.extend({
        urlRoot: 'services/CreditCard.Service.ss',
        validation: {
            ccname: {
                fn: function (cc_name) {
                    if (!cc_name || !jQuery.trim(cc_name)) {
                        return _('Name is required').translate();
                    } else if (cc_name.length > 26) {
                        return _('Name too long').translate();
                    }
                }
            },
            ccnumber: {
                fn: function (cc_number, attr, form) {
                    if (!cc_number) {
                        return _('Card Number is required').translate();
                    }
                    if (_.isUndefined(form.internalid)) {
                        cc_number = cc_number.replace(/\s/g, '');
                        var card_number_is_valid = _(cc_number.split('').reverse()).reduce(function (a, n, index) {
                            return a + _((+n * [
                                1,
                                2
                            ][index % 2]).toString().split('')).reduce(function (b, o) {
                                return b + +o;
                            }, 0);
                        }, 0) % 10 === 0;
                        if (!card_number_is_valid) {
                            return _('Credit Card Number is invalid').translate();
                        }
                    }
                }
            },
            paymentmethod: {
                fn: function (paymentmethod, attr, form) {
                    if (_.isUndefined(form.internalid) && paymentmethod === '0') {
                        return _('Please Select a Credit Card Type').translate();
                    }
                }
            },
            expyear: { fn: validateExpirationDate },
            expmonth: { fn: validateExpirationDate },
            ccsecuritycode: {
                fn: function (cc_security_code) {
                    if (SC.ENVIRONMENT.siteSettings.checkout.requireccsecuritycode === 'T' && (this.hasSecurityCode || this.get('hasSecurityCode'))) {
                        var errorMessage = _.validateSecurityCode(cc_security_code);
                        if (errorMessage) {
                            return errorMessage;
                        }
                    }
                }
            }
        },
        initialize: function (attributes, options) {
            this.options = options;
        }
    });
});
define('CreditCard.Collection', [
    'CreditCard.Model',
    'Backbone'
], function (Model, Backbone) {
    'use strict';
    return Backbone.Collection.extend({
        model: Model,
        url: 'services/CreditCard.Service.ss',
        comparator: function (model) {
            return model.get('ccdefault') !== 'T';
        }
    });
});
define('Singleton', function () {
    'use strict';
    var Singleton = {
        getInstance: function () {
            var This = this;
            this.instance = this.instance || new This();
            return this.instance;
        }
    };
    SC.Singleton = Singleton;
    return Singleton;
});
;
(function (global) {
    'use strict';
    var MAX = 1000000000, MAX_POWER = 1000000, DECIMAL_PLACES = 20, ROUNDING_MODE = 4, TO_EXP_NEG = -7, TO_EXP_POS = 21, MIN_EXP = -MAX, MAX_EXP = MAX, ERRORS = true, parse = parseInt, P = BigNumber.prototype, DIGITS = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_', outOfRange, id = 0, isValid = /^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i, trim = String.prototype.trim || function () {
            return this.replace(/^\s+|\s+$/g, '');
        }, ONE = BigNumber(1);
    function BigNumber(n, b) {
        var e, i, isNum, digits, valid, orig, x = this;
        if (!(x instanceof BigNumber)) {
            return new BigNumber(n, b);
        }
        if (n instanceof BigNumber) {
            id = 0;
            if (b !== e) {
                n += '';
            } else {
                x['s'] = n['s'];
                x['e'] = n['e'];
                x['c'] = (n = n['c']) ? n.slice() : n;
                return;
            }
        }
        if (typeof n != 'string') {
            n = (isNum = typeof n == 'number' || Object.prototype.toString.call(n) == '[object Number]') && n === 0 && 1 / n < 0 ? '-0' : n + '';
        }
        orig = n;
        if (b === e && isValid.test(n)) {
            x['s'] = n.charAt(0) == '-' ? (n = n.slice(1), -1) : 1;
        } else {
            if (b == 10) {
                return setMode(n, DECIMAL_PLACES, ROUNDING_MODE);
            }
            n = trim.call(n).replace(/^\+(?!-)/, '');
            x['s'] = n.charAt(0) == '-' ? (n = n.replace(/^-(?!-)/, ''), -1) : 1;
            if (b != null) {
                if ((b == (b | 0) || !ERRORS) && !(outOfRange = !(b >= 2 && b < 65))) {
                    digits = '[' + DIGITS.slice(0, b = b | 0) + ']+';
                    n = n.replace(/\.$/, '').replace(/^\./, '0.');
                    if (valid = new RegExp('^' + digits + '(?:\\.' + digits + ')?$', b < 37 ? 'i' : '').test(n)) {
                        if (isNum) {
                            if (n.replace(/^0\.0*|\./, '').length > 15) {
                                ifExceptionsThrow(orig, 0);
                            }
                            isNum = !isNum;
                        }
                        n = convert(n, 10, b, x['s']);
                    } else if (n != 'Infinity' && n != 'NaN') {
                        ifExceptionsThrow(orig, 1, b);
                        n = 'NaN';
                    }
                } else {
                    ifExceptionsThrow(b, 2);
                    valid = isValid.test(n);
                }
            } else {
                valid = isValid.test(n);
            }
            if (!valid) {
                x['c'] = x['e'] = null;
                if (n != 'Infinity') {
                    if (n != 'NaN') {
                        ifExceptionsThrow(orig, 3);
                    }
                    x['s'] = null;
                }
                id = 0;
                return;
            }
        }
        if ((e = n.indexOf('.')) > -1) {
            n = n.replace('.', '');
        }
        if ((i = n.search(/e/i)) > 0) {
            if (e < 0) {
                e = i;
            }
            e += +n.slice(i + 1);
            n = n.substring(0, i);
        } else if (e < 0) {
            e = n.length;
        }
        for (i = 0; n.charAt(i) == '0'; i++) {
        }
        b = n.length;
        if (isNum && b > 15 && n.slice(i).length > 15) {
            ifExceptionsThrow(orig, 0);
        }
        id = 0;
        if ((e -= i + 1) > MAX_EXP) {
            x['c'] = x['e'] = null;
        } else if (i == b || e < MIN_EXP) {
            x['c'] = [x['e'] = 0];
        } else {
            for (; n.charAt(--b) == '0';) {
            }
            x['e'] = e;
            x['c'] = [];
            for (e = 0; i <= b; x['c'][e++] = +n.charAt(i++)) {
            }
        }
    }
    BigNumber['ROUND_UP'] = 0;
    BigNumber['ROUND_DOWN'] = 1;
    BigNumber['ROUND_CEIL'] = 2;
    BigNumber['ROUND_FLOOR'] = 3;
    BigNumber['ROUND_HALF_UP'] = 4;
    BigNumber['ROUND_HALF_DOWN'] = 5;
    BigNumber['ROUND_HALF_EVEN'] = 6;
    BigNumber['ROUND_HALF_CEIL'] = 7;
    BigNumber['ROUND_HALF_FLOOR'] = 8;
    BigNumber['config'] = function () {
        var v, p, i = 0, r = {}, a = arguments, o = a[0], c = 'config', inRange = function (n, lo, hi) {
                return !((outOfRange = n < lo || n > hi) || parse(n) != n && n !== 0);
            }, has = o && typeof o == 'object' ? function () {
                if (o.hasOwnProperty(p))
                    return (v = o[p]) != null;
            } : function () {
                if (a.length > i)
                    return (v = a[i++]) != null;
            };
        if (has(p = 'DECIMAL_PLACES')) {
            if (inRange(v, 0, MAX)) {
                DECIMAL_PLACES = v | 0;
            } else {
                ifExceptionsThrow(v, p, c);
            }
        }
        r[p] = DECIMAL_PLACES;
        if (has(p = 'ROUNDING_MODE')) {
            if (inRange(v, 0, 8)) {
                ROUNDING_MODE = v | 0;
            } else {
                ifExceptionsThrow(v, p, c);
            }
        }
        r[p] = ROUNDING_MODE;
        if (has(p = 'EXPONENTIAL_AT')) {
            if (inRange(v, -MAX, MAX)) {
                TO_EXP_NEG = -(TO_EXP_POS = ~~(v < 0 ? -v : +v));
            } else if (!outOfRange && v && inRange(v[0], -MAX, 0) && inRange(v[1], 0, MAX)) {
                TO_EXP_NEG = ~~v[0];
                TO_EXP_POS = ~~v[1];
            } else {
                ifExceptionsThrow(v, p, c, 1);
            }
        }
        r[p] = [
            TO_EXP_NEG,
            TO_EXP_POS
        ];
        if (has(p = 'RANGE')) {
            if (inRange(v, -MAX, MAX) && ~~v) {
                MIN_EXP = -(MAX_EXP = ~~(v < 0 ? -v : +v));
            } else if (!outOfRange && v && inRange(v[0], -MAX, -1) && inRange(v[1], 1, MAX)) {
                MIN_EXP = ~~v[0], MAX_EXP = ~~v[1];
            } else {
                ifExceptionsThrow(v, p, c, 1, 1);
            }
        }
        r[p] = [
            MIN_EXP,
            MAX_EXP
        ];
        if (has(p = 'ERRORS')) {
            if (v === !!v || v === 1 || v === 0) {
                parse = (outOfRange = id = 0, ERRORS = !!v) ? parseInt : parseFloat;
            } else {
                ifExceptionsThrow(v, p, c, 0, 0, 1);
            }
        }
        r[p] = ERRORS;
        return r;
    };
    function ifExceptionsThrow(arg, i, j, isArray, isRange, isErrors) {
        if (ERRORS) {
            var error, method = [
                    'new BigNumber',
                    'cmp',
                    'div',
                    'eq',
                    'gt',
                    'gte',
                    'lt',
                    'lte',
                    'minus',
                    'mod',
                    'plus',
                    'times',
                    'toFr'
                ][id ? id < 0 ? -id : id : 1 / id < 0 ? 1 : 0] + '()', message = outOfRange ? ' out of range' : ' not a' + (isRange ? ' non-zero' : 'n') + ' integer';
            message = ([
                method + ' number type has more than 15 significant digits',
                method + ' not a base ' + j + ' number',
                method + ' base' + message,
                method + ' not a number'
            ][i] || j + '() ' + i + (isErrors ? ' not a boolean or binary digit' : message + (isArray ? ' or not [' + (outOfRange ? ' negative, positive' : ' integer, integer') + ' ]' : ''))) + ': ' + arg;
            outOfRange = id = 0;
            error = new Error(message);
            error['name'] = 'BigNumber Error';
            throw error;
        }
    }
    function convert(nStr, baseOut, baseIn, sign) {
        var e, dvs, dvd, nArr, fracArr, fracBN;
        function strToArr(str, bIn) {
            var j, i = 0, strL = str.length, arrL, arr = [0];
            for (bIn = bIn || baseIn; i < strL; i++) {
                for (arrL = arr.length, j = 0; j < arrL; arr[j] *= bIn, j++) {
                }
                for (arr[0] += DIGITS.indexOf(str.charAt(i)), j = 0; j < arr.length; j++) {
                    if (arr[j] > baseOut - 1) {
                        if (arr[j + 1] == null) {
                            arr[j + 1] = 0;
                        }
                        arr[j + 1] += arr[j] / baseOut ^ 0;
                        arr[j] %= baseOut;
                    }
                }
            }
            return arr.reverse();
        }
        function arrToStr(arr) {
            var i = 0, arrL = arr.length, str = '';
            for (; i < arrL; str += DIGITS.charAt(arr[i++])) {
            }
            return str;
        }
        if (baseIn < 37) {
            nStr = nStr.toLowerCase();
        }
        if ((e = nStr.indexOf('.')) > -1) {
            e = nStr.length - e - 1;
            dvs = strToArr(new BigNumber(baseIn)['pow'](e)['toF'](), 10);
            nArr = nStr.split('.');
            dvd = strToArr(nArr[1]);
            nArr = strToArr(nArr[0]);
            fracBN = divide(dvd, dvs, dvd.length - dvs.length, sign, baseOut, nArr[nArr.length - 1] & 1);
            fracArr = fracBN['c'];
            if (e = fracBN['e']) {
                for (; ++e; fracArr.unshift(0)) {
                }
                nStr = arrToStr(nArr) + '.' + arrToStr(fracArr);
            } else if (fracArr[0]) {
                if (nArr[e = nArr.length - 1] < baseOut - 1) {
                    ++nArr[e];
                    nStr = arrToStr(nArr);
                } else {
                    nStr = new BigNumber(arrToStr(nArr), baseOut)['plus'](ONE)['toS'](baseOut);
                }
            } else {
                nStr = arrToStr(nArr);
            }
        } else {
            nStr = arrToStr(strToArr(nStr));
        }
        return nStr;
    }
    function divide(dvd, dvs, exp, s, base, isOdd) {
        var dvsL, dvsT, next, cmp, remI, dvsZ = dvs.slice(), dvdI = dvsL = dvs.length, dvdL = dvd.length, rem = dvd.slice(0, dvsL), remL = rem.length, quo = new BigNumber(ONE), qc = quo['c'] = [], qi = 0, dig = DECIMAL_PLACES + (quo['e'] = exp) + 1;
        quo['s'] = s;
        s = dig < 0 ? 0 : dig;
        for (; remL++ < dvsL; rem.push(0)) {
        }
        dvsZ.unshift(0);
        do {
            for (next = 0; next < base; next++) {
                if (dvsL != (remL = rem.length)) {
                    cmp = dvsL > remL ? 1 : -1;
                } else {
                    for (remI = -1, cmp = 0; ++remI < dvsL;) {
                        if (dvs[remI] != rem[remI]) {
                            cmp = dvs[remI] > rem[remI] ? 1 : -1;
                            break;
                        }
                    }
                }
                if (cmp < 0) {
                    for (dvsT = remL == dvsL ? dvs : dvsZ; remL;) {
                        if (rem[--remL] < dvsT[remL]) {
                            for (remI = remL; remI && !rem[--remI]; rem[remI] = base - 1) {
                            }
                            --rem[remI];
                            rem[remL] += base;
                        }
                        rem[remL] -= dvsT[remL];
                    }
                    for (; !rem[0]; rem.shift()) {
                    }
                } else {
                    break;
                }
            }
            qc[qi++] = cmp ? next : ++next;
            rem[0] && cmp ? rem[remL] = dvd[dvdI] || 0 : rem = [dvd[dvdI]];
        } while ((dvdI++ < dvdL || rem[0] != null) && s--);
        if (!qc[0] && qi != 1) {
            --quo['e'];
            qc.shift();
        }
        if (qi > dig) {
            rnd(quo, DECIMAL_PLACES, base, isOdd, rem[0] != null);
        }
        if (quo['e'] > MAX_EXP) {
            quo['c'] = quo['e'] = null;
        } else if (quo['e'] < MIN_EXP) {
            quo['c'] = [quo['e'] = 0];
        }
        return quo;
    }
    function format(n, d, exp) {
        var i = d - (n = new BigNumber(n))['e'], c = n['c'];
        if (!c) {
            return n['toS']();
        }
        if (c.length > ++d) {
            rnd(n, i, 10);
        }
        i = c[0] == 0 ? i + 1 : exp ? d : n['e'] + i + 1;
        for (; c.length < i; c.push(0)) {
        }
        i = n['e'];
        return exp == 1 || exp == 2 && (--d < i || i <= TO_EXP_NEG) ? (n['s'] < 0 && c[0] ? '-' : '') + (c.length > 1 ? (c.splice(1, 0, '.'), c.join('')) : c[0]) + (i < 0 ? 'e' : 'e+') + i : n['toS']();
    }
    function rnd(x, dp, base, isOdd, r) {
        var xc = x['c'], isNeg = x['s'] < 0, half = base / 2, i = x['e'] + dp + 1, next = xc[i], more = r || i < 0 || xc[i + 1] != null;
        r = ROUNDING_MODE < 4 ? (next != null || more) && (ROUNDING_MODE == 0 || ROUNDING_MODE == 2 && !isNeg || ROUNDING_MODE == 3 && isNeg) : next > half || next == half && (ROUNDING_MODE == 4 || more || ROUNDING_MODE == 6 && (xc[i - 1] & 1 || !dp && isOdd) || ROUNDING_MODE == 7 && !isNeg || ROUNDING_MODE == 8 && isNeg);
        if (i < 1 || !xc[0]) {
            xc.length = 0;
            xc.push(0);
            if (r) {
                xc[0] = 1;
                x['e'] = -dp;
            } else {
                x['e'] = 0;
            }
            return x;
        }
        xc.length = i--;
        if (r) {
            for (--base; ++xc[i] > base;) {
                xc[i] = 0;
                if (!i--) {
                    ++x['e'];
                    xc.unshift(1);
                }
            }
        }
        for (i = xc.length; !xc[--i]; xc.pop()) {
        }
        return x;
    }
    function setMode(x, dp, rm) {
        var r = ROUNDING_MODE;
        ROUNDING_MODE = rm;
        x = new BigNumber(x);
        x['c'] && rnd(x, dp, 10);
        ROUNDING_MODE = r;
        return x;
    }
    P['abs'] = P['absoluteValue'] = function () {
        var x = new BigNumber(this);
        if (x['s'] < 0) {
            x['s'] = 1;
        }
        return x;
    };
    P['ceil'] = function () {
        return setMode(this, 0, 2);
    };
    P['comparedTo'] = P['cmp'] = function (y, b) {
        var a, x = this, xc = x['c'], yc = (id = -id, y = new BigNumber(y, b))['c'], i = x['s'], j = y['s'], k = x['e'], l = y['e'];
        if (!i || !j) {
            return null;
        }
        a = xc && !xc[0], b = yc && !yc[0];
        if (a || b) {
            return a ? b ? 0 : -j : i;
        }
        if (i != j) {
            return i;
        }
        if (a = i < 0, b = k == l, !xc || !yc) {
            return b ? 0 : !xc ^ a ? 1 : -1;
        }
        if (!b) {
            return k > l ^ a ? 1 : -1;
        }
        for (i = -1, j = (k = xc.length) < (l = yc.length) ? k : l; ++i < j;) {
            if (xc[i] != yc[i]) {
                return xc[i] > yc[i] ^ a ? 1 : -1;
            }
        }
        return k == l ? 0 : k > l ^ a ? 1 : -1;
    };
    P['decimalPlaces'] = P['dp'] = function () {
        var dp;
        if (this['c']) {
            dp = this['c'].length - this['e'] - 1;
            return dp < 0 ? 0 : dp;
        }
        return null;
    };
    P['dividedBy'] = P['div'] = function (y, b) {
        var xc = this['c'], xe = this['e'], xs = this['s'], yc = (id = 2, y = new BigNumber(y, b))['c'], ye = y['e'], ys = y['s'], s = xs == ys ? 1 : -1;
        return !xe && (!xc || !xc[0]) || !ye && (!yc || !yc[0]) ? new BigNumber(!xs || !ys || (xc ? yc && xc[0] == yc[0] : !yc) ? NaN : xc && xc[0] == 0 || !yc ? s * 0 : s / 0) : divide(xc, yc, xe - ye, s, 10);
    };
    P['equals'] = P['eq'] = function (n, b) {
        id = 3;
        return this['cmp'](n, b) === 0;
    };
    P['floor'] = function () {
        return setMode(this, 0, 3);
    };
    P['greaterThan'] = P['gt'] = function (n, b) {
        id = 4;
        return this['cmp'](n, b) > 0;
    };
    P['greaterThanOrEqualTo'] = P['gte'] = function (n, b) {
        id = 5;
        return (b = this['cmp'](n, b)) == 1 || b === 0;
    };
    P['isFinite'] = P['isF'] = function () {
        return !!this['c'];
    };
    P['isNaN'] = function () {
        return !this['s'];
    };
    P['isNegative'] = P['isNeg'] = function () {
        return this['s'] < 0;
    };
    P['isZero'] = P['isZ'] = function () {
        return !!this['c'] && this['c'][0] == 0;
    };
    P['lessThan'] = P['lt'] = function (n, b) {
        id = 6;
        return this['cmp'](n, b) < 0;
    };
    P['lessThanOrEqualTo'] = P['lte'] = function (n, b) {
        id = 7;
        return (b = this['cmp'](n, b)) == -1 || b === 0;
    };
    P['minus'] = function (y, b) {
        var d, i, j, xLTy, x = this, a = x['s'];
        b = (id = 8, y = new BigNumber(y, b))['s'];
        if (!a || !b) {
            return new BigNumber(NaN);
        }
        if (a != b) {
            return y['s'] = -b, x['plus'](y);
        }
        var xc = x['c'], xe = x['e'], yc = y['c'], ye = y['e'];
        if (!xe || !ye) {
            if (!xc || !yc) {
                return xc ? (y['s'] = -b, y) : new BigNumber(yc ? x : NaN);
            }
            if (!xc[0] || !yc[0]) {
                return yc[0] ? (y['s'] = -b, y) : new BigNumber(xc[0] ? x : ROUNDING_MODE == 3 ? -0 : 0);
            }
        }
        if (xc = xc.slice(), a = xe - ye) {
            d = (xLTy = a < 0) ? (a = -a, xc) : (ye = xe, yc);
            for (d.reverse(), b = a; b--; d.push(0)) {
            }
            d.reverse();
        } else {
            j = ((xLTy = xc.length < yc.length) ? xc : yc).length;
            for (a = b = 0; b < j; b++) {
                if (xc[b] != yc[b]) {
                    xLTy = xc[b] < yc[b];
                    break;
                }
            }
        }
        if (xLTy) {
            d = xc, xc = yc, yc = d;
            y['s'] = -y['s'];
        }
        if ((b = -((j = xc.length) - yc.length)) > 0) {
            for (; b--; xc[j++] = 0) {
            }
        }
        for (b = yc.length; b > a;) {
            if (xc[--b] < yc[b]) {
                for (i = b; i && !xc[--i]; xc[i] = 9) {
                }
                --xc[i];
                xc[b] += 10;
            }
            xc[b] -= yc[b];
        }
        for (; xc[--j] == 0; xc.pop()) {
        }
        for (; xc[0] == 0; xc.shift(), --ye) {
        }
        if (ye < MIN_EXP || !xc[0]) {
            if (!xc[0]) {
                y['s'] = ROUNDING_MODE == 3 ? -1 : 1;
            }
            xc = [ye = 0];
        }
        return y['c'] = xc, y['e'] = ye, y;
    };
    P['modulo'] = P['mod'] = function (y, b) {
        var x = this, xc = x['c'], yc = (id = 9, y = new BigNumber(y, b))['c'], i = x['s'], j = y['s'];
        b = !i || !j || yc && !yc[0];
        if (b || xc && !xc[0]) {
            return new BigNumber(b ? NaN : x);
        }
        x['s'] = y['s'] = 1;
        b = y['cmp'](x) == 1;
        x['s'] = i, y['s'] = j;
        return b ? new BigNumber(x) : (i = DECIMAL_PLACES, j = ROUNDING_MODE, DECIMAL_PLACES = 0, ROUNDING_MODE = 1, x = x['div'](y), DECIMAL_PLACES = i, ROUNDING_MODE = j, this['minus'](x['times'](y)));
    };
    P['negated'] = P['neg'] = function () {
        var x = new BigNumber(this);
        return x['s'] = -x['s'] || null, x;
    };
    P['plus'] = function (y, b) {
        var d, x = this, a = x['s'];
        b = (id = 10, y = new BigNumber(y, b))['s'];
        if (!a || !b) {
            return new BigNumber(NaN);
        }
        if (a != b) {
            return y['s'] = -b, x['minus'](y);
        }
        var xe = x['e'], xc = x['c'], ye = y['e'], yc = y['c'];
        if (!xe || !ye) {
            if (!xc || !yc) {
                return new BigNumber(a / 0);
            }
            if (!xc[0] || !yc[0]) {
                return yc[0] ? y : new BigNumber(xc[0] ? x : a * 0);
            }
        }
        if (xc = xc.slice(), a = xe - ye) {
            d = a > 0 ? (ye = xe, yc) : (a = -a, xc);
            for (d.reverse(); a--; d.push(0)) {
            }
            d.reverse();
        }
        if (xc.length - yc.length < 0) {
            d = yc, yc = xc, xc = d;
        }
        for (a = yc.length, b = 0; a; b = (xc[--a] = xc[a] + yc[a] + b) / 10 ^ 0, xc[a] %= 10) {
        }
        if (b) {
            xc.unshift(b);
            if (++ye > MAX_EXP) {
                xc = ye = null;
            }
        }
        for (a = xc.length; xc[--a] == 0; xc.pop()) {
        }
        return y['c'] = xc, y['e'] = ye, y;
    };
    P['toPower'] = P['pow'] = function (e) {
        var i = e * 0 == 0 ? e | 0 : e, x = new BigNumber(this), y = new BigNumber(ONE);
        if (((outOfRange = e < -MAX_POWER || e > MAX_POWER) && (i = e * 1 / 0) || parse(e) != e && e !== 0 && !(i = NaN)) && !ifExceptionsThrow(e, 'exponent', 'pow') || !i) {
            return new BigNumber(Math.pow(x['toS'](), i));
        }
        for (i = i < 0 ? -i : i;;) {
            if (i & 1) {
                y = y['times'](x);
            }
            i >>= 1;
            if (!i) {
                break;
            }
            x = x['times'](x);
        }
        return e < 0 ? ONE['div'](y) : y;
    };
    P['round'] = function (dp, rm) {
        dp = dp == null || ((outOfRange = dp < 0 || dp > MAX) || parse(dp) != dp) && !ifExceptionsThrow(dp, 'decimal places', 'round') ? 0 : dp | 0;
        rm = rm == null || ((outOfRange = rm < 0 || rm > 8) || parse(rm) != rm && rm !== 0) && !ifExceptionsThrow(rm, 'mode', 'round') ? ROUNDING_MODE : rm | 0;
        return setMode(this, dp, rm);
    };
    P['squareRoot'] = P['sqrt'] = function () {
        var n, r, re, t, x = this, c = x['c'], s = x['s'], e = x['e'], dp = DECIMAL_PLACES, rm = ROUNDING_MODE, half = new BigNumber('0.5');
        if (s !== 1 || !c || !c[0]) {
            return new BigNumber(!s || s < 0 && (!c || c[0]) ? NaN : c ? x : 1 / 0);
        }
        s = Math.sqrt(x['toS']());
        ROUNDING_MODE = 1;
        if (s == 0 || s == 1 / 0) {
            n = c.join('');
            if (!(n.length + e & 1)) {
                n += '0';
            }
            r = new BigNumber(Math.sqrt(n) + '');
            if (!r['c']) {
                r['c'] = [1];
            }
            r['e'] = ((e + 1) / 2 | 0) - (e < 0 || e & 1);
        } else {
            r = new BigNumber(n = s.toString());
        }
        re = r['e'];
        s = re + (DECIMAL_PLACES += 4);
        if (s < 3) {
            s = 0;
        }
        e = s;
        for (;;) {
            t = r;
            r = half['times'](t['plus'](x['div'](t)));
            if (t['c'].slice(0, s).join('') === r['c'].slice(0, s).join('')) {
                c = r['c'];
                s = s - (n && r['e'] < re);
                if (c[s] == 9 && c[s - 1] == 9 && c[s - 2] == 9 && (c[s - 3] == 9 || n && c[s - 3] == 4)) {
                    if (n && c[s - 3] == 9) {
                        t = r['round'](dp, 0);
                        if (t['times'](t)['eq'](x)) {
                            ROUNDING_MODE = rm;
                            DECIMAL_PLACES = dp;
                            return t;
                        }
                    }
                    DECIMAL_PLACES += 4;
                    s += 4;
                    n = '';
                } else {
                    if (!c[e] && !c[e - 1] && !c[e - 2] && (!c[e - 3] || c[e - 3] == 5)) {
                        if (c.length > e - 2) {
                            c.length = e - 2;
                        }
                        if (!r['times'](r)['eq'](x)) {
                            while (c.length < e - 3) {
                                c.push(0);
                            }
                            c[e - 3]++;
                        }
                    }
                    ROUNDING_MODE = rm;
                    rnd(r, DECIMAL_PLACES = dp, 10);
                    return r;
                }
            }
        }
    };
    P['times'] = function (y, b) {
        var c, x = this, xc = x['c'], yc = (id = 11, y = new BigNumber(y, b))['c'], i = x['e'], j = y['e'], a = x['s'];
        y['s'] = a == (b = y['s']) ? 1 : -1;
        if (!i && (!xc || !xc[0]) || !j && (!yc || !yc[0])) {
            return new BigNumber(!a || !b || xc && !xc[0] && !yc || yc && !yc[0] && !xc ? NaN : !xc || !yc ? y['s'] / 0 : y['s'] * 0);
        }
        y['e'] = i + j;
        if ((a = xc.length) < (b = yc.length)) {
            c = xc, xc = yc, yc = c, j = a, a = b, b = j;
        }
        for (j = a + b, c = []; j--; c.push(0)) {
        }
        for (i = b - 1; i > -1; i--) {
            for (b = 0, j = a + i; j > i; b = c[j] + yc[i] * xc[j - i - 1] + b, c[j--] = b % 10 | 0, b = b / 10 | 0) {
            }
            if (b) {
                c[j] = (c[j] + b) % 10;
            }
        }
        b && ++y['e'];
        !c[0] && c.shift();
        for (j = c.length; !c[--j]; c.pop()) {
        }
        y['c'] = y['e'] > MAX_EXP ? y['e'] = null : y['e'] < MIN_EXP ? [y['e'] = 0] : c;
        return y;
    };
    P['toExponential'] = P['toE'] = function (dp) {
        return format(this, (dp == null || ((outOfRange = dp < 0 || dp > MAX) || parse(dp) != dp && dp !== 0) && !ifExceptionsThrow(dp, 'decimal places', 'toE')) && this['c'] ? this['c'].length - 1 : dp | 0, 1);
    };
    P['toFixed'] = P['toF'] = function (dp) {
        var n, str, d, x = this;
        if (!(dp == null || ((outOfRange = dp < 0 || dp > MAX) || parse(dp) != dp && dp !== 0) && !ifExceptionsThrow(dp, 'decimal places', 'toF'))) {
            d = x['e'] + (dp | 0);
        }
        n = TO_EXP_NEG, dp = TO_EXP_POS;
        TO_EXP_NEG = -(TO_EXP_POS = 1 / 0);
        if (d == str) {
            str = x['toS']();
        } else {
            str = format(x, d);
            if (x['s'] < 0 && x['c']) {
                if (!x['c'][0]) {
                    str = str.replace(/^-/, '');
                } else if (str.indexOf('-') < 0) {
                    str = '-' + str;
                }
            }
        }
        TO_EXP_NEG = n, TO_EXP_POS = dp;
        return str;
    };
    P['toFraction'] = P['toFr'] = function (maxD) {
        var q, frac, n0, d0, d2, n, e, n1 = d0 = new BigNumber(ONE), d1 = n0 = new BigNumber('0'), x = this, xc = x['c'], exp = MAX_EXP, dp = DECIMAL_PLACES, rm = ROUNDING_MODE, d = new BigNumber(ONE);
        if (!xc) {
            return x['toS']();
        }
        e = d['e'] = xc.length - x['e'] - 1;
        if (maxD == null || (!(id = 12, n = new BigNumber(maxD))['s'] || (outOfRange = n['cmp'](n1) < 0 || !n['c']) || ERRORS && n['e'] < n['c'].length - 1) && !ifExceptionsThrow(maxD, 'max denominator', 'toFr') || (maxD = n)['cmp'](d) > 0) {
            maxD = e > 0 ? d : n1;
        }
        MAX_EXP = 1 / 0;
        n = new BigNumber(xc.join(''));
        for (DECIMAL_PLACES = 0, ROUNDING_MODE = 1;;) {
            q = n['div'](d);
            d2 = d0['plus'](q['times'](d1));
            if (d2['cmp'](maxD) == 1) {
                break;
            }
            d0 = d1, d1 = d2;
            n1 = n0['plus'](q['times'](d2 = n1));
            n0 = d2;
            d = n['minus'](q['times'](d2 = d));
            n = d2;
        }
        d2 = maxD['minus'](d0)['div'](d1);
        n0 = n0['plus'](d2['times'](n1));
        d0 = d0['plus'](d2['times'](d1));
        n0['s'] = n1['s'] = x['s'];
        DECIMAL_PLACES = e * 2;
        ROUNDING_MODE = rm;
        frac = n1['div'](d1)['minus'](x)['abs']()['cmp'](n0['div'](d0)['minus'](x)['abs']()) < 1 ? [
            n1['toS'](),
            d1['toS']()
        ] : [
            n0['toS'](),
            d0['toS']()
        ];
        return MAX_EXP = exp, DECIMAL_PLACES = dp, frac;
    };
    P['toPrecision'] = P['toP'] = function (sd) {
        return sd == null || ((outOfRange = sd < 1 || sd > MAX) || parse(sd) != sd) && !ifExceptionsThrow(sd, 'precision', 'toP') ? this['toS']() : format(this, --sd | 0, 2);
    };
    P['toString'] = P['toS'] = function (b) {
        var u, str, strL, x = this, xe = x['e'];
        if (xe === null) {
            str = x['s'] ? 'Infinity' : 'NaN';
        } else if (b === u && (xe <= TO_EXP_NEG || xe >= TO_EXP_POS)) {
            return format(x, x['c'].length - 1, 1);
        } else {
            str = x['c'].join('');
            if (xe < 0) {
                for (; ++xe; str = '0' + str) {
                }
                str = '0.' + str;
            } else if (strL = str.length, xe > 0) {
                if (++xe > strL) {
                    for (xe -= strL; xe--; str += '0') {
                    }
                } else if (xe < strL) {
                    str = str.slice(0, xe) + '.' + str.slice(xe);
                }
            } else {
                if (u = str.charAt(0), strL > 1) {
                    str = u + '.' + str.slice(1);
                } else if (u == '0') {
                    return u;
                }
            }
            if (b != null) {
                if (!(outOfRange = !(b >= 2 && b < 65)) && (b == (b | 0) || !ERRORS)) {
                    str = convert(str, b | 0, 10, x['s']);
                    if (str == '0') {
                        return str;
                    }
                } else {
                    ifExceptionsThrow(b, 'base', 'toS');
                }
            }
        }
        return x['s'] < 0 ? '-' + str : str;
    };
    P['toNumber'] = P['toN'] = function () {
        var x = this;
        return +x || (x['s'] ? 0 * x['s'] : NaN);
    };
    P['valueOf'] = P['toJSON'] = function () {
        return this['toS']();
    };
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = BigNumber;
    } else if (typeof define == 'function' && define.amd) {
        define('bignumber', [], function () {
            return BigNumber;
        });
    } else {
        global['BigNumber'] = BigNumber;
    }
}(this));
define('Profile.Model', [
    'Address.Collection',
    'SC.Configuration',
    'CreditCard.Collection',
    'Singleton',
    'underscore',
    'jQuery',
    'Backbone',
    'bignumber',
    'Utils'
], function (AddressCollection, Configuration, CreditCardsCollection, Singleton, _, jQuery, Backbone, BigNumber, Utils) {
    'use strict';
    var classProperties = _.extend({
            getPromise: function () {
                var self = this;
                if (!SC.PROFILE_PROMISE) {
                    SC.PROFILE_PROMISE = jQuery.Deferred().done(function (profile) {
                        delete SC.ENVIRONMENT.PROFILE;
                        self.getInstance().set(profile);
                    });
                }
                if (SC.ENVIRONMENT.PROFILE && SC.PROFILE_PROMISE.state() !== 'resolved') {
                    SC.PROFILE_PROMISE.resolve(SC.ENVIRONMENT.PROFILE);
                }
                return SC.PROFILE_PROMISE;
            }
        }, Singleton), ProfileModel = Backbone.Model.extend({
            validation: {
                firstname: {
                    required: true,
                    msg: _('First Name is required').translate()
                },
                lastname: {
                    required: true,
                    msg: _('Last Name is required').translate()
                },
                email: {
                    required: true,
                    pattern: 'email',
                    msg: _('Valid Email is required').translate()
                },
                phone: {
                    required: true,
                    fn: Utils.validatePhone
                },
                companyname: {
                    required: function isCompanyRequired() {
                        return Configuration.get('siteSettings.registration.companyfieldmandatory', 'F') === 'T';
                    },
                    msg: _('Company Name is required').translate()
                },
                confirm_email: function (confirm_email, attr, form) {
                    if (Utils.trim(form.email) !== this.attributes.email && Utils.trim(confirm_email) !== Utils.trim(form.email)) {
                        return _('Emails do not match').translate();
                    }
                },
                current_password: function (current_password, attr, form) {
                    if (Utils.trim(form.email) !== this.attributes.email && (_.isNull(current_password) || _.isUndefined(current_password) || _.isString(current_password) && Utils.trim(current_password) === '')) {
                        return _('Current password is required').translate();
                    }
                }
            },
            urlRoot: 'services/Profile.Service.ss',
            initialize: function initialize(attributes) {
                this.on('change:addresses', function (model, addresses) {
                    model.set('addresses', new AddressCollection(addresses), { silent: true });
                    this.get('addresses').on('change:defaultshipping change:defaultbilling add destroy reset', this.checkDefaultsAddresses, this);
                });
                this.on('change:creditcards', function (model, creditcards) {
                    model.set('creditcards', new CreditCardsCollection(creditcards), { silent: true });
                    this.get('creditcards').on('change:ccdefault add destroy reset', this.checkDefaultsCreditCard, this);
                });
                this.on('change:balance', function (model) {
                    if (_.isNumber(model.get('creditlimit')) && _.isNumber(model.get('balance'))) {
                        var balance_available;
                        if (typeof BigNumber !== 'undefined') {
                            balance_available = BigNumber(model.get('creditlimit')).minus(model.get('balance'));
                        } else {
                            balance_available = model.get('creditlimit') - model.get('balance');
                        }
                        model.set('balance_available', balance_available);
                        model.set('balance_available_formatted', Utils.formatCurrency(balance_available));
                    }
                });
                this.set('addresses', attributes && attributes.addresses || new AddressCollection());
                this.set('creditcards', attributes && attributes.creditcards || new CreditCardsCollection());
            },
            checkDefaultsAddresses: function checkDefaultsAddresses(model) {
                var addresses = this.get('addresses'), Model = addresses.model;
                if (model instanceof Model) {
                    if (model.get('defaultshipping') === 'T') {
                        _.each(addresses.where({ defaultshipping: 'T' }), function (address) {
                            if (model !== address) {
                                address.set({ defaultshipping: 'F' }, { silent: true });
                            }
                        });
                    }
                    if (model.get('defaultbilling') === 'T') {
                        _.each(addresses.where({ defaultbilling: 'T' }), function (address) {
                            if (model !== address) {
                                address.set({ defaultbilling: 'F' }, { silent: true });
                            }
                        });
                    }
                }
            },
            checkDefaultsCreditCard: function (model) {
                var creditcards = this.get('creditcards'), Model = creditcards.model;
                if (model.get('ccdefault') === 'T') {
                    _.each(creditcards.where({ ccdefault: 'T' }), function (creditCard) {
                        if (creditCard && model !== creditCard) {
                            creditCard.set({ ccdefault: 'F' }, { silent: true });
                        }
                    });
                }
                var default_creditcard = creditcards.find(function (model) {
                    return model.get('ccdefault') === 'T';
                });
                this.set('defaultCreditCard', default_creditcard || new Model({ ccdefault: 'T' }));
            },
            getSearchApiUrl: function () {
                if (Configuration.getRegistrationType() !== 'disabled' && (Configuration.get('siteSettings.requireloginforpricing', 'F') === 'T' || Configuration.get('siteSettings.siteloginrequired', 'F') === 'T') && this.get('isLoggedIn') === 'T') {
                    return Utils.getAbsoluteUrl('searchApi.ssp');
                }
                return '/api/items';
            },
            isAvoidingDoubleRedirect: function () {
                return Configuration.getRegistrationType() !== 'disabled' && (Configuration.get('siteSettings.requireloginforpricing', 'F') === 'T' || Configuration.get('siteSettings.siteloginrequired', 'F') === 'T') && this.get('isLoggedIn') === 'T';
            },
            hidePrices: function () {
                return Configuration.getRegistrationType() !== 'disabled' && Configuration.get('siteSettings.requireloginforpricing', 'F') === 'T' && this.get('isLoggedIn') !== 'T';
            }
        }, classProperties);
    return ProfileModel;
});
define('Header.Logo.View', [
    'SC.Configuration',
    'header_logo.tpl',
    'Backbone',
    'Utils'
], function (Configuration, header_logo_tpl, Backbone, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: header_logo_tpl,
        getContext: function () {
            return {
                logoUrl: Utils.getAbsoluteUrlOfNonManagedResources(Configuration.get('header.logoUrl')),
                headerLinkHref: this.options.headerLinkHref || '/',
                headerLinkTouchPoint: this.options.headerLinkTouchPoint || 'home',
                headerLinkHashtag: this.options.headerLinkHashtag || '#',
                headerLinkTitle: this.options.headerLinkTitle || SC.ENVIRONMENT.siteSettings.displayname
            };
        }
    });
});
define('Backbone.CachedSync', [
    'Backbone',
    'underscore',
    'jQuery'
], function (Backbone, _, jQuery) {
    'use strict';
    Backbone.localCache = {};
    Backbone.cacheSize = 100;
    function evictRecords() {
        var keys = _.keys(Backbone.localCache), cache_size = keys.length;
        if (cache_size > Backbone.cacheSize) {
            delete Backbone.localCache[keys[0]];
        }
    }
    Backbone.cachedSync = function (action, self, options) {
        if (action === 'read') {
            var url = _.result(this, 'url');
            if (options && options.data) {
                url += (~url.indexOf('?') ? '&' : '?') + jQuery.param(options.data);
            }
            var deferred = jQuery.Deferred();
            deferred.error = deferred.fail;
            deferred.success = deferred.done;
            deferred.success(options.success);
            deferred.error(options.error);
            delete options.success;
            delete options.error;
            options.cache = true;
            Backbone.localCache[url] = Backbone.localCache[url] || Backbone.sync.apply(this, arguments);
            Backbone.localCache[url].then(function (response, status, jqXhr) {
                response = jqXhr.responseText ? JSON.parse(jqXhr.responseText) : response;
                deferred.resolveWith(Backbone.localCache[url], [
                    response,
                    status,
                    jqXhr
                ]);
                evictRecords();
            }, function () {
                delete Backbone.localCache[url];
                deferred.rejectWith(Backbone.localCache[url], arguments);
            }, function () {
                deferred.notifyWith(Backbone.localCache[url], arguments);
            });
            return deferred;
        }
        return Backbone.sync.apply(this, arguments);
    };
    function addToCache(data, params) {
        var url = _.result(this, 'url');
        url += (~url.indexOf('?') ? '&' : '?') + jQuery.param(params || {});
        var deferred = jQuery.Deferred();
        deferred.resolveWith(this, [
            data,
            'success',
            {
                response: data,
                status: 'success',
                statusCode: '200',
                readyState: 4,
                statusText: 'OK',
                responseText: false
            }
        ]);
        Backbone.localCache[url] = deferred;
    }
    function isCached(params) {
        var url = _.result(this, 'url');
        if (params) {
            url += (~url.indexOf('?') ? '&' : '?') + jQuery.param(params);
        }
        return !!Backbone.localCache[url];
    }
    return {
        cachedSync: Backbone.cachedSync,
        addToCache: addToCache,
        isCached: isCached
    };
});
define('Backbone.CachedModel', [
    'Backbone.CachedSync',
    'Backbone'
], function (BackboneCachedSync, Backbone) {
    'use strict';
    Backbone.CachedModel = Backbone.Model.extend({
        sync: BackboneCachedSync.cachedSync,
        addToCache: BackboneCachedSync.addToCache,
        isCached: BackboneCachedSync.isCached
    });
    return Backbone.CachedModel;
});
define('UrlHelper', [
    'underscore',
    'Utils'
], function (_, Utils) {
    'use strict';
    var UrlHelper = {
        url: '',
        listeners: {},
        parameters: {},
        setUrl: function (url) {
            var self = this;
            this.url = url;
            this.parameters = {};
            _.each(this.listeners, function (fn, token) {
                var parameter_value = self.getParameterValue(token);
                if (parameter_value) {
                    var value = _.isFunction(fn) ? fn(parameter_value) : fn;
                    if (value) {
                        if (_.isBoolean(value)) {
                            self.parameters[token] = parameter_value;
                        } else {
                            self.parameters[token] = value;
                        }
                    }
                }
            });
        },
        addTokenListener: function (token, fn) {
            this.listeners[token] = fn;
        },
        getParameters: function () {
            return this.parameters;
        },
        getParameterValue: function (parameter) {
            var value = this.url.match(parameter + '{1}\\={1}(.*?[^&#]*)');
            if (value && value[1]) {
                return value[1];
            } else {
                return '';
            }
        },
        clearValues: function () {
            this.url = '';
            this.listeners = {};
            this.parameters = {};
        }
    };
    function fixUrl(url) {
        if (!new RegExp('^http').test(url)) {
            var parameters = UrlHelper.getParameters(), charValue = '', value = '';
            _.each(parameters, function (i, parameter) {
                value = url.match(new RegExp(parameter + '{1}\\={1}(.*?[^&]*)'));
                if (!value) {
                    charValue = ~url.indexOf('?') ? '&' : '?';
                    url += charValue + parameter + '=' + parameters[parameter];
                }
            });
        }
        return url;
    }
    function setUrlParameter(url, parameter, new_value) {
        var value = url.match(new RegExp(parameter + '{1}\\={1}(.*?[^(&|#)]*)')), charValue = '';
        if (value) {
            return url.replace(value[0], parameter + '=' + new_value);
        } else {
            charValue = ~url.indexOf('?') ? '&' : '?';
            return url + charValue + parameter + '=' + new_value;
        }
    }
    function removeUrlParameter(url, parameter) {
        var value = url.match(new RegExp('(\\?|&)' + parameter + '{1}\\={1}(.*?[^(&|#)]*)'));
        if (value) {
            if (~value[0].indexOf('?') && ~url.indexOf('&')) {
                return url.replace(value[0] + '&', '?');
            } else {
                return url.replace(value[0], '');
            }
        } else {
            return url;
        }
    }
    _.extend(Utils, {
        fixUrl: fixUrl,
        setUrlParameter: setUrlParameter,
        removeUrlParameter: removeUrlParameter
    });
    _.mixin(Utils);
    return _.extend(UrlHelper, {
        mountToApp: function (Application) {
            var self = this;
            Application.getLayout().on('afterAppendView', function () {
                self.setUrl(window.location.href);
            });
        }
    });
});
define('Item.KeyMapping', [
    'underscore',
    'Utils',
    'UrlHelper'
], function (_, Utils) {
    'use strict';
    function getKeyMapping(configuration) {
        return {
            _id: 'internalid',
            _sku: function (item) {
                return item.get('itemid') || '';
            },
            _name: function (item) {
                var item_id = item.get('itemid') || '';
                var parent = item.get('_matrixParent');
                if (parent.get('internalid')) {
                    var matches = item_id.match(/:(.*)/);
                    var child_name = matches && matches[1];
                    return child_name || parent.get('storedisplayname2') || parent.get('displayname') || item_id;
                }
                return item.get('storedisplayname2') || item.get('displayname') || item_id;
            },
            _pageTitle: [
                'pagetitle',
                'storedisplayname2',
                'displayname'
            ],
            _pageHeader: [
                'storedisplayname2',
                'displayname'
            ],
            _keywords: 'searchkeywords',
            _metaTags: 'metataghtml',
            _breadcrumb: function (item) {
                var breadcrumb = [], commercecategory = item.get('commercecategory');
                if (commercecategory && commercecategory.primarypath && commercecategory.primarypath.length) {
                    var primarypath = _.sortBy(commercecategory.primarypath, function (path) {
                        return path.urls[0];
                    });
                    _.each(primarypath, function (path) {
                        breadcrumb.push({
                            href: path.urls[0],
                            text: path.name
                        });
                    });
                }
                breadcrumb.push({
                    href: item.get('_url'),
                    text: item.get('_name')
                });
                return breadcrumb;
            },
            _url: function (item) {
                var matrixParent = item.get('_matrixParent');
                if (!_.isEmpty(matrixParent) && matrixParent.get('internalid')) {
                    return item.get('_matrixParent').get('_url');
                } else if (SC.ENVIRONMENT.siteType && SC.ENVIRONMENT.siteType === 'STANDARD') {
                    return item.get('canonicalurl');
                }
                return item.get('urlcomponent') ? '/' + item.get('urlcomponent') : '/product/' + item.get('internalid');
            },
            _thumbnail: function (item) {
                var item_images_detail = item.get('itemimages_detail') || {};
                if (item_images_detail.thumbnail) {
                    if (_.isArray(item_images_detail.thumbnail.urls) && item_images_detail.thumbnail.urls.length) {
                        return item_images_detail.thumbnail.urls[0];
                    }
                    return item_images_detail.thumbnail;
                }
                if (SC.ENVIRONMENT.siteType && SC.ENVIRONMENT.siteType === 'STANDARD' && item.get('storedisplaythumbnail')) {
                    return {
                        url: item.get('storedisplaythumbnail'),
                        altimagetext: item.get('_name')
                    };
                }
                var parent_item = item.get('_matrixParent');
                if (parent_item && parent_item.get('internalid')) {
                    return parent_item.get('_thumbnail');
                }
                var images = Utils.imageFlatten(item_images_detail);
                if (images.length) {
                    return images[0];
                }
                return {
                    url: Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', configuration.get('imageNotAvailable')),
                    altimagetext: item.get('_name')
                };
            },
            _images: function (item) {
                var result = [], item_images_detail = item.get('itemimages_detail') || {};
                item_images_detail = item_images_detail.media || item_images_detail;
                result = Utils.imageFlatten(item_images_detail);
                return result.length ? result : [{
                        url: Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', configuration.get('imageNotAvailable')),
                        altimagetext: item.get('_name')
                    }];
            },
            _matrixParent: 'matrix_parent',
            _matrixChilds: 'matrixchilditems_detail',
            _optionsDetails: 'itemoptions_detail',
            _relatedItems: 'related_items',
            _relatedItemsDetail: 'relateditems_detail',
            _correlatedItemsDetail: 'correlateditems_detail',
            _priceDetails: 'onlinecustomerprice_detail',
            _price: function (item) {
                return item.get('onlinecustomerprice_detail') && item.get('onlinecustomerprice_detail').onlinecustomerprice || '';
            },
            _price_formatted: function (item) {
                return item.get('onlinecustomerprice_detail') && item.get('onlinecustomerprice_detail').onlinecustomerprice_formatted || '';
            },
            _comparePriceAgainst: function (item) {
                var prices = item.get('_priceDetails');
                if (prices) {
                    if (prices.priceschedule) {
                        return prices.priceschedule[0].price;
                    } else {
                        return prices.onlinecustomerprice;
                    }
                } else {
                    return item.get('pricelevel1');
                }
            },
            _comparePriceAgainstFormated: function (item) {
                var prices = item.get('_priceDetails');
                if (prices) {
                    if (prices.priceschedule) {
                        return prices.priceschedule[0].price_formatted;
                    } else {
                        return prices.onlinecustomerprice_formatted;
                    }
                } else {
                    return item.get('pricelevel1_formatted');
                }
            },
            _itemType: 'itemtype',
            _stock: 'quantityavailable',
            _minimumQuantity: function (item) {
                return item.get('minimumquantity') || 1;
            },
            _isReturnable: function (item) {
                var type = item.get('itemtype');
                return type === 'InvtPart' || type === 'NonInvtPart' || type === 'Kit';
            },
            _isInStock: 'isinstock',
            _isPurchasable: 'ispurchasable',
            _isBackorderable: 'isbackorderable',
            _showOutOfStockMessage: 'showoutofstockmessage',
            _isfulfillable: function (item) {
                return item.get('isfulfillable') !== false;
            },
            _showInStockMessage: function () {
                return false;
            },
            _showQuantityAvailable: function () {
                return true;
            },
            _showStockDescription: function () {
                return true;
            },
            _stockDescription: 'stockdescription',
            _stockDescriptionClass: function (item) {
                return 'stock-description-' + (item.get('_stockDescription') || '').toLowerCase().replace(/[\W\"]+/g, '-').replace(/\-+/g, '-');
            },
            _outOfStockMessage: function (item) {
                return item.get('outofstockmessage2') || item.get('outofstockmessage');
            },
            _inStockMessage: function () {
                return _('In Stock').translate();
            },
            _rating: function (item) {
                return Math.round(item.get('custitem_ns_pr_rating') * 10) / 10 || 0;
            },
            _ratingsCount: function (item) {
                return item.get('custitem_ns_pr_count') || 0;
            },
            _attributesToRateOn: function (item) {
                var attributes = item.get('custitem_ns_pr_item_attributes') || '';
                return _.reject(attributes.split(', '), function (attribute) {
                    return !attribute || attribute === '&nbsp;';
                });
            },
            _attributesRating: function (item) {
                return JSON.parse(item.get('custitem_ns_pr_attributes_rating'));
            },
            _ratingsCountsByRate: function (item) {
                return item.get('custitem_ns_pr_rating_by_rate') && JSON.parse(item.get('custitem_ns_pr_rating_by_rate')) || {};
            },
            _isstorepickupallowed: 'isstorepickupallowed',
            _quantityavailableforstorepickup_detail: function (item) {
                return item.get('quantityavailableforstorepickup_detail') && item.get('quantityavailableforstorepickup_detail').locations || [];
            }
        };
    }
    return { getKeyMapping: getKeyMapping };
});
define('ProductLine.Option.Model', ['Backbone'], function (Backbone) {
    'use strict';
    return Backbone.Model.extend({
        toJSON: function toJSON() {
            return {
                cartOptionId: this.get('cartOptionId'),
                itemOptionId: this.get('itemOptionId'),
                label: this.get('label'),
                type: this.get('type'),
                value: this.get('value')
            };
        }
    });
});
define('Item.Option.Model', ['ProductLine.Option.Model'], function (ProductLineOptionModel) {
    'use strict';
    return ProductLineOptionModel.extend({});
});
define('ProductLine.Option.Collection', [
    'ProductLine.Option.Model',
    'Backbone'
], function (ProductLineOptionModel, Backbone) {
    'use strict';
    return Backbone.Collection.extend({ model: ProductLineOptionModel });
});
define('Item.Option.Collection', [
    'Item.Option.Model',
    'ProductLine.Option.Collection'
], function (ItemOptionModel, ProductLineOptionCollection) {
    'use strict';
    return ProductLineOptionCollection.extend({ model: ItemOptionModel });
});
define('Item.Model', [
    'Backbone.CachedModel',
    'Session',
    'Item.KeyMapping',
    'Item.Option.Collection',
    'SC.Configuration',
    'Profile.Model',
    'underscore',
    'Utils'
], function (BackboneCachedModel, Session, ItemKeyMapping, ItemOptionCollection, Configuration, ProfileModel, _, Utils) {
    'use strict';
    var ItemCollection = null, ItemModel = BackboneCachedModel.extend({
            moduleName: 'Item.Model',
            url: function url() {
                var profile = ProfileModel.getInstance(), url = Utils.addParamsToUrl(profile.getSearchApiUrl(), _.extend({}, this.searchApiMasterOptions, Session.getSearchApiParams()), profile.isAvoidingDoubleRedirect());
                return url;
            },
            parse: function parse(response) {
                var single_item = response.items && response.items[0];
                if (single_item) {
                    single_item.facets = response.facets;
                }
                return single_item || response;
            },
            generateURL: function generateURL() {
                return this.get('_url');
            },
            getFullLink: function getFullLink() {
                var url = this.generateURL(), link_attributes = { href: url };
                if (SC.ENVIRONMENT.siteSettings.sitetype === 'ADVANCED') {
                    _.extend(link_attributes, {
                        data: {
                            touchpoint: 'home',
                            hashtag: Configuration.get('currentTouchpoint') !== 'home' ? encodeURIComponent(url) : url
                        }
                    });
                }
                return Utils.objectToAtrributes(link_attributes);
            },
            initialize: function initialize() {
                this.searchApiMasterOptions = Configuration.get('searchApiMasterOptions.itemDetails', {});
                this.itemOptionsConfig = Configuration.get('ItemOptions.optionsConfiguration', []);
                var self = this;
                this.set('options', this.getPosibleOptions(), { silent: true });
                this.on('change:itemoptions_detail', function () {
                    self.set('options', self.getPosibleOptions(), { silent: true });
                }, this);
            },
            getPosibleOptions: function getPosibleOptions() {
                if (this.cachedPosibleOptions) {
                    return this.cachedPosibleOptions;
                }
                var result = new ItemOptionCollection();
                if (this.get('_optionsDetails') && this.get('_optionsDetails').fields) {
                    var self = this, options_config_map = {};
                    _.each(this.itemOptionsConfig, function (option) {
                        if (option.cartOptionId) {
                            options_config_map[option.cartOptionId] = option;
                        }
                    });
                    var fields = this.get('_matrixParent').get('_id') ? this.get('_matrixParent').get('_optionsDetails').fields : this.get('_optionsDetails').fields;
                    _.each(fields, function (option_details) {
                        var option = {
                            label: option_details.label,
                            values: option_details.values,
                            type: option_details.type,
                            cartOptionId: option_details.internalid,
                            itemOptionId: option_details.sourcefrom || '',
                            isMatrixDimension: !!option_details.ismatrixdimension || false,
                            isMandatory: !!option_details.ismandatory || false,
                            urlParameterName: option_details.internalid,
                            useLabelsOnUrl: false,
                            index: 10
                        };
                        _.each(option.values, function (value) {
                            value.isAvailable = true;
                        });
                        if (options_config_map[option.cartOptionId]) {
                            option = _.extend(option, options_config_map[option.cartOptionId]);
                        }
                        option.values = _.map(option.values, function (value) {
                            value.url = Utils.setUrlParameter(self.get('_url'), option.urlParameterName, option.useLabelsOnUrl ? value.label : value.internalid);
                            return value;
                        });
                        if (option_details.ismatrixdimension && self.get('_matrixChilds').length) {
                            var item_values = self.get('_matrixChilds').pluck(option.itemOptionId);
                            option.values = _.filter(option.values, function (value) {
                                if (value.internalid) {
                                    return _.contains(item_values, value.label);
                                }
                                return true;
                            });
                        }
                        result.add(option);
                    });
                    this.cachedPosibleOptions = result;
                }
                return result;
            },
            isProperlyConfigured: function isProperlyConfigured() {
                var options = this.getPosibleOptions(), option = null;
                if (options && options.length) {
                    for (var i = 0; i < options.length; i++) {
                        option = options.at(i);
                        if (option.get('isMatrixDimension') && !option.get('itemOptionId')) {
                            return false;
                        }
                    }
                } else if (this.get('_matrixChilds') && this.get('_matrixChilds').length) {
                    return false;
                }
                return true;
            },
            getKeyMapping: function getKeyMapping() {
                if (!this._keyMapping) {
                    this._keyMapping = _.defaults(Configuration.itemKeyMapping || {}, ItemKeyMapping.getKeyMapping(Configuration));
                }
                return this._keyMapping;
            },
            get: function get(attr, dont_cache) {
                var keyMapping = this.getKeyMapping();
                if (dont_cache || keyMapping && !this.attributes[attr] && keyMapping[attr]) {
                    var mapped_key = keyMapping[attr];
                    if (_.isFunction(mapped_key)) {
                        this.attributes[attr] = mapped_key(this);
                    } else if (_.isArray(mapped_key)) {
                        for (var i = 0; i < mapped_key.length; i++) {
                            if (this.attributes[mapped_key[i]]) {
                                this.attributes[attr] = this.attributes[mapped_key[i]];
                                break;
                            }
                        }
                    } else {
                        this.attributes[attr] = this.attributes[mapped_key];
                    }
                    if (attr === '_matrixChilds' || attr === '_relatedItems') {
                        ItemCollection = ItemCollection || Utils.requireModules('Item.Collection');
                        if (!(this.attributes[attr] instanceof ItemCollection)) {
                            this.attributes[attr] = new ItemCollection(this.attributes[attr] || []);
                        }
                    } else if (attr === '_matrixParent') {
                        if (!(this.attributes[attr] instanceof ItemModel)) {
                            this.attributes[attr] = new ItemModel(this.attributes[attr] || {});
                        }
                    }
                }
                return this.attributes[attr];
            },
            getDefaultPrice: function getDefaultPrice(details_object) {
                return {
                    price: details_object.onlinecustomerprice,
                    price_formatted: details_object.onlinecustomerprice_formatted
                };
            },
            getPrice: function getPrice(quantity, selected_matrix_children) {
                selected_matrix_children = selected_matrix_children || (this.get('_matrixChilds') ? this.get('_matrixChilds').models : []);
                quantity = quantity || 1;
                var details_object = this.get('_priceDetails') || {}, result = this.getDefaultPrice(details_object);
                if (details_object.priceschedule && details_object.priceschedule.length) {
                    var price_schedule, min, max;
                    for (var i = 0; i < details_object.priceschedule.length; i++) {
                        price_schedule = details_object.priceschedule[i];
                        min = parseInt(price_schedule.minimumquantity, 10);
                        max = parseInt(price_schedule.maximumquantity, 10);
                        if (min <= quantity && quantity < max || min <= quantity && !max) {
                            result = {
                                price: price_schedule.price,
                                price_formatted: price_schedule.price_formatted
                            };
                        }
                    }
                }
                if (selected_matrix_children.length) {
                    var children_prices = [];
                    _.each(selected_matrix_children, function (child) {
                        children_prices.push(child.getPrice(quantity));
                    });
                    if (children_prices.length === 1) {
                        result = children_prices[0];
                    } else {
                        var children_prices_values = _.pluck(children_prices, 'price'), min_value = _.min(children_prices_values), max_value = _.max(children_prices_values);
                        if (min_value !== max_value) {
                            result.min = _.where(children_prices, { price: min_value })[0];
                            result.max = _.where(children_prices, { price: max_value })[0];
                        } else {
                            result = children_prices[0];
                        }
                    }
                }
                if (!result.compare_price && this.get('_comparePriceAgainst')) {
                    result.compare_price = this.get('_comparePriceAgainst');
                    result.compare_price_formatted = this.get('_comparePriceAgainstFormated');
                }
                return result;
            },
            getThumbnail: function getThumbnail() {
                return this.get('_thumbnail');
            },
            getSku: function getSku() {
                return this.get('_sku');
            },
            getImages: function getImages() {
                var result = [], item_images_detail = this.get('itemimages_detail') || {};
                item_images_detail = item_images_detail.media || item_images_detail;
                result = Utils.imageFlatten(item_images_detail);
                return result.length ? result : [{
                        url: Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', Configuration.get('imageNotAvailable')),
                        altimagetext: this.get('_name')
                    }];
            },
            getOption: function getOption(cart_option_id) {
                return this.get('options').findWhere({ cartOptionId: cart_option_id });
            },
            getStockInfo: function getStockInfo(selected_matrix_children, options_selection) {
                options_selection = options_selection || {};
                selected_matrix_children = selected_matrix_children || [];
                var model = selected_matrix_children.length === 1 ? selected_matrix_children[0] : this, parent = this.get('_matrixParent'), stock_info = {
                        stock: model.get('_stock'),
                        isInStock: model.get('_isInStock'),
                        outOfStockMessage: model.get('_outOfStockMessage') || this.get('_outOfStockMessage') || parent && parent.get('_outOfStockMessage') || _('Out of Stock').translate(),
                        showOutOfStockMessage: model.get('_showOutOfStockMessage') || this.get('_showOutOfStockMessage'),
                        inStockMessage: model.get('_inStockMessage'),
                        showInStockMessage: model.get('_showInStockMessage'),
                        stockDescription: model.get('_stockDescription') || this.get('_stockDescription'),
                        showStockDescription: model.get('_showStockDescription'),
                        stockDescriptionClass: model.get('_stockDescriptionClass'),
                        isNotAvailableInStore: _.isUndefined(model.get('_isPurchasable')),
                        stockPerLocation: model.get('_quantityavailableforstorepickup_detail'),
                        isAvailableForPickup: !!model.get('_isstorepickupallowed'),
                        showQuantityAvailable: !!model.get('_showQuantityAvailable')
                    }, is_something_selected = _(options_selection).keys().length;
                if (is_something_selected && selected_matrix_children.length > 1) {
                    var matrix_children_stock_info = [];
                    _.each(selected_matrix_children, function (child) {
                        matrix_children_stock_info.push(child.getStockInfo());
                    });
                    _.each(stock_info, function (value, key) {
                        var children_values_for_attribute = _.pluck(matrix_children_stock_info, key);
                        if (key === 'stock') {
                            stock_info.stock = _.reduce(children_values_for_attribute, function (memo, num) {
                                return memo + num;
                            }, 0);
                            if (isNaN(stock_info.stock)) {
                                delete stock_info.stock;
                            }
                        } else if (key === 'isInStock') {
                            stock_info.isInStock = _.contains(children_values_for_attribute, true);
                        } else {
                            children_values_for_attribute = _.uniq(children_values_for_attribute);
                            if (children_values_for_attribute.length === 1) {
                                stock_info[key] = children_values_for_attribute[0];
                            }
                        }
                    });
                }
                return stock_info;
            }
        });
    return ItemModel;
});
define('Transaction.Line.Option.Model', ['ProductLine.Option.Model'], function (ProductLineOptionModel) {
    'use strict';
    return ProductLineOptionModel.extend({});
});
define('Transaction.Line.Option.Collection', [
    'Transaction.Line.Option.Model',
    'ProductLine.Option.Collection'
], function (TransactionLineOptionModel, ProductLineOptionCollection) {
    'use strict';
    return ProductLineOptionCollection.extend({ model: TransactionLineOptionModel });
});
define('ProductLine.Common.Url', [
    'underscore',
    'Utils',
    'PluginContainer',
    'SC.Configuration'
], function (_, utils, PluginContainer, Configuration) {
    'use strict';
    var ProductLineCommonUrl = {
        attributesReflectedInURL: [
            'options',
            'quantity'
        ],
        preURLGenerated: new PluginContainer(),
        preItemSetFromURL: new PluginContainer(),
        getQuery: function getQuery(parameters_to_override) {
            var query = '', line_model = this, attributes_to_map_in_url = _.filter(_.keys(line_model.attributes), function (attribute) {
                    return !!~_.indexOf(ProductLineCommonUrl.attributesReflectedInURL, attribute);
                }), all_parameters = _.map(attributes_to_map_in_url, function (attribute) {
                    return {
                        param: attribute,
                        value: line_model.get(attribute)
                    };
                });
            all_parameters = this.mapOptionsToURLParameters(all_parameters);
            all_parameters = ProductLineCommonUrl.preURLGenerated.executeAll(all_parameters, this) || all_parameters;
            _.each(parameters_to_override || {}, function (value, parameter) {
                var selected_parameter = _.findWhere(all_parameters, { param: parameter });
                if (selected_parameter) {
                    if (_.isNull(value)) {
                        all_parameters.splice(_.indexOf(all_parameters, selected_parameter), 1);
                    } else {
                        selected_parameter.value = value;
                    }
                } else if (!_.isNull(value)) {
                    all_parameters.push({
                        param: parameter,
                        value: value
                    });
                }
            });
            var params_to_set = _.filter(all_parameters, _.property('value'));
            query = _.reduce(params_to_set, function (memo_url, option) {
                return utils.setUrlParameter(memo_url, option.param, encodeURIComponent(option.value));
            }, query);
            return query;
        },
        generateURL: function generateURL(parameters_to_override) {
            return this.get('item').get('_url') + this.getQuery(parameters_to_override);
        },
        mapOptionsToURLParameters: function mapOptionsToURLParameters(all_parameters) {
            var options_parameter = _.findWhere(all_parameters, { param: 'options' });
            if (options_parameter) {
                all_parameters.splice(_.indexOf(all_parameters, options_parameter), 1);
                this.get('options').each(function (option) {
                    if (option.get('value')) {
                        all_parameters.push({
                            param: option.get('urlParameterName'),
                            value: option.get('useLabelsOnUrl') ? option.get('value').label : option.get('value').internalid
                        });
                    }
                });
            }
            return all_parameters;
        },
        getFullLink: function getFullLink(parameters_to_override) {
            var url = this.generateURL(parameters_to_override), link_attributes = { href: url };
            if (SC.ENVIRONMENT.siteSettings.sitetype === 'ADVANCED') {
                _.extend(link_attributes, {
                    data: {
                        touchpoint: 'home',
                        hashtag: Configuration.get('currentTouchpoint') !== 'home' ? encodeURIComponent(url) : url
                    }
                });
            }
            return utils.objectToAtrributes(link_attributes);
        },
        setOptionsFromURL: function setOptionsFromURL(options) {
            var self = this;
            options = options || {};
            options = this.mapURLParametersToOptions(options);
            options.quantity && (options.quantity = parseInt(options.quantity, 10));
            options = ProductLineCommonUrl.preItemSetFromURL.executeAll(options, self) || options;
            _.each(options, function (value, name) {
                if (value && !!~_.indexOf(ProductLineCommonUrl.attributesReflectedInURL, name)) {
                    self.set(name, value);
                }
            });
        },
        mapURLParametersToOptions: function mapURLParametersToOptions(url_parameters) {
            var self = this;
            this.get('options').each(function (option) {
                if (url_parameters[option.get('urlParameterName')]) {
                    var aux_param_value = url_parameters[option.get('urlParameterName')], selected_option_value;
                    delete url_parameters[option.get('urlParameterName')];
                    if (option.get('useLabelsOnUrl')) {
                        selected_option_value = _.findWhere(option.get('values'), { label: aux_param_value });
                        url_parameters[option.get('cartOptionId')] = selected_option_value ? selected_option_value.internalid : aux_param_value;
                    } else {
                        url_parameters[option.get('cartOptionId')] = aux_param_value;
                    }
                    self.setOption(option.get('cartOptionId'), url_parameters[option.get('cartOptionId')]);
                }
            });
            return url_parameters;
        }
    };
    return ProductLineCommonUrl;
});
define('ProductLine.Common.Image', [
    'SC.Configuration',
    'underscore',
    'Utils'
], function (Configuration, _, Utils) {
    'use strict';
    return {
        filterImages: function filterImages(item_images_detail, image_option_filters) {
            var self = this, images_container = item_images_detail, selected_option_filter;
            _.each(image_option_filters, function (image_filter) {
                selected_option_filter = self.get('options').findWhere({ cartOptionId: image_filter });
                if (selected_option_filter && selected_option_filter.get('value') && selected_option_filter.get('value').label) {
                    var label = selected_option_filter.get('value').label.toLowerCase();
                    _.each(images_container, function (value, key) {
                        if (key.toLowerCase() === label) {
                            images_container = value;
                        }
                    });
                }
            });
            return images_container;
        },
        getThumbnail: function getThumbnail() {
            var item = this.get('item'), item_images_detail = item.get('itemimages_detail') || {}, image_filters = Configuration.get('productline.multiImageOption', []), images = [], images_container = {};
            if (_.isEqual(item_images_detail, {}) && item.get('_matrixParent').get('internalid') && item.get('_matrixParent').get('itemimages_detail')) {
                item_images_detail = item.get('_matrixParent').get('itemimages_detail');
            }
            if (item_images_detail.thumbnail) {
                images_container = this.filterImages(item_images_detail.thumbnail, image_filters);
                images = Utils.imageFlatten(images_container);
                return _.first(images) || item_images_detail.thumbnail;
            } else if (SC.ENVIRONMENT.siteType === 'STANDARD') {
                return item.getThumbnail();
            } else {
                item_images_detail = item_images_detail.media || item_images_detail;
                images_container = this.filterImages(item_images_detail, image_filters);
                images = Utils.imageFlatten(images_container);
                return images.length ? _.first(images) : {
                    url: Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', Configuration.get('imageNotAvailable')),
                    altimagetext: item.get('_name')
                };
            }
        }
    };
});
define('ProductLine.Common', [
    'ProductLine.Common.Url',
    'ProductLine.Common.Image',
    'SC.Configuration',
    'underscore'
], function (ProductLineCommonUrl, ProductLineCommonImage, Configuration, _) {
    'use strict';
    var ProductLineCommon = {
        getSku: function getSku() {
            return this.getItem().getSku();
        },
        getOption: function getOption(cart_option_id) {
            return this.get('options').findWhere({ cartOptionId: cart_option_id });
        },
        getVisibleOptions: function getVisibleOptions() {
            var collection;
            if (Configuration.get('ItemOptions.showOnlyTheListedOptions')) {
                collection = this.get('options').filter(function (option) {
                    return _.find(Configuration.get('ItemOptions.optionsConfiguration'), function (optionConfiguration) {
                        return optionConfiguration.cartOptionId === option.get('cartOptionId');
                    });
                });
            } else {
                collection = this.get('options').models;
            }
            return _.sortBy(collection, function (option) {
                return option.get('index');
            });
        },
        extendOptionsFromItem: function extendOptionsFromItem(item, productline) {
            item.get('options').each(function (item_option) {
                var item_option_cartId = item_option.get('cartOptionId').toLowerCase(), productline_option = productline.get('options').find(function (product_option) {
                        return product_option.get('cartOptionId').toLowerCase() === item_option_cartId;
                    });
                if (productline_option) {
                    productline_option.attributes = _.extend({}, productline_option.attributes, item_option.attributes);
                }
            });
        },
        toJSON: function toJSON() {
            return {
                item: {
                    internalid: this.getItemId(),
                    type: this.attributes.item.get('itemtype')
                },
                quantity: this.attributes.quantity,
                internalid: this.attributes.internalid,
                options: this.get('options').toJSON(),
                shipaddress: this.attributes.shipaddress,
                shipmethod: this.attributes.shipmethod,
                location: this.attributes.location && this.attributes.location.attributes && this.attributes.location.attributes.internalid || '',
                fulfillmentChoice: this.attributes.fulfillmentChoice || 'ship'
            };
        }
    };
    return _.extend(ProductLineCommon, ProductLineCommonUrl, ProductLineCommonImage);
});
define('Transaction.Line.Model', [
    'Item.Model',
    'Transaction.Line.Option.Collection',
    'ProductLine.Common',
    'SC.Configuration',
    'underscore',
    'Backbone'
], function (ItemModel, TransactionLineOptionCollection, ProductLineCommon, Configuration, _, Backbone) {
    'use strict';
    var TransactionLineModel = Backbone.Model.extend({
        initialize: function initialize(attributes) {
            Backbone.Model.prototype.initialize.apply(this, arguments);
            var self = this;
            this.on('change:item', function (model, item) {
                model.set('item', item instanceof ItemModel ? item.clone() : new ItemModel(item), { silent: true });
                var item_options = model.get('item').get('options'), options = model.get('options') || item_options.toJSON();
                model.set('options', options instanceof TransactionLineOptionCollection ? options : new TransactionLineOptionCollection(options), { silent: true });
                self.extendOptionsFromItem(model.get('item'), self);
            });
            this.trigger('change:item', this, attributes && attributes.item || {});
            _.extend(this, Backbone.Validation.mixin);
        },
        moduleName: 'Transaction.Line.Model',
        getItem: function getItem() {
            return this.get('item');
        },
        getStockInfo: function getStockInfo() {
            return this.get('item').getStockInfo();
        },
        getPrice: function getPrice() {
            return this.getItem().getPrice(this.get('quantity'), []);
        },
        getItemId: function getItemId() {
            return this.get('item').id;
        },
        isEqual: function isEqual(other_line) {
            return !!(other_line && this.getItemId() === other_line.getItemId() && _.isEqual(this.get('options').toJSON(), other_line.get('options').toJSON()));
        }
    }, {
        createFromProduct: function createFromProduct(product) {
            var line = new TransactionLineModel(product.toJSON()), item = product.get('item'), item_images_detail = item.get('itemimages_detail'), is_matrix_item = !!item.get('_matrixChilds').length;
            if (_.isEqual(item_images_detail, {}) && item.get('_matrixParent').get('internalid') && item.get('_matrixParent').get('itemimages_detail')) {
                item_images_detail = item.get('_matrixParent').get('itemimages_detail');
            }
            line.set('item', product.getItem().clone(), { silent: true });
            line.get('item').set('itemimages_detail', item_images_detail, { silent: true });
            line.get('item').set('itemid', item.get('itemid'), { silent: true });
            line.set('minimumquantity', product.get('item').minimumquantity);
            if (is_matrix_item) {
                line.get('item').set('matrix_parent', product.get('item'));
            }
            var price = product.getPrice();
            line.set('rate', price.price, { silent: true });
            line.set('rate_formatted', price.price_formatted, { silent: true });
            product.get('options').each(function (product_option) {
                var line_option = line.get('options').findWhere({ cartOptionId: product_option.get('cartOptionId') });
                line_option.attributes = _.extend({}, product_option.attributes, line_option.attributes);
            });
            return line;
        }
    });
    TransactionLineModel.prototype = _.extend(TransactionLineModel.prototype, ProductLineCommon);
    return TransactionLineModel;
});
define('Transaction.Line.Collection', [
    'Transaction.Line.Model',
    'Backbone'
], function (TransactionLineModel, Backbone) {
    'use strict';
    return Backbone.Collection.extend({ model: TransactionLineModel });
});
define('Transaction.Shipmethod.Model', ['Backbone'], function (Backbone) {
    'use strict';
    return Backbone.Model.extend({
        getFormattedShipmethod: function () {
            return this.get('name');
        }
    });
});
define('Transaction.Shipmethod.Collection', [
    'Transaction.Shipmethod.Model',
    'Backbone'
], function (TransactionShipmethodModel, Backbone) {
    'use strict';
    return Backbone.Collection.extend({
        model: TransactionShipmethodModel,
        comparator: 'name'
    });
});
define('Transaction.Paymentmethod.Model', ['Backbone'], function (Backbone) {
    'use strict';
    return Backbone.Model.extend({
        getFormattedPaymentmethod: function () {
            return this.get('type');
        }
    });
});
define('Transaction.Paymentmethod.Collection', [
    'Transaction.Paymentmethod.Model',
    'Backbone'
], function (TransactionPaymentmethodModel, Backbone) {
    'use strict';
    return Backbone.Collection.extend({ model: TransactionPaymentmethodModel });
});
define('Transaction.Model', [
    'Transaction.Line.Collection',
    'Transaction.Shipmethod.Collection',
    'Transaction.Paymentmethod.Collection',
    'Address.Collection',
    'CreditCard.Collection',
    'underscore',
    'Backbone',
    'Backbone.CachedSync'
], function (TransactionLineCollection, TransactionShipmethodCollection, TransactionPaymentmethodCollection, AddressesCollection, CreditCardsCollection, _, Backbone, BackboneCachedSync) {
    'use strict';
    return Backbone.Model.extend({
        linesCollection: TransactionLineCollection,
        defaults: {
            'addresses': null,
            'shipmethods': null
        },
        cacheSupport: false,
        initialize: function (attributes) {
            if (this.cacheSupport) {
                var self = this;
                _.each(BackboneCachedSync, function (fn, name) {
                    self[name === 'cachedSync' ? 'sync' : name] = fn;
                });
            }
            this.on('change:lines', function (model, lines) {
                if (model.previous('lines') instanceof model.linesCollection) {
                    model.set('lines', model.previous('lines'), { silent: true });
                    model.get('lines').reset(lines instanceof model.linesCollection ? lines.clone() : lines);
                } else {
                    model.set('lines', new model.linesCollection(lines), { silent: true });
                }
            });
            this.trigger('change:lines', this, attributes && attributes.lines || []);
            this.on('change:shipmethods', function (model, shipmethods) {
                if (model.previous('shipmethods') instanceof TransactionShipmethodCollection) {
                    model.set('shipmethods', model.previous('shipmethods'), { silent: true });
                    model.get('shipmethods').reset(shipmethods instanceof TransactionShipmethodCollection ? shipmethods.clone() : shipmethods);
                } else {
                    model.set('shipmethods', new TransactionShipmethodCollection(shipmethods), { silent: true });
                }
            });
            this.trigger('change:shipmethods', this, attributes && attributes.shipmethods || []);
            this.on('change:paymentmethods', function (model, paymentmethods) {
                if (model.previous('paymentmethods') instanceof TransactionPaymentmethodCollection) {
                    model.set('paymentmethods', model.previous('paymentmethods'), { silent: true });
                    model.get('paymentmethods').reset(paymentmethods instanceof TransactionPaymentmethodCollection ? paymentmethods.clone() : paymentmethods);
                } else {
                    model.set('paymentmethods', new TransactionPaymentmethodCollection(paymentmethods), { silent: true });
                }
            });
            this.trigger('change:paymentmethods', this, attributes && attributes.paymentmethods || []);
            this.on('change:addresses', function (model, addresses) {
                if (model.previous('addresses') instanceof AddressesCollection) {
                    model.set('addresses', model.previous('addresses'), { silent: true });
                    model.get('addresses').reset(addresses instanceof AddressesCollection ? addresses.clone() : addresses);
                } else {
                    model.set('addresses', new AddressesCollection(addresses), { silent: true });
                }
            });
            this.trigger('change:addresses', this, attributes && attributes.addresses || []);
        },
        _submit: function () {
            this.set('internalid', null);
            var creditcard = this.get('paymentmethods').findWhere({ type: 'creditcard' }), paypal = this.get('paymentmethods').findWhere({ type: 'paypal' });
            if (creditcard && !creditcard.get('creditcard')) {
                this.get('paymentmethods').remove(creditcard);
            }
            if (paypal && !paypal.get('complete')) {
                this.get('paymentmethods').remove(paypal);
            }
            if (_.isFunction(this.shippingAddressIsRequired) && !this.shippingAddressIsRequired()) {
                this.unset('shipaddress', { silent: true });
                this.set('sameAs', false, { silent: true });
            }
            return this.save();
        }
    });
});
define('LiveOrder.Line.Model', [
    'Transaction.Line.Model',
    'underscore',
    'Utils'
], function (TransactionLineModel, _) {
    'use strict';
    var LiveOrderLineModel = TransactionLineModel.extend({
        urlRoot: _.getAbsoluteUrl('services/LiveOrder.Line.Service.ss'),
        initialize: function initialize() {
            TransactionLineModel.prototype.initialize.apply(this, arguments);
            this.on('error', function (model, jqXhr) {
                var result = JSON.parse(jqXhr.responseText), error_details = result.errorDetails;
                if (error_details && error_details.status === 'LINE_ROLLBACK') {
                    model.set('internalid', error_details.newLineId);
                }
            });
        },
        toJSON: function toJSON() {
            return {
                item: {
                    internalid: this.getItemId(),
                    type: this.attributes.item.get('itemtype')
                },
                quantity: this.attributes.quantity,
                internalid: this.attributes.internalid,
                options: this.get('options').toJSON(),
                splitquantity: this.attributes.splitquantity,
                shipaddress: this.attributes.shipaddress,
                shipmethod: this.attributes.shipmethod,
                location: this.attributes.location && this.attributes.location.attributes && this.attributes.location.attributes.internalid || '',
                fulfillmentChoice: this.attributes.fulfillmentChoice || 'ship'
            };
        },
        isEqual: function isEqual(other_line) {
            return !!(other_line && this.getItemId() === other_line.getItemId() && _.isEqual(this.get('options').toJSON(), other_line.get('options').toJSON()) && (this.get('location') && this.get('location').get('internalid')) === (other_line.get('location') && other_line.get('location').get('internalid')) && this.get('fulfillmentChoice') === other_line.get('fulfillmentChoice'));
        }
    }, {
        createFromProduct: function createFromProduct(product) {
            var line = new LiveOrderLineModel(product.toJSON()), item = product.get('item'), item_images_detail = item.get('itemimages_detail'), is_matrix_item = !!item.get('_matrixChilds').length;
            if (_.isEqual(item_images_detail, {}) && item.get('_matrixParent').get('internalid') && item.get('_matrixParent').get('itemimages_detail')) {
                item_images_detail = item.get('_matrixParent').get('itemimages_detail');
            }
            line.set('item', product.getItem().clone(), { silent: true });
            line.get('item').set('itemimages_detail', item_images_detail, { silent: true });
            line.get('item').set('itemid', item.get('itemid'), { silent: true });
            line.set('rate_formatted', product.getPrice().price_formatted, { silent: true });
            product.get('options').each(function (product_option) {
                var line_option = line.get('options').findWhere({ cartOptionId: product_option.get('cartOptionId') });
                line_option.attributes = _.extend({}, product_option.attributes, line_option.attributes);
            });
            if (is_matrix_item) {
                line.get('item').set('matrix_parent', product.get('item'));
            }
            return line;
        }
    });
    return LiveOrderLineModel;
});
define('LiveOrder.Line.Collection', [
    'Transaction.Line.Collection',
    'LiveOrder.Line.Model',
    'underscore',
    'Utils'
], function (TransactionLineCollection, LiveOrderLineModel, _) {
    'use strict';
    return TransactionLineCollection.extend({
        model: LiveOrderLineModel,
        url: _.getAbsoluteUrl('services/LiveOrder.Line.Service.ss')
    });
});
define('jQuery.ajaxSetup', [
    'jQuery',
    'underscore',
    'Utils'
], function (jQuery, _) {
    'use strict';
    var mouse_position = {
        top: 0,
        left: 0
    };
    jQuery(document).ready(function () {
        var $body = jQuery(document.body), $loading_icon = jQuery('#loadingIndicator');
        if (!$loading_icon.length && !(SC && SC.ENVIRONMENT && SC.ENVIRONMENT.isTouchEnabled)) {
            $loading_icon = jQuery('<img/>', {
                id: 'loadingIndicator',
                'class': 'global-loading-indicator',
                src: _.getThemeAbsoluteUrlOfNonManagedResources('img/ajax-loader.gif'),
                css: {
                    zIndex: 9999,
                    position: 'absolute'
                }
            }).hide();
            if (!_.result(SC, 'isPageGenerator')) {
                $loading_icon.appendTo($body);
            }
        }
        SC.$loadingIndicator = $loading_icon;
        var icon_height = 16, icon_width = 16;
        $body.on({
            mousemove: _.throttle(function (e) {
                mouse_position = {
                    top: Math.min($body.innerHeight() - icon_height, e.pageY + icon_width),
                    left: Math.min($body.innerWidth() - icon_width, e.pageX + icon_height)
                };
                $loading_icon.filter(':visible').css(mouse_position);
            }, 50),
            resize: _.throttle(function () {
                var icon_offset = $loading_icon.offset();
                if (!icon_offset) {
                    return;
                }
                mouse_position = {
                    top: Math.min($body.innerHeight() - icon_height, icon_offset.top),
                    left: Math.min($body.innerWidth() - icon_width, icon_offset.left)
                };
                $loading_icon.filter(':visible').css(mouse_position);
            }, 50)
        });
    });
    SC.loadingIndicatorShow = function () {
        SC.$loadingIndicator && SC.$loadingIndicator.css(mouse_position).show();
    };
    SC.loadingIndicatorHide = function () {
        SC.$loadingIndicator && SC.$loadingIndicator.hide();
    };
    var $document = jQuery(document).ajaxStart(SC.loadingIndicatorShow).ajaxStop(SC.loadingIndicatorHide);
    if (_.result(SC.ENVIRONMENT, 'SENSORS_ENABLED')) {
        $document.ajaxStop(function () {
            if (typeof window.NLRUM !== 'undefined') {
                window.NLRUM.mark('done');
            }
        });
    }
    jQuery.ajaxSetup({
        beforeSend: function (jqXhr, options) {
            if (!~options.contentType.indexOf('charset')) {
                jqXhr.setRequestHeader('Content-Type', options.contentType + '; charset=UTF-8');
            }
            if (!SC.dontSetRequestHeaderTouchpoint) {
                jqXhr.setRequestHeader('X-SC-Touchpoint', SC.ENVIRONMENT.SCTouchpoint);
            }
        }
    });
});
define('AjaxRequestsKiller', [
    'underscore',
    'jQuery',
    'Backbone',
    'jQuery.ajaxSetup'
], function (_, jQuery, Backbone) {
    'use strict';
    var killerId, lambsToBeKilled;
    return {
        getKillerId: function () {
            return killerId;
        },
        getLambsToBeKilled: function () {
            return lambsToBeKilled;
        },
        mountToApp: function (application) {
            killerId = _.uniqueId('ajax_killer_');
            lambsToBeKilled = [];
            jQuery.ajaxSettings.beforeSend = _.wrap(jQuery.ajaxSettings.beforeSend, function (fn, jqXhr, options) {
                if (options.killerId) {
                    jqXhr.killerId = options.killerId;
                    lambsToBeKilled.push(jqXhr);
                }
                fn.apply(this, _.toArray(arguments).slice(1));
            });
            application.on('afterStart', function () {
                Backbone.history.on('all', function () {
                    _.each(lambsToBeKilled, function (prev_jqXhr) {
                        if (killerId && killerId !== prev_jqXhr.killerId) {
                            if (prev_jqXhr.readyState !== 4) {
                                prev_jqXhr.preventDefault = true;
                                prev_jqXhr.abort();
                            }
                            lambsToBeKilled = _.without(lambsToBeKilled, prev_jqXhr);
                        }
                    });
                    killerId = _.uniqueId('ajax_killer_');
                });
            });
        }
    };
});
define('Tracker', [
    'Singleton',
    'underscore',
    'Backbone'
], function (Singleton, _, Backbone) {
    'use strict';
    var Tracker = function () {
        this.trackers = [];
        this.trackOnce = {};
    };
    Tracker.prototype.track = function (method) {
        var parameters = Array.prototype.slice.call(arguments, 1);
        _.each(this.trackers, function (tracker) {
            tracker[method] && tracker[method].apply(tracker, parameters);
        });
        return this;
    };
    Tracker.prototype.trackPageview = function (url) {
        if (this.trackOnce.pageView !== url) {
            this.trackOnce = { 'pageView': url };
            return this.track('trackPageview', url);
        }
        return this;
    };
    Tracker.prototype.trackAddToCart = function (line, event) {
        return this.track('trackEvent', event || {
            category: 'add-to-cart',
            action: 'button',
            label: line.generateURL(),
            value: 1
        }).track('trackAddToCart', line);
    };
    Tracker.prototype.trackGenericEvent = function () {
        return this.track('trackGenericEvent', arguments);
    };
    Tracker.prototype.trackEvent = function (event) {
        this.track('trackEvent', event);
        if (event.callback) {
            var doCallback = _.find(this.trackers, function (tracker) {
                return tracker.doCallback();
            });
            !doCallback && event.callback();
        }
        return this;
    };
    Tracker.prototype.trackTransaction = function (transaction, event) {
        return this.track('trackEvent', event || {
            category: 'place-order',
            action: 'button',
            label: '',
            value: 1
        }).track('trackTransaction', transaction);
    };
    Tracker.prototype.trackViewCart = function (cart) {
        return this.track('trackViewCart', cart);
    };
    Tracker.prototype.trackProductList = function (items, listName) {
        var options = _.parseUrlOptions(Backbone.history.fragment), key = options.keywords || '';
        listName = listName || (key ? 'Search Results' : 'Category');
        if (!this.trackOnce[listName]) {
            this.trackOnce[listName] = true;
            return this.track('trackProductList', items, listName);
        }
        return this;
    };
    Tracker.prototype.trackProductClick = function (item) {
        if (!this.trackOnce['click_' + item.get('name')]) {
            this.trackOnce['click_' + item.get('name')] = true;
            return this.track('trackProductClick', item);
        }
        return this;
    };
    Tracker.prototype.trackProductView = function (product) {
        if (!this.trackOnce['view_' + product.getSku()]) {
            this.trackOnce['view_' + product.getSku()] = true;
            return this.track('trackProductView', product);
        }
        return this;
    };
    Tracker.prototype.addCrossDomainParameters = function (url) {
        _.each(this.trackers, function (tracker) {
            if (tracker.addCrossDomainParameters) {
                url = tracker.addCrossDomainParameters(url);
            }
        });
        return url;
    };
    return _.extend(Tracker, Singleton, Backbone.Events);
});
define('LiveOrder.Model', [
    'Transaction.Model',
    'Transaction.Shipmethod.Collection',
    'LiveOrder.Line.Collection',
    'LiveOrder.Line.Model',
    'Profile.Model',
    'Session',
    'Singleton',
    'AjaxRequestsKiller',
    'SC.Configuration',
    'Utils',
    'underscore',
    'jQuery',
    'Tracker'
], function (TransactionModel, TransactionShipmethodCollection, LiveOrderLineCollection, LiveOrderLineModel, ProfileModel, Session, Singleton, AjaxRequestsKiller, Configuration, Utils, _, jQuery, Tracker) {
    'use strict';
    var ClassProperties = _.extend({
        loadCart: function () {
            if (_.result(SC, 'isPageGenerator')) {
                return jQuery.Deferred().resolve();
            }
            var cart_instance = this.getInstance();
            if (cart_instance.cartLoad) {
                if (cart_instance.isLoading) {
                    cart_instance.isLoading = false;
                }
            } else {
                cart_instance.cartLoad = jQuery.Deferred();
                ProfileModel.getPromise().done(function () {
                    cart_instance.fetch().done(function () {
                        cart_instance.cartLoad.resolve.apply(this, arguments);
                    }).fail(function () {
                        cart_instance.cartLoad.reject.apply(this, arguments);
                    }).always(function () {
                        if (cart_instance.isLoading) {
                            cart_instance.isLoading = false;
                        }
                    });
                });
            }
            return cart_instance.cartLoad;
        }
    }, Singleton);
    var LiveOrderModel = TransactionModel.extend({
        urlRoot: Utils.getAbsoluteUrl('services/LiveOrder.Service.ss'),
        linesCollection: LiveOrderLineCollection,
        validation: { zip: { fn: Utils.validateZipCode } },
        url: function url() {
            var base_url = TransactionModel.prototype.url.apply(this, arguments);
            return base_url + (base_url.indexOf('?') > 0 ? '&' : '?') + 't=' + new Date().getTime();
        },
        initialize: function initialize(attributes) {
            TransactionModel.prototype.initialize.apply(this, arguments);
            this.set('internalid', 'cart');
            this.on('change:confirmation', function (model, confirmation) {
                model.set('confirmation', new TransactionModel(confirmation), { silent: true });
            });
            this.trigger('change:confirmation', this, attributes && attributes.confirmation || {});
            this.on('change:multishipmethods', function (model, multishipmethods) {
                if (multishipmethods) {
                    _.each(_.keys(multishipmethods), function (address_id) {
                        multishipmethods[address_id] = new TransactionShipmethodCollection(multishipmethods[address_id], { silent: true });
                    });
                }
                model.set('multishipmethods', multishipmethods, { silent: true });
            });
            this.trigger('change:multishipmethods', this, attributes && attributes.multishipmethods || []);
            this.on('change:touchpoints', function (model, touchpoints) {
                Session.set('touchpoints', touchpoints);
            });
            if (SC.ENVIRONMENT.customFieldsMetadata && SC.ENVIRONMENT.customFieldsMetadata.salesorder) {
                this.__customFieldsMetadata = SC.ENVIRONMENT.customFieldsMetadata.salesorder;
            }
        },
        getLatestAddition: function getLatestAddition() {
            var model = null;
            if (this.get('latest_addition')) {
                model = this.get('lines').get(this.get('latest_addition'));
            }
            if (!model && this.get('lines').length) {
                model = this.get('lines').at(0);
            }
            return model;
        },
        findLine: function findLine(line) {
            return this.get('lines').find(function (cart_line) {
                return cart_line.isEqual(line);
            });
        },
        addLines: function addLines(lines) {
            lines = lines instanceof LiveOrderLineCollection ? lines : new LiveOrderLineCollection(lines);
            var self = this, promise = lines.sync('create', lines, { killerId: AjaxRequestsKiller.getKillerId() });
            promise.done(function (attributes) {
                self.set(attributes);
                Tracker.getInstance().trackAddToCart(self.get('lines').get(self.get('latest_addition')));
            });
            return promise;
        },
        addLine: function addLine(line) {
            return this.addLines([line]);
        },
        addProduct: function addProduct(product) {
            return this.addLine(LiveOrderLineModel.createFromProduct(product));
        },
        addProducts: function addProducts(products) {
            var lines = _.map(products, function (product) {
                return LiveOrderLineModel.createFromProduct(product);
            });
            return this.addLines(lines);
        },
        updateProduct: function updateProduct(product) {
            return this.updateLine(LiveOrderLineModel.createFromProduct(product));
        },
        updateLine: function updateLine(line) {
            var self = this;
            return line.sync('update', line, {
                killerId: AjaxRequestsKiller.getKillerId(),
                validate: false
            }).done(function (attributes) {
                self.set(attributes);
                Tracker.getInstance().trackAddToCart(self.getLatestAddition());
            }).fail(function (jqXhr) {
                var error_details = null;
                try {
                    var response = JSON.parse(jqXhr.responseText);
                    error_details = response.errorDetails;
                } finally {
                    if (error_details && error_details.status === 'LINE_ROLLBACK') {
                        var line = self.get('lines').get(error_details.oldLineId);
                        if (line) {
                            line.set('internalid', error_details.newLineId);
                            self.trigger('LINE_ROLLBACK', line);
                        }
                    }
                }
            });
        },
        removeLine: function removeLine(line) {
            var self = this;
            return line.sync('delete', line, {
                killerId: AjaxRequestsKiller.getKillerId(),
                validate: false
            }).done(function (attributes) {
                self.set(attributes);
            });
        },
        submit: function submit() {
            this.set('internalid', null);
            var self = this, creditcard = this.get('paymentmethods').findWhere({ type: 'creditcard' }), paypal = this.get('paymentmethods').findWhere({ type: 'paypal' });
            if (creditcard && !creditcard.get('creditcard')) {
                this.get('paymentmethods').remove(creditcard);
            }
            if (paypal && !paypal.get('complete')) {
                this.get('paymentmethods').remove(paypal);
            }
            if (!this.shippingAddressIsRequired()) {
                this.unset('shipaddress', { silent: true });
                this.set('sameAs', false, { silent: true });
            }
            return this.save().fail(function () {
                self.set('internalid', 'cart');
            });
        },
        save: function save() {
            if (this.get('confirmation') && this.get('confirmation').get('internalid')) {
                return jQuery.Deferred().resolve();
            }
            return TransactionModel.prototype.save.apply(this, arguments);
        },
        getTotalItemCount: function getTotalItemCount() {
            return _.reduce(this.get('lines').pluck('quantity'), function (memo, quantity) {
                return memo + (parseFloat(quantity) || 1);
            }, 0);
        },
        parse: function parse(response, options) {
            if (options && !options.parse) {
                return;
            }
            return TransactionModel.prototype.parse.apply(this, arguments);
        },
        getUnsetLines: function getUnsetLines() {
            return this.get('lines').filter(function (line) {
                return !line.get('shipaddress') && line.get('item').get('_isfulfillable');
            });
        },
        getNonShippableLines: function getNonShippableLines() {
            return this.get('lines').filter(function (line) {
                return !line.get('item').get('_isfulfillable');
            });
        },
        getSetLines: function getSetLines() {
            return this.get('lines').filter(function (line) {
                return line.get('shipaddress') && line.get('item').get('_isfulfillable');
            });
        },
        getShippableLines: function getShippableLines() {
            return this.get('lines').filter(function (line) {
                return line.get('item').get('_isfulfillable') && line.get('fulfillmentChoice') !== 'pickup';
            });
        },
        getItemsIds: function getItemsIds() {
            return this.get('lines').map(function (line) {
                return line.get('item').get('internalid');
            });
        },
        getIfThereAreDeliverableItems: function getIfThereAreDeliverableItems() {
            return this.get('lines').length - this.getNonShippableLines().length - this.getPickupInStoreLines().length > 0;
        },
        shippingAddressIsRequired: function shippingAddressIsRequired() {
            return this.getIfThereAreDeliverableItems() && Configuration.get('siteSettings.requireshippinginformation', 'F') === 'T';
        },
        getPickupInStoreLines: function getPickupInStoreLines() {
            var lines = [];
            this.get('lines').each(function (line) {
                if (line.get('fulfillmentChoice') === 'pickup') {
                    lines.push(line);
                }
            });
            return lines;
        }
    }, ClassProperties);
    return LiveOrderModel;
});
define('Header.MiniCartSummary.View', [
    'LiveOrder.Model',
    'header_mini_cart_summary.tpl',
    'Backbone',
    'underscore'
], function (LiveOrderModel, header_mini_cart_summary_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: header_mini_cart_summary_tpl,
        initialize: function () {
            var self = this;
            this.itemsInCart = 0;
            this.showPluraLabel = true;
            this.isLoading = true;
            LiveOrderModel.loadCart().done(function () {
                var cart = LiveOrderModel.getInstance();
                self.itemsInCart = _.reduce(cart.get('lines').pluck('quantity'), function (memo, quantity) {
                    return memo + (parseFloat(quantity) || 1);
                }, 0);
                self.showPluraLabel = self.itemsInCart !== 1;
                self.isLoading = false;
                self.render();
                cart.on('change', function () {
                    self.render();
                });
            });
            this.on('afterViewRender', function () {
                self.isLoading && _.ellipsis('.header-mini-cart-summary-cart-ellipsis');
            });
        },
        getContext: function () {
            return {
                itemsInCart: this.itemsInCart,
                showPluraLabel: this.showPluraLabel,
                isLoading: this.isLoading
            };
        }
    });
});
(function (factory) {
    if (typeof define === 'function' && define.amd) {
        define('backbone.stickit', [
            'underscore',
            'Backbone',
            'exports'
        ], factory);
    } else if (typeof exports === 'object') {
        factory(require('underscore'), require('Backbone'), exports);
    } else {
        factory(_, Backbone, {});
    }
}(function (_, Backbone, Stickit) {
    Stickit._handlers = [];
    Stickit.addHandler = function (handlers) {
        handlers = _.map(_.flatten([handlers]), function (handler) {
            return _.extend({
                updateModel: true,
                updateView: true,
                updateMethod: 'text'
            }, handler);
        });
        this._handlers = this._handlers.concat(handlers);
    };
    Stickit.ViewMixin = {
        _modelBindings: null,
        unstickit: function (model, bindingSelector) {
            if (_.isObject(bindingSelector)) {
                _.each(_.keys(bindingSelector), function (selector) {
                    this.unstickit(model, selector);
                }, this);
                return;
            }
            var models = [], destroyFns = [];
            _.each(this._modelBindings, function (binding, i) {
                if (model && binding.model !== model) {
                    return;
                }
                if (bindingSelector && binding.config.selector != bindingSelector)
                    return;
                destroyFns.push(binding.config._destroy);
                binding.model.off(binding.event, binding.fn);
                models.push(binding.model);
                delete this._modelBindings[i];
            }, this);
            _.invoke(_.uniq(models), 'trigger', 'stickit:unstuck', this.cid);
            _.each(_.uniq(destroyFns), function (fn) {
                fn.call(this);
            }, this);
            this._modelBindings = _.compact(this._modelBindings);
            this.$el.off('.stickit' + (model ? '.' + model.cid : ''), bindingSelector);
        },
        stickit: function (optionalModel, optionalBindingsConfig) {
            var model = optionalModel || this.model, bindings = optionalBindingsConfig || _.result(this, 'bindings') || {};
            this._modelBindings || (this._modelBindings = []);
            this.addBinding(model, bindings);
            var remove = this.remove;
            if (!remove.stickitWrapped)
                this.remove = function () {
                    var ret = this;
                    this.unstickit();
                    if (remove)
                        ret = remove.apply(this, arguments);
                    return ret;
                };
            this.remove.stickitWrapped = true;
        },
        addBinding: function (optionalModel, second, _binding) {
            var $el, options, modelAttr, config, selector, model = optionalModel || this.model, namespace = '.stickit.' + model.cid, binding = _binding || {}, bindId = _.uniqueId();
            if (_.isString(second)) {
                selector = second;
            } else {
                var bindings = second;
                _.each(bindings, function (v, selector) {
                    this.addBinding(model, selector, bindings[selector]);
                }, this);
                return;
            }
            $el = selector === ':el' ? this.$el : this.$(selector);
            this.unstickit(model, selector);
            if (!$el.length)
                return;
            if (_.isString(binding))
                binding = { observe: binding };
            if (_.isFunction(binding.observe))
                binding.observe = binding.observe.call(this);
            config = getConfiguration($el, binding);
            config.selector = selector;
            modelAttr = config.observe;
            config.bindId = bindId;
            config.view = this;
            options = _.extend({ stickitChange: config }, config.setOptions);
            config._destroy = function () {
                applyViewFn(this, config.destroy, $el, model, config);
            };
            initializeAttributes(this, $el, config, model, modelAttr);
            initializeVisible(this, $el, config, model, modelAttr);
            if (modelAttr) {
                _.each(config.events, function (type) {
                    var event = type + namespace;
                    var method = function (event) {
                        var val = config.getVal.call(this, $el, event, config, _.rest(arguments));
                        if (evaluateBoolean(this, config.updateModel, val, event, config))
                            setAttr(model, modelAttr, val, options, this, config);
                    };
                    method = _.bind(method, this);
                    if (selector === ':el')
                        this.$el.on(event, method);
                    else
                        this.$el.on(event, selector, method);
                }, this);
                _.each(_.flatten([modelAttr]), function (attr) {
                    observeModelEvent(model, this, 'change:' + attr, config, function (model, val, options) {
                        var changeId = options && options.stickitChange && options.stickitChange.bindId || null;
                        if (changeId !== bindId)
                            updateViewBindEl(this, $el, config, getAttr(model, modelAttr, config, this), model);
                    });
                }, this);
                updateViewBindEl(this, $el, config, getAttr(model, modelAttr, config, this), model, true);
            }
            applyViewFn(this, config.initialize, $el, model, config);
        }
    };
    _.extend(Backbone.View.prototype, Stickit.ViewMixin);
    var evaluatePath = function (obj, path) {
        var parts = (path || '').split('.');
        var result = _.reduce(parts, function (memo, i) {
            return memo[i];
        }, obj);
        return result == null ? obj : result;
    };
    var applyViewFn = function (view, fn) {
        if (fn)
            return (_.isString(fn) ? evaluatePath(view, fn) : fn).apply(view, _.rest(arguments, 2));
    };
    var getSelectedOption = function ($select) {
        return $select.find('option').not(function () {
            return !this.selected;
        });
    };
    var evaluateBoolean = function (view, reference) {
        if (_.isBoolean(reference))
            return reference;
        else if (_.isFunction(reference) || _.isString(reference))
            return applyViewFn.apply(this, arguments);
        return false;
    };
    var observeModelEvent = function (model, view, event, config, fn) {
        model.on(event, fn, view);
        view._modelBindings.push({
            model: model,
            event: event,
            fn: fn,
            config: config
        });
    };
    var setAttr = function (model, attr, val, options, context, config) {
        var value = {};
        if (config.onSet)
            val = applyViewFn(context, config.onSet, val, config);
        if (config.set)
            applyViewFn(context, config.set, attr, val, options, config);
        else {
            value[attr] = val;
            if (_.isArray(attr) && _.isArray(val)) {
                value = _.reduce(attr, function (memo, attribute, index) {
                    memo[attribute] = _.has(val, index) ? val[index] : null;
                    return memo;
                }, {});
            }
            model.set(value, options);
        }
    };
    var getAttr = function (model, attr, config, context) {
        var val, retrieveVal = function (field) {
                return model[config.escape ? 'escape' : 'get'](field);
            }, sanitizeVal = function (val) {
                return val == null ? '' : val;
            };
        val = _.isArray(attr) ? _.map(attr, retrieveVal) : retrieveVal(attr);
        if (config.onGet)
            val = applyViewFn(context, config.onGet, val, config);
        return _.isArray(val) ? _.map(val, sanitizeVal) : sanitizeVal(val);
    };
    var getConfiguration = Stickit.getConfiguration = function ($el, binding) {
        var handlers = [{
                updateModel: false,
                updateMethod: 'text',
                update: function ($el, val, m, opts) {
                    if ($el[opts.updateMethod])
                        $el[opts.updateMethod](val);
                },
                getVal: function ($el, e, opts) {
                    return $el[opts.updateMethod]();
                }
            }];
        handlers = handlers.concat(_.filter(Stickit._handlers, function (handler) {
            return $el.is(handler.selector);
        }));
        handlers.push(binding);
        var config = _.extend.apply(_, handlers);
        if (config.visible && !_.has(config, 'updateView'))
            config.updateView = false;
        else if (!_.has(config, 'updateView'))
            config.updateView = true;
        return config;
    };
    var initializeAttributes = function (view, $el, config, model, modelAttr) {
        var props = [
            'autofocus',
            'autoplay',
            'async',
            'checked',
            'controls',
            'defer',
            'disabled',
            'hidden',
            'indeterminate',
            'loop',
            'multiple',
            'open',
            'readonly',
            'required',
            'scoped',
            'selected'
        ];
        _.each(config.attributes || [], function (attrConfig) {
            var lastClass = '', observed, updateAttr;
            attrConfig = _.clone(attrConfig);
            observed = attrConfig.observe || (attrConfig.observe = modelAttr), updateAttr = function () {
                var updateType = _.indexOf(props, attrConfig.name, true) > -1 ? 'prop' : 'attr', val = getAttr(model, observed, attrConfig, view);
                if (attrConfig.name === 'class') {
                    $el.removeClass(lastClass).addClass(val);
                    lastClass = val;
                } else
                    $el[updateType](attrConfig.name, val);
            };
            _.each(_.flatten([observed]), function (attr) {
                observeModelEvent(model, view, 'change:' + attr, config, updateAttr);
            });
            updateAttr();
        });
    };
    var initializeVisible = function (view, $el, config, model, modelAttr) {
        if (config.visible == null)
            return;
        var visibleCb = function () {
            var visible = config.visible, visibleFn = config.visibleFn, val = getAttr(model, modelAttr, config, view), isVisible = !!val;
            if (_.isFunction(visible) || _.isString(visible))
                isVisible = !!applyViewFn(view, visible, val, config);
            if (visibleFn)
                applyViewFn(view, visibleFn, $el, isVisible, config);
            else {
                $el.toggle(isVisible);
            }
        };
        _.each(_.flatten([modelAttr]), function (attr) {
            observeModelEvent(model, view, 'change:' + attr, config, visibleCb);
        });
        visibleCb();
    };
    var updateViewBindEl = function (view, $el, config, val, model, isInitializing) {
        if (!evaluateBoolean(view, config.updateView, val, config))
            return;
        applyViewFn(view, config.update, $el, val, model, config);
        if (!isInitializing)
            applyViewFn(view, config.afterUpdate, $el, val, config);
    };
    Stickit.addHandler([
        {
            selector: '[contenteditable="true"]',
            updateMethod: 'html',
            events: [
                'input',
                'change'
            ]
        },
        {
            selector: 'input',
            events: [
                'propertychange',
                'input',
                'change'
            ],
            update: function ($el, val) {
                $el.val(val);
            },
            getVal: function ($el) {
                return $el.val();
            }
        },
        {
            selector: 'textarea',
            events: [
                'propertychange',
                'input',
                'change'
            ],
            update: function ($el, val) {
                $el.val(val);
            },
            getVal: function ($el) {
                return $el.val();
            }
        },
        {
            selector: 'input[type="radio"]',
            events: ['change'],
            update: function ($el, val) {
                $el.filter('[value="' + val + '"]').prop('checked', true);
            },
            getVal: function ($el) {
                return $el.filter(':checked').val();
            }
        },
        {
            selector: 'input[type="checkbox"]',
            events: ['change'],
            update: function ($el, val, model, options) {
                if ($el.length > 1) {
                    val || (val = []);
                    $el.each(function (i, el) {
                        var checkbox = Backbone.$(el);
                        var checked = _.indexOf(val, checkbox.val()) > -1;
                        checkbox.prop('checked', checked);
                    });
                } else {
                    var checked = _.isBoolean(val) ? val : val === $el.val();
                    $el.prop('checked', checked);
                }
            },
            getVal: function ($el) {
                var val;
                if ($el.length > 1) {
                    val = _.reduce($el, function (memo, el) {
                        var checkbox = Backbone.$(el);
                        if (checkbox.prop('checked'))
                            memo.push(checkbox.val());
                        return memo;
                    }, []);
                } else {
                    val = $el.prop('checked');
                    var boxval = $el.val();
                    if (boxval !== 'on' && boxval != null) {
                        val = val ? $el.val() : null;
                    }
                }
                return val;
            }
        },
        {
            selector: 'select',
            events: ['change'],
            update: function ($el, val, model, options) {
                var optList, selectConfig = options.selectOptions, list = selectConfig && selectConfig.collection || undefined, isMultiple = $el.prop('multiple');
                if (!selectConfig) {
                    selectConfig = {};
                    var getList = function ($el) {
                        return $el.map(function () {
                            return {
                                value: this.value,
                                label: this.text
                            };
                        }).get();
                    };
                    if ($el.find('optgroup').length) {
                        list = { opt_labels: [] };
                        if ($el.find('> option').length) {
                            list.opt_labels.push(undefined);
                            _.each($el.find('> option'), function (el) {
                                list[undefined] = getList(Backbone.$(el));
                            });
                        }
                        _.each($el.find('optgroup'), function (el) {
                            var label = Backbone.$(el).attr('label');
                            list.opt_labels.push(label);
                            list[label] = getList(Backbone.$(el).find('option'));
                        });
                    } else {
                        list = getList($el.find('option'));
                    }
                }
                selectConfig.valuePath = selectConfig.valuePath || 'value';
                selectConfig.labelPath = selectConfig.labelPath || 'label';
                var addSelectOptions = function (optList, $el, fieldVal) {
                    _.each(optList, function (obj) {
                        var option = Backbone.$('<option/>'), optionVal = obj;
                        var fillOption = function (text, val) {
                            option.text(text);
                            optionVal = val;
                            option.data('stickit_bind_val', optionVal);
                            if (!_.isArray(optionVal) && !_.isObject(optionVal))
                                option.val(optionVal);
                        };
                        if (obj === '__default__')
                            fillOption(selectConfig.defaultOption.label, selectConfig.defaultOption.value);
                        else
                            fillOption(evaluatePath(obj, selectConfig.labelPath), evaluatePath(obj, selectConfig.valuePath));
                        if (!isMultiple && optionVal != null && fieldVal != null && optionVal === fieldVal || _.isObject(fieldVal) && _.isEqual(optionVal, fieldVal))
                            option.prop('selected', true);
                        else if (isMultiple && _.isArray(fieldVal)) {
                            _.each(fieldVal, function (val) {
                                if (_.isObject(val))
                                    val = evaluatePath(val, selectConfig.valuePath);
                                if (val === optionVal || _.isObject(val) && _.isEqual(optionVal, val))
                                    option.prop('selected', true);
                            });
                        }
                        $el.append(option);
                    });
                };
                $el.find('*').remove();
                var evaluate = function (view, list) {
                    var context = window;
                    if (list.indexOf('this.') === 0)
                        context = view;
                    list = list.replace(/^[a-z]*\.(.+)$/, '$1');
                    return evaluatePath(context, list);
                };
                if (_.isString(list))
                    optList = evaluate(this, list);
                else if (_.isFunction(list))
                    optList = applyViewFn(this, list, $el, options);
                else
                    optList = list;
                if (optList instanceof Backbone.Collection)
                    optList = optList.toJSON();
                if (selectConfig.defaultOption) {
                    addSelectOptions(['__default__'], $el);
                }
                if (_.isArray(optList)) {
                    addSelectOptions(optList, $el, val);
                } else if (optList.opt_labels) {
                    _.each(optList.opt_labels, function (label) {
                        var $group = Backbone.$('<optgroup/>').attr('label', label);
                        addSelectOptions(optList[label], $group, val);
                        $el.append($group);
                    });
                } else {
                    var opts = [], opt;
                    for (var i in optList) {
                        opt = {};
                        opt[selectConfig.valuePath] = i;
                        opt[selectConfig.labelPath] = optList[i];
                        opts.push(opt);
                    }
                    addSelectOptions(_.sortBy(opts, selectConfig.comparator || selectConfig.labelPath), $el, val);
                }
            },
            getVal: function ($el) {
                var val;
                if ($el.prop('multiple')) {
                    val = Backbone.$(getSelectedOption($el).map(function () {
                        return Backbone.$(this).data('stickit_bind_val');
                    })).get();
                } else {
                    val = getSelectedOption($el).data('stickit_bind_val');
                }
                return val;
            }
        }
    ]);
    Backbone.Stickit = Stickit;
    return Backbone.Stickit;
}));
define('Transaction.Line.Views.Option.View', [
    'SC.Configuration',
    'Backbone',
    'underscore',
    'backbone.stickit'
], function (Configuration, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        initialize: function () {
            this.config = _.findWhere(Configuration.get('ItemOptions.optionsConfiguration', []), { cartOptionId: this.model.get('cartOptionId') }) || { templates: {} };
            this.config.templates = this.config.templates || {};
            this.line_model = this.options.line;
            var item_options_default_templates = Configuration.get('ItemOptions.defaultTemplates', {});
            if (item_options_default_templates && item_options_default_templates.selectorByType) {
                if (!this.config.templates.selector) {
                    var option_selector_template = item_options_default_templates.selectorByType[this.model.get('type')], default_option_selector_template = item_options_default_templates.selectorByType['default'];
                    this.config.templates.selector = option_selector_template || default_option_selector_template;
                }
                if (!this.config.templates.selected) {
                    var selected_option_template = item_options_default_templates.selectedByType[this.model.get('type')], default_selected_option_template = item_options_default_templates.selectedByType['default'];
                    this.config.templates.selected = selected_option_template || default_selected_option_template;
                }
            }
            this.options.templateName = this.options.templateName || 'selector';
            this.template = this.config.templates[this.options.templateName];
        },
        render: function () {
            if (!this.model.get('value') || !this.model.get('value').internalid) {
                return this;
            }
            return this._render();
        },
        getContext: function () {
            var self = this, selected_value = this.model.get('value') || {}, values = _.map(this.model.get('values') || [], function (value) {
                    var color = '', is_color_tile = false, image = {}, is_image_tile = false;
                    if (self.model.get('colors')) {
                        color = self.model.get('colors')[value.label] || self.model.get('colors').defaultColor;
                        if (_.isObject(color)) {
                            image = color;
                            color = '';
                            is_image_tile = true;
                        } else {
                            is_color_tile = true;
                        }
                    }
                    return {
                        internalid: value.internalid,
                        isAvailable: value.isAvailable,
                        label: value.label,
                        isActive: value.internalid === selected_value.internalid,
                        color: color,
                        isColorTile: is_color_tile,
                        isImageTile: is_image_tile,
                        image: image,
                        isLightColor: _.contains(Configuration.get('layout.lightColors', []), value.label)
                    };
                });
            selected_value = _.extend({}, selected_value, _.findWhere(values, { internalid: selected_value.internalid }) || {});
            selected_value.label = selected_value.label || selected_value.internalid;
            return {
                model: this.model,
                values: values,
                showSelectedValue: !!selected_value,
                isMandatory: this.model.get('isMandatory'),
                itemOptionId: this.model.get('itemOptionId'),
                cartOptionId: this.model.get('cartOptionId'),
                label: this.config && this.config.label || this.model.get('label'),
                selectedValue: selected_value,
                isTextArea: this.model.get('type') === 'textarea',
                isEmail: this.model.get('type') === 'email',
                isText: this.model.get('type') === 'text',
                isSelect: this.model.get('type') === 'select',
                isCheckbox: this.model.get('type') === 'checkbox',
                isDate: this.model.get('type') === 'date',
                htmlId: 'option-' + this.model.get('cartOptionId'),
                htmlIdContainer: this.model.get('cartOptionId') + '-container'
            };
        }
    });
});
define('HandlebarsExtras', [
    'SC.Configuration',
    'Utils',
    'Handlebars',
    'Backbone',
    'underscore',
    'jQuery'
], function (Configuration, Utils, Handlebars, Backbone, _, jQuery) {
    'use strict';
    Handlebars.registerHelper('getThemeAssetsPathWithDefault', function (img_path, default_img_path) {
        if (img_path && img_path === Utils.getAbsoluteUrlOfNonManagedResources('')) {
            img_path = null;
        }
        return Utils.getThemeAbsoluteUrlOfNonManagedResources(default_img_path, img_path);
    });
    Handlebars.registerHelper('getThemeAssetsPath', function (default_img_path) {
        return Handlebars.helpers.getThemeAssetsPathWithDefault.apply(this, [
            null,
            default_img_path
        ]);
    });
    Handlebars.registerHelper('getExtensionAssetsPathWithDefault', function (img_path, default_img_path) {
        if (img_path && img_path !== Utils.getAbsoluteUrl()) {
            return img_path;
        }
        img_path = (this._extension_path || '') + default_img_path;
        return Utils.getAbsoluteUrl(img_path);
    });
    Handlebars.registerHelper('getExtensionAssetsPath', function (default_img_path) {
        return Handlebars.helpers.getExtensionAssetsPathWithDefault.apply(this, [
            null,
            default_img_path
        ]);
    });
    Handlebars.registerHelper('translate', function () {
        return new Handlebars.SafeString(_.translate.apply(_, arguments));
    });
    Handlebars.registerHelper('highlightKeyword', function (text, keyword) {
        return new Handlebars.SafeString(Utils.highlightKeyword(text, keyword));
    });
    var objectToAttributesFn = function () {
        return new Handlebars.SafeString(Utils.objectToAtrributes(this, ''));
    };
    Handlebars.registerHelper('objectToAtrributes', objectToAttributesFn);
    Handlebars.registerHelper('objectToAttributes', objectToAttributesFn);
    Handlebars.registerHelper('each', function (context, options) {
        var ret = '', iterable = context instanceof Backbone.Collection ? context.models : context, length = iterable && iterable.length || 0;
        for (var i = 0, j = length; i < j; i++) {
            ret = ret + options.fn(iterable[i], {
                data: {
                    first: i === 0,
                    last: i === iterable.length - 1,
                    index: i,
                    indexPlusOne: i + 1
                }
            });
        }
        if (!length) {
            ret = options.inverse(this);
        }
        return ret;
    });
    Handlebars.registerHelper('resizeImage', function (url, size) {
        url = url || _.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', Configuration.get('imageNotAvailable'));
        var mapped_size = Configuration['imageSizeMapping.' + size] || size;
        return Utils.resizeImage(SC.ENVIRONMENT.siteSettings.imagesizes || [], url, mapped_size);
    });
    Handlebars.registerHelper('trimHtml', function (htmlString, length) {
        var htmlStringSelector;
        try {
            htmlStringSelector = jQuery(htmlString);
        } catch (e) {
        }
        var trimmedString = htmlStringSelector && htmlStringSelector.length > 0 ? jQuery.trim(htmlStringSelector.text()) : jQuery.trim(htmlString), moreContent = '';
        if (trimmedString.length > length) {
            moreContent = '...';
        }
        return trimmedString.substring(0, length) + moreContent;
    });
    Handlebars.registerHelper('breaklines', function (text) {
        text = Handlebars.Utils.escapeExpression(text || '');
        text = text.replace(/(\r\n|\n|\r|\u0005)/gm, '<br/>');
        return new Handlebars.SafeString(text);
    });
    Handlebars.registerHelper('ifEquals', function (v1, v2, options) {
        if (v1 == v2) {
            return options.fn(this);
        }
        return options.inverse(this);
    });
    Handlebars.registerHelper('formatCurrency', function (amount, symbol) {
        if (typeof symbol === 'string') {
            return Utils.formatCurrency(amount, symbol);
        } else {
            return Utils.formatCurrency(amount);
        }
    });
});
define('Backbone.View.render', [
    'Backbone',
    'underscore',
    'jQuery',
    'PluginContainer',
    'Utils',
    'Backbone.CompositeView',
    'Backbone.Validation',
    'Handlebars',
    'HandlebarsExtras'
], function (Backbone, _, jQuery, PluginContainer, Utils) {
    'use strict';
    _.extend(Backbone.View.prototype, {
        getTemplateContext: function () {
            var template_context;
            if (this.getContext) {
                template_context = this.getContext();
                if (this.constructor.extraContextProperties) {
                    var safe_context = Utils.deepCopy(template_context);
                    _.each(this.constructor.extraContextProperties, function contextExtender(property_generator, property_name) {
                        template_context[property_name] = property_generator.fn(safe_context);
                    });
                }
            } else {
                template_context = {};
                if (this.model) {
                    template_context.model = this.model;
                }
                if (this.collection) {
                    template_context.collection = this.collection;
                }
            }
            return template_context;
        },
        compileTemplate: function () {
            var template_context = this.getTemplateContext();
            this.template = Backbone.View.preCompile.executeAll(this.template, this, template_context) || this.template;
            if (!this.template) {
                throw new Error('View doesn\'t have a template');
            }
            if (!_.isFunction(this.template)) {
                var templateName = this.template + '';
                this.template = Utils.requireModules(templateName);
                if (!this.template) {
                    console.log('View render error, template not found: ', templateName);
                }
            }
            var tmpl_str = this.template(template_context);
            tmpl_str = Backbone.View.postCompile.executeAll(tmpl_str, this);
            return tmpl_str;
        },
        _initialize: function () {
        },
        initialize: function () {
            this._initialize();
        },
        _render: function () {
            if (this.events) {
                this.undelegateEvents();
            }
            var tmpl_str = this.compileTemplate();
            var $tmpl = SC.ENVIRONMENT.jsEnvironment === 'server' ? jQuery('<div/>').append(tmpl_str) : jQuery(tmpl_str);
            $tmpl = Backbone.View.preRender.executeAll($tmpl, this);
            $tmpl = this.preRenderPlugins ? this.preRenderPlugins.executeAll($tmpl, this) : $tmpl;
            this.$el.empty();
            this.trigger('beforeViewRender', this);
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                if (this.$el[0]) {
                    this.$el[0].innerHTML = $tmpl[0].innerHTML;
                }
            } else {
                this.$el.append($tmpl);
            }
            this.renderCompositeView();
            Backbone.View.postRender.executeAll(this.$el, this);
            this.trigger('afterViewRender', this);
            if (this.events) {
                this.delegateEvents();
            }
            return this;
        },
        render: function () {
            return this._render();
        },
        _destroy: function (softDestroy) {
            this.destroyCompositeView();
            if (this.$el) {
                this.undelegateEvents();
            }
            this.model && this.model.off(null, null, this);
            this.collection && this.collection.off && this.collection.off(null, null, this);
            if (this.$el && softDestroy) {
                this.$el.empty();
            } else if (this.$el) {
                this.remove();
                this.$el.unbind();
            }
            this.trigger('destroy');
        },
        destroy: function (softDestroy) {
            this._destroy(softDestroy);
        }
    });
    var isDataTypeValid = function (data_type) {
        var valid_data_types = [
            'number',
            'string',
            'object',
            'array',
            'boolean',
            'null'
        ];
        if (_.isString(data_type)) {
            return _.indexOf(valid_data_types, data_type) >= 0;
        } else if (_.isArray(data_type)) {
            return !_.difference(data_type, valid_data_types).length;
        }
        return false;
    };
    _.extend(Backbone.View, {
        preCompile: new PluginContainer(),
        postCompile: new PluginContainer(),
        preRender: new PluginContainer(),
        postRender: new PluginContainer(),
        addExtraContextProperty: function addExtraContextProperty(property_name, type, callback) {
            this.extraContextProperties = this.extraContextProperties || {};
            var error = {};
            if (!isDataTypeValid(type)) {
                error = new Error('Invalid data type. Please check the json-schema documentation for valid data types.');
                error.name = 'INVALID_DATA_TYPE';
                throw error;
            }
            if (this.extraContextProperties[property_name]) {
                error = new Error('Duplicated property_name. Trying to add more than one extra context property with the same name.');
                error.name = 'DUPLICATED_CONTEXT_PROPERTY';
                throw error;
            }
            this.extraContextProperties[property_name] = {
                type: type,
                fn: callback
            };
        },
        removeExtraContextProperty: function removeExtraContextProperty(property_name) {
            this.extraContextProperties = this.extraContextProperties || {};
            delete this.extraContextProperties[property_name];
        }
    });
    return Backbone.View;
});
define('Backbone.CollectionView', [
    'Backbone',
    'jQuery',
    'underscore',
    'Backbone.View',
    'Backbone.View.render'
], function (Backbone, jQuery, _) {
    'use strict';
    return Backbone.View.extend({
        childView: Backbone.View,
        template: null,
        childViewOptions: {},
        viewsPerRow: 3,
        rowsCount: 12,
        childTemplate: null,
        cellTemplate: null,
        rowTemplate: null,
        cellsContainerId: 'backbone.collection.view.cells',
        cellContainerId: 'backbone.collection.view.cell',
        rowsContainerId: 'backbone.collection.view.rows',
        context: {},
        initialize: function (options) {
            this.childView = options.childView || this.childView;
            this.childViewOptions = options.childViewOptions || this.childViewOptions;
            this.viewsPerRow = options.viewsPerRow ? options.viewsPerRow : this.viewsPerRow;
            if (this.viewsPerRow < 1) {
                this.viewsPerRow = Infinity;
            }
            this.context = options.context || {};
            this.collection = options.collection;
            this.childTemplate = options.childTemplate || this.childTemplate;
            this.cellTemplate = options.cellTemplate || this.cellTemplate;
            this.rowTemplate = options.rowTemplate || this.rowTemplate;
            this.cellsContainerId = options.cellsContainerId || this.cellsContainerId;
            this.cellContainerId = options.cellContainerId || this.cellContainerId;
            this.template = options.template || this.template;
            this.childCells = [];
        },
        createChildElement: function () {
            var data = this.placeholderData || {}, tag_name = data.childTagName || 'div', element = jQuery('<' + tag_name + '></' + tag_name + '>');
            if (data.childId) {
                element.attr('id', data.childId);
            }
            if (data.childClass) {
                element.addClass(data.childClass);
            }
            if (data.childDataAction) {
                element.attr('data-action', data.childDataAction);
            }
            if (data.childDataType) {
                element.attr('data-type', data.childDataType);
            }
            return element;
        },
        generateRowContext: function () {
            return {};
        },
        generateCellContext: function (child_view_instance) {
            var child_view_instance_context = child_view_instance.getTemplateContext ? child_view_instance.getTemplateContext() : child_view_instance.getContext ? child_view_instance.getContext() : {};
            return _.extend(child_view_instance_context, { spanSize: this.calculateSpanSize() });
        },
        calculateSpanSize: function () {
            return this.rowsCount / this.viewsPerRow;
        },
        createCell: function (model, index) {
            var options = _.extend({}, this.childViewOptions, {
                    model: model,
                    index: index
                }), child_view_instance = new this.childView(options);
            this.childCells.push(child_view_instance);
            child_view_instance.setElement(this.createChildElement());
            child_view_instance.render();
            if (child_view_instance.$el.children().length === 1) {
                child_view_instance.setElement(child_view_instance.$el.children()[0]);
            }
            if (this.cellTemplate) {
                var $cell = jQuery(this.cellTemplate(this.generateCellContext(child_view_instance))), $placeholder = $cell.find('[data-type="' + this.cellContainerId + '"]');
                if ($placeholder.length) {
                    $placeholder.replaceWith(child_view_instance.$el);
                } else {
                    $cell = jQuery('<div></div>');
                    $cell.append(child_view_instance.$el);
                }
                return $cell;
            } else {
                return child_view_instance.$el;
            }
        },
        appendCellsToRow: function (cells) {
            var $cells = jQuery(_(cells).map(function (element) {
                return element.get(0);
            }));
            if (this.rowTemplate) {
                var $row = jQuery(this.rowTemplate(this.generateRowContext())), $placeholder = $row.find('[data-type="' + this.cellsContainerId + '"]');
                if ($placeholder.length) {
                    $placeholder.replaceWith($cells);
                } else {
                    $row = jQuery('<div></div>');
                    $row.append($cells);
                }
                return $row;
            } else {
                return $cells;
            }
        },
        render: function () {
            this.collection = this.collection instanceof Backbone.Collection ? this.collection : new Backbone.Collection(this.collection);
            this.$el.empty();
            if (this.template) {
                this._render();
            }
            var self = this, rows = [], cells_in_row = [];
            if (self.childTemplate) {
                self.childView.prototype.template = self.childTemplate;
            }
            this.viewsPerRow = this.placeholderData && this.placeholderData.viewsPerRow || this.viewsPerRow;
            this.collection.each(function (model, index) {
                var cell = self.createCell(model, index);
                if (self.rowTemplate) {
                    cells_in_row.push(cell);
                    if (self.viewsPerRow === 1 || (index + 1) % self.viewsPerRow === 0 || index + 1 === self.collection.length) {
                        rows.push(self.appendCellsToRow(cells_in_row));
                        cells_in_row = [];
                    }
                } else {
                    rows.push(cell);
                }
            });
            var $content = jQuery(_(rows).map(function (element) {
                return element.get(0);
            }));
            if (this.template) {
                this.$('[data-type="' + this.rowsContainerId + '"]').replaceWith($content);
            } else {
                this.$el.append($content);
            }
        },
        destroy: function () {
            _.each(this.childCells, function (child) {
                child && child.destroy();
            });
            Backbone.View.prototype.destroy.apply(this, Array.prototype.slice.call(arguments));
        },
        getContext: function () {
            var context = {
                collection: this.collection,
                showCells: !!this.collection.length
            };
            return _.extend(context, this.context);
        }
    });
});
define('Transaction.Line.Views.Options.Selected.View', [
    'Transaction.Line.Views.Option.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'transaction_line_views_options_selected.tpl',
    'Backbone'
], function (TransactionLineViewsOptionView, BackboneCompositeView, BackboneCollectionView, transaction_line_views_options_selected_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: transaction_line_views_options_selected_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        childViews: {
            'Options.Collection': function () {
                return new BackboneCollectionView({
                    collection: this.model.getVisibleOptions(),
                    childView: TransactionLineViewsOptionView,
                    viewsPerRow: 1,
                    childViewOptions: {
                        line: this.model,
                        templateName: 'selected'
                    }
                });
            }
        },
        getContext: function () {
            return { model: this.model };
        }
    });
});
define('Header.MiniCartItemCell.View', [
    'Transaction.Line.Views.Options.Selected.View',
    'Profile.Model',
    'header_mini_cart_item_cell.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView'
], function (TransactionLineViewsOptionsSelectedView, ProfileModel, header_mini_cart_item_cell_tpl, Backbone, BackboneCompositeView) {
    'use strict';
    return Backbone.View.extend({
        template: header_mini_cart_item_cell_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        childViews: {
            'Item.SelectedOptions': function () {
                return new TransactionLineViewsOptionsSelectedView({ model: this.model });
            }
        },
        getContext: function () {
            return {
                line: this.model,
                itemId: this.model.get('item').id,
                itemType: this.model.get('item').get('itemtype'),
                linkAttributes: this.model.getFullLink({
                    quantity: null,
                    location: null,
                    fulfillmentChoice: null
                }),
                thumbnail: this.model.getThumbnail(),
                isPriceEnabled: !ProfileModel.getInstance().hidePrices()
            };
        }
    });
});
define('Header.MiniCart.View', [
    'LiveOrder.Model',
    'Header.MiniCartSummary.View',
    'Header.MiniCartItemCell.View',
    'Profile.Model',
    'SC.Configuration',
    'header_mini_cart.tpl',
    'underscore',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'underscore',
    'Utils'
], function (LiveOrderModel, HeaderMiniCartSummaryView, HeaderMiniCartItemCellView, ProfileModel, Configuration, header_mini_cart_tpl, _, Backbone, BackboneCompositeView, BackboneCollectionView) {
    'use strict';
    return Backbone.View.extend({
        template: header_mini_cart_tpl,
        initialize: function initialize() {
            BackboneCompositeView.add(this);
            var self = this;
            this.isLoading = true;
            this.itemsInCart = 0;
            this.model = LiveOrderModel.getInstance();
            LiveOrderModel.loadCart().done(function () {
                self.isLoading = false;
                self.render();
            });
            this.model.on('change', this.render, this);
            this.model.get('lines').on('add remove', this.render, this);
        },
        render: function render() {
            this.itemsInCart = this.model.getTotalItemCount();
            Backbone.View.prototype.render.apply(this, arguments);
            if (_.isTabletDevice() || _.isDesktopDevice()) {
                this.$('[data-type="mini-cart"]').attr('data-toggle', 'dropdown');
            }
        },
        destroy: function destroy() {
            this._destroy();
            this.model.off('change', this.render, this);
            this.model.get('lines').off('add remove', this.render, this);
        },
        childViews: {
            'Header.MiniCartSummary': function () {
                return new HeaderMiniCartSummaryView();
            },
            'Header.MiniCartItemCell': function () {
                return new BackboneCollectionView({
                    collection: !this.isLoading ? this.model.get('lines') : new Backbone.Collection(),
                    childView: HeaderMiniCartItemCellView,
                    viewsPerRow: 1
                });
            }
        },
        getContext: function () {
            var summary = this.model.get('summary');
            return {
                model: this.model,
                itemsInCart: this.itemsInCart,
                showPluraLabel: this.itemsInCart !== 1,
                showLines: this.itemsInCart > 0,
                isLoading: this.isLoading,
                subtotalFormatted: !this.isLoading ? summary && summary.subtotal_formatted : '',
                cartTouchPoint: Configuration.get('modulesConfig.Cart.startRouter', false) ? Configuration.get('currentTouchpoint') : 'viewcart',
                isPriceEnabled: !ProfileModel.getInstance().hidePrices()
            };
        }
    });
});
define('Product.Option.Model', [
    'ProductLine.Option.Model',
    'Backbone',
    'underscore',
    'Utils'
], function (ProductLineOptionModel, Backbone, _, Utils) {
    'use strict';
    return ProductLineOptionModel.extend({
        initialize: function initialize() {
            ProductLineOptionModel.prototype.initialize.apply(this, arguments);
            _.extend(this, Backbone.Validation.mixin);
        },
        validation: {
            'value.internalid': {
                fn: function optionValueValidator() {
                    var value = this.get('value') && this.get('value').internalid;
                    if (this.get('isMandatory') && !value) {
                        return _('Please specify a value for this option').translate();
                    } else if (value) {
                        var max_length = 160;
                        if (this.get('type') === 'text' || this.get('type') === 'textarea') {
                            if (this.get('isMandatory') && (!Utils.trim(value) || value.length > max_length)) {
                                return _('Please enter a valid input for this string').translate();
                            } else if (value.length > max_length) {
                                return _('Please enter a string shorter (maximum length: $(0))').translate(max_length);
                            }
                        } else if (this.get('type') === 'email' && !Backbone.Validation.patterns.email.test(value)) {
                            return _('Please enter a valid email').translate();
                        } else if (this.get('type') === 'integer' && !Backbone.Validation.patterns.netsuiteInteger.test(value)) {
                            return _('Please enter a valid integer number').translate();
                        } else if (this.get('type') === 'float' && !Backbone.Validation.patterns.netsuiteFloat.test(value)) {
                            return _('Please enter a valid decimal number').translate();
                        } else if (this.get('type') === 'currency' && !Backbone.Validation.patterns.netsuiteFloat.test(value)) {
                            return _('Please enter a valid currency number').translate();
                        } else if (this.get('type') === 'phone' && !Backbone.Validation.patterns.netsuitePhone.test(value)) {
                            return _('Please enter a valid phone').translate();
                        } else if (this.get('type') === 'percent' && !Backbone.Validation.patterns.netsuitePercent.test(value)) {
                            return _('Please enter a valid percent').translate();
                        } else if (this.get('type') === 'url' && !Backbone.Validation.patterns.netsuiteUrl.test(value)) {
                            return _('Please enter a valid url').translate();
                        } else if (this.get('type') === 'select' && !_.findWhere(this.get('values'), { internalid: value })) {
                            return _('Please select a valid value for this option').translate();
                        }
                    }
                }
            }
        }
    });
});
define('Product.Option.Collection', [
    'Product.Option.Model',
    'ProductLine.Option.Collection'
], function (ProductOptionModel, ProductLineOptionCollection) {
    'use strict';
    return ProductLineOptionCollection.extend({ model: ProductOptionModel });
});
define('Product.Model', [
    'Item.Model',
    'Product.Option.Collection',
    'ProductLine.Common',
    'PluginContainer',
    'SC.Configuration',
    'underscore',
    'Backbone',
    'Utils',
    'jQuery'
], function (ItemModel, ProductOptionCollection, ProductLineCommon, PluginContainer, Configuration, _, Backbone, Utils, jQuery) {
    'use strict';
    var ProductModel = Backbone.Model.extend({
        validation: {
            'quantity': {
                fn: function quantityValidator(new_quantity) {
                    var current_quantity = parseInt(new_quantity, 10);
                    if (!_.isNumber(current_quantity) || _.isNaN(current_quantity) || current_quantity < 1) {
                        return _.translate('Invalid quantity value');
                    } else if (current_quantity < this.getItem().get('_minimumQuantity')) {
                        return _.translate('Please add $(0) or more of this item', this.getItem().get('_minimumQuantity'));
                    }
                }
            },
            'options': {
                fn: function optionsValidator() {
                    var are_options_with_error = false;
                    this.get('options').each(function (option) {
                        are_options_with_error = are_options_with_error || !!option.validate();
                    });
                    return are_options_with_error && _.translate('Invalid options values');
                }
            }
        },
        initialize: function initialize(attributes) {
            var self = this;
            Backbone.Model.prototype.initialize.apply(this, arguments);
            this.validation = _.extend({}, this.validation);
            this.on('change:item', function (model, item) {
                model.set('item', item instanceof ItemModel ? item : new ItemModel(item), { silent: true });
                self.initializeOptions(model.isNew() ? self.get('item').get('options').toJSON() : attributes.options);
            });
            this.trigger('change:item', this, attributes && attributes.item || {});
            this.get('item').on('change', this.onItemChangeUpdateLine, this);
            if (this.isNew()) {
                this.initializeOptions(attributes && attributes.options || this.get('item').get('options').toJSON() || []);
            } else {
                this.initializeOptions(this.get('options'));
            }
            _.extend(this, Backbone.Validation.mixin);
        },
        _setQuantity: function _setQuantity(quantity, args) {
            var self = this;
            return this.cancelableTrigger('beforeChangeQuantity', quantity).then(function () {
                Backbone.Model.prototype.set.apply(self, args);
                self.cancelableTrigger('afterChangeQuantity');
            }, function () {
                self.trigger('change:quantity', self);
                return jQuery.Deferred().reject();
            });
        },
        set: function set(attributes, value, options) {
            var args = Array.prototype.slice.call(arguments);
            if (_.isString(attributes) && attributes === 'quantity' && (!options || !options.silent)) {
                return this._setQuantity(value, args);
            } else if (_.isObject(attributes) && _.isNumber(attributes.quantity) && (!value || !value.silent)) {
                return this._setQuantity(attributes.quantity, args);
            } else {
                return Backbone.Model.prototype.set.apply(this, arguments);
            }
        },
        onItemChangeUpdateLine: function onItemChangeUpdateLine() {
            if (this.isNew()) {
                this.initializeMinimumQuantity();
            }
            this.initializeOptions(this.get('item').get('options').toJSON());
        },
        initializeOptions: function initializeOptions(options) {
            this.set('options', options instanceof ProductOptionCollection ? options : new ProductOptionCollection(options), { silent: true });
            this.extendOptionsFromItem(this.get('item'), this);
            this.setOptionsValidation();
        },
        initializeMinimumQuantity: function initializeMinimumQuantity() {
            var line_quantity = this.get('quantity'), minimum_quantity = this.get('item').get('_minimumQuantity') || 1;
            if (!_.isNumber(line_quantity) || _.isNaN(line_quantity) || line_quantity < minimum_quantity) {
                line_quantity = minimum_quantity;
            }
            this.set('quantity', line_quantity, { silent: true });
        },
        setOptionsValidation: function setOptionsValidation() {
            var self = this;
            self.get('options').each(function (option) {
                self.validation[option.get('cartOptionId')] = {
                    fn: function optionValidationFunction(value, cartOptionId, computedState) {
                        var selected_option = computedState.options.findWhere({ cartOptionId: cartOptionId }), validation = selected_option.validate();
                        if (validation && validation['value.internalid']) {
                            return validation['value.internalid'];
                        }
                    }
                };
            });
        },
        areAttributesValid: function areAttributesValid(attributes, validators) {
            var current_validation = _.extend({}, this.validation);
            _.extend(this.validation, validators || {});
            var result = this.isValid(attributes);
            this.validation = current_validation;
            return result;
        },
        setOption: function setOption(option_cart_id, value) {
            var self = this;
            return this.cancelableTrigger('beforeChangeOption', option_cart_id, value).then(function () {
                var selected_option = self.get('options').findWhere({ cartOptionId: option_cart_id }), selected_value = selected_option && _.findWhere(selected_option.get('values'), { internalid: value });
                if (selected_option) {
                    if (selected_value) {
                        selected_option.set('value', {
                            internalid: selected_value.internalid,
                            label: selected_value.label
                        });
                        self.set(option_cart_id, value);
                    } else if (value !== null && value !== undefined && value !== '' && selected_option.get('type') !== 'select') {
                        selected_option.set('value', {
                            internalid: value,
                            label: value
                        });
                        self.set(option_cart_id, value);
                    } else {
                        selected_option.unset('value');
                        self.unset(option_cart_id);
                    }
                    if (selected_option.get('isMatrixDimension') && value && selected_option.get('value')) {
                        var valid_values_for_selected_option = self.getValidValuesForOption(selected_option), reset = !_.contains(valid_values_for_selected_option, selected_option.get('value').label);
                        _.each(self.get('options').where({ 'isMatrixDimension': true }), function (option) {
                            if (reset && option_cart_id !== option.get('cartOptionId')) {
                                self.setOption(option.get('cartOptionId'), null);
                            }
                        });
                        _.each(self.get('options').where({ 'isMatrixDimension': true }), function (option) {
                            var valid_values_for_option = self.getValidValuesForOption(option);
                            _.each(option.get('values'), function (value) {
                                if (value.isAvailable !== _.contains(valid_values_for_option, value.label)) {
                                    value.isAvailable = !value.isAvailable;
                                    self.trigger('change:' + option.get('cartOptionId'), self, self.get(option.get('cartOptionId')));
                                }
                            });
                        });
                    }
                }
                self.cancelableTrigger('afterChangeOption', _.isUndefined(self.get(option_cart_id)) ? false : selected_option.toJSON());
                return jQuery.Deferred().resolve(_.isUndefined(self.get(option_cart_id)) ? false : selected_option);
            });
        },
        isEqual: function isEqual(other_line) {
            var other_line_internalid = _.isFunction(other_line.getItem) ? other_line.getItem().get('internalid') : other_line.get('item').get('internalid');
            if (other_line && this.getItem().get('internalid') === other_line_internalid) {
                var extract_options = function (option) {
                    return {
                        cartOptionId: option.cartOptionId,
                        value: option.value
                    };
                };
                var options_this_line = _.map(this.get('options').toJSON(), extract_options);
                var options_other_line = _.map(other_line.get('options').toJSON(), extract_options);
                return _.isEqual(options_this_line, options_other_line);
            }
            return false;
        },
        getImages: function getImages() {
            var item = this.get('item'), item_images_detail = item.get('itemimages_detail') || {};
            item_images_detail = item_images_detail.media || item_images_detail;
            var image_filters = Configuration.get('productline.multiImageOption', []), images_container = this.filterImages(item_images_detail, image_filters), result = Utils.imageFlatten(images_container);
            return result.length ? result : [{
                    url: Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', Configuration.get('imageNotAvailable')),
                    altimagetext: item.get('_name')
                }];
        },
        isSelectionComplete: function isSelectionComplete() {
            var options = this.get('options').where({ isMandatory: true });
            return _.all(options, function (option) {
                return option.isValid(true);
            });
        },
        getSelectedOptions: function getSelectedOptions() {
            var selected_options = [];
            this.get('options').each(function (option) {
                if (!option.validate()) {
                    selected_options.push(option.get('value'));
                }
            });
            return selected_options;
        },
        getValidValuesForOption: function getValidValuesForOption(option) {
            var matrix_options = this.getMatrixOptionsSelection();
            delete matrix_options[option.get('itemOptionId')];
            return _.uniq(_.map(this.getSelectedMatrixChilds(matrix_options), function (model) {
                return model.get(option.get('itemOptionId'));
            }));
        },
        getMatrixOptionsSelection: function getMatrixOptionsSelection() {
            var matrix_options = this.get('options').where({ isMatrixDimension: true }), result = {};
            _.each(matrix_options, function (matrix_option) {
                var set_value = matrix_option.get('value');
                if (set_value) {
                    result[matrix_option.get('itemOptionId')] = set_value.label;
                }
            });
            return result;
        },
        getSelectedMatrixChilds: function getSelectedMatrixChilds(matrix_options) {
            var item_matrix_children = this.get('item').get('_matrixChilds');
            if (!item_matrix_children) {
                return [];
            }
            matrix_options = matrix_options || this.getMatrixOptionsSelection();
            var selection_key = JSON.stringify(matrix_options);
            this.matrixSelectionCache = this.matrixSelectionCache || {};
            if (!this.matrixSelectionCache[selection_key]) {
                this.matrixSelectionCache[selection_key] = _.values(matrix_options).length ? item_matrix_children.where(matrix_options) : item_matrix_children.models;
            }
            return this.matrixSelectionCache[selection_key];
        },
        getItemId: function getItemId() {
            return this.getItem().get('_id');
        },
        getItem: function getItem() {
            var item = this.get('item'), children = this.getSelectedMatrixChilds();
            if (children && children.length === 1) {
                item = children[0];
            }
            return item;
        },
        getStockInfo: function getStockInfo() {
            return this.get('item').getStockInfo(this.getSelectedMatrixChilds(), this.getMatrixOptionsSelection());
        },
        getPrice: function getPrice() {
            return this.get('item').getPrice(this.get('quantity'), this.getSelectedMatrixChilds());
        }
    }, {
        createFromTransactionLine: function createFromTransactionLine(transaction_line) {
            var attributes = transaction_line.toJSON();
            delete attributes.internalid;
            _.each(attributes.options, function (option) {
                option.values = transaction_line.get('options').findWhere({ cartOptionId: option.cartOptionId }).get('values');
            });
            return new ProductModel(attributes);
        }
    });
    ProductModel.prototype = _.extend(ProductModel.prototype, ProductLineCommon);
    return ProductModel;
});
define('ProductList.Item.Model', [
    'Product.Model',
    'Item.Model',
    'underscore',
    'Backbone',
    'Utils'
], function (ProductModel, Item, _, Backbone) {
    'use strict';
    function validateLength(value, name) {
        var max_length = 300;
        if (value && value.length > max_length) {
            return _('$(0) must be at most $(1) characters').translate(name, max_length);
        }
    }
    var ProductListItemModel = ProductModel.extend({
        urlRoot: _.getAbsoluteUrl('services/ProductList.Item.Service.ss'),
        defaults: {
            priority: {
                id: '2',
                name: 'medium'
            },
            options: ''
        },
        validation: _.extend({}, ProductModel.prototype.validation, {
            name: {
                required: true,
                msg: _('Name is required').translate()
            },
            description: { fn: validateLength }
        }),
        className: 'ProductList.Item.Model',
        url: function () {
            var base_url = Backbone.Model.prototype.url.apply(this, arguments), product_list = this.get('productList'), url_params = { t: new Date().getTime() };
            if (product_list && product_list.owner) {
                url_params.user = product_list.owner;
            }
            return _.addParamsToUrl(base_url, url_params);
        },
        initialize: function (attributes) {
            if (attributes && attributes.item && attributes.item.matrix_parent) {
                attributes.item = _.extend(attributes.item, attributes.item.matrix_parent);
                delete attributes.item.matrix_parent;
            }
            var item_aux = new Item(attributes.item), item_options = item_aux.get('options');
            item_options.each(function (item_option, i) {
                var option = _.findWhere(attributes.options, { 'cartOptionId': item_option.get('cartOptionId') });
                if (!option) {
                    attributes.options.push(item_option.toJSON());
                } else if (_.isObject(option.value) && _.isEmpty(option.value)) {
                    attributes.options[i] = item_option.toJSON();
                }
            });
            ProductModel.prototype.initialize.apply(this, arguments);
        },
        getOptionsArray: function () {
            var option_values = [], selected_options = this.get('options');
            _.each(selected_options, function (value, key) {
                option_values.push({
                    id: key,
                    value: value.value,
                    displayvalue: value.displayvalue
                });
            });
            return option_values;
        },
        fulfillsMinimumQuantityRequirement: function () {
            return this.get('item').get('_minimumQuantity') <= this.get('quantity');
        },
        getItemForCart: function (id, qty, options_details, options) {
            return new ProductModel({
                internalid: id,
                quantity: qty,
                _optionsDetails: options_details,
                options: options
            });
        },
        getMatrixItem: function (optionsSelected, optionsAvailable) {
            var objSearch = {};
            _.each(_.keys(optionsSelected), function (option) {
                var optionName = _.findWhere(optionsAvailable, { 'cartOptionId': option }).itemOptionId;
                objSearch[optionName] = optionsSelected[option].label;
            });
            return _.findWhere(this.item.matrixchilditems_detail, objSearch);
        },
        isMatrixChild: function () {
            return this.item && this.item.matrix_parent && this.item.itemoptions_detail ? true : false;
        },
        clone: function clone() {
            return new ProductListItemModel(this.toJSON());
        },
        toJSON: function toJSON() {
            var result = ProductModel.prototype.toJSON.apply(this, arguments), self = this;
            result.description = this.get('description');
            result.productList = this.get('productList');
            result.priority = this.get('priority');
            result.created = this.get('created');
            result.createddate = this.get('createddate');
            result.lastmodified = this.get('lastmodified');
            result.item.internalid = this.getItem().get('internalid');
            _.each(result.options, function (option) {
                var opt = self.get('options').findWhere({ cartOptionId: option.cartOptionId });
                option.values = opt && opt.get('values');
            });
            return result;
        },
        getItemId: function () {
            return this.get('item').get('internalid');
        }
    }, {
        createFromProduct: function (product) {
            var attributes = product.toJSON();
            delete attributes.internalid;
            _.each(attributes.options, function (option) {
                option.values = product.get('options').findWhere({ cartOptionId: option.cartOptionId }).get('values');
            });
            attributes.item = product.get('item').toJSON();
            return new ProductListItemModel(attributes);
        },
        createFromTransactionLine: function (transaction_line) {
            var attributes = transaction_line.toJSON();
            delete attributes.internalid;
            _.each(attributes.options, function (option) {
                option.values = transaction_line.get('options').findWhere({ cartOptionId: option.cartOptionId }).get('values');
            });
            return new ProductListItemModel(attributes);
        }
    });
    return ProductListItemModel;
});
define('Product.Collection', [
    'Product.Model',
    'Backbone'
], function (ProductModel, Backbone) {
    'use strict';
    return Backbone.Collection.extend({ model: ProductModel });
});
define('ProductList.Item.Collection', [
    'ProductList.Item.Model',
    'Product.Collection',
    'underscore',
    'Utils'
], function (ProductListItemModel, ProductCollection, _) {
    'use strict';
    return ProductCollection.extend({
        model: ProductListItemModel,
        url: _.getAbsoluteUrl('services/ProductList.Item.Service.ss'),
        initialize: function (options) {
            ProductCollection.prototype.initialize.apply(this, arguments);
            this.options = options;
        },
        update: function (options) {
            this.fetch({
                data: {
                    productlistid: this.productListId,
                    internalid: null,
                    sort: options.sort.value,
                    order: options.order,
                    page: options.page
                },
                reset: true,
                killerId: options.killerId
            });
        }
    });
});
define('ProductList.Model', [
    'ProductList.Item.Collection',
    'underscore',
    'Backbone',
    'Utils'
], function (ProductListItemCollection, _, Backbone) {
    'use strict';
    function validateLength(value, name) {
        var max_length = 300;
        if (value && value.length > max_length) {
            return _('$(0) must be at most $(1) characters').translate(name, max_length);
        }
    }
    function validateName(value, name) {
        if (!value) {
            return _('Name is required').translate();
        }
        return validateLength(value, name);
    }
    return Backbone.Model.extend({
        urlRoot: _.getAbsoluteUrl('services/ProductList.Service.ss'),
        defaults: {
            name: '',
            description: '',
            items: new ProductListItemCollection(),
            scopeId: '2',
            scopeName: 'private',
            typeId: '1',
            typeName: 'default'
        },
        validation: {
            name: { fn: validateName },
            description: { fn: validateLength }
        },
        url: function () {
            var base_url = Backbone.Model.prototype.url.apply(this, arguments), url_params = { t: new Date().getTime() };
            return _.addParamsToUrl(base_url, url_params);
        },
        initialize: function (attributes) {
            this.on('change:items', function (model, items) {
                if (model.previous('items') instanceof ProductListItemCollection) {
                    model.set('items', model.previous('items'), { silent: true });
                    model.get('items').reset(items);
                } else {
                    model.set('items', new ProductListItemCollection(items), { silent: true });
                }
            });
            this.trigger('change:items', this, attributes && attributes.items || []);
        },
        checked: function (line) {
            return !!this.get('items').find(function (product_list_line) {
                return product_list_line.isEqual(line);
            });
        },
        getOutOfStockItems: function (items_to_check) {
            var items = !_.isUndefined(items_to_check) ? items_to_check : this.get('items');
            return items.filter(function (product_list_item) {
                return !product_list_item.get('item').get('_isPurchasable');
            });
        },
        getNotPurchasableItemsDueToMinimumQuantity: function (items_to_check) {
            var items = !_.isUndefined(items_to_check) ? items_to_check : this.get('items');
            return items.filter(function (product_list_item) {
                return !product_list_item.fulfillsMinimumQuantityRequirement();
            });
        },
        someCheckedItemsExist: function () {
            return this.get('items').some(function (product_list_item) {
                return product_list_item.get('checked');
            });
        },
        canBeAddedToCart: function (only_checked_items) {
            var items = !_.isUndefined(only_checked_items) ? new Backbone.Collection(this.get('items').filter(function (product_list_item) {
                return product_list_item.get('checked');
            })) : this.get('items');
            return items.length && this.getOutOfStockItems(items).length === 0 && this.getNotPurchasableItemsDueToMinimumQuantity(items).length === 0;
        }
    });
});
define('ProductList.Collection', [
    'ProductList.Model',
    'underscore',
    'Backbone',
    'Utils'
], function (ProductListModel, _, Backbone) {
    'use strict';
    return Backbone.Collection.extend({
        url: _.getAbsoluteUrl('services/ProductList.Service.ss'),
        model: ProductListModel,
        filtered: function (iterator) {
            return new this.constructor(this.filter(iterator));
        }
    });
});
define('ProductList.ControlItem.View', [
    'product_list_control_item.tpl',
    'jQuery',
    'Backbone'
], function (product_list_control_item_tpl, jQuery, Backbone) {
    'use strict';
    return Backbone.View.extend({
        tagName: 'li',
        template: product_list_control_item_tpl,
        events: { 'click [data-action="product-list-item"]': 'pListItemHandler' },
        initialize: function (options) {
            this.model = options.model;
            this.line = options.product;
            this.application = options.application;
            this.parentView = options.parentView;
        },
        checked: function () {
            return this.parentView.mode !== 'move' ? this.model.checked(this.line) : false;
        },
        pListItemHandler: function (e) {
            var self = this, checkbox = jQuery(e.target);
            if (self.parentView.mode === 'move') {
                self.moveProduct();
            } else {
                self.addRemoveProduct(checkbox);
            }
        },
        moveProduct: function () {
            this.parentView.moveProductHandler(this.model);
        },
        addRemoveProduct: function ($checkbox) {
            if ($checkbox.is(':checked')) {
                this.parentView.addItemToList(this.line, this.model);
            } else {
                this.removeItemFromList(this.line);
            }
        },
        removeItemFromList: function (line) {
            var self = this, selected_line = self.model.get('items').find(function (product_list_line) {
                    return product_list_line.isEqual(line);
                });
            if (selected_line) {
                selected_line.set('productList', {
                    id: self.model.get('internalid'),
                    owner: self.model.get('owner').id
                });
                self.model.get('items').remove(selected_line);
                selected_line.destroy().done(function () {
                    self.model.collection.trigger('changed');
                    self.parentView.render();
                    self.parentView.hideConfirmationMessage();
                });
            } else {
                self.parentView.render();
            }
        },
        getContext: function () {
            return {
                isMoving: this.parentView.mode === 'move',
                isChecked: this.checked(),
                isTypePredefined: this.model.get('typeName') === 'predefined',
                itemName: this.model.get('name'),
                listId: this.model.get('internalid')
            };
        }
    });
});
define('Backbone.FormView', [
    'Backbone',
    'underscore',
    'jQuery',
    'backbone.stickit',
    'Backbone.Validation'
], function (Backbone, _, jQuery) {
    'use strict';
    function buttonSubmitProgress(savingForm) {
        savingForm.find('[type="submit"]').each(function () {
            var element = jQuery(this);
            element.attr('disabled', true);
            element.data('default-text', jQuery.trim(element.text()));
            element.text(_('Processing...').translate());
        });
    }
    function buttonSubmitDone(savingForm) {
        savingForm.find('[type="submit"]').each(function () {
            var element = jQuery(this);
            element.attr('disabled', false);
            element.text(element.data('default-text'));
        });
    }
    var handler_radio = _.findWhere(Backbone.Stickit._handlers, { 'selector': 'input[type="radio"]' });
    if (handler_radio) {
        handler_radio.update = function ($el, val) {
            if (val) {
                $el.filter('[value="' + val + '"]').prop('checked', true);
            } else {
                $el.prop('checked', false);
            }
        };
    }
    return {
        bindViewToStickit: function () {
            var view = this;
            Backbone.Validation.bind(view, {
                model: view.validationModel,
                forceUpdate: true
            });
            view.stickit(view.validationModel, view.bindings);
        },
        formatBindings: function (view) {
            _(view.bindings).each(function (binding, name) {
                if (_(binding).isString()) {
                    view.bindings[name] = {
                        observe: binding,
                        setOptions: {
                            validate: true,
                            silent: true
                        },
                        events: ['blur']
                    };
                } else if (!binding.setOptions || typeof binding.setOptions.validate === 'undefined') {
                    binding.setOptions = binding.setOptions || {};
                    binding.setOptions.validate = true;
                    binding.setOptions.silent = true;
                }
            });
        },
        add: function (view, options) {
            options = options || {};
            this.formatBindings(view);
            view.validationModel = options.noCloneModel ? view.model : view.model.clone();
            !options.noCloneModel && view.model.on('change', this.synchronizeModels, view);
            view.on(view.childViews ? 'afterCompositeViewRender' : 'afterViewRender', this.bindViewToStickit);
            var self = this;
            view.destroy = _.wrap(view.destroy, function (fn) {
                this.unstickit();
                view.model.off('change', self.synchronizeModels);
                return fn.apply(this, Array.prototype.slice.call(arguments));
            });
            view.model.bind('validated', function (isValid) {
                if (view.isSavingForm && isValid === false) {
                    var $first_input_error = jQuery('body [data-validation-error]:first input');
                    if ($first_input_error) {
                        if (!jQuery('.global-views-message-error').length && $first_input_error.closest('[data-validation="control-group"]').length) {
                            jQuery('body').animate({ scrollTop: $first_input_error.closest('[data-validation="control-group"]').offset().top }, 600);
                        }
                        $first_input_error.focus();
                    }
                }
                if (view.isSavingForm && isValid === true) {
                    buttonSubmitProgress(view.$savingForm);
                }
                view.isSavingForm = false;
            });
            view.events = view.events || {};
            view.events['focusin *'] = 'formViewFocusHandler';
            var removeValidationErrors = function ($el) {
                $el.find('[data-validation-error="block"]').remove();
                $el.find('[data-validation-error]').removeAttr('data-validation-error');
            };
            view.removeValidationErrors = function () {
                removeValidationErrors(this.$el);
            };
            view.formViewFocusHandler = function () {
                if (!this.$el.hasClass('focused-form-view')) {
                    removeValidationErrors(jQuery('.focused-form-view'));
                    jQuery('.focused-form-view').removeClass('focused-form-view');
                }
                this.$el.addClass('focused-form-view');
            };
            view.saveForm = this.saveForm;
            return view.validationModel;
        },
        synchronizeModels: function (view_model) {
            if (!view_model) {
                return;
            }
            var changed_attributes = view_model.changedAttributes(), view = this;
            _.each(changed_attributes, function (value, attribute) {
                view.validationModel.set(attribute, value);
            });
        },
        saveForm: function (e, model, props) {
            e.preventDefault();
            Backbone.Validation.bind(this);
            model = model || this.model;
            this.$savingForm = jQuery(e.target).closest('form');
            this.isSavingForm = true;
            if (this.$savingForm.length) {
                this.$savingForm.find('input[type="reset"], button[type="reset"]').hide();
            }
            this.hideError();
            var self = this, options = self.selector ? { selector: self.selector } : {}, result = model.save(props || this.$savingForm.serializeObject(), _.extend({
                    wait: true,
                    forceUpdate: false,
                    success: function (model, response) {
                        if (self.inModal && self.$containerModal) {
                            self.$containerModal.modal('hide');
                        }
                        if (self.$savingForm.length) {
                            self.hideError(self.$savingForm);
                            buttonSubmitDone(self.$savingForm);
                            model.trigger('save', model, response);
                        }
                        model.trigger('saveCompleted');
                    },
                    error: function (model, response) {
                        buttonSubmitDone(self.$savingForm);
                        if (response.responseText) {
                            model.trigger('error', jQuery.parseJSON(response.responseText));
                        }
                    }
                }, options));
            if (result === false) {
                this.$savingForm.find('input[type="reset"], button[type="reset"]').show();
                this.$savingForm.find('*[type=submit], *[type=reset]').attr('disabled', false);
            }
            return result;
        }
    };
});
define('ProductList.ControlNewItem.View', [
    'ProductList.Item.Collection',
    'product_list_control_new_item.tpl',
    'jQuery',
    'Backbone',
    'Backbone.FormView'
], function (ProductListItemCollection, product_list_control_new_item_tpl, jQuery, Backbone, BackboneFormView) {
    'use strict';
    return Backbone.View.extend({
        tagName: 'div',
        template: product_list_control_new_item_tpl,
        events: {
            'submit [data-action="create-and-move"]': 'createMoveList',
            'click [data-action="show-add-new-list-form"]': 'showNewListForm'
        },
        bindings: { '[name="name"]': 'name' },
        initialize: function (options) {
            this.application = options.application;
            this.model = options.model;
            this.parentView = options.parentView;
            BackboneFormView.add(this);
        },
        createMoveList: function (event) {
            if (!this.parentView.validateGiftCertificate(this.parentView.product)) {
                return;
            }
            var self = this, save_promise = this.saveForm(event);
            if (!save_promise) {
                return;
            }
            save_promise.done(function () {
                var new_product_list = self.model, parent_view = self.parentView;
                new_product_list.set('items', new ProductListItemCollection(new_product_list.get('items').toJSON()));
                if (parent_view.mode === 'move') {
                    parent_view.moveProductHandler(new_product_list);
                    parent_view.collection.add(self.model, { merge: true });
                } else {
                    parent_view.collection.add(new_product_list);
                    parent_view.addNewProductToList(new_product_list);
                }
            });
        },
        showNewListForm: function (e) {
            e && e.stopPropagation();
            var $el = jQuery(this.el);
            var new_list_form = $el.find('form[data-type="product-list-control-add-new-list-form"]');
            if (new_list_form) {
                new_list_form.show();
                this.$('[data-type="new-product-list-name"]').focus();
                $el.find(e.target).hide();
            }
        },
        getContext: function () {
            return { isMoving: this.parentView.mode === 'move' };
        }
    });
});
define('MenuTree.Node.View', [
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'menu_tree_node.tpl',
    'Backbone'
], function (BackboneCompositeView, BackboneCollectionView, menu_tree_node_tpl, Backbone) {
    'use strict';
    var MenuTreeNodeView = Backbone.View.extend({
        template: menu_tree_node_tpl,
        initialize: function (options) {
            this.node = options.model;
            this.level = options.level;
            BackboneCompositeView.add(this);
        },
        childViews: {
            'MenuItems.Collection': function () {
                return new BackboneCollectionView({
                    collection: this.node.get('children'),
                    childView: MenuTreeNodeView,
                    viewsPerRow: 1,
                    childViewOptions: { level: this.level + 1 }
                });
            }
        },
        getContext: function () {
            return {
                node: this.node,
                level: this.level
            };
        }
    });
    return MenuTreeNodeView;
});
define('MenuTree.View', [
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'MenuTree.Node.View',
    'Singleton',
    'menu_tree.tpl',
    'Backbone',
    'underscore',
    'jQuery'
], function (BackboneCompositeView, BackboneCollectionView, MenuTreeNodeView, Singleton, menu_tree_tpl, Backbone, _, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: menu_tree_tpl,
        menuItems: [],
        events: { 'click [data-action="expander"]': 'menuClick' },
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        render: function () {
            this.fixedMenuItems = this.getFixedMenuItems();
            Backbone.View.prototype.render.apply(this, arguments);
        },
        menuClick: function (e, synthetic) {
            var target = jQuery(e.currentTarget), this_expander = target.next('[data-type="menu-tree-node-expander"]'), this_expander_is_opened = this_expander.hasClass('in'), this_expandable = target.closest('[data-type="menu-tree-node-expandable"]'), all_expandables = this.$('[data-type="menu-tree-node-expandable"]');
            all_expandables.removeClass('open');
            this_expandable.addClass('open');
            var expanding_expander = this.$(target.data('target'));
            if (!this_expander_is_opened) {
                var open_expanders = this.$('[data-type="menu-tree-node-expander"].in');
                jQuery.fn.collapse.call(open_expanders, 'hide');
                jQuery.fn.collapse.call(expanding_expander, 'show');
            }
            if (synthetic === undefined && this_expander_is_opened) {
                jQuery.fn.collapse.call(expanding_expander, 'hide');
                this_expandable.removeClass('open');
            }
        },
        updateSidebar: function (label) {
            this.currentLabel = label || this.currentLabel;
            var target = this.$('[data-id="' + this.currentLabel + '"]'), target_expandable = target.closest('[data-type="menu-tree-node-expandable"]'), anchors = this.$('[data-id]');
            anchors.removeClass('active');
            target.addClass('active');
            target_expandable.find('[data-action="expander"]:first').trigger('click', { synthetic: true });
            if (label === 'home') {
                var all_expandables = this.$('[data-type="menu-tree-node-expandable"]'), open_expanders = this.$('[data-type="menu-tree-node-expander"].in');
                all_expandables.removeClass('open');
                jQuery.fn.collapse.call(open_expanders, 'hide');
            }
        },
        getFixedMenuItems: function () {
            var self = this, fixed = null, parent = null, parsed_menu_items = [], menu_items_with_parent = [];
            _.each(this.menuItems, function (item) {
                fixed = item && self.fixMenuItems(item);
                if (fixed) {
                    parsed_menu_items.push(fixed);
                    if (fixed.parent) {
                        menu_items_with_parent.push(fixed);
                    }
                }
            });
            _.each(menu_items_with_parent, function (menu_item) {
                parent = _.findWhere(parsed_menu_items, { id: menu_item.parent });
                if (parent) {
                    if (!_.findWhere(parent.children, { id: menu_item.id })) {
                        parent.children.push(menu_item);
                        parent.children = self.sortMenuItems(parent.children);
                    }
                    parsed_menu_items = _.without(parsed_menu_items, menu_item);
                }
            });
            return this.sortMenuItems(parsed_menu_items);
        },
        sortMenuItems: function (menu_items) {
            return menu_items.sort(function (item1, item2) {
                if (item1.index !== item2.index) {
                    return item1.index - item2.index;
                } else {
                    return item1.name > item2.name ? 1 : -1;
                }
            });
        },
        addMenuItem: function (items) {
            var self = this;
            items = _.isArray(items) ? items : [items];
            _.each(items, function (item) {
                self.menuItems.push(item);
            });
        },
        fixMenuItems: function (item_) {
            var self = this, item = self.fixMenuItem(item_);
            if (item && _.isArray(item.children)) {
                item.children = _.map(item.children, function (children_item) {
                    return self.fixMenuItems(children_item);
                });
            }
            return item;
        },
        menuItemValue: function (value) {
            return _.isFunction(value) ? value.apply(this, [this.application]) : value;
        },
        fixMenuItem: function (item_) {
            var item = null;
            item_ = this.menuItemValue(item_);
            if (!item_) {
                return undefined;
            }
            item = _.clone(item_);
            item.parent = this.menuItemValue(item.parent);
            item.name = this.menuItemValue(item.name);
            item.index = this.menuItemValue(item.index);
            item.url = this.menuItemValue(item.url) ? '/' + this.menuItemValue(item.url) : '';
            item.id = this.menuItemValue(item.id);
            item.children = this.menuItemValue(item.children) || [];
            item.showChildren = !!item.children.length;
            if (item.showChildren) {
                item.children = this.sortMenuItems(item.children);
            }
            return item;
        },
        removeMenuItem: function (id) {
            this.menuItems = _.reject(this.menuItems, function (item) {
                return item.id === id;
            });
        },
        updateMenuItemsUI: function () {
            this.render();
            this.updateSidebar();
        },
        replaceMenuItem: function (filter, new_menu_item) {
            for (var i = 0; i < this.menuItems.length; i++) {
                if (filter(this.fixMenuItem(this.menuItems[i]))) {
                    this.menuItems[i] = new_menu_item;
                }
            }
        },
        getContext: function () {
            return { menuItems: this.fixedMenuItems };
        },
        childViews: {
            'MenuItems.Collection': function () {
                return new BackboneCollectionView({
                    collection: this.fixedMenuItems,
                    childView: MenuTreeNodeView,
                    viewsPerRow: 1,
                    childViewOptions: { level: 1 }
                });
            }
        }
    }, Singleton);
});
define('ProductList.Control.View', [
    'product_list_control.tpl',
    'ProductList.ControlItem.View',
    'ProductList.ControlNewItem.View',
    'Profile.Model',
    'ProductList.Model',
    'ProductList.Item.Model',
    'Session',
    'ProductList.Item.Collection',
    'MenuTree.View',
    'underscore',
    'jQuery',
    'Backbone'
], function (product_list_control_tpl, ControlItemView, ControlNewItemView, ProfileModel, ProductListModel, ProductListItemModel, Session, ProductListItemCollection, MenuTreeView, _, jQuery, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_control_tpl,
        attributes: { 'class': 'dropdown product-lists' },
        events: {
            'click [data-action="show-productlist-control"]': 'validateLogin',
            'click [data-toggle="showFlyout"]': 'showFlyout',
            'click': 'contentClick',
            'mouseup': 'contentMouseUp'
        },
        initialize: function (options) {
            this.product = options.product;
            this.collection = options.collection;
            this.application = options.application;
            this.moveOptions = options.moveOptions;
            this.countedClicks = options.countedClicks;
            if (this.moveOptions) {
                this.mode = 'move';
            }
            jQuery(document).click(function (event) {
                var outside = jQuery(event.target).parents().index(jQuery(event.target).closest('[data-type^="productlist-control"]')) === -1;
                outside = outside && jQuery(event.target).data('action') !== 'show-productlist-control';
                if (outside) {
                    if (jQuery('[data-type="productlist-control"]').is(':visible')) {
                        var $control = jQuery('[data-type="productlist-control"]');
                        $control.find('form').hide();
                        $control.find('[data-action="show-add-new-list-form"]').show();
                        $control.slideUp();
                    }
                }
            });
            this.product.on('change', this.render, this);
        },
        render: function () {
            this.is_visible = this.$('[data-type="productlist-control"]').is(':visible');
            Backbone.View.prototype.render.apply(this);
            var self = this;
            self.collection.each(function (model) {
                var view = new ControlItemView({
                    model: model,
                    product: self.product,
                    application: self.application,
                    parentView: self
                });
                self.$('ul').prepend(view.render().el);
            });
            var new_product_list_model = this.getNewProductListModel(), new_item_view = new ControlNewItemView({
                    model: new_product_list_model,
                    application: self.application,
                    parentView: self
                });
            self.$('[data-type="new-item-container"]').html(new_item_view.render().el);
            self.confirm_message && self.saveAndShowConfirmationMessage(self.confirm_message);
        },
        getNewProductListModel: function () {
            return new ProductListModel();
        },
        validateLogin: function (e) {
            if (ProfileModel.getInstance().get('isLoggedIn') === 'T') {
                return true;
            }
            e.stopPropagation();
            e.stopImmediatePropagation();
            e.preventDefault();
            var login = Session.get('touchpoints.login');
            login += '&origin=' + this.application.getConfig('currentTouchpoint');
            if (this.$el.closest('.modal-product-detail').size() > 0) {
                var hashtag = this.product.generateURL();
                login += '&origin_hash=' + encodeURIComponent(hashtag.replace('#/', ''));
            } else {
                login += '&origin_hash=' + encodeURIComponent(Backbone.history.fragment);
            }
            window.location.href = login;
        },
        validateGiftCertificate: function validateGiftCertificate(line) {
            var line_option_email = line.get('options') && line.get('options').findWhere({ cartOptionId: 'GIFTCERTRECIPIENTEMAIL' });
            if (line_option_email && !line_option_email.isValid(true)) {
                this.render();
                this.showError(this.application.getErrorMessage('recipientEmailIsInvalid'));
                return false;
            }
            return true;
        },
        getItemOptions: function (line) {
            var selected_options = line.get('options').filter(function (option) {
                return !!option.get('value');
            });
            return _.reduce(selected_options, function (acc, option) {
                var value = option.get('value') || {};
                acc[option.get('cartOptionId')] = {
                    value: value.internalid,
                    displayvalue: value.label
                };
                return acc;
            }, {});
        },
        addNewProductToList: function (newList) {
            this.addItemToList(this.product, newList, true);
            this.saveAndShowConfirmationMessage(this.$('.ul-product-lists [type="checkbox"]:checked').length > 1 ? _('Good! You added this item to your product lists').translate() : _('Good! You added this item to your product list').translate());
        },
        addItemToList: function (line, productList, dontShowMessage) {
            if (line.isValid(true)) {
                var self = this;
                if (!productList.get('internalid')) {
                    productList.save().done(function (data) {
                        var new_model = new ProductListModel(data);
                        self.application.ProductListModule.Utils.getProductLists().add(new_model, { merge: true });
                        self.doAddItemToList(line, new_model, dontShowMessage);
                    });
                } else {
                    self.doAddItemToList(line, productList, dontShowMessage);
                }
            }
        },
        getNewItemData: function (line, productList) {
            var product_list_line = ProductListItemModel.createFromProduct(line);
            product_list_line.set('productList', {
                id: productList.get('internalid'),
                owner: productList.get('owner').id
            });
            return product_list_line;
        },
        doAddItemToList: function (product, productList, dontShowMessage) {
            var self = this, product_list_line_to_save = this.getNewItemData(product, productList);
            product_list_line_to_save.save(null, {
                validate: false,
                success: function (product_list_line_to_save_saved) {
                    productList.get('items').add(product_list_line_to_save_saved);
                    self.collection.trigger('changed');
                    self.render();
                    if (!dontShowMessage) {
                        self.saveAndShowConfirmationMessage(self.$('.ul-product-lists [type="checkbox"]:checked').length > 1 ? _('Good! You added this item to your product lists').translate() : _('Good! You added this item to your product list').translate());
                    }
                }
            });
        },
        moveProductHandler: function (destination) {
            var self = this;
            if (!destination.get('internalid')) {
                destination.save().done(function (data) {
                    var new_product_list = new ProductListModel(data);
                    self.application.ProductListModule.Utils.getProductLists().add(new_product_list, { merge: true });
                    self.moveProduct(new_product_list);
                });
            } else {
                self.application.ProductListModule.Utils.getProductLists().add(destination, { merge: true });
                self.moveProduct(destination);
            }
        },
        moveProduct: function (destination) {
            var self = this, original_item = this.moveOptions.productListItem, original_item_clone = original_item.clone(), details_view = this.moveOptions.parentView;
            original_item_clone.set('productList', { id: destination.get('internalid') });
            destination.get('items').create(original_item_clone, {
                validate: false,
                success: function (saved_model) {
                    var app = details_view.application, from_list = self.application.ProductListModule.Utils.getProductLists().findWhere({ internalid: self.moveOptions.parentView.model.get('internalid') }), to_list = self.application.ProductListModule.Utils.getProductLists().findWhere({ internalid: destination.get('internalid') });
                    self.doMoveProduct(from_list, to_list, original_item, saved_model);
                    details_view.model.get('items').remove(original_item);
                    details_view.render();
                    jQuery('.sc-flyout-bg').remove();
                    MenuTreeView.getInstance().updateMenuItemsUI();
                    app.getLayout().currentView.showConfirmationMessage(_('<div class="product-list-control-message">Good! You successfully moved the item from this to <a href="/wishlist/$(0)">$(1)</a></div>').translate(destination.get('internalid'), destination.get('name')));
                }
            });
        },
        doMoveProduct: function (from, to, original_model, saved_model) {
            if (to.get('items') instanceof Array) {
                to.set('items', new ProductListItemCollection());
            }
            to.get('items').add(saved_model);
            from.get('items').remove(original_model);
            this.collection.trigger('changed');
        },
        getProductId: function (line) {
            if (line.getItemId) {
                return line.getItemId();
            } else if (this.application.ProductListModule) {
                return this.application.ProductListModule.Utils.internalGetProductId(line);
            } else {
                return line.get('_id') + '';
            }
        },
        isAvailable: function () {
            return true;
        },
        saveAndShowConfirmationMessage: function (message) {
            this.confirm_message = message;
            this.showConfirmationMessage(this.confirm_message, true);
        },
        hideConfirmationMessage: function () {
            this.confirm_message = null;
            this.$('[data-confirm-message]').hide();
        },
        showFlyout: function (e) {
            e.stopPropagation();
            if (this.product.areAttributesValid([
                    'options',
                    'quantity'
                ], {})) {
                jQuery('.product-list-control-flyout').hide();
                this.countedClicks[e.pageX + '|' + e.pageY] = false;
                var self = jQuery(e.target);
                if (_.isPhoneDevice()) {
                    self.next().toggle();
                    var body = jQuery('body');
                    var scrollvalue = self.offset();
                    body.animate({ scrollTop: scrollvalue.top }, '500', function () {
                        jQuery('#main').append('<div class="sc-flyout-bg"></div>');
                        jQuery('.sc-flyout-bg').on('click', function () {
                            jQuery('.sc-flyout-bg').remove();
                        });
                    });
                } else {
                    self.next().toggle();
                }
            }
        },
        contentClick: function (e) {
            this.countedClicks[e.pageX + '|' + e.pageY] = true;
        },
        contentMouseUp: function (e) {
            if (e.which !== 2 && e.which !== 3) {
                var self = this;
                _.delay(function () {
                    if (!self.countedClicks[e.pageX + '|' + e.pageY]) {
                        jQuery(document.elementFromPoint(e.clientX, e.clientY)).click();
                    }
                    delete self.countedClicks[e.pageX + '|' + e.pageY];
                }, 100);
            }
        },
        getContext: function () {
            return {
                isMoving: this.mode === 'move',
                showControl: this.is_visible,
                isEmpty: this.collection.length === 0,
                hasOneProductList: this.collection.length === 1,
                hasProductLists: this.collection.length > 0,
                productListLength: this.collection.length
            };
        }
    });
});
define('ProductList.ControlSingle.View', [
    'ProductList.Control.View',
    'ProductList.Item.Collection',
    'product_list_control_single.tpl',
    'underscore',
    'Backbone',
    'Backbone.View',
    'Backbone.View.render'
], function (ControlView, ProductListItemCollection, product_list_control_single_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_control_single_tpl,
        attributes: { 'class': 'product-lists-single' },
        events: { 'click [data-type="add-product-to-single-list"]': 'addItemToSingleList' },
        addItemToList: ControlView.prototype.addItemToList,
        doAddItemToList: ControlView.prototype.doAddItemToList,
        saveAndShowConfirmationMessage: ControlView.prototype.saveAndShowConfirmationMessage,
        validateGiftCertificate: ControlView.prototype.validateGiftCertificate,
        getItemOptions: ControlView.prototype.getItemOptions,
        validateLogin: ControlView.prototype.validateLogin,
        getProductId: ControlView.prototype.getProductId,
        getNewItemData: ControlView.prototype.getNewItemData,
        initialize: function (options) {
            this.product = options.product;
            this.collection = options.collection;
            this.application = options.application;
            this.single_list = this.collection.at(0);
        },
        render: function () {
            this._render();
        },
        isProductAlreadyAdded: function () {
            return this.single_list.checked(this.product);
        },
        getProductsInternalid: function () {
            return _(this.single_list.get('items').models).map(function (item) {
                return item.get('item').internalid;
            });
        },
        addItemToSingleList: function (e) {
            e.preventDefault();
            if (!this.validateLogin(e)) {
                return;
            }
            var self = this;
            if (self.product.isValid(true)) {
                if (!self.single_list.get('internalid')) {
                    self.single_list.save().done(function () {
                        self.single_list.set('items', new ProductListItemCollection([]));
                        self.renderAfterAdded(self);
                    });
                } else {
                    self.renderAfterAdded(self);
                }
            }
        },
        renderAfterAdded: function (self) {
            if (!this.validateGiftCertificate(self.product)) {
                return;
            }
            self.addItemToList(self.product, self.single_list);
            self.render();
            self.saveAndShowConfirmationMessage(_('Good! You added this item to your product list').translate());
            this.$('[data-action="add-product-to-single-list"]').attr('disabled', 'true');
        },
        getContext: function getContext() {
            var model = this.single_list;
            return {
                isProductAlreadyAdded: this.isProductAlreadyAdded(),
                name: model.get('name'),
                id: model.get('internalid')
            };
        }
    });
});
define('ErrorManagement.View', ['Backbone'], function (Backbone) {
    'use strict';
    return Backbone.View.extend({ isErrorView: true });
});
define('ErrorManagement.ExpiredLink.View', [
    'error_management_expired_link.tpl',
    'ErrorManagement.View',
    'Backbone',
    'underscore',
    'Utils'
], function (error_management_expired_link_tpl, ErrorManagementView, Backbone, _) {
    'use strict';
    return ErrorManagementView.extend({
        template: error_management_expired_link_tpl,
        attributes: {
            'id': 'expired_link',
            'class': 'expired_link'
        },
        initialize: function (options) {
            if (options.title) {
                this.title = options.title;
            }
            if (options.page_header) {
                this.page_header = options.page_header;
            }
            if (options.message) {
                this.message = options.message;
            }
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                nsglobal.statusCode = 500;
            }
        },
        getContext: function () {
            return {
                pageHeader: this.page_header || '',
                message: this.message || _('Sorry, we could not load the content you requested.').translate()
            };
        }
    });
});
define('ErrorManagement.ForbiddenError.View', [
    'error_management_forbidden_error.tpl',
    'ErrorManagement.View',
    'Backbone',
    'underscore',
    'Utils'
], function (error_management_forbidden_error_tpl, ErrorManagementView, Backbone, _) {
    'use strict';
    return ErrorManagementView.extend({
        template: error_management_forbidden_error_tpl,
        attributes: {
            'id': 'forbidden-error',
            'class': 'forbidden-error'
        },
        title: _('NOT ALLOWED').translate(),
        page_header: _('NOT ALLOWED').translate(),
        initialize: function () {
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                nsglobal.statusCode = 403;
            }
        },
        getContext: function () {
            return {
                title: this.title,
                pageHeader: this.page_header
            };
        }
    });
});
define('ErrorManagement.InternalError.View', [
    'error_management_internal_error.tpl',
    'ErrorManagement.View',
    'Backbone',
    'underscore',
    'Utils'
], function (error_management_internal_error_tpl, ErrorManagementView, Backbone, _) {
    'use strict';
    return ErrorManagementView.extend({
        template: error_management_internal_error_tpl,
        attributes: {
            'id': 'internal-error',
            'class': 'internal-error'
        },
        title: _('Internal Error').translate(),
        page_header: _('Internal Error').translate(),
        initialize: function (options) {
            if (options.title) {
                this.title = options.title;
            }
            if (options.page_header || options.pageHeader) {
                this.page_header = options.page_header || options.pageHeader;
            }
            if (options.message) {
                this.message = options.message;
            }
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                nsglobal.statusCode = 500;
            }
        },
        getContext: function () {
            return {
                pageHeader: this.page_header,
                message: this.message || _('Sorry, we could not load the content you requested.').translate()
            };
        }
    });
});
define('ErrorManagement.LoggedOut.View', [
    'error_management_logged_out.tpl',
    'ErrorManagement.View',
    'Backbone',
    'underscore',
    'Utils'
], function (error_management_logged_out_tpl, ErrorManagementView, Backbone, _) {
    'use strict';
    return ErrorManagementView.extend({
        template: error_management_logged_out_tpl,
        attributes: { 'id': 'logged-out' },
        title: _('Logged out').translate(),
        initialize: function () {
            this.labels = {
                title: _('You have been logged out').translate(),
                explanation: _('Your session expired or someone else logged in another device with your account. You must log in again to continue.').translate(),
                login: _('Log in').translate()
            };
        },
        showError: function () {
        },
        render: function () {
            var res = Backbone.View.prototype.render.apply(this, arguments);
            this.$containerModal.find('[data-dismiss="modal"]').remove();
            return res;
        },
        getContext: function () {
            return { labels: this.labels };
        }
    });
});
define('ErrorManagement.PageNotFound.View', [
    'error_management_page_not_found.tpl',
    'ErrorManagement.View',
    'Backbone',
    'underscore',
    'Utils'
], function (error_management_page_not_found_tpl, ErrorManagementView, Backbone, _) {
    'use strict';
    return ErrorManagementView.extend({
        template: error_management_page_not_found_tpl,
        attributes: {
            'id': 'page-not-found',
            'class': 'page-not-found'
        },
        title: _('Page not found').translate(),
        page_header: _('Page not found').translate(),
        initialize: function () {
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                nsglobal.statusCode = 404;
            }
        },
        getContext: function () {
            return {
                title: this.title,
                pageHeader: this.page_header
            };
        }
    });
});
define('ErrorManagement.ResponseErrorParser', ['underscore'], function (_) {
    'use strict';
    return function ErrorManagementErrorParser(jqXhr, messageKeys) {
        var message = null, current_key;
        try {
            var response = JSON.parse(jqXhr.responseText);
            if (response) {
                for (var i = 0; i < messageKeys.length; i++) {
                    current_key = messageKeys[i];
                    if (response[current_key]) {
                        message = _.isArray(response[current_key]) ? response[current_key][0] : response[current_key];
                        break;
                    }
                }
            }
        } catch (err) {
            console.error('Impossible to parse backend error', jqXhr);
        }
        return message;
    };
});
define('ErrorManagement', [
    'SC.Configuration',
    'Session',
    'ErrorManagement.ExpiredLink.View',
    'ErrorManagement.ForbiddenError.View',
    'ErrorManagement.InternalError.View',
    'ErrorManagement.LoggedOut.View',
    'ErrorManagement.PageNotFound.View',
    'ErrorManagement.ResponseErrorParser',
    'GlobalViews.Message.View',
    'jQuery',
    'Backbone',
    'underscore',
    'Profile.Model',
    'Utils'
], function (Configuration, Session, ExpiredLinkView, ForbiddenErrorView, InternalErrorView, LoggedOutView, PageNotFoundView, ErrorManagementResponseErrorParser, GlobalViewsMessageView, jQuery, Backbone, _, ProfileModel, Utils) {
    'use strict';
    _.extend(Backbone.View.prototype, {
        hideError: function () {
            this.$('[data-type="alert-placeholder"]').empty();
        },
        showError: function (message, type, closable, disableElements) {
            this.hideError();
            var placeholder = this.$('[data-type="alert-placeholder"]');
            if (!placeholder.length) {
                placeholder = jQuery('<div/>', { 'data-type': 'alert-placeholder' });
                this.$el.prepend(placeholder);
            }
            var global_view_message = new GlobalViewsMessageView({
                message: message,
                type: type ? type : 'error',
                closable: !_.isUndefined(closable) ? !!closable : false
            });
            placeholder.append(global_view_message.render().$el.html());
            if (!disableElements) {
                this.$(':disabled').attr('disabled', false);
            }
            if (this.application) {
                _.result(this.application.getLayout(), 'backToTop');
            }
        },
        showErrorInModal: function (message) {
            var view = new Backbone.View({ application: this.application });
            view.title = _('Error').translate();
            view.render = function () {
                this.$el.append('<p class="error-message">' + message + '</p>');
            };
            view.showInModal();
        }
    });
    return {
        parseErrorMessage: ErrorManagementResponseErrorParser,
        mountToApp: function (application) {
            var Layout = application.getLayout();
            _.extend(Layout, {
                errorMessageKeys: [
                    'errorMessage',
                    'errors',
                    'error',
                    'message'
                ],
                notFound: function () {
                    var view = new PageNotFoundView({ application: application });
                    view.showContent();
                },
                internalError: function (message, pageHeader, title) {
                    var view = new InternalErrorView({
                        application: application,
                        message: message,
                        pageHeader: pageHeader,
                        title: title
                    });
                    view.showContent();
                },
                expiredLink: function (message) {
                    var view = new ExpiredLinkView({
                        application: application,
                        pageHeader: message,
                        title: message
                    });
                    view.showContent();
                },
                forbiddenError: function () {
                    var view = new ForbiddenErrorView({ application: application });
                    view.showContent();
                },
                unauthorizedError: function (user_session_timedOut) {
                    if (Configuration.get('currentTouchpoint', '') === 'login') {
                        return;
                    }
                    ProfileModel.getInstance().set({
                        isLoggedIn: 'F',
                        isGuest: 'F'
                    });
                    var base_url = Utils.setUrlParameter(Session.get('touchpoints.login'), 'origin', Configuration.get('currentTouchpoint'));
                    base_url = Utils.setUrlParameter(base_url, 'origin_hash', Backbone.history.fragment);
                    Configuration.currentTouchpoint = 'login';
                    window.location = user_session_timedOut ? Utils.setUrlParameter(base_url, 'timeout', 'T') : base_url;
                }
            });
            jQuery(document).ajaxError(function (e, jqXhr, options, error_text) {
                var intStatus = parseInt(jqXhr.status, 10);
                if (error_text === 'abort' || intStatus === 0) {
                    return;
                }
                if (intStatus === 401 || intStatus === 206) {
                    Layout.unauthorizedError(jqXhr.responseJSON && jqXhr.responseJSON.errorCode === 'ERR_USER_SESSION_TIMED_OUT');
                    return;
                }
                if (!jqXhr.preventDefault) {
                    var message = ErrorManagementResponseErrorParser(jqXhr, Layout.errorMessageKeys);
                    if (!message || _.isObject(message) && !message.errorCode) {
                        message = _('An internal error has occurred').translate();
                    }
                    if (options.type === 'GET' && options.killerId) {
                        if (intStatus === 403) {
                            Layout.forbiddenError();
                        } else if (intStatus === 404) {
                            Layout.notFound();
                        } else {
                            Layout.internalError(message);
                        }
                    } else if (Layout.currentView) {
                        if (intStatus !== 403) {
                            if (Layout.modalCurrentView) {
                                Layout.modalCurrentView.showError(message);
                            } else {
                                var childViewInstances = Layout.currentView.getChildViewInstances();
                                var activeView = _.find(childViewInstances, function (childView) {
                                    return childView && (childView.$('.focused-form-view').length > 0 || childView.$el.is('.focused-form-view'));
                                });
                                activeView = activeView || Layout.currentView;
                                activeView.showError(message);
                            }
                        } else {
                            var view = Layout.modalCurrentView || Layout.currentView;
                            if (view && _.isFunction(view.forbiddenError)) {
                                view.forbiddenError();
                            } else {
                                Layout.forbiddenError();
                            }
                        }
                    } else {
                        Layout.internalError();
                    }
                }
            });
            var control_valid_navigation = function control_valid_navigation() {
                if (!Backbone.history.started) {
                    return;
                }
                var fragment = Backbone.history.getFragment(), match = _(Backbone.history.handlers).some(function (handler) {
                        if (handler.callback && handler.route.exec(fragment)) {
                            return true;
                        }
                    });
                if (!match) {
                    Layout.notFound();
                }
            };
            jQuery(window).on('hashchange', control_valid_navigation);
            application.once('afterStart', control_valid_navigation);
        }
    };
});
define('ProductViews.Price.View', [
    'Profile.Model',
    'Session',
    'SC.Configuration',
    'product_views_price.tpl',
    'Backbone',
    'underscore'
], function (ProfileModel, Session, Configuration, product_views_price_tpl, Backbone, _) {
    'use strict';
    var ProductViewsPriceView = Backbone.View.extend({
        template: product_views_price_tpl,
        initialize: function () {
            this.model.on('change', this.render, this);
        },
        getUrlLogin: function () {
            var url = Session.get('touchpoints.login') + '&origin=' + (Configuration.get('currentTouchpoint') || 'home') + '&origin_hash=';
            return url + encodeURIComponent(this.options.origin === 'PDPQUICK' ? this.model.generateURL().replace('/', '') : Backbone.history.fragment);
        },
        getContext: function () {
            var price_container_object = this.model.getPrice(), is_price_range = !!(price_container_object.min && price_container_object.max), showComparePrice = false;
            if (!this.options.hideComparePrice) {
                showComparePrice = is_price_range ? price_container_object.max.price < price_container_object.compare_price : price_container_object.price < price_container_object.compare_price;
            }
            return {
                isPriceEnabled: !ProfileModel.getInstance().hidePrices(),
                urlLogin: this.getUrlLogin(),
                isPriceRange: is_price_range,
                showComparePrice: showComparePrice,
                isInStock: this.model.getStockInfo().isInStock,
                model: this.model,
                currencyCode: SC.getSessionInfo('currency') ? SC.getSessionInfo('currency').code : '',
                priceFormatted: price_container_object.price_formatted || '',
                comparePriceFormatted: price_container_object.compare_price_formatted || '',
                minPriceFormatted: price_container_object.min ? price_container_object.min.price_formatted : '',
                maxPriceFormatted: price_container_object.max ? price_container_object.max.price_formatted : '',
                price: price_container_object.price ? price_container_object.price : 0,
                comparePrice: price_container_object.compare_price ? price_container_object.compare_price : 0,
                minPrice: price_container_object.min ? price_container_object.min.price : 0,
                maxPrice: price_container_object.max ? price_container_object.max.price : 0,
                showHighlightedMessage: _.indexOf(ProductViewsPriceView.highlightedViews, this.options.origin) >= 0
            };
        }
    }, {
        highlightedViews: [
            'PDPQUICK',
            'PDPFULL'
        ]
    });
    return ProductViewsPriceView;
});
define('ProductLine.Stock.View', [
    'product_line_stock.tpl',
    'Backbone'
], function (product_line_stock_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_line_stock_tpl,
        initialize: function () {
            this.model.on('change', this.render, this);
        },
        destroy: function destroy() {
            Backbone.View.prototype.destroy.apply(this, arguments);
            this.model.off('change', this.render, this);
        },
        getContext: function () {
            this.stock_info = this.model.getStockInfo();
            return {
                showOutOfStockMessage: !!(!this.stock_info.isInStock && this.stock_info.showOutOfStockMessage),
                stockInfo: this.stock_info,
                model: this.model,
                showInStockMessage: !(!this.stock_info.isInStock && this.stock_info.showOutOfStockMessage) && !!this.stock_info.showInStockMessage,
                isNotAvailableInStore: this.stock_info.isNotAvailableInStore
            };
        }
    });
});
define('ProductList.DetailsMinQuantity.View', [
    'product_list_details_min_quantity.tpl',
    'Backbone'
], function (product_list_details_min_quantity_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_details_min_quantity_tpl,
        getContext: function () {
            var item_model = this.model.get('item');
            return {
                fulfillsMinQuantityRequirements: this.model.fulfillsMinimumQuantityRequirement(),
                minimumQuantity: item_model.get('_minimumQuantity'),
                quantity: this.model.get('quantity'),
                id: this.model.get('internalid')
            };
        }
    });
});
define('ProductLine.StockDescription.View', [
    'product_line_stock_description.tpl',
    'Backbone'
], function (product_line_stock_description_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_line_stock_description_tpl,
        initialize: function () {
            this.model.on('change', this.render, this);
        },
        getContext: function () {
            this.stock_info = this.model.getStockInfo();
            return {
                showStockDescription: !!(this.stock_info.showStockDescription && this.stock_info.stockDescription),
                stockInfo: this.stock_info
            };
        }
    });
});
define('ProductList.DetailsLaterMacro.View', [
    'ProductViews.Price.View',
    'ProductLine.Stock.View',
    'ProductList.DetailsMinQuantity.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Transaction.Line.Views.Options.Selected.View',
    'ProductLine.StockDescription.View',
    'product_list_details_later_macro.tpl',
    'underscore',
    'Backbone'
], function (ProductViewsPriceView, ProductLineStockView, ProductListDetailsMinQuantityView, BackboneCompositeView, BackboneCollectionView, TransactionLineViewsOptionsSelectedView, ProductLineStockDescriptionView, product_list_details_later_macro_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_details_later_macro_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        childViews: {
            'ItemViews.Price': function () {
                return new ProductViewsPriceView({
                    model: this.model,
                    origin: 'PRODUCTLISTDETAILSLATER'
                });
            },
            'Item.SelectedOptions': function () {
                return new TransactionLineViewsOptionsSelectedView({ model: this.model });
            },
            'ItemViews.Stock': function () {
                return new ProductLineStockView({ model: this.model });
            },
            'ProductList.DetailsMinQuantity': function () {
                return new ProductListDetailsMinQuantityView({ model: this.model });
            },
            'StockDescription': function () {
                return new ProductLineStockDescriptionView({ model: this.model });
            }
        },
        getContext: function () {
            var item = this.model.get('item');
            return {
                model: this.model,
                quantity: this.model.get('quantity'),
                itemId: item.get('internalid'),
                canBeAddedToCart: item.get('ispurchasable') && this.model.fulfillsMinimumQuantityRequirement(),
                itemDetailsUrl: this.model.generateURL(),
                isGiftCertificate: item.get('itemtype') === 'GiftCert',
                showActions: !this.options.hide_actions,
                thumbnail: this.model.getThumbnail()
            };
        }
    });
});
define('ProductList.Edit.View', [
    'ProductList.Model',
    'ProductList.Item.Collection',
    'MenuTree.View',
    'Backbone.FormView',
    'product_list_new.tpl',
    'underscore',
    'Backbone',
    'Backbone.View',
    'Backbone.View.render',
    'Utils'
], function (ProductListModel, ProductListItemCollection, MenuTreeView, BackboneFormView, product_list_new_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_new_tpl,
        attributes: { 'class': 'product-list-new-wrapper' },
        events: {
            'submit form': 'saveForm',
            '[data-action="prevent-enter"]': 'preventEnter'
        },
        bindings: { '[name="name"]': 'name' },
        initialize: function (options) {
            this.application = options.application;
            this.parentView = options.parentView;
            this.model = options.model;
            this.isEdit = this.model.get('internalid');
            this.page_header = this.getTitle();
            this.inModal = options.inModal;
            BackboneFormView.add(this);
            this.model.once('saveCompleted', _.bind(this.onSaveComplete, this));
        },
        preventEnter: function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
            }
        },
        getTitle: function () {
            this.$('[name="name"]').focus();
            var editLabel = _('Edit your list').translate();
            var newLabel = _('Edit your list').translate();
            return this.isEdit ? editLabel : newLabel;
        },
        onSaveComplete: function () {
            var self = this;
            if (_.isArray(self.model.get('items'))) {
                self.model.set('items', new ProductListItemCollection(self.model.get('items')));
            }
            self.$containerModal && self.$containerModal.modal('hide');
            if (self.isEdit) {
                self.application.ProductListModule.Utils.getProductLists().add(self.model, { merge: true });
                MenuTreeView.getInstance().updateMenuItemsUI();
                self.parentView.render();
                if (self.parentView.$el.hasClass('ProductListDetailsView')) {
                    self.parentView.showConfirmationMessage(_('Good! The list was successfully updated. ').translate());
                } else {
                    self.parentView.showConfirmationMessage(_('Good! Your <a href="/wishlist/$(0)">$(1)</a> list was successfully updated. ').translate(self.model.get('internalid'), self.model.get('name')));
                }
            } else {
                self.application.ProductListModule.Utils.getProductLists().add(self.model);
                MenuTreeView.getInstance().updateMenuItemsUI();
                self.parentView.render();
                self.parentView.showConfirmationMessage(_('Good! Your <a href="/wishlist/$(0)">$(1)</a> list was successfully created. ').translate(self.model.get('internalid'), self.model.get('name')));
            }
            self.parentView.highlightList && self.parentView.highlightList(self.model.get('internalid'));
        },
        getName: function () {
            return this.$('.product-list-new-name-input input').val();
        },
        getNotes: function () {
            return this.$('.product-list-new-notes-input textarea').val();
        },
        getContext: function () {
            var model = this.model;
            return {
                inModal: !!this.inModal,
                isEdit: !!this.isEdit,
                name: model.get('name'),
                description: model.get('description')
            };
        }
    });
});
define('GlobalViews.StarRating.View', [
    'SC.Configuration',
    'global_views_star_rating.tpl',
    'Backbone',
    'jQuery',
    'underscore'
], function (Configuration, global_views_star_rating_tpl, Backbone, jQuery, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_star_rating_tpl,
        initialize: function () {
            if (!this.model) {
                return;
            }
            this.options.value = this.model.get('_rating') || this.model.get('rating') || 0;
            this.options.ratingCount = this.model.get('_ratingsCount') || 0;
            this.options.label = this.model.get('label') || '';
            this.options.name = this.model.get('name');
        },
        getContext: function () {
            var fill_value = Math.round(this.options.value * 2) / 2, max_value = this.options.max || Configuration.get('productReviews.maxRate', 5);
            return {
                showLabelRating: this.options.showLabelRating || false,
                showLabel: !!this.options.label,
                label: this.options.label || '',
                name: this.options.name || '',
                maxValue: max_value,
                value: this.options.value,
                fillValue: fill_value,
                filledBy: fill_value * 100 / max_value,
                isWritable: !!this.options.isWritable,
                buttons: _.range(max_value),
                showValue: !!this.options.showValue,
                showRatingCount: !!this.options.showRatingCount,
                ratingCount: this.options.ratingCount,
                className: this.options.className ? '-' + this.options.className : '',
                ratingCountGreaterThan0: this.options.ratingCount > 0,
                hasOneReview: this.options.ratingCount === 1
            };
        }
    });
});
define('ProductList.DisplayFull.View', [
    'ProductViews.Price.View',
    'ProductLine.Stock.View',
    'GlobalViews.StarRating.View',
    'ProductList.DetailsMinQuantity.View',
    'Backbone.CompositeView',
    'Transaction.Line.Views.Options.Selected.View',
    'ProductLine.StockDescription.View',
    'product_list_display_full.tpl',
    'underscore',
    'Backbone'
], function (ProductViewsPriceView, ProductLineStockView, GlobalViewsStarRatingView, ProductListDetailsMinQuantityView, BackboneCompositeView, TransactionLineViewsOptionsSelectedView, ProductLineStockDescriptionView, product_list_display_full_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_display_full_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        childViews: {
            'ItemViews.Price': function () {
                return new ProductViewsPriceView({
                    model: this.model,
                    origin: 'PRODUCTLISTDETAILSFULL'
                });
            },
            'Item.SelectedOptions': function () {
                return new TransactionLineViewsOptionsSelectedView({ model: this.model });
            },
            'ItemViews.Stock': function () {
                return new ProductLineStockView({ model: this.model });
            },
            'GlobalViews.StarRating': function () {
                return new GlobalViewsStarRatingView({ model: this.model.get('item') });
            },
            'ProductList.DetailsMinQuantity': function () {
                return new ProductListDetailsMinQuantityView({ model: this.model });
            },
            'StockDescription': function () {
                return new ProductLineStockDescriptionView({ model: this.model });
            }
        },
        getContext: function getContext() {
            var line = this.model, options = this.options || {}, priority = line.get('priority'), item = line.get('item'), description = line.get('description');
            return {
                lineId: line.get('internalid'),
                isChecked: !!line.get('checked'),
                quantity: line.get('quantity'),
                description: description,
                hasDescription: !!description,
                showEdit: options.show_edit_action,
                showMoveAction: options.show_move_action,
                showAddedOn: !options.hide_added_on,
                itemId: line.getItemId(),
                isAvailableForCart: item.get('_isPurchasable') && line.fulfillsMinimumQuantityRequirement(),
                showRating: !options.hide_rating,
                showCheckbox: !options.hide_checkbox,
                productName: item.get('_name'),
                priorityName: priority.name,
                itemCreatedDate: line.get('createddate'),
                linkAttributes: line.getFullLink(),
                thumbnail: this.model.getThumbnail()
            };
        }
    });
});
define('ProductList.AddedToCart.View', [
    'Backbone.CollectionView',
    'Backbone.CompositeView',
    'ProductList.DisplayFull.View',
    'product_list_added_to_cart.tpl',
    'underscore',
    'Backbone',
    'Backbone.View',
    'Backbone.View.render',
    'Utils'
], function (BackboneCollectionView, BackboneCompositeView, ProductListDisplayFullView, product_list_added_to_cart_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_added_to_cart_tpl,
        attributes: { 'class': 'product-list-added-to-cart' },
        title: _('Added to Cart').translate(),
        initialize: function (options) {
            this.application = options.application;
            BackboneCompositeView.add(this);
        },
        render: function () {
            Backbone.View.prototype.render.apply(this);
            var list = this.options.list, not_purchasable_items_count = this.options.not_purchasable_items_count;
            if (list && not_purchasable_items_count > 0) {
                var warning_message = not_purchasable_items_count === 1 ? _('One item not available for purchase was not added to the cart.').translate() : _('$(0) items not available for purchase were not added to the cart.').translate(not_purchasable_items_count);
                this.showWarningMessage(warning_message);
            }
        },
        showWarningMessage: function (message) {
            this.$('[data-warning-message]').empty().append(message);
        },
        isPurchasable: function (model) {
            return model.get('item').get('_isPurchasable');
        },
        childViews: {
            'ProductList.ItemsAddedToCart': function () {
                var list = this.options.list, isItem = !list;
                return new BackboneCollectionView({
                    childView: ProductListDisplayFullView,
                    childViewOptions: {
                        application: this.application,
                        hide_rating: true,
                        hide_added_on: true,
                        hide_checkbox: true,
                        id: 'list',
                        name: 'List',
                        icon: 'icon-th-list',
                        isDefault: true
                    },
                    viewsPerRow: 1,
                    collection: isItem ? [this.options.item] : list.get('items').models.filter(this.isPurchasable)
                });
            }
        },
        getContext: function () {
            var list = this.options.list, isItem = !list, models = isItem ? [this.options.item] : list.get('items').models.filter(this.isPurchasable);
            return {
                isItem: isItem,
                hasMoreThanOneModel: models.length > 1,
                listName: list.get('name'),
                modelsLength: models.length
            };
        }
    });
});
define('GlobalViews.Confirmation.View', [
    'global_views_confirmation.tpl',
    'Backbone.CompositeView',
    'Backbone',
    'underscore',
    'Utils'
], function (global_views_confirmation_tpl, BackboneCompositeView, Backbone, _, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_confirmation_tpl,
        title: _('Confirm').translate(),
        page_header: _('Confirm').translate(),
        events: {
            'click [data-action="confirm"]': 'confirm',
            'click [data-action="cancel"]': 'cancel'
        },
        initialize: function (options) {
            this.callBack = options.callBack;
            this.callBackParameters = options.callBackParameters;
            this.cancelCallBack = options.cancelCallBack;
            this.cancelCallBackParameters = options.cancelCallBackParameters;
            this.title = options.title || this.title;
            this.page_header = options.title || this.page_header;
            this.className = options.className || '';
            this.body = options.body;
            this.showBodyMessage = !options.view;
            this.childViewMessage = options.view;
            this.childViewMessageParameters = options.viewParameters;
            this.autohide = !!options.autohide;
            this.confirmLabel = options.confirmLabel;
            this.cancelLabel = options.cancelLabel;
            BackboneCompositeView.add(this);
            this.once('afterViewRender', function () {
                var self = this;
                self.$containerModal.on('shown.bs.modal', function () {
                    self.$containerModal.off('shown.bs.modal');
                    self.$('[data-action="confirm"]').focus();
                });
            }, this);
        },
        childViews: {
            'ChildViewMessage': function () {
                return new this.childViewMessage(this.childViewMessageParameters || {});
            }
        },
        confirm: function confirm() {
            _.isFunction(this.callBack) && this.callBack.call(this, this.callBackParameters);
            if (this.autohide) {
                this.$containerModal.modal('hide');
            }
        },
        cancel: function cancel() {
            _.isFunction(this.cancelCallBack) && this.cancelCallBack.call(this, this.cancelCallBackParameters);
            if (this.autohide) {
                this.$containerModal.modal('hide');
            }
        },
        getTitle: function getTitle() {
            return Utils.translate('Confirmation');
        },
        getContext: function getContext() {
            return {
                body: this.body,
                hasConfirmLabel: !!this.confirmLabel,
                confirmLabel: this.confirmLabel,
                hasCancelLabel: !!this.cancelLabel,
                cancelLabel: this.cancelLabel,
                showBodyMessage: this.showBodyMessage,
                className: this.className
            };
        }
    });
});
define('ProductList.ListDetails.View', [
    'product_list_list_details.tpl',
    'underscore',
    'Backbone'
], function (product_list_list_details_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_list_details_tpl,
        getContext: function () {
            var list = this.options.model, items = list.get('items'), outOfStockItems = list.getOutOfStockItems();
            var minimumQuantityItems = list.getNotPurchasableItemsDueToMinimumQuantity();
            var last_product_item = _.sortBy(items.models, function (it) {
                    return new Date(it.get('created'));
                }).reverse()[0], list_description = list.get('description');
            var result = {
                isChecked: list.get('checked'),
                internalId: list.get('internalid'),
                isAvailableForCart: list.canBeAddedToCart(),
                templateId: list.get('templateId'),
                isTypePredefined: list.get('typeName') === 'predefined',
                listName: list.get('name'),
                hasItems: !!items.length,
                itemsLength: items.length,
                hasOneItem: items.length === 1,
                hasLastItem: false,
                lastProductItemUrl: null,
                lastItemDisplayName: null,
                hasOutOfStockItems: outOfStockItems.length > 0,
                hasMinimumQuantityItems: minimumQuantityItems.length > 0,
                lastModifiedDate: list.get('lastmodifieddate'),
                listDescription: list_description,
                hasListDescription: !!list_description,
                isListPrivate: list.get('scopeName') === 'private'
            };
            if (last_product_item) {
                result.hasLastItem = !!last_product_item.get('item');
                result.lastProductItemUrl = last_product_item.getFullLink();
                result.lastItemDisplayName = last_product_item.get('item').get('_name');
            }
            return result;
        }
    });
});
define('ProductList.Lists.View', [
    'ProductList.Model',
    'ProductList.Item.Collection',
    'ProductList.Edit.View',
    'MenuTree.View',
    'ProductList.AddedToCart.View',
    'GlobalViews.Confirmation.View',
    'product_list_lists.tpl',
    'LiveOrder.Model',
    'ProductList.ListDetails.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'SC.Configuration',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.View',
    'Backbone.View.render',
    'Utils'
], function (ProductListModel, ProductListItemCollection, ProductListCreationView, MenuTreeView, ProductListAddedToCartView, GlobalViewsConfirmationView, product_list_lists_tpl, LiveOrderModel, ProductListListDetailsView, BackboneCompositeView, BackboneCollectionView, Configuration, _, jQuery, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_lists_tpl,
        title: _('Wishlist').translate(),
        className: 'ProductListListsView',
        attributes: { 'class': 'ProductListListsView' },
        events: {
            'change [data-action="sort-by"]': 'sortBy',
            'click [data-action="add-list"]': 'createProductList',
            'click [data-action="delete-list"]': 'askDeleteList',
            'click [data-action="edit-list"]': 'editListHandler',
            'click [data-action="share-list"]': 'shareList',
            'click [data-action="add-to-cart"]': 'addListToCartHandler',
            'click [data-action="select"]': 'toggleProductListHandler',
            'click [data-action="navigate"]': 'navigateToItems'
        },
        initialize: function (options) {
            this.options = options;
            this.application = options.application;
            BackboneCompositeView.add(this);
        },
        render: function () {
            Backbone.View.prototype.render.apply(this, arguments);
            if (!this.collection.length) {
                this.newProductListView = new ProductListCreationView({
                    application: this.application,
                    parentView: this,
                    model: new ProductListModel()
                });
                this.newProductListView.render();
                this.$('[data-type="new-product-list"]').append(this.newProductListView.$el);
            }
        },
        createProductList: function () {
            this.newProductListView = new ProductListCreationView({
                application: this.application,
                parentView: this,
                model: new ProductListModel()
            });
            this.application.getLayout().showInModal(this.newProductListView);
        },
        askDeleteList: function (e) {
            this.deleteConfirmationView = new GlobalViewsConfirmationView({
                callBackParameters: {
                    target: e.target,
                    context: this
                },
                callBack: this.deleteListHandler,
                title: _('Delete list').translate(),
                autohide: false,
                body: _('Are you sure you want to remove this list?').translate()
            });
            this.application.getLayout().showInModal(this.deleteConfirmationView);
        },
        deleteListHandler: function (options) {
            var self = options.context, target = options.target, list = self.getListFromDom(jQuery(target));
            self.collection.remove(list);
            list.url = ProductListModel.prototype.url;
            list.destroy().done(function () {
                MenuTreeView.getInstance().updateMenuItemsUI();
                self.render();
                self.showConfirmationMessage(_('Your <span class="product-list-name">$(0)</span> list was removed').translate(list.get('name')));
                self.deleteConfirmationView.$containerModal.modal('hide');
            });
        },
        highlightList: function (internalid) {
            var $list_dom = jQuery(this.el).find('article[data-product-list-id=' + internalid + ']');
            if ($list_dom) {
                $list_dom.addClass('new-list');
                setTimeout(function () {
                    $list_dom.removeClass('new-list');
                }, 3000);
            }
        },
        addListToCartHandler: function (e) {
            var list = this.getCurrentList(e);
            this.addListToCart(list);
        },
        addListToCart: function (list) {
            var lines_to_add = [], self = this, not_purchasable_items_count = 0;
            list.get('items').each(function (pli) {
                if (pli.get('item').get('_isPurchasable')) {
                    lines_to_add.push(pli);
                } else {
                    not_purchasable_items_count++;
                }
            });
            if (lines_to_add.length === 0) {
                var errorMessage = _('All items in the list are not available for purchase.').translate();
                self.showWarningMessage(errorMessage);
                return;
            }
            LiveOrderModel.getInstance().addProducts(lines_to_add).done(function () {
                self.application.ProductListModule.Utils.getProductList(list.get('internalid')).done(function (model) {
                    self.addedToCartView = new ProductListAddedToCartView({
                        application: self.application,
                        parentView: self,
                        list: new ProductListModel(model),
                        not_purchasable_items_count: not_purchasable_items_count
                    });
                    var confirmMessage;
                    if (list.get('items').length > 1) {
                        confirmMessage = _('Good! $(0) items from your <a class="product-list-name" href="/wishlist/$(1)">$(2)</a> list were successfully added to your cart. You can continue to <a href="">view your cart and checkout</a>').translate(list.get('items').length, list.get('internalid'), list.get('name'));
                    } else {
                        confirmMessage = _('Good! $(0) item from your <a class="product-list-name" href="/wishlist/$(1)">$(2)</a> list was successfully added to your cart. You can continue to <a href="" data-touchpoint="viewcart">view your cart and checkout</a>').translate(list.get('items').length, list.get('internalid'), list.get('name'));
                    }
                    self.showConfirmationMessage(confirmMessage);
                    self.application.getLayout().showInModal(self.addedToCartView);
                });
            });
        },
        editListHandler: function (e) {
            var list = this.getListFromDom(jQuery(e.target));
            this.editList(list);
        },
        getListFromDom: function ($target) {
            var list_id = $target.closest('[data-product-list-id]').data('product-list-id') + '';
            return this.options.collection.where({ internalid: list_id })[0];
        },
        editList: function (list) {
            this.newProductListView = new ProductListCreationView({
                application: this.application,
                parentView: this,
                model: list,
                inModal: true
            });
            this.application.getLayout().showInModal(this.newProductListView);
        },
        getSelectedMenu: function () {
            return 'productlist_all';
        },
        getBreadcrumbPages: function () {
            return {
                text: _('Wishlist').translate(),
                href: '/wishlist'
            };
        },
        toggleProductListItemHandler: function (e) {
            this.toggleProductListItem(jQuery(e.target).closest('article').data('id'));
        },
        toggleProductListHandler: function (e) {
            this.toggleProductList(jQuery(e.target).closest('article').data('id'));
        },
        toggleProductList: function (pl_internalid) {
            var pl = this.collection.get(pl_internalid);
            if (pl) {
                this[pl.get('checked') ? 'unselectProductList' : 'selectProductList'](pl);
                this.render();
            }
        },
        selectProductList: function (pl) {
            if (pl) {
                pl.set('checked', true);
            }
        },
        unselectProductList: function (pl) {
            if (pl) {
                pl.set('checked', false);
            }
        },
        getCurrentList: function (e) {
            var list_id = jQuery(e.target).closest('[data-product-list-id]').data('product-list-id') + '', list = this.options.collection.findWhere({ internalid: list_id });
            return list;
        },
        navigateToItems: function (e) {
            if (_.isTargetActionable(e)) {
                return;
            }
            var list = this.getCurrentList(e), internalid = list.get('internalid'), url = '/wishlist/' + (internalid ? internalid : 'tmpl_' + list.get('templateid'));
            Backbone.history.navigate(url, { trigger: true });
        },
        childViews: {
            'ProductList.ListDetails': function () {
                return new BackboneCollectionView({
                    childView: ProductListListDetailsView,
                    viewsPerRow: 1,
                    collection: this.collection
                });
            }
        },
        getContext: function () {
            return {
                hasLists: this.collection.length,
                showBackToAccount: Configuration.get('siteSettings.sitetype') === 'STANDARD',
                isSingleList: this.application.ProductListModule.Utils.isSingleList()
            };
        }
    });
});
define('bootstrap', ['jQuery'], function () {
    +function ($) {
        'use strict';
        var Affix = function (element, options) {
            this.options = $.extend({}, Affix.DEFAULTS, options);
            this.$target = $(this.options.target).on('scroll.bs.affix.data-api', $.proxy(this.checkPosition, this)).on('click.bs.affix.data-api', $.proxy(this.checkPositionWithEventLoop, this));
            this.$element = $(element);
            this.affixed = this.unpin = this.pinnedOffset = null;
            this.checkPosition();
        };
        Affix.VERSION = '3.3.1';
        Affix.RESET = 'affix affix-top affix-bottom';
        Affix.DEFAULTS = {
            offset: 0,
            target: window
        };
        Affix.prototype.getState = function (scrollHeight, height, offsetTop, offsetBottom) {
            var scrollTop = this.$target.scrollTop();
            var position = this.$element.offset();
            var targetHeight = this.$target.height();
            if (offsetTop != null && this.affixed == 'top')
                return scrollTop < offsetTop ? 'top' : false;
            if (this.affixed == 'bottom') {
                if (offsetTop != null)
                    return scrollTop + this.unpin <= position.top ? false : 'bottom';
                return scrollTop + targetHeight <= scrollHeight - offsetBottom ? false : 'bottom';
            }
            var initializing = this.affixed == null;
            var colliderTop = initializing ? scrollTop : position.top;
            var colliderHeight = initializing ? targetHeight : height;
            if (offsetTop != null && colliderTop <= offsetTop)
                return 'top';
            if (offsetBottom != null && colliderTop + colliderHeight >= scrollHeight - offsetBottom)
                return 'bottom';
            return false;
        };
        Affix.prototype.getPinnedOffset = function () {
            if (this.pinnedOffset)
                return this.pinnedOffset;
            this.$element.removeClass(Affix.RESET).addClass('affix');
            var scrollTop = this.$target.scrollTop();
            var position = this.$element.offset();
            return this.pinnedOffset = position.top - scrollTop;
        };
        Affix.prototype.checkPositionWithEventLoop = function () {
            setTimeout($.proxy(this.checkPosition, this), 1);
        };
        Affix.prototype.checkPosition = function () {
            if (!this.$element.is(':visible'))
                return;
            var height = this.$element.height();
            var offset = this.options.offset;
            var offsetTop = offset.top;
            var offsetBottom = offset.bottom;
            var scrollHeight = $('body').height();
            if (typeof offset != 'object')
                offsetBottom = offsetTop = offset;
            if (typeof offsetTop == 'function')
                offsetTop = offset.top(this.$element);
            if (typeof offsetBottom == 'function')
                offsetBottom = offset.bottom(this.$element);
            var affix = this.getState(scrollHeight, height, offsetTop, offsetBottom);
            if (this.affixed != affix) {
                if (this.unpin != null)
                    this.$element.css('top', '');
                var affixType = 'affix' + (affix ? '-' + affix : '');
                var e = $.Event(affixType + '.bs.affix');
                this.$element.trigger(e);
                if (e.isDefaultPrevented())
                    return;
                this.affixed = affix;
                this.unpin = affix == 'bottom' ? this.getPinnedOffset() : null;
                this.$element.removeClass(Affix.RESET).addClass(affixType).trigger(affixType.replace('affix', 'affixed') + '.bs.affix');
            }
            if (affix == 'bottom') {
                this.$element.offset({ top: scrollHeight - height - offsetBottom });
            }
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.affix');
                var options = typeof option == 'object' && option;
                if (!data)
                    $this.data('bs.affix', data = new Affix(this, options));
                if (typeof option == 'string')
                    data[option]();
            });
        }
        var old = $.fn.affix;
        $.fn.affix = Plugin;
        $.fn.affix.Constructor = Affix;
        $.fn.affix.noConflict = function () {
            $.fn.affix = old;
            return this;
        };
        $(window).on('load', function () {
            $('[data-spy="affix"]').each(function () {
                var $spy = $(this);
                var data = $spy.data();
                data.offset = data.offset || {};
                if (data.offsetBottom != null)
                    data.offset.bottom = data.offsetBottom;
                if (data.offsetTop != null)
                    data.offset.top = data.offsetTop;
                Plugin.call($spy, data);
            });
        });
    }(jQuery);
    +function ($) {
        'use strict';
        var dismiss = '[data-dismiss="alert"]';
        var Alert = function (el) {
            $(el).on('click', dismiss, this.close);
        };
        Alert.VERSION = '3.3.1';
        Alert.TRANSITION_DURATION = 150;
        Alert.prototype.close = function (e) {
            var $this = $(this);
            var selector = $this.attr('data-target');
            if (!selector) {
                selector = $this.attr('href');
                selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '');
            }
            var $parent = $(selector);
            if (e)
                e.preventDefault();
            if (!$parent.length) {
                $parent = $this.closest('.alert');
            }
            $parent.trigger(e = $.Event('close.bs.alert'));
            if (e.isDefaultPrevented())
                return;
            $parent.removeClass('in');
            function removeElement() {
                $parent.detach().trigger('closed.bs.alert').remove();
            }
            $.support.transition && $parent.hasClass('fade') ? $parent.one('bsTransitionEnd', removeElement).emulateTransitionEnd(Alert.TRANSITION_DURATION) : removeElement();
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.alert');
                if (!data)
                    $this.data('bs.alert', data = new Alert(this));
                if (typeof option == 'string')
                    data[option].call($this);
            });
        }
        var old = $.fn.alert;
        $.fn.alert = Plugin;
        $.fn.alert.Constructor = Alert;
        $.fn.alert.noConflict = function () {
            $.fn.alert = old;
            return this;
        };
        $(document).on('click.bs.alert.data-api', dismiss, Alert.prototype.close);
    }(jQuery);
    +function ($) {
        'use strict';
        var Button = function (element, options) {
            this.$element = $(element);
            this.options = $.extend({}, Button.DEFAULTS, options);
            this.isLoading = false;
        };
        Button.VERSION = '3.3.1';
        Button.DEFAULTS = { loadingText: 'loading...' };
        Button.prototype.setState = function (state) {
            var d = 'disabled';
            var $el = this.$element;
            var val = $el.is('input') ? 'val' : 'html';
            var data = $el.data();
            state = state + 'Text';
            if (data.resetText == null)
                $el.data('resetText', $el[val]());
            setTimeout($.proxy(function () {
                $el[val](data[state] == null ? this.options[state] : data[state]);
                if (state == 'loadingText') {
                    this.isLoading = true;
                    $el.addClass(d).attr(d, d);
                } else if (this.isLoading) {
                    this.isLoading = false;
                    $el.removeClass(d).removeAttr(d);
                }
            }, this), 0);
        };
        Button.prototype.toggle = function () {
            var changed = true;
            var $parent = this.$element.closest('[data-toggle="buttons"]');
            if ($parent.length) {
                var $input = this.$element.find('input');
                if ($input.prop('type') == 'radio') {
                    if ($input.prop('checked') && this.$element.hasClass('active'))
                        changed = false;
                    else
                        $parent.find('.active').removeClass('active');
                }
                if (changed)
                    $input.prop('checked', !this.$element.hasClass('active')).trigger('change');
            } else {
                this.$element.attr('aria-pressed', !this.$element.hasClass('active'));
            }
            if (changed)
                this.$element.toggleClass('active');
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.button');
                var options = typeof option == 'object' && option;
                if (!data)
                    $this.data('bs.button', data = new Button(this, options));
                if (option == 'toggle')
                    data.toggle();
                else if (option)
                    data.setState(option);
            });
        }
        var old = $.fn.button;
        $.fn.button = Plugin;
        $.fn.button.Constructor = Button;
        $.fn.button.noConflict = function () {
            $.fn.button = old;
            return this;
        };
        $(document).on('click.bs.button.data-api', '[data-toggle^="button"]', function (e) {
            var $btn = $(e.target);
            if (!$btn.hasClass('btn'))
                $btn = $btn.closest('.btn');
            Plugin.call($btn, 'toggle');
            e.preventDefault();
        }).on('focus.bs.button.data-api blur.bs.button.data-api', '[data-toggle^="button"]', function (e) {
            $(e.target).closest('.btn').toggleClass('focus', /^focus(in)?$/.test(e.type));
        });
    }(jQuery);
    +function ($) {
        'use strict';
        var Carousel = function (element, options) {
            this.$element = $(element);
            this.$indicators = this.$element.find('.carousel-indicators');
            this.options = options;
            this.paused = this.sliding = this.interval = this.$active = this.$items = null;
            this.options.keyboard && this.$element.on('keydown.bs.carousel', $.proxy(this.keydown, this));
            this.options.pause == 'hover' && !('ontouchstart' in document.documentElement) && this.$element.on('mouseenter.bs.carousel', $.proxy(this.pause, this)).on('mouseleave.bs.carousel', $.proxy(this.cycle, this));
        };
        Carousel.VERSION = '3.3.1';
        Carousel.TRANSITION_DURATION = 600;
        Carousel.DEFAULTS = {
            interval: 5000,
            pause: 'hover',
            wrap: true,
            keyboard: true
        };
        Carousel.prototype.keydown = function (e) {
            if (/input|textarea/i.test(e.target.tagName))
                return;
            switch (e.which) {
            case 37:
                this.prev();
                break;
            case 39:
                this.next();
                break;
            default:
                return;
            }
            e.preventDefault();
        };
        Carousel.prototype.cycle = function (e) {
            e || (this.paused = false);
            this.interval && clearInterval(this.interval);
            this.options.interval && !this.paused && (this.interval = setInterval($.proxy(this.next, this), this.options.interval));
            return this;
        };
        Carousel.prototype.getItemIndex = function (item) {
            this.$items = item.parent().children('.item');
            return this.$items.index(item || this.$active);
        };
        Carousel.prototype.getItemForDirection = function (direction, active) {
            var delta = direction == 'prev' ? -1 : 1;
            var activeIndex = this.getItemIndex(active);
            var itemIndex = (activeIndex + delta) % this.$items.length;
            return this.$items.eq(itemIndex);
        };
        Carousel.prototype.to = function (pos) {
            var that = this;
            var activeIndex = this.getItemIndex(this.$active = this.$element.find('.item.active'));
            if (pos > this.$items.length - 1 || pos < 0)
                return;
            if (this.sliding)
                return this.$element.one('slid.bs.carousel', function () {
                    that.to(pos);
                });
            if (activeIndex == pos)
                return this.pause().cycle();
            return this.slide(pos > activeIndex ? 'next' : 'prev', this.$items.eq(pos));
        };
        Carousel.prototype.pause = function (e) {
            e || (this.paused = true);
            if (this.$element.find('.next, .prev').length && $.support.transition) {
                this.$element.trigger($.support.transition.end);
                this.cycle(true);
            }
            this.interval = clearInterval(this.interval);
            return this;
        };
        Carousel.prototype.next = function () {
            if (this.sliding)
                return;
            return this.slide('next');
        };
        Carousel.prototype.prev = function () {
            if (this.sliding)
                return;
            return this.slide('prev');
        };
        Carousel.prototype.slide = function (type, next) {
            var $active = this.$element.find('.item.active');
            var $next = next || this.getItemForDirection(type, $active);
            var isCycling = this.interval;
            var direction = type == 'next' ? 'left' : 'right';
            var fallback = type == 'next' ? 'first' : 'last';
            var that = this;
            if (!$next.length) {
                if (!this.options.wrap)
                    return;
                $next = this.$element.find('.item')[fallback]();
            }
            if ($next.hasClass('active'))
                return this.sliding = false;
            var relatedTarget = $next[0];
            var slideEvent = $.Event('slide.bs.carousel', {
                relatedTarget: relatedTarget,
                direction: direction
            });
            this.$element.trigger(slideEvent);
            if (slideEvent.isDefaultPrevented())
                return;
            this.sliding = true;
            isCycling && this.pause();
            if (this.$indicators.length) {
                this.$indicators.find('.active').removeClass('active');
                var $nextIndicator = $(this.$indicators.children()[this.getItemIndex($next)]);
                $nextIndicator && $nextIndicator.addClass('active');
            }
            var slidEvent = $.Event('slid.bs.carousel', {
                relatedTarget: relatedTarget,
                direction: direction
            });
            if ($.support.transition && this.$element.hasClass('slide')) {
                $next.addClass(type);
                $next[0].offsetWidth;
                $active.addClass(direction);
                $next.addClass(direction);
                $active.one('bsTransitionEnd', function () {
                    $next.removeClass([
                        type,
                        direction
                    ].join(' ')).addClass('active');
                    $active.removeClass([
                        'active',
                        direction
                    ].join(' '));
                    that.sliding = false;
                    setTimeout(function () {
                        that.$element.trigger(slidEvent);
                    }, 0);
                }).emulateTransitionEnd(Carousel.TRANSITION_DURATION);
            } else {
                $active.removeClass('active');
                $next.addClass('active');
                this.sliding = false;
                this.$element.trigger(slidEvent);
            }
            isCycling && this.cycle();
            return this;
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.carousel');
                var options = $.extend({}, Carousel.DEFAULTS, $this.data(), typeof option == 'object' && option);
                var action = typeof option == 'string' ? option : options.slide;
                if (!data)
                    $this.data('bs.carousel', data = new Carousel(this, options));
                if (typeof option == 'number')
                    data.to(option);
                else if (action)
                    data[action]();
                else if (options.interval)
                    data.pause().cycle();
            });
        }
        var old = $.fn.carousel;
        $.fn.carousel = Plugin;
        $.fn.carousel.Constructor = Carousel;
        $.fn.carousel.noConflict = function () {
            $.fn.carousel = old;
            return this;
        };
        var clickHandler = function (e) {
            var href;
            var $this = $(this);
            var $target = $($this.attr('data-target') || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, ''));
            if (!$target.hasClass('carousel'))
                return;
            var options = $.extend({}, $target.data(), $this.data());
            var slideIndex = $this.attr('data-slide-to');
            if (slideIndex)
                options.interval = false;
            Plugin.call($target, options);
            if (slideIndex) {
                $target.data('bs.carousel').to(slideIndex);
            }
            e.preventDefault();
        };
        $(document).on('click.bs.carousel.data-api', '[data-slide]', clickHandler).on('click.bs.carousel.data-api', '[data-slide-to]', clickHandler);
        $(window).on('load', function () {
            $('[data-ride="carousel"]').each(function () {
                var $carousel = $(this);
                Plugin.call($carousel, $carousel.data());
            });
        });
    }(jQuery);
    +function ($) {
        'use strict';
        var Collapse = function (element, options) {
            this.$element = $(element);
            this.options = $.extend({}, Collapse.DEFAULTS, options);
            this.$trigger = $(this.options.trigger).filter('[href="#' + element.id + '"], [data-target="#' + element.id + '"]');
            this.transitioning = null;
            if (this.options.parent) {
                this.$parent = this.getParent();
            } else {
                this.addAriaAndCollapsedClass(this.$element, this.$trigger);
            }
            if (this.options.toggle)
                this.toggle();
        };
        Collapse.VERSION = '3.3.1';
        Collapse.TRANSITION_DURATION = 350;
        Collapse.DEFAULTS = {
            toggle: true,
            trigger: '[data-toggle="collapse"]'
        };
        Collapse.prototype.dimension = function () {
            var hasWidth = this.$element.hasClass('width');
            return hasWidth ? 'width' : 'height';
        };
        Collapse.prototype.show = function () {
            if (this.transitioning || this.$element.hasClass('in'))
                return;
            var activesData;
            var actives = this.$parent && this.$parent.find('> .panel').children('.in, .collapsing');
            if (actives && actives.length) {
                activesData = actives.data('bs.collapse');
                if (activesData && activesData.transitioning)
                    return;
            }
            var startEvent = $.Event('show.bs.collapse');
            this.$element.trigger(startEvent);
            if (startEvent.isDefaultPrevented())
                return;
            if (actives && actives.length) {
                Plugin.call(actives, 'hide');
                activesData || actives.data('bs.collapse', null);
            }
            var dimension = this.dimension();
            this.$element.removeClass('collapse').addClass('collapsing')[dimension](0).attr('aria-expanded', true);
            this.$trigger.removeClass('collapsed').attr('aria-expanded', true);
            this.transitioning = 1;
            var complete = function () {
                this.$element.removeClass('collapsing').addClass('collapse in')[dimension]('');
                this.transitioning = 0;
                this.$element.trigger('shown.bs.collapse');
            };
            if (!$.support.transition)
                return complete.call(this);
            var scrollSize = $.camelCase([
                'scroll',
                dimension
            ].join('-'));
            this.$element.one('bsTransitionEnd', $.proxy(complete, this)).emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize]);
        };
        Collapse.prototype.hide = function () {
            if (this.transitioning || !this.$element.hasClass('in'))
                return;
            var startEvent = $.Event('hide.bs.collapse');
            this.$element.trigger(startEvent);
            if (startEvent.isDefaultPrevented())
                return;
            var dimension = this.dimension();
            this.$element[dimension](this.$element[dimension]())[0].offsetHeight;
            this.$element.addClass('collapsing').removeClass('collapse in').attr('aria-expanded', false);
            this.$trigger.addClass('collapsed').attr('aria-expanded', false);
            this.transitioning = 1;
            var complete = function () {
                this.transitioning = 0;
                this.$element.removeClass('collapsing').addClass('collapse').trigger('hidden.bs.collapse');
            };
            if (!$.support.transition)
                return complete.call(this);
            this.$element[dimension](0).one('bsTransitionEnd', $.proxy(complete, this)).emulateTransitionEnd(Collapse.TRANSITION_DURATION);
        };
        Collapse.prototype.toggle = function () {
            this[this.$element.hasClass('in') ? 'hide' : 'show']();
        };
        Collapse.prototype.getParent = function () {
            return $(this.options.parent).find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]').each($.proxy(function (i, element) {
                var $element = $(element);
                this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element);
            }, this)).end();
        };
        Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
            var isOpen = $element.hasClass('in');
            $element.attr('aria-expanded', isOpen);
            $trigger.toggleClass('collapsed', !isOpen).attr('aria-expanded', isOpen);
        };
        function getTargetFromTrigger($trigger) {
            var href;
            var target = $trigger.attr('data-target') || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '');
            return $(target);
        }
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.collapse');
                var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option);
                if (!data && options.toggle && option == 'show')
                    options.toggle = false;
                if (!data)
                    $this.data('bs.collapse', data = new Collapse(this, options));
                if (typeof option == 'string')
                    data[option]();
            });
        }
        var old = $.fn.collapse;
        $.fn.collapse = Plugin;
        $.fn.collapse.Constructor = Collapse;
        $.fn.collapse.noConflict = function () {
            $.fn.collapse = old;
            return this;
        };
        $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
            var $this = $(this);
            if (!$this.attr('data-target'))
                e.preventDefault();
            var $target = getTargetFromTrigger($this);
            var data = $target.data('bs.collapse');
            var option = data ? 'toggle' : $.extend({}, $this.data(), { trigger: this });
            Plugin.call($target, option);
        });
    }(jQuery);
    +function ($) {
        'use strict';
        var backdrop = '.dropdown-backdrop';
        var toggle = '[data-toggle="dropdown"]';
        var Dropdown = function (element) {
            $(element).on('click.bs.dropdown', this.toggle);
        };
        Dropdown.VERSION = '3.3.1';
        Dropdown.prototype.toggle = function (e) {
            var $this = $(this);
            if ($this.is('.disabled, :disabled'))
                return;
            var $parent = getParent($this);
            var isActive = $parent.hasClass('open');
            clearMenus();
            if (!isActive) {
                if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
                    $('<div class="dropdown-backdrop"/>').insertAfter($(this)).on('click', clearMenus);
                }
                var relatedTarget = { relatedTarget: this };
                $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget));
                if (e.isDefaultPrevented())
                    return;
                $this.trigger('focus').attr('aria-expanded', 'true');
                $parent.toggleClass('open').trigger('shown.bs.dropdown', relatedTarget);
            }
            return false;
        };
        Dropdown.prototype.keydown = function (e) {
            if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName))
                return;
            var $this = $(this);
            e.preventDefault();
            e.stopPropagation();
            if ($this.is('.disabled, :disabled'))
                return;
            var $parent = getParent($this);
            var isActive = $parent.hasClass('open');
            if (!isActive && e.which != 27 || isActive && e.which == 27) {
                if (e.which == 27)
                    $parent.find(toggle).trigger('focus');
                return $this.trigger('click');
            }
            var desc = ' li:not(.divider):visible a';
            var $items = $parent.find('[role="menu"]' + desc + ', [role="listbox"]' + desc);
            if (!$items.length)
                return;
            var index = $items.index(e.target);
            if (e.which == 38 && index > 0)
                index--;
            if (e.which == 40 && index < $items.length - 1)
                index++;
            if (!~index)
                index = 0;
            $items.eq(index).trigger('focus');
        };
        function clearMenus(e) {
            if (e && e.which === 3)
                return;
            $(backdrop).remove();
            $(toggle).each(function () {
                var $this = $(this);
                var $parent = getParent($this);
                var relatedTarget = { relatedTarget: this };
                if (!$parent.hasClass('open'))
                    return;
                $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget));
                if (e.isDefaultPrevented())
                    return;
                $this.attr('aria-expanded', 'false');
                $parent.removeClass('open').trigger('hidden.bs.dropdown', relatedTarget);
            });
        }
        function getParent($this) {
            var selector = $this.attr('data-target');
            if (!selector) {
                selector = $this.attr('href');
                selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '');
            }
            var $parent = selector && $(selector);
            return $parent && $parent.length ? $parent : $this.parent();
        }
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.dropdown');
                if (!data)
                    $this.data('bs.dropdown', data = new Dropdown(this));
                if (typeof option == 'string')
                    data[option].call($this);
            });
        }
        var old = $.fn.dropdown;
        $.fn.dropdown = Plugin;
        $.fn.dropdown.Constructor = Dropdown;
        $.fn.dropdown.noConflict = function () {
            $.fn.dropdown = old;
            return this;
        };
        $(document).on('click.bs.dropdown.data-api', clearMenus).on('click.bs.dropdown.data-api', '.dropdown form', function (e) {
            e.stopPropagation();
        }).on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle).on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown).on('keydown.bs.dropdown.data-api', '[role="menu"]', Dropdown.prototype.keydown).on('keydown.bs.dropdown.data-api', '[role="listbox"]', Dropdown.prototype.keydown);
    }(jQuery);
    +function ($) {
        'use strict';
        var Tab = function (element) {
            this.element = $(element);
        };
        Tab.VERSION = '3.3.1';
        Tab.TRANSITION_DURATION = 150;
        Tab.prototype.show = function () {
            var $this = this.element;
            var $ul = $this.closest('ul:not(.dropdown-menu)');
            var selector = $this.data('target');
            if (!selector) {
                selector = $this.attr('href');
                selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '');
            }
            if ($this.parent('li').hasClass('active'))
                return;
            var $previous = $ul.find('.active:last a');
            var hideEvent = $.Event('hide.bs.tab', { relatedTarget: $this[0] });
            var showEvent = $.Event('show.bs.tab', { relatedTarget: $previous[0] });
            $previous.trigger(hideEvent);
            $this.trigger(showEvent);
            if (showEvent.isDefaultPrevented() || hideEvent.isDefaultPrevented())
                return;
            var $target = $(selector);
            this.activate($this.closest('li'), $ul);
            this.activate($target, $target.parent(), function () {
                $previous.trigger({
                    type: 'hidden.bs.tab',
                    relatedTarget: $this[0]
                });
                $this.trigger({
                    type: 'shown.bs.tab',
                    relatedTarget: $previous[0]
                });
            });
        };
        Tab.prototype.activate = function (element, container, callback) {
            var $active = container.find('> .active');
            var transition = callback && $.support.transition && ($active.length && $active.hasClass('fade') || !!container.find('> .fade').length);
            function next() {
                $active.removeClass('active').find('> .dropdown-menu > .active').removeClass('active').end().find('[data-toggle="tab"]').attr('aria-expanded', false);
                element.addClass('active').find('[data-toggle="tab"]').attr('aria-expanded', true);
                if (transition) {
                    element[0].offsetWidth;
                    element.addClass('in');
                } else {
                    element.removeClass('fade');
                }
                if (element.parent('.dropdown-menu')) {
                    element.closest('li.dropdown').addClass('active').end().find('[data-toggle="tab"]').attr('aria-expanded', true);
                }
                callback && callback();
            }
            $active.length && transition ? $active.one('bsTransitionEnd', next).emulateTransitionEnd(Tab.TRANSITION_DURATION) : next();
            $active.removeClass('in');
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.tab');
                if (!data)
                    $this.data('bs.tab', data = new Tab(this));
                if (typeof option == 'string')
                    data[option]();
            });
        }
        var old = $.fn.tab;
        $.fn.tab = Plugin;
        $.fn.tab.Constructor = Tab;
        $.fn.tab.noConflict = function () {
            $.fn.tab = old;
            return this;
        };
        var clickHandler = function (e) {
            e.preventDefault();
            Plugin.call($(this), 'show');
        };
        $(document).on('click.bs.tab.data-api', '[data-toggle="tab"]', clickHandler).on('click.bs.tab.data-api', '[data-toggle="pill"]', clickHandler);
    }(jQuery);
    +function ($) {
        'use strict';
        function transitionEnd() {
            var el = document.createElement('bootstrap');
            var transEndEventNames = {
                WebkitTransition: 'webkitTransitionEnd',
                MozTransition: 'transitionend',
                OTransition: 'oTransitionEnd otransitionend',
                transition: 'transitionend'
            };
            for (var name in transEndEventNames) {
                if (el.style[name] !== undefined) {
                    return { end: transEndEventNames[name] };
                }
            }
            return false;
        }
        $.fn.emulateTransitionEnd = function (duration) {
            var called = false;
            var $el = this;
            $(this).one('bsTransitionEnd', function () {
                called = true;
            });
            var callback = function () {
                if (!called)
                    $($el).trigger($.support.transition.end);
            };
            setTimeout(callback, duration);
            return this;
        };
        $(function () {
            $.support.transition = transitionEnd();
            if (!$.support.transition)
                return;
            $.event.special.bsTransitionEnd = {
                bindType: $.support.transition.end,
                delegateType: $.support.transition.end,
                handle: function (e) {
                    if ($(e.target).is(this))
                        return e.handleObj.handler.apply(this, arguments);
                }
            };
        });
    }(jQuery);
    +function ($) {
        'use strict';
        function ScrollSpy(element, options) {
            var process = $.proxy(this.process, this);
            this.$body = $('body');
            this.$scrollElement = $(element).is('body') ? $(window) : $(element);
            this.options = $.extend({}, ScrollSpy.DEFAULTS, options);
            this.selector = (this.options.target || '') + ' .nav li > a';
            this.offsets = [];
            this.targets = [];
            this.activeTarget = null;
            this.scrollHeight = 0;
            this.$scrollElement.on('scroll.bs.scrollspy', process);
            this.refresh();
            this.process();
        }
        ScrollSpy.VERSION = '3.3.1';
        ScrollSpy.DEFAULTS = { offset: 10 };
        ScrollSpy.prototype.getScrollHeight = function () {
            return this.$scrollElement[0].scrollHeight || Math.max(this.$body[0].scrollHeight, document.documentElement.scrollHeight);
        };
        ScrollSpy.prototype.refresh = function () {
            var offsetMethod = 'offset';
            var offsetBase = 0;
            if (!$.isWindow(this.$scrollElement[0])) {
                offsetMethod = 'position';
                offsetBase = this.$scrollElement.scrollTop();
            }
            this.offsets = [];
            this.targets = [];
            this.scrollHeight = this.getScrollHeight();
            var self = this;
            this.$body.find(this.selector).map(function () {
                var $el = $(this);
                var href = $el.data('target') || $el.attr('href');
                var $href = /^#./.test(href) && $(href);
                return $href && $href.length && $href.is(':visible') && [[
                        $href[offsetMethod]().top + offsetBase,
                        href
                    ]] || null;
            }).sort(function (a, b) {
                return a[0] - b[0];
            }).each(function () {
                self.offsets.push(this[0]);
                self.targets.push(this[1]);
            });
        };
        ScrollSpy.prototype.process = function () {
            var scrollTop = this.$scrollElement.scrollTop() + this.options.offset;
            var scrollHeight = this.getScrollHeight();
            var maxScroll = this.options.offset + scrollHeight - this.$scrollElement.height();
            var offsets = this.offsets;
            var targets = this.targets;
            var activeTarget = this.activeTarget;
            var i;
            if (this.scrollHeight != scrollHeight) {
                this.refresh();
            }
            if (scrollTop >= maxScroll) {
                return activeTarget != (i = targets[targets.length - 1]) && this.activate(i);
            }
            if (activeTarget && scrollTop < offsets[0]) {
                this.activeTarget = null;
                return this.clear();
            }
            for (i = offsets.length; i--;) {
                activeTarget != targets[i] && scrollTop >= offsets[i] && (!offsets[i + 1] || scrollTop <= offsets[i + 1]) && this.activate(targets[i]);
            }
        };
        ScrollSpy.prototype.activate = function (target) {
            this.activeTarget = target;
            this.clear();
            var selector = this.selector + '[data-target="' + target + '"],' + this.selector + '[href="' + target + '"]';
            var active = $(selector).parents('li').addClass('active');
            if (active.parent('.dropdown-menu').length) {
                active = active.closest('li.dropdown').addClass('active');
            }
            active.trigger('activate.bs.scrollspy');
        };
        ScrollSpy.prototype.clear = function () {
            $(this.selector).parentsUntil(this.options.target, '.active').removeClass('active');
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.scrollspy');
                var options = typeof option == 'object' && option;
                if (!data)
                    $this.data('bs.scrollspy', data = new ScrollSpy(this, options));
                if (typeof option == 'string')
                    data[option]();
            });
        }
        var old = $.fn.scrollspy;
        $.fn.scrollspy = Plugin;
        $.fn.scrollspy.Constructor = ScrollSpy;
        $.fn.scrollspy.noConflict = function () {
            $.fn.scrollspy = old;
            return this;
        };
        $(window).on('load.bs.scrollspy.data-api', function () {
            $('[data-spy="scroll"]').each(function () {
                var $spy = $(this);
                Plugin.call($spy, $spy.data());
            });
        });
    }(jQuery);
    +function ($) {
        'use strict';
        var Modal = function (element, options) {
            this.options = options;
            this.$body = $(document.body);
            this.$element = $(element);
            this.$backdrop = this.isShown = null;
            this.scrollbarWidth = 0;
            if (this.options.remote) {
                this.$element.find('.modal-content').load(this.options.remote, $.proxy(function () {
                    this.$element.trigger('loaded.bs.modal');
                }, this));
            }
        };
        Modal.VERSION = '3.3.1';
        Modal.TRANSITION_DURATION = 300;
        Modal.BACKDROP_TRANSITION_DURATION = 150;
        Modal.DEFAULTS = {
            backdrop: true,
            keyboard: true,
            show: true
        };
        Modal.prototype.toggle = function (_relatedTarget) {
            return this.isShown ? this.hide() : this.show(_relatedTarget);
        };
        Modal.prototype.show = function (_relatedTarget) {
            var that = this;
            var e = $.Event('show.bs.modal', { relatedTarget: _relatedTarget });
            this.$element.trigger(e);
            if (this.isShown || e.isDefaultPrevented())
                return;
            this.isShown = true;
            this.checkScrollbar();
            this.setScrollbar();
            this.$body.addClass('modal-open');
            this.escape();
            this.resize();
            this.$element.on('click.dismiss.bs.modal', '[data-dismiss="modal"]', $.proxy(this.hide, this));
            this.backdrop(function () {
                var transition = $.support.transition && that.$element.hasClass('fade');
                if (!that.$element.parent().length) {
                    that.$element.appendTo(that.$body);
                }
                that.$element.show().scrollTop(0);
                if (that.options.backdrop)
                    that.adjustBackdrop();
                that.adjustDialog();
                if (transition) {
                    that.$element[0].offsetWidth;
                }
                that.$element.addClass('in').attr('aria-hidden', false);
                that.enforceFocus();
                var e = $.Event('shown.bs.modal', { relatedTarget: _relatedTarget });
                transition ? that.$element.find('.modal-dialog').one('bsTransitionEnd', function () {
                    that.$element.trigger('focus').trigger(e);
                }).emulateTransitionEnd(Modal.TRANSITION_DURATION) : that.$element.trigger('focus').trigger(e);
            });
        };
        Modal.prototype.hide = function (e) {
            if (e)
                e.preventDefault();
            e = $.Event('hide.bs.modal');
            this.$element.trigger(e);
            if (!this.isShown || e.isDefaultPrevented())
                return;
            this.isShown = false;
            this.escape();
            this.resize();
            $(document).off('focusin.bs.modal');
            this.$element.removeClass('in').attr('aria-hidden', true).off('click.dismiss.bs.modal');
            $.support.transition && this.$element.hasClass('fade') ? this.$element.one('bsTransitionEnd', $.proxy(this.hideModal, this)).emulateTransitionEnd(Modal.TRANSITION_DURATION) : this.hideModal();
        };
        Modal.prototype.enforceFocus = function () {
            $(document).off('focusin.bs.modal').on('focusin.bs.modal', $.proxy(function (e) {
                if (this.$element[0] !== e.target && !this.$element.has(e.target).length) {
                    this.$element.trigger('focus');
                }
            }, this));
        };
        Modal.prototype.escape = function () {
            if (this.isShown && this.options.keyboard) {
                this.$element.on('keydown.dismiss.bs.modal', $.proxy(function (e) {
                    e.which == 27 && this.hide();
                }, this));
            } else if (!this.isShown) {
                this.$element.off('keydown.dismiss.bs.modal');
            }
        };
        Modal.prototype.resize = function () {
            if (this.isShown) {
                $(window).on('resize.bs.modal', $.proxy(this.handleUpdate, this));
            } else {
                $(window).off('resize.bs.modal');
            }
        };
        Modal.prototype.hideModal = function () {
            var that = this;
            this.$element.hide();
            this.backdrop(function () {
                that.$body.removeClass('modal-open');
                that.resetAdjustments();
                that.resetScrollbar();
                that.$element.trigger('hidden.bs.modal');
            });
        };
        Modal.prototype.removeBackdrop = function () {
            this.$backdrop && this.$backdrop.remove();
            this.$backdrop = null;
        };
        Modal.prototype.backdrop = function (callback) {
            var that = this;
            var animate = this.$element.hasClass('fade') ? 'fade' : '';
            if (this.isShown && this.options.backdrop) {
                var doAnimate = $.support.transition && animate;
                this.$backdrop = $('<div class="modal-backdrop ' + animate + '" />').prependTo(this.$element).on('click.dismiss.bs.modal', $.proxy(function (e) {
                    if (e.target !== e.currentTarget)
                        return;
                    this.options.backdrop == 'static' ? this.$element[0].focus.call(this.$element[0]) : this.hide.call(this);
                }, this));
                if (doAnimate)
                    this.$backdrop[0].offsetWidth;
                this.$backdrop.addClass('in');
                if (!callback)
                    return;
                doAnimate ? this.$backdrop.one('bsTransitionEnd', callback).emulateTransitionEnd(Modal.BACKDROP_TRANSITION_DURATION) : callback();
            } else if (!this.isShown && this.$backdrop) {
                this.$backdrop.removeClass('in');
                var callbackRemove = function () {
                    that.removeBackdrop();
                    callback && callback();
                };
                $.support.transition && this.$element.hasClass('fade') ? this.$backdrop.one('bsTransitionEnd', callbackRemove).emulateTransitionEnd(Modal.BACKDROP_TRANSITION_DURATION) : callbackRemove();
            } else if (callback) {
                callback();
            }
        };
        Modal.prototype.handleUpdate = function () {
            if (this.options.backdrop)
                this.adjustBackdrop();
            this.adjustDialog();
        };
        Modal.prototype.adjustBackdrop = function () {
            this.$backdrop.css('height', 0).css('height', this.$element[0].scrollHeight);
        };
        Modal.prototype.adjustDialog = function () {
            var modalIsOverflowing = this.$element[0].scrollHeight > document.documentElement.clientHeight;
            this.$element.css({
                paddingLeft: !this.bodyIsOverflowing && modalIsOverflowing ? this.scrollbarWidth : '',
                paddingRight: this.bodyIsOverflowing && !modalIsOverflowing ? this.scrollbarWidth : ''
            });
        };
        Modal.prototype.resetAdjustments = function () {
            this.$element.css({
                paddingLeft: '',
                paddingRight: ''
            });
        };
        Modal.prototype.checkScrollbar = function () {
            this.bodyIsOverflowing = document.body.scrollHeight > document.documentElement.clientHeight;
            this.scrollbarWidth = this.measureScrollbar();
        };
        Modal.prototype.setScrollbar = function () {
            var bodyPad = parseInt(this.$body.css('padding-right') || 0, 10);
            if (this.bodyIsOverflowing)
                this.$body.css('padding-right', bodyPad + this.scrollbarWidth);
        };
        Modal.prototype.resetScrollbar = function () {
            this.$body.css('padding-right', '');
        };
        Modal.prototype.measureScrollbar = function () {
            var scrollDiv = document.createElement('div');
            scrollDiv.className = 'modal-scrollbar-measure';
            this.$body.append(scrollDiv);
            var scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;
            this.$body[0].removeChild(scrollDiv);
            return scrollbarWidth;
        };
        function Plugin(option, _relatedTarget) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.modal');
                var options = $.extend({}, Modal.DEFAULTS, $this.data(), typeof option == 'object' && option);
                if (!data)
                    $this.data('bs.modal', data = new Modal(this, options));
                if (typeof option == 'string')
                    data[option](_relatedTarget);
                else if (options.show)
                    data.show(_relatedTarget);
            });
        }
        var old = $.fn.modal;
        $.fn.modal = Plugin;
        $.fn.modal.Constructor = Modal;
        $.fn.modal.noConflict = function () {
            $.fn.modal = old;
            return this;
        };
        $(document).on('click.bs.modal.data-api', '[data-toggle="modal"]', function (e) {
            var $this = $(this);
            var href = $this.attr('href');
            var $target = $($this.attr('data-target') || href && href.replace(/.*(?=#[^\s]+$)/, ''));
            var option = $target.data('bs.modal') ? 'toggle' : $.extend({ remote: !/#/.test(href) && href }, $target.data(), $this.data());
            if ($this.is('a'))
                e.preventDefault();
            $target.one('show.bs.modal', function (showEvent) {
                if (showEvent.isDefaultPrevented())
                    return;
                $target.one('hidden.bs.modal', function () {
                    $this.is(':visible') && $this.trigger('focus');
                });
            });
            Plugin.call($target, option, this);
        });
    }(jQuery);
    +function ($) {
        'use strict';
        var Tooltip = function (element, options) {
            this.type = this.options = this.enabled = this.timeout = this.hoverState = this.$element = null;
            this.init('tooltip', element, options);
        };
        Tooltip.VERSION = '3.3.1';
        Tooltip.TRANSITION_DURATION = 150;
        Tooltip.DEFAULTS = {
            animation: true,
            placement: 'top',
            selector: false,
            template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',
            trigger: 'hover focus',
            title: '',
            delay: 0,
            html: false,
            container: false,
            viewport: {
                selector: 'body',
                padding: 0
            }
        };
        Tooltip.prototype.init = function (type, element, options) {
            this.enabled = true;
            this.type = type;
            this.$element = $(element);
            this.options = this.getOptions(options);
            this.$viewport = this.options.viewport && $(this.options.viewport.selector || this.options.viewport);
            var triggers = this.options.trigger.split(' ');
            for (var i = triggers.length; i--;) {
                var trigger = triggers[i];
                if (trigger == 'click') {
                    this.$element.on('click.' + this.type, this.options.selector, $.proxy(this.toggle, this));
                } else if (trigger != 'manual') {
                    var eventIn = trigger == 'hover' ? 'mouseenter' : 'focusin';
                    var eventOut = trigger == 'hover' ? 'mouseleave' : 'focusout';
                    this.$element.on(eventIn + '.' + this.type, this.options.selector, $.proxy(this.enter, this));
                    this.$element.on(eventOut + '.' + this.type, this.options.selector, $.proxy(this.leave, this));
                }
            }
            this.options.selector ? this._options = $.extend({}, this.options, {
                trigger: 'manual',
                selector: ''
            }) : this.fixTitle();
        };
        Tooltip.prototype.getDefaults = function () {
            return Tooltip.DEFAULTS;
        };
        Tooltip.prototype.getOptions = function (options) {
            options = $.extend({}, this.getDefaults(), this.$element.data(), options);
            if (options.delay && typeof options.delay == 'number') {
                options.delay = {
                    show: options.delay,
                    hide: options.delay
                };
            }
            return options;
        };
        Tooltip.prototype.getDelegateOptions = function () {
            var options = {};
            var defaults = this.getDefaults();
            this._options && $.each(this._options, function (key, value) {
                if (defaults[key] != value)
                    options[key] = value;
            });
            return options;
        };
        Tooltip.prototype.enter = function (obj) {
            var self = obj instanceof this.constructor ? obj : $(obj.currentTarget).data('bs.' + this.type);
            if (self && self.$tip && self.$tip.is(':visible')) {
                self.hoverState = 'in';
                return;
            }
            if (!self) {
                self = new this.constructor(obj.currentTarget, this.getDelegateOptions());
                $(obj.currentTarget).data('bs.' + this.type, self);
            }
            clearTimeout(self.timeout);
            self.hoverState = 'in';
            if (!self.options.delay || !self.options.delay.show)
                return self.show();
            self.timeout = setTimeout(function () {
                if (self.hoverState == 'in')
                    self.show();
            }, self.options.delay.show);
        };
        Tooltip.prototype.leave = function (obj) {
            var self = obj instanceof this.constructor ? obj : $(obj.currentTarget).data('bs.' + this.type);
            if (!self) {
                self = new this.constructor(obj.currentTarget, this.getDelegateOptions());
                $(obj.currentTarget).data('bs.' + this.type, self);
            }
            clearTimeout(self.timeout);
            self.hoverState = 'out';
            if (!self.options.delay || !self.options.delay.hide)
                return self.hide();
            self.timeout = setTimeout(function () {
                if (self.hoverState == 'out')
                    self.hide();
            }, self.options.delay.hide);
        };
        Tooltip.prototype.show = function () {
            var e = $.Event('show.bs.' + this.type);
            if (this.hasContent() && this.enabled) {
                this.$element.trigger(e);
                var inDom = $.contains(this.$element[0].ownerDocument.documentElement, this.$element[0]);
                if (e.isDefaultPrevented() || !inDom)
                    return;
                var that = this;
                var $tip = this.tip();
                var tipId = this.getUID(this.type);
                this.setContent();
                $tip.attr('id', tipId);
                this.$element.attr('aria-describedby', tipId);
                if (this.options.animation)
                    $tip.addClass('fade');
                var placement = typeof this.options.placement == 'function' ? this.options.placement.call(this, $tip[0], this.$element[0]) : this.options.placement;
                var autoToken = /\s?auto?\s?/i;
                var autoPlace = autoToken.test(placement);
                if (autoPlace)
                    placement = placement.replace(autoToken, '') || 'top';
                $tip.detach().css({
                    top: 0,
                    left: 0,
                    display: 'block'
                }).addClass(placement).data('bs.' + this.type, this);
                this.options.container ? $tip.appendTo(this.options.container) : $tip.insertAfter(this.$element);
                var pos = this.getPosition();
                var actualWidth = $tip[0].offsetWidth;
                var actualHeight = $tip[0].offsetHeight;
                if (autoPlace) {
                    var orgPlacement = placement;
                    var $container = this.options.container ? $(this.options.container) : this.$element.parent();
                    var containerDim = this.getPosition($container);
                    placement = placement == 'bottom' && pos.bottom + actualHeight > containerDim.bottom ? 'top' : placement == 'top' && pos.top - actualHeight < containerDim.top ? 'bottom' : placement == 'right' && pos.right + actualWidth > containerDim.width ? 'left' : placement == 'left' && pos.left - actualWidth < containerDim.left ? 'right' : placement;
                    $tip.removeClass(orgPlacement).addClass(placement);
                }
                var calculatedOffset = this.getCalculatedOffset(placement, pos, actualWidth, actualHeight);
                this.applyPlacement(calculatedOffset, placement);
                var complete = function () {
                    var prevHoverState = that.hoverState;
                    that.$element.trigger('shown.bs.' + that.type);
                    that.hoverState = null;
                    if (prevHoverState == 'out')
                        that.leave(that);
                };
                $.support.transition && this.$tip.hasClass('fade') ? $tip.one('bsTransitionEnd', complete).emulateTransitionEnd(Tooltip.TRANSITION_DURATION) : complete();
            }
        };
        Tooltip.prototype.applyPlacement = function (offset, placement) {
            var $tip = this.tip();
            var width = $tip[0].offsetWidth;
            var height = $tip[0].offsetHeight;
            var marginTop = parseInt($tip.css('margin-top'), 10);
            var marginLeft = parseInt($tip.css('margin-left'), 10);
            if (isNaN(marginTop))
                marginTop = 0;
            if (isNaN(marginLeft))
                marginLeft = 0;
            offset.top = offset.top + marginTop;
            offset.left = offset.left + marginLeft;
            $.offset.setOffset($tip[0], $.extend({
                using: function (props) {
                    $tip.css({
                        top: Math.round(props.top),
                        left: Math.round(props.left)
                    });
                }
            }, offset), 0);
            $tip.addClass('in');
            var actualWidth = $tip[0].offsetWidth;
            var actualHeight = $tip[0].offsetHeight;
            if (placement == 'top' && actualHeight != height) {
                offset.top = offset.top + height - actualHeight;
            }
            var delta = this.getViewportAdjustedDelta(placement, offset, actualWidth, actualHeight);
            if (delta.left)
                offset.left += delta.left;
            else
                offset.top += delta.top;
            var isVertical = /top|bottom/.test(placement);
            var arrowDelta = isVertical ? delta.left * 2 - width + actualWidth : delta.top * 2 - height + actualHeight;
            var arrowOffsetPosition = isVertical ? 'offsetWidth' : 'offsetHeight';
            $tip.offset(offset);
            this.replaceArrow(arrowDelta, $tip[0][arrowOffsetPosition], isVertical);
        };
        Tooltip.prototype.replaceArrow = function (delta, dimension, isHorizontal) {
            this.arrow().css(isHorizontal ? 'left' : 'top', 50 * (1 - delta / dimension) + '%').css(isHorizontal ? 'top' : 'left', '');
        };
        Tooltip.prototype.setContent = function () {
            var $tip = this.tip();
            var title = this.getTitle();
            $tip.find('.tooltip-inner')[this.options.html ? 'html' : 'text'](title);
            $tip.removeClass('fade in top bottom left right');
        };
        Tooltip.prototype.hide = function (callback) {
            var that = this;
            var $tip = this.tip();
            var e = $.Event('hide.bs.' + this.type);
            function complete() {
                if (that.hoverState != 'in')
                    $tip.detach();
                that.$element.removeAttr('aria-describedby').trigger('hidden.bs.' + that.type);
                callback && callback();
            }
            this.$element.trigger(e);
            if (e.isDefaultPrevented())
                return;
            $tip.removeClass('in');
            $.support.transition && this.$tip.hasClass('fade') ? $tip.one('bsTransitionEnd', complete).emulateTransitionEnd(Tooltip.TRANSITION_DURATION) : complete();
            this.hoverState = null;
            return this;
        };
        Tooltip.prototype.fixTitle = function () {
            var $e = this.$element;
            if ($e.attr('title') || typeof $e.attr('data-original-title') != 'string') {
                $e.attr('data-original-title', $e.attr('title') || '').attr('title', '');
            }
        };
        Tooltip.prototype.hasContent = function () {
            return this.getTitle();
        };
        Tooltip.prototype.getPosition = function ($element) {
            $element = $element || this.$element;
            var el = $element[0];
            var isBody = el.tagName == 'BODY';
            var elRect = el.getBoundingClientRect();
            if (elRect.width == null) {
                elRect = $.extend({}, elRect, {
                    width: elRect.right - elRect.left,
                    height: elRect.bottom - elRect.top
                });
            }
            var elOffset = isBody ? {
                top: 0,
                left: 0
            } : $element.offset();
            var scroll = { scroll: isBody ? document.documentElement.scrollTop || document.body.scrollTop : $element.scrollTop() };
            var outerDims = isBody ? {
                width: $(window).width(),
                height: $(window).height()
            } : null;
            return $.extend({}, elRect, scroll, outerDims, elOffset);
        };
        Tooltip.prototype.getCalculatedOffset = function (placement, pos, actualWidth, actualHeight) {
            return placement == 'bottom' ? {
                top: pos.top + pos.height,
                left: pos.left + pos.width / 2 - actualWidth / 2
            } : placement == 'top' ? {
                top: pos.top - actualHeight,
                left: pos.left + pos.width / 2 - actualWidth / 2
            } : placement == 'left' ? {
                top: pos.top + pos.height / 2 - actualHeight / 2,
                left: pos.left - actualWidth
            } : {
                top: pos.top + pos.height / 2 - actualHeight / 2,
                left: pos.left + pos.width
            };
        };
        Tooltip.prototype.getViewportAdjustedDelta = function (placement, pos, actualWidth, actualHeight) {
            var delta = {
                top: 0,
                left: 0
            };
            if (!this.$viewport)
                return delta;
            var viewportPadding = this.options.viewport && this.options.viewport.padding || 0;
            var viewportDimensions = this.getPosition(this.$viewport);
            if (/right|left/.test(placement)) {
                var topEdgeOffset = pos.top - viewportPadding - viewportDimensions.scroll;
                var bottomEdgeOffset = pos.top + viewportPadding - viewportDimensions.scroll + actualHeight;
                if (topEdgeOffset < viewportDimensions.top) {
                    delta.top = viewportDimensions.top - topEdgeOffset;
                } else if (bottomEdgeOffset > viewportDimensions.top + viewportDimensions.height) {
                    delta.top = viewportDimensions.top + viewportDimensions.height - bottomEdgeOffset;
                }
            } else {
                var leftEdgeOffset = pos.left - viewportPadding;
                var rightEdgeOffset = pos.left + viewportPadding + actualWidth;
                if (leftEdgeOffset < viewportDimensions.left) {
                    delta.left = viewportDimensions.left - leftEdgeOffset;
                } else if (rightEdgeOffset > viewportDimensions.width) {
                    delta.left = viewportDimensions.left + viewportDimensions.width - rightEdgeOffset;
                }
            }
            return delta;
        };
        Tooltip.prototype.getTitle = function () {
            var title;
            var $e = this.$element;
            var o = this.options;
            title = $e.attr('data-original-title') || (typeof o.title == 'function' ? o.title.call($e[0]) : o.title);
            return title;
        };
        Tooltip.prototype.getUID = function (prefix) {
            do
                prefix += ~~(Math.random() * 1000000);
            while (document.getElementById(prefix));
            return prefix;
        };
        Tooltip.prototype.tip = function () {
            return this.$tip = this.$tip || $(this.options.template);
        };
        Tooltip.prototype.arrow = function () {
            return this.$arrow = this.$arrow || this.tip().find('.tooltip-arrow');
        };
        Tooltip.prototype.enable = function () {
            this.enabled = true;
        };
        Tooltip.prototype.disable = function () {
            this.enabled = false;
        };
        Tooltip.prototype.toggleEnabled = function () {
            this.enabled = !this.enabled;
        };
        Tooltip.prototype.toggle = function (e) {
            var self = this;
            if (e) {
                self = $(e.currentTarget).data('bs.' + this.type);
                if (!self) {
                    self = new this.constructor(e.currentTarget, this.getDelegateOptions());
                    $(e.currentTarget).data('bs.' + this.type, self);
                }
            }
            self.tip().hasClass('in') ? self.leave(self) : self.enter(self);
        };
        Tooltip.prototype.destroy = function () {
            var that = this;
            clearTimeout(this.timeout);
            this.hide(function () {
                that.$element.off('.' + that.type).removeData('bs.' + that.type);
            });
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.tooltip');
                var options = typeof option == 'object' && option;
                var selector = options && options.selector;
                if (!data && option == 'destroy')
                    return;
                if (selector) {
                    if (!data)
                        $this.data('bs.tooltip', data = {});
                    if (!data[selector])
                        data[selector] = new Tooltip(this, options);
                } else {
                    if (!data)
                        $this.data('bs.tooltip', data = new Tooltip(this, options));
                }
                if (typeof option == 'string')
                    data[option]();
            });
        }
        var old = $.fn.tooltip;
        $.fn.tooltip = Plugin;
        $.fn.tooltip.Constructor = Tooltip;
        $.fn.tooltip.noConflict = function () {
            $.fn.tooltip = old;
            return this;
        };
    }(jQuery);
    +function ($) {
        'use strict';
        var Popover = function (element, options) {
            this.init('popover', element, options);
        };
        if (!$.fn.tooltip)
            throw new Error('Popover requires tooltip.js');
        Popover.VERSION = '3.3.1';
        Popover.DEFAULTS = $.extend({}, $.fn.tooltip.Constructor.DEFAULTS, {
            placement: 'right',
            trigger: 'click',
            content: '',
            template: '<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'
        });
        Popover.prototype = $.extend({}, $.fn.tooltip.Constructor.prototype);
        Popover.prototype.constructor = Popover;
        Popover.prototype.getDefaults = function () {
            return Popover.DEFAULTS;
        };
        Popover.prototype.setContent = function () {
            var $tip = this.tip();
            var title = this.getTitle();
            var content = this.getContent();
            $tip.find('.popover-title')[this.options.html ? 'html' : 'text'](title);
            $tip.find('.popover-content').children().detach().end()[this.options.html ? typeof content == 'string' ? 'html' : 'append' : 'text'](content);
            $tip.removeClass('fade top bottom left right in');
            if (!$tip.find('.popover-title').html())
                $tip.find('.popover-title').hide();
        };
        Popover.prototype.hasContent = function () {
            return this.getTitle() || this.getContent();
        };
        Popover.prototype.getContent = function () {
            var $e = this.$element;
            var o = this.options;
            return $e.attr('data-content') || (typeof o.content == 'function' ? o.content.call($e[0]) : o.content);
        };
        Popover.prototype.arrow = function () {
            return this.$arrow = this.$arrow || this.tip().find('.arrow');
        };
        Popover.prototype.tip = function () {
            if (!this.$tip)
                this.$tip = $(this.options.template);
            return this.$tip;
        };
        function Plugin(option) {
            return this.each(function () {
                var $this = $(this);
                var data = $this.data('bs.popover');
                var options = typeof option == 'object' && option;
                var selector = options && options.selector;
                if (!data && option == 'destroy')
                    return;
                if (selector) {
                    if (!data)
                        $this.data('bs.popover', data = {});
                    if (!data[selector])
                        data[selector] = new Popover(this, options);
                } else {
                    if (!data)
                        $this.data('bs.popover', data = new Popover(this, options));
                }
                if (typeof option == 'string')
                    data[option]();
            });
        }
        var old = $.fn.popover;
        $.fn.popover = Plugin;
        $.fn.popover.Constructor = Popover;
        $.fn.popover.noConflict = function () {
            $.fn.popover = old;
            return this;
        };
    }(jQuery);
    return;
});
define('bootstrap-datepicker', [
    'jQuery',
    'bootstrap'
], function () {
    (function ($, undefined) {
        var $window = $(window);
        function UTCDate() {
            return new Date(Date.UTC.apply(Date, arguments));
        }
        function UTCToday() {
            var today = new Date();
            return UTCDate(today.getFullYear(), today.getMonth(), today.getDate());
        }
        function alias(method) {
            return function () {
                return this[method].apply(this, arguments);
            };
        }
        var DateArray = function () {
            var extras = {
                get: function (i) {
                    return this.slice(i)[0];
                },
                contains: function (d) {
                    var val = d && d.valueOf();
                    for (var i = 0, l = this.length; i < l; i++)
                        if (this[i].valueOf() === val)
                            return i;
                    return -1;
                },
                remove: function (i) {
                    this.splice(i, 1);
                },
                replace: function (new_array) {
                    if (!new_array)
                        return;
                    if (!$.isArray(new_array))
                        new_array = [new_array];
                    this.clear();
                    this.push.apply(this, new_array);
                },
                clear: function () {
                    this.length = 0;
                },
                copy: function () {
                    var a = new DateArray();
                    a.replace(this);
                    return a;
                }
            };
            return function () {
                var a = [];
                a.push.apply(a, arguments);
                $.extend(a, extras);
                return a;
            };
        }();
        var Datepicker = function (element, options) {
            this.dates = new DateArray();
            this.viewDate = UTCToday();
            this.focusDate = null;
            this._process_options(options);
            this.element = $(element);
            this.isInline = false;
            this.isInput = this.element.is('input');
            this.component = this.element.is('.date') ? this.element.find('.add-on, .input-group-addon, .btn') : false;
            this.hasInput = this.component && this.element.find('input').length;
            if (this.component && this.component.length === 0)
                this.component = false;
            this.picker = $(DPGlobal.template);
            this._buildEvents();
            this._attachEvents();
            if (this.isInline) {
                this.picker.addClass('datepicker-inline').appendTo(this.element);
            } else {
                this.picker.addClass('datepicker-dropdown dropdown-menu');
            }
            if (this.o.rtl) {
                this.picker.addClass('datepicker-rtl');
            }
            this.viewMode = this.o.startView;
            if (this.o.calendarWeeks)
                this.picker.find('tfoot th.today, tfoot th.clear').attr('colspan', function (i, val) {
                    return parseInt(val) + 1;
                });
            this._allow_update = false;
            this.setStartDate(this._o.startDate);
            this.setEndDate(this._o.endDate);
            this.setDaysOfWeekDisabled(this.o.daysOfWeekDisabled);
            this.fillDow();
            this.fillMonths();
            this._allow_update = true;
            this.update();
            this.showMode();
            if (this.isInline) {
                this.show();
            }
        };
        Datepicker.prototype = {
            constructor: Datepicker,
            _process_options: function (opts) {
                this._o = $.extend({}, this._o, opts);
                var o = this.o = $.extend({}, this._o);
                var lang = o.language;
                if (!dates[lang]) {
                    lang = lang.split('-')[0];
                    if (!dates[lang])
                        lang = defaults.language;
                }
                o.language = lang;
                switch (o.startView) {
                case 2:
                case 'decade':
                    o.startView = 2;
                    break;
                case 1:
                case 'year':
                    o.startView = 1;
                    break;
                default:
                    o.startView = 0;
                }
                switch (o.minViewMode) {
                case 1:
                case 'months':
                    o.minViewMode = 1;
                    break;
                case 2:
                case 'years':
                    o.minViewMode = 2;
                    break;
                default:
                    o.minViewMode = 0;
                }
                o.startView = Math.max(o.startView, o.minViewMode);
                if (o.multidate !== true) {
                    o.multidate = Number(o.multidate) || false;
                    if (o.multidate !== false)
                        o.multidate = Math.max(0, o.multidate);
                    else
                        o.multidate = 1;
                }
                o.multidateSeparator = String(o.multidateSeparator);
                o.weekStart %= 7;
                o.weekEnd = (o.weekStart + 6) % 7;
                var format = DPGlobal.parseFormat(o.format);
                if (o.startDate !== -Infinity) {
                    if (!!o.startDate) {
                        if (o.startDate instanceof Date)
                            o.startDate = this._local_to_utc(this._zero_time(o.startDate));
                        else
                            o.startDate = DPGlobal.parseDate(o.startDate, format, o.language);
                    } else {
                        o.startDate = -Infinity;
                    }
                }
                if (o.endDate !== Infinity) {
                    if (!!o.endDate) {
                        if (o.endDate instanceof Date)
                            o.endDate = this._local_to_utc(this._zero_time(o.endDate));
                        else
                            o.endDate = DPGlobal.parseDate(o.endDate, format, o.language);
                    } else {
                        o.endDate = Infinity;
                    }
                }
                o.daysOfWeekDisabled = o.daysOfWeekDisabled || [];
                if (!$.isArray(o.daysOfWeekDisabled))
                    o.daysOfWeekDisabled = o.daysOfWeekDisabled.split(/[,\s]*/);
                o.daysOfWeekDisabled = $.map(o.daysOfWeekDisabled, function (d) {
                    return parseInt(d, 10);
                });
                var plc = String(o.orientation).toLowerCase().split(/\s+/g), _plc = o.orientation.toLowerCase();
                plc = $.grep(plc, function (word) {
                    return /^auto|left|right|top|bottom$/.test(word);
                });
                o.orientation = {
                    x: 'auto',
                    y: 'auto'
                };
                if (!_plc || _plc === 'auto');
                else if (plc.length === 1) {
                    switch (plc[0]) {
                    case 'top':
                    case 'bottom':
                        o.orientation.y = plc[0];
                        break;
                    case 'left':
                    case 'right':
                        o.orientation.x = plc[0];
                        break;
                    }
                } else {
                    _plc = $.grep(plc, function (word) {
                        return /^left|right$/.test(word);
                    });
                    o.orientation.x = _plc[0] || 'auto';
                    _plc = $.grep(plc, function (word) {
                        return /^top|bottom$/.test(word);
                    });
                    o.orientation.y = _plc[0] || 'auto';
                }
            },
            _events: [],
            _secondaryEvents: [],
            _applyEvents: function (evs) {
                for (var i = 0, el, ch, ev; i < evs.length; i++) {
                    el = evs[i][0];
                    if (evs[i].length === 2) {
                        ch = undefined;
                        ev = evs[i][1];
                    } else if (evs[i].length === 3) {
                        ch = evs[i][1];
                        ev = evs[i][2];
                    }
                    el.on(ev, ch);
                }
            },
            _unapplyEvents: function (evs) {
                for (var i = 0, el, ev, ch; i < evs.length; i++) {
                    el = evs[i][0];
                    if (evs[i].length === 2) {
                        ch = undefined;
                        ev = evs[i][1];
                    } else if (evs[i].length === 3) {
                        ch = evs[i][1];
                        ev = evs[i][2];
                    }
                    el.off(ev, ch);
                }
            },
            _buildEvents: function () {
                if (this.isInput) {
                    this._events = [[
                            this.element,
                            {
                                focus: $.proxy(this.show, this),
                                keyup: $.proxy(function (e) {
                                    if ($.inArray(e.keyCode, [
                                            27,
                                            37,
                                            39,
                                            38,
                                            40,
                                            32,
                                            13,
                                            9
                                        ]) === -1)
                                        this.update();
                                }, this),
                                keydown: $.proxy(this.keydown, this)
                            }
                        ]];
                } else if (this.component && this.hasInput) {
                    this._events = [
                        [
                            this.element.find('input'),
                            {
                                focus: $.proxy(this.show, this),
                                keyup: $.proxy(function (e) {
                                    if ($.inArray(e.keyCode, [
                                            27,
                                            37,
                                            39,
                                            38,
                                            40,
                                            32,
                                            13,
                                            9
                                        ]) === -1)
                                        this.update();
                                }, this),
                                keydown: $.proxy(this.keydown, this)
                            }
                        ],
                        [
                            this.component,
                            { click: $.proxy(this.show, this) }
                        ]
                    ];
                } else if (this.element.is('div')) {
                    this.isInline = true;
                } else {
                    this._events = [[
                            this.element,
                            { click: $.proxy(this.show, this) }
                        ]];
                }
                this._events.push([
                    this.element,
                    '*',
                    {
                        blur: $.proxy(function (e) {
                            this._focused_from = e.target;
                        }, this)
                    }
                ], [
                    this.element,
                    {
                        blur: $.proxy(function (e) {
                            this._focused_from = e.target;
                        }, this)
                    }
                ]);
                this._secondaryEvents = [
                    [
                        this.picker,
                        { click: $.proxy(this.click, this) }
                    ],
                    [
                        $(window),
                        { resize: $.proxy(this.place, this) }
                    ],
                    [
                        $(document),
                        {
                            'mousedown touchstart': $.proxy(function (e) {
                                if (!(this.element.is(e.target) || this.element.find(e.target).length || this.picker.is(e.target) || this.picker.find(e.target).length)) {
                                    this.hide();
                                }
                            }, this)
                        }
                    ]
                ];
            },
            _attachEvents: function () {
                this._detachEvents();
                this._applyEvents(this._events);
            },
            _detachEvents: function () {
                this._unapplyEvents(this._events);
            },
            _attachSecondaryEvents: function () {
                this._detachSecondaryEvents();
                this._applyEvents(this._secondaryEvents);
            },
            _detachSecondaryEvents: function () {
                this._unapplyEvents(this._secondaryEvents);
            },
            _trigger: function (event, altdate) {
                var date = altdate || this.dates.get(-1), local_date = this._utc_to_local(date);
                this.element.trigger({
                    type: event,
                    date: local_date,
                    dates: $.map(this.dates, this._utc_to_local),
                    format: $.proxy(function (ix, format) {
                        if (arguments.length === 0) {
                            ix = this.dates.length - 1;
                            format = this.o.format;
                        } else if (typeof ix === 'string') {
                            format = ix;
                            ix = this.dates.length - 1;
                        }
                        format = format || this.o.format;
                        var date = this.dates.get(ix);
                        return DPGlobal.formatDate(date, format, this.o.language);
                    }, this)
                });
            },
            show: function () {
                if (!this.isInline)
                    this.picker.appendTo('body');
                this.picker.show();
                this.place();
                this._attachSecondaryEvents();
                this._trigger('show');
            },
            hide: function () {
                if (this.isInline)
                    return;
                if (!this.picker.is(':visible'))
                    return;
                this.focusDate = null;
                this.picker.hide().detach();
                this._detachSecondaryEvents();
                this.viewMode = this.o.startView;
                this.showMode();
                if (this.o.forceParse && (this.isInput && this.element.val() || this.hasInput && this.element.find('input').val()))
                    this.setValue();
                this._trigger('hide');
            },
            remove: function () {
                this.hide();
                this._detachEvents();
                this._detachSecondaryEvents();
                this.picker.remove();
                delete this.element.data().datepicker;
                if (!this.isInput) {
                    delete this.element.data().date;
                }
            },
            _utc_to_local: function (utc) {
                return utc && new Date(utc.getTime() + utc.getTimezoneOffset() * 60000);
            },
            _local_to_utc: function (local) {
                return local && new Date(local.getTime() - local.getTimezoneOffset() * 60000);
            },
            _zero_time: function (local) {
                return local && new Date(local.getFullYear(), local.getMonth(), local.getDate());
            },
            _zero_utc_time: function (utc) {
                return utc && new Date(Date.UTC(utc.getUTCFullYear(), utc.getUTCMonth(), utc.getUTCDate()));
            },
            getDates: function () {
                return $.map(this.dates, this._utc_to_local);
            },
            getUTCDates: function () {
                return $.map(this.dates, function (d) {
                    return new Date(d);
                });
            },
            getDate: function () {
                return this._utc_to_local(this.getUTCDate());
            },
            getUTCDate: function () {
                return new Date(this.dates.get(-1));
            },
            setDates: function () {
                var args = $.isArray(arguments[0]) ? arguments[0] : arguments;
                this.update.apply(this, args);
                this._trigger('changeDate');
                this.setValue();
            },
            setUTCDates: function () {
                var args = $.isArray(arguments[0]) ? arguments[0] : arguments;
                this.update.apply(this, $.map(args, this._utc_to_local));
                this._trigger('changeDate');
                this.setValue();
            },
            setDate: alias('setDates'),
            setUTCDate: alias('setUTCDates'),
            setValue: function () {
                var formatted = this.getFormattedDate();
                if (!this.isInput) {
                    if (this.component) {
                        this.element.find('input').val(formatted).change();
                    }
                } else {
                    this.element.val(formatted).change();
                }
            },
            getFormattedDate: function (format) {
                if (format === undefined)
                    format = this.o.format;
                var lang = this.o.language;
                return $.map(this.dates, function (d) {
                    return DPGlobal.formatDate(d, format, lang);
                }).join(this.o.multidateSeparator);
            },
            setStartDate: function (startDate) {
                this._process_options({ startDate: startDate });
                this.update();
                this.updateNavArrows();
            },
            setEndDate: function (endDate) {
                this._process_options({ endDate: endDate });
                this.update();
                this.updateNavArrows();
            },
            setDaysOfWeekDisabled: function (daysOfWeekDisabled) {
                this._process_options({ daysOfWeekDisabled: daysOfWeekDisabled });
                this.update();
                this.updateNavArrows();
            },
            place: function () {
                if (this.isInline)
                    return;
                var calendarWidth = this.picker.outerWidth(), calendarHeight = this.picker.outerHeight(), visualPadding = 10, windowWidth = $window.width(), windowHeight = $window.height(), scrollTop = $window.scrollTop();
                var parentsZindex = [];
                this.element.parents().each(function () {
                    var itemZIndex = $(this).css('z-index');
                    if (itemZIndex !== 'auto' && itemZIndex !== 0)
                        parentsZindex.push(parseInt(itemZIndex));
                });
                var zIndex = Math.max.apply(Math, parentsZindex) + 10;
                var offset = this.component ? this.component.parent().offset() : this.element.offset();
                var height = this.component ? this.component.outerHeight(true) : this.element.outerHeight(false);
                var width = this.component ? this.component.outerWidth(true) : this.element.outerWidth(false);
                var left = offset.left, top = offset.top;
                this.picker.removeClass('datepicker-orient-top datepicker-orient-bottom ' + 'datepicker-orient-right datepicker-orient-left');
                if (this.o.orientation.x !== 'auto') {
                    this.picker.addClass('datepicker-orient-' + this.o.orientation.x);
                    if (this.o.orientation.x === 'right')
                        left -= calendarWidth - width;
                } else {
                    this.picker.addClass('datepicker-orient-left');
                    if (offset.left < 0)
                        left -= offset.left - visualPadding;
                    else if (offset.left + calendarWidth > windowWidth)
                        left = windowWidth - calendarWidth - visualPadding;
                }
                var yorient = this.o.orientation.y, top_overflow, bottom_overflow;
                if (yorient === 'auto') {
                    top_overflow = -scrollTop + offset.top - calendarHeight;
                    bottom_overflow = scrollTop + windowHeight - (offset.top + height + calendarHeight);
                    if (Math.max(top_overflow, bottom_overflow) === bottom_overflow)
                        yorient = 'top';
                    else
                        yorient = 'bottom';
                }
                this.picker.addClass('datepicker-orient-' + yorient);
                if (yorient === 'top')
                    top += height;
                else
                    top -= calendarHeight + parseInt(this.picker.css('padding-top'));
                this.picker.css({
                    top: top,
                    left: left,
                    zIndex: zIndex
                });
            },
            _allow_update: true,
            update: function () {
                if (!this._allow_update)
                    return;
                var oldDates = this.dates.copy(), dates = [], fromArgs = false;
                if (arguments.length) {
                    $.each(arguments, $.proxy(function (i, date) {
                        if (date instanceof Date)
                            date = this._local_to_utc(date);
                        dates.push(date);
                    }, this));
                    fromArgs = true;
                } else {
                    dates = this.isInput ? this.element.val() : this.element.data('date') || this.element.find('input').val();
                    if (dates && this.o.multidate)
                        dates = dates.split(this.o.multidateSeparator);
                    else
                        dates = [dates];
                    delete this.element.data().date;
                }
                dates = $.map(dates, $.proxy(function (date) {
                    return DPGlobal.parseDate(date, this.o.format, this.o.language);
                }, this));
                dates = $.grep(dates, $.proxy(function (date) {
                    return date < this.o.startDate || date > this.o.endDate || !date;
                }, this), true);
                this.dates.replace(dates);
                if (this.dates.length)
                    this.viewDate = new Date(this.dates.get(-1));
                else if (this.viewDate < this.o.startDate)
                    this.viewDate = new Date(this.o.startDate);
                else if (this.viewDate > this.o.endDate)
                    this.viewDate = new Date(this.o.endDate);
                if (fromArgs) {
                    this.setValue();
                } else if (dates.length) {
                    if (String(oldDates) !== String(this.dates))
                        this._trigger('changeDate');
                }
                if (!this.dates.length && oldDates.length)
                    this._trigger('clearDate');
                this.fill();
            },
            fillDow: function () {
                var dowCnt = this.o.weekStart, html = '<tr>';
                if (this.o.calendarWeeks) {
                    var cell = '<th class="cw">&nbsp;</th>';
                    html += cell;
                    this.picker.find('.datepicker-days thead tr:first-child').prepend(cell);
                }
                while (dowCnt < this.o.weekStart + 7) {
                    html += '<th class="dow">' + dates[this.o.language].daysMin[dowCnt++ % 7] + '</th>';
                }
                html += '</tr>';
                this.picker.find('.datepicker-days thead').append(html);
            },
            fillMonths: function () {
                var html = '', i = 0;
                while (i < 12) {
                    html += '<span class="month">' + dates[this.o.language].monthsShort[i++] + '</span>';
                }
                this.picker.find('.datepicker-months td').html(html);
            },
            setRange: function (range) {
                if (!range || !range.length)
                    delete this.range;
                else
                    this.range = $.map(range, function (d) {
                        return d.valueOf();
                    });
                this.fill();
            },
            getClassNames: function (date) {
                var cls = [], year = this.viewDate.getUTCFullYear(), month = this.viewDate.getUTCMonth(), today = new Date();
                if (date.getUTCFullYear() < year || date.getUTCFullYear() === year && date.getUTCMonth() < month) {
                    cls.push('old');
                } else if (date.getUTCFullYear() > year || date.getUTCFullYear() === year && date.getUTCMonth() > month) {
                    cls.push('new');
                }
                if (this.focusDate && date.valueOf() === this.focusDate.valueOf())
                    cls.push('focused');
                if (this.o.todayHighlight && date.getUTCFullYear() === today.getFullYear() && date.getUTCMonth() === today.getMonth() && date.getUTCDate() === today.getDate()) {
                    cls.push('today');
                }
                if (this.dates.contains(date) !== -1)
                    cls.push('active');
                if (date.valueOf() < this.o.startDate || date.valueOf() > this.o.endDate || $.inArray(date.getUTCDay(), this.o.daysOfWeekDisabled) !== -1) {
                    cls.push('disabled');
                }
                if (this.range) {
                    if (date > this.range[0] && date < this.range[this.range.length - 1]) {
                        cls.push('range');
                    }
                    if ($.inArray(date.valueOf(), this.range) !== -1) {
                        cls.push('selected');
                    }
                }
                return cls;
            },
            fill: function () {
                var d = new Date(this.viewDate), year = d.getUTCFullYear(), month = d.getUTCMonth(), startYear = this.o.startDate !== -Infinity ? this.o.startDate.getUTCFullYear() : -Infinity, startMonth = this.o.startDate !== -Infinity ? this.o.startDate.getUTCMonth() : -Infinity, endYear = this.o.endDate !== Infinity ? this.o.endDate.getUTCFullYear() : Infinity, endMonth = this.o.endDate !== Infinity ? this.o.endDate.getUTCMonth() : Infinity, todaytxt = dates[this.o.language].today || dates['en'].today || '', cleartxt = dates[this.o.language].clear || dates['en'].clear || '', tooltip;
                if (isNaN(year) || isNaN(month))
                    return;
                this.picker.find('.datepicker-days thead th.datepicker-switch').text(dates[this.o.language].months[month] + ' ' + year);
                this.picker.find('tfoot th.today').text(todaytxt).toggle(this.o.todayBtn !== false);
                this.picker.find('tfoot th.clear').text(cleartxt).toggle(this.o.clearBtn !== false);
                this.updateNavArrows();
                this.fillMonths();
                var prevMonth = UTCDate(year, month - 1, 28), day = DPGlobal.getDaysInMonth(prevMonth.getUTCFullYear(), prevMonth.getUTCMonth());
                prevMonth.setUTCDate(day);
                prevMonth.setUTCDate(day - (prevMonth.getUTCDay() - this.o.weekStart + 7) % 7);
                var nextMonth = new Date(prevMonth);
                nextMonth.setUTCDate(nextMonth.getUTCDate() + 42);
                nextMonth = nextMonth.valueOf();
                var html = [];
                var clsName;
                while (prevMonth.valueOf() < nextMonth) {
                    if (prevMonth.getUTCDay() === this.o.weekStart) {
                        html.push('<tr>');
                        if (this.o.calendarWeeks) {
                            var ws = new Date(+prevMonth + (this.o.weekStart - prevMonth.getUTCDay() - 7) % 7 * 86400000), th = new Date(Number(ws) + (7 + 4 - ws.getUTCDay()) % 7 * 86400000), yth = new Date(Number(yth = UTCDate(th.getUTCFullYear(), 0, 1)) + (7 + 4 - yth.getUTCDay()) % 7 * 86400000), calWeek = (th - yth) / 86400000 / 7 + 1;
                            html.push('<td class="cw">' + calWeek + '</td>');
                        }
                    }
                    clsName = this.getClassNames(prevMonth);
                    clsName.push('day');
                    if (this.o.beforeShowDay !== $.noop) {
                        var before = this.o.beforeShowDay(this._utc_to_local(prevMonth));
                        if (before === undefined)
                            before = {};
                        else if (typeof before === 'boolean')
                            before = { enabled: before };
                        else if (typeof before === 'string')
                            before = { classes: before };
                        if (before.enabled === false)
                            clsName.push('disabled');
                        if (before.classes)
                            clsName = clsName.concat(before.classes.split(/\s+/));
                        if (before.tooltip)
                            tooltip = before.tooltip;
                    }
                    clsName = $.unique(clsName);
                    html.push('<td class="' + clsName.join(' ') + '"' + (tooltip ? ' title="' + tooltip + '"' : '') + '>' + prevMonth.getUTCDate() + '</td>');
                    tooltip = null;
                    if (prevMonth.getUTCDay() === this.o.weekEnd) {
                        html.push('</tr>');
                    }
                    prevMonth.setUTCDate(prevMonth.getUTCDate() + 1);
                }
                this.picker.find('.datepicker-days tbody').empty().append(html.join(''));
                var months = this.picker.find('.datepicker-months').find('th:eq(1)').text(year).end().find('span').removeClass('active');
                $.each(this.dates, function (i, d) {
                    if (d.getUTCFullYear() === year)
                        months.eq(d.getUTCMonth()).addClass('active');
                });
                if (year < startYear || year > endYear) {
                    months.addClass('disabled');
                }
                if (year === startYear) {
                    months.slice(0, startMonth).addClass('disabled');
                }
                if (year === endYear) {
                    months.slice(endMonth + 1).addClass('disabled');
                }
                html = '';
                year = parseInt(year / 10, 10) * 10;
                var yearCont = this.picker.find('.datepicker-years').find('th:eq(1)').text(year + '-' + (year + 9)).end().find('td');
                year -= 1;
                var years = $.map(this.dates, function (d) {
                        return d.getUTCFullYear();
                    }), classes;
                for (var i = -1; i < 11; i++) {
                    classes = ['year'];
                    if (i === -1)
                        classes.push('old');
                    else if (i === 10)
                        classes.push('new');
                    if ($.inArray(year, years) !== -1)
                        classes.push('active');
                    if (year < startYear || year > endYear)
                        classes.push('disabled');
                    html += '<span class="' + classes.join(' ') + '">' + year + '</span>';
                    year += 1;
                }
                yearCont.html(html);
            },
            updateNavArrows: function () {
                if (!this._allow_update)
                    return;
                var d = new Date(this.viewDate), year = d.getUTCFullYear(), month = d.getUTCMonth();
                switch (this.viewMode) {
                case 0:
                    if (this.o.startDate !== -Infinity && year <= this.o.startDate.getUTCFullYear() && month <= this.o.startDate.getUTCMonth()) {
                        this.picker.find('.prev').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.prev').css({ visibility: 'visible' });
                    }
                    if (this.o.endDate !== Infinity && year >= this.o.endDate.getUTCFullYear() && month >= this.o.endDate.getUTCMonth()) {
                        this.picker.find('.next').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.next').css({ visibility: 'visible' });
                    }
                    break;
                case 1:
                case 2:
                    if (this.o.startDate !== -Infinity && year <= this.o.startDate.getUTCFullYear()) {
                        this.picker.find('.prev').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.prev').css({ visibility: 'visible' });
                    }
                    if (this.o.endDate !== Infinity && year >= this.o.endDate.getUTCFullYear()) {
                        this.picker.find('.next').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.next').css({ visibility: 'visible' });
                    }
                    break;
                }
            },
            click: function (e) {
                e.preventDefault();
                var target = $(e.target).closest('span, td, th'), year, month, day;
                if (target.length === 1) {
                    switch (target[0].nodeName.toLowerCase()) {
                    case 'th':
                        switch (target[0].className) {
                        case 'datepicker-switch':
                            this.showMode(1);
                            break;
                        case 'prev':
                        case 'next':
                            var dir = DPGlobal.modes[this.viewMode].navStep * (target[0].className === 'prev' ? -1 : 1);
                            switch (this.viewMode) {
                            case 0:
                                this.viewDate = this.moveMonth(this.viewDate, dir);
                                this._trigger('changeMonth', this.viewDate);
                                break;
                            case 1:
                            case 2:
                                this.viewDate = this.moveYear(this.viewDate, dir);
                                if (this.viewMode === 1)
                                    this._trigger('changeYear', this.viewDate);
                                break;
                            }
                            this.fill();
                            break;
                        case 'today':
                            var date = new Date();
                            date = UTCDate(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
                            this.showMode(-2);
                            var which = this.o.todayBtn === 'linked' ? null : 'view';
                            this._setDate(date, which);
                            break;
                        case 'clear':
                            var element;
                            if (this.isInput)
                                element = this.element;
                            else if (this.component)
                                element = this.element.find('input');
                            if (element)
                                element.val('').change();
                            this.update();
                            this._trigger('changeDate');
                            if (this.o.autoclose)
                                this.hide();
                            break;
                        }
                        break;
                    case 'span':
                        if (!target.is('.disabled')) {
                            this.viewDate.setUTCDate(1);
                            if (target.is('.month')) {
                                day = 1;
                                month = target.parent().find('span').index(target);
                                year = this.viewDate.getUTCFullYear();
                                this.viewDate.setUTCMonth(month);
                                this._trigger('changeMonth', this.viewDate);
                                if (this.o.minViewMode === 1) {
                                    this._setDate(UTCDate(year, month, day));
                                }
                            } else {
                                day = 1;
                                month = 0;
                                year = parseInt(target.text(), 10) || 0;
                                this.viewDate.setUTCFullYear(year);
                                this._trigger('changeYear', this.viewDate);
                                if (this.o.minViewMode === 2) {
                                    this._setDate(UTCDate(year, month, day));
                                }
                            }
                            this.showMode(-1);
                            this.fill();
                        }
                        break;
                    case 'td':
                        if (target.is('.day') && !target.is('.disabled')) {
                            day = parseInt(target.text(), 10) || 1;
                            year = this.viewDate.getUTCFullYear();
                            month = this.viewDate.getUTCMonth();
                            if (target.is('.old')) {
                                if (month === 0) {
                                    month = 11;
                                    year -= 1;
                                } else {
                                    month -= 1;
                                }
                            } else if (target.is('.new')) {
                                if (month === 11) {
                                    month = 0;
                                    year += 1;
                                } else {
                                    month += 1;
                                }
                            }
                            this._setDate(UTCDate(year, month, day));
                        }
                        break;
                    }
                }
                if (this.picker.is(':visible') && this._focused_from) {
                    $(this._focused_from).focus();
                }
                delete this._focused_from;
            },
            _toggle_multidate: function (date) {
                var ix = this.dates.contains(date);
                if (!date) {
                    this.dates.clear();
                }
                if (this.o.multidate === 1 && ix === 0) {
                } else if (ix !== -1) {
                    this.dates.remove(ix);
                } else {
                    this.dates.push(date);
                }
                if (typeof this.o.multidate === 'number')
                    while (this.dates.length > this.o.multidate)
                        this.dates.remove(0);
            },
            _setDate: function (date, which) {
                if (!which || which === 'date')
                    this._toggle_multidate(date && new Date(date));
                if (!which || which === 'view')
                    this.viewDate = date && new Date(date);
                this.fill();
                this.setValue();
                this._trigger('changeDate');
                var element;
                if (this.isInput) {
                    element = this.element;
                } else if (this.component) {
                    element = this.element.find('input');
                }
                if (element) {
                    element.change();
                }
                if (this.o.autoclose && (!which || which === 'date')) {
                    this.hide();
                }
            },
            moveMonth: function (date, dir) {
                if (!date)
                    return undefined;
                if (!dir)
                    return date;
                var new_date = new Date(date.valueOf()), day = new_date.getUTCDate(), month = new_date.getUTCMonth(), mag = Math.abs(dir), new_month, test;
                dir = dir > 0 ? 1 : -1;
                if (mag === 1) {
                    test = dir === -1 ? function () {
                        return new_date.getUTCMonth() === month;
                    } : function () {
                        return new_date.getUTCMonth() !== new_month;
                    };
                    new_month = month + dir;
                    new_date.setUTCMonth(new_month);
                    if (new_month < 0 || new_month > 11)
                        new_month = (new_month + 12) % 12;
                } else {
                    for (var i = 0; i < mag; i++)
                        new_date = this.moveMonth(new_date, dir);
                    new_month = new_date.getUTCMonth();
                    new_date.setUTCDate(day);
                    test = function () {
                        return new_month !== new_date.getUTCMonth();
                    };
                }
                while (test()) {
                    new_date.setUTCDate(--day);
                    new_date.setUTCMonth(new_month);
                }
                return new_date;
            },
            moveYear: function (date, dir) {
                return this.moveMonth(date, dir * 12);
            },
            dateWithinRange: function (date) {
                return date >= this.o.startDate && date <= this.o.endDate;
            },
            keydown: function (e) {
                if (this.picker.is(':not(:visible)')) {
                    if (e.keyCode === 27)
                        this.show();
                    return;
                }
                var dateChanged = false, dir, newDate, newViewDate, focusDate = this.focusDate || this.viewDate;
                switch (e.keyCode) {
                case 27:
                    if (this.focusDate) {
                        this.focusDate = null;
                        this.viewDate = this.dates.get(-1) || this.viewDate;
                        this.fill();
                    } else
                        this.hide();
                    e.preventDefault();
                    break;
                case 37:
                case 39:
                    if (!this.o.keyboardNavigation)
                        break;
                    dir = e.keyCode === 37 ? -1 : 1;
                    if (e.ctrlKey) {
                        newDate = this.moveYear(this.dates.get(-1) || UTCToday(), dir);
                        newViewDate = this.moveYear(focusDate, dir);
                        this._trigger('changeYear', this.viewDate);
                    } else if (e.shiftKey) {
                        newDate = this.moveMonth(this.dates.get(-1) || UTCToday(), dir);
                        newViewDate = this.moveMonth(focusDate, dir);
                        this._trigger('changeMonth', this.viewDate);
                    } else {
                        newDate = new Date(this.dates.get(-1) || UTCToday());
                        newDate.setUTCDate(newDate.getUTCDate() + dir);
                        newViewDate = new Date(focusDate);
                        newViewDate.setUTCDate(focusDate.getUTCDate() + dir);
                    }
                    if (this.dateWithinRange(newDate)) {
                        this.focusDate = this.viewDate = newViewDate;
                        this.setValue();
                        this.fill();
                        e.preventDefault();
                    }
                    break;
                case 38:
                case 40:
                    if (!this.o.keyboardNavigation)
                        break;
                    dir = e.keyCode === 38 ? -1 : 1;
                    if (e.ctrlKey) {
                        newDate = this.moveYear(this.dates.get(-1) || UTCToday(), dir);
                        newViewDate = this.moveYear(focusDate, dir);
                        this._trigger('changeYear', this.viewDate);
                    } else if (e.shiftKey) {
                        newDate = this.moveMonth(this.dates.get(-1) || UTCToday(), dir);
                        newViewDate = this.moveMonth(focusDate, dir);
                        this._trigger('changeMonth', this.viewDate);
                    } else {
                        newDate = new Date(this.dates.get(-1) || UTCToday());
                        newDate.setUTCDate(newDate.getUTCDate() + dir * 7);
                        newViewDate = new Date(focusDate);
                        newViewDate.setUTCDate(focusDate.getUTCDate() + dir * 7);
                    }
                    if (this.dateWithinRange(newDate)) {
                        this.focusDate = this.viewDate = newViewDate;
                        this.setValue();
                        this.fill();
                        e.preventDefault();
                    }
                    break;
                case 32:
                    break;
                case 13:
                    focusDate = this.focusDate || this.dates.get(-1) || this.viewDate;
                    if (this.o.keyboardNavigation) {
                        this._toggle_multidate(focusDate);
                        dateChanged = true;
                    }
                    this.focusDate = null;
                    this.viewDate = this.dates.get(-1) || this.viewDate;
                    this.setValue();
                    this.fill();
                    if (this.picker.is(':visible')) {
                        e.preventDefault();
                        if (this.o.autoclose)
                            this.hide();
                    }
                    break;
                case 9:
                    this.focusDate = null;
                    this.viewDate = this.dates.get(-1) || this.viewDate;
                    this.fill();
                    this.hide();
                    break;
                }
                if (dateChanged) {
                    if (this.dates.length)
                        this._trigger('changeDate');
                    else
                        this._trigger('clearDate');
                    var element;
                    if (this.isInput) {
                        element = this.element;
                    } else if (this.component) {
                        element = this.element.find('input');
                    }
                    if (element) {
                        element.change();
                    }
                }
            },
            showMode: function (dir) {
                if (dir) {
                    this.viewMode = Math.max(this.o.minViewMode, Math.min(2, this.viewMode + dir));
                }
                this.picker.find('>div').hide().filter('.datepicker-' + DPGlobal.modes[this.viewMode].clsName).css('display', 'block');
                this.updateNavArrows();
            }
        };
        var DateRangePicker = function (element, options) {
            this.element = $(element);
            this.inputs = $.map(options.inputs, function (i) {
                return i.jquery ? i[0] : i;
            });
            delete options.inputs;
            $(this.inputs).datepicker(options).bind('changeDate', $.proxy(this.dateUpdated, this));
            this.pickers = $.map(this.inputs, function (i) {
                return $(i).data('datepicker');
            });
            this.updateDates();
        };
        DateRangePicker.prototype = {
            updateDates: function () {
                this.dates = $.map(this.pickers, function (i) {
                    return i.getUTCDate();
                });
                this.updateRanges();
            },
            updateRanges: function () {
                var range = $.map(this.dates, function (d) {
                    return d.valueOf();
                });
                $.each(this.pickers, function (i, p) {
                    p.setRange(range);
                });
            },
            dateUpdated: function (e) {
                if (this.updating)
                    return;
                this.updating = true;
                var dp = $(e.target).data('datepicker'), new_date = dp.getUTCDate(), i = $.inArray(e.target, this.inputs), l = this.inputs.length;
                if (i === -1)
                    return;
                $.each(this.pickers, function (i, p) {
                    if (!p.getUTCDate())
                        p.setUTCDate(new_date);
                });
                if (new_date < this.dates[i]) {
                    while (i >= 0 && new_date < this.dates[i]) {
                        this.pickers[i--].setUTCDate(new_date);
                    }
                } else if (new_date > this.dates[i]) {
                    while (i < l && new_date > this.dates[i]) {
                        this.pickers[i++].setUTCDate(new_date);
                    }
                }
                this.updateDates();
                delete this.updating;
            },
            remove: function () {
                $.map(this.pickers, function (p) {
                    p.remove();
                });
                delete this.element.data().datepicker;
            }
        };
        function opts_from_el(el, prefix) {
            var data = $(el).data(), out = {}, inkey, replace = new RegExp('^' + prefix.toLowerCase() + '([A-Z])');
            prefix = new RegExp('^' + prefix.toLowerCase());
            function re_lower(_, a) {
                return a.toLowerCase();
            }
            for (var key in data)
                if (prefix.test(key)) {
                    inkey = key.replace(replace, re_lower);
                    out[inkey] = data[key];
                }
            return out;
        }
        function opts_from_locale(lang) {
            var out = {};
            if (!dates[lang]) {
                lang = lang.split('-')[0];
                if (!dates[lang])
                    return;
            }
            var d = dates[lang];
            $.each(locale_opts, function (i, k) {
                if (k in d)
                    out[k] = d[k];
            });
            return out;
        }
        var old = $.fn.datepicker;
        $.fn.datepicker = function (option) {
            var args = Array.apply(null, arguments);
            args.shift();
            var internal_return;
            this.each(function () {
                var $this = $(this), data = $this.data('datepicker'), options = typeof option === 'object' && option;
                if (!data) {
                    var elopts = opts_from_el(this, 'date'), xopts = $.extend({}, defaults, elopts, options), locopts = opts_from_locale(xopts.language), opts = $.extend({}, defaults, locopts, elopts, options);
                    if ($this.is('.input-daterange') || opts.inputs) {
                        var ropts = { inputs: opts.inputs || $this.find('input').toArray() };
                        $this.data('datepicker', data = new DateRangePicker(this, $.extend(opts, ropts)));
                    } else {
                        $this.data('datepicker', data = new Datepicker(this, opts));
                    }
                }
                if (typeof option === 'string' && typeof data[option] === 'function') {
                    internal_return = data[option].apply(data, args);
                    if (internal_return !== undefined)
                        return false;
                }
            });
            if (internal_return !== undefined)
                return internal_return;
            else
                return this;
        };
        var defaults = $.fn.datepicker.defaults = {
            autoclose: false,
            beforeShowDay: $.noop,
            calendarWeeks: false,
            clearBtn: false,
            daysOfWeekDisabled: [],
            endDate: Infinity,
            forceParse: true,
            format: 'mm/dd/yyyy',
            keyboardNavigation: true,
            language: 'en',
            minViewMode: 0,
            multidate: false,
            multidateSeparator: ',',
            orientation: 'auto',
            rtl: false,
            startDate: -Infinity,
            startView: 0,
            todayBtn: false,
            todayHighlight: false,
            weekStart: 0
        };
        var locale_opts = $.fn.datepicker.locale_opts = [
            'format',
            'rtl',
            'weekStart'
        ];
        $.fn.datepicker.Constructor = Datepicker;
        var dates = $.fn.datepicker.dates = {
            en: {
                days: [
                    'Sunday',
                    'Monday',
                    'Tuesday',
                    'Wednesday',
                    'Thursday',
                    'Friday',
                    'Saturday',
                    'Sunday'
                ],
                daysShort: [
                    'Sun',
                    'Mon',
                    'Tue',
                    'Wed',
                    'Thu',
                    'Fri',
                    'Sat',
                    'Sun'
                ],
                daysMin: [
                    'Su',
                    'Mo',
                    'Tu',
                    'We',
                    'Th',
                    'Fr',
                    'Sa',
                    'Su'
                ],
                months: [
                    'January',
                    'February',
                    'March',
                    'April',
                    'May',
                    'June',
                    'July',
                    'August',
                    'September',
                    'October',
                    'November',
                    'December'
                ],
                monthsShort: [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ],
                today: 'Today',
                clear: 'Clear'
            }
        };
        var DPGlobal = {
            modes: [
                {
                    clsName: 'days',
                    navFnc: 'Month',
                    navStep: 1
                },
                {
                    clsName: 'months',
                    navFnc: 'FullYear',
                    navStep: 1
                },
                {
                    clsName: 'years',
                    navFnc: 'FullYear',
                    navStep: 10
                }
            ],
            isLeapYear: function (year) {
                return year % 4 === 0 && year % 100 !== 0 || year % 400 === 0;
            },
            getDaysInMonth: function (year, month) {
                return [
                    31,
                    DPGlobal.isLeapYear(year) ? 29 : 28,
                    31,
                    30,
                    31,
                    30,
                    31,
                    31,
                    30,
                    31,
                    30,
                    31
                ][month];
            },
            validParts: /dd?|DD?|mm?|MM?|yy(?:yy)?/g,
            nonpunctuation: /[^ -\/:-@\[\u3400-\u9fff-`{-~\t\n\r]+/g,
            parseFormat: function (format) {
                var separators = format.replace(this.validParts, '\0').split('\0'), parts = format.match(this.validParts);
                if (!separators || !separators.length || !parts || parts.length === 0) {
                    throw new Error('Invalid date format.');
                }
                return {
                    separators: separators,
                    parts: parts
                };
            },
            parseDate: function (date, format, language) {
                if (!date)
                    return undefined;
                if (date instanceof Date)
                    return date;
                if (typeof format === 'string')
                    format = DPGlobal.parseFormat(format);
                var part_re = /([\-+]\d+)([dmwy])/, parts = date.match(/([\-+]\d+)([dmwy])/g), part, dir, i;
                if (/^[\-+]\d+[dmwy]([\s,]+[\-+]\d+[dmwy])*$/.test(date)) {
                    date = new Date();
                    for (i = 0; i < parts.length; i++) {
                        part = part_re.exec(parts[i]);
                        dir = parseInt(part[1]);
                        switch (part[2]) {
                        case 'd':
                            date.setUTCDate(date.getUTCDate() + dir);
                            break;
                        case 'm':
                            date = Datepicker.prototype.moveMonth.call(Datepicker.prototype, date, dir);
                            break;
                        case 'w':
                            date.setUTCDate(date.getUTCDate() + dir * 7);
                            break;
                        case 'y':
                            date = Datepicker.prototype.moveYear.call(Datepicker.prototype, date, dir);
                            break;
                        }
                    }
                    return UTCDate(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), 0, 0, 0);
                }
                parts = date && date.match(this.nonpunctuation) || [];
                date = new Date();
                var parsed = {}, setters_order = [
                        'yyyy',
                        'yy',
                        'M',
                        'MM',
                        'm',
                        'mm',
                        'd',
                        'dd'
                    ], setters_map = {
                        yyyy: function (d, v) {
                            return d.setUTCFullYear(v);
                        },
                        yy: function (d, v) {
                            return d.setUTCFullYear(2000 + v);
                        },
                        m: function (d, v) {
                            if (isNaN(d))
                                return d;
                            v -= 1;
                            while (v < 0)
                                v += 12;
                            v %= 12;
                            d.setUTCMonth(v);
                            while (d.getUTCMonth() !== v)
                                d.setUTCDate(d.getUTCDate() - 1);
                            return d;
                        },
                        d: function (d, v) {
                            return d.setUTCDate(v);
                        }
                    }, val, filtered;
                setters_map['M'] = setters_map['MM'] = setters_map['mm'] = setters_map['m'];
                setters_map['dd'] = setters_map['d'];
                date = UTCDate(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
                var fparts = format.parts.slice();
                if (parts.length !== fparts.length) {
                    fparts = $(fparts).filter(function (i, p) {
                        return $.inArray(p, setters_order) !== -1;
                    }).toArray();
                }
                function match_part() {
                    var m = this.slice(0, parts[i].length), p = parts[i].slice(0, m.length);
                    return m === p;
                }
                if (parts.length === fparts.length) {
                    var cnt;
                    for (i = 0, cnt = fparts.length; i < cnt; i++) {
                        val = parseInt(parts[i], 10);
                        part = fparts[i];
                        if (isNaN(val)) {
                            switch (part) {
                            case 'MM':
                                filtered = $(dates[language].months).filter(match_part);
                                val = $.inArray(filtered[0], dates[language].months) + 1;
                                break;
                            case 'M':
                                filtered = $(dates[language].monthsShort).filter(match_part);
                                val = $.inArray(filtered[0], dates[language].monthsShort) + 1;
                                break;
                            }
                        }
                        parsed[part] = val;
                    }
                    var _date, s;
                    for (i = 0; i < setters_order.length; i++) {
                        s = setters_order[i];
                        if (s in parsed && !isNaN(parsed[s])) {
                            _date = new Date(date);
                            setters_map[s](_date, parsed[s]);
                            if (!isNaN(_date))
                                date = _date;
                        }
                    }
                }
                return date;
            },
            formatDate: function (date, format, language) {
                if (!date)
                    return '';
                if (typeof format === 'string')
                    format = DPGlobal.parseFormat(format);
                var val = {
                    d: date.getUTCDate(),
                    D: dates[language].daysShort[date.getUTCDay()],
                    DD: dates[language].days[date.getUTCDay()],
                    m: date.getUTCMonth() + 1,
                    M: dates[language].monthsShort[date.getUTCMonth()],
                    MM: dates[language].months[date.getUTCMonth()],
                    yy: date.getUTCFullYear().toString().substring(2),
                    yyyy: date.getUTCFullYear()
                };
                val.dd = (val.d < 10 ? '0' : '') + val.d;
                val.mm = (val.m < 10 ? '0' : '') + val.m;
                date = [];
                var seps = $.extend([], format.separators);
                for (var i = 0, cnt = format.parts.length; i <= cnt; i++) {
                    if (seps.length)
                        date.push(seps.shift());
                    date.push(val[format.parts[i]]);
                }
                return date.join('');
            },
            headTemplate: '<thead>' + '<tr>' + '<th class="prev">&laquo;</th>' + '<th colspan="5" class="datepicker-switch"></th>' + '<th class="next">&raquo;</th>' + '</tr>' + '</thead>',
            contTemplate: '<tbody><tr><td colspan="7"></td></tr></tbody>',
            footTemplate: '<tfoot>' + '<tr>' + '<th colspan="7" class="today"></th>' + '</tr>' + '<tr>' + '<th colspan="7" class="clear"></th>' + '</tr>' + '</tfoot>'
        };
        DPGlobal.template = '<div class="datepicker">' + '<div class="datepicker-days">' + '<table class=" table-condensed">' + DPGlobal.headTemplate + '<tbody></tbody>' + DPGlobal.footTemplate + '</table>' + '</div>' + '<div class="datepicker-months">' + '<table class="table-condensed">' + DPGlobal.headTemplate + DPGlobal.contTemplate + DPGlobal.footTemplate + '</table>' + '</div>' + '<div class="datepicker-years">' + '<table class="table-condensed">' + DPGlobal.headTemplate + DPGlobal.contTemplate + DPGlobal.footTemplate + '</table>' + '</div>' + '</div>';
        $.fn.datepicker.DPGlobal = DPGlobal;
        $.fn.datepicker.noConflict = function () {
            $.fn.datepicker = old;
            return this;
        };
        $(document).on('focus.datepicker.data-api click.datepicker.data-api', '[data-provide="datepicker"]', function (e) {
            var $this = $(this);
            if ($this.data('datepicker'))
                return;
            e.preventDefault();
            $this.datepicker('show');
        });
        $(function () {
            $('[data-provide="datepicker-inline"]').datepicker();
        });
    }(window.jQuery));
    return;
});
define('ProductViews.Option.View', [
    'SC.Configuration',
    'Backbone',
    'underscore',
    'bootstrap-datepicker'
], function (Configuration, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        initialize: function () {
            this.config = _.findWhere(Configuration.get('ItemOptions.optionsConfiguration', []), { cartOptionId: this.model.get('cartOptionId') }) || { templates: {} };
            this.config.templates = this.config.templates || {};
            var item_options_default_templates = Configuration.get('ItemOptions.defaultTemplates', {});
            if (item_options_default_templates && item_options_default_templates.selectorByType) {
                if (!this.config.templates.selector) {
                    var option_selector_template = item_options_default_templates.selectorByType[this.model.get('type')], default_option_selector_template = item_options_default_templates.selectorByType['default'];
                    this.config.templates.selector = option_selector_template || default_option_selector_template;
                }
                if (!this.config.templates.selected) {
                    var option_selected_template = item_options_default_templates.selectedByType[this.model.get('type')], default_option_selected_template = item_options_default_templates.selectedByType['default'];
                    this.config.templates.selected = option_selected_template || default_option_selected_template;
                }
                if (!this.config.templates.facetCell) {
                    var option_facetcell_template = item_options_default_templates.facetCellByType[this.model.get('type')], default_option_facetcell_template = item_options_default_templates.facetCellByType['default'];
                    this.config.templates.facetCell = option_facetcell_template || default_option_facetcell_template;
                }
            }
            this.options.templateName = this.options.templateName || 'selector';
            this.template = this.config.templates[this.options.templateName];
        },
        getContext: function () {
            var self = this, selected_value = this.model.get('value') || {}, values = _.map(this.model.get('values'), function (value) {
                    var color = '', is_color_tile = true, image = {};
                    if (self.model.get('colors')) {
                        color = self.model.get('colors')[value.label] || self.model.get('colors').defaultColor;
                        if (_.isObject(color)) {
                            image = color;
                            color = '';
                            is_color_tile = false;
                        }
                    }
                    return {
                        internalId: value.internalid,
                        isAvailable: value.isAvailable,
                        url: value.url,
                        label: value.label,
                        isActive: value.internalid === selected_value.internalid,
                        color: color,
                        isColorTile: is_color_tile,
                        image: image,
                        isLightColor: _.contains(Configuration.get('layout.lightColors', []), value.label)
                    };
                });
            return {
                model: this.model,
                values: values,
                showSelectedValue: !!selected_value,
                showRequiredLabel: this.options.show_required_label && this.model.get('isMandatory'),
                itemOptionId: this.model.get('itemOptionId'),
                cartOptionId: this.model.get('cartOptionId'),
                label: this.model.get('label'),
                selectedValue: selected_value,
                isTextArea: this.model.get('type') === 'textarea',
                isEmail: this.model.get('type') === 'email',
                isText: this.model.get('type') === 'text',
                isCheckbox: this.model.get('type') === 'checkbox',
                isDate: this.model.get('type') === 'date',
                isSelect: this.model.get('type') === 'select',
                showLabel: !this.options.hideLabel,
                showSmall: !!this.options.showSmall
            };
        }
    });
});
define('ProductDetails.Options.Selector.Pusher.View', [
    'product_details_options_selector_pusher.tpl',
    'Backbone'
], function (product_details_options_selector_pusher_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_details_options_selector_pusher_tpl,
        initialize: function () {
            Backbone.View.prototype.initialize.apply(this, arguments);
            this.model.on('change', this.render, this);
        },
        getContext: function () {
            var selected_options = this.model.getSelectedOptions();
            return {
                model: this.model,
                isSelectionCompleted: this.model.isSelectionComplete(),
                hasSelectedOptions: !!selected_options.length,
                selectedOptions: selected_options
            };
        }
    });
});
define('ProductDetails.Options.Selector.View', [
    'ProductViews.Option.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'ProductViews.Price.View',
    'ProductLine.Stock.View',
    'ProductLine.StockDescription.View',
    'ProductDetails.Options.Selector.Pusher.View',
    'product_details_options_selector.tpl',
    'Backbone'
], function (ProductViewsOptionView, BackboneCompositeView, BackboneCollectionView, ProductViewsPriceView, ProductLineStockView, ProductLineStockDescriptionView, ProductDetailsOptionsSelectorPusherView, product_details_options_selector_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_details_options_selector_tpl,
        initialize: function () {
            Backbone.View.prototype.initialize.apply(this, arguments);
            BackboneCompositeView.add(this);
        },
        render: function () {
            if (!this.model.get('options').length) {
                return;
            }
            this._render();
        },
        childViews: {
            'Pusher': function () {
                return new ProductDetailsOptionsSelectorPusherView({ model: this.model });
            },
            'Options.Collection': function () {
                return new BackboneCollectionView({
                    collection: this.model.getVisibleOptions(),
                    childView: ProductViewsOptionView,
                    viewsPerRow: 1,
                    childViewOptions: {
                        line: this.model,
                        item: this.model.get('item'),
                        templateName: 'selector',
                        show_required_label: this.options.show_required_label
                    }
                });
            },
            'Item.Price': function () {
                return new ProductViewsPriceView({
                    model: this.model,
                    origin: 'PDPOPTIONS'
                });
            },
            'Item.Stock': function () {
                return new ProductLineStockView({ model: this.model });
            },
            'StockDescription': function () {
                return new ProductLineStockDescriptionView({ model: this.model });
            }
        },
        getContext: function () {
            return {
                model: this.model,
                showPusher: this.options.show_pusher,
                showRequiredLabel: this.options.show_required_label
            };
        }
    });
});
define('ProductList.Item.Edit.View', [
    'ProductList.Item.Model',
    'GlobalViews.StarRating.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'ProductViews.Price.View',
    'ProductDetails.Options.Selector.View',
    'product_list_edit_item.tpl',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.FormView',
    'Utils'
], function (ProductListItemModel, GlobalViewsStarRatingView, BackboneCompositeView, BackboneCollectionView, ProductViewsPriceView, ProductDetailsOptionsSelectorView, product_list_edit_item_tpl, _, jQuery, Backbone, BackboneFormView, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_edit_item_tpl,
        title: _('Edit item').translate(),
        page_header: _('Edit item').translate(),
        modalClass: 'global-views-modal-large',
        events: {
            'submit form': 'submitForm',
            'blur [data-toggle="text-option"]': 'setOption',
            'click [data-toggle="set-option"]': 'setOption',
            'change [data-toggle="select-option"]': 'setOption',
            'change [name="quantity"]': 'updateQuantity',
            'keypress [name="quantity"]': 'ignoreEnter',
            'click [data-ui-action="add"]': 'addQuantity',
            'click [data-ui-action="minus"]': 'subQuantity',
            'change [name="description"]': 'updateDescription',
            'keypress [name="description"]': 'ignoreEnter',
            'change [name="priority"]': 'updatePriority',
            'keydown [data-toggle="text-option"]': 'tabNavigationFix',
            'focus [data-toggle="text-option"]': 'tabNavigationFix'
        },
        bindings: { '[name="description"]': 'description' },
        initialize: function (options) {
            this.application = options.application;
            this.parentView = options.parentView;
            this.target = options.target;
            this.title = options.title;
            this.page_header = options.title;
            this.confirm_edit_method = options.confirm_edit_method;
            BackboneCompositeView.add(this);
            BackboneFormView.add(this);
        },
        submitForm: function (e) {
            e.preventDefault();
            if (this.model.areAttributesValid([
                    'quantity',
                    'options'
                ], {})) {
                var self = this;
                this.$('[data-action="edit"]').attr('disabled', 'true');
                this.model.save(null, { validate: false }).done(function (new_attributes) {
                    self.parentView[self.confirm_edit_method](new_attributes);
                    var item_list = _.findWhere(self.application.ProductListModule.Utils.getProductLists().models, { id: self.parentView.model.id });
                    item_list && item_list.get('items').get(self.model.id).set('quantity', new_attributes.quantity);
                    if (self.inModal && self.$containerModal) {
                        self.$containerModal.modal('hide');
                        self.destroy();
                    }
                });
            }
        },
        updateQuantity: function (e) {
            var new_quantity = parseInt(jQuery(e.target).val(), 10), min_quantity = this.getMinimumQuantity(), current_quantity = this.model.get('quantity');
            new_quantity = new_quantity >= min_quantity ? new_quantity : min_quantity;
            jQuery(e.target).val(new_quantity);
            if (new_quantity !== current_quantity) {
                this.model.set('quantity', new_quantity);
                this.storeFocus(e);
                this.render();
            }
        },
        addQuantity: function (e) {
            e.preventDefault();
            var $element = jQuery(e.target), oldValue = $element.parent().find('input').val(), newVal = parseInt(oldValue, 10) + 1;
            var input = $element.parent().find('input');
            input.val(newVal);
            input.trigger('change');
        },
        subQuantity: function (e) {
            e.preventDefault();
            var $element = jQuery(e.target), oldValue = $element.parent().find('input').val(), newVal = parseInt(oldValue, 10) - 1;
            newVal = Math.max(1, newVal);
            var input = $element.parent().find('input');
            input.val(newVal);
            input.trigger('change');
        },
        getMinimumQuantity: function () {
            if (this.model.isMatrixChild()) {
                var optionsSelected = this.model.get('itemDetails').itemOptions, optionsAvailable = this.model.get('itemDetails').getPosibleOptions(), activeItem = this.model.getMatrixItem(optionsSelected, optionsAvailable);
                return activeItem && activeItem.get('_minimumQuantity') ? activeItem.get('_minimumQuantity') : 1;
            } else {
                return this.model.get('item').get('_minimumQuantity') ? this.model.get('item').get('_minimumQuantity') : 1;
            }
        },
        updateDescription: function (e) {
            var new_description = jQuery(e.target).val(), current_description = this.model.get('description');
            if (new_description !== current_description) {
                this.model.set('description', new_description);
                this.storeFocus(e);
            }
        },
        updatePriority: function (e) {
            var new_priority = jQuery(e.target).val(), current_priority = this.model.get('priority');
            if (new_priority !== current_priority) {
                this.model.set('priority', { id: new_priority });
                this.storeFocus(e);
            }
        },
        setOption: function (e) {
            var $target = jQuery(e.currentTarget), value = $target.val() || $target.data('value') || null, cart_option_id = $target.closest('[data-type="option"]').data('cart-option-id');
            e.preventDefault();
            if ($target.data('active')) {
                value = null;
            }
            this.model.setOption(cart_option_id, value);
            this.storeFocus(e);
            this.render();
        },
        storeFocus: function () {
            var focused_element = this.$(':focus').get(0);
            this.focusedElement = focused_element ? Utils.getFullPathForElement(focused_element) : null;
        },
        tabNavigationFix: function (e) {
            this.hideError();
            this.tabNavigation = e.type === 'keydown' && e.which === 9;
            this.tabNavigationUpsidedown = e.shiftKey;
            this.tabNavigationCurrent = Utils.getFullPathForElement(e.target);
        },
        afterAppend: function () {
            this.focusedElement && this.$(this.focusedElement).focus();
            if (this.tabNavigation) {
                var current_index = this.$(':input').index(this.$(this.tabNavigationCurrent).get(0)), next_index = this.tabNavigationUpsidedown ? current_index - 1 : current_index + 1;
                this.$(':input:eq(' + next_index + ')').focus();
            }
        },
        showInModal: function (options) {
            this.template = 'product_list_edit_item';
            return this.application.getLayout().showInModal(this, options);
        },
        ignoreEnter: function (e) {
            if (e.keyCode === 13) {
                e.preventDefault();
                e.stopPropagation();
            }
        },
        childViews: {
            'ItemViews.Price': function () {
                return new ProductViewsPriceView({
                    model: this.model,
                    origin: 'PRODUCTLISTDETAILSEDIT'
                });
            },
            'GlobalViews.StarRating': function () {
                return new GlobalViewsStarRatingView({ model: this.model.get('item') });
            },
            'ItemDetails.Options': function () {
                return new ProductDetailsOptionsSelectorView({ model: this.model });
            }
        },
        getContext: function () {
            var line = this.model, item = line.get('item'), min_quantity = item.get('_minimumQuantity'), priority = line.get('priority');
            return {
                showRating: SC.ENVIRONMENT.REVIEWS_CONFIG && SC.ENVIRONMENT.REVIEWS_CONFIG.enabled,
                quantity: line.get('quantity'),
                showMinimumQuantity: min_quantity > 1,
                minQuantity: min_quantity,
                description: line.get('description'),
                productId: item.get('internalid'),
                productName: item.get('_name'),
                itemCreatedDate: line.get('created'),
                isSelectionCompleteForEdit: line.areAttributesValid([
                    'quantity',
                    'options'
                ], {}),
                isPriority1: priority.id === '1',
                isPriority2: priority.id === '2',
                isPriority3: priority.id === '3',
                thumbnail: this.model.getThumbnail()
            };
        }
    });
});
define('GlobalViews.Pagination.View', [
    'global_views_pagination.tpl',
    'Backbone',
    'underscore',
    'Utils'
], function (global_views_pagination_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_pagination_tpl,
        initialize: function () {
            this.current_page;
            this.pages;
            this.pager;
            this.range_start = 1;
            this.range_end;
            this.show_page_list;
            this.precalculateValues();
        },
        _pager: function (url_value) {
            var page_number = parseInt(url_value, 10), url = Backbone.history.fragment;
            return isNaN(page_number) || page_number === 1 ? _.removeUrlParameter(url, 'page') : _.setUrlParameter(url, 'page', page_number);
        },
        _getCurrentPage: function () {
            var url_options = _.parseUrlOptions(Backbone.history.fragment);
            return this._getPageFromUrl(url_options.page);
        },
        _getPageFromUrl: function (url_value) {
            var page_number = parseInt(url_value, 10);
            return !isNaN(page_number) && page_number > 0 ? page_number : 1;
        },
        precalculateValues: function () {
            this.current_page = this._getCurrentPage();
            this.total_pages = parseInt(this.options.totalPages, 10);
            this.pager = this.options.pager || this._pager;
            this.range_end = this.total_pages + 1;
            this.show_page_list = _.isBoolean(this.options.showPageList) ? this.options.showPageList : true;
            var pages_to_show = parseInt(this.options.pagesToShow, 10) || 4, padding_left = pages_to_show % 2 === 0 ? pages_to_show / 2 - 1 : parseInt(pages_to_show / 2, 10);
            if (this.show_page_list && pages_to_show < this.total_pages) {
                if (pages_to_show - padding_left > this.total_pages - this.current_page) {
                    this.range_start = this.total_pages + 1 - pages_to_show;
                } else {
                    this.range_start = this.current_page - padding_left < 1 ? 1 : this.current_page - padding_left;
                    this.range_end = this.range_start + pages_to_show > this.total_pages ? this.total_pages : this.range_start + pages_to_show;
                }
            }
            var self = this;
            this.pages = _.map(_.range(this.range_start, this.range_end), function (page_index) {
                return {
                    isCurrentPageActivePage: page_index === self.current_page,
                    URL: self.pager(page_index),
                    fixedURL: _(self.pager(page_index)).fixUrl(),
                    pageIndex: page_index
                };
            });
        },
        getContext: function () {
            return {
                currentPageLowerThanTotalPagesAndCurrentPageGreaterThan0AndPagesCountGreaterThan1: this.total_pages >= this.current_page && this.current_page > 0 && this.pages.length > 1,
                showPageIndicator: this.options.showPageIndicator || true,
                paginatorClass: this.options.extraClass || '',
                currentPage: this.current_page,
                totalPages: this.total_pages,
                isCurrentPageDifferentThan1: this.current_page !== 1,
                currentPageURL: _(this.pager(this.current_page)).fixUrl(),
                previousPageURL: _(this.pager(this.current_page - 1)).fixUrl(),
                nextPageURL: _(this.pager(this.current_page + 1)).fixUrl(),
                showPageList: this.show_page_list,
                showPaginationLinksCompactClass: !this.show_page_list,
                isRangeStartGreaterThan1: this.range_start > 1,
                isRangeEndLowerThanTotalPages: this.range_end < this.total_pages,
                isCurrentPageLast: this.current_page === this.total_pages,
                pages: this.pages
            };
        }
    });
});
define('GlobalViews.ShowingCurrent.View', [
    'global_views_showing_current.tpl',
    'Backbone',
    'underscore'
], function (global_views_showing_current_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_showing_current_tpl,
        _getCurrentPage: function () {
            var url_options = _.parseUrlOptions(Backbone.history.fragment);
            return this._getPageFromUrl(url_options.page);
        },
        _getPageFromUrl: function (url_value) {
            var page_number = parseInt(url_value, 10);
            return !isNaN(page_number) && page_number > 0 ? page_number : 1;
        },
        getContext: function () {
            this.options.current_page = this._getCurrentPage();
            var lastItem = this.options.current_page * this.options.items_per_page;
            return {
                orderText: this.options.order_id ? ' ' + _('for <a href="/ordershistory/view/$(0)">  Order Number: #$(1)</a>').translate(this.options.order_id, this.options.order_number) : '',
                extraClass: this.options.extraClass,
                firstItem: (this.options.current_page - 1) * this.options.items_per_page + 1,
                lastItem: lastItem > this.options.total_items ? this.options.total_items : lastItem,
                totalItems: this.options.total_items
            };
        }
    });
});
define('ListHeader.View', [
    'SC.Configuration',
    'GlobalViews.Pagination.View',
    'GlobalViews.ShowingCurrent.View',
    'AjaxRequestsKiller',
    'list_header_view.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore',
    'jQuery',
    'Utils',
    'bootstrap-datepicker',
    'UrlHelper'
], function (Configuration, GlobalViewsPaginationView, GlobalViewsShowingCurrentView, AjaxRequestsKiller, list_header_view_tpl, Backbone, BackboneCompositeView, _, jQuery) {
    'use strict';
    var ListHeader = Backbone.View.extend({
        template: list_header_view_tpl,
        events: {
            'change [data-action="filter"]': 'filterHandler',
            'change [data-action="sort"]': 'sortHandler',
            'click [data-action="toggle-sort"]': 'toggleSortHandler',
            'change [data-action="select-all"]': 'selectAll',
            'change [data-action="unselect-all"]': 'unselectAll',
            'focus [data-action="range-filter"]': 'clearRangeFilterTimeout',
            'blur [data-action="range-filter"]': 'rangeFilterBlur',
            'click [data-action="toggle-filters"]': 'toggleFilters',
            'click [data-action="clear-value"]': 'clearRangeValue'
        },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            var view = options.view;
            _.extend(this, options);
            this.avoidFirstFetch = options.avoidFirstFetch;
            this.totalCount = options.totalCount;
            this.rangeFilterOptions = view.rangeFilterOptions || {};
            this.rangeFilterLabel = options.rangeFilterLabel;
            this.expandedStatePath = this.view.className ? this.view.className + '.expanded' : 'state.expanded';
            ListHeader.setPersistedState(this.expandedStatePath, ListHeader.getPersistedState(this.expandedStatePath, false));
            this.eventFilter = options.eventFilter;
            this.eventName = options.eventName;
            this.allowEmptyBoundaries = options.allowEmptyBoundaries;
        },
        destroy: function () {
            this.clearRangeFilterTimeout();
            this._destroy();
        },
        childViews: {
            'GlobalViews.Pagination': function () {
                return new GlobalViewsPaginationView(_.extend({
                    currentPage: this.page,
                    totalPages: Math.ceil(this.collection.totalRecordsFound / this.collection.recordsPerPage),
                    pager: this.pager
                }, Configuration.defaultPaginationSettings));
            },
            'GlobalViews.ShowCurrentPage': function () {
                return new GlobalViewsShowingCurrentView({
                    current_page: this.page,
                    items_per_page: this.collection.recordsPerPage,
                    total_items: this.collection.totalRecordsFound,
                    total_pages: Math.ceil(this.collection.totalRecordsFound / this.collection.recordsPerPage),
                    extraClass: 'pull-right'
                });
            }
        },
        getContext: function () {
            var self = this, hideHeaderExpandable = _.isFunction(this.hideFilterExpandable) ? this.hideFilterExpandable() : this.hideFilterExpandable, selected_filter, selected_sort;
            if (this.selectedFilter) {
                selected_filter = _.isFunction(this.selectedFilter.value) ? this.selectedFilter.value.apply(this.view) : this.selectedFilter.value;
            }
            if (this.selectedSort) {
                selected_sort = this.selectedSort.value;
            }
            _.each(this.displays, function (display) {
                display.url = _(self.displayer(display.id)).fixUrl();
                display.activeClassName = self.selectedDisplay.id === display.id ? 'active' : '';
            });
            _.each(this.filters, function (filter) {
                var item_value = _.isFunction(filter.value) ? filter.value.apply(self.view) : filter.value;
                filter.cssClassName = filter.className || '';
                filter.itemValue = item_value;
                filter.selected = selected_filter === item_value ? true : false;
            });
            _.each(this.sorts, function (sort) {
                sort.selected = selected_sort === sort.value ? true : false;
            });
            return {
                showHeader: this.displays || this.rangeFilter || this.filters || this.collection.length,
                headerMarkup: _.isFunction(this.headerMarkup) ? this.headerMarkup() : this.headerMarkup,
                classes: this.classes || '',
                showHeaderExpandable: !hideHeaderExpandable,
                displays: this.displays,
                rangeFilter: this.rangeFilter,
                selectedRangeFrom: this.selectedRange && this.selectedRange.from,
                rangeFilterLabel: _.isUndefined(this.rangeFilterLabel) ? _('From').translate() : _(this.rangeFilterLabel).translate(),
                rangeFilterFromMin: this.rangeFilterOptions.fromMin || '',
                rangeFilterFromMax: this.rangeFilterOptions.fromMax || '',
                selectedRangeTo: this.selectedRange && this.selectedRange.to,
                rangeFilterToMin: this.rangeFilterOptions.toMin || '',
                rangeFilterToMax: this.rangeFilterOptions.toMax || '',
                filters: this.filters,
                sorts: this.sorts,
                sortIconUp: this.order > 0 ? 'listheader-filter-sortorder-arrow-selected' : '',
                sortIconDown: this.order < 0 ? 'listheader-filter-sortorder-arrow-selected' : '',
                showSelectAll: this.selectable && this.collection.length > 1,
                unselectedLength: this.getUnselectedLength(),
                collectionLength: this.getCollectionLength(),
                showPagination: !this.options.hidePagination ? !!(this.collection.totalRecordsFound && this.collection.recordsPerPage) : false,
                showCurrentPage: !!this.options.showCurrentPage,
                initiallyCollapsed: _.isPhoneDevice() || _.isTabletDevice() ? 'collapse' : ''
            };
        },
        toggleFilters: function (e) {
            e.preventDefault();
            var current_target = jQuery(e.currentTarget), filter_icon = current_target.find('.filter-icon'), is_expanded = ListHeader.getPersistedState(this.expandedStatePath, false);
            is_expanded ? filter_icon.addClass('icon-chevron-down').removeClass('icon-chevron-up') : filter_icon.removeClass('icon-chevron-down').addClass('icon-chevron-up');
            ListHeader.setPersistedState(this.expandedStatePath, !is_expanded);
            current_target.parents('[data-type="accordion"]').toggleClass('well').toggleClass('facet-header-white-well').find('[data-type="accordion-body"]').stop().slideToggle().removeClass('collapse');
        },
        clearRangeValue: function (e) {
            var input = jQuery(e.currentTarget).parent().find('[data-action="range-filter"]');
            input.val('');
            this.rangeFilterHandler();
        },
        getExpanded: function () {
            return ListHeader.getPersistedState(this.expandedStatePath, false);
        },
        getInitialDateRange: function (url_range) {
            if (this.rangeFilter) {
                var date_range_fromUrl = this.getRangeFromUrl(url_range);
                if (date_range_fromUrl.from || date_range_fromUrl.to) {
                    this.validateDateRange(date_range_fromUrl);
                    return date_range_fromUrl;
                } else {
                    var quantityDays = this.notUseDefaultDateRange ? this.quantityDaysRange : this.application.getConfig('listHeader.filterRangeQuantityDays');
                    if (quantityDays) {
                        var from = new Date(), to = new Date();
                        from.setDate(from.getDate() - quantityDays);
                        return {
                            from: _.dateToString(from),
                            to: _.dateToString(to)
                        };
                    }
                }
            }
        },
        getUnselectedLength: function () {
            return this.collection.filter(function (record) {
                return !record.get('checked');
            }).length;
        },
        getCollectionLength: function () {
            return this.collection.length;
        },
        setSelecteds: function () {
            var url_options = _.parseUrlOptions(Backbone.history.fragment);
            this.selectedFilter = this.getFilterFromUrl(url_options.filter);
            this.selectedRange = this.getInitialDateRange(url_options.range) || {};
            this.selectedSort = this.getSortFromUrl(url_options.sort);
            this.order = this.getOrderFromUrl(url_options.order);
            this.page = this.getPageFromUrl(url_options.page);
            this.selectedDisplay = this.getDisplayFromUrl(url_options.display);
        },
        render: function () {
            if (this.totalCount === 0) {
                return;
            }
            if (!this.selectedFilter && !this.selectedSort && !this.order && !this.selectedRange && !this.selectedDisplay) {
                this.setSelecteds();
                if (!this.avoidFirstFetch) {
                    this.updateCollection();
                }
            }
            this._render();
            this.updateCalendarButtons();
            if (this.options.customFilterHandler) {
                this.options.customFilterHandler(this.selectedFilter, this.getElementSort());
            }
        },
        updateCollection: function () {
            var range = null, collection = this.collection;
            if (this.selectedRange) {
                range = {
                    from: this.selectedRange.from || (this.allowEmptyBoundaries ? '' : this.rangeFilterOptions.fromMin),
                    to: this.selectedRange.to || (this.allowEmptyBoundaries ? '' : this.rangeFilterOptions.toMax)
                };
            }
            collection.update && collection.update({
                filter: this.selectedFilter,
                range: range,
                sort: this.selectedSort,
                order: this.order,
                page: this.page,
                killerId: AjaxRequestsKiller.getKillerId()
            }, this);
            return this;
        },
        getFilter: function (value) {
            return _(this.filters).find(function (filter) {
                return _.isFunction(filter.value) ? filter.value.apply(this.view) === value : filter.value === value;
            }, this);
        },
        getSort: function (value) {
            return _.findWhere(this.sorts, { value: value });
        },
        getElementSort: function () {
            return this.$('select[name=sort]');
        },
        getDisplay: function (value) {
            return _.findWhere(this.displays, { id: value });
        },
        getFilterFromUrl: function (url_value) {
            return this.getFilter(url_value) || this.getDefaultFilter();
        },
        getRangeFromUrl: function (url_value) {
            var split = url_value ? url_value.split('to') : [];
            return {
                from: split[0],
                to: split[1]
            };
        },
        getSortFromUrl: function (url_value) {
            return this.getSort(url_value) || this.getDefaultSort();
        },
        getOrderFromUrl: function (url_value) {
            return url_value === 'inverse' ? -1 : 1;
        },
        getDisplayFromUrl: function (url_value) {
            return this.getDisplay(url_value) || this.getDefaultDisplay();
        },
        getPageFromUrl: function (url_value) {
            var page_number = parseInt(url_value, 10);
            return !isNaN(page_number) && page_number > 0 ? page_number : 1;
        },
        pager: function (url_value) {
            var page_number = parseInt(url_value, 10), url = Backbone.history.fragment;
            return isNaN(page_number) || page_number === 1 ? _.removeUrlParameter(url, 'page') : _.setUrlParameter(url, 'page', page_number);
        },
        displayer: function (display_option) {
            var url = Backbone.history.fragment;
            return display_option === this.getDefaultDisplay().id ? _.removeUrlParameter(url, 'display') : _.setUrlParameter(url, 'display', display_option);
        },
        getDefaultFilter: function () {
            return this.defaultFilter || (this.defaultFilter = _.findWhere(this.filters, { selected: true }) || _.first(this.filters));
        },
        getDefaultSort: function () {
            return this.defaultSort || (this.defaultSort = _.findWhere(this.sorts, { selected: true }) || _.first(this.sorts));
        },
        getDefaultDisplay: function () {
            return this.defaultDisplay || (this.defaultDisplay = _.findWhere(this.displays, { selected: true }) || _.first(this.displays));
        },
        isDefaultFilter: function (filter) {
            return this.getDefaultFilter() === filter;
        },
        isDefaultSort: function (sort) {
            return this.getDefaultSort() === sort;
        },
        isDefaultDisplay: function (display) {
            return this.getDefaultDisplay() === display;
        },
        filterHandler: function (e) {
            this.unselectAll({ silent: true });
            this.selectedFilter = this.getFilter(e.target.value);
            this.updateUrl();
        },
        sortHandler: function (e) {
            this.selectedSort = this.getSort(e.target.value);
            this.updateUrl();
        },
        toggleSortHandler: function (e) {
            if (e) {
                e.preventDefault();
            }
            this.order *= -1;
            this.updateUrl();
        },
        selectAll: function () {
            if ('selectAll' in this.view) {
                this.view.selectAll();
            }
            return this;
        },
        unselectAll: function (options) {
            if ('unselectAll' in this.view) {
                this.view.unselectAll(options);
            }
            return this;
        },
        rangeFilterBlur: function () {
            this.clearRangeFilterTimeout();
            this.rangeFilterTimeout = setTimeout(_.bind(this.rangeFilterHandler, this), 1000);
        },
        clearRangeFilterTimeout: function () {
            if (this.rangeFilterTimeout) {
                clearTimeout(this.rangeFilterTimeout);
                this.rangeFilterTimeout = null;
            }
        },
        rangeFilterHandler: function () {
            var selected_range = this.selectedRange, $ranges = this.$('[data-action="range-filter"]');
            $ranges.each(function () {
                if (this.value) {
                    selected_range[this.name] = this.value;
                } else {
                    delete selected_range[this.name];
                }
            });
            if (this.validateDateRange(selected_range)) {
                this.updateUrl();
            } else {
                this.showError(this.application.getErrorMessage('invalidDateFormat'));
            }
            return this;
        },
        validateDateRange: function (selected_range) {
            var options = this.rangeFilterOptions, is_valid = true, to = new Date(selected_range.to), from = new Date(selected_range.from), toMin = new Date(options.toMin), toMax = new Date(options.toMax), fromMin = new Date(options.fromMin), fromMax = new Date(options.fromMax), validateRange = {};
            if (options.toMin && _.isDateValid(toMin) && _.isDateValid(to) && to.getTime() < toMin.getTime()) {
                validateRange.to = options.toMin;
            } else if (!selected_range.to || options.toMax && _.isDateValid(toMax) && _.isDateValid(to) && to.getTime() > toMax.getTime()) {
                validateRange.to = options.toMax;
            }
            if (!selected_range.from || options.fromMin && _.isDateValid(fromMin) && _.isDateValid(from) && from.getTime() < fromMin.getTime()) {
                validateRange.from = options.fromMin;
            } else if (options.fromMax && _.isDateValid(fromMax) && _.isDateValid(from) && from.getTime() > fromMax.getTime()) {
                validateRange.from = options.fromMax;
            }
            if (validateRange.to && !_.isDateValid(_.stringToDate(validateRange.to))) {
                is_valid = false;
                delete selected_range.to;
            }
            if (validateRange.from && !_.isDateValid(_.stringToDate(validateRange.from))) {
                is_valid = false;
                delete selected_range.from;
            }
            return is_valid;
        },
        updateUrl: function () {
            var url = Backbone.history.fragment;
            url = this.isDefaultFilter(this.selectedFilter) ? _.removeUrlParameter(url, 'filter') : _.setUrlParameter(url, 'filter', _.isFunction(this.selectedFilter.value) ? this.selectedFilter.value.apply(this.view) : this.selectedFilter.value);
            url = this.isDefaultSort(this.selectedSort) ? _.removeUrlParameter(url, 'sort') : _.setUrlParameter(url, 'sort', this.selectedSort.value);
            url = this.order === 1 ? _.removeUrlParameter(url, 'order') : _.setUrlParameter(url, 'order', 'inverse');
            if (this.selectedRange) {
                url = this.selectedRange.from || this.selectedRange.to ? _.setUrlParameter(url, 'range', (this.selectedRange.from || '') + 'to' + (this.selectedRange.to || '')) : _.removeUrlParameter(url, 'range');
            }
            url = _.removeUrlParameter(url, 'page');
            this.page = 1;
            Backbone.history.navigate(url, { trigger: false });
            return this.updateCollection();
        },
        updateCalendarButtons: function () {
            var $ranges = this.$('[data-action="range-filter"]');
            $ranges.each(function () {
                var parent = jQuery(this).parent(), calendar_icon = parent.find('.list-header-view-accordion-body-calendar-icon'), clear_button = parent.find('.list-header-view-accordion-body-clear');
                if (this.value) {
                    calendar_icon.hide();
                    clear_button.show();
                } else {
                    calendar_icon.show();
                    clear_button.hide();
                }
            });
        }
    });
    ListHeader = _.extend(ListHeader, {
        setPersistedState: function (path, value) {
            return _.setPathFromObject(this.state = this.state || {}, path, value);
        },
        getPersistedState: function (path, default_value) {
            return _.getPathFromObject(this.state = this.state || {}, path, default_value);
        }
    });
    return ListHeader;
});
define('ProductList.BulkActions.View', [
    'product_list_bulk_actions.tpl',
    'Backbone'
], function (product_list_bulk_actions_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_bulk_actions_tpl,
        getContext: function () {
            var model = this.options.model, isAtLeastOneItemChecked = model.someCheckedItemsExist();
            return {
                isAtLeastOneItemChecked: isAtLeastOneItemChecked,
                hasItems: model.get('items').length,
                isAddToCartEnabled: isAtLeastOneItemChecked && model.canBeAddedToCart(true),
                isTypePredefined: model.get('typeName') === 'predefined'
            };
        }
    });
});
define('ProductList.Details.View', [
    'ProductList.Item.Collection',
    'ProductList.Model',
    'ProductList.Lists.View',
    'ProductList.AddedToCart.View',
    'ProductList.Item.Edit.View',
    'ProductList.Item.Model',
    'ProductList.Control.View',
    'ListHeader.View',
    'MenuTree.View',
    'product_list_details.tpl',
    'LiveOrder.Model',
    'Backbone.CollectionView',
    'ProductList.DisplayFull.View',
    'ProductList.BulkActions.View',
    'Backbone.CompositeView',
    'Handlebars',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.View',
    'Backbone.View.render',
    'Utils'
], function (ProductListItemCollection, ProductListModel, ProductListListsView, ProductListAddedToCartView, ProductListItemEditView, ProductListItemModel, ProductListControlView, ListHeaderView, MenuTreeView, product_list_details_tpl, LiveOrderModel, BackboneCollectionView, ProductListDisplayFullView, ProductListBulkActionsView, BackboneCompositeView, Handlebars, _, jQuery, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_details_tpl,
        className: 'ProductListDetailsView',
        attributes: { 'class': 'ProductListDetailsView' },
        events: {
            'click [data-action="add-to-cart"]': 'addItemToCartHandler',
            'click [data-action="add-items-to-cart"]': 'addItemsToCartBulkHandler',
            'click [data-action="delete-items"]': 'deleteItemsHandler',
            'click [data-action="edit-item"]': 'askEditListItem',
            'click [data-action="update-item-quantity"]': 'updateListItemQuantity',
            'click [data-ui-action="show-edit-notes"]': 'showEditNotes',
            'click [data-ui-action="cancel-edit-notes-form"]': 'showViewNotes',
            'click [data-action="add-list-to-cart"]': 'addListToCart_',
            'click [data-action="edit-list"]': 'editListHandler',
            'change [data-action="change-quantity"]': 'updateItemQuantity',
            'keyup [data-action="change-quantity"]': 'updateItemQuantity',
            'submit [data-action="update-quantity-item-list"]': 'updateItemQuantityFormSubmit',
            'click [data-action="product-list-item"]': 'toggleProductListItemHandler'
        },
        sortOptions: [
            {
                value: 'sku',
                name: _('Sort by name').translate(),
                selected: true
            },
            {
                value: 'price',
                name: _('Sort by price').translate()
            },
            {
                value: 'created',
                name: _('Sort by date Added').translate()
            },
            {
                value: 'priority',
                name: _('Sort by priority').translate()
            }
        ],
        initialize: function (options) {
            this.options = options;
            this.model = options.model;
            this.application = options.application;
            this.cart = LiveOrderModel.getInstance();
            this.displayOptions = this.application.getConfig('productList.templates');
            this.includeSortingFilteringHeader = options.includeSortingFilteringHeader;
            this.title = this.model.get('name');
            this.collection = this.model.get('items');
            this.collection.productListId = this.model.get('internalid');
            this.setupListHeader(this.collection);
            this.on('afterCompositeViewRender', function () {
                var self = this, out_of_stock_items = [], items = this.model.get('items'), is_single_list = this.application.ProductListModule.Utils.isSingleList();
                items.each(function (item) {
                    if (!item.get('item').get('_isPurchasable')) {
                        out_of_stock_items.push(item);
                    }
                    if (!is_single_list) {
                        self.renderMove(item);
                    }
                });
                var warning_message = null;
                if (out_of_stock_items.length === 1) {
                    warning_message = _('$(0) of $(1) items in your list is currently not available for purchase. If you decide to add the list to your cart, only available products will be added.').translate(out_of_stock_items.length, items.length);
                } else if (out_of_stock_items.length > 1) {
                    warning_message = _('$(0) of $(1) items in your list are currently not available for purchase. If you decide to add the list to your cart, only available products will be added.').translate(out_of_stock_items.length, items.length);
                }
                if (warning_message) {
                    self.showWarningMessage(warning_message);
                }
            });
            BackboneCompositeView.add(this);
            this.collection.on('reset', jQuery.proxy(this, 'render'));
        },
        setupListHeader: function (collection) {
            if (!this.includeSortingFilteringHeader) {
                return;
            }
            var self = this;
            this.listHeader = new ListHeaderView({
                view: this,
                application: this.application,
                avoidFirstFetch: true,
                headerMarkup: function () {
                    var view = new ProductListBulkActionsView({ model: self.model });
                    view.render();
                    return new Handlebars.SafeString(view.$el.html());
                },
                hideFilterExpandable: function () {
                    return this.collection.length < 2;
                },
                selectable: true,
                collection: collection,
                sorts: this.sortOptions
            });
        },
        addListToCart_: function () {
            this.addListToCart(this.model);
        },
        addListToCart: ProductListListsView.prototype.addListToCart,
        addItemToCartHandler: function (e) {
            e.stopPropagation();
            e.preventDefault();
            var self = this, selected_product_list_item_id = self.$(e.target).closest('article').data('id'), selected_product_list_item = self.model.get('items').findWhere({ internalid: selected_product_list_item_id.toString() }), selected_item = selected_product_list_item.get('item'), selected_item_internalid = selected_item.internalid, item_detail = selected_product_list_item.getItemForCart(selected_item_internalid, selected_product_list_item.get('quantity'), selected_item.itemoptions_detail, selected_product_list_item.getOptionsArray());
            var add_to_cart_promise = this.addItemToCart(item_detail), whole_promise = jQuery.when(add_to_cart_promise).then(jQuery.proxy(this, 'showConfirmationHelper', selected_product_list_item));
            if (whole_promise) {
                this.disableElementsOnPromise(whole_promise, 'article[data-item-id="' + selected_item_internalid + '"] a, article[data-item-id="' + selected_item_internalid + '"] button');
            }
        },
        _getSelection: function () {
            var items = [], button_selector = [];
            _.each(this.collection.models, function (pli) {
                if (pli.get('checked') !== true) {
                    return;
                }
                items.push(pli);
                var item_internal_id = pli.getItemId();
                button_selector.push('article[data-item-id="' + item_internal_id + '"] a, article[data-item-id="' + item_internal_id + '"] button');
            });
            return {
                items: new ProductListItemCollection(items),
                button_selector: button_selector
            };
        },
        addItemsToCartBulkHandler: function (e) {
            e.preventDefault();
            var self = this, selected_models = this._getSelection();
            if (selected_models.items.length < 1) {
                return;
            }
            var button_selector = selected_models.button_selector.join(','), add_to_cart_promise = this.cart.addProducts(selected_models.items.models);
            add_to_cart_promise.then(function () {
                self.unselectAll();
                self.showConfirmationHelper();
            });
            this.disableElementsOnPromise(add_to_cart_promise, button_selector);
        },
        deleteItemsHandler: function (e) {
            e.preventDefault();
            var self = this, selected_models = this._getSelection(), delete_promises = [];
            if (selected_models.items.length < 1) {
                return;
            }
            var app_item_list = _.findWhere(self.application.ProductListModule.Utils.getProductLists().models, { id: self.model.id });
            _.each([].concat(selected_models.items.models), function (item) {
                item.url = ProductListItemModel.prototype.url;
                app_item_list && app_item_list.get('items').remove(item);
                delete_promises.push(item.destroy().promise());
            });
            jQuery.when.apply(jQuery, delete_promises).then(function () {
                self.render();
                MenuTreeView.getInstance().updateMenuItemsUI();
                self.showConfirmationMessage(_('The selected items were removed from your product list').translate());
            });
        },
        selectAll: function () {
            _.each(this.collection.models, function (item) {
                item.set('checked', true);
            });
            this.render();
        },
        unselectAll: function () {
            _.each(this.collection.models, function (item) {
                item.set('checked', false);
            });
            this.render();
        },
        showConfirmationHelper: function (selected_item) {
            this.showConfirmationMessage(_('Good! The items were successfully added to your cart. You can continue to <a href="#" data-touchpoint="viewcart">view cart and checkout</a>').translate());
            if (_.isUndefined(selected_item) === true) {
                return;
            }
            this.addedToCartView = new ProductListAddedToCartView({
                application: this.application,
                parentView: this,
                item: selected_item
            });
            this.application.getLayout().showInModal(this.addedToCartView);
        },
        addItemToCart: function (item) {
            return this.cart.addItem(item);
        },
        deleteListItem: function (product_list_item, successFunc) {
            this.model.get('items').remove(product_list_item);
            product_list_item.url = ProductListItemModel.prototype.url;
            var promise = product_list_item.destroy();
            promise && successFunc && promise.done(function () {
                successFunc();
            });
        },
        askEditListItem: function (e) {
            e.stopPropagation();
            var product_list_itemid = this.$(e.target).closest('[data-id]').data('id'), selected_item = this.model.get('items').get(product_list_itemid), editView = new ProductListItemEditView({
                    application: this.application,
                    parentView: this,
                    model: selected_item,
                    title: _('Edit Item').translate(),
                    confirm_edit_method: 'editListItemHandler'
                });
            this.application.getLayout().showInModal(editView);
        },
        updateListItemQuantity: function (e) {
            e.preventDefault();
            var self = this, product_list_itemid = this.$(e.target).data('id'), selected_pli = this.model.get('items').findWhere({ internalid: product_list_itemid.toString() }), minimum_quantity = selected_pli.get('item').get('_minimumQuantity'), promise = this.updateItemQuantityHelper(selected_pli, minimum_quantity);
            promise && promise.done(function () {
                self.render();
            });
        },
        editListItemHandler: function (new_attributes) {
            var new_model = new ProductListItemModel(new_attributes), products = this.model.get('items'), original_model = products.get(new_attributes.internalid), original_model_index = products.indexOf(original_model);
            this.model.get('items').remove(new_attributes.internalid, { silent: true });
            this.model.get('items').add(new_model, { at: original_model_index });
            this.render();
        },
        getDisplayOption: function () {
            var search = this.options.params && this.options.params.display || 'list';
            return _(this.displayOptions).findWhere({ id: search });
        },
        renderMove: function (product_list_model) {
            var self = this, container = this.$('[data-id="' + product_list_model.id + '"]').find('[data-type="productlist-control-move"]'), control = new ProductListControlView({
                    collection: self.getMoveLists(self.application.ProductListModule.Utils.getProductLists(), self.model, product_list_model),
                    product: product_list_model,
                    application: self.application,
                    countedClicks: {},
                    moveOptions: {
                        parentView: self,
                        productListItem: product_list_model
                    }
                });
            jQuery(container).empty().append(control.$el);
            control.render();
        },
        getMoveLists: function (all_lists, current_list, list_item) {
            return all_lists.filtered(function (model) {
                return model.get('internalid') !== current_list.get('internalid') && !model.get('items').find(function (product_item) {
                    return product_item.isEqual(list_item);
                });
            });
        },
        editListHandler: function (event) {
            event.preventDefault();
            ProductListListsView.prototype.editList.apply(this, [this.model]);
        },
        getSelectedMenu: function () {
            return 'productlist_' + (this.model.get('internalid') ? this.model.get('internalid') : 'tmpl_' + this.model.get('templateid'));
        },
        getBreadcrumbPages: function () {
            var breadcrumb = [
                {
                    text: _('Wishlist').translate(),
                    href: '/wishlist'
                },
                {
                    text: this.model.get('name'),
                    href: '/wishlist/' + (this.model.get('internalid') ? this.model.get('internalid') : 'tmpl_' + this.model.get('templateid'))
                }
            ];
            if (this.application.ProductListModule.Utils.isSingleList()) {
                breadcrumb.splice(0, 1);
            }
            return breadcrumb;
        },
        updateItemQuantityFormSubmit: function (e) {
            e.preventDefault();
            this.updateItemQuantity(e);
        },
        updateItemQuantityHelper: function (selected_item, new_quantity) {
            selected_item.set('quantity', new_quantity);
            var self = this, edit_result = selected_item.save(null, { validate: false });
            if (edit_result) {
                edit_result.done(function (new_attributes) {
                    var new_model = new ProductListItemModel(new_attributes);
                    self.model.get('items').add(new_model, { merge: true });
                    var item_list = self.application.ProductListModule.Utils.getProductLists().findWhere({ id: self.model.id });
                    item_list && item_list.get('items').get(selected_item.id).set('quantity', new_quantity);
                });
            }
            return edit_result;
        },
        updateItemQuantity: _.debounce(function (e) {
            e.preventDefault();
            var product_list_itemid = this.$(e.target).closest('article').data('id'), selected_item = this.model.get('items').findWhere({ internalid: product_list_itemid.toString() }), options = jQuery(e.target).closest('form').serializeObject(), $input = jQuery(e.target).closest('form').find('[name="item_quantity"]'), new_quantity = parseInt(options.item_quantity, 10), current_quantity = parseInt(selected_item.get('quantity'), 10), minimum_quantity = parseInt(selected_item.get('item').get('_minimumQuantity'), 10) || 0;
            new_quantity = new_quantity > 0 && new_quantity > minimum_quantity ? new_quantity : minimum_quantity || current_quantity;
            $input.val(new_quantity);
            if (new_quantity === current_quantity) {
                return;
            }
            $input.val(new_quantity).prop('disabled', true);
            var edit_promise = this.updateItemQuantityHelper(selected_item, new_quantity);
            if (!edit_promise) {
                return;
            }
            edit_promise.always(function () {
                $input.prop('disabled', false);
            });
        }, 600),
        toggleProductListItemHandler: function toggleProductListItemHandler(e) {
            this.toggleProductListItem(jQuery(e.target).closest('[data-id]').data('id'));
        },
        toggleProductListItem: function (pli) {
            pli = this.collection.get(pli);
            if (pli) {
                this[pli.get('checked') ? 'unselectProductListItem' : 'selectProductListItem'](pli);
                this.render();
            }
        },
        selectProductListItem: function (pli) {
            if (pli) {
                pli.set('checked', true);
            }
        },
        unselectProductListItem: function (pli) {
            if (pli) {
                pli.set('checked', false);
            }
        },
        childViews: {
            'ListHeader': function () {
                return this.listHeader;
            },
            'ProductList.DynamicDisplay': function () {
                var displayOption = this.getDisplayOption(), rows = parseInt(displayOption.columns, 10) || 3;
                return new BackboneCollectionView({
                    childView: ProductListDisplayFullView,
                    collection: this.model.get('items').models,
                    viewsPerRow: rows,
                    childViewOptions: {
                        application: this.application,
                        show_edit_action: true,
                        show_move_action: true
                    }
                });
            }
        },
        getContext: function () {
            var items = this.model.get('items');
            return {
                showListHeader: !(items.length === 0 && this.model.get('typeName') === 'predefined'),
                isTypePredefined: this.model.get('typeName') === 'predefined',
                name: this.model.get('name'),
                hasItems: items.length > 0,
                itemsLength: items.length,
                hasOneItem: items.length === 1
            };
        }
    });
});
define('ProductList.Deletion.View', [
    'product_list_deletion.tpl',
    'underscore',
    'Backbone',
    'Backbone.View',
    'Backbone.View.render',
    'Utils'
], function (product_list_deletion_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_list_deletion_tpl,
        title: _('Delete item').translate(),
        attributes: { 'class': 'view product-list-deletion-confirm' },
        page_header: _('Delete item').translate(),
        events: { 'click [data-action="delete"]': 'confirmDelete' },
        initialize: function (options) {
            this.application = options.application;
            this.parentView = options.parentView;
            this.target = options.target;
            this.title = options.title;
            this.page_header = options.title;
            this.body = options.body;
            this.confirm_delete_method = options.confirm_delete_method;
            this.confirmLabel = options.confirmLabel || _('Yes, Remove It').translate();
        },
        render: function () {
            Backbone.View.prototype.render.apply(this, arguments);
            var self = this;
            this.$containerModal.on('shown.bs.modal', function () {
                self.$('[data-action="delete"]').focus();
            });
        },
        confirmDelete: function () {
            this.parentView[this.confirm_delete_method](this.target);
        },
        getTitle: function () {
            return _('Delete product list').translate();
        },
        getContext: function () {
            return {
                body: this.body,
                hasConfirmLabel: !!this.confirmLabel,
                confirmLabel: this.confirmLabel,
                hasCancelLabel: !!this.cancelLabel,
                cancelLabel: this.cancelLabel
            };
        }
    });
});
define('ProductList.DetailsLater.View', [
    'product_list_details_later.tpl',
    'ProductList.DetailsLaterMacro.View',
    'ProductList.Details.View',
    'ProductList.Deletion.View',
    'LiveOrder.Model',
    'Profile.Model',
    'Backbone.CollectionView',
    'Backbone.CompositeView',
    'products_detail_later_cell.tpl',
    'backbone_collection_view_row.tpl',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.View',
    'Backbone.View.render'
], function (product_list_details_later_tpl, ProductListDetailsLaterMacroView, ProductListDetailsView, ProductListDeletionView, LiveOrderModel, ProfileModel, BackboneCollectionView, BackboneCompositeView, products_detail_later_cell_tpl, backbone_collection_view_row_tpl, _, jQuery, Backbone) {
    'use strict';
    var product_list_promise;
    return Backbone.View.extend({
        template: product_list_details_later_tpl,
        events: {
            'click [data-action="add-to-cart"]': 'addItemToCartHandler',
            'click [data-action="delete-item"]': 'askDeleteListItem',
            'change [data-action="change-quantity"]': 'updateItemQuantity',
            'keyup [data-action="change-quantity"]': 'updateItemQuantity',
            'click [data-ui-action="add"]': 'addQuantity',
            'click [data-ui-action="minus"]': 'subQuantity'
        },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.options = options;
            this.application = options.application;
            this.cart = LiveOrderModel.getInstance();
            this.model.on('change', this.render, this);
            this.model.get('items').on('add remove change reset', this.render, this);
            this.promise = this.loadProductList();
        },
        render: function () {
            if (ProfileModel.getInstance().get('isLoggedIn') === 'T') {
                this._render();
                this.$('[data-action="pushable"]').scPush();
            } else {
                this.$el.empty();
            }
            return this;
        },
        loadProductList: function () {
            var self = this;
            if (!product_list_promise) {
                ProfileModel.getPromise().done(function () {
                    if (ProfileModel.getInstance().get('isLoggedIn') === 'T') {
                        product_list_promise = self.options.application.ProductListModule.Utils.getSavedForLaterProductList().done(function (attributes) {
                            self.model.set(attributes);
                        });
                    }
                });
            }
            return product_list_promise;
        },
        addItemToCartHandler: function (e) {
            e.stopPropagation();
            e.preventDefault();
            var selected_product_list_item_id = this.$(e.target).closest('article').data('id'), selected_product_list_item = this.model.get('items').get(selected_product_list_item_id), add_to_cart_promise = this.cart.addLine(selected_product_list_item), whole_promise = jQuery.when(add_to_cart_promise, this.deleteListItem(selected_product_list_item));
            this.disableElementsOnPromise(whole_promise, this.$(e.target).closest('article').find('button'));
        },
        addQuantity: function (e) {
            e.preventDefault();
            var $element = jQuery(e.target), oldValue = $element.parent().find('input').val(), newVal = parseFloat(oldValue) + 1;
            var input = $element.parent().find('input');
            input.val(newVal);
            input.trigger('change');
        },
        subQuantity: function (e) {
            e.preventDefault();
            var $element = jQuery(e.target), oldValue = $element.parent().find('input').val(), newVal = parseFloat(oldValue) - 1;
            newVal = Math.max(1, newVal);
            var input = $element.parent().find('input');
            input.val(newVal);
            input.trigger('change');
        },
        askDeleteListItem: function (e) {
            e.stopPropagation();
            this.deleteConfirmationView = new ProductListDeletionView({
                application: this.application,
                parentView: this,
                target: e.target,
                title: _('Delete selected items').translate(),
                body: _('Are you sure you want to remove selected items?').translate(),
                confirmLabel: _('Yes').translate(),
                confirm_delete_method: 'deleteListItemHandler'
            });
            this.deleteConfirmationView.showInModal();
        },
        deleteListItemHandler: function (target) {
            var self = this, itemid = jQuery(target).closest('article').data('id'), product_list_item = this.model.get('items').findWhere({ internalid: itemid + '' }), success = function () {
                    if (self.application.getLayout().updateMenuItemsUI) {
                        self.application.getLayout().updateMenuItemsUI();
                    }
                    self.deleteConfirmationView.$containerModal.modal('hide');
                    self.render();
                    self.showConfirmationMessage(_('The item was removed from your product list').translate(), true);
                };
            self.model.get('items').remove(product_list_item);
            self.deleteListItem(product_list_item, success);
        },
        deleteListItem: ProductListDetailsView.prototype.deleteListItem,
        disableElementsOnPromise: ProductListDetailsView.prototype.disableElementsOnPromise,
        updateItemQuantity: ProductListDetailsView.prototype.updateItemQuantity,
        updateItemQuantityHelper: ProductListDetailsView.prototype.updateItemQuantityHelper,
        childViews: {
            'ProductList.DetailsLater.Collection': function () {
                return new BackboneCollectionView({
                    collection: this.model.get('items'),
                    childView: ProductListDetailsLaterMacroView,
                    viewsPerRow: 4,
                    cellTemplate: products_detail_later_cell_tpl,
                    rowTemplate: backbone_collection_view_row_tpl,
                    childViewOptions: { application: this.application }
                });
            }
        },
        getContext: function () {
            var items = this.model.get('items'), itemsLength = items.length;
            return {
                itemsLength: itemsLength,
                hasItems: itemsLength > 0,
                isEmpty: itemsLength === 0,
                hasMoreThanOneItem: itemsLength > 1
            };
        }
    });
});
define('Transaction.Line.Views.Price.View', [
    'Profile.Model',
    'Session',
    'SC.Configuration',
    'transaction_line_views_price.tpl',
    'Backbone'
], function (ProfileModel, Session, Configuration, transaction_line_views_price_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: transaction_line_views_price_tpl,
        initialize: function () {
            this.profileModel = ProfileModel.getInstance();
            this.isPriceEnabled = !ProfileModel.getInstance().hidePrices();
            if (this.isPriceEnabled) {
                this.model.on('change:quantity', function () {
                    this.render();
                }, this);
            }
        },
        getUrlLogin: function () {
            var url = Session.get('touchpoints.login') + '&origin=' + (Configuration.get('currentTouchpoint') || 'home') + '&origin_hash=';
            return url + encodeURIComponent(this.options.origin === 'PDPQUICK' ? this.model.generateURL().replace('/', '') : Backbone.history.fragment);
        },
        getContext: function () {
            var price_container_object = this.model.getPrice(), showComparePrice = this.options.showComparePrice && price_container_object.price < price_container_object.compare_price;
            return {
                model: this.model,
                showComparePrice: showComparePrice,
                isInStock: !!this.model.getStockInfo().isInStock,
                currencyCode: SC.getSessionInfo('currency').code || '',
                comparePriceFormatted: price_container_object.compare_price_formatted || '',
                price: price_container_object.price || 0,
                rateFormatted: this.model.get('rate_formatted') || price_container_object.price_formatted || '',
                isPriceEnabled: this.isPriceEnabled,
                urlLogin: this.getUrlLogin()
            };
        }
    });
});
define('ProductLine.Sku.View', [
    'product_line_sku.tpl',
    'Backbone'
], function (product_line_sku_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_line_sku_tpl,
        initialize: function () {
            this.model.on('change', this.render, this);
        },
        destroy: function destroy() {
            Backbone.View.prototype.destroy.apply(this, arguments);
            this.model.off('change', this.render, this);
        },
        getContext: function () {
            return {
                model: this.model,
                sku: this.model.getSku()
            };
        }
    });
});
define('Transaction.Line.Views.Tax', [
    'transaction_line_views_tax.tpl',
    'Backbone'
], function (transaction_line_views_tax_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: transaction_line_views_tax_tpl,
        initialize: function () {
            this.model.on('change:quantity', function () {
                this.render();
            }, this);
        },
        getContext: function () {
            return {
                showTax: !!this.model.get('tax1_amount') || !!this.model.get('tax_amount'),
                taxRate: this.model.get('tax_rate1') || this.model.get('tax_rate'),
                taxAmount: this.model.get('tax1_amount_formatted') || this.model.get('tax_amount_formatted')
            };
        }
    });
});
define('Cart.Lines.View', [
    'Transaction.Line.Views.Price.View',
    'Transaction.Line.Views.Options.Selected.View',
    'ProductLine.Stock.View',
    'ProductLine.Sku.View',
    'ProductLine.StockDescription.View',
    'Transaction.Line.Views.Tax',
    'Backbone.CollectionView',
    'Backbone.CompositeView',
    'cart_lines.tpl',
    'Backbone',
    'underscore',
    'SC.Configuration'
], function (TransactionLineViewsPriceView, TransactionLineViewsOptionsSelectedView, ProductLineStockView, ProductLineSkuView, ProductLineStockDescriptionView, TransactionLineViewsTax, BackboneCollectionView, BackboneCompositeView, cart_lines_tpl, Backbone, _, Configuration) {
    'use strict';
    return Backbone.View.extend({
        template: cart_lines_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        childViews: {
            'Item.Price': function () {
                return new TransactionLineViewsPriceView({
                    model: this.model,
                    showComparePrice: true
                });
            },
            'Item.Sku': function () {
                return new ProductLineSkuView({ model: this.model });
            },
            'Item.SelectedOptions': function () {
                return new TransactionLineViewsOptionsSelectedView({ model: this.model });
            },
            'Product.Stock.Info': function () {
                return new ProductLineStockView({ model: this.model });
            },
            'Item.Tax.Info': function () {
                if (Configuration.get('showTaxDetailsPerLine')) {
                    return new TransactionLineViewsTax({ model: this.model });
                }
            },
            'Item.Summary.View': function () {
                return new this.options.SummaryView(_.extend({
                    model: this.model,
                    application: this.options.application
                }, this.options.summaryOptions || {}));
            },
            'Item.Actions.View': function () {
                return new this.options.ActionsView(_.extend({
                    model: this.model,
                    application: this.options.application
                }, this.options.actionsOptions || {}));
            },
            'StockDescription': function () {
                return new ProductLineStockDescriptionView({ model: this.model });
            }
        },
        getContext: function () {
            var item = this.model.get('item');
            return {
                line: this.model,
                lineId: this.model.get('internalid'),
                item: item,
                itemId: item.get('internalid'),
                linkAttributes: this.model.getFullLink({
                    quantity: null,
                    location: null,
                    fulfillmentChoice: null
                }),
                isNavigable: !!this.options.navigable && !!item.get('_isPurchasable'),
                showCustomAlert: !!item.get('_cartCustomAlert'),
                customAlertType: item.get('_cartCustomAlertType') || 'info',
                showActionsView: !!this.options.ActionsView,
                showSummaryView: !!this.options.SummaryView,
                showAlert: !_.isUndefined(this.options.showAlert) ? !!this.options.showAlert : true,
                showGeneralClass: !!this.options.generalClass,
                generalClass: this.options.generalClass,
                thumbnail: this.model.getThumbnail()
            };
        }
    });
});
define('Cart.Promocode.Notifications.View', [
    'GlobalViews.Message.View',
    'cart_promocode_notifications.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore'
], function (GlobalViewsMessageView, cart_promocode_notifications, Backbone, BackboneCompositeView, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_promocode_notifications,
        initialize: function initialize() {
            BackboneCompositeView.add(this);
            this.on('afterCompositeViewRender', this.afterViewRender, this);
        },
        childViews: {
            'Promocode.Notification': function () {
                var notification = this.getNotification();
                return new GlobalViewsMessageView({
                    message: notification.message,
                    type: notification.type,
                    closable: true
                });
            }
        },
        afterViewRender: function () {
            this.options.parentModel.trigger('promocodeNotificationShown', this.model.get('internalid'));
        },
        getNotification: function () {
            var notification = {};
            if (this.model.get('applicabilitystatus') === 'APPLIED') {
                notification.type = 'success';
                notification.message = _('Promotion <strong>').translate() + this.model.get('code') + _('</strong> is now discounting your order.').translate();
            } else if (this.model.get('applicabilityreason') === 'CRITERIA_NOT_MET') {
                notification.type = !this.model.get('isautoapplied') ? 'warning' : 'info';
                notification.message = _('Promotion <strong>').translate() + this.model.get('code') + _('</strong> is not discounting your order. ').translate() + this.model.get('errormsg');
            } else if (this.model.get('applicabilityreason') === 'DISCARDED_BEST_OFFER') {
                notification.type = 'info';
                notification.message = _('We have chosen the best possible offer for you. Promotion <strong>').translate() + this.model.get('code') + _('</strong> is not discounting your order.').translate();
            }
            return notification;
        },
        getContext: function getContext() {
            return {};
        }
    });
});
define('Cart.PromocodeForm.View', [
    'ErrorManagement',
    'GlobalViews.Message.View',
    'cart_promocode_form.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'jQuery',
    'underscore',
    'Utils'
], function (ErrorManagement, GlobalViewsMessageView, cart_promocode_form_tpl, Backbone, BackboneCompositeView, jQuery, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_promocode_form_tpl,
        events: { 'submit form[data-action="apply-promocode"]': 'applyPromocode' },
        initialize: function (options) {
            this.promocode = options.promocode || {};
            this.state = {
                errorMessage: null,
                code: '',
                isSaving: false
            };
            BackboneCompositeView.add(this);
        },
        applyPromocode: function applyPromocode(e) {
            e.preventDefault();
            e.stopPropagation();
            var self = this, $target = this.$(e.target), options = $target.serializeObject(), pre_promocodes = this.model.get('promocodes') || [], new_promocodes = pre_promocodes.concat({ code: options.promocode });
            if (!options.promocode) {
                this.state.errorMessage = _('Promo Code is required').translate();
            } else {
                this.state.errorMessage = null;
                this.state.isSaving = true;
                this.trigger('applying_promocode');
                this.model.save({ promocodes: new_promocodes }).fail(function savePromocodeFailed(jqXhr) {
                    self.model.set('promocodes', pre_promocodes);
                    jqXhr.preventDefault = true;
                    self.state.errorMessage = ErrorManagement.parseErrorMessage(jqXhr, self.options.application.getLayout().errorMessageKeys);
                    self.trigger('apply_promocode_failed');
                }).done(function savePromocodeSucceeded() {
                    self.trigger('apply_promocode_succeeded');
                    self.model.trigger('promocodeUpdated', 'applied');
                }).always(function savePromocodeEnded() {
                    self.state.isSaving = false;
                    self.state.code = '';
                    self.trigger('apply_promocode_finished');
                    self.render();
                });
            }
            this.render();
        },
        childViews: {
            'GlobalsViewErrorMessage': function () {
                var placeholder = jQuery('[data-type="promocode-error-placeholder"]');
                var global_view_message = new GlobalViewsMessageView({
                    message: this.state.errorMessage,
                    type: 'error',
                    closable: true
                });
                placeholder.html(global_view_message.render().$el.html());
            }
        },
        getContext: function getContext() {
            return {
                showErrorMessage: !!this.state.errorMessage,
                errorMessage: this.state.errorMessage,
                promocodeCode: this.state.code,
                isSaving: this.state.isSaving
            };
        }
    });
});
define('GlobalViews.FormatPaymentMethod.View', [
    'SC.Configuration',
    'Utils',
    'global_views_format_payment_method.tpl',
    'Backbone',
    'underscore'
], function (Configuration, Utils, global_views_format_payment_method_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_format_payment_method_tpl,
        initialize: function (options) {
            this.showBillingInfo = options.showBillingInfo;
            this.model = options.model || new Backbone.Model();
        },
        getContext: function () {
            var payment_methods = Configuration.get('siteSettings.paymentmethods'), credit_card = this.model.get('creditcard'), is_paypal = this.model.get('type') === 'paypal', is_credit_card = this.model.get('type') === 'creditcard' && credit_card && credit_card.ccnumber, is_invoice = this.model.get('type') === 'invoice', is_gift_certificate = this.model.get('type') === 'giftcertificate', credit_card_payment_method_name = credit_card && credit_card.paymentmethod ? credit_card.paymentmethod.name : '', credit_card_payment_method_internalid = credit_card && credit_card.paymentmethod ? credit_card.paymentmethod.internalid : '', credit_card_payment_method_key = credit_card && credit_card.paymentmethod ? credit_card.paymentmethod.key : '', gift_certificate_ending = '', payment_method = credit_card_payment_method_key ? _.findWhere(payment_methods, { key: credit_card_payment_method_key }) : _.findWhere(payment_methods, { internalid: credit_card_payment_method_internalid }), icon = payment_method && payment_method.imagesrc && payment_method.imagesrc[0];
            if (is_gift_certificate) {
                var code_length = this.model.get('giftcertificate').code.length;
                gift_certificate_ending = this.model.get('giftcertificate').code.substring(code_length - 4, code_length);
            }
            return {
                model: this.model,
                showStreet: this.model.get('ccstreet') && this.showBillingInfo,
                showZipCode: this.model.get('cczipcode') && this.showBillingInfo,
                isCreditcard: is_credit_card,
                isGiftCertificate: is_gift_certificate,
                isPaypal: is_paypal,
                isInvoice: is_invoice,
                isOther: !is_invoice && !is_paypal && !is_credit_card && !is_gift_certificate,
                type: this.model.get('type') || _('Not specified').translate(),
                name: this.model.get('name') || _('Not specified').translate(),
                creditCardNumberEnding: credit_card && credit_card.ccnumber && credit_card.ccnumber.replace(/\*/g, '') || '',
                showCreditCardImage: !!icon,
                creditCardImageUrl: icon || '',
                creditCardPaymentMethodName: credit_card_payment_method_name,
                creditCard: credit_card,
                giftCertificateEnding: gift_certificate_ending,
                showPurchaseNumber: !!this.model.get('purchasenumber')
            };
        }
    });
});
define('Cart.Promocode.List.Item.View', [
    'cart_promocode_list_item.tpl',
    'Backbone',
    'underscore'
], function (cart_promocode_list_item_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_promocode_list_item_tpl,
        getContext: function getContext() {
            var code = this.model.get('code'), internalid = this.model.get('internalid'), hide_autoapply_promo = !_.isUndefined(this.model.get('isautoapplied')) ? this.model.get('applicabilityreason') === 'DISCARDED_BEST_OFFER' || this.model.get('isautoapplied') && this.model.get('applicabilitystatus') === 'NOT_APPLIED' : false;
            if (this.options.source === 'item_summary') {
                code = this.model.get('promotion_couponcode');
                internalid = this.model.get('promotion_id');
            }
            return {
                showPromo: !!code && !hide_autoapply_promo,
                code: code,
                internalid: internalid,
                isEditable: !this.options.isReadOnly && !this.model.get('isautoapplied'),
                showDiscountRate: !!this.model.get('discountrate_formatted'),
                discountRate: this.model.get('discountrate_formatted'),
                showWarning: this.model.get('isvalid') === false && this.model.get('errormsg'),
                errorMessage: this.model.get('errormsg')
            };
        }
    });
});
define('Cart.Promocode.List.View', [
    'Cart.Promocode.List.Item.View',
    'cart_promocode_list.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'underscore'
], function (CartPromocodeListItemView, cart_promocode_list_tpl, Backbone, BackboneCompositeView, BackboneCollectionView, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_promocode_list_tpl,
        events: { 'click [data-action="remove-promocode"]': 'removePromocode' },
        initialize: function initialize() {
            BackboneCompositeView.add(this);
        },
        setOptions: function setOptions(options) {
            this.options = options;
            this.model = options.model || this.model;
        },
        removePromocode: function removePromocode(e) {
            e.preventDefault();
            var self = this, promocodes = this.model.get('promocodes') || [], promo_code_internalid = (this.$(e.currentTarget).data('id') || '').toString();
            this.trigger('removing_promocode');
            promocodes = _.reject(promocodes, function (promocode) {
                return promocode.internalid === promo_code_internalid;
            });
            this.model.save({ 'promocodes': promocodes }).always(function promocodeSaveFinished() {
                self.trigger('remove_promocode_finished');
                self.model.trigger('promocodeUpdated', 'removed');
            });
        },
        childViews: {
            'PromocodeList': function () {
                return new BackboneCollectionView({
                    collection: _.filter(this.model.get('promocodes') || [], function (promocode) {
                        return promocode.internalid;
                    }),
                    viewsPerRow: 1,
                    childView: CartPromocodeListItemView,
                    childViewOptions: {
                        isReadOnly: this.options.isReadOnly,
                        source: 'summary'
                    }
                });
            }
        },
        getContext: function getContext() {
            return {};
        }
    });
});
define('Cart.Summary.View', [
    'SC.Configuration',
    'Cart.PromocodeForm.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'GlobalViews.FormatPaymentMethod.View',
    'Profile.Model',
    'Cart.Promocode.List.View',
    'Session',
    'cart_summary.tpl',
    'cart_summary_gift_certificate_cell.tpl',
    'underscore',
    'Backbone'
], function (Configuration, CartPromocodeFormView, BackboneCompositeView, BackboneCollectionView, GlobalViewsFormatPaymentMethodView, ProfileModel, CartPromocodeListView, Session, cart_summary_tpl, cart_summary_gift_certificate_cell_tpl, _, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: cart_summary_tpl,
        initialize: function initialize(options) {
            this.model = options.model;
            BackboneCompositeView.add(this);
            this.promocodeFormComponent = new CartPromocodeFormView({
                model: this.model,
                application: this.options.application
            });
        },
        childViews: {
            'Cart.PromocodeFrom': function () {
                return this.promocodeFormComponent;
            },
            'CartPromocodeListView': function () {
                return new CartPromocodeListView({
                    model: this.model,
                    isReadOnly: false
                });
            },
            'GiftCertificates': function () {
                var gift_certificates = this.model.get('paymentmethods').where({ type: 'giftcertificate' }) || [];
                return new BackboneCollectionView({
                    collection: gift_certificates,
                    cellTemplate: cart_summary_gift_certificate_cell_tpl,
                    viewsPerRow: 1,
                    childView: GlobalViewsFormatPaymentMethodView,
                    rowTemplate: null
                });
            }
        },
        getUrlLogin: function getUrlLogin() {
            var login = Session.get('touchpoints.login'), currentTouchpoint = this.model.application && this.model.application.Configuration.currentTouchpoint ? this.model.application.Configuration.currentTouchpoint : 'home';
            login += '&origin=' + currentTouchpoint;
            if (this.$el.closest('.modal-product-detail').size() > 0) {
                var hashtag = this.$el.closest('.modal-product-detail').find('[data-name="view-full-details"]').data('hashtag');
                login += '&origin_hash=' + encodeURIComponent(hashtag.replace('#/', ''));
            } else {
                login += '&origin_hash=' + encodeURIComponent(Backbone.history.fragment);
            }
            return login;
        },
        getContext: function getContext() {
            var continueURL = Configuration.get('siteSettings.sitetype') === 'ADVANCED' ? Configuration.defaultSearchUrl : '', is_wsdk = false, summary = this.model.get('summary'), items_count = _.reduce(this.model.get('lines').pluck('quantity'), function (memo, quantity) {
                    return memo + (parseFloat(quantity) || 1);
                }, 0), shipping_address = this.model.get('addresses').get(this.model.get('shipaddress')) || new Backbone.Model(), default_country = shipping_address.get('country') || Configuration.get('siteSettings.defaultshipcountry'), shipping_zip_code = shipping_address.get('zip'), promocodes = this.model.get('promocodes') || [], gift_certificates = this.model.get('paymentmethods').where({ type: 'giftcertificate' }) || [], is_single_country = _.size(Configuration.get('siteSettings.countries', [])) === 1, is_zipcode_require, selected_country, countries_list, is_estimated_shipping_valid, show_estimation_form = true, countries = _.clone(Configuration.get('siteSettings.countries'));
            if (countries && default_country && countries[default_country]) {
                selected_country = _.findWhere(countries, { selected: true });
                if (selected_country) {
                    selected_country.selected = false;
                }
                countries[default_country].selected = true;
                is_zipcode_require = countries[default_country].isziprequired !== 'F';
                selected_country = countries[default_country];
                countries_list = _.toArray(countries);
            } else {
                selected_country = _.findWhere(countries, { selected: true });
                countries_list = _.toArray(countries);
                if (!selected_country) {
                    selected_country = _.first(countries_list);
                }
                is_zipcode_require = selected_country.isziprequired !== 'F';
            }
            if (_.isString(shipping_address.id) && shipping_address.id !== '-------null') {
                is_estimated_shipping_valid = is_zipcode_require ? !!shipping_zip_code : !!shipping_address.get('country');
            } else {
                is_estimated_shipping_valid = false;
            }
            if (Configuration.get('siteSettings.iswsdk', false) && Configuration.get('siteSettings.wsdkcancelcarturl')) {
                continueURL = Configuration.get('siteSettings.wsdkcancelcarturl');
                is_wsdk = true;
            }
            if (is_estimated_shipping_valid && is_zipcode_require) {
                show_estimation_form = false;
            } else if (is_estimated_shipping_valid) {
                show_estimation_form = !this.options.showEstimated;
            } else {
                show_estimation_form = true;
            }
            return {
                model: this.model,
                isWSDK: is_wsdk,
                continueURL: continueURL,
                showActions: true,
                showLabelsAsEstimated: true,
                summary: summary,
                itemCount: items_count,
                isSingleItem: items_count === 1,
                isZipCodeRequire: is_zipcode_require,
                showEstimate: show_estimation_form,
                showHandlingCost: !!summary.handlingcost,
                showGiftCertificates: !!summary.giftcertapplied,
                showPromocodeForm: Configuration.get('promocodes.allowMultiples', true) || !promocodes.length,
                giftCertificates: gift_certificates,
                showDiscountTotal: !!summary.discounttotal,
                defaultCountry: default_country,
                isDefaultCountryUS: default_country === 'US',
                countries: countries_list,
                singleCountry: is_single_country,
                singleCountryCode: is_single_country ? countries_list[0].code : '',
                shipToText: shipping_zip_code || selected_country.name,
                singleCountryName: is_single_country ? countries_list[0].name : '',
                shippingZipCode: shipping_zip_code || '',
                showPaypalButton: Configuration.get('siteSettings.checkout.paypalexpress.available', 'F') === 'T',
                paypalButtonImageUrl: Configuration.get('paypalButtonImageUrl', 'https://www.paypalobjects.com/webstatic/en_US/i/buttons/checkout-logo-large.png'),
                showProceedButton: Configuration.get('siteSettings.sitetype') === 'STANDARD',
                urlLogin: this.getUrlLogin(),
                isPriceEnabled: !ProfileModel.getInstance().hidePrices(),
                showPickupInStoreLabel: this.model.getPickupInStoreLines().length > 0,
                areAllItemsPickupable: this.model.getPickupInStoreLines().length === this.model.get('lines').length,
                taxLabel: !!Configuration.get('summaryTaxLabel') ? Configuration.get('summaryTaxLabel') : 'Tax'
            };
        }
    });
});
define('Cart.Item.Summary.View', [
    'Cart.Promocode.List.Item.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Profile.Model',
    'cart_item_summary.tpl',
    'Backbone',
    'underscore'
], function (CartPromocodeListItemView, BackboneCompositeView, BackboneCollectionView, ProfileModel, cart_item_summary_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_item_summary_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        events: {
            'click [data-action="plus"]': 'addQuantity',
            'click [data-action="minus"]': 'subQuantity'
        },
        addQuantity: function (e) {
            e.preventDefault();
            var $element = this.$(e.target), quantity_input = $element.parent().find('input'), old_value = quantity_input.val(), new_val = parseFloat(old_value) + 1;
            quantity_input.val(new_val);
            quantity_input.change();
        },
        subQuantity: function (e) {
            e.preventDefault();
            var $element = this.$(e.target), quantity_input = $element.parent().find('input'), old_value = quantity_input.val(), new_val = parseFloat(old_value) - 1;
            new_val = Math.max(this.model.get('item').get('_minimumQuantity', true), new_val);
            quantity_input.val(new_val);
            quantity_input.change();
        },
        childViews: {
            'PromocodeList': function () {
                if (!!this.model.get('discounts_impact')) {
                    var discounts = _.filter(this.model.get('discounts_impact').discounts, function (discount) {
                        return !!discount.promotion_couponcode;
                    });
                    return new BackboneCollectionView({
                        collection: discounts,
                        viewsPerRow: 1,
                        childView: CartPromocodeListItemView,
                        childViewOptions: {
                            isReadOnly: true,
                            source: 'item_summary'
                        }
                    });
                }
            }
        },
        getContext: function () {
            var minimum_quantity = this.model.get('item').get('_minimumQuantity', true) || 1;
            return {
                line: this.model,
                lineId: this.model.get('internalid'),
                isMinusButtonDisabled: this.model.get('item').get('quantity') <= this.model.get('item').get('_minimumQuantity', true) || this.model.get('item').get('quantity') === 1,
                showQuantity: this.model.get('item').get('_itemType') === 'GiftCert',
                showComparePrice: this.model.get('amount') > this.model.get('total'),
                showMinimumQuantity: minimum_quantity > 1,
                minimumQuantity: minimum_quantity,
                isPriceEnabled: !ProfileModel.getInstance().hidePrices()
            };
        }
    });
});
define('Cart.Item.Actions.View', [
    'Backbone.CompositeView',
    'SC.Configuration',
    'cart_item_actions.tpl',
    'Backbone',
    'Utils'
], function (BackboneCompositeView, Configuration, cart_item_actions_tpl, Backbone, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: cart_item_actions_tpl,
        initialize: function () {
            this.application = this.options.application;
            BackboneCompositeView.add(this);
        },
        getContext: function () {
            return {
                line: this.model,
                item: this.model.get('item'),
                editUrl: Utils.addParamsToUrl(this.model.generateURL(), {
                    'source': 'cart',
                    'internalid': this.model.get('internalid')
                }),
                isAdvanced: Configuration.siteSettings.sitetype !== 'STANDARD',
                showSaveForLateButton: this.application.ProductListModule && this.application.ProductListModule.Utils.isProductListEnabled() && Configuration.currentTouchpoint === 'home',
                lineId: this.model.get('internalid'),
                showQuantity: this.model.get('item').get('_itemType') === 'GiftCert'
            };
        }
    });
});
define('jQuery.scStickyButton', [
    'jQuery',
    'Utils'
], function (jQuery, Utils) {
    'use strict';
    var sticky_button, padding_offset = 20;
    jQuery.fn.scStickyButton = function () {
        if (canStick()) {
            init(this);
            jQuery(document).on('scroll touchstart touchmove', checkStickyPosition);
        }
        return this;
    };
    function canStick() {
        var viewport_width = Utils.getViewportWidth(), mobile_width_max = 768;
        return viewport_width < mobile_width_max;
    }
    function init(sticky) {
        sticky_button = jQuery(sticky);
        var button_clone = jQuery('<div class="sticky-button-container-clone">').append(sticky_button.clone(true).removeAttr('data-action'));
        sticky_button.wrap('<div class="sticky-button-container">').parent().append(button_clone);
        unStickIt();
    }
    function checkStickyPosition() {
        var document_scroll_top = jQuery(document).scrollTop(), is_sticked = sticky_button.hasClass('sticked'), current_offset = sticky_button.offset().top - padding_offset;
        if (!is_sticked && document_scroll_top >= current_offset) {
            stickIt();
        } else if (is_sticked && document_scroll_top <= current_offset) {
            unStickIt();
        }
    }
    function stickIt() {
        var clone = sticky_button.parent().find('.sticky-button-container-clone').first();
        clone.addClass('sticked');
        sticky_button.addClass('sticked');
    }
    function unStickIt() {
        var clone = sticky_button.parent().find('.sticky-button-container-clone').first();
        clone.removeClass('sticked');
        sticky_button.removeClass('sticked');
    }
});
define('Cart.Detailed.View', [
    'Backbone.CompositeView',
    'GlobalViews.Message.View',
    'Backbone.CollectionView',
    'Backbone.FormView',
    'Cart.Lines.View',
    'Cart.Promocode.Notifications.View',
    'Cart.Summary.View',
    'Cart.Item.Summary.View',
    'Cart.Item.Actions.View',
    'SC.Configuration',
    'cart_detailed.tpl',
    'Utils',
    'underscore',
    'Backbone',
    'jQuery',
    'jQuery.scStickyButton'
], function (BackboneCompositeView, GlobalViewsMessageView, BackboneCollectionView, BackboneFormView, CartLinesView, CartPromocodeNotifications, CartSummaryView, CartItemSummaryView, CartItemActionsView, Configuration, cart_detailed_tpl, Utils, _, Backbone, jQuery) {
    'use strict';
    var colapsibles_states = {};
    return Backbone.View.extend({
        template: cart_detailed_tpl,
        title: _('Shopping Cart').translate(),
        page_header: _('Shopping Cart').translate(),
        attributes: { 'id': 'Cart.Detailed.View' },
        bindings: { '[name="zip"]': 'zip' },
        events: {
            'change [data-type="cart-item-quantity-input"]': 'debouncedUpdateItemQuantity',
            'keypress [data-type="cart-item-quantity-input"]': 'debouncedUpdateItemQuantity',
            'submit [data-action="update-quantity"]': 'updateItemQuantityFormSubmit',
            'click [data-action="remove-item"]': 'removeItem',
            'submit form[data-action="estimate-tax-ship"]': 'estimateTaxShip',
            'click [data-action="remove-shipping-address"]': 'removeShippingAddress',
            'change [data-action="estimate-tax-ship-country"]': 'changeCountry'
        },
        initialize: function (options) {
            this.application = options.application;
            this.showEstimated = false;
            BackboneCompositeView.add(this);
            BackboneFormView.add(this);
            this.model.on('change', this.render, this);
            this.model.get('lines').on('add remove', this.render, this);
            this.model.on('LINE_ROLLBACK', this.render, this);
            this.model.on('promocodeNotificationShown', this.removePromocodeNotification, this);
            this.on('afterCompositeViewRender', this.resetColapsiblesState, this);
            this.on('afterCompositeViewRender', this.initPlugins, this);
            this.options = options;
        },
        getBreadcrumbPages: function () {
            return {
                href: '/cart',
                text: _('Shopping Cart').translate()
            };
        },
        initPlugins: function initPlugins() {
            if (Configuration.get('siteSettings.sitetype') === 'ADVANCED') {
                this.$('[data-action="sticky"]').scStickyButton();
            }
            Utils.initBxSlider(this.$('[data-type="carousel-items"]'), Configuration.get('bxSliderDefaults'));
        },
        render: function render() {
            this.storeColapsiblesState();
            this._render();
            return this;
        },
        hideError: function hideError(selector) {
            var el = selector ? selector.find('[data-type="alert-placeholder"]') : this.$('[data-type="alert-placeholder"]');
            el.empty();
        },
        showError: function showError(message, line, error_details) {
            var placeholder;
            this.hideError();
            if (line) {
                if (error_details && error_details.status === 'LINE_ROLLBACK') {
                    var new_line_id = error_details.newLineId;
                    line.attr('id', new_line_id);
                    line.find('[name="internalid"]').attr({
                        id: 'update-internalid-' + new_line_id,
                        value: new_line_id
                    });
                }
                placeholder = line.find('[data-type="alert-placeholder"]');
                this.hideError(line);
            } else {
                placeholder = this.$('[data-type="alert-placeholder"]');
                this.hideError();
            }
            if (!placeholder.length) {
                placeholder = jQuery('<div/>', { 'data-type': 'alert-placeholder' });
                this.$el.prepend(placeholder);
            }
            var global_view_message = new GlobalViewsMessageView({
                message: message,
                type: 'error',
                closable: true
            });
            placeholder.append(global_view_message.render().$el.html());
            if (line) {
                line.find(':disabled').attr('disabled', false);
            } else {
                this.$(':disabled').attr('disabled', false);
            }
        },
        validInputValue: function (input) {
            if (input.validity && !input.validity.valid || input.value === '') {
                return false;
            }
            return !isNaN(input.value);
        },
        updateItemQuantity: function updateItemQuantity(e) {
            var self = this, $line = null, $form = jQuery(e.target).closest('form'), options = $form.serializeObject(), internalid = options.internalid, line = this.model.get('lines').get(internalid), $input = $form.find('[name="quantity"]'), validInput = this.validInputValue($input[0]);
            if (!line || this.isRemoving) {
                return;
            }
            if (!validInput || options.quantity) {
                var new_quantity = parseInt(options.quantity, 10), item = line.get('item'), min_quantity = item ? item.get('_minimumQuantity', true) : line.get('minimumquantity'), current_quantity = parseInt(line.get('quantity'), 10);
                new_quantity = new_quantity >= min_quantity ? new_quantity : current_quantity;
                $input.val(new_quantity);
                if (new_quantity !== current_quantity) {
                    $line = this.$('#' + internalid);
                    $input.val(new_quantity).prop('disabled', true);
                    line.set('quantity', new_quantity);
                    var invalid = line.validate();
                    if (!invalid) {
                        var update_promise = this.model.updateLine(line);
                        this.disableElementsOnPromise(update_promise, '#' + internalid + ' button');
                        update_promise.fail(function (jqXhr) {
                            jqXhr.preventDefault = true;
                            var result = JSON.parse(jqXhr.responseText);
                            self.showError(result.errorMessage, $line, result.errorDetails);
                            line.set('quantity', current_quantity);
                        }).always(function () {
                            $input.prop('disabled', false);
                        });
                    } else {
                        var placeholder = this.$('#' + internalid + ' [data-type="alert-placeholder"]');
                        placeholder.empty();
                        _.each(invalid, function (value) {
                            var global_view_message = new GlobalViewsMessageView({
                                message: value,
                                type: 'error',
                                closable: true
                            });
                            placeholder.append(global_view_message.render().$el.html());
                        });
                        $input.prop('disabled', false);
                        line.set('quantity', current_quantity);
                    }
                }
            }
        },
        debouncedUpdateItemQuantity: _.debounce(function (e) {
            this.updateItemQuantity(e);
        }, 1000),
        updateItemQuantityFormSubmit: function updateItemQuantityFormSubmit(e) {
            e.preventDefault();
            this.updateItemQuantity(e);
        },
        removeItem: function removeItem(e) {
            var self = this, product = this.model.get('lines').get(this.$(e.target).data('internalid')), remove_promise = this.model.removeLine(product), internalid = product.get('internalid');
            this.isRemoving = true;
            this.disableElementsOnPromise(remove_promise, 'article[id="' + internalid + '"] a, article[id="' + internalid + '"] button');
            remove_promise.always(function () {
                self.isRemoving = false;
            });
            return remove_promise;
        },
        estimateTaxShip: function estimateTaxShip(e) {
            var options = this.$(e.target).serializeObject(), address_internalid = options.zip + '-' + options.country + '-null';
            e.preventDefault();
            this.model.get('addresses').push({
                internalid: address_internalid,
                zip: options.zip,
                country: options.country
            });
            this.model.set('shipaddress', address_internalid);
            var promise = this.saveForm(e);
            if (promise) {
                this.swapEstimationStatus();
            }
        },
        swapEstimationStatus: function swapEstimationStatus() {
            this.showEstimated = !this.showEstimated;
        },
        removeShippingAddress: function removeShippingAddress(e) {
            e.preventDefault();
            this.swapEstimationStatus();
            this.model.save({
                shipmethod: null,
                shipaddress: null
            });
        },
        changeCountry: function changeCountry(e) {
            e.preventDefault();
            var options = this.$(e.target).serializeObject(), AddressModel = this.model.get('addresses').model;
            this.model.get('addresses').add(new AddressModel({
                country: options.country,
                internalid: options.country
            }));
            this.model.set({ shipaddress: options.country });
        },
        resetColapsiblesState: function resetColapsiblesState() {
            var self = this;
            _.each(colapsibles_states, function (is_in, element_selector) {
                self.$(element_selector)[is_in ? 'addClass' : 'removeClass']('in').css('height', is_in ? 'auto' : '0');
            });
        },
        storeColapsiblesState: function () {
            this.$('.collapse').each(function (index, element) {
                colapsibles_states[Utils.getFullPathForElement(element)] = jQuery(element).hasClass('in');
            });
        },
        removePromocodeNotification: function (promocode_id) {
            var promocode = _.findWhere(this.model.get('promocodes'), { internalid: promocode_id });
            delete promocode.notification;
        },
        destroy: function () {
            colapsibles_states = {};
            this.model.off('change', this.render, this);
            this.model.get('lines').off('add remove', this.render, this);
            this.model.off('LINE_ROLLBACK', this.render, this);
            this.off('afterCompositeViewRender', this.resetColapsiblesState, this);
            this.off('afterCompositeViewRender', this.initPlugins, this);
            this._destroy();
        },
        childViews: {
            'Cart.Summary': function () {
                return new CartSummaryView({
                    model: this.model,
                    showEstimated: this.showEstimated,
                    application: this.application
                });
            },
            'Item.ListNavigable': function () {
                return new BackboneCollectionView({
                    collection: this.model.get('lines'),
                    viewsPerRow: 1,
                    childView: CartLinesView,
                    childViewOptions: {
                        navigable: true,
                        application: this.application,
                        SummaryView: CartItemSummaryView,
                        ActionsView: CartItemActionsView,
                        showAlert: false
                    }
                });
            },
            'Promocode.Notifications': function () {
                var promotions = _.filter(this.model.get('promocodes') || [], function (promocode) {
                    return promocode.notification === true;
                });
                if (promotions.length) {
                    return new BackboneCollectionView({
                        collection: promotions,
                        viewsPerRow: 1,
                        childView: CartPromocodeNotifications,
                        childViewOptions: { parentModel: this.model }
                    });
                }
            }
        },
        getExtraChildrenOptions: function () {
            return { urlOptions: this.options.urlOptions };
        },
        getContext: function () {
            var lines = this.model.get('lines'), product_count = lines.length, item_count = _.reduce(lines.models, function (memo, line) {
                    return memo + line.get('quantity');
                }, 0), product_and_items_count = '';
            if (product_count === 1) {
                if (item_count === 1) {
                    product_and_items_count = _('1 Product, 1 Item').translate();
                } else {
                    product_and_items_count = _('1 Product, $(0) Items').translate(item_count);
                }
            } else {
                if (item_count === 1) {
                    product_and_items_count = _('$(0) Products, 1 Item').translate(product_count);
                } else {
                    product_and_items_count = _('$(0) Products, $(1) Items').translate(product_count, item_count);
                }
            }
            return {
                model: this.model,
                showLines: !!(lines && lines.length),
                lines: lines,
                productsAndItemsCount: product_and_items_count,
                productCount: product_count,
                itemCount: item_count,
                pageHeader: this.page_header
            };
        }
    });
});
define('jQuery.scPush', [
    'jQuery',
    'underscore',
    'Utils'
], function (jQuery, _, Utils) {
    'use strict';
    jQuery.fn.scPush = function (options) {
        var settings = jQuery.extend({}, jQuery.fn.push.defaults, options), $main = jQuery('.layout-container');
        setOverlay();
        $main.removeClass('sc-pushing');
        $main.css({
            'margin-top': '',
            'height': ''
        }).removeClass('sc-pushing-partial');
        var opened_pusher_id = jQuery('[data-pushing]').attr('data-pushing'), opened_pusher = jQuery('[data-id="' + opened_pusher_id + '"]');
        if (opened_pusher.length > 0) {
            opened_pusher.addClass('sc-pushing-reopened');
            openPushContent(opened_pusher_id, true);
            $main.addClass('sc-pushing');
        }
        return this.each(function () {
            var self = this, $this = jQuery(this), $push_header = $this.find('.sc-pusher-header, [data-type="sc-pusher-header"]');
            if (!$push_header.length) {
                $push_header = jQuery('<div class="sc-pusher-header"><a href="#" class="sc-pusher-header-back" data-action="sc-pusher-dismiss">' + _('Back').translate() + '</a></div>');
                $this.prepend($push_header);
            }
            var push_target_size = settings.target === 'tablet' ? 'sc-pushable-md' : 'sc-pushable-xs';
            $this.attr('data-pusher', push_target_size);
            var id = $this.data('id');
            if (!id) {
                id = 'sc-pusher-' + new Date().getTime();
                $this.attr('data-id', id);
            }
            var openFn = jQuery.proxy(function (e) {
                var proxy = jQuery.proxy(openPushContent, this);
                if (options && options.beforeOpen) {
                    var res = options.beforeOpen(proxy, e);
                    if (!res) {
                        return;
                    }
                } else {
                    e.preventDefault();
                }
                this.currentScroll = jQuery(document.body).scrollTop();
                proxy(id);
                if (options && options.afterOpen) {
                    options.afterOpen(proxy, e);
                }
            }, this);
            var closeFn = jQuery.proxy(function (e) {
                e.preventDefault();
                $this.trigger('beforeClose');
                jQuery('#content').removeAttr('data-pushing');
                jQuery('[data-id="' + id + '"]').removeClass('sc-pushing-reopened');
                $main.removeClass('sc-pushing');
                jQuery('[data-view="Footer"]').show();
                if (Utils.getViewportWidth() < 768) {
                    this.currentScroll && jQuery(document.body).scrollTop(this.currentScroll);
                } else {
                    $main.css({
                        'margin-top': '',
                        'height': ''
                    }).removeClass('sc-pushing-partial');
                    jQuery(document.body).scrollTop(this.currentScroll);
                    jQuery('.main-push-overlay').removeClass('active');
                }
                if ($this.attr('data-action')) {
                    $this.attr('data-action', $this.attr('data-action').replace('sc-pushing', ''));
                }
                $this.trigger('afterClose');
            }, this);
            var pusher = jQuery('[data-type="sc-pusher"][data-target="' + id + '"]');
            $this.on('open', openFn);
            pusher.on('click', openFn);
            $this.on('close', closeFn);
            $push_header.find('[data-action="sc-pusher-dismiss"]').on('click', closeFn);
        });
    };
    function setOverlay() {
        if (Utils.getViewportWidth() >= 768) {
            var $main = jQuery('.layout-container'), overlay = jQuery('<div class="main-push-overlay" data-action="main-push-overlay-hide"></div>');
            $main.find('.main-push-overlay').remove();
            $main.append(overlay);
            overlay.on('click', function () {
                jQuery(this).removeClass('active');
                var pushed_content = jQuery('[data-action="sc-pushing"]');
                jQuery('#content').removeAttr('data-pushing');
                jQuery('[data-id="' + pushed_content.attr('data-id') + '"]').removeClass('sc-pushing-reopened');
                $main.removeClass('sc-pushing');
                jQuery('[data-view="Footer"]').show();
                $main.css({
                    'margin-top': '',
                    'height': ''
                }).removeClass('sc-pushing-partial');
                pushed_content.attr('data-action', pushed_content.attr('data-action').replace('sc-pushing', ''));
                jQuery(document.body).scrollTop(pushed_content[0].currentScroll);
            });
        }
    }
    function openPushContent(id, isStatic) {
        jQuery('#content').attr('data-pushing', id);
        jQuery('[data-id="' + id + '"]').attr('data-action', 'sc-pushing');
        var open_handler = jQuery.proxy(onPushOpened, this);
        if (isStatic) {
            open_handler();
        } else {
            jQuery('[data-id="' + id + '"][data-action="sc-pushing"]').one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function (e) {
                open_handler();
                jQuery(this).off('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend');
            });
        }
    }
    function onPushOpened() {
        var $main = jQuery('.layout-container');
        if (Utils.getViewportWidth() < 768) {
            $main.addClass('sc-pushing');
            jQuery('[data-view="Footer"]').hide();
        } else {
            $main.css({
                'margin-top': -this.currentScroll,
                'height': '+=' + this.currentScroll
            }).addClass('sc-pushing-partial');
            jQuery('.main-push-overlay').addClass('active');
        }
    }
    jQuery.fn.push.defaults = {
        target: 'mobile',
        appendPusher: false
    };
});
define('ProductList.CartSaveForLater.View', [
    'SC.Configuration',
    'ErrorManagement',
    'ProductList.DetailsLater.View',
    'ProductList.Model',
    'ProductList.Item.Model',
    'Cart.Detailed.View',
    'Session',
    'Profile.Model',
    'product_list_details_later.tpl',
    'underscore',
    'jQuery',
    'Backbone',
    'Utils',
    'jQuery.scPush'
], function (Configuration, ErrorManagement, ProductListDetailsLaterView, ProductListModel, ProductListItemModel, CartDetailedView, Session, ProfileModel, product_list_details_later_tpl, _, jQuery, Backbone, Utils) {
    'use strict';
    var original_initialize = CartDetailedView.prototype.initialize, product_list_model = new ProductListModel();
    _.extend(CartDetailedView.prototype, {
        initialize: function () {
            var self = this;
            original_initialize.apply(this, arguments);
            this.productListModel = product_list_model;
            this.utils = this.application.ProductListModule && this.application.ProductListModule.Utils;
            ProfileModel.getPromise().done(function () {
                self.render();
            });
        },
        childViews: _.extend({}, CartDetailedView.prototype.childViews, {
            'SavedForLater': function () {
                if (this.utils && this.utils.isProductListEnabled()) {
                    return new ProductListDetailsLaterView({
                        application: this.options.application,
                        model: this.productListModel
                    });
                }
                return null;
            }
        }),
        saveForLaterItem: function (e) {
            e.preventDefault();
            if (!this.validateLogin()) {
                return;
            }
            var cart_line = this.model.get('lines').get(jQuery(e.target).data('internalid')), internalid = cart_line.get('internalid'), whole_promise = jQuery.Deferred(), self = this;
            jQuery.when(this.model.removeLine(cart_line), self.addItemToList(cart_line)).then(function () {
                self.showConfirmationMessage(_('Good! You saved the item for later. If you want to add it back to your cart, see below in <b>"Saved for later"</b>').translate());
                whole_promise.resolve();
            });
            this.disableElementsOnPromise(whole_promise, '#' + internalid + ' button');
        },
        addItemToList: function (cart_line) {
            var defer = jQuery.Deferred(), self = this;
            if (this.productListModel.isNew()) {
                this.productListModel.save().done(function () {
                    self.doAddItemToList(self.productListModel.get('internalid'), cart_line, defer);
                });
            } else {
                self.doAddItemToList(self.productListModel.get('internalid'), cart_line, defer);
            }
            return defer.promise();
        },
        doAddItemToList: function (product_list_id, cart_line, internal_promise) {
            var self = this, product_list_item_model = ProductListItemModel.createFromTransactionLine(cart_line);
            product_list_item_model.set('productList', { id: product_list_id });
            product_list_item_model.set('description', '');
            product_list_item_model.set('item', cart_line.get('item'), { silent: true });
            product_list_item_model.save(null, { validate: false }).done(function () {
                product_list_item_model.set('item', cart_line.get('item'), { silent: true });
                self.productListModel.get('items').add(product_list_item_model, { at: 0 });
                internal_promise.resolve();
            });
        },
        validateLogin: function () {
            if (ProfileModel.getInstance().get('isLoggedIn') === 'F') {
                var parameters = {
                    'origin': this.application.getConfig('currentTouchpoint'),
                    'origin_hash': encodeURIComponent(Backbone.history.fragment)
                };
                window.location.href = Utils.addParamsToUrl(Session.get('touchpoints.login'), parameters);
                return false;
            }
            return true;
        }
    });
    CartDetailedView.prototype.events = _.extend({}, CartDetailedView.prototype.events, { 'click [data-action="save-for-later-item"]': 'saveForLaterItem' });
    return CartDetailedView;
});
define('ProductList.Utils', [
    'ProductList.Collection',
    'ProductList.Model',
    'Profile.Model',
    'ProductList.ControlSingle.View',
    'ProductList.Control.View',
    'ProductList.Item.Model',
    'MenuTree.View',
    'underscore',
    'jQuery',
    'ProductList.CartSaveForLater.View'
], function (ProductListCollection, ProductListModel, ProfileModel, ProductListControlSingleView, ProductListControlView, ProductListItemModel, MenuTreeView, _, jQuery) {
    'use strict';
    var productListsInstancePromise, productListsInstance;
    return function (application) {
        return {
            getProductListsPromise: function () {
                if (!productListsInstancePromise) {
                    productListsInstancePromise = jQuery.Deferred();
                    productListsInstance = new ProductListCollection();
                    productListsInstance.application = application;
                    productListsInstance.fetch({ cache: false }).done(function (jsonCollection) {
                        productListsInstance.reset(jsonCollection);
                        productListsInstancePromise.resolve(productListsInstance);
                    });
                }
                return productListsInstancePromise;
            },
            productListsPromiseDone: function () {
                var layout = application.getLayout(), menu_tree = MenuTreeView.getInstance();
                menu_tree.replaceMenuItem(function (menuitem) {
                    return menuitem && menuitem.id === 'product_list_dummy';
                }, function (application) {
                    var utils = application.ProductListModule.Utils;
                    if (!utils.isProductListEnabled()) {
                        return undefined;
                    }
                    var product_lists = utils.getProductLists(), actual_object = {
                            id: function () {
                                var is_single_list = utils.isSingleList();
                                if (is_single_list) {
                                    var the_single_list = product_lists.at(0);
                                    return 'productlist_' + (the_single_list.get('internalid') ? the_single_list.get('internalid') : 'tmpl_' + the_single_list.get('templateId'));
                                } else {
                                    return 'productlists';
                                }
                            },
                            name: function () {
                                return utils.isSingleList() ? product_lists.at(0).get('name') : _('Wishlist').translate();
                            },
                            url: function () {
                                var is_single_list = utils.isSingleList();
                                if (is_single_list) {
                                    var the_single_list = product_lists.at(0);
                                    return 'wishlist/' + (the_single_list.get('internalid') ? the_single_list.get('internalid') : 'tmpl_' + the_single_list.get('templateId'));
                                } else {
                                    return '';
                                }
                            },
                            index: 2,
                            children: function () {
                                if (utils.isSingleList()) {
                                    return [];
                                }
                                var items = [{
                                        id: 'productlist_all',
                                        name: _('All my lists').translate(),
                                        url: 'wishlist/?',
                                        index: 1
                                    }];
                                product_lists.each(function (productlist) {
                                    items.push({
                                        id: 'productlist_' + (productlist.get('internalid') || 'tmpl_' + productlist.get('templateId')),
                                        url: 'wishlist/' + (productlist.get('internalid') || 'tmpl_' + productlist.get('templateId')),
                                        name: productlist.get('name') + ' (' + productlist.get('items').length + ')',
                                        index: 2
                                    });
                                });
                                return items;
                            }
                        };
                    return actual_object;
                });
                menu_tree.updateMenuItemsUI();
                if (application.ProductListModule.Utils.isSingleList()) {
                    var the_single_list = application.ProductListModule.Utils.getProductLists().at(0), product_list_menu_item = layout.$('.header-profile-single-productlist');
                    if (the_single_list && product_list_menu_item) {
                        var product_list_hashtag = '#wishlist/' + (the_single_list.get('internalid') ? the_single_list.get('internalid') : 'tmpl_' + the_single_list.get('templateId'));
                        product_list_menu_item.text(the_single_list.get('name'));
                        product_list_menu_item.attr('data-hashtag', product_list_hashtag);
                    }
                }
            },
            profileModelPromiseDone: function () {
                var utils = application.ProductListModule.Utils;
                if (!utils.isProductListEnabled()) {
                    return;
                }
                var layout = application.getLayout();
                utils.renderProductLists();
                layout.on('afterAppendView', function (view) {
                    utils.renderProductLists(view);
                });
                layout.on('afterAppendToDom', function () {
                    utils.renderProductLists();
                });
                utils.getProductListsPromise().done(utils.productListsPromiseDone);
                ProductListItemModel.prototype.keyMapping = application.getConfig('itemKeyMapping', {});
                ProductListItemModel.prototype.itemOptionsConfig = application.getConfig('itemOptions', []);
            },
            getProductLists: function () {
                if (!productListsInstance) {
                    productListsInstance = new ProductListCollection();
                    productListsInstance.application = application;
                }
                return productListsInstance;
            },
            getProductList: function (id) {
                var productList = new ProductListModel();
                productList.set('internalid', id);
                return productList.fetch();
            },
            getSavedForLaterProductList: function () {
                var productList = new ProductListModel();
                productList.set('internalid', 'later');
                return productList.fetch();
            },
            getRequestAQuoteProductList: function () {
                var productList = new ProductListModel();
                productList.set('internalid', 'quote');
                return productList.fetch();
            },
            isProductListEnabled: function () {
                return SC.ENVIRONMENT.PRODUCTLIST_ENABLED;
            },
            isSingleList: function () {
                return !application.getConfig('productList.additionEnabled', false) && _.filter(application.getConfig('productList.listTemplates', []), function (pl) {
                    return !pl.typeName || pl.typeName !== 'later' && pl.typeName !== 'quote';
                }).length === 1;
            },
            renderProductLists: function (view) {
                if (!application.ProductListModule.Utils.isProductListEnabled()) {
                    return;
                }
                application.ProductListModule.Utils.renderControl(view);
            },
            internalGetProductId: function (product) {
                if (product.getPosibleOptions().length) {
                    var selected_options = product.getSelectedMatrixChilds();
                    if (selected_options.length === 1) {
                        return selected_options[0].get('internalid') + '';
                    }
                }
                return product.get('_id') + '';
            },
            placeholder: { control: '[data-type="product-lists-control"]' },
            renderControl: function (view_) {
                var utils = application.ProductListModule.Utils;
                jQuery(this.placeholder.control).each(function () {
                    var view = view_ || application.getLayout().currentView, is_single_list_mode = utils.isSingleList(), $container = jQuery(this), product_lists_promise = utils.getProductListsPromise();
                    product_lists_promise.done(function () {
                        if (view && view.model && view.model.getPosibleOptions) {
                            var control = null;
                            if (is_single_list_mode) {
                                control = new ProductListControlSingleView({
                                    collection: utils.getProductLists(),
                                    product: view.model,
                                    application: application
                                });
                            } else {
                                view.countedClicks = {};
                                control = new ProductListControlView({
                                    collection: utils.getProductLists(),
                                    product: view.model,
                                    application: application,
                                    isDisabledWishlistButton: !!jQuery(utils.placeholder.control).data('disabledbutton'),
                                    countedClicks: view.countedClicks
                                });
                            }
                            $container.empty().append(control.$el);
                            control.render();
                        }
                    });
                    if (product_lists_promise.state() === 'pending') {
                        $container.empty().append('<button class="product-list-control-button-wishlist">' + (is_single_list_mode ? _('Loading List...').translate() : _('Loading Lists...').translate()) + '</button>');
                    }
                });
            }
        };
    };
});
define('Header.Menu.MyAccount.View', [
    'SC.Configuration',
    'header_menu_myaccount.tpl',
    'Backbone',
    'underscore',
    'jQuery',
    'ProductList.Utils'
], function (Configuration, header_menu_myaccount_tpl, Backbone, _, jQuery, ProductListUtils) {
    'use strict';
    return Backbone.View.extend({
        template: header_menu_myaccount_tpl,
        initialize: function () {
            this.productListModule = ProductListUtils(this.options.application);
            this.isProductListEnabled = this.productListModule.isProductListEnabled();
            if (this.isProductListEnabled) {
                this.productListsPromise = this.productListModule.getProductListsPromise();
                this.product_list_collection = this.productListModule.getProductLists();
                var self = this;
                this.debounced_render = _.debounce(_.bind(this.render, this), 250);
                this.productListsPromise.done(function () {
                    _.each(self.product_list_collection.models, function (list) {
                        list.get('items').on('add remove', function () {
                            self.debounced_render();
                        }, this);
                    }, this);
                    self.debounced_render();
                });
                this.product_list_collection.on('add remove change:name', this.debounced_render);
            } else {
                this.productListsPromise = jQuery.Deferred();
            }
        },
        render: function () {
            this._render();
            if (this.$('.header-menu-myaccount-level3-orders').children().length === 1) {
                this.$('.header-menu-myaccount-level2-orders').remove();
            }
        },
        destroy: function () {
            if (this.product_list_collection) {
                this.product_list_collection.off('add remove', this.debounced_render);
            }
            this._destroy();
        },
        getContext: function () {
            if (this.product_list_collection) {
                this.product_list_collection.each(function (product_list) {
                    var url = 'wishlist/' + (product_list.get('internalid') || 'tmpl_' + product_list.get('templateId'));
                    product_list.set('url', url, { silent: true });
                });
            }
            var isSCISIntegrationEnabled = Configuration.get('siteSettings.isSCISIntegrationEnabled', false);
            return {
                isProductListsEnabled: !!this.isProductListEnabled,
                isSingleList: !!this.productListModule.isSingleList(),
                isCaseModuleEnabled: SC && SC.ENVIRONMENT && SC.ENVIRONMENT.casesManagementEnabled,
                productListsReady: this.productListsPromise.state() === 'resolved',
                productLists: this.product_list_collection || [],
                purchasesPermissions: isSCISIntegrationEnabled ? 'transactions.tranFind.1,transactions.tranPurchases.1' : 'transactions.tranFind.1,transactions.tranSalesOrd.1',
                returnsPermissions: isSCISIntegrationEnabled ? 'transactions.tranFind.1,transactions.tranPurchasesReturns.1' : 'transactions.tranFind.1,transactions.tranRtnAuth.1'
            };
        }
    });
});
define('Header.Profile.View', [
    'Profile.Model',
    'SC.Configuration',
    'Header.Menu.MyAccount.View',
    'header_profile.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore'
], function (ProfileModel, Configuration, HeaderMenuMyAccountView, header_profile_tpl, Backbone, BackboneCompositeView, _) {
    'use strict';
    return Backbone.View.extend({
        template: header_profile_tpl,
        initialize: function () {
            var self = this;
            BackboneCompositeView.add(this);
            ProfileModel.getPromise().done(function () {
                self.render();
            });
            this.on('afterViewRender', function () {
                _.ellipsis('.header-profile-loading-indicator');
            });
        },
        childViews: {
            'Header.Menu.MyAccount': function () {
                return new HeaderMenuMyAccountView(this.options);
            }
        },
        getContext: function () {
            var profile = ProfileModel.getInstance(), is_loading = !_.getPathFromObject(Configuration, 'performance.waitForUserProfile', true) && ProfileModel.getPromise().state() !== 'resolved', is_loged_in = (profile.get('isLoggedIn') === 'T' || profile.get('isRecognized') === 'T') && profile.get('isGuest') === 'F';
            return {
                showExtendedMenu: !is_loading && is_loged_in,
                showLoginMenu: !is_loading && !is_loged_in,
                showLoadingMenu: is_loading,
                showMyAccountMenu: !!this.options.showMyAccountMenu,
                displayName: profile.get('firstname') || profile.get('companyname'),
                showLogin: Configuration.getRegistrationType() !== 'disabled',
                showRegister: Configuration.getRegistrationType() === 'optional' || Configuration.getRegistrationType() === 'required'
            };
        }
    });
});
define('GlobalViews.HostSelector.View', [
    'SC.Configuration',
    'global_views_host_selector.tpl',
    'Backbone',
    'Utils',
    'underscore',
    'jQuery'
], function (Configuration, global_views_host_selector_tpl, Backbone, Utils, _, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_host_selector_tpl,
        events: {
            'change select[data-toggle="host-selector"]': 'selectHost',
            'click select[data-toggle="host-selector"]': 'selectHostClick'
        },
        selectHostClick: function (e) {
            e.stopPropagation();
        },
        selectHost: function (e) {
            if (Configuration.currentTouchpoint === 'home') {
                this.setHost(e);
            } else {
                this.setLang(e);
            }
        },
        setHref: function (url) {
            window.location.href = location.protocol + '//' + url;
        },
        setSearch: function (search) {
            window.location.search = search;
        },
        getCurrentPath: function () {
            return location.pathname;
        },
        setHost: function (e) {
            var host = jQuery(e.target).val(), url;
            if (Backbone.history._hasPushState) {
                url = host;
            } else {
                url = host + this.getCurrentPath();
            }
            url = Utils.addParamsToUrl(url, Utils.getSessionParams(SC.ENVIRONMENT.siteSettings.touchpoints));
            this.setHref(url);
        },
        setLang: function (e) {
            var selected_host = jQuery(e.target).val(), available_hosts = SC.ENVIRONMENT.availableHosts, selected_language;
            for (var i = 0; i < available_hosts.length; i++) {
                var host = available_hosts[i], lang = _(host.languages).findWhere({ host: selected_host });
                if (lang && lang.locale) {
                    selected_language = lang;
                    break;
                }
            }
            if (selected_language && selected_language.locale) {
                var current_search = Utils.parseUrlOptions(window.location.search);
                current_search.lang = selected_language.locale;
                var search = _.reduce(current_search, function (memo, val, name) {
                    return val ? memo + name + '=' + val + '&' : memo;
                }, '?');
                this.setSearch(search);
                return search;
            }
        },
        getContext: function () {
            var is_home_touchpoint = Configuration.currentTouchpoint === 'home';
            var use_parameter = !is_home_touchpoint, current_host = is_home_touchpoint ? SC.ENVIRONMENT.currentHostString : SC.ENVIRONMENT.currentLanguage.locale, available_hosts = _.map(SC.ENVIRONMENT.availableHosts, function (host) {
                    return {
                        hasLanguages: host.languages && host.languages.length,
                        title: host.title,
                        languages: _.map(host.languages, function (language) {
                            return {
                                host: language.host,
                                displayName: language.title || language.name,
                                isSelected: !!(use_parameter && language.locale === current_host || language.host === current_host)
                            };
                        })
                    };
                });
            return {
                showHosts: !!(available_hosts && available_hosts.length > 1),
                availableHosts: available_hosts,
                currentHost: current_host,
                useParameter: use_parameter
            };
        }
    });
});
define('GlobalViews.CurrencySelector.View', [
    'SC.Configuration',
    'Utils',
    'Session',
    'global_views_currency_selector.tpl',
    'Backbone',
    'underscore'
], function (Configuration, Utils, Session, global_views_currency_selector_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_currency_selector_tpl,
        events: {
            'change select[data-toggle="currency-selector"]': 'setCurrency',
            'click select[data-toggle="currency-selector"]': 'currencySelectorClick'
        },
        currencySelectorClick: function (e) {
            e.stopPropagation();
        },
        setCurrency: function (e) {
            var currency_code = this.$(e.target).val(), selected_currency = _.find(SC.ENVIRONMENT.availableCurrencies, function (currency) {
                    return currency.code === currency_code;
                });
            window.location.href = Utils.addParamsToUrl(Session.get('touchpoints.' + Configuration.get('currentTouchpoint')), { cur: selected_currency.code });
        },
        getContext: function () {
            var available_currencies = _.map(SC.ENVIRONMENT.availableCurrencies, function (currency) {
                return {
                    code: currency.code,
                    internalId: currency.internalid,
                    isDefault: currency.isdefault,
                    symbol: currency.symbol,
                    symbolPlacement: currency.symbolplacement,
                    displayName: currency.title || currency.name,
                    isSelected: SC.ENVIRONMENT.currentCurrency.code === currency.code
                };
            });
            return {
                showCurrencySelector: !!(SC.ENVIRONMENT.availableCurrencies && SC.ENVIRONMENT.availableCurrencies.length > 1),
                availableCurrencies: available_currencies || [],
                currentCurrencyCode: SC.ENVIRONMENT.currentCurrency.code,
                currentCurrencySymbol: SC.getSessionInfo('currency').symbol
            };
        }
    });
});
define('jQuery.sidebarMenu', ['jQuery'], function (jQuery) {
    'use strict';
    function Menu(el) {
        var wrapper = el, last_opened_menu = wrapper, root_ul = wrapper.find('.header-sidebar-menu:first'), animating = false, has_animation_support = detectAnimationSupport(), class_names = {
                menuOpened: 'header-sidebar-menu-opened',
                menuPath: 'header-sidebar-menu-path',
                menuTransition: 'header-sidebar-menu-transition',
                animateIn: 'header-sidebar-menu-flyer-in',
                animateOut: 'header-sidebar-menu-flyer-out',
                flyer: 'header-sidebar-menu-flyer'
            }, height_stack = [];
        last_opened_menu.addClass(class_names.menuPath);
        last_opened_menu.addClass(class_names.menuOpened);
        jQuery(root_ul).on('click', '[data-action="push-menu"]', function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (animating === true) {
                return;
            }
            animating = true;
            var anchor = jQuery(this), parent_li = anchor.closest('li'), pushing_menu = anchor.next();
            animate(pushing_menu, class_names.animateIn, function () {
                last_opened_menu.removeClass(class_names.menuOpened);
                last_opened_menu = parent_li;
                parent_li.addClass(class_names.menuPath).addClass(class_names.menuOpened);
            });
        });
        jQuery(root_ul).on('click', '[data-action="pop-menu"]', function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (animating === true) {
                return;
            }
            animating = true;
            var anchor = jQuery(this), anchor_menu = anchor.closest('ul'), opened_li = anchor.closest('.' + class_names.menuOpened);
            opened_li.removeClass(class_names.menuPath).removeClass(class_names.menuOpened);
            last_opened_menu = opened_li.closest('.' + class_names.menuPath);
            last_opened_menu.addClass(class_names.menuOpened);
            animate(anchor_menu, class_names.animateOut);
        });
        var flyer_className = '.' + class_names.flyer;
        jQuery(wrapper).on('animationend MSAnimationEnd oAnimationEnd webkitAnimationEnd', flyer_className, function () {
            var cb = jQuery(this).data('callback');
            if (cb) {
                cb();
            }
            jQuery(this).remove();
            animating = false;
            root_ul.addClass(class_names.menuTransition);
        });
        function animate(sub_menu, animation_class, cb) {
            var flyer_menu = sub_menu.clone(false);
            flyer_menu.removeClass().addClass(class_names.flyer).insertAfter(root_ul).addClass(animation_class);
            if (animation_class === class_names.animateIn) {
                height_stack.push(root_ul.height());
                root_ul.css('height', flyer_menu.height());
            } else {
                root_ul.css('height', height_stack.pop());
            }
            flyer_menu.data('callback', cb);
            if (!has_animation_support) {
                if (cb) {
                    cb();
                }
                flyer_menu.remove();
                animating = false;
                root_ul.addClass(class_names.menuTransition);
            }
        }
    }
    function detectAnimationSupport() {
        var domPrefixes = 'Webkit Moz O ms Khtml'.split(' '), elm = document.createElement('div');
        if (elm.style.animationName !== undefined) {
            return true;
        }
        for (var i = 0; i < domPrefixes.length; i++) {
            if (elm.style[domPrefixes[i] + 'AnimationName'] !== undefined) {
                return true;
            }
        }
        return false;
    }
    jQuery.fn.sidebarMenu = function () {
        return this.each(function () {
            Menu(jQuery(this));
        });
    };
    return jQuery.fn.sidebarMenu;
});
define('Header.Menu.View', [
    'Profile.Model',
    'SC.Configuration',
    'Header.Profile.View',
    'Header.Menu.MyAccount.View',
    'GlobalViews.HostSelector.View',
    'GlobalViews.CurrencySelector.View',
    'header_menu.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore',
    'jQuery',
    'jQuery.sidebarMenu'
], function (ProfileModel, Configuration, HeaderProfileView, HeaderMenuMyAccountView, GlobalViewsHostSelectorView, GlobalViewsCurrencySelectorView, header_menu, Backbone, BackboneCompositeView, _, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: header_menu,
        events: {
            'mouseenter [data-toggle="categories-menu"]': 'menuOpen',
            'mouseleave [data-toggle="categories-menu"]': 'menuClose',
            'click [data-toggle="categories-menu"]': 'menuClose'
        },
        menuOpen: function (e) {
            jQuery(e.currentTarget).addClass('open');
        },
        menuClose: function (e) {
            jQuery(e.currentTarget).removeClass('open');
        },
        initialize: function () {
            var self = this;
            BackboneCompositeView.add(this);
            this.options.application.on('Configuration.navigationData', this.render, this);
            ProfileModel.getPromise().done(function () {
                self.render();
            });
        },
        childViews: {
            'Header.Profile': function () {
                return new HeaderProfileView({
                    showMyAccountMenu: false,
                    application: this.options.application
                });
            },
            'Header.Menu.MyAccount': function () {
                return new HeaderMenuMyAccountView(this.options);
            },
            'Global.HostSelector': function () {
                return new GlobalViewsHostSelectorView();
            },
            'Global.CurrencySelector': function () {
                return new GlobalViewsCurrencySelectorView();
            }
        },
        render: function () {
            Backbone.View.prototype.render.apply(this, arguments);
            this.$('[data-type="header-sidebar-menu"]').sidebarMenu();
        },
        getContext: function () {
            var profile = ProfileModel.getInstance(), is_loading = !Configuration.get('performance.waitForUserProfile', true) && ProfileModel.getPromise().state() !== 'resolved', is_loged_in = profile.get('isLoggedIn') === 'T' && profile.get('isGuest') === 'F', environment = SC.ENVIRONMENT, show_languages = environment.availableHosts && environment.availableHosts.length > 1, show_currencies = environment.availableCurrencies && environment.availableCurrencies.length > 1 && !Configuration.get('header.notShowCurrencySelector');
            _.each(Configuration.navigationData, function (entry) {
                if (entry.dataTouchpoint !== undefined) {
                    entry.data = entry.data || {};
                    entry.data.touchpoint = entry.dataTouchpoint;
                }
                if (entry.dataHashtag !== undefined) {
                    entry.data = entry.data || {};
                    entry.data.hashtag = entry.dataHashtag;
                }
            });
            return {
                categories: Configuration.navigationData || [],
                showExtendedMenu: !is_loading && is_loged_in,
                showLanguages: show_languages,
                showCurrencies: show_currencies
            };
        }
    });
});
define('ItemsSearcher.Utils', [
    'SC.Configuration',
    'underscore'
], function (Configuration, _) {
    'use strict';
    return {
        formatKeywords: function (keywords) {
            var keywordFormatter = _.getPathFromObject(Configuration, 'searchPrefs.keywordsFormatter');
            if (keywordFormatter && _.isFunction(keywordFormatter)) {
                keywords = keywordFormatter(keywords);
                var maxLength = _.getPathFromObject(Configuration, 'searchPrefs.maxLength', 99999);
                if (keywords.length > maxLength) {
                    keywords = keywords.substring(0, maxLength);
                }
            }
            return keywords;
        }
    };
});
define('Backbone.CachedCollection', [
    'Backbone.CachedSync',
    'Backbone'
], function (BackboneCachedSync, Backbone) {
    'use strict';
    Backbone.CachedCollection = Backbone.Collection.extend({
        sync: BackboneCachedSync.cachedSync,
        addToCache: BackboneCachedSync.addToCache,
        isCached: BackboneCachedSync.isCached
    });
    return Backbone.CachedCollection;
});
define('Item.Collection', [
    'Backbone.CachedCollection',
    'Item.Model',
    'Session',
    'Profile.Model',
    'underscore',
    'Utils'
], function (BackboneCachedCollection, ItemModel, Session, ProfileModel, _) {
    'use strict';
    return BackboneCachedCollection.extend({
        url: function () {
            var profile = ProfileModel.getInstance(), url = _.addParamsToUrl(profile.getSearchApiUrl(), _.extend({}, this.searchApiMasterOptions, Session.getSearchApiParams()), profile.isAvoidingDoubleRedirect());
            return url;
        },
        model: ItemModel,
        parse: function (response) {
            return _.compact(response.items) || null;
        }
    });
});
define('typeahead', ['jQuery'], function () {
    (function ($) {
        var _ = function () {
            'use strict';
            return {
                isMsie: function () {
                    return /(msie|trident)/i.test(navigator.userAgent) ? navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2] : false;
                },
                isBlankString: function (str) {
                    return !str || /^\s*$/.test(str);
                },
                escapeRegExChars: function (str) {
                    return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, '\\$&');
                },
                isString: function (obj) {
                    return typeof obj === 'string';
                },
                isNumber: function (obj) {
                    return typeof obj === 'number';
                },
                isArray: $.isArray,
                isFunction: $.isFunction,
                isObject: $.isPlainObject,
                isUndefined: function (obj) {
                    return typeof obj === 'undefined';
                },
                toStr: function toStr(s) {
                    return _.isUndefined(s) || s === null ? '' : s + '';
                },
                bind: $.proxy,
                each: function (collection, cb) {
                    $.each(collection, reverseArgs);
                    function reverseArgs(index, value) {
                        return cb(value, index);
                    }
                },
                map: $.map,
                filter: $.grep,
                every: function (obj, test) {
                    var result = true;
                    if (!obj) {
                        return result;
                    }
                    $.each(obj, function (key, val) {
                        if (!(result = test.call(null, val, key, obj))) {
                            return false;
                        }
                    });
                    return !!result;
                },
                some: function (obj, test) {
                    var result = false;
                    if (!obj) {
                        return result;
                    }
                    $.each(obj, function (key, val) {
                        if (result = test.call(null, val, key, obj)) {
                            return false;
                        }
                    });
                    return !!result;
                },
                mixin: $.extend,
                getUniqueId: function () {
                    var counter = 0;
                    return function () {
                        return counter++;
                    };
                }(),
                templatify: function templatify(obj) {
                    return $.isFunction(obj) ? obj : template;
                    function template() {
                        return String(obj);
                    }
                },
                defer: function (fn) {
                    setTimeout(fn, 0);
                },
                debounce: function (func, wait, immediate) {
                    var timeout, result;
                    return function () {
                        var context = this, args = arguments, later, callNow;
                        later = function () {
                            timeout = null;
                            if (!immediate) {
                                result = func.apply(context, args);
                            }
                        };
                        callNow = immediate && !timeout;
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                        if (callNow) {
                            result = func.apply(context, args);
                        }
                        return result;
                    };
                },
                throttle: function (func, wait) {
                    var context, args, timeout, result, previous, later;
                    previous = 0;
                    later = function () {
                        previous = new Date();
                        timeout = null;
                        result = func.apply(context, args);
                    };
                    return function () {
                        var now = new Date(), remaining = wait - (now - previous);
                        context = this;
                        args = arguments;
                        if (remaining <= 0) {
                            clearTimeout(timeout);
                            timeout = null;
                            previous = now;
                            result = func.apply(context, args);
                        } else if (!timeout) {
                            timeout = setTimeout(later, remaining);
                        }
                        return result;
                    };
                },
                noop: function () {
                }
            };
        }();
        var VERSION = '0.10.5';
        var tokenizers = function () {
            'use strict';
            return {
                nonword: nonword,
                whitespace: whitespace,
                obj: {
                    nonword: getObjTokenizer(nonword),
                    whitespace: getObjTokenizer(whitespace)
                }
            };
            function whitespace(str) {
                str = _.toStr(str);
                return str ? str.split(/\s+/) : [];
            }
            function nonword(str) {
                str = _.toStr(str);
                return str ? str.split(/\W+/) : [];
            }
            function getObjTokenizer(tokenizer) {
                return function setKey() {
                    var args = [].slice.call(arguments, 0);
                    return function tokenize(o) {
                        var tokens = [];
                        _.each(args, function (k) {
                            tokens = tokens.concat(tokenizer(_.toStr(o[k])));
                        });
                        return tokens;
                    };
                };
            }
        }();
        var LruCache = function () {
            'use strict';
            function LruCache(maxSize) {
                this.maxSize = _.isNumber(maxSize) ? maxSize : 100;
                this.reset();
                if (this.maxSize <= 0) {
                    this.set = this.get = $.noop;
                }
            }
            _.mixin(LruCache.prototype, {
                set: function set(key, val) {
                    var tailItem = this.list.tail, node;
                    if (this.size >= this.maxSize) {
                        this.list.remove(tailItem);
                        delete this.hash[tailItem.key];
                    }
                    if (node = this.hash[key]) {
                        node.val = val;
                        this.list.moveToFront(node);
                    } else {
                        node = new Node(key, val);
                        this.list.add(node);
                        this.hash[key] = node;
                        this.size++;
                    }
                },
                get: function get(key) {
                    var node = this.hash[key];
                    if (node) {
                        this.list.moveToFront(node);
                        return node.val;
                    }
                },
                reset: function reset() {
                    this.size = 0;
                    this.hash = {};
                    this.list = new List();
                }
            });
            function List() {
                this.head = this.tail = null;
            }
            _.mixin(List.prototype, {
                add: function add(node) {
                    if (this.head) {
                        node.next = this.head;
                        this.head.prev = node;
                    }
                    this.head = node;
                    this.tail = this.tail || node;
                },
                remove: function remove(node) {
                    node.prev ? node.prev.next = node.next : this.head = node.next;
                    node.next ? node.next.prev = node.prev : this.tail = node.prev;
                },
                moveToFront: function (node) {
                    this.remove(node);
                    this.add(node);
                }
            });
            function Node(key, val) {
                this.key = key;
                this.val = val;
                this.prev = this.next = null;
            }
            return LruCache;
        }();
        var PersistentStorage = function () {
            'use strict';
            var ls, methods;
            try {
                ls = window.localStorage;
                ls.setItem('~~~', '!');
                ls.removeItem('~~~');
            } catch (err) {
                ls = null;
            }
            function PersistentStorage(namespace) {
                this.prefix = [
                    '__',
                    namespace,
                    '__'
                ].join('');
                this.ttlKey = '__ttl__';
                this.keyMatcher = new RegExp('^' + _.escapeRegExChars(this.prefix));
            }
            if (ls && window.JSON) {
                methods = {
                    _prefix: function (key) {
                        return this.prefix + key;
                    },
                    _ttlKey: function (key) {
                        return this._prefix(key) + this.ttlKey;
                    },
                    get: function (key) {
                        if (this.isExpired(key)) {
                            this.remove(key);
                        }
                        return decode(ls.getItem(this._prefix(key)));
                    },
                    set: function (key, val, ttl) {
                        if (_.isNumber(ttl)) {
                            ls.setItem(this._ttlKey(key), encode(now() + ttl));
                        } else {
                            ls.removeItem(this._ttlKey(key));
                        }
                        return ls.setItem(this._prefix(key), encode(val));
                    },
                    remove: function (key) {
                        ls.removeItem(this._ttlKey(key));
                        ls.removeItem(this._prefix(key));
                        return this;
                    },
                    clear: function () {
                        var i, key, keys = [], len = ls.length;
                        for (i = 0; i < len; i++) {
                            if ((key = ls.key(i)).match(this.keyMatcher)) {
                                keys.push(key.replace(this.keyMatcher, ''));
                            }
                        }
                        for (i = keys.length; i--;) {
                            this.remove(keys[i]);
                        }
                        return this;
                    },
                    isExpired: function (key) {
                        var ttl = decode(ls.getItem(this._ttlKey(key)));
                        return _.isNumber(ttl) && now() > ttl ? true : false;
                    }
                };
            } else {
                methods = {
                    get: _.noop,
                    set: _.noop,
                    remove: _.noop,
                    clear: _.noop,
                    isExpired: _.noop
                };
            }
            _.mixin(PersistentStorage.prototype, methods);
            return PersistentStorage;
            function now() {
                return new Date().getTime();
            }
            function encode(val) {
                return JSON.stringify(_.isUndefined(val) ? null : val);
            }
            function decode(val) {
                return JSON.parse(val);
            }
        }();
        var Transport = function () {
            'use strict';
            var pendingRequestsCount = 0, pendingRequests = {}, maxPendingRequests = 6, sharedCache = new LruCache(10);
            function Transport(o) {
                o = o || {};
                this.cancelled = false;
                this.lastUrl = null;
                this._send = o.transport ? callbackToDeferred(o.transport) : $.ajax;
                this._get = o.rateLimiter ? o.rateLimiter(this._get) : this._get;
                this._cache = o.cache === false ? new LruCache(0) : sharedCache;
            }
            Transport.setMaxPendingRequests = function setMaxPendingRequests(num) {
                maxPendingRequests = num;
            };
            Transport.resetCache = function resetCache() {
                sharedCache.reset();
            };
            _.mixin(Transport.prototype, {
                _get: function (url, o, cb) {
                    var that = this, jqXhr;
                    if (this.cancelled || url !== this.lastUrl) {
                        return;
                    }
                    if (jqXhr = pendingRequests[url]) {
                        jqXhr.done(done).fail(fail);
                    } else if (pendingRequestsCount < maxPendingRequests) {
                        pendingRequestsCount++;
                        pendingRequests[url] = this._send(url, o).done(done).fail(fail).always(always);
                    } else {
                        this.onDeckRequestArgs = [].slice.call(arguments, 0);
                    }
                    function done(resp) {
                        cb && cb(null, resp);
                        that._cache.set(url, resp);
                    }
                    function fail() {
                        cb && cb(true);
                    }
                    function always() {
                        pendingRequestsCount--;
                        delete pendingRequests[url];
                        if (that.onDeckRequestArgs) {
                            that._get.apply(that, that.onDeckRequestArgs);
                            that.onDeckRequestArgs = null;
                        }
                    }
                },
                get: function (url, o, cb) {
                    var resp;
                    if (_.isFunction(o)) {
                        cb = o;
                        o = {};
                    }
                    this.cancelled = false;
                    this.lastUrl = url;
                    if (resp = this._cache.get(url)) {
                        _.defer(function () {
                            cb && cb(null, resp);
                        });
                    } else {
                        this._get(url, o, cb);
                    }
                    return !!resp;
                },
                cancel: function () {
                    this.cancelled = true;
                }
            });
            return Transport;
            function callbackToDeferred(fn) {
                return function customSendWrapper(url, o) {
                    var deferred = $.Deferred();
                    fn(url, o, onSuccess, onError);
                    return deferred;
                    function onSuccess(resp) {
                        _.defer(function () {
                            deferred.resolve(resp);
                        });
                    }
                    function onError(err) {
                        _.defer(function () {
                            deferred.reject(err);
                        });
                    }
                };
            }
        }();
        var SearchIndex = function () {
            'use strict';
            function SearchIndex(o) {
                o = o || {};
                if (!o.datumTokenizer || !o.queryTokenizer) {
                    $.error('datumTokenizer and queryTokenizer are both required');
                }
                this.datumTokenizer = o.datumTokenizer;
                this.queryTokenizer = o.queryTokenizer;
                this.reset();
            }
            _.mixin(SearchIndex.prototype, {
                bootstrap: function bootstrap(o) {
                    this.datums = o.datums;
                    this.trie = o.trie;
                },
                add: function (data) {
                    var that = this;
                    data = _.isArray(data) ? data : [data];
                    _.each(data, function (datum) {
                        var id, tokens;
                        id = that.datums.push(datum) - 1;
                        tokens = normalizeTokens(that.datumTokenizer(datum));
                        _.each(tokens, function (token) {
                            var node, chars, ch;
                            node = that.trie;
                            chars = token.split('');
                            while (ch = chars.shift()) {
                                node = node.children[ch] || (node.children[ch] = newNode());
                                node.ids.push(id);
                            }
                        });
                    });
                },
                get: function get(query) {
                    var that = this, tokens, matches;
                    tokens = normalizeTokens(this.queryTokenizer(query));
                    _.each(tokens, function (token) {
                        var node, chars, ch, ids;
                        if (matches && matches.length === 0) {
                            return false;
                        }
                        node = that.trie;
                        chars = token.split('');
                        while (node && (ch = chars.shift())) {
                            node = node.children[ch];
                        }
                        if (node && chars.length === 0) {
                            ids = node.ids.slice(0);
                            matches = matches ? getIntersection(matches, ids) : ids;
                        } else {
                            matches = [];
                            return false;
                        }
                    });
                    return matches ? _.map(unique(matches), function (id) {
                        return that.datums[id];
                    }) : [];
                },
                reset: function reset() {
                    this.datums = [];
                    this.trie = newNode();
                },
                serialize: function serialize() {
                    return {
                        datums: this.datums,
                        trie: this.trie
                    };
                }
            });
            return SearchIndex;
            function normalizeTokens(tokens) {
                tokens = _.filter(tokens, function (token) {
                    return !!token;
                });
                tokens = _.map(tokens, function (token) {
                    return token.toLowerCase();
                });
                return tokens;
            }
            function newNode() {
                return {
                    ids: [],
                    children: {}
                };
            }
            function unique(array) {
                var seen = {}, uniques = [];
                for (var i = 0, len = array.length; i < len; i++) {
                    if (!seen[array[i]]) {
                        seen[array[i]] = true;
                        uniques.push(array[i]);
                    }
                }
                return uniques;
            }
            function getIntersection(arrayA, arrayB) {
                var ai = 0, bi = 0, intersection = [];
                arrayA = arrayA.sort(compare);
                arrayB = arrayB.sort(compare);
                var lenArrayA = arrayA.length, lenArrayB = arrayB.length;
                while (ai < lenArrayA && bi < lenArrayB) {
                    if (arrayA[ai] < arrayB[bi]) {
                        ai++;
                    } else if (arrayA[ai] > arrayB[bi]) {
                        bi++;
                    } else {
                        intersection.push(arrayA[ai]);
                        ai++;
                        bi++;
                    }
                }
                return intersection;
                function compare(a, b) {
                    return a - b;
                }
            }
        }();
        var oParser = function () {
            'use strict';
            return {
                local: getLocal,
                prefetch: getPrefetch,
                remote: getRemote
            };
            function getLocal(o) {
                return o.local || null;
            }
            function getPrefetch(o) {
                var prefetch, defaults;
                defaults = {
                    url: null,
                    thumbprint: '',
                    ttl: 24 * 60 * 60 * 1000,
                    filter: null,
                    ajax: {}
                };
                if (prefetch = o.prefetch || null) {
                    prefetch = _.isString(prefetch) ? { url: prefetch } : prefetch;
                    prefetch = _.mixin(defaults, prefetch);
                    prefetch.thumbprint = VERSION + prefetch.thumbprint;
                    prefetch.ajax.type = prefetch.ajax.type || 'GET';
                    prefetch.ajax.dataType = prefetch.ajax.dataType || 'json';
                    !prefetch.url && $.error('prefetch requires url to be set');
                }
                return prefetch;
            }
            function getRemote(o) {
                var remote, defaults;
                defaults = {
                    url: null,
                    cache: true,
                    wildcard: '%QUERY',
                    replace: null,
                    rateLimitBy: 'debounce',
                    rateLimitWait: 300,
                    send: null,
                    filter: null,
                    ajax: {}
                };
                if (remote = o.remote || null) {
                    remote = _.isString(remote) ? { url: remote } : remote;
                    remote = _.mixin(defaults, remote);
                    remote.rateLimiter = /^throttle$/i.test(remote.rateLimitBy) ? byThrottle(remote.rateLimitWait) : byDebounce(remote.rateLimitWait);
                    remote.ajax.type = remote.ajax.type || 'GET';
                    remote.ajax.dataType = remote.ajax.dataType || 'json';
                    delete remote.rateLimitBy;
                    delete remote.rateLimitWait;
                    !remote.url && $.error('remote requires url to be set');
                }
                return remote;
                function byDebounce(wait) {
                    return function (fn) {
                        return _.debounce(fn, wait);
                    };
                }
                function byThrottle(wait) {
                    return function (fn) {
                        return _.throttle(fn, wait);
                    };
                }
            }
        }();
        (function (root) {
            'use strict';
            var old, keys;
            old = root.Bloodhound;
            keys = {
                data: 'data',
                protocol: 'protocol',
                thumbprint: 'thumbprint'
            };
            root.Bloodhound = Bloodhound;
            function Bloodhound(o) {
                if (!o || !o.local && !o.prefetch && !o.remote) {
                    $.error('one of local, prefetch, or remote is required');
                }
                this.limit = o.limit || 5;
                this.sorter = getSorter(o.sorter);
                this.dupDetector = o.dupDetector || ignoreDuplicates;
                this.local = oParser.local(o);
                this.prefetch = oParser.prefetch(o);
                this.remote = oParser.remote(o);
                this.cacheKey = this.prefetch ? this.prefetch.cacheKey || this.prefetch.url : null;
                this.index = new SearchIndex({
                    datumTokenizer: o.datumTokenizer,
                    queryTokenizer: o.queryTokenizer
                });
                this.storage = this.cacheKey ? new PersistentStorage(this.cacheKey) : null;
            }
            Bloodhound.noConflict = function noConflict() {
                root.Bloodhound = old;
                return Bloodhound;
            };
            Bloodhound.tokenizers = tokenizers;
            _.mixin(Bloodhound.prototype, {
                _loadPrefetch: function loadPrefetch(o) {
                    var that = this, serialized, deferred;
                    if (serialized = this._readFromStorage(o.thumbprint)) {
                        this.index.bootstrap(serialized);
                        deferred = $.Deferred().resolve();
                    } else {
                        deferred = $.ajax(o.url, o.ajax).done(handlePrefetchResponse);
                    }
                    return deferred;
                    function handlePrefetchResponse(resp) {
                        that.clear();
                        that.add(o.filter ? o.filter(resp) : resp);
                        that._saveToStorage(that.index.serialize(), o.thumbprint, o.ttl);
                    }
                },
                _getFromRemote: function getFromRemote(query, cb) {
                    var that = this, url, uriEncodedQuery;
                    if (!this.transport) {
                        return;
                    }
                    query = query || '';
                    uriEncodedQuery = encodeURIComponent(query);
                    url = this.remote.replace ? this.remote.replace(this.remote.url, query) : this.remote.url.replace(this.remote.wildcard, uriEncodedQuery);
                    return this.transport.get(url, this.remote.ajax, handleRemoteResponse);
                    function handleRemoteResponse(err, resp) {
                        err ? cb([]) : cb(that.remote.filter ? that.remote.filter(resp) : resp);
                    }
                },
                _cancelLastRemoteRequest: function cancelLastRemoteRequest() {
                    this.transport && this.transport.cancel();
                },
                _saveToStorage: function saveToStorage(data, thumbprint, ttl) {
                    if (this.storage) {
                        this.storage.set(keys.data, data, ttl);
                        this.storage.set(keys.protocol, location.protocol, ttl);
                        this.storage.set(keys.thumbprint, thumbprint, ttl);
                    }
                },
                _readFromStorage: function readFromStorage(thumbprint) {
                    var stored = {}, isExpired;
                    if (this.storage) {
                        stored.data = this.storage.get(keys.data);
                        stored.protocol = this.storage.get(keys.protocol);
                        stored.thumbprint = this.storage.get(keys.thumbprint);
                    }
                    isExpired = stored.thumbprint !== thumbprint || stored.protocol !== location.protocol;
                    return stored.data && !isExpired ? stored.data : null;
                },
                _initialize: function initialize() {
                    var that = this, local = this.local, deferred;
                    deferred = this.prefetch ? this._loadPrefetch(this.prefetch) : $.Deferred().resolve();
                    local && deferred.done(addLocalToIndex);
                    this.transport = this.remote ? new Transport(this.remote) : null;
                    return this.initPromise = deferred.promise();
                    function addLocalToIndex() {
                        that.add(_.isFunction(local) ? local() : local);
                    }
                },
                initialize: function initialize(force) {
                    return !this.initPromise || force ? this._initialize() : this.initPromise;
                },
                add: function add(data) {
                    this.index.add(data);
                },
                get: function get(query, cb) {
                    var that = this, matches = [], cacheHit = false;
                    matches = this.index.get(query);
                    matches = this.sorter(matches).slice(0, this.limit);
                    matches.length < this.limit ? cacheHit = this._getFromRemote(query, returnRemoteMatches) : this._cancelLastRemoteRequest();
                    if (!cacheHit) {
                        (matches.length > 0 || !this.transport) && cb && cb(matches);
                    }
                    function returnRemoteMatches(remoteMatches) {
                        var matchesWithBackfill = matches.slice(0);
                        _.each(remoteMatches, function (remoteMatch) {
                            var isDuplicate;
                            isDuplicate = _.some(matchesWithBackfill, function (match) {
                                return that.dupDetector(remoteMatch, match);
                            });
                            !isDuplicate && matchesWithBackfill.push(remoteMatch);
                            return matchesWithBackfill.length < that.limit;
                        });
                        cb && cb(that.sorter(matchesWithBackfill));
                    }
                },
                clear: function clear() {
                    this.index.reset();
                },
                clearPrefetchCache: function clearPrefetchCache() {
                    this.storage && this.storage.clear();
                },
                clearRemoteCache: function clearRemoteCache() {
                    this.transport && Transport.resetCache();
                },
                ttAdapter: function ttAdapter() {
                    return _.bind(this.get, this);
                }
            });
            return Bloodhound;
            function getSorter(sortFn) {
                return _.isFunction(sortFn) ? sort : noSort;
                function sort(array) {
                    return array.sort(sortFn);
                }
                function noSort(array) {
                    return array;
                }
            }
            function ignoreDuplicates() {
                return false;
            }
        }(this));
        var html = function () {
            return {
                wrapper: '<span class="twitter-typeahead"></span>',
                dropdown: '<span class="tt-dropdown-menu"></span>',
                dataset: '<div class="tt-dataset-%CLASS%"></div>',
                suggestions: '<span class="tt-suggestions"></span>',
                suggestion: '<div class="tt-suggestion"></div>'
            };
        }();
        var css = function () {
            'use strict';
            var css = {
                wrapper: {
                    position: 'relative',
                    display: 'inline-block'
                },
                hint: {
                    position: 'absolute',
                    top: '0',
                    left: '0',
                    borderColor: 'transparent',
                    boxShadow: 'none',
                    opacity: '1'
                },
                input: {
                    position: 'relative',
                    verticalAlign: 'top',
                    backgroundColor: 'transparent'
                },
                inputWithNoHint: {
                    position: 'relative',
                    verticalAlign: 'top'
                },
                dropdown: {
                    position: 'absolute',
                    top: '100%',
                    left: '0',
                    zIndex: '100',
                    display: 'none'
                },
                suggestions: { display: 'block' },
                suggestion: {
                    whiteSpace: 'nowrap',
                    cursor: 'pointer'
                },
                suggestionChild: { whiteSpace: 'normal' },
                ltr: {
                    left: '0',
                    right: 'auto'
                },
                rtl: {
                    left: 'auto',
                    right: ' 0'
                }
            };
            if (_.isMsie()) {
                _.mixin(css.input, { backgroundImage: 'url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)' });
            }
            if (_.isMsie() && _.isMsie() <= 7) {
                _.mixin(css.input, { marginTop: '-1px' });
            }
            return css;
        }();
        var EventBus = function () {
            'use strict';
            var namespace = 'typeahead:';
            function EventBus(o) {
                if (!o || !o.el) {
                    $.error('EventBus initialized without el');
                }
                this.$el = $(o.el);
            }
            _.mixin(EventBus.prototype, {
                trigger: function (type) {
                    var args = [].slice.call(arguments, 1);
                    this.$el.trigger(namespace + type, args);
                }
            });
            return EventBus;
        }();
        var EventEmitter = function () {
            'use strict';
            var splitter = /\s+/, nextTick = getNextTick();
            return {
                onSync: onSync,
                onAsync: onAsync,
                off: off,
                trigger: trigger
            };
            function on(method, types, cb, context) {
                var type;
                if (!cb) {
                    return this;
                }
                types = types.split(splitter);
                cb = context ? bindContext(cb, context) : cb;
                this._callbacks = this._callbacks || {};
                while (type = types.shift()) {
                    this._callbacks[type] = this._callbacks[type] || {
                        sync: [],
                        async: []
                    };
                    this._callbacks[type][method].push(cb);
                }
                return this;
            }
            function onAsync(types, cb, context) {
                return on.call(this, 'async', types, cb, context);
            }
            function onSync(types, cb, context) {
                return on.call(this, 'sync', types, cb, context);
            }
            function off(types) {
                var type;
                if (!this._callbacks) {
                    return this;
                }
                types = types.split(splitter);
                while (type = types.shift()) {
                    delete this._callbacks[type];
                }
                return this;
            }
            function trigger(types) {
                var type, callbacks, args, syncFlush, asyncFlush;
                if (!this._callbacks) {
                    return this;
                }
                types = types.split(splitter);
                args = [].slice.call(arguments, 1);
                while ((type = types.shift()) && (callbacks = this._callbacks[type])) {
                    syncFlush = getFlush(callbacks.sync, this, [type].concat(args));
                    asyncFlush = getFlush(callbacks.async, this, [type].concat(args));
                    syncFlush() && nextTick(asyncFlush);
                }
                return this;
            }
            function getFlush(callbacks, context, args) {
                return flush;
                function flush() {
                    var cancelled;
                    for (var i = 0, len = callbacks.length; !cancelled && i < len; i += 1) {
                        cancelled = callbacks[i].apply(context, args) === false;
                    }
                    return !cancelled;
                }
            }
            function getNextTick() {
                var nextTickFn;
                if (window.setImmediate) {
                    nextTickFn = function nextTickSetImmediate(fn) {
                        setImmediate(function () {
                            fn();
                        });
                    };
                } else {
                    nextTickFn = function nextTickSetTimeout(fn) {
                        setTimeout(function () {
                            fn();
                        }, 0);
                    };
                }
                return nextTickFn;
            }
            function bindContext(fn, context) {
                return fn.bind ? fn.bind(context) : function () {
                    fn.apply(context, [].slice.call(arguments, 0));
                };
            }
        }();
        var highlight = function (doc) {
            'use strict';
            var defaults = {
                node: null,
                pattern: null,
                tagName: 'strong',
                className: null,
                wordsOnly: false,
                caseSensitive: false
            };
            return function hightlight(o) {
                var regex;
                o = _.mixin({}, defaults, o);
                if (!o.node || !o.pattern) {
                    return;
                }
                o.pattern = _.isArray(o.pattern) ? o.pattern : [o.pattern];
                regex = getRegex(o.pattern, o.caseSensitive, o.wordsOnly);
                traverse(o.node, hightlightTextNode);
                function hightlightTextNode(textNode) {
                    var match, patternNode, wrapperNode;
                    if (match = regex.exec(textNode.data)) {
                        wrapperNode = doc.createElement(o.tagName);
                        o.className && (wrapperNode.className = o.className);
                        patternNode = textNode.splitText(match.index);
                        patternNode.splitText(match[0].length);
                        wrapperNode.appendChild(patternNode.cloneNode(true));
                        textNode.parentNode.replaceChild(wrapperNode, patternNode);
                    }
                    return !!match;
                }
                function traverse(el, hightlightTextNode) {
                    var childNode, TEXT_NODE_TYPE = 3;
                    for (var i = 0; i < el.childNodes.length; i++) {
                        childNode = el.childNodes[i];
                        if (childNode.nodeType === TEXT_NODE_TYPE) {
                            i += hightlightTextNode(childNode) ? 1 : 0;
                        } else {
                            traverse(childNode, hightlightTextNode);
                        }
                    }
                }
            };
            function getRegex(patterns, caseSensitive, wordsOnly) {
                var escapedPatterns = [], regexStr;
                for (var i = 0, len = patterns.length; i < len; i++) {
                    escapedPatterns.push(_.escapeRegExChars(patterns[i]));
                }
                regexStr = wordsOnly ? '\\b(' + escapedPatterns.join('|') + ')\\b' : '(' + escapedPatterns.join('|') + ')';
                return caseSensitive ? new RegExp(regexStr) : new RegExp(regexStr, 'i');
            }
        }(window.document);
        var Input = function () {
            'use strict';
            var specialKeyCodeMap;
            specialKeyCodeMap = {
                9: 'tab',
                27: 'esc',
                37: 'left',
                39: 'right',
                13: 'enter',
                38: 'up',
                40: 'down'
            };
            function Input(o) {
                var that = this, onBlur, onFocus, onKeydown, onInput;
                o = o || {};
                if (!o.input) {
                    $.error('input is missing');
                }
                onBlur = _.bind(this._onBlur, this);
                onFocus = _.bind(this._onFocus, this);
                onKeydown = _.bind(this._onKeydown, this);
                onInput = _.bind(this._onInput, this);
                this.$hint = $(o.hint);
                this.$input = $(o.input).on('blur.tt', onBlur).on('focus.tt', onFocus).on('keydown.tt', onKeydown);
                if (this.$hint.length === 0) {
                    this.setHint = this.getHint = this.clearHint = this.clearHintIfInvalid = _.noop;
                }
                if (!_.isMsie()) {
                    this.$input.on('input.tt', onInput);
                } else {
                    this.$input.on('keydown.tt keypress.tt cut.tt paste.tt', function ($e) {
                        if (specialKeyCodeMap[$e.which || $e.keyCode]) {
                            return;
                        }
                        _.defer(_.bind(that._onInput, that, $e));
                    });
                }
                this.query = this.$input.val();
                this.$overflowHelper = buildOverflowHelper(this.$input);
            }
            Input.normalizeQuery = function (str) {
                return (str || '').replace(/^\s*/g, '').replace(/\s{2,}/g, ' ');
            };
            _.mixin(Input.prototype, EventEmitter, {
                _onBlur: function onBlur() {
                    this.resetInputValue();
                    this.trigger('blurred');
                },
                _onFocus: function onFocus() {
                    this.trigger('focused');
                },
                _onKeydown: function onKeydown($e) {
                    var keyName = specialKeyCodeMap[$e.which || $e.keyCode];
                    this._managePreventDefault(keyName, $e);
                    if (keyName && this._shouldTrigger(keyName, $e)) {
                        this.trigger(keyName + 'Keyed', $e);
                    }
                },
                _onInput: function onInput() {
                    this._checkInputValue();
                },
                _managePreventDefault: function managePreventDefault(keyName, $e) {
                    var preventDefault, hintValue, inputValue;
                    switch (keyName) {
                    case 'tab':
                        hintValue = this.getHint();
                        inputValue = this.getInputValue();
                        preventDefault = hintValue && hintValue !== inputValue && !withModifier($e);
                        break;
                    case 'up':
                    case 'down':
                        preventDefault = !withModifier($e);
                        break;
                    default:
                        preventDefault = false;
                    }
                    preventDefault && $e.preventDefault();
                },
                _shouldTrigger: function shouldTrigger(keyName, $e) {
                    var trigger;
                    switch (keyName) {
                    case 'tab':
                        trigger = !withModifier($e);
                        break;
                    default:
                        trigger = true;
                    }
                    return trigger;
                },
                _checkInputValue: function checkInputValue() {
                    var inputValue, areEquivalent, hasDifferentWhitespace;
                    inputValue = this.getInputValue();
                    areEquivalent = areQueriesEquivalent(inputValue, this.query);
                    hasDifferentWhitespace = areEquivalent ? this.query.length !== inputValue.length : false;
                    this.query = inputValue;
                    if (!areEquivalent) {
                        this.trigger('queryChanged', this.query);
                    } else if (hasDifferentWhitespace) {
                        this.trigger('whitespaceChanged', this.query);
                    }
                },
                focus: function focus() {
                    this.$input.focus();
                },
                blur: function blur() {
                    this.$input.blur();
                },
                getQuery: function getQuery() {
                    return this.query;
                },
                setQuery: function setQuery(query) {
                    this.query = query;
                },
                getInputValue: function getInputValue() {
                    return this.$input.val();
                },
                setInputValue: function setInputValue(value, silent) {
                    this.$input.val(value);
                    silent ? this.clearHint() : this._checkInputValue();
                },
                resetInputValue: function resetInputValue() {
                    this.setInputValue(this.query, true);
                },
                getHint: function getHint() {
                    return this.$hint.val();
                },
                setHint: function setHint(value) {
                    this.$hint.val(value);
                },
                clearHint: function clearHint() {
                    this.setHint('');
                },
                clearHintIfInvalid: function clearHintIfInvalid() {
                    var val, hint, valIsPrefixOfHint, isValid;
                    val = this.getInputValue();
                    hint = this.getHint();
                    valIsPrefixOfHint = val !== hint && hint.indexOf(val) === 0;
                    isValid = val !== '' && valIsPrefixOfHint && !this.hasOverflow();
                    !isValid && this.clearHint();
                },
                getLanguageDirection: function getLanguageDirection() {
                    return (this.$input.css('direction') || 'ltr').toLowerCase();
                },
                hasOverflow: function hasOverflow() {
                    var constraint = this.$input.width() - 2;
                    this.$overflowHelper.text(this.getInputValue());
                    return this.$overflowHelper.width() >= constraint;
                },
                isCursorAtEnd: function () {
                    var valueLength, selectionStart, range;
                    valueLength = this.$input.val().length;
                    selectionStart = this.$input[0].selectionStart;
                    if (_.isNumber(selectionStart)) {
                        return selectionStart === valueLength;
                    } else if (document.selection) {
                        range = document.selection.createRange();
                        range.moveStart('character', -valueLength);
                        return valueLength === range.text.length;
                    }
                    return true;
                },
                destroy: function destroy() {
                    this.$hint.off('.tt');
                    this.$input.off('.tt');
                    this.$hint = this.$input = this.$overflowHelper = null;
                }
            });
            return Input;
            function buildOverflowHelper($input) {
                return $('<pre aria-hidden="true"></pre>').css({
                    position: 'absolute',
                    visibility: 'hidden',
                    whiteSpace: 'pre',
                    fontFamily: $input.css('font-family'),
                    fontSize: $input.css('font-size'),
                    fontStyle: $input.css('font-style'),
                    fontVariant: $input.css('font-variant'),
                    fontWeight: $input.css('font-weight'),
                    wordSpacing: $input.css('word-spacing'),
                    letterSpacing: $input.css('letter-spacing'),
                    textIndent: $input.css('text-indent'),
                    textRendering: $input.css('text-rendering'),
                    textTransform: $input.css('text-transform')
                }).insertAfter($input);
            }
            function areQueriesEquivalent(a, b) {
                return Input.normalizeQuery(a) === Input.normalizeQuery(b);
            }
            function withModifier($e) {
                return $e.altKey || $e.ctrlKey || $e.metaKey || $e.shiftKey;
            }
        }();
        var Dataset = function () {
            'use strict';
            var datasetKey = 'ttDataset', valueKey = 'ttValue', datumKey = 'ttDatum';
            function Dataset(o) {
                o = o || {};
                o.templates = o.templates || {};
                if (!o.source) {
                    $.error('missing source');
                }
                if (o.name && !isValidName(o.name)) {
                    $.error('invalid dataset name: ' + o.name);
                }
                this.query = null;
                this.highlight = !!o.highlight;
                this.name = o.name || _.getUniqueId();
                this.source = o.source;
                this.displayFn = getDisplayFn(o.display || o.displayKey);
                this.templates = getTemplates(o.templates, this.displayFn);
                this.$el = $(html.dataset.replace('%CLASS%', this.name));
            }
            Dataset.extractDatasetName = function extractDatasetName(el) {
                return $(el).data(datasetKey);
            };
            Dataset.extractValue = function extractDatum(el) {
                return $(el).data(valueKey);
            };
            Dataset.extractDatum = function extractDatum(el) {
                return $(el).data(datumKey);
            };
            _.mixin(Dataset.prototype, EventEmitter, {
                _render: function render(query, suggestions) {
                    if (!this.$el) {
                        return;
                    }
                    var that = this, hasSuggestions;
                    this.$el.empty();
                    hasSuggestions = suggestions && suggestions.length;
                    if (!hasSuggestions && this.templates.empty) {
                        this.$el.html(getEmptyHtml()).prepend(that.templates.header ? getHeaderHtml() : null).append(that.templates.footer ? getFooterHtml() : null);
                    } else if (hasSuggestions) {
                        this.$el.html(getSuggestionsHtml()).prepend(that.templates.header ? getHeaderHtml() : null).append(that.templates.footer ? getFooterHtml() : null);
                    }
                    this.trigger('rendered');
                    function getEmptyHtml() {
                        return that.templates.empty({
                            query: query,
                            isEmpty: true
                        });
                    }
                    function getSuggestionsHtml() {
                        var $suggestions, nodes;
                        $suggestions = $(html.suggestions).css(css.suggestions);
                        nodes = _.map(suggestions, getSuggestionNode);
                        $suggestions.append.apply($suggestions, nodes);
                        that.highlight && highlight({
                            className: 'tt-highlight',
                            node: $suggestions[0],
                            pattern: query
                        });
                        return $suggestions;
                        function getSuggestionNode(suggestion) {
                            var $el;
                            $el = $(html.suggestion).append(that.templates.suggestion(suggestion)).data(datasetKey, that.name).data(valueKey, that.displayFn(suggestion)).data(datumKey, suggestion);
                            $el.children().each(function () {
                                $(this).css(css.suggestionChild);
                            });
                            return $el;
                        }
                    }
                    function getHeaderHtml() {
                        return that.templates.header({
                            query: query,
                            isEmpty: !hasSuggestions
                        });
                    }
                    function getFooterHtml() {
                        return that.templates.footer({
                            query: query,
                            isEmpty: !hasSuggestions
                        });
                    }
                },
                getRoot: function getRoot() {
                    return this.$el;
                },
                update: function update(query) {
                    var that = this;
                    this.query = query;
                    this.canceled = false;
                    this.source(query, render);
                    function render(suggestions) {
                        if (!that.canceled && query === that.query) {
                            that._render(query, suggestions);
                        }
                    }
                },
                cancel: function cancel() {
                    this.canceled = true;
                },
                clear: function clear() {
                    this.cancel();
                    this.$el.empty();
                    this.trigger('rendered');
                },
                isEmpty: function isEmpty() {
                    return this.$el.is(':empty');
                },
                destroy: function destroy() {
                    this.$el = null;
                }
            });
            return Dataset;
            function getDisplayFn(display) {
                display = display || 'value';
                return _.isFunction(display) ? display : displayFn;
                function displayFn(obj) {
                    return obj[display];
                }
            }
            function getTemplates(templates, displayFn) {
                return {
                    empty: templates.empty && _.templatify(templates.empty),
                    header: templates.header && _.templatify(templates.header),
                    footer: templates.footer && _.templatify(templates.footer),
                    suggestion: templates.suggestion || suggestionTemplate
                };
                function suggestionTemplate(context) {
                    return '<p>' + displayFn(context) + '</p>';
                }
            }
            function isValidName(str) {
                return /^[_a-zA-Z0-9-]+$/.test(str);
            }
        }();
        var Dropdown = function () {
            'use strict';
            function Dropdown(o) {
                var that = this, onSuggestionClick, onSuggestionMouseEnter, onSuggestionMouseLeave;
                o = o || {};
                if (!o.menu) {
                    $.error('menu is required');
                }
                this.isOpen = false;
                this.isEmpty = true;
                this.datasets = _.map(o.datasets, initializeDataset);
                onSuggestionClick = _.bind(this._onSuggestionClick, this);
                onSuggestionMouseEnter = _.bind(this._onSuggestionMouseEnter, this);
                onSuggestionMouseLeave = _.bind(this._onSuggestionMouseLeave, this);
                this.$menu = $(o.menu).on('click.tt', '.tt-suggestion', onSuggestionClick).on('mouseenter.tt', '.tt-suggestion', onSuggestionMouseEnter).on('mouseleave.tt', '.tt-suggestion', onSuggestionMouseLeave);
                _.each(this.datasets, function (dataset) {
                    that.$menu.append(dataset.getRoot());
                    dataset.onSync('rendered', that._onRendered, that);
                });
            }
            _.mixin(Dropdown.prototype, EventEmitter, {
                _onSuggestionClick: function onSuggestionClick($e) {
                    this.trigger('suggestionClicked', $($e.currentTarget));
                },
                _onSuggestionMouseEnter: function onSuggestionMouseEnter($e) {
                    this._removeCursor();
                    this._setCursor($($e.currentTarget), true);
                },
                _onSuggestionMouseLeave: function onSuggestionMouseLeave() {
                    this._removeCursor();
                },
                _onRendered: function onRendered() {
                    this.isEmpty = _.every(this.datasets, isDatasetEmpty);
                    this.isEmpty ? this._hide() : this.isOpen && this._show();
                    this.trigger('datasetRendered');
                    function isDatasetEmpty(dataset) {
                        return dataset.isEmpty();
                    }
                },
                _hide: function () {
                    this.$menu.hide();
                },
                _show: function () {
                    this.$menu.css('display', 'block');
                },
                _getSuggestions: function getSuggestions() {
                    return this.$menu.find('.tt-suggestion');
                },
                _getCursor: function getCursor() {
                    return this.$menu.find('.tt-cursor').first();
                },
                _setCursor: function setCursor($el, silent) {
                    $el.first().addClass('tt-cursor');
                    !silent && this.trigger('cursorMoved');
                },
                _removeCursor: function removeCursor() {
                    this._getCursor().removeClass('tt-cursor');
                },
                _moveCursor: function moveCursor(increment) {
                    var $suggestions, $oldCursor, newCursorIndex, $newCursor;
                    if (!this.isOpen) {
                        return;
                    }
                    $oldCursor = this._getCursor();
                    $suggestions = this._getSuggestions();
                    this._removeCursor();
                    newCursorIndex = $suggestions.index($oldCursor) + increment;
                    newCursorIndex = (newCursorIndex + 1) % ($suggestions.length + 1) - 1;
                    if (newCursorIndex === -1) {
                        this.trigger('cursorRemoved');
                        return;
                    } else if (newCursorIndex < -1) {
                        newCursorIndex = $suggestions.length - 1;
                    }
                    this._setCursor($newCursor = $suggestions.eq(newCursorIndex));
                    this._ensureVisible($newCursor);
                },
                _ensureVisible: function ensureVisible($el) {
                    var elTop, elBottom, menuScrollTop, menuHeight;
                    elTop = $el.position().top;
                    elBottom = elTop + $el.outerHeight(true);
                    menuScrollTop = this.$menu.scrollTop();
                    menuHeight = this.$menu.height() + parseInt(this.$menu.css('paddingTop'), 10) + parseInt(this.$menu.css('paddingBottom'), 10);
                    if (elTop < 0) {
                        this.$menu.scrollTop(menuScrollTop + elTop);
                    } else if (menuHeight < elBottom) {
                        this.$menu.scrollTop(menuScrollTop + (elBottom - menuHeight));
                    }
                },
                close: function close() {
                    if (this.isOpen) {
                        this.isOpen = false;
                        this._removeCursor();
                        this._hide();
                        this.trigger('closed');
                    }
                },
                open: function open() {
                    if (!this.isOpen) {
                        this.isOpen = true;
                        !this.isEmpty && this._show();
                        this.trigger('opened');
                    }
                },
                setLanguageDirection: function setLanguageDirection(dir) {
                    this.$menu.css(dir === 'ltr' ? css.ltr : css.rtl);
                },
                moveCursorUp: function moveCursorUp() {
                    this._moveCursor(-1);
                },
                moveCursorDown: function moveCursorDown() {
                    this._moveCursor(+1);
                },
                getDatumForSuggestion: function getDatumForSuggestion($el) {
                    var datum = null;
                    if ($el.length) {
                        datum = {
                            raw: Dataset.extractDatum($el),
                            value: Dataset.extractValue($el),
                            datasetName: Dataset.extractDatasetName($el)
                        };
                    }
                    return datum;
                },
                getDatumForCursor: function getDatumForCursor() {
                    return this.getDatumForSuggestion(this._getCursor().first());
                },
                getDatumForTopSuggestion: function getDatumForTopSuggestion() {
                    return this.getDatumForSuggestion(this._getSuggestions().first());
                },
                update: function update(query) {
                    _.each(this.datasets, updateDataset);
                    function updateDataset(dataset) {
                        dataset.update(query);
                    }
                },
                empty: function empty() {
                    _.each(this.datasets, clearDataset);
                    this.isEmpty = true;
                    function clearDataset(dataset) {
                        dataset.clear();
                    }
                },
                isVisible: function isVisible() {
                    return this.isOpen && !this.isEmpty;
                },
                destroy: function destroy() {
                    this.$menu.off('.tt');
                    this.$menu = null;
                    _.each(this.datasets, destroyDataset);
                    function destroyDataset(dataset) {
                        dataset.destroy();
                    }
                }
            });
            return Dropdown;
            function initializeDataset(oDataset) {
                return new Dataset(oDataset);
            }
        }();
        var Typeahead = function () {
            'use strict';
            var attrsKey = 'ttAttrs';
            function Typeahead(o) {
                var $menu, $input, $hint;
                o = o || {};
                if (!o.input) {
                    $.error('missing input');
                }
                this.isActivated = false;
                this.autoselect = !!o.autoselect;
                this.minLength = _.isNumber(o.minLength) ? o.minLength : 1;
                this.$node = buildDom(o.input, o.withHint);
                $menu = this.$node.find('.tt-dropdown-menu');
                $input = this.$node.find('.tt-input');
                $hint = this.$node.find('.tt-hint');
                $input.on('blur.tt', function ($e) {
                    var active, isActive, hasActive;
                    active = document.activeElement;
                    isActive = $menu.is(active);
                    hasActive = $menu.has(active).length > 0;
                    if (_.isMsie() && (isActive || hasActive)) {
                        $e.preventDefault();
                        $e.stopImmediatePropagation();
                        _.defer(function () {
                            $input.focus();
                        });
                    }
                });
                $menu.on('mousedown.tt', function ($e) {
                    $e.preventDefault();
                });
                this.eventBus = o.eventBus || new EventBus({ el: $input });
                this.dropdown = new Dropdown({
                    menu: $menu,
                    datasets: o.datasets
                }).onSync('suggestionClicked', this._onSuggestionClicked, this).onSync('cursorMoved', this._onCursorMoved, this).onSync('cursorRemoved', this._onCursorRemoved, this).onSync('opened', this._onOpened, this).onSync('closed', this._onClosed, this).onAsync('datasetRendered', this._onDatasetRendered, this);
                this.input = new Input({
                    input: $input,
                    hint: $hint
                }).onSync('focused', this._onFocused, this).onSync('blurred', this._onBlurred, this).onSync('enterKeyed', this._onEnterKeyed, this).onSync('tabKeyed', this._onTabKeyed, this).onSync('escKeyed', this._onEscKeyed, this).onSync('upKeyed', this._onUpKeyed, this).onSync('downKeyed', this._onDownKeyed, this).onSync('leftKeyed', this._onLeftKeyed, this).onSync('rightKeyed', this._onRightKeyed, this).onSync('queryChanged', this._onQueryChanged, this).onSync('whitespaceChanged', this._onWhitespaceChanged, this);
                this._setLanguageDirection();
            }
            _.mixin(Typeahead.prototype, {
                _onSuggestionClicked: function onSuggestionClicked(type, $el) {
                    var datum;
                    if (datum = this.dropdown.getDatumForSuggestion($el)) {
                        this._select(datum);
                    }
                },
                _onCursorMoved: function onCursorMoved() {
                    var datum = this.dropdown.getDatumForCursor();
                    this.input.setInputValue(datum.value, true);
                    this.eventBus.trigger('cursorchanged', datum.raw, datum.datasetName);
                },
                _onCursorRemoved: function onCursorRemoved() {
                    this.input.resetInputValue();
                    this._updateHint();
                },
                _onDatasetRendered: function onDatasetRendered() {
                    this._updateHint();
                },
                _onOpened: function onOpened() {
                    this._updateHint();
                    this.eventBus.trigger('opened');
                },
                _onClosed: function onClosed() {
                    this.input.clearHint();
                    this.eventBus.trigger('closed');
                },
                _onFocused: function onFocused() {
                    this.isActivated = true;
                    this.dropdown.open();
                },
                _onBlurred: function onBlurred() {
                    this.isActivated = false;
                    this.dropdown.empty();
                    this.dropdown.close();
                },
                _onEnterKeyed: function onEnterKeyed(type, $e) {
                    var cursorDatum, topSuggestionDatum;
                    cursorDatum = this.dropdown.getDatumForCursor();
                    topSuggestionDatum = this.dropdown.getDatumForTopSuggestion();
                    if (cursorDatum) {
                        this._select(cursorDatum);
                        $e.preventDefault();
                    } else if (this.autoselect && topSuggestionDatum) {
                        this._select(topSuggestionDatum);
                        $e.preventDefault();
                    }
                },
                _onTabKeyed: function onTabKeyed(type, $e) {
                    var datum;
                    if (datum = this.dropdown.getDatumForCursor()) {
                        this._select(datum);
                        $e.preventDefault();
                    } else {
                        this._autocomplete(true);
                    }
                },
                _onEscKeyed: function onEscKeyed() {
                    this.dropdown.close();
                    this.input.resetInputValue();
                },
                _onUpKeyed: function onUpKeyed() {
                    var query = this.input.getQuery();
                    this.dropdown.isEmpty && query.length >= this.minLength ? this.dropdown.update(query) : this.dropdown.moveCursorUp();
                    this.dropdown.open();
                },
                _onDownKeyed: function onDownKeyed() {
                    var query = this.input.getQuery();
                    this.dropdown.isEmpty && query.length >= this.minLength ? this.dropdown.update(query) : this.dropdown.moveCursorDown();
                    this.dropdown.open();
                },
                _onLeftKeyed: function onLeftKeyed() {
                    this.dir === 'rtl' && this._autocomplete();
                },
                _onRightKeyed: function onRightKeyed() {
                    this.dir === 'ltr' && this._autocomplete();
                },
                _onQueryChanged: function onQueryChanged(e, query) {
                    this.input.clearHintIfInvalid();
                    query.length >= this.minLength ? this.dropdown.update(query) : this.dropdown.empty();
                    this.dropdown.open();
                    this._setLanguageDirection();
                },
                _onWhitespaceChanged: function onWhitespaceChanged() {
                    this._updateHint();
                    this.dropdown.open();
                },
                _setLanguageDirection: function setLanguageDirection() {
                    var dir;
                    if (this.dir !== (dir = this.input.getLanguageDirection())) {
                        this.dir = dir;
                        this.$node.css('direction', dir);
                        this.dropdown.setLanguageDirection(dir);
                    }
                },
                _updateHint: function updateHint() {
                    var datum, val, query, escapedQuery, frontMatchRegEx, match;
                    datum = this.dropdown.getDatumForTopSuggestion();
                    if (datum && this.dropdown.isVisible() && !this.input.hasOverflow()) {
                        val = this.input.getInputValue();
                        query = Input.normalizeQuery(val);
                        escapedQuery = _.escapeRegExChars(query);
                        frontMatchRegEx = new RegExp('^(?:' + escapedQuery + ')(.+$)', 'i');
                        match = frontMatchRegEx.exec(datum.value);
                        match ? this.input.setHint(val + match[1]) : this.input.clearHint();
                    } else {
                        this.input.clearHint();
                    }
                },
                _autocomplete: function autocomplete(laxCursor) {
                    var hint, query, isCursorAtEnd, datum;
                    hint = this.input.getHint();
                    query = this.input.getQuery();
                    isCursorAtEnd = laxCursor || this.input.isCursorAtEnd();
                    if (hint && query !== hint && isCursorAtEnd) {
                        datum = this.dropdown.getDatumForTopSuggestion();
                        datum && this.input.setInputValue(datum.value);
                        this.eventBus.trigger('autocompleted', datum.raw, datum.datasetName);
                    }
                },
                _select: function select(datum) {
                    this.input.setQuery(datum.value);
                    this.input.setInputValue(datum.value, true);
                    this._setLanguageDirection();
                    this.eventBus.trigger('selected', datum.raw, datum.datasetName);
                    this.dropdown.close();
                    _.defer(_.bind(this.dropdown.empty, this.dropdown));
                },
                open: function open() {
                    this.dropdown.open();
                },
                close: function close() {
                    this.dropdown.close();
                },
                setVal: function setVal(val) {
                    val = _.toStr(val);
                    if (this.isActivated) {
                        this.input.setInputValue(val);
                    } else {
                        this.input.setQuery(val);
                        this.input.setInputValue(val, true);
                    }
                    this._setLanguageDirection();
                },
                getVal: function getVal() {
                    return this.input.getQuery();
                },
                destroy: function destroy() {
                    this.input.destroy();
                    this.dropdown.destroy();
                    destroyDomStructure(this.$node);
                    this.$node = null;
                }
            });
            return Typeahead;
            function buildDom(input, withHint) {
                var $input, $wrapper, $dropdown, $hint;
                $input = $(input);
                $wrapper = $(html.wrapper).css(css.wrapper);
                $dropdown = $(html.dropdown).css(css.dropdown);
                $hint = $input.clone().css(css.hint).css(getBackgroundStyles($input));
                $hint.val('').removeData().addClass('tt-hint').removeAttr('id name placeholder required').prop('readonly', true).attr({
                    autocomplete: 'off',
                    spellcheck: 'false',
                    tabindex: -1
                });
                $input.data(attrsKey, {
                    dir: $input.attr('dir'),
                    autocomplete: $input.attr('autocomplete'),
                    spellcheck: $input.attr('spellcheck'),
                    style: $input.attr('style')
                });
                $input.addClass('tt-input').attr({
                    autocomplete: 'off',
                    spellcheck: false
                }).css(withHint ? css.input : css.inputWithNoHint);
                try {
                    !$input.attr('dir') && $input.attr('dir', 'auto');
                } catch (e) {
                }
                return $input.wrap($wrapper).parent().prepend(withHint ? $hint : null).append($dropdown);
            }
            function getBackgroundStyles($el) {
                return {
                    backgroundAttachment: $el.css('background-attachment'),
                    backgroundClip: $el.css('background-clip'),
                    backgroundColor: $el.css('background-color'),
                    backgroundImage: $el.css('background-image'),
                    backgroundOrigin: $el.css('background-origin'),
                    backgroundPosition: $el.css('background-position'),
                    backgroundRepeat: $el.css('background-repeat'),
                    backgroundSize: $el.css('background-size')
                };
            }
            function destroyDomStructure($node) {
                var $input = $node.find('.tt-input');
                _.each($input.data(attrsKey), function (val, key) {
                    _.isUndefined(val) ? $input.removeAttr(key) : $input.attr(key, val);
                });
                $input.detach().removeData(attrsKey).removeClass('tt-input').insertAfter($node);
                $node.remove();
            }
        }();
        (function () {
            'use strict';
            var old, typeaheadKey, methods;
            old = $.fn.typeahead;
            typeaheadKey = 'ttTypeahead';
            methods = {
                initialize: function initialize(o, datasets) {
                    datasets = _.isArray(datasets) ? datasets : [].slice.call(arguments, 1);
                    o = o || {};
                    return this.each(attach);
                    function attach() {
                        var $input = $(this), eventBus, typeahead;
                        _.each(datasets, function (d) {
                            d.highlight = !!o.highlight;
                        });
                        typeahead = new Typeahead({
                            input: $input,
                            eventBus: eventBus = new EventBus({ el: $input }),
                            withHint: _.isUndefined(o.hint) ? true : !!o.hint,
                            minLength: o.minLength,
                            autoselect: o.autoselect,
                            datasets: datasets
                        });
                        $input.data(typeaheadKey, typeahead);
                    }
                },
                open: function open() {
                    return this.each(openTypeahead);
                    function openTypeahead() {
                        var $input = $(this), typeahead;
                        if (typeahead = $input.data(typeaheadKey)) {
                            typeahead.open();
                        }
                    }
                },
                close: function close() {
                    return this.each(closeTypeahead);
                    function closeTypeahead() {
                        var $input = $(this), typeahead;
                        if (typeahead = $input.data(typeaheadKey)) {
                            typeahead.close();
                        }
                    }
                },
                val: function val(newVal) {
                    return !arguments.length ? getVal(this.first()) : this.each(setVal);
                    function setVal() {
                        var $input = $(this), typeahead;
                        if (typeahead = $input.data(typeaheadKey)) {
                            typeahead.setVal(newVal);
                        }
                    }
                    function getVal($input) {
                        var typeahead, query;
                        if (typeahead = $input.data(typeaheadKey)) {
                            query = typeahead.getVal();
                        }
                        return query;
                    }
                },
                destroy: function destroy() {
                    return this.each(unattach);
                    function unattach() {
                        var $input = $(this), typeahead;
                        if (typeahead = $input.data(typeaheadKey)) {
                            typeahead.destroy();
                            $input.removeData(typeaheadKey);
                        }
                    }
                }
            };
            $.fn.typeahead = function (method) {
                var tts;
                if (methods[method] && method !== 'initialize') {
                    tts = this.filter(function () {
                        return !!$(this).data(typeaheadKey);
                    });
                    return methods[method].apply(tts, [].slice.call(arguments, 1));
                } else {
                    return methods.initialize.apply(this, arguments);
                }
            };
            $.fn.typeahead.noConflict = function noConflict() {
                $.fn.typeahead = old;
                return this;
            };
        }());
    }(window.jQuery));
    return;
});
define('ItemsSearcher.Collection', [
    'SC.Configuration',
    'Item.Collection',
    'underscore',
    'Utils',
    'typeahead'
], function (Configuration, ItemCollection, _) {
    'use strict';
    return ItemCollection.extend({
        defaultOptions: { searcherAPIConfiguration: 'searchApiMasterOptions.typeAhead' },
        initialize: function (collection, options) {
            this.options = _.defaults(options || {}, this.defaultOptions);
            this.searchApiMasterOptions = Configuration.get(this.options.searcherAPIConfiguration);
            ItemCollection.prototype.initialize.apply(this, arguments);
        },
        fetch: function (options) {
            options = options || {};
            options.cache = true;
            return ItemCollection.prototype.fetch.apply(this, arguments);
        }
    });
});
define('ItemsSearcher.Item.View', [
    'GlobalViews.StarRating.View',
    'itemssearcher_item.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore'
], function (GlobalViewsStarRatingView, itemssearcher_item_tpl, Backbone, BackboneCompositeView, _) {
    'use strict';
    return Backbone.View.extend({
        template: function () {
        },
        defaultOptions: { template: itemssearcher_item_tpl },
        initialize: function (options) {
            this.options = _.defaults(options || {}, this.defaultOptions);
            this.template = this.options.template;
            BackboneCompositeView.add(this);
        },
        childViews: {
            'Global.StarRating': function () {
                return new GlobalViewsStarRatingView({
                    model: this.model,
                    showRatingCount: false
                });
            }
        },
        getContext: function () {
            return {
                model: this.model,
                currentQuery: _(this.options.query).escape(),
                isItemSelected: !!this.model,
                hasResults: this.options.areResults,
                isAjaxDone: this.options.isAjaxDone
            };
        }
    });
});
define('ItemsSearcher.View', [
    'ItemsSearcher.Utils',
    'ItemsSearcher.Collection',
    'ItemsSearcher.Item.View',
    'PluginContainer',
    'itemssearcher.tpl',
    'Backbone',
    'underscore',
    'jQuery',
    'Utils'
], function (ItemsSearcherUtils, ItemsSearcherCollection, ItemsSearcherItemView, PluginContainer, itemssearcher_tpl, Backbone, _, jQuery) {
    'use strict';
    var ItemsSearcherView = Backbone.View.extend({
        template: function () {
        },
        defaultOptions: {
            placeholderLabel: _('Search for products').translate(),
            minLength: 3,
            maxLength: 10,
            limit: 10,
            sort: 'relevance:asc',
            labels: [],
            collection: ItemsSearcherCollection,
            query: '',
            ajaxDone: false,
            showMenuOnClick: false,
            itemView: ItemsSearcherItemView,
            highlight: true,
            template: itemssearcher_tpl,
            componentId: void 0,
            componentName: void 0,
            showSeeAll: true,
            highlightFirst: true,
            itemViewOptions: {},
            collectionOptions: {},
            getItemDisplayName: null
        },
        events: {
            'keyup [data-type="search-input"]': 'onKeyUp',
            'keydown [data-type="search-input"]': 'onKeyDown'
        },
        initialize: function (options) {
            this.options = _.defaults(options || {}, this.defaultOptions);
            this.collection = new this.options.collection([], this.options.collectionOptions);
            this.template = this.options.template;
            this.on('afterViewRender', this.configureTypeahead, this);
            this.installPlugins();
        },
        installPlugins: function () {
            this.postItemsSuggestionObtained = new PluginContainer();
        },
        getTypeAheadConfiguration: function () {
            var self = this;
            return {
                source: _.debounce(_.bind(self.loadSuggestionItemsSource, self), 500),
                displayKey: _.bind(self.getSelectedItemDisplayText, self),
                templates: { suggestion: _.bind(self.getSuggestionItemTemplate, self) }
            };
        },
        configureTypeahead: function () {
            var self = this, typeaheadOptions = {
                    highlight: this.options.highlight,
                    minLength: this.options.minLength
                };
            self.$searchElement = self.$('[data-type="search-input"]');
            if (SC.ENVIRONMENT.jsEnvironment !== 'server') {
                self.$searchElement.typeahead(typeaheadOptions, this.getTypeAheadConfiguration()).on('typeahead:selected', _.bind(self.onItemSelected, self));
                self.$searchElement.on('focus', _.bind(self.selectFirstIfRequire, self));
                var drop = self.$searchElement.data('ttTypeahead').dropdown;
                drop.$menu.off('click.tt', '.tt-suggestion').on('click.tt', '.tt-suggestion', _.bind(function ($e) {
                    $e.preventDefault();
                    $e.stopPropagation();
                    drop.trigger('suggestionClicked', jQuery($e.currentTarget));
                }, drop));
                if (self.options.showMenuOnClick) {
                    self.$searchElement.focus(function () {
                        var ev = jQuery.Event('keydown');
                        ev.keyCode = ev.which = 40;
                        jQuery(this).trigger(ev);
                        return true;
                    });
                }
            }
        },
        getCurrentQuery: function getCurrentQuery() {
            return jQuery.trim(this.$searchElement.val());
        },
        cleanSearch: function cleanSearch(stop_triggering_event) {
            this.$searchElement.data('ttTypeahead') && this.$searchElement.data('ttTypeahead').close();
            this.$searchElement.typeahead('val', '');
            this.options.query = '';
            this.options.selectedItem = null;
            if (!stop_triggering_event) {
                this.trigger('itemSelected', {
                    selectedItem: null,
                    collection: this.collection.models,
                    currentQuery: this.options.query
                });
            }
        },
        onItemSelected: function onItemSelected(e, item_id) {
            this.options.selectedItem = this.collection.get(item_id);
            this.trigger('itemSelected', {
                selectedItem: this.collection.get(item_id),
                collection: this.collection.models,
                currentQuery: this.options.query,
                isResultCompleted: this.options.ajaxDone
            });
        },
        setFocus: function setFocus() {
            this.$searchElement.focus();
        },
        selectFirstIfRequire: function selectFirstIfRequire() {
            if (this.options.highlightFirst) {
                var $menu_container = this.$searchElement.data('ttTypeahead').dropdown.$menu, current_cursor_index = $menu_container.find('.tt-suggestion.tt-cursor').index();
                if (current_cursor_index === -1) {
                    $menu_container.find('.tt-suggestion').first().addClass('tt-cursor');
                }
            }
        },
        loadSuggestionItemsSource: function loadSuggestionItemsSource(query, callback) {
            var self = this;
            self.options.ajaxDone = false;
            self.options.results = {};
            self.options.query = ItemsSearcherUtils.formatKeywords(query);
            this.collection = new this.options.collection([], this.options.collectionOptions);
            if (self.options.query.length >= self.options.minLength) {
                self.options.labels = ['see-all-' + self.options.query];
                callback(self.options.labels);
                self.$searchElement.data('ttTypeahead').dropdown.moveCursorDown();
            }
            self.collection.fetch({
                data: {
                    q: jQuery.trim(self.options.query),
                    sort: self.options.sort,
                    limit: self.options.limit,
                    offset: 0
                },
                killerId: _.uniqueId('ajax_killer_')
            }, { silent: true }).done(function () {
                self.collection = self.postItemsSuggestionObtained.executeAll(self.collection, self.options) || self.collection;
                self.options.ajaxDone = true;
                self.options.labels = self.options.showSeeAll ? ['see-all-' + self.options.query].concat(self.getItemIds(self.collection)) : self.getItemIds(self.collection);
                if (!self.options.labels.length) {
                    self.options.labels = ['see-all-' + self.options.query];
                }
                callback(self.options.labels);
                self.selectFirstIfRequire();
            });
        },
        getItemIds: function getItemIds(collection) {
            return collection.map(function (item) {
                return item.id;
            });
        },
        getSelectedItemDisplayText: function (item_id) {
            return this.getItemDisplayName(this.collection.get(item_id), this.options.query);
        },
        getItemDisplayName: function (item, query) {
            return _.isFunction(this.options.getItemDisplayName) ? this.options.getItemDisplayName(item, query) : item ? item.get('_name') : query;
        },
        getSuggestionItemTemplate: function (item_id) {
            var item_view_options = _.extend({}, this.options.itemViewOptions, {
                    model: this.collection.get(item_id),
                    query: this.options.query,
                    areResults: !!this.collection.length,
                    isAjaxDone: this.options.ajaxDone
                }), items_searcher_item = new this.options.itemView(item_view_options);
            items_searcher_item.render();
            return items_searcher_item.$el;
        },
        onKeyUp: function (e) {
            this.trigger('keyUp', {
                collection: this.collection.models,
                eventObject: e,
                currentQuery: this.getCurrentQuery()
            });
        },
        onKeyDown: function (e) {
            var current_text = this.$searchElement.typeahead('val');
            if (this.options.selectedItem && current_text !== this.getItemDisplayName(this.options.selectedItem, this.options.query)) {
                this.options.selectedItem = null;
                this.trigger('itemSelected', {
                    selectedItem: null,
                    collection: this.collection.models,
                    currentQuery: this.options.query
                });
            }
            this.trigger('keyDown', {
                collection: this.collection.models,
                eventObject: e,
                currentQuery: this.getCurrentQuery()
            });
        },
        destroy: function () {
            this.off('afterViewRender');
            this.$searchElement.off('click');
            Backbone.View.prototype.destroy.apply(this, arguments);
        },
        getContext: function () {
            return {
                placeholderLabel: this.options.placeholderLabel,
                maxLength: this.options.maxLength,
                showId: !!this.options.componentId,
                id: this.options.componentId,
                showName: !!this.options.componentName,
                name: this.options.componentName
            };
        }
    });
    return ItemsSearcherView;
});
define('SiteSearch.View', [
    'SC.Configuration',
    'ItemsSearcher.View',
    'Session',
    'Backbone.CompositeView',
    'site_search.tpl',
    'Backbone',
    'underscore',
    'Utils'
], function (Configuration, ItemsSearcherView, Session, BackboneCompositeView, site_search_tpl, Backbone, _, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: site_search_tpl,
        events: {
            'submit [data-action="search"]': 'searchEventHandler',
            'click [data-type="search-reset"]': 'resetHandle'
        },
        initialize: function () {
            this.itemsSearcherComponent = new ItemsSearcherView({
                minLength: Configuration.get('typeahead.minLength', 3),
                maxLength: Configuration.get('searchPrefs.maxLength', 0),
                limit: Configuration.get('typeahead.maxResults', 10),
                sort: Configuration.get('typeahead.sort', 'relevance:asc'),
                highlight: Configuration.get('typeahead.highlight', true)
            });
            this.itemsSearcherComponent.on('itemSelected', this.onItemSelected, this);
            this.itemsSearcherComponent.on('keyUp', this.showReset, this);
            this.itemsSearcherComponent.on('keyDown', this.cleanSearchOnEnter, this);
            BackboneCompositeView.add(this);
        },
        showReset: function (event_properties) {
            if (event_properties.currentQuery) {
                this.$('[data-type="search-reset"]').show();
            } else {
                this.$('[data-type="search-reset"]').hide();
            }
        },
        cleanSearchOnEnter: function (event_properties) {
            if (event_properties.eventObject.keyCode === 27) {
                this.$('[data-type="search-reset"]').hide();
                this.itemsSearcherComponent.cleanSearch();
            }
        },
        resetHandle: function () {
            this.$('[data-type="search-reset"]').hide();
            this.itemsSearcherComponent.cleanSearch();
        },
        showSiteSearch: function (dontFocus) {
            this.$('[data-type="search-reset"]').hide();
            this.itemsSearcherComponent.cleanSearch(true);
            if (!dontFocus) {
                this.itemsSearcherComponent.setFocus();
            }
        },
        searchEventHandler: function (e) {
            e.preventDefault();
            var search_term = this.itemsSearcherComponent.getCurrentQuery();
            if (search_term.length < 1) {
                return;
            }
            this.itemsSearcherComponent.cleanSearch();
            this.executeSearch(search_term);
        },
        executeSearch: function (keywords) {
            var search_url = _.getPathFromObject(Configuration, 'defaultSearchUrl'), delimiters = _.getPathFromObject(Configuration, 'facetDelimiters'), keywordsDelimited = delimiters ? delimiters.betweenFacetsAndOptions + 'keywords' + delimiters.betweenOptionNameAndValue : '?keywords=';
            if (_.getPathFromObject(Configuration, 'currentTouchpoint') !== 'home') {
                window.location.href = Session.get('touchpoints.home') + '#' + search_url + keywordsDelimited + keywords;
            } else {
                Backbone.history.navigate(search_url + keywordsDelimited + keywords + this.getCurrentSearchOptions(), { trigger: true });
            }
        },
        onItemSelected: function (result) {
            var item = result.selectedItem, collection = result.collection, query = result.currentQuery;
            this.$('[data-type="search-reset"]').hide();
            this.itemsSearcherComponent.cleanSearch(true);
            if (item) {
                var path = item.get('_url');
                if (Configuration.get('currentTouchpoint', '') !== 'home') {
                    window.location.href = Session.get('touchpoints.home') + '#' + path;
                } else {
                    Backbone.history.navigate(path, { trigger: true });
                }
            } else {
                if (!collection.length && result.isResultCompleted) {
                    return false;
                } else {
                    this.executeSearch(query);
                }
            }
        },
        getCurrentSearchOptions: function () {
            var newOptions = [], currentOptions = Utils.parseUrlOptions(window.location.href);
            _.each(currentOptions, function (value, key) {
                var lowerCaseKey = key.toLowerCase();
                if (lowerCaseKey === 'order' || lowerCaseKey === 'show' || lowerCaseKey === 'display') {
                    newOptions.push(lowerCaseKey + '=' + value);
                }
            });
            var newOptionsStr = newOptions.join('&');
            if (newOptionsStr.length > 0) {
                newOptionsStr = '&' + newOptionsStr;
            }
            return newOptionsStr;
        },
        childViews: {
            'ItemsSeacher': function () {
                return this.itemsSearcherComponent;
            }
        },
        getContext: function () {
            return {};
        },
        destroy: function () {
            Backbone.View.prototype.destroy.apply(this, arguments);
            this.itemsSearcherComponent.off('itemSelected');
            this.itemsSearcherComponent.off('keyUp');
            this.itemsSearcherComponent.off('keyDown');
        }
    });
});
define('Header.View', [
    'SC.Configuration',
    'Profile.Model',
    'Header.Logo.View',
    'Header.MiniCart.View',
    'Header.MiniCartSummary.View',
    'Header.Profile.View',
    'Header.Menu.View',
    'GlobalViews.HostSelector.View',
    'GlobalViews.CurrencySelector.View',
    'SiteSearch.View',
    'header.tpl',
    'jQuery',
    'Backbone',
    'Backbone.CompositeView',
    'underscore',
    'Utils'
], function (Configuration, ProfileModel, HeaderLogoView, HeaderMiniCartView, HeaderMiniCartSummaryView, HeaderProfileView, HeaderMenuView, GlobalViewsHostSelectorView, GlobalViewsCurrencySelectorView, SiteSearchView, header_tpl, jQuery, Backbone, BackboneCompositeView, _, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: header_tpl,
        events: {
            'click [data-action="show-sitesearch"]': 'showSiteSearch',
            'click [data-action="header-sidebar-show"]': 'showSidebar',
            'click [data-action="header-sidebar-hide"]': 'hideSidebar',
            'click [data-type="header-sidebar-menu"]': 'hideSidebar'
        },
        initialize: function () {
            BackboneCompositeView.add(this);
            Backbone.history.on('all', this.verifyShowSiteSearch, this);
        },
        verifyShowSiteSearch: function () {
            var hash = Backbone.history.getFragment() || '';
            hash = hash.indexOf('?') === -1 ? hash : hash.substring(0, hash.indexOf('?'));
            var is_home = hash === '' || hash === '/';
            if (Utils.getDeviceType() !== 'desktop' && is_home) {
                this.showSiteSearch(null, true);
            } else {
                this.hideSiteSearch();
            }
        },
        showSiteSearch: function (ev) {
            ev && ev.preventDefault();
            this.$('[data-action="show-sitesearch"]').toggleClass('active');
            var self = this;
            this.$('[data-type="SiteSearch"]').stop(true, false).slideToggle(function () {
                self.getChildViewInstance('SiteSearch').showSiteSearch();
            });
        },
        hideSiteSearch: function () {
            this.$('[data-type="SiteSearch"]').slideUp();
        },
        showMiniCart: function () {
            this.$('[data-type="mini-cart"]').parent().addClass('open');
        },
        showSidebar: function () {
            jQuery('#main').addClass('header-sidebar-opened');
        },
        hideSidebar: function (e) {
            if (e.target.tagName === 'A') {
                if (this.activeLink) {
                    this.activeLink.removeClass('active');
                }
                this.activeLink = jQuery(e.target);
                this.activeLink.addClass('active');
            }
            jQuery('#main').removeClass('header-sidebar-opened');
        },
        childViews: {
            'Header.MiniCart': function () {
                return new HeaderMiniCartView();
            },
            'Header.MiniCartSummary': function () {
                return new HeaderMiniCartSummaryView();
            },
            'Header.Profile': function () {
                var header_profile_view_options = _.extend({
                    showMyAccountMenu: true,
                    application: this.options.application
                }, this.options.headerProfileViewOptions || {});
                return new HeaderProfileView(header_profile_view_options);
            },
            'Header.Logo': function () {
                return new HeaderLogoView(this.options);
            },
            'Header.Menu': function () {
                var header_view_options = _.extend({ application: this.options.application }, this.options.headerProfileViewOptions || {});
                return new HeaderMenuView(header_view_options);
            },
            'Global.HostSelector': function () {
                return new GlobalViewsHostSelectorView();
            },
            'Global.CurrencySelector': function () {
                return new GlobalViewsCurrencySelectorView();
            },
            'SiteSearch': function () {
                return new SiteSearchView();
            }
        },
        getContext: function getContext() {
            var environment = SC.ENVIRONMENT, show_languages = environment.availableHosts && environment.availableHosts.length > 1, show_currencies = environment.availableCurrencies && environment.availableCurrencies.length > 1 && !Configuration.get('header.notShowCurrencySelector');
            return {
                profileModel: ProfileModel.getInstance(),
                showLanguages: show_languages,
                showCurrencies: show_currencies,
                showLanguagesOrCurrencies: show_languages || show_currencies,
                showLanguagesAndCurrencies: show_languages && show_currencies,
                isHomeTouchpoint: Configuration.currentTouchpoint === 'home',
                cartTouchPoint: Configuration.get('modulesConfig.Cart.startRouter', false) ? Configuration.currentTouchpoint : 'viewcart'
            };
        },
        destroy: function () {
            Backbone.View.prototype.destroy.apply(this, arguments);
            Backbone.history.off('all', this.verifyShowSiteSearch);
        }
    });
});
define('GlobalViews.BackToTop.View', [
    'global_views_back_to_top.tpl',
    'Backbone',
    'jQuery'
], function (global_views_back_to_top_tpl, Backbone, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_back_to_top_tpl,
        events: { 'click [data-action="back-to-top"]': 'backToTop' },
        backToTop: function () {
            jQuery('html, body').animate({ scrollTop: '0px' }, 300);
        }
    });
});
define('Footer.View', [
    'SC.Configuration',
    'GlobalViews.BackToTop.View',
    'footer.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'jQuery'
], function (Configuration, GlobalViewsBackToTopView, footer_tpl, Backbone, BackboneCompositeView, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: footer_tpl,
        initialize: function (options) {
            this.application = options.application;
            BackboneCompositeView.add(this);
            this.application.getLayout().on('afterAppendToDom', function () {
                var headerMargin = 25;
                setTimeout(function () {
                    var contentHeight = jQuery(window).innerHeight() - jQuery('#site-header')[0].offsetHeight - headerMargin - jQuery('#site-footer')[0].offsetHeight;
                    jQuery('#main-container').css('min-height', contentHeight);
                }, 10);
            });
        },
        childViews: {
            'Global.BackToTop': function () {
                return new GlobalViewsBackToTopView();
            }
        },
        getContext: function () {
            var footerNavigationLinks = Configuration.get('footer.navigationLinks', []);
            return {
                showFooterNavigationLinks: !!footerNavigationLinks.length,
                footerNavigationLinks: footerNavigationLinks
            };
        }
    });
});
define('GlobalViews.Breadcrumb.View', [
    'global_views_breadcrumb.tpl',
    'Backbone',
    'jQuery',
    'underscore'
], function (global_views_breadcrumb_tpl, Backbone, jQuery, _) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_breadcrumb_tpl,
        initialize: function (options) {
            var opt_pages = options.pages;
            if (_.isUndefined(opt_pages)) {
                this.pages = [];
            } else if (_.isArray(opt_pages)) {
                this.pages = opt_pages;
            } else {
                this.pages = [opt_pages];
            }
        },
        getContext: function () {
            _.each(this.pages, function (page) {
                if (page['data-touchpoint']) {
                    page.hasDataTouchpoint = true;
                }
                if (page['data-hashtag']) {
                    page.hasDataHashtag = true;
                }
            });
            return { pages: this.pages };
        }
    });
});
define('ApplicationSkeleton.Layout', [
    'GlobalViews.Modal.View',
    'Header.View',
    'Footer.View',
    'Backbone.CompositeView',
    'GlobalViews.Breadcrumb.View',
    'Tracker',
    'Backbone',
    'underscore',
    'jQuery'
], function (GlobalViewsModalView, HeaderView, FooterView, BackboneCompositeView, GlobalViewsBreadcrumbView, Tracker, Backbone, _, jQuery) {
    'use strict';
    var $current_modal_el, current_modal_view;
    return Backbone.View.extend({
        container_element: '#main',
        content_element: '#content',
        events: {
            'click [data-type="post-to-touchpoint"]': 'touchpointPost',
            'click [data-action="items-expander"]': 'itemsExpander',
            'click [data-action="dropdown-expander"]': 'dropdownExpander'
        },
        breadcrumbPrefix: [],
        breadcrumbPages: [],
        initialize: function (Application) {
            BackboneCompositeView.add(this);
            this.headerView = this.originalHeaderView = HeaderView;
            this.footerView = this.originalFooterView = FooterView;
            this.application = Application;
            this.windowWidth = jQuery(window).width();
            this.afterAppendViewPromise = jQuery.Deferred();
            var self = this;
            this.once('afterAppendView', function () {
                self.afterAppendViewPromise.resolve();
            });
            jQuery(window).on('resize', _.throttle(function () {
                if (_.getDeviceType(self.windowWidth) === _.getDeviceType(jQuery(window).width())) {
                    return;
                }
                _.resetViewportWidth();
                self.updateHeader();
                self.updateFooter();
                self.updateLayoutSB && self.updateLayoutSB();
                self.windowWidth = jQuery(window).width();
            }, 1000));
        },
        getColorPalette: function getColorPalette(palette_name) {
            var color_palette = {};
            if (!palette_name) {
                return color_palette;
            }
            _.each(this.application.getConfig('layout.colorPalette', []), function (color_item) {
                if (color_item.paletteId === palette_name) {
                    if (color_item.colorValue) {
                        color_palette[color_item.colorName] = color_item.colorValue;
                    } else if (color_item.imgsrc) {
                        color_palette[color_item.colorName] = {
                            src: color_item.imgsrc,
                            height: color_item.imgheight,
                            width: color_item.imgwidth
                        };
                    }
                }
            });
            return color_palette;
        },
        render: function () {
            this.trigger('beforeRender', this);
            Backbone.View.prototype.render.call(this);
            this.trigger('afterRender', this);
        },
        updateHeader: function () {
            if (this.application.getConfig('siteSettings.sitetype') === 'ADVANCED') {
                this.headerViewInstance && this.headerViewInstance.render();
            }
        },
        updateFooter: function () {
            if (this.application.getConfig('siteSettings.sitetype') === 'ADVANCED') {
                this.footerViewInstance && this.footerViewInstance.render();
            }
        },
        updateCrumbtrail: function (pages) {
            if (!_.isArray(pages)) {
                pages = [pages];
            }
            this.breadcrumbPages = _.union(this.breadcrumbPrefix, pages);
            return this.breadcrumbPages;
        },
        hideBreadcrumb: function () {
            this.breadcrumbViewInstance && this.breadcrumbViewInstance.$el.empty();
        },
        appendToDom: function () {
            var self = this;
            this.afterAppendViewPromise.done(function () {
                self.trigger('beforeAppendToDom', self);
                jQuery(self.container_element).html(self.$el);
                self.trigger('afterAppendToDom', self);
            });
        },
        getApplication: function () {
            return this.application;
        },
        touchpointPost: function (e) {
            var touchpoint = this.$(e.target).data('post-touchpoint'), touchpoints = SC.getSessionInfo('touchpoints'), target_touchpoint = (touchpoints ? touchpoints[touchpoint] : '') || '', new_url = _.fixUrl(target_touchpoint);
            _.doPost(new_url);
        },
        itemsExpander: function (e) {
            e.preventDefault();
            e.stopPropagation();
            jQuery(e.currentTarget).parent().find('[data-action="items-expander"] a i').toggleClass('icon-minus').end().find('[data-content="items-body"]').stop().slideToggle();
        },
        dropdownExpander: function (e) {
            e.preventDefault();
            e.stopPropagation();
            jQuery(e.currentTarget).parent().find('[data-action="dropdown-expander"] a i').toggleClass('icon-chevron-up').end().find('[data-content="items-body"]').stop().slideToggle();
        },
        showContent: function showContent(view, dont_scroll) {
            return this.cancelableTriggerUnsafe('beforeAppendView', view).then(_.bind(this._showContent, this, view, dont_scroll));
        },
        _showContent: function _showContent(view, dont_scroll) {
            var first_show_content = !this.currentView, current_view = this.currentView;
            if (!view.enhancedPage) {
                Tracker.getInstance().trackPageview('/' + Backbone.history.fragment);
            }
            this.closeModal();
            if (view.inModal) {
                return view.showInModal();
            }
            if (!this.rendered) {
                this.render();
                this.rendered = true;
            }
            if (current_view && current_view !== view) {
                current_view.destroy();
                if (current_view.bodyClass) {
                    this.$el.removeClass(current_view.bodyClass);
                }
            }
            this.currentView = view;
            this._currentView = view;
            this.headerView = this.currentView.getHeaderView && this.currentView.getHeaderView() ? this.currentView.getHeaderView() : this.originalHeaderView;
            this.footerView = this.currentView.getFooterView && this.currentView.getFooterView() ? this.currentView.getFooterView() : this.originalFooterView;
            if (this.headerViewInstance && !(this.headerViewInstance instanceof this.headerView) || this.footerViewInstance && !(this.footerViewInstance instanceof this.footerView)) {
                this.getChildViewInstance('Header') && this.getChildViewInstance('Header').undelegateEvents();
                this.getChildViewInstance('Footer') && this.getChildViewInstance('Footer').undelegateEvents();
                this.addChildViewInstances({
                    'Header': this.childViews.Header,
                    'Footer': this.childViews.Footer
                });
                this.render();
            }
            var breadcrumb_pages = this.currentView.getBreadcrumbPages ? this.currentView.getBreadcrumbPages() : null;
            if (breadcrumb_pages && this.breadcrumbViewInstance) {
                this.breadcrumbViewInstance.pages = this.updateCrumbtrail(breadcrumb_pages || []);
                this.breadcrumbViewInstance.render();
            } else {
                this.hideBreadcrumb();
            }
            var minHeight;
            if (!first_show_content) {
                minHeight = this.$(this.content_element).css('min-height');
                this.$(this.content_element).css('min-height', this.$(this.content_element).height() + 'px');
            }
            this.$(this.content_element).empty();
            view.render();
            if (view.bodyClass) {
                this.$el.addClass(view.bodyClass);
            }
            document.title = view.title || '';
            this.trigger('beforeAppendView', view);
            this.$(this.content_element).append(view.$el);
            if (!first_show_content && minHeight) {
                this.$(this.content_element).css('min-height', minHeight);
            }
            this.trigger('afterAppendView', view);
            view.isRenderedInLayout = true;
            if (!dont_scroll && !first_show_content) {
                jQuery(document).scrollTop(0);
            }
            return jQuery.Deferred().resolveWith(this, [view]);
        },
        wrapModalView: function (view) {
            var $modal_body = view.$containerModal.find(['data-type="modal-body"']);
            if (view.$('.modal-body').length && $modal_body.length) {
                $modal_body.removeClass('modal-body');
            }
            return this;
        },
        prefixViewIds: function (view, prefix) {
            if (typeof view === 'string') {
                prefix = view;
                view = this.currentView;
            }
            if (view instanceof Backbone.View) {
                prefix = prefix || '';
                view.$('[id]').each(function () {
                    var el = jQuery(this);
                    if (el.parents('svg').length > 0 || !!el.data('nonprefix')) {
                        return;
                    }
                    el.attr('id', function (i, old_id) {
                        return prefix + old_id;
                    });
                });
                view.$('[for]').each(function () {
                    jQuery(this).attr('for', function (i, old_id) {
                        return prefix + old_id;
                    });
                });
            }
        },
        addModalListeners: function (view, current_view) {
            var self = this;
            view.$containerModal.on('hidden.bs.modal', function () {
                self.$el.removeClass('modal-open');
                view.trigger('modal-close', view);
                current_view.destroy();
                view.$containerModal.remove();
                view.$containerModal = null;
                self.$containerModal = null;
                self.modalCurrentView = null;
                $current_modal_el = false;
                self._currentView = self.currentView;
                document.title = self.currentView && self.currentView.getTitle() || '';
            });
            view.$containerModal.on('shown.bs.modal', function () {
                if (view.focusFirstInput ? view.focusFirstInput() : true) {
                    view.$('form:first *:input[type!=hidden]:first').focus();
                }
                self.trigger('afterAppendView', view);
                view.$containerModal.modal('handleUpdate');
            });
        },
        getCurrentView: function () {
            return this._currentView;
        },
        showInPush: function (view, options) {
            var self = this;
            options = options || {};
            if (!this.$pusher_container) {
                this.$pusher_container = jQuery('<div data-action="pushable"></div>');
                this.$el.append(this.$pusher_container);
            }
            view.$pusher_container = this.$pusher_container;
            view.render();
            this.pushCurrentView = view;
            this.$pusher_container.append(view.$el);
            this.$pusher_container.scPush();
            this.$pusher_container.trigger('open');
            this.$pusher_container.on('afterClose', function () {
                if (!options.no_destroy) {
                    if (view) {
                        view.$el.empty();
                        view.destroy();
                        self.$pusher_container.find('div:empty').remove();
                        self.pushCurrentView = null;
                    }
                }
            });
            return jQuery.Deferred().resolveWith(this, [view]);
        },
        closePush: function removePush() {
            if (this.$pusher_container) {
                this.$pusher_container.trigger('close');
                this.$pusher_container.find('div:empty').remove();
            }
        },
        showInModal: function (view, options) {
            var promise_result = jQuery.Deferred();
            options = jQuery.extend({ modalOptions: {} }, options);
            view.events = view.events || {};
            view.events['mousedown [data-dismiss="modal"]'] = function (e) {
                e.preventDefault();
            };
            view.inModal = true;
            if (!view.hasRenderedInModal) {
                var element_id = view.$el.attr('id');
                GlobalViewsModalView.prototype.attributes = {};
                GlobalViewsModalView.prototype.className = 'modal fade ' + (view.modalClass || element_id ? 'modal-' + element_id : '');
                GlobalViewsModalView.prototype.attributes.id = view.modalId || element_id ? 'modal-' + element_id : 'modal';
                current_modal_view = new GlobalViewsModalView({
                    childViewIstance: view,
                    pageHeader: view.page_header || view.title || ''
                });
                this.$containerModal = view.$containerModal = current_modal_view.$el;
                this.modalCurrentView = view;
                this._currentView = view;
                view.options.layout = this;
            }
            this.trigger('beforeAppendView', view);
            if (!view.hasRenderedInModal) {
                var self = this;
                this.closeModal().done(function () {
                    self._showModalInDOM(view, options, current_modal_view, promise_result);
                });
            } else {
                this._renderModalView(view, current_modal_view);
                promise_result.resolveWith(this, [view]);
            }
            return promise_result;
        },
        closeModal: function () {
            var promise = jQuery.Deferred();
            if ($current_modal_el) {
                $current_modal_el.on('hidden.bs.modal', function () {
                    promise.resolve();
                });
                $current_modal_el.modal('hide');
            } else {
                promise.resolve();
            }
            return promise;
        },
        _renderModalView: function (view, current_modal_view) {
            if (!view.hasRenderedInModal) {
                current_modal_view.render();
            } else {
                view.render();
            }
            this.wrapModalView(view).prefixViewIds(view, 'in-modal-');
        },
        _showModalInDOM: function (view, options, current_modal_view, promise) {
            this._renderModalView(view, current_modal_view);
            $current_modal_el = view.$containerModal;
            this.addModalListeners(view, current_modal_view);
            view.$containerModal.appendTo(this.el);
            view.$containerModal.modal(options.modalOptions);
            this.$el.addClass('modal-open');
            if (options.className) {
                view.$containerModal.addClass(options.className);
            }
            view.hasRenderedInModal = true;
            promise.resolveWith(this, [view]);
        },
        showError: jQuery.noop,
        showSuccess: jQuery.noop,
        childViews: {
            'Header': function () {
                var options = { application: this.application };
                if (this.currentView && this.currentView.getHeaderViewOptions) {
                    _.extend(options, this.currentView.getHeaderViewOptions());
                }
                this.headerViewInstance = new this.headerView(options);
                return this.headerViewInstance;
            },
            'Footer': function () {
                var options = { application: this.application };
                if (this.currentView && this.currentView.getFooterViewOptions) {
                    _.extend(options, this.currentView.getFooterViewOptions());
                }
                this.footerViewInstance = new this.footerView(options);
                return this.footerViewInstance;
            },
            'Global.Breadcrumb': function () {
                this.breadcrumbViewInstance = new GlobalViewsBreadcrumbView({ pages: this.breadcrumbPages });
                return this.breadcrumbViewInstance;
            }
        },
        getContext: function () {
            return {};
        }
    });
});
define('SC.ComponentContainer', ['underscore'], function (_) {
    'use strict';
    function sealComponent(component, component_name) {
        try {
            _.each(component, function (value, prop) {
                Object.defineProperty(component, prop, {
                    get: function () {
                        return value;
                    },
                    set: function () {
                        throw new Error('You cannot override property ' + prop + ' of component ' + component_name);
                    }
                });
            });
        } catch (e) {
        }
        return component;
    }
    return {
        _components: {},
        registerComponent: function registerComponent(component) {
            if (component && component.componentName) {
                this._components[component.componentName] = sealComponent(component, component.componentName);
                return;
            }
            var error = new Error('Invalid component parameter, make sure you specify a componentName property and getProxy method');
            error.name = 'INVALID_PARAM';
            throw error;
        },
        getComponent: function getComponent(component_name) {
            return this._components[component_name] || null;
        }
    };
});
define('Console.Polyfill', function () {
    'use strict';
    if (typeof window.console === 'undefined') {
        window.console = {};
        var i = 0, noop = function () {
            }, methods = [
                'assert',
                'error',
                'clear',
                'count',
                'debug',
                'dir',
                'dirxml',
                'exception',
                'group',
                'groupCollapsed',
                'groupEnd',
                'info',
                'log',
                'profile',
                'profileEnd',
                'table',
                'time',
                'timeEnd',
                'trace',
                'warn'
            ];
        for (; i < methods.length; i++) {
            window.console[methods[i]] = noop;
        }
    }
    if (typeof window.console.memory === 'undefined') {
        window.console.memory = {};
    }
});
define('json2', [], function () {
    if (typeof JSON !== 'object') {
        JSON = {};
    }
    (function () {
        'use strict';
        function f(n) {
            return n < 10 ? '0' + n : n;
        }
        if (typeof Date.prototype.toJSON !== 'function') {
            Date.prototype.toJSON = function () {
                return isFinite(this.valueOf()) ? this.getUTCFullYear() + '-' + f(this.getUTCMonth() + 1) + '-' + f(this.getUTCDate()) + 'T' + f(this.getUTCHours()) + ':' + f(this.getUTCMinutes()) + ':' + f(this.getUTCSeconds()) + 'Z' : null;
            };
            String.prototype.toJSON = Number.prototype.toJSON = Boolean.prototype.toJSON = function () {
                return this.valueOf();
            };
        }
        var cx, escapable, gap, indent, meta, rep;
        function quote(string) {
            escapable.lastIndex = 0;
            return escapable.test(string) ? '"' + string.replace(escapable, function (a) {
                var c = meta[a];
                return typeof c === 'string' ? c : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
            }) + '"' : '"' + string + '"';
        }
        function str(key, holder) {
            var i, k, v, length, mind = gap, partial, value = holder[key];
            if (value && typeof value === 'object' && typeof value.toJSON === 'function') {
                value = value.toJSON(key);
            }
            if (typeof rep === 'function') {
                value = rep.call(holder, key, value);
            }
            switch (typeof value) {
            case 'string':
                return quote(value);
            case 'number':
                return isFinite(value) ? String(value) : 'null';
            case 'boolean':
            case 'null':
                return String(value);
            case 'object':
                if (!value) {
                    return 'null';
                }
                gap += indent;
                partial = [];
                if (Object.prototype.toString.apply(value) === '[object Array]') {
                    length = value.length;
                    for (i = 0; i < length; i += 1) {
                        partial[i] = str(i, value) || 'null';
                    }
                    v = partial.length === 0 ? '[]' : gap ? '[\n' + gap + partial.join(',\n' + gap) + '\n' + mind + ']' : '[' + partial.join(',') + ']';
                    gap = mind;
                    return v;
                }
                if (rep && typeof rep === 'object') {
                    length = rep.length;
                    for (i = 0; i < length; i += 1) {
                        if (typeof rep[i] === 'string') {
                            k = rep[i];
                            v = str(k, value);
                            if (v) {
                                partial.push(quote(k) + (gap ? ': ' : ':') + v);
                            }
                        }
                    }
                } else {
                    for (k in value) {
                        if (Object.prototype.hasOwnProperty.call(value, k)) {
                            v = str(k, value);
                            if (v) {
                                partial.push(quote(k) + (gap ? ': ' : ':') + v);
                            }
                        }
                    }
                }
                v = partial.length === 0 ? '{}' : gap ? '{\n' + gap + partial.join(',\n' + gap) + '\n' + mind + '}' : '{' + partial.join(',') + '}';
                gap = mind;
                return v;
            }
        }
        if (typeof JSON.stringify !== 'function') {
            escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
            meta = {
                '\b': '\\b',
                '\t': '\\t',
                '\n': '\\n',
                '\f': '\\f',
                '\r': '\\r',
                '"': '\\"',
                '\\': '\\\\'
            };
            JSON.stringify = function (value, replacer, space) {
                var i;
                gap = '';
                indent = '';
                if (typeof space === 'number') {
                    for (i = 0; i < space; i += 1) {
                        indent += ' ';
                    }
                } else if (typeof space === 'string') {
                    indent = space;
                }
                rep = replacer;
                if (replacer && typeof replacer !== 'function' && (typeof replacer !== 'object' || typeof replacer.length !== 'number')) {
                    throw new Error('JSON.stringify');
                }
                return str('', { '': value });
            };
        }
        if (typeof JSON.parse !== 'function') {
            cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
            JSON.parse = function (text, reviver) {
                var j;
                function walk(holder, key) {
                    var k, v, value = holder[key];
                    if (value && typeof value === 'object') {
                        for (k in value) {
                            if (Object.prototype.hasOwnProperty.call(value, k)) {
                                v = walk(value, k);
                                if (v !== undefined) {
                                    value[k] = v;
                                } else {
                                    delete value[k];
                                }
                            }
                        }
                    }
                    return reviver.call(holder, key, value);
                }
                text = String(text);
                cx.lastIndex = 0;
                if (cx.test(text)) {
                    text = text.replace(cx, function (a) {
                        return '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
                    });
                }
                if (/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {
                    j = eval('(' + text + ')');
                    return typeof reviver === 'function' ? walk({ '': j }, '') : j;
                }
                throw new SyntaxError('JSON.parse');
            };
        }
    }());
    return JSON;
});
define('ApplicationSkeleton', [
    'ApplicationSkeleton.Layout',
    'SC.ComponentContainer',
    'underscore',
    'Backbone',
    'Utils',
    'Console.Polyfill',
    'json2'
], function (Layout, SCComponentContainer, _, Backbone, Utils) {
    'use strict';
    function ApplicationSkeleton(name) {
        if (!(this instanceof ApplicationSkeleton)) {
            return new ApplicationSkeleton();
        }
        this.Configuration = {};
        this.name = name;
        this._modulesMountToAppResult = [];
    }
    ApplicationSkeleton.prototype.resizeImage = function (url, size) {
        url = url || _.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', this.getConfig('imageNotAvailable'));
        var mapped_size = this.getConfig('imageSizeMapping.' + size, size);
        return Utils.resizeImage(this.getConfig('siteSettings.imagesizes', []), url, mapped_size);
    };
    ApplicationSkeleton.prototype.Layout = Layout;
    ApplicationSkeleton.prototype.getLayout = function getLayout() {
        this._layoutInstance = this._layoutInstance || new this.Layout(this);
        return this._layoutInstance;
    };
    ApplicationSkeleton.prototype.getConfig = function getConfig(path, default_value) {
        return Utils.getPathFromObject(this.Configuration, path, default_value);
    };
    ApplicationSkeleton.prototype.start = function start(modules, done_fn) {
        this.trigger('beforeStart', self);
        var self = this;
        self.modules = modules;
        var mount_to_app_result = {};
        _.each(self.modules, function (module) {
            if (module && _.isFunction(module.mountToApp)) {
                mount_to_app_result = module.mountToApp(self);
                if (mount_to_app_result && mount_to_app_result.componentName) {
                    self.registerComponent(mount_to_app_result);
                } else {
                    self._modulesMountToAppResult.push(mount_to_app_result);
                }
            }
        });
        if (!Backbone.history) {
            throw new Error('No Backbone.Router has been initialized (Hint: Are your modules properly set?).');
        }
        self.trigger('afterModulesLoaded', self);
        done_fn && _.isFunction(done_fn) && done_fn(self);
        self.trigger('afterStart', self);
    };
    _.extend(ApplicationSkeleton.prototype, Backbone.Events, SCComponentContainer);
    return ApplicationSkeleton;
});
define('Application', ['ApplicationSkeleton'], function (ApplicationSkeleton) {
    'use strict';
    SC._applications = {};
    SC.Application = function (application_name) {
        SC._applications[application_name] = SC._applications[application_name] || new ApplicationSkeleton(application_name);
        return SC._applications[application_name];
    };
    return SC.Application;
});
define('SC.Shopping.Layout', [
    'ApplicationSkeleton.Layout',
    'shopping_layout.tpl',
    'underscore',
    'Utils'
], function (ApplicationSkeletonLayout, shopping_layout_tpl, _) {
    'use strict';
    return ApplicationSkeletonLayout.extend({
        template: shopping_layout_tpl,
        className: 'layout-container',
        breadcrumbPrefix: [{
                href: '/',
                'data-touchpoint': 'home',
                'data-hashtag': '#',
                text: _('Home').translate()
            }]
    });
});
define('Backbone.Model', [
    'Backbone',
    'underscore',
    'SC.CancelableEvents'
], function (Backbone, _, SCCancelableEvents) {
    'use strict';
    _.extend(Backbone.Model.prototype, {
        url: function () {
            var base = _.result(this, 'urlRoot') || _.result(this.collection, 'url');
            if (this.isNew()) {
                return base;
            }
            var sep = base.indexOf('?') === -1 ? '?' : '&';
            return base + sep + 'internalid=' + encodeURIComponent(this.id);
        },
        idAttribute: 'internalid'
    }, SCCancelableEvents);
    return Backbone.Model;
});
define('Backbone.Sync', [
    'Backbone',
    'underscore',
    'jQuery',
    'Utils'
], function (Backbone, _, jQuery, Utils) {
    'use strict';
    Backbone.sync = _.wrap(Backbone.sync, function (fn, method, model, options) {
        var url = options.url || _.result(model, 'url');
        if (url) {
            options = options || {};
            if (url.indexOf('&c=') < 0 && url.indexOf('?c=') < 0) {
                url = url + (~url.indexOf('?') ? '&' : '?') + jQuery.param({ c: SC.ENVIRONMENT.companyId });
            }
            if (url.indexOf('&n=') < 0 && url.indexOf('?n=') < 0) {
                url = url + (~url.indexOf('?') ? '&' : '?') + jQuery.param({ n: SC.ENVIRONMENT.siteSettings.siteid });
            }
        }
        options.url = url;
        var actionDetails = model.get('actionDetails');
        if (actionDetails) {
            options.url = Utils.addParamsToUrl(options.url, actionDetails);
            model.unset('actionDetails');
        }
        return fn.apply(this, [
            method,
            model,
            options
        ]);
    });
    return Backbone.sync;
});
define('Backbone.Validation.callbacks', [
    'Backbone',
    'underscore',
    'Backbone.Validation',
    'Utils'
], function (Backbone, _) {
    'use strict';
    var selectors = {
        controlGroup: {
            attr: 'data-validation',
            value: 'control-group'
        },
        control: {
            attr: 'data-validation',
            value: 'control'
        },
        error: {
            attr: 'data-validation-error',
            value: ''
        },
        errorInline: {
            attr: 'data-validation-error',
            value: 'inline'
        },
        errorBlock: {
            attr: 'data-validation-error',
            value: 'block'
        },
        build: function (selectorName) {
            var selector = selectors[selectorName];
            return '[' + selector.attr + '="' + selector.value + '"]';
        }
    };
    _.extend(Backbone.Validation.callbacks, {
        valid: function (view, attr, selector) {
            var $control = view.$el.find('[' + selector + '="' + attr + '"]'), $group = $control.closest(selectors.build('controlGroup')).removeAttr(selectors.error.attr), $target = $control.data('error-style') === 'inline' ? $group.find(selectors.build('errorInline')) : $group.find(selectors.build('errorBlock'));
            view.helpMessages = view.helpMessages || {};
            if (view.helpMessages[attr]) {
                $target.text(view.helpMessages[attr]);
            }
            return $target.remove().end();
        },
        invalid: function (view, attr, error, selector) {
            view.hideError();
            var $target, $control = view.$el.find('[' + selector + '="' + attr + '"]'), $group = $control.closest(selectors.build('controlGroup')).attr(selectors.error.attr, selectors.error.value);
            if (!view.$savingForm) {
                view.$savingForm = $control.closest('form');
            }
            if ($control.data('error-style') === 'inline') {
                if (!$group.find(selectors.build('errorInline')).length) {
                    $group.find(selectors.build('control')).append('<span ' + selectors.errorInline.attr + '="' + selectors.errorInline.value + '"></span>');
                }
                $target = $group.find(selectors.build('errorInline'));
            } else {
                if (!$group.find(selectors.build('errorBlock')).length) {
                    $group.find(selectors.build('control')).append('<p ' + selectors.errorBlock.attr + '="' + selectors.errorBlock.value + '"></p>');
                }
                $target = $group.find(selectors.build('errorBlock'));
            }
            view.helpMessages = view.helpMessages || {};
            view.helpMessages[attr] = $target.text();
            return $target.text(error);
        }
    });
    return Backbone.Validation.callbacks;
});
define('Backbone.Validation.patterns', [
    'Backbone',
    'underscore',
    'Backbone.Validation'
], function (Backbone, _) {
    'use strict';
    _.extend(Backbone.Validation.patterns, {
        email: /^[-a-z0-9!#$%&'*+\/=?^_`{|}~]+(?:\.[-a-z0-9!#$%&'*+\/=?^_`{|}~]+)*@(?:[a-z0-9]+(?:-+[a-z0-9]+)*\.)+(?:xn--[a-z0-9]+|[a-z]{2,16})$/i,
        netsuiteUrl: /^(https|http|ftp|file):\/\//,
        netsuiteFloat: /^-{0,1}([0-9])+(\.{1}[0-9]+)?$/,
        netsuiteInteger: /^-{0,1}([0-9])+$/,
        netsuitePercent: /^0*((([0-9]{1,2})(\.[0-9]{1,2})?%?$)|(100(\.0{1,2})?%?$))/,
        netsuitePhone: /^.{7,}$/
    });
    return Backbone.Validation.patterns;
});
define('Backbone.View.saveForm', [
    'Backbone',
    'underscore',
    'jQuery'
], function (Backbone, _, jQuery) {
    'use strict';
    _.extend(Backbone.View.prototype, {
        saveForm: function (e, model, props) {
            e.preventDefault();
            model = model || this.model;
            this.$savingForm = jQuery(e.target).closest('form');
            if (this.$savingForm.length) {
                this.$savingForm.find('input[type="submit"], button[type="submit"]').attr('disabled', true);
                this.$savingForm.find('input[type="reset"], button[type="reset"]').hide();
            }
            this.hideError();
            var self = this;
            return model.save(props || this.$savingForm.serializeObject(), {
                wait: true,
                success: function (model, response) {
                    if (self.inModal && self.$containerModal) {
                        self.$containerModal.modal('hide');
                    }
                    if (self.$savingForm.length) {
                        self.hideError(self.$savingForm);
                        self.$savingForm.find('[type="submit"], [type="reset"]').attr('disabled', false);
                        model.trigger('save', model, response);
                    }
                },
                error: function (model, response) {
                    self.$savingForm.find('*[type=submit], *[type=reset]').attr('disabled', false);
                    if (response.responseText) {
                        model.trigger('error', jQuery.parseJSON(response.responseText));
                    }
                }
            });
        }
    });
    return Backbone.View.prototype.saveForm;
});
define('Backbone.View.toggleReset', [
    'Backbone',
    'underscore',
    'jQuery'
], function (Backbone, _, jQuery) {
    'use strict';
    _.extend(Backbone.View.prototype, {
        toggleReset: _.debounce(function (e) {
            var $form = jQuery(e.target).closest('form'), model = this.model, attribute, value, fields_changed = _.filter($form.serializeObject(), function (item, key) {
                    attribute = model.get(key);
                    value = jQuery.trim(item);
                    return attribute ? attribute !== value : !!value;
                });
            $form.find('[data-action="reset"]')[fields_changed.length ? 'removeClass' : 'addClass']('hide');
            return this;
        }, 300)
    });
    return Backbone.View.prototype.toggleReset;
});
define('Bootstrap.Rate', ['jQuery'], function ($) {
    'use strict';
    var Rater = function (element, options) {
        this.init(element, options);
    };
    Rater.prototype = {
        init: function (element, options) {
            this.options = options;
            this.$element = $(element);
            this.$fill = this.$element.children('.global-views-star-rating-area-fill');
            var data = this.$element.data();
            this.max = data.max;
            this.value = data.value;
            this.name = data.name;
            this.listen();
        },
        listen: function () {
            var self = this;
            this.$element.on('click.rater.data-api', function (e) {
                self.handleClick.call(self, e);
            }).on('mousemove.rater.data-api', function (e) {
                self.handleMouseMove.call(self, e);
            }).on('mouseleave.rater.data-api', function (e) {
                self.handleMouseLeave.call(self, e);
            });
        },
        handleClick: function (e) {
            e.preventDefault();
            if (e.target.tagName.toLowerCase() === 'button') {
                this.setValue(e.target.value);
            }
        },
        handleMouseMove: function (e) {
            e.preventDefault();
            if (e.target.tagName.toLowerCase() === 'button') {
                this.setFillStatus(e.target.value);
            }
        },
        handleMouseLeave: function () {
            this.setFillStatus(this.value);
        },
        setValue: function (value, silent) {
            this.value = typeof value === 'number' ? Math.round(value) : parseInt(value, 10);
            this.$element.data('value', this.value);
            this.setFillStatus(this.value);
            !silent && this.$element.trigger('rate', this);
        },
        setFillStatus: function (value) {
            this.$fill.css('width', value * 100 / this.max + '%');
        }
    };
    $.fn.rater = function (options) {
        return this.each(function () {
            var $this = $(this), data = $this.data('rater');
            if (!data) {
                $this.data('rater', data = new Rater(this, options));
            }
        });
    };
    $.fn.rater.Constructor = Rater;
    $.fn.rater.defaults = {};
    $(window).on('load', function () {
        $('[data-toggle="rater"]').rater();
    });
});
define('Bootstrap.Slider', ['jQuery'], function ($) {
    'use strict';
    var Slider = function (element, options) {
        this.init(element, options);
    };
    Slider.prototype = {
        init: function (element, options) {
            var $element = $(element), $children = $element.children();
            this.$element = $element;
            this.options = options;
            this.values = this.parseValues(options.values, $element.data());
            this.$bar = $children.filter('[data-control="bar"]');
            this.controls = {
                $low: $children.filter('[data-control="low"]'),
                $high: $children.filter('[data-control="high"]')
            };
            this.slideToInitial(true);
            this.listen();
        },
        parseValues: function (defaults, dom_data) {
            var values = {
                min: dom_data.min || defaults.min,
                max: dom_data.max || defaults.max
            };
            $.extend(values, {
                low: Math.max(dom_data.low || defaults.min, values.min),
                high: Math.min(dom_data.high || defaults.high, values.max)
            });
            return values;
        },
        listen: function () {
            var proxy = jQuery.proxy;
            this.proxyHandleMouseDown = proxy(this.handleMouseDown, this);
            this.proxyHandleMouseMove = proxy(this.handleMouseMove, this);
            this.proxyHandleMouseUp = proxy(this.handleMouseUp, this);
            this.$element.on('mousedown.slider.data-api', this.proxyHandleMouseDown).on('touchstart.slider.data-api', this.proxyHandleMouseDown);
            $('html').on('mousemove.slider.data-api', this.proxyHandleMouseMove).on('touchmove.slider.data-api', this.proxyHandleMouseMove).on('mouseup.slider.data-api', this.proxyHandleMouseUp).on('touchend.slider.data-api', this.proxyHandleMouseUp).on('touchcancel.slider.data-api', this.proxyHandleMouseUp);
        },
        stopListen: function () {
            $('html').off('mousemove.slider.data-api', this.proxyHandleMouseMove).off('touchmove.slider.data-api', this.proxyHandleMouseMove).off('mouseup.slider.data-api', this.proxyHandleMouseUp).off('touchend.slider.data-api', this.proxyHandleMouseUp).off('touchcancel.slider.data-api', this.proxyHandleMouseUp);
        },
        getMinBoundary: function () {
            return this.$element.offset().left;
        },
        getMaxBoundary: function () {
            return this.getMinBoundary() + this.$element.innerWidth();
        },
        handleMouseDown: function (e) {
            if (e.which !== 1 && e.type !== 'touchstart') {
                return;
            }
            var page_x = this.getPageX(e), $target = $(e.target);
            if ($target.is('a') || $target.is('button')) {
                if (this.values.low === this.values.max || this.values.high === this.values.min) {
                    $target = this.controls['$' + (page_x < this.$element.offset().left + this.$element.innerWidth() / 2 ? 'high' : 'low')];
                }
                this.$dragging = $target;
                this.$element.trigger('start', this);
            } else {
                this.$dragging = this.getClosestControl(page_x);
                this.slideToValue(this.getSlidValue(page_x));
            }
            e.preventDefault();
        },
        handleMouseMove: function (e) {
            if (!this.$dragging) {
                return;
            }
            var page_x = this.getPageX(e), slid_value = this.getSlidValue(page_x), is_low = this.$dragging.data('control') === 'low', value = Math[is_low ? 'min' : 'max'](slid_value, this.values[is_low ? 'high' : 'low']);
            this.slideToValue(value);
            e.preventDefault();
        },
        handleMouseUp: function (e) {
            if (!this.$dragging) {
                return;
            }
            this.$dragging = null;
            this.$element.trigger('stop', this);
            e.preventDefault();
        },
        getPageX: function (e) {
            var touch = e.originalEvent && e.originalEvent.touches ? e.originalEvent.touches[0] || e.originalEvent.changedTouches[0] : null;
            return touch ? touch.pageX : e.pageX;
        },
        getSlidValue: function (page_x) {
            var minBoundary = this.getMinBoundary(), maxBoundary = this.getMaxBoundary(), location = page_x > maxBoundary ? maxBoundary : page_x < minBoundary ? minBoundary : page_x;
            return (location - minBoundary) / this.$element.innerWidth() * this.getSizeInValue() + this.values.min;
        },
        getClosestControl: function (page_x) {
            var value = this.getSlidValue(page_x), distance_low = Math.abs(this.values.low - value), distance_high = Math.abs(this.values.high - value), $low = this.controls.$low;
            if (distance_low !== distance_high) {
                return distance_low < distance_high ? $low : this.controls.$high;
            } else {
                return page_x < $low.offset().left ? $low : this.controls.$high;
            }
        },
        getSizeInValue: function () {
            return this.values.max - this.values.min;
        },
        moveControl: function ($control, value) {
            return $control.css({ left: (value - this.values.min) * 100 / this.getSizeInValue() + '%' });
        },
        resizeBar: function () {
            return this.$bar.css({
                left: (this.values.low - this.values.min) * 100 / this.getSizeInValue() + '%',
                width: (this.values.high - this.values.low) / this.getSizeInValue() * 100 + '%'
            });
        },
        slideToInitial: function (trigger) {
            this.slideControls();
            this.resizeBar();
            if (trigger) {
                this.$element.trigger('slide', this);
            }
        },
        slideControls: function () {
            this.moveControl(this.controls.$low, this.values.low);
            this.moveControl(this.controls.$high, this.values.high);
        },
        slideToValue: function (value) {
            var is_low = this.$dragging.data('control') === 'low';
            this.values[is_low ? 'low' : 'high'] = value;
            this.moveControl(this.$dragging, value);
            this.resizeBar();
            this.$element.trigger('slide', this);
        }
    };
    $.fn.slider = function (option) {
        return this.each(function () {
            var $this = $(this), data = $this.data('slider');
            if (!data) {
                var options = $.extend({}, $.fn.slider.defaults, typeof option === 'object' && options);
                $this.data('slider', data = new Slider(this, options));
            }
        });
    };
    $.fn.slider.Constructor = Slider;
    $.fn.slider.defaults = {
        values: {
            min: 0,
            max: 100
        }
    };
    $(window).on('load', function () {
        $('[data-toggle="slider"]').slider();
    });
});
define('jQuery.serializeObject', ['jQuery'], function (jQuery) {
    'use strict';
    jQuery.fn.serializeObject = function () {
        var o = {}, a = this.serializeArray();
        this.find('input[type=checkbox]:not(:checked)[data-unchecked-value]').each(function () {
            var $this = jQuery(this);
            a.push({
                name: $this.prop('name'),
                value: $this.data('unchecked-value')
            });
        });
        jQuery.each(a, function () {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };
    return jQuery.fn.serializeObject;
});
define('SC.Shopping', [
    'SC.Shopping.Configuration',
    'Application',
    'SC.Shopping.Layout',
    'Backbone',
    'jQuery',
    'underscore',
    'Utils',
    'Backbone.Model',
    'Backbone.Sync',
    'Backbone.Validation.callbacks',
    'Backbone.Validation.patterns',
    'Backbone.View',
    'Backbone.View.render',
    'Backbone.View.saveForm',
    'Backbone.View.toggleReset',
    'Bootstrap.Rate',
    'Bootstrap.Slider',
    'jQuery.ajaxSetup',
    'jQuery.serializeObject',
    'jQuery.scPush',
    'String.format'
], function (Configuration, Application, ShoppingLayout, Backbone, jQuery, _, Utils) {
    'use strict';
    var Shopping = Application('Shopping');
    Shopping.Layout = ShoppingLayout;
    var Layout = Shopping.getLayout();
    Shopping.Configuration = _.extend(Shopping.Configuration, Configuration);
    _.extend(Layout, {
        changeUrl: function (e) {
            this.$('select[data-type="navigator"], .pagination-links a').attr('disabled', 'disabled');
            Backbone.history.navigate(this.$(e.target).val(), { trigger: true });
        }
    });
    _.extend(Layout.events, { 'change select[data-type="navigator"]': 'changeUrl' });
    _.extend(Shopping, {
        CaseModule: {
            isEnabled: function () {
                return !_.isUndefined(SC.ENVIRONMENT.CASES) && !_.isUndefined(SC.ENVIRONMENT.CASES.CONFIG) && SC.ENVIRONMENT.CASES.enabled;
            }
        }
    });
    jQuery.ajaxSetup({ cache: true });
    jQuery.ajaxPrefilter(function (options) {
        if (options.url) {
            if (options.type === 'GET' && options.data) {
                var join_string = ~options.url.indexOf('?') ? '&' : '?';
                options.url = options.url + join_string + options.data;
                options.data = '';
            }
            options.url = Utils.reorderUrlParams(options.url);
        }
        if (options.pageGeneratorPreload && SC.ENVIRONMENT.jsEnvironment === 'server') {
            jQuery('<img />', {
                src: options.url,
                alt: '',
                style: 'display: none;'
            }).prependTo('body');
        }
    });
    return Shopping;
});
define('ReferenceMap.Configuration', [], function () {
    'use strict';
    var configuration = {
        mapOptions: function () {
        },
        iconOptions: function () {
        },
        zoomInDetails: function () {
        },
        title: function () {
        },
        isEnabled: function () {
        },
        getUrl: function () {
        },
        getApiKey: function () {
        },
        getExtraData: function () {
        },
        getRadius: function () {
        },
        openPopupOnMouseOver: function () {
        },
        showLocalizationMap: function () {
        },
        showAllStoresRecordsPerPage: function () {
        }
    };
    return configuration;
});
define('ReferenceMap', [
    'ReferenceMap.Configuration',
    'underscore',
    'Backbone',
    'jQuery',
    'Utils'
], function (ReferenceMapConfiguration, _, Backbone, jQuery) {
    'use strict';
    var ReferenceMap = function ReferenceMap() {
        this.configuration = ReferenceMapConfiguration;
        this.map = null;
        this.points = [];
        this.myposition = {};
    };
    ReferenceMap.prototype.load = function load() {
    };
    ReferenceMap.prototype.isInitialize = function isInitialized() {
    };
    ReferenceMap.prototype.showMap = function showMap() {
    };
    ReferenceMap.prototype.centerMapToDefault = function centerMapToDefault() {
    };
    ReferenceMap.prototype.showPoint = function showPoint() {
    };
    ReferenceMap.prototype.removePoint = function removePoint() {
    };
    ReferenceMap.prototype.showAutoCompleteInput = function showAutoCompleteInput() {
    };
    ReferenceMap.prototype.autoCompleteChange = function autoCompleteChange() {
    };
    ReferenceMap.prototype.showPosition = function showPosition() {
    };
    ReferenceMap.prototype.showPointList = function showPointList(list, map) {
        var self = this;
        list.each(function (point) {
            self.points.push(self.showPoint(point, map));
        });
    };
    ReferenceMap.prototype.showPointWithoutInfoWindow = function showPointWithoutInfoWindow() {
    };
    ReferenceMap.prototype.getInfoWindow = function getInfoWindow() {
    };
    ReferenceMap.prototype.getTooltip = function getTooltip() {
    };
    ReferenceMap.prototype.showInfoWindow = function showInfoWindow() {
    };
    ReferenceMap.prototype.showInfoWindowOnClick = function showInfoWindowOnClick() {
    };
    ReferenceMap.prototype.clearPointList = function clearPointList() {
        var self = this;
        _.each(this.points, function (point) {
            self.removePoint(point);
        });
        this.points = [];
    };
    ReferenceMap.prototype.fitBounds = function fitBounds() {
    };
    ReferenceMap.prototype.getCityGeoCode = function getCityGeoCode() {
    };
    ReferenceMap.prototype.zoomToPoint = function zoomToPoint() {
    };
    ReferenceMap.prototype.getDirectionsUrl = function getDirectionsUrl(source, destination) {
        source;
        destination;
    };
    ReferenceMap.prototype.getCurrentPositionGeolocation = function getCurrentPositionGeolocation() {
        var promise = jQuery.Deferred(), self = this;
        navigator.geolocation.getCurrentPosition(function (position) {
            self.setPosition({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                address: ''
            });
            promise.resolveWith(self, [self.myposition]);
        }, function () {
            promise.rejectWith(self, arguments);
        });
        return promise;
    };
    ReferenceMap.prototype.setPosition = function (position) {
        this.myposition = position ? position : { refineSearch: true };
        this.trigger('change:position', this.myposition);
    };
    ReferenceMap.prototype.getPosition = function () {
        return this.myposition || {};
    };
    _.extend(ReferenceMap.prototype, Backbone.Events);
    return ReferenceMap;
});
define('StoreLocator.Tooltip.View', [
    'ReferenceMap',
    'store_locator_tooltip.tpl',
    'underscore',
    'Backbone.CollectionView',
    'Backbone'
], function (ReferenceMap, store_locator_tooltip_tpl, _, BackboneCollectionView, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_tooltip_tpl,
        initialize: function initialize(options) {
            this.application = options.application;
            this.index = options.index;
        },
        getContext: function getContext() {
            return {
                model: this.model,
                storeName: this.model.get('name'),
                showStoreDistance: !!this.model.get('distance'),
                distanceUnit: this.model.get('distanceunit'),
                storeDistance: this.model.get('distance'),
                showStoreAddress: !!this.model.get('address1'),
                storeAddress: this.model.get('address1'),
                storeId: this.model.get('internalid'),
                index: this.index
            };
        }
    });
});
define('ReferenceMap.Promise.Handler', [], function () {
    'use strict';
    var instance = null;
    function ReferenceMapPromiseHandler() {
        if (instance !== null) {
            throw new Error('Cannot instantiate more than one ReferenceMapPromiseHandler, use ReferenceMapPromiseHandler.getInstance()');
        }
        this.initialize();
    }
    ReferenceMapPromiseHandler.prototype = {
        initialize: function () {
            this.promise = null;
        },
        setPromise: function (promise) {
            this.promise = promise;
        },
        getPromise: function () {
            return this.promise;
        }
    };
    ReferenceMapPromiseHandler.getInstance = function () {
        if (instance === null) {
            instance = new ReferenceMapPromiseHandler();
        }
        return instance;
    };
    return ReferenceMapPromiseHandler.getInstance();
});
define('GoogleMap', [
    'Backbone',
    'jQuery',
    'underscore',
    'ReferenceMap',
    'StoreLocator.Tooltip.View',
    'ReferenceMap.Promise.Handler'
], function (Backbone, jQuery, _, ReferenceMap, StoreLocatorTooltip, PromiseHandler) {
    'use strict';
    ReferenceMap.prototype.isInitialized = function isInitialized() {
        return typeof google === 'object' && typeof google.maps === 'object';
    };
    ReferenceMap.prototype.load = function load() {
        var url = this.configuration.getUrl(), handler = PromiseHandler;
        if (!handler.getPromise() && !this.isInitialized()) {
            var promise = jQuery.getScript(url).done(function () {
                ReferenceMap.prototype.initialized = true;
            });
            this.load_promise = promise;
            handler.setPromise(promise);
        }
        return handler.getPromise();
    };
    ReferenceMap.prototype.showMap = function showMap(container) {
        var map_configuration = this.configuration.mapOptions(), map_options = {
                center: new google.maps.LatLng(map_configuration.centerPosition.latitude, map_configuration.centerPosition.longitude),
                zoom: map_configuration.zoom,
                mapTypeControl: map_configuration.mapTypeControl,
                streetViewControl: map_configuration.streetViewControl,
                mapTypeId: google.maps.MapTypeId[map_configuration.mapTypeId],
                disableDefaultUI: true
            };
        var map = new google.maps.Map(container, map_options);
        var self = this;
        google.maps.event.addListener(map, 'tilt_changed', _.bind(function () {
            google.maps.event.trigger(map, 'resize');
            if (!!this.points.length) {
                this.fitBounds(map);
            } else if (this.detail_point) {
                this.fitBounds(map);
                map.setCenter(map.getCenter());
                map.setZoom(this.configuration.zoomInDetails());
            } else {
                this.centerMapToDefault(map);
            }
        }, this));
        this.map = map;
        return map;
    };
    ReferenceMap.prototype.centerMapToDefault = function centerMapToDefault(map) {
        map = this.map || map;
        if (!map) {
            return;
        }
        map.myPositionMarker && map.myPositionMarker.setMap(null);
        var map_options = this.configuration.mapOptions();
        map.setZoom(map_options.zoom);
        map.setCenter(new google.maps.LatLng(parseInt(map_options.centerPosition.latitude, 10), parseInt(map_options.centerPosition.longitude, 10)));
    };
    ReferenceMap.prototype.getInfoWindow = function getInfoWindow() {
        if (!this.infowindow) {
            this.infowindow = new google.maps.InfoWindow();
        }
        return this.infowindow;
    };
    ReferenceMap.prototype.getTooltip = function getTooltip(model, index) {
        if (!this.tooltip) {
            this.tooltip = new StoreLocatorTooltip({
                model: model,
                index: index
            });
        } else {
            this.tooltip.index = index;
            this.tooltip.model = model;
        }
        return this.tooltip;
    };
    ReferenceMap.prototype.showPoint = function showPoint(point, map) {
        map = map || this.map;
        if (!map) {
            return;
        }
        var location = point.get('location'), marker = new google.maps.Marker({
                store_id: point.get('internalid'),
                icon: this.configuration.iconOptions('stores'),
                map: map
            });
        marker.setPosition(new google.maps.LatLng(location.latitude, location.longitude));
        marker.setVisible(true);
        marker.addListener('click', _.bind(function () {
            this.showInfoWindowOnClick(marker, map);
        }, this));
        return marker;
    };
    ReferenceMap.prototype.showPointWithoutInfoWindow = function showPointWithoutInfoWindow(point, map) {
        map = map || this.map;
        if (!map) {
            return;
        }
        var location = point.get('location'), marker = new google.maps.Marker({
                store_id: point.get('internalid'),
                icon: this.configuration.iconOptions('stores'),
                map: map
            });
        marker.setPosition(new google.maps.LatLng(location.latitude, location.longitude));
        marker.setVisible(true);
        this.detail_point = marker;
        return marker;
    };
    ReferenceMap.prototype.showInfoWindowOnClick = function showInfoWindowOnClick(marker, map) {
        var point = this.collection.find({ 'id': marker.store_id }), index = this.collection.indexOf(point) + 1;
        this.showInfoWindow(marker, point, index, map);
    };
    ReferenceMap.prototype.showInfoWindow = function showInfoWindow(marker, model, index, map) {
        map = map || this.map;
        if (!map) {
            return;
        }
        var tooltip = this.getTooltip(model, index), info_window = this.getInfoWindow();
        info_window.setContent(tooltip.template(tooltip.getContext()));
        info_window.open(map, marker);
    };
    ReferenceMap.prototype.showMyPosition = function showMyPosition(position, map) {
        position = position || this.myposition;
        map = map || this.map;
        if (!position || !map) {
            return;
        }
        if (map.myPositionMarker) {
            map.myPositionMarker.setMap(null);
        }
        map.myPositionMarker = new google.maps.Marker({
            icon: this.configuration.iconOptions('position'),
            map: map
        });
        position.location = position.location || new google.maps.LatLng(position.latitude, position.longitude);
        map.myPositionMarker.setPosition(position.location);
        map.myPositionMarker.setVisible(true);
        if (position.viewport) {
            map.fitBounds(position.viewport);
        } else {
            var map_options = this.configuration.mapOptions();
            map.setCenter(position.location);
            map.setZoom(map_options.zoom);
        }
        return map.myPositionMarker;
    };
    ReferenceMap.prototype.removePoint = function removePoint(point) {
        point.setMap(null);
    };
    ReferenceMap.prototype.showAutoCompleteInput = function showAutoCompleteInput(input) {
        var self = this;
        if (input) {
            this.autocomplete = new google.maps.places.SearchBox(input);
            google.maps.event.addListener(this.autocomplete, 'places_changed', function () {
                self.autocompleteChange();
                self.trigger('change:places', self.autocomplete.getPlaces());
            });
        }
        return this.autocomplete;
    };
    ReferenceMap.prototype.autocompleteChange = function autocompleteChange() {
        var place = this.autocomplete && this.autocomplete.getPlaces() && this.autocomplete.getPlaces()[0];
        if (!place || _.size(place) === 0) {
            console.warn('Autocomplete returned place contains no geometry');
            return;
        }
        if (!place.geometry) {
            console.warn('Autocomplete returned place contains no geometry');
            return;
        }
        if (place.geometry.location) {
            this.setPosition({
                latitude: place.geometry.location.lat(),
                longitude: place.geometry.location.lng(),
                address: place.formatted_address,
                viewport: place.geometry.viewport,
                location: place.geometry.location
            });
        }
    };
    ReferenceMap.prototype.fitBounds = function fitBounds(map) {
        map = map || this.map;
        if (!map) {
            return;
        }
        var bounds = new google.maps.LatLngBounds();
        _.each(this.points, function (point) {
            var location = point.getPosition();
            bounds.extend(new google.maps.LatLng(location.lat(), location.lng()));
        });
        if (!_.isUndefined(this.myposition.latitude) && !_.isUndefined(this.myposition.longitude)) {
            bounds.extend(new google.maps.LatLng(this.myposition.latitude, this.myposition.longitude));
        }
        if (!!this.detail_point) {
            bounds.extend(new google.maps.LatLng(this.detail_point.position.lat(), this.detail_point.position.lng()));
        }
        map.fitBounds(bounds);
    };
    ReferenceMap.prototype.getCityGeoCode = function getCityGeoCode() {
        var promise = jQuery.Deferred(), geoCoder = new google.maps.Geocoder(), position = this.myposition, latlng = {
                lat: parseFloat(position.latitude),
                lng: parseFloat(position.longitude)
            }, self = this;
        geoCoder.geocode({ location: latlng }, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                var city = _(results).find(function (result) {
                    return !_.indexOf(result.types, 'locality');
                });
                if (city) {
                    self.myposition.address = city.formatted_address;
                } else {
                    self.myposition.address = results[0].formatted_address;
                }
                self.trigger('change:position', self.myposition);
                promise.resolve();
            } else {
                promise.always();
                console.warn('Geocoder failed due to: ' + status);
            }
        });
        return promise;
    };
    ReferenceMap.prototype.zoomToPoint = function zoomToPoint(marker, map) {
        map = map || this.map;
        if (!map) {
            return;
        }
        map.setZoom(this.configuration.zoomInDetails());
        map.panTo(marker.position);
    };
    ReferenceMap.prototype.getDirectionsUrl = function getDirectionsUrl(source, destination) {
        var source_parameter = source ? source.latitude + ',' + source.longitude : 'Current+Location', destination_parameter = (destination && destination.latitude) + ',' + (destination && destination.longitude);
        return 'https://maps.google.com?saddr=' + source_parameter + '&daddr=' + destination_parameter;
    };
});
define('GoogleMap.Configuration', [
    'ReferenceMap.Configuration',
    'SC.Configuration',
    'underscore',
    'Utils'
], function (ReferenceMapConfiguration, Configuration, _) {
    'use strict';
    ReferenceMapConfiguration.mapOptions = function mapOptions() {
        return Configuration.get('storeLocator.mapOptions');
    };
    ReferenceMapConfiguration.iconOptions = function iconOptions(attr) {
        if (attr) {
            return Configuration.get('storeLocator.icons')[attr];
        } else {
            return Configuration.get('storeLocator.icons');
        }
    };
    ReferenceMapConfiguration.zoomInDetails = function zoomInDetails() {
        return Configuration.get('storeLocator.zoomInDetails');
    };
    ReferenceMapConfiguration.title = function title() {
        return Configuration.get('storeLocator.title');
    };
    ReferenceMapConfiguration.isEnabled = function isEnabled() {
        return Configuration.get('storeLocator.isEnabled');
    };
    ReferenceMapConfiguration.getUrl = function getUrl() {
        return 'https://maps.googleapis.com/maps/api/js?v=3.21&key=' + Configuration.get('storeLocator.apiKey') + '&signed_in=false&libraries=places';
    };
    ReferenceMapConfiguration.getApiKey = function getApiKey() {
        return Configuration.get('storeLocator.apiKey');
    };
    ReferenceMapConfiguration.getExtraData = function getExtraData() {
        return Configuration.get('storeLocator.additionalStoresData');
    };
    ReferenceMapConfiguration.getRadius = function getRadius() {
        return Configuration.get('storeLocator.radius');
    };
    ReferenceMapConfiguration.openPopupOnMouseOver = function openPopupOnMouseOver() {
        return Configuration.get('storeLocator.openPopupOnMouseOver');
    };
    ReferenceMapConfiguration.showLocalizationMap = function showLocalizationMap() {
        return Configuration.get('storeLocator.showLocalizationMap');
    };
    ReferenceMapConfiguration.showAllStoresRecordsPerPage = function showAllStoresRecordsPerPage() {
        return Configuration.get('storeLocator.showAllStoresRecordsPerPage');
    };
    return ReferenceMapConfiguration;
});
define('Backbone.View.Plugin.ApplyPermissions', [
    'Backbone.View.render',
    'underscore',
    'jQuery'
], function (BackboneView, _, jQuery) {
    'use strict';
    return {
        mountToApp: function () {
            if (!_.result(SC, 'isPageGenerator')) {
                BackboneView.postRender.install({
                    name: 'applyPermissions',
                    priority: 10,
                    execute: function (template) {
                        var $permissioned_elements = template.find('[data-permissions]');
                        $permissioned_elements.each(function () {
                            var $el = jQuery(this), element_permission = $el.data('permissions'), perms = element_permission.split(/[\s,]+/), perm_operator = $el.data('permissions-operator') || 'AND', perm_eval, perm_evaluation = perm_operator !== 'OR';
                            _.each(perms, function (perm) {
                                var perm_tokens = perm.split('.');
                                perm_eval = !(perm_tokens.length === 3 && perm_tokens[2] < 5 && SC.ENVIRONMENT.permissions && SC.ENVIRONMENT.permissions[perm_tokens[0]] && SC.ENVIRONMENT.permissions[perm_tokens[0]][perm_tokens[1]] < perm_tokens[2]);
                                if (perm_operator === 'OR') {
                                    perm_evaluation = perm_evaluation || perm_eval;
                                } else {
                                    perm_evaluation = perm_evaluation && perm_eval;
                                }
                            });
                            if (!perm_evaluation) {
                                $el.remove();
                            }
                        });
                        return template;
                    }
                });
            }
        }
    };
});
define('Backbone.View.Plugin.Bootstrap', [
    'Backbone.View.render',
    'underscore'
], function (BackboneView, _) {
    'use strict';
    return {
        mountToApp: function () {
            if (!_.result(SC, 'isPageGenerator')) {
                BackboneView.postRender.install({
                    name: 'HTMLBootstrap',
                    priority: 10,
                    execute: function ($el, view) {
                        view.$('[data-toggle="tooltip"]').tooltip({ html: true });
                        view.$('[data-toggle="dropdown"]').dropdown();
                    }
                });
            }
        }
    };
});
define('Backbone.View.Plugin.DatePicker', [
    'Backbone.View.render',
    'underscore',
    'jQuery',
    'bootstrap-datepicker'
], function (BackboneView, _, jQuery) {
    'use strict';
    return {
        mountToApp: function () {
            if (!_.result(SC, 'isPageGenerator')) {
                BackboneView.postRender.install({
                    name: 'datePicker',
                    priority: 10,
                    execute: function ($el, view) {
                        if (_.isNativeDatePickerSupported() === false || _.isDesktopDevice()) {
                            view.$('input[type="date"]').each(function () {
                                var $date_picker = jQuery(this);
                                try {
                                    $date_picker.attr('type', 'text');
                                } catch (ex) {
                                }
                                $date_picker.datepicker({
                                    format: $date_picker.data('format'),
                                    startDate: $date_picker.data('start-date'),
                                    endDate: $date_picker.data('end-date'),
                                    autoclose: true,
                                    todayHighlight: $date_picker.data('todayhighlight')
                                });
                            });
                        }
                    }
                });
            }
        }
    };
});
define('Backbone.View.Plugin.DebugTemplateName', [
    'Backbone.View.render',
    'Utils',
    'underscore'
], function (BackboneView, Utils, _) {
    'use strict';
    return {
        mountToApp: function () {
            if (!_.result(SC, 'isPageGenerator')) {
                BackboneView.postCompile.install({
                    name: 'debugTemplateName',
                    priority: 10,
                    execute: function (tmpl_str, view) {
                        var template_name = view.template.Name, prefix = Utils.isPageGenerator() ? '' : '\n\n<!-- TEMPLATE STARTS: ' + template_name + '-->\n', posfix = Utils.isPageGenerator() ? '' : '\n<!-- TEMPLATE ENDS: ' + template_name + ' -->\n';
                        tmpl_str = prefix + tmpl_str + posfix;
                        return tmpl_str;
                    }
                });
            }
        }
    };
});
define('Backbone.View.Plugin.OldIEFix', [
    'Backbone.View.render',
    'Utils'
], function (BackboneView, Utils) {
    'use strict';
    return {
        mountToApp: function () {
            if (Utils.oldIE()) {
                BackboneView.postCompile.install({
                    name: 'oldIEFix',
                    priority: 20,
                    execute: function (tmpl_str) {
                        return (tmpl_str || '').replace(/href="(.+?)(?=")/g, '$&" data-href="$1');
                    }
                });
            }
        }
    };
});
define('Backbone.View.Plugin.PageGeneratorImages', [
    'Backbone.View.render',
    'underscore'
], function (BackboneView, _) {
    'use strict';
    return {
        mountToApp: function () {
            if (_.result(SC, 'isPageGenerator')) {
                BackboneView.postCompile.install({
                    name: 'pageGeneratorWrapImagesNoscript',
                    priority: 30,
                    execute: function (tmpl_str) {
                        return tmpl_str.replace(/(<img\s+[^>]*>\s*<\/img>|<img\s+[^>]*\/>|(?:<img\s+[^>]*>)(?!\s*<\/img>))(?!\s*<\s*\/noscript\s*>)/gim, '<noscript>$1</noscript>');
                    }
                });
            }
        }
    };
});
define('Backbone.View.Plugins', [
    'Backbone.View.Plugin.ApplyPermissions',
    'Backbone.View.Plugin.Bootstrap',
    'Backbone.View.Plugin.DatePicker',
    'Backbone.View.Plugin.DebugTemplateName',
    'Backbone.View.Plugin.OldIEFix',
    'Backbone.View.Plugin.PageGeneratorImages'
], function () {
    'use strict';
    var plugins = arguments;
    return {
        mountToApp: function () {
            console.warn('DEPRECATED: Backbone.View.Plugin is deprecated. Include dependencies using ' + ' require("Backbone.Plugin.{Your neeeded plugin}") instead');
            for (var i = 0; i < plugins.length; ++i) {
                plugins[i].mountToApp.apply(this, arguments);
            }
        }
    };
});
define('Location.Model', [
    'Backbone.CachedModel',
    'Utils'
], function (BackboneCachedModel, Utils) {
    'use strict';
    return BackboneCachedModel.extend({
        urlRoot: Utils.getAbsoluteUrl('services/Location.Service.ss'),
        toString: function toString() {
            return this.get('internalid') || '';
        }
    });
});
define('Location.Collection', [
    'Location.Model',
    'underscore',
    'Backbone.CachedCollection'
], function (LocationModel, _, BackboneCachedCollection) {
    'use strict';
    return BackboneCachedCollection.extend({
        model: LocationModel,
        url: _.getAbsoluteUrl('services/Location.Service.ss'),
        parse: function parse(response) {
            if (!_.isUndefined(response.totalRecordsFound)) {
                this.totalRecordsFound = response.totalRecordsFound;
                this.recordsPerPage = response.recordsPerPage;
                return response.records;
            } else {
                return response;
            }
        },
        update: function update(options, callbacks) {
            return this.fetch(_.extend({
                data: {
                    latitude: options.latitude,
                    longitude: options.longitude,
                    radius: options.radius,
                    sort: options.sort,
                    page: options.page,
                    locationtype: options.locationtype,
                    results_per_page: options.results_per_page
                },
                reset: !!options.reset,
                killerId: options.killerId
            }, callbacks));
        }
    });
});
(function (factory) {
    if (typeof define === 'function' && define.amd) {
        define('jquery.cookie', ['jQuery'], factory);
    } else if (typeof exports === 'object') {
        factory(require('jquery'));
    } else {
        factory(jQuery);
    }
}(function ($) {
    var pluses = /\+/g;
    function encode(s) {
        return config.raw ? s : encodeURIComponent(s);
    }
    function decode(s) {
        return config.raw ? s : decodeURIComponent(s);
    }
    function stringifyCookieValue(value) {
        return encode(config.json ? JSON.stringify(value) : String(value));
    }
    function parseCookieValue(s) {
        if (s.indexOf('"') === 0) {
            s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
        }
        try {
            s = decodeURIComponent(s.replace(pluses, ' '));
            return config.json ? JSON.parse(s) : s;
        } catch (e) {
        }
    }
    function read(s, converter) {
        var value = config.raw ? s : parseCookieValue(s);
        return $.isFunction(converter) ? converter(value) : value;
    }
    var config = $.cookie = function (key, value, options) {
        if (arguments.length > 1 && !$.isFunction(value)) {
            options = $.extend({}, config.defaults, options);
            if (typeof options.expires === 'number') {
                var days = options.expires, t = options.expires = new Date();
                t.setTime(+t + days * 86400000);
            }
            return document.cookie = [
                encode(key),
                '=',
                stringifyCookieValue(value),
                options.expires ? '; expires=' + options.expires.toUTCString() : '',
                options.path ? '; path=' + options.path : '',
                options.domain ? '; domain=' + options.domain : '',
                options.secure ? '; secure' : ''
            ].join('');
        }
        var result = key ? undefined : {};
        var cookies = document.cookie ? document.cookie.split('; ') : [];
        for (var i = 0, l = cookies.length; i < l; i++) {
            var parts = cookies[i].split('=');
            var name = decode(parts.shift());
            var cookie = parts.join('=');
            if (key && key === name) {
                result = read(cookie, value);
                break;
            }
            if (!key && (cookie = read(cookie)) !== undefined) {
                result[name] = cookie;
            }
        }
        return result;
    };
    config.defaults = {};
    $.removeCookie = function (key, options) {
        if ($.cookie(key) === undefined) {
            return false;
        }
        $.cookie(key, '', $.extend({}, options, { expires: -1 }));
        return !$.cookie(key);
    };
}));
define('Location.ProductLine', [
    'Product.Model',
    'Transaction.Line.Model',
    'ProductLine.Common',
    'Location.Model',
    'underscore',
    'Backbone'
], function (ProductModel, TransactionLineModel, ProductLineCommon, LocationModel, _, Backbone) {
    'use strict';
    var initialize_location = function (attributes) {
        this.on('change:location', function (model, location) {
            var value;
            if (location instanceof LocationModel || location instanceof Backbone.Model) {
                value = location.clone();
            } else if (_.isObject(location)) {
                value = new LocationModel(location);
            } else {
                value = new LocationModel({ internalid: location });
            }
            model.set('location', value, { silent: true });
        });
        this.trigger('change:location', this, attributes && attributes.location || {});
    };
    var original_product_model_initialize_fn = ProductModel.prototype.initialize;
    ProductModel.prototype.initialize = function initialize() {
        original_product_model_initialize_fn.apply(this, arguments);
        initialize_location.apply(this, arguments);
    };
    var original_transaction_line_model_initialize_fn = TransactionLineModel.prototype.initialize;
    TransactionLineModel.prototype.initialize = function initialize() {
        original_transaction_line_model_initialize_fn.apply(this, arguments);
        initialize_location.apply(this, arguments);
    };
    var original_to_json_product_line_common_fn = ProductLineCommon.toJSON;
    ProductLineCommon.toJSON = function toJSON() {
        var result = original_to_json_product_line_common_fn.apply(this, arguments);
        result.location = this.attributes.location && this.attributes.location.attributes && this.attributes.location.attributes.internalid || '';
        result.fulfillmentChoice = this.attributes.fulfillmentChoice || 'ship';
        return result;
    };
});
define('Location', [
    'Location.Collection',
    'Location.Model',
    'Transaction.Model',
    'underscore',
    'jQuery',
    'jquery.cookie',
    'Location.ProductLine'
], function (LocationCollection, LocationModel, TransactionModel, _, jQuery) {
    'use strict';
    var locations_cache = {};
    function fetchLocations(location_ids) {
        location_ids = _.isArray(location_ids) ? location_ids : [location_ids];
        var location_id_to_fetch = _.filter(location_ids, function (internalid) {
                return !locations_cache[internalid] ? internalid : false;
            }), promise = jQuery.Deferred();
        location_ids = _.unique(_.compact(location_ids));
        if (location_id_to_fetch.length) {
            if (location_id_to_fetch.length === 1) {
                promise = new LocationModel({ internalid: location_id_to_fetch[0] }).fetch().done(function (location) {
                    locations_cache[location.internalid] = location;
                });
            } else {
                promise = new LocationCollection().fetch({ data: { internalid: location_id_to_fetch.join(',') } }).done(function (locations) {
                    _.each(locations, function (location) {
                        locations_cache[location.internalid] = location;
                    });
                });
            }
        } else {
            promise.resolve();
        }
        return promise;
    }
    return {
        get: function (location_id) {
            return locations_cache[location_id] || {};
        },
        fetchLocations: fetchLocations,
        mountToApp: function mountToApp() {
            var original_transaction_model_fn = TransactionModel.prototype.initialize;
            TransactionModel.prototype.initialize = function initialize() {
                original_transaction_model_fn.apply(this, arguments);
                this.on('change:lines', function (model) {
                    var default_location_id = jQuery.cookie('myStore'), lines = model.get('lines'), is_cart = this.get('internalid') === 'cart', location_ids = lines.map(function (line) {
                            return line.get('location') && line.get('location').get('internalid');
                        });
                    if (!location_ids.length) {
                        return;
                    }
                    if (is_cart && default_location_id) {
                        location_ids.push(default_location_id);
                    }
                    fetchLocations(location_ids).done(function () {
                        lines.each(function (line) {
                            var internalid = line.get('location') && line.get('location').get('internalid') || (is_cart ? default_location_id : null);
                            if (internalid) {
                                line.get('location').set(locations_cache[internalid]);
                            }
                        });
                    });
                });
            };
        }
    };
});
define('jQuery.html', [
    'jQuery',
    'Utils'
], function (jQuery, utils) {
    'use strict';
    return {
        mountToApp: function () {
            if (utils.isPageGenerator()) {
                var jQuery_originalHtml = jQuery.fn.html;
                jQuery.fn.html = function (html) {
                    if (typeof html === 'string') {
                        html = utils.minifyMarkup(html);
                        html = utils.removeScripts(html);
                    }
                    return jQuery_originalHtml.apply(this, [html]);
                };
                var jQuery_originalAppend = jQuery.fn.append;
                jQuery.fn.append = function (html) {
                    if (typeof html === 'string') {
                        html = utils.minifyMarkup(html);
                        html = utils.removeScripts(html);
                    }
                    return jQuery_originalAppend.apply(this, [html]);
                };
            }
        }
    };
});
define('Cart.Confirmation.View', [
    'Transaction.Line.Views.Price.View',
    'Backbone.CompositeView',
    'Transaction.Line.Views.Options.Selected.View',
    'ProductLine.Sku.View',
    'cart_confirmation_modal.tpl',
    'Backbone',
    'underscore',
    'Utils'
], function (TransactionLineViewsPriceView, BackboneCompositeView, TransactionLineViewsOptionsSelectedView, ProductLineSkuView, cart_confirmation_modal_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_confirmation_modal_tpl,
        title: _('Added to Cart').translate(),
        modalClass: 'global-views-modal-large',
        page_header: _('Added to Cart').translate(),
        attributes: {
            'id': 'Cart.Confirmation.View',
            'class': 'add-to-cart-confirmation-modal shopping-cart-modal'
        },
        initialize: function () {
            this.model.on('change', this.render, this);
            BackboneCompositeView.add(this);
        },
        destroy: function destroy() {
            this.model.off('change', this.render, this);
            this._destroy();
        },
        childViews: {
            'Line.Price': function () {
                return new TransactionLineViewsPriceView({ model: this.model });
            },
            'Line.SelectedOptions': function () {
                return new TransactionLineViewsOptionsSelectedView({ model: this.model });
            },
            'Line.Sku': function () {
                return new ProductLineSkuView({ model: this.model });
            }
        },
        getContext: function () {
            var item = this.model.get('item');
            return {
                model: this.model,
                thumbnail: this.model.getThumbnail(),
                showQuantity: item.get('_itemType') !== 'GiftCert' && this.model.get('quantity') > 0,
                itemName: item.get('_name', true)
            };
        }
    });
});
define('Cart.Confirmation.Helpers', [
    'LiveOrder.Model',
    'Cart.Confirmation.View',
    'SC.Configuration',
    'ErrorManagement.ResponseErrorParser',
    'Backbone',
    'Utils',
    'jQuery',
    'underscore'
], function (LiveOrderModel, CartConfirmationView, Configuration, ErrorManagementResponseErrorParser, Backbone, Utils, jQuery, _) {
    'use strict';
    return {
        showCartConfirmation: function showCartConfirmation(cart_promise, line, application) {
            this['_' + Configuration.get('addToCartBehavior', 'showCartConfirmationModal')](cart_promise, line, application);
            var layout = application.getLayout();
            cart_promise.fail(function (error) {
                var output_message = '', error_object = error && error.responseJSON || {}, error_message = ErrorManagementResponseErrorParser(error, layout.errorMessageKeys);
                if (error_object.errorCode === 'ERR_EXT_CANCELED_OPERATION' && error_message) {
                    output_message = error_message;
                } else {
                    output_message = _('Sorry, there is a problem with this Item and can not be purchased at this time. Please check back later.').translate();
                }
                layout.showErrorInModal(output_message);
            });
        },
        _showCartConfirmationModal: function _showCartConfirmationModal(cart_promise, line, application) {
            if (line.isNew()) {
                return this._showOptimisticCartConfirmation(cart_promise, line, application);
            } else {
                cart_promise.done(function () {
                    var view = new CartConfirmationView({
                        application: application,
                        model: LiveOrderModel.getInstance().getLatestAddition()
                    });
                    view.showInModal();
                });
            }
        },
        _showOptimisticCartConfirmation: function _showOptimisticCartConfirmation(cart_promise, line, application) {
            if (LiveOrderModel.loadCart().state() === 'resolved') {
                var cart_model = LiveOrderModel.getInstance(), cart_line = cart_model.findLine(line);
                if (cart_line) {
                    if (line.get('source') !== 'cart') {
                        cart_line.set('quantity', cart_line.get('quantity') + parseInt(line.get('quantity'), 10));
                    } else {
                        cart_line.set('quantity', line.get('quantity'));
                    }
                    cart_promise.fail(function () {
                        cart_line.set('quantity', cart_line.previous('quantity'));
                    });
                    line = cart_line;
                } else {
                    cart_model.get('lines').add(line, { at: 0 });
                    cart_promise.fail(function () {
                        cart_model.get('lines').remove(line);
                    });
                }
            }
            var view = new CartConfirmationView({
                application: application,
                model: line
            });
            cart_promise.done(function () {
                view.model = cart_model.getLatestAddition();
                view.render();
            });
            view.showInModal();
        },
        _goToCart: function _goToCart(cart_promise) {
            cart_promise.done(function () {
                Backbone.history.navigate('cart', { trigger: true });
            });
        },
        _showMiniCart: function _showMiniCart(cart_promise, line, application) {
            var layout = application.getLayout();
            cart_promise.done(function () {
                jQuery(document).scrollTop(0);
                layout.closeModal().done(function () {
                    layout.headerViewInstance && layout.headerViewInstance.showMiniCart();
                });
            });
        }
    };
});
define('Cart.AddToCart.Button.View', [
    'LiveOrder.Model',
    'LiveOrder.Line.Model',
    'Cart.Confirmation.Helpers',
    'cart_add_to_cart_button.tpl',
    'Backbone',
    'underscore',
    'Utils'
], function (LiveOrderModel, LiveOrderLineModel, CartConfirmationHelpers, cart_add_to_cart_button_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_add_to_cart_button_tpl,
        events: { 'click [data-type="add-to-cart"]': 'addToCart' },
        initialize: function initialize() {
            Backbone.View.prototype.initialize.apply(this, arguments);
            this.cart = LiveOrderModel.getInstance();
            this.model.on('change', this.render, this);
        },
        destroy: function destroy() {
            Backbone.View.prototype.destroy.apply(this, arguments);
            this.model.off('change', this.render, this);
        },
        getAddToCartValidators: function getAddToCartValidators() {
            var self = this;
            return {
                quantity: {
                    fn: function () {
                        var line_on_cart = self.cart.findLine(self.model), quantity = self.model.get('quantity'), minimum_quantity = self.model.getItem().get('_minimumQuantity') || 1;
                        if (!_.isNumber(quantity) || _.isNaN(quantity) || quantity < 1) {
                            return _.translate('Invalid quantity value');
                        } else if (!line_on_cart && quantity < minimum_quantity) {
                            return _.translate('Please add $(0) or more of this item', minimum_quantity);
                        }
                    }
                }
            };
        },
        submitHandler: function submitHandler(e) {
            return this.addToCart(e);
        },
        addToCart: function addToCart(e) {
            e.preventDefault();
            var self = this, cart_promise;
            if (!this.model.areAttributesValid([
                    'options',
                    'quantity'
                ], self.getAddToCartValidators())) {
                return;
            }
            if (!this.model.isNew() && this.model.get('source') === 'cart') {
                cart_promise = this.cart.updateProduct(this.model);
                cart_promise.done(function () {
                    self.options.application.getLayout().closeModal();
                });
            } else {
                var line = LiveOrderLineModel.createFromProduct(this.model);
                cart_promise = this.cart.addLine(line);
                CartConfirmationHelpers.showCartConfirmation(cart_promise, line, self.options.application);
            }
            cart_promise.fail(function (jqXhr) {
                var error_details = null;
                try {
                    var response = JSON.parse(jqXhr.responseText);
                    error_details = response.errorDetails;
                } finally {
                    if (error_details && error_details.status === 'LINE_ROLLBACK') {
                        self.model.set('internalid', error_details.newLineId);
                    }
                }
            });
            this.disableElementsOnPromise(cart_promise, e.target);
            return false;
        },
        getContext: function getContext() {
            return {
                isCurrentItemPurchasable: this.model.getItem().get('_isPurchasable'),
                isUpdate: !this.model.isNew() && this.model.get('source') === 'cart'
            };
        }
    });
});
define('ProductDetails.Information.View', [
    'SC.Configuration',
    'product_details_information.tpl',
    'Backbone',
    'Utils',
    'underscore'
], function (Configuration, product_details_information_tpl, Backbone, Utils, _) {
    'use strict';
    return Backbone.View.extend({
        template: product_details_information_tpl,
        events: {
            'click [data-action="show-more"]': 'showMore',
            'click [data-action="selected-tab"]': 'debouncedCheckContentHeight'
        },
        initialize: function initialize() {
            Backbone.View.prototype.initialize.apply(this, arguments);
            this.details = this.options.details;
        },
        render: function () {
            this.details = this.details || this.computeDetailsArea();
            this._render();
            if (!SC.isPageGenerator()) {
                this.debouncedCheckContentHeight();
            }
        },
        computeDetailsArea: function () {
            var self = this, details = [];
            _.each(Configuration.get('productDetailsInformation', []), function (item_information) {
                var content = '';
                if (item_information.contentFromKey) {
                    content = self.model.get('item').get(item_information.contentFromKey);
                }
                if (content && Utils.trim(content)) {
                    details.push({
                        name: item_information.name,
                        content: content,
                        itemprop: item_information.itemprop
                    });
                }
            });
            return details;
        },
        debouncedCheckContentHeight: function () {
            return _.defer(_.bind(this.checkContentHeight, this));
        },
        checkContentHeight: function () {
            var content_height = this.$('.active [data-type="information-content-text"]').height();
            if (content_height <= 370) {
                this.$('[data-type="information-content-text-actions"]').hide();
            } else {
                this.$('[data-type="information-content-text-actions"]').show();
            }
        },
        showMore: function () {
            this.$('[data-type="information-content"]').toggleClass('show');
        },
        getContext: function () {
            return {
                showInformation: this.details.length > 0,
                showHeader: this.details.length < 2,
                details: this.details
            };
        }
    });
});
define('ProductDetails.Quantity.View', [
    'LiveOrder.Model',
    'product_details_quantity.tpl',
    'Backbone'
], function (LiveOrderModel, product_details_quantity_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: product_details_quantity_tpl,
        events: {
            'click [data-action="updateQuantity"]': 'setQuantity',
            'click [data-action="changeQuantity"]': 'setFocus',
            'keyup [data-action="changeQuantity"]': 'disableFocus'
        },
        setQuantity: function setQuantity(e) {
            e.preventDefault();
            var value = parseInt(this.$(e.currentTarget).data('value'), 10), $input_quantity = this.$('[name="quantity"]'), old_value = parseInt($input_quantity.val(), 10), new_quantity = old_value + value;
            $input_quantity.val(new_quantity).trigger('blur');
        },
        setFocus: function setFocus() {
            this.$('[name="quantity"]').focus();
        },
        disableFocus: function disableFocus(e) {
            if (e.keyCode === 13) {
                this.$('[name="quantity"]').blur();
            }
        },
        getContext: function getContext() {
            return {
                model: this.model,
                showQuantity: this.model.get('item').get('_itemType') !== 'GiftCert',
                isMinusButtonDisabled: this.model.get('quantity') <= 1
            };
        }
    });
});
define('Utilities.ResizeImage', [
    'SC.Configuration',
    'Utils',
    'underscore'
], function (Configuration, Utils, _) {
    'use strict';
    return function resizeImage(url, size) {
        url = url || Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', Configuration.get('imageNotAvailable'));
        size = Configuration['imageSizeMapping.' + size] || size;
        var resize = _.first(_.where(Configuration.get('siteSettings.imagesizes', []), { name: size }));
        if (!!resize) {
            return url + (~url.indexOf('?') ? '&' : '?') + resize.urlsuffix;
        }
        return url;
    };
});
define('SocialSharing.Flyout.Hover.View', [
    'social_sharing_flyout_hover.tpl',
    'Backbone'
], function (social_sharing_flyout_hover_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: social_sharing_flyout_hover_tpl,
        getContext: function () {
            return {};
        }
    });
});
define('jquery.zoom', ['jQuery'], function () {
    (function ($) {
        var defaults = {
            url: false,
            callback: false,
            target: false,
            duration: 120,
            on: 'mouseover',
            touch: true,
            onZoomIn: false,
            onZoomOut: false,
            magnify: 1
        };
        $.zoom = function (target, source, img, magnify) {
            var targetHeight, targetWidth, sourceHeight, sourceWidth, xRatio, yRatio, offset, position = $(target).css('position'), $source = $(source);
            target.style.position = /(absolute|fixed)/.test(position) ? position : 'relative';
            target.style.overflow = 'hidden';
            img.style.width = img.style.height = '';
            $(img).addClass('zoomImg').css({
                position: 'absolute',
                top: 0,
                left: 0,
                opacity: 0,
                width: img.width * magnify,
                height: img.height * magnify,
                border: 'none',
                maxWidth: 'none',
                maxHeight: 'none'
            }).appendTo(target);
            return {
                init: function () {
                    targetWidth = $(target).outerWidth();
                    targetHeight = $(target).outerHeight();
                    if (source === target) {
                        sourceWidth = targetWidth;
                        sourceHeight = targetHeight;
                    } else {
                        sourceWidth = $source.outerWidth();
                        sourceHeight = $source.outerHeight();
                    }
                    xRatio = (img.width - targetWidth) / sourceWidth;
                    yRatio = (img.height - targetHeight) / sourceHeight;
                    offset = $source.offset();
                },
                move: function (e) {
                    var left = e.pageX - offset.left, top = e.pageY - offset.top;
                    top = Math.max(Math.min(top, sourceHeight), 0);
                    left = Math.max(Math.min(left, sourceWidth), 0);
                    img.style.left = left * -xRatio + 'px';
                    img.style.top = top * -yRatio + 'px';
                }
            };
        };
        $.fn.zoom = function (options) {
            return this.each(function () {
                var settings = $.extend({}, defaults, options || {}), target = settings.target || this, source = this, $source = $(source), img = document.createElement('img'), $img = $(img), mousemove = 'mousemove.zoom', clicked = false, touched = false, $urlElement;
                if (!settings.url) {
                    $urlElement = $source.find('img');
                    if ($urlElement[0]) {
                        settings.url = $urlElement.data('src') || $urlElement.attr('src');
                    }
                    if (!settings.url) {
                        return;
                    }
                }
                (function () {
                    var position = target.style.position;
                    var overflow = target.style.overflow;
                    $source.one('zoom.destroy', function () {
                        $source.off('.zoom');
                        target.style.position = position;
                        target.style.overflow = overflow;
                        $img.remove();
                    });
                }());
                img.onload = function () {
                    var zoom = $.zoom(target, source, img, settings.magnify);
                    function start(e) {
                        zoom.init();
                        zoom.move(e);
                        $img.stop().fadeTo($.support.opacity ? settings.duration : 0, 1, $.isFunction(settings.onZoomIn) ? settings.onZoomIn.call(img) : false);
                    }
                    function stop() {
                        $img.stop().fadeTo(settings.duration, 0, $.isFunction(settings.onZoomOut) ? settings.onZoomOut.call(img) : false);
                    }
                    if (settings.on === 'grab') {
                        $source.on('mousedown.zoom', function (e) {
                            if (e.which === 1) {
                                $(document).one('mouseup.zoom', function () {
                                    stop();
                                    $(document).off(mousemove, zoom.move);
                                });
                                start(e);
                                $(document).on(mousemove, zoom.move);
                                e.preventDefault();
                            }
                        });
                    } else if (settings.on === 'click') {
                        $source.on('click.zoom', function (e) {
                            if (clicked) {
                                return;
                            } else {
                                clicked = true;
                                start(e);
                                $(document).on(mousemove, zoom.move);
                                $(document).one('click.zoom', function () {
                                    stop();
                                    clicked = false;
                                    $(document).off(mousemove, zoom.move);
                                });
                                return false;
                            }
                        });
                    } else if (settings.on === 'toggle') {
                        $source.on('click.zoom', function (e) {
                            if (clicked) {
                                stop();
                            } else {
                                start(e);
                            }
                            clicked = !clicked;
                        });
                    } else if (settings.on === 'mouseover') {
                        zoom.init();
                        $source.on('mouseenter.zoom', start).on('mouseleave.zoom', stop).on(mousemove, zoom.move);
                    }
                    if (settings.touch) {
                        $source.on('touchstart.zoom', function (e) {
                            e.preventDefault();
                            if (touched) {
                                touched = false;
                                stop();
                            } else {
                                touched = true;
                                start(e.originalEvent.touches[0] || e.originalEvent.changedTouches[0]);
                            }
                        }).on('touchmove.zoom', function (e) {
                            e.preventDefault();
                            zoom.move(e.originalEvent.touches[0] || e.originalEvent.changedTouches[0]);
                        });
                    }
                    if ($.isFunction(settings.callback)) {
                        settings.callback.call(img);
                    }
                };
                img.src = settings.url;
            });
        };
        $.fn.zoom.defaults = defaults;
    }(window.jQuery));
    return;
});
define('jQuery.bxSlider', ['jQuery'], function () {
    ;
    (function ($) {
        var plugin = {};
        var defaults = {
            mode: 'horizontal',
            slideSelector: '',
            infiniteLoop: true,
            hideControlOnEnd: false,
            speed: 500,
            easing: null,
            slideMargin: 0,
            startSlide: 0,
            randomStart: false,
            captions: false,
            ticker: false,
            tickerHover: false,
            adaptiveHeight: false,
            adaptiveHeightSpeed: 500,
            video: false,
            useCSS: true,
            preloadImages: 'visible',
            responsive: true,
            slideZIndex: 50,
            wrapperClass: 'bx-wrapper',
            touchEnabled: true,
            swipeThreshold: 50,
            oneToOneTouch: true,
            preventDefaultSwipeX: true,
            preventDefaultSwipeY: false,
            pager: true,
            pagerType: 'full',
            pagerShortSeparator: ' / ',
            pagerSelector: null,
            buildPager: null,
            pagerCustom: null,
            controls: true,
            nextText: 'Next',
            prevText: 'Prev',
            nextSelector: null,
            prevSelector: null,
            autoControls: false,
            startText: 'Start',
            stopText: 'Stop',
            autoControlsCombine: false,
            autoControlsSelector: null,
            auto: false,
            pause: 4000,
            autoStart: true,
            autoDirection: 'next',
            autoHover: false,
            autoDelay: 0,
            autoSlideForOnePage: false,
            minSlides: 1,
            maxSlides: 1,
            moveSlides: 0,
            slideWidth: 0,
            onSliderLoad: function () {
            },
            onSlideBefore: function () {
            },
            onSlideAfter: function () {
            },
            onSlideNext: function () {
            },
            onSlidePrev: function () {
            },
            onSliderResize: function () {
            }
        };
        $.fn.bxSlider = function (options) {
            if (this.length == 0)
                return this;
            if (this.length > 1) {
                this.each(function () {
                    $(this).bxSlider(options);
                });
                return this;
            }
            var slider = {};
            var el = this;
            plugin.el = this;
            var windowWidth = $(window).width();
            var windowHeight = $(window).height();
            var init = function () {
                slider.settings = $.extend({}, defaults, options);
                slider.settings.slideWidth = parseInt(slider.settings.slideWidth);
                slider.children = el.children(slider.settings.slideSelector);
                if (slider.children.length < slider.settings.minSlides)
                    slider.settings.minSlides = slider.children.length;
                if (slider.children.length < slider.settings.maxSlides)
                    slider.settings.maxSlides = slider.children.length;
                if (slider.settings.randomStart)
                    slider.settings.startSlide = Math.floor(Math.random() * slider.children.length);
                slider.active = { index: slider.settings.startSlide };
                slider.carousel = slider.settings.minSlides > 1 || slider.settings.maxSlides > 1;
                if (slider.carousel)
                    slider.settings.preloadImages = 'all';
                slider.minThreshold = slider.settings.minSlides * slider.settings.slideWidth + (slider.settings.minSlides - 1) * slider.settings.slideMargin;
                slider.maxThreshold = slider.settings.maxSlides * slider.settings.slideWidth + (slider.settings.maxSlides - 1) * slider.settings.slideMargin;
                slider.working = false;
                slider.controls = {};
                slider.interval = null;
                slider.animProp = slider.settings.mode == 'vertical' ? 'top' : 'left';
                slider.usingCSS = slider.settings.useCSS && slider.settings.mode != 'fade' && function () {
                    var div = document.createElement('div');
                    var props = [
                        'WebkitPerspective',
                        'MozPerspective',
                        'OPerspective',
                        'msPerspective'
                    ];
                    for (var i in props) {
                        if (div.style[props[i]] !== undefined) {
                            slider.cssPrefix = props[i].replace('Perspective', '').toLowerCase();
                            slider.animProp = '-' + slider.cssPrefix + '-transform';
                            return true;
                        }
                    }
                    return false;
                }();
                if (slider.settings.mode == 'vertical')
                    slider.settings.maxSlides = slider.settings.minSlides;
                el.data('origStyle', el.attr('style'));
                el.children(slider.settings.slideSelector).each(function () {
                    $(this).data('origStyle', $(this).attr('style'));
                });
                setup();
            };
            var setup = function () {
                el.wrap('<div class="' + slider.settings.wrapperClass + '"><div class="bx-viewport"></div></div>');
                slider.viewport = el.parent();
                slider.loader = $('<div class="bx-loading" />');
                slider.viewport.prepend(slider.loader);
                el.css({
                    width: slider.settings.mode == 'horizontal' ? slider.children.length * 100 + 215 + '%' : 'auto',
                    position: 'relative'
                });
                if (slider.usingCSS && slider.settings.easing) {
                    el.css('-' + slider.cssPrefix + '-transition-timing-function', slider.settings.easing);
                } else if (!slider.settings.easing) {
                    slider.settings.easing = 'swing';
                }
                var slidesShowing = getNumberSlidesShowing();
                slider.viewport.css({
                    width: '100%',
                    overflow: 'hidden',
                    position: 'relative'
                });
                slider.viewport.parent().css({ maxWidth: getViewportMaxWidth() });
                if (!slider.settings.pager) {
                    slider.viewport.parent().css({ margin: '0 auto 0px' });
                }
                slider.children.css({
                    'float': slider.settings.mode == 'horizontal' ? 'left' : 'none',
                    listStyle: 'none',
                    position: 'relative'
                });
                slider.children.css('width', getSlideWidth());
                if (slider.settings.mode == 'horizontal' && slider.settings.slideMargin > 0)
                    slider.children.css('marginRight', slider.settings.slideMargin);
                if (slider.settings.mode == 'vertical' && slider.settings.slideMargin > 0)
                    slider.children.css('marginBottom', slider.settings.slideMargin);
                if (slider.settings.mode == 'fade') {
                    slider.children.css({
                        position: 'absolute',
                        zIndex: 0,
                        display: 'none'
                    });
                    slider.children.eq(slider.settings.startSlide).css({
                        zIndex: slider.settings.slideZIndex,
                        display: 'block'
                    });
                }
                slider.controls.el = $('<div class="bx-controls" />');
                if (slider.settings.captions)
                    appendCaptions();
                slider.active.last = slider.settings.startSlide == getPagerQty() - 1;
                if (slider.settings.video)
                    el.fitVids();
                var preloadSelector = slider.children.eq(slider.settings.startSlide);
                if (slider.settings.preloadImages == 'all')
                    preloadSelector = slider.children;
                if (!slider.settings.ticker) {
                    if (slider.settings.pager)
                        appendPager();
                    if (slider.settings.controls)
                        appendControls();
                    if (slider.settings.auto && slider.settings.autoControls)
                        appendControlsAuto();
                    if (slider.settings.controls || slider.settings.autoControls || slider.settings.pager)
                        slider.viewport.after(slider.controls.el);
                } else {
                    slider.settings.pager = false;
                }
                if (slider.settings.forceStart)
                    start();
                else
                    loadElements(preloadSelector, start);
            };
            var loadElements = function (selector, callback) {
                var total = selector.find('img, iframe').length;
                if (total == 0) {
                    callback();
                    return;
                }
                var count = 0;
                selector.find('img, iframe').each(function () {
                    $(this).load(function () {
                        setTimeout(function () {
                            if (++count == total)
                                callback();
                        }, 0);
                    });
                });
            };
            var start = function () {
                if (slider.settings.infiniteLoop && slider.settings.mode != 'fade' && !slider.settings.ticker) {
                    var slice = slider.settings.mode == 'vertical' ? slider.settings.minSlides : slider.settings.maxSlides;
                    var sliceAppend = slider.children.slice(0, slice).clone().addClass('bx-clone');
                    var slicePrepend = slider.children.slice(-slice).clone().addClass('bx-clone');
                    el.append(sliceAppend).prepend(slicePrepend);
                }
                slider.loader.remove();
                setSlidePosition();
                if (slider.settings.mode == 'vertical')
                    slider.settings.adaptiveHeight = true;
                slider.viewport.height(getViewportHeight());
                el.redrawSlider();
                slider.settings.onSliderLoad(slider.active.index);
                slider.initialized = true;
                if (slider.settings.responsive)
                    $(window).bind('resize', resizeWindow);
                if (slider.settings.auto && slider.settings.autoStart && (getPagerQty() > 1 || slider.settings.autoSlideForOnePage))
                    initAuto();
                if (slider.settings.ticker)
                    initTicker();
                if (slider.settings.pager)
                    updatePagerActive(slider.settings.startSlide);
                if (slider.settings.controls)
                    updateDirectionControls();
                if (slider.settings.touchEnabled && !slider.settings.ticker)
                    initTouch();
            };
            var getViewportHeight = function () {
                var height = 0;
                var children = $();
                if (slider.settings.mode != 'vertical' && !slider.settings.adaptiveHeight) {
                    children = slider.children;
                } else {
                    if (!slider.carousel) {
                        children = slider.children.eq(slider.active.index);
                    } else {
                        var currentIndex = slider.settings.moveSlides == 1 ? slider.active.index : slider.active.index * getMoveBy();
                        children = slider.children.eq(currentIndex);
                        for (i = 1; i <= slider.settings.maxSlides - 1; i++) {
                            if (currentIndex + i >= slider.children.length) {
                                children = children.add(slider.children.eq(i - 1));
                            } else {
                                children = children.add(slider.children.eq(currentIndex + i));
                            }
                        }
                    }
                }
                if (slider.settings.mode == 'vertical') {
                    children.each(function (index) {
                        height += $(this).outerHeight();
                    });
                    if (slider.settings.slideMargin > 0) {
                        height += slider.settings.slideMargin * (slider.settings.minSlides - 1);
                    }
                } else {
                    height = Math.max.apply(Math, children.map(function () {
                        return $(this).outerHeight(false);
                    }).get());
                }
                if (slider.viewport.css('box-sizing') == 'border-box') {
                    height += parseFloat(slider.viewport.css('padding-top')) + parseFloat(slider.viewport.css('padding-bottom')) + parseFloat(slider.viewport.css('border-top-width')) + parseFloat(slider.viewport.css('border-bottom-width'));
                } else if (slider.viewport.css('box-sizing') == 'padding-box') {
                    height += parseFloat(slider.viewport.css('padding-top')) + parseFloat(slider.viewport.css('padding-bottom'));
                }
                return height;
            };
            var getViewportMaxWidth = function () {
                var width = '100%';
                if (slider.settings.slideWidth > 0) {
                    if (slider.settings.mode == 'horizontal') {
                        width = slider.settings.maxSlides * slider.settings.slideWidth + (slider.settings.maxSlides - 1) * slider.settings.slideMargin;
                    } else {
                        width = slider.settings.slideWidth;
                    }
                }
                return width;
            };
            var getSlideWidth = function () {
                var newElWidth = slider.settings.slideWidth;
                var wrapWidth = slider.viewport.width();
                if (slider.settings.slideWidth == 0 || slider.settings.slideWidth > wrapWidth && !slider.carousel || slider.settings.mode == 'vertical') {
                    newElWidth = wrapWidth;
                } else if (slider.settings.maxSlides > 1 && slider.settings.mode == 'horizontal') {
                    if (wrapWidth > slider.maxThreshold) {
                    } else if (wrapWidth < slider.minThreshold) {
                        newElWidth = (wrapWidth - slider.settings.slideMargin * (slider.settings.minSlides - 1)) / slider.settings.minSlides;
                    }
                }
                return newElWidth;
            };
            var getNumberSlidesShowing = function () {
                var slidesShowing = 1;
                if (slider.settings.mode == 'horizontal' && slider.settings.slideWidth > 0) {
                    if (slider.viewport.width() < slider.minThreshold) {
                        slidesShowing = slider.settings.minSlides;
                    } else if (slider.viewport.width() > slider.maxThreshold) {
                        slidesShowing = slider.settings.maxSlides;
                    } else {
                        var childWidth = slider.children.first().width() + slider.settings.slideMargin;
                        slidesShowing = Math.floor((slider.viewport.width() + slider.settings.slideMargin) / childWidth);
                    }
                } else if (slider.settings.mode == 'vertical') {
                    slidesShowing = slider.settings.minSlides;
                }
                return slidesShowing;
            };
            var getPagerQty = function () {
                var pagerQty = 0;
                if (slider.settings.moveSlides > 0) {
                    if (slider.settings.infiniteLoop) {
                        pagerQty = Math.ceil(slider.children.length / getMoveBy());
                    } else {
                        var breakPoint = 0;
                        var counter = 0;
                        while (breakPoint < slider.children.length) {
                            ++pagerQty;
                            breakPoint = counter + getNumberSlidesShowing();
                            counter += slider.settings.moveSlides <= getNumberSlidesShowing() ? slider.settings.moveSlides : getNumberSlidesShowing();
                        }
                    }
                } else {
                    pagerQty = Math.ceil(slider.children.length / getNumberSlidesShowing());
                }
                return pagerQty;
            };
            var getMoveBy = function () {
                if (slider.settings.moveSlides > 0 && slider.settings.moveSlides <= getNumberSlidesShowing()) {
                    return slider.settings.moveSlides;
                }
                return getNumberSlidesShowing();
            };
            var setSlidePosition = function () {
                if (slider.children.length > slider.settings.maxSlides && slider.active.last && !slider.settings.infiniteLoop) {
                    if (slider.settings.mode == 'horizontal') {
                        var lastChild = slider.children.last();
                        var position = lastChild.position();
                        setPositionProperty(-(position.left - (slider.viewport.width() - lastChild.outerWidth())), 'reset', 0);
                    } else if (slider.settings.mode == 'vertical') {
                        var lastShowingIndex = slider.children.length - slider.settings.minSlides;
                        var position = slider.children.eq(lastShowingIndex).position();
                        setPositionProperty(-position.top, 'reset', 0);
                    }
                } else {
                    var position = slider.children.eq(slider.active.index * getMoveBy()).position();
                    if (slider.active.index == getPagerQty() - 1)
                        slider.active.last = true;
                    if (position != undefined) {
                        if (slider.settings.mode == 'horizontal')
                            setPositionProperty(-position.left, 'reset', 0);
                        else if (slider.settings.mode == 'vertical')
                            setPositionProperty(-position.top, 'reset', 0);
                    }
                }
            };
            var setPositionProperty = function (value, type, duration, params) {
                if (slider.usingCSS) {
                    var propValue = slider.settings.mode == 'vertical' ? 'translate3d(0, ' + value + 'px, 0)' : 'translate3d(' + value + 'px, 0, 0)';
                    el.css('-' + slider.cssPrefix + '-transition-duration', duration / 1000 + 's');
                    if (type == 'slide') {
                        el.css(slider.animProp, propValue);
                        el.bind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd', function () {
                            el.unbind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd');
                            updateAfterSlideTransition();
                        });
                    } else if (type == 'reset') {
                        el.css(slider.animProp, propValue);
                    } else if (type == 'ticker') {
                        el.css('-' + slider.cssPrefix + '-transition-timing-function', 'linear');
                        el.css(slider.animProp, propValue);
                        el.bind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd', function () {
                            el.unbind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd');
                            setPositionProperty(params['resetValue'], 'reset', 0);
                            tickerLoop();
                        });
                    }
                } else {
                    var animateObj = {};
                    animateObj[slider.animProp] = value;
                    if (type == 'slide') {
                        el.animate(animateObj, duration, slider.settings.easing, function () {
                            updateAfterSlideTransition();
                        });
                    } else if (type == 'reset') {
                        el.css(slider.animProp, value);
                    } else if (type == 'ticker') {
                        el.animate(animateObj, speed, 'linear', function () {
                            setPositionProperty(params['resetValue'], 'reset', 0);
                            tickerLoop();
                        });
                    }
                }
            };
            var populatePager = function () {
                var pagerHtml = '';
                var pagerQty = getPagerQty();
                for (var i = 0; i < pagerQty; i++) {
                    var linkContent = '';
                    if (slider.settings.buildPager && $.isFunction(slider.settings.buildPager)) {
                        linkContent = slider.settings.buildPager(i);
                        slider.pagerEl.addClass('bx-custom-pager');
                    } else {
                        linkContent = i + 1;
                        slider.pagerEl.addClass('bx-default-pager');
                    }
                    pagerHtml += '<div class="bx-pager-item"><a href="" data-slide-index="' + i + '" class="bx-pager-link">' + linkContent + '</a></div>';
                }
                ;
                slider.pagerEl.html(pagerHtml);
            };
            var appendPager = function () {
                if (!slider.settings.pagerCustom) {
                    slider.pagerEl = $('<div class="bx-pager" />');
                    if (slider.settings.pagerSelector) {
                        $(slider.settings.pagerSelector).html(slider.pagerEl);
                    } else {
                        slider.controls.el.addClass('bx-has-pager').append(slider.pagerEl);
                    }
                    populatePager();
                } else {
                    slider.pagerEl = $(slider.settings.pagerCustom);
                }
                slider.pagerEl.on('click', 'a', clickPagerBind);
            };
            var appendControls = function () {
                slider.controls.next = $('<a class="bx-next" href="">' + slider.settings.nextText + '</a>');
                slider.controls.prev = $('<a class="bx-prev" href="">' + slider.settings.prevText + '</a>');
                slider.controls.next.bind('click', clickNextBind);
                slider.controls.prev.bind('click', clickPrevBind);
                if (slider.settings.nextSelector) {
                    $(slider.settings.nextSelector).append(slider.controls.next);
                }
                if (slider.settings.prevSelector) {
                    $(slider.settings.prevSelector).append(slider.controls.prev);
                }
                if (!slider.settings.nextSelector && !slider.settings.prevSelector) {
                    slider.controls.directionEl = $('<div class="bx-controls-direction" />');
                    slider.controls.directionEl.append(slider.controls.prev).append(slider.controls.next);
                    slider.controls.el.addClass('bx-has-controls-direction').append(slider.controls.directionEl);
                }
            };
            var appendControlsAuto = function () {
                slider.controls.start = $('<div class="bx-controls-auto-item"><a class="bx-start" href="">' + slider.settings.startText + '</a></div>');
                slider.controls.stop = $('<div class="bx-controls-auto-item"><a class="bx-stop" href="">' + slider.settings.stopText + '</a></div>');
                slider.controls.autoEl = $('<div class="bx-controls-auto" />');
                slider.controls.autoEl.on('click', '.bx-start', clickStartBind);
                slider.controls.autoEl.on('click', '.bx-stop', clickStopBind);
                if (slider.settings.autoControlsCombine) {
                    slider.controls.autoEl.append(slider.controls.start);
                } else {
                    slider.controls.autoEl.append(slider.controls.start).append(slider.controls.stop);
                }
                if (slider.settings.autoControlsSelector) {
                    $(slider.settings.autoControlsSelector).html(slider.controls.autoEl);
                } else {
                    slider.controls.el.addClass('bx-has-controls-auto').append(slider.controls.autoEl);
                }
                updateAutoControls(slider.settings.autoStart ? 'stop' : 'start');
            };
            var appendCaptions = function () {
                slider.children.each(function (index) {
                    var title = $(this).find('img:first').attr('title');
                    if (title != undefined && ('' + title).length) {
                        $(this).append('<div class="bx-caption"><span>' + title + '</span></div>');
                    }
                });
            };
            var clickNextBind = function (e) {
                if (slider.settings.auto)
                    el.stopAuto();
                el.goToNextSlide();
                e.preventDefault();
            };
            var clickPrevBind = function (e) {
                if (slider.settings.auto)
                    el.stopAuto();
                el.goToPrevSlide();
                e.preventDefault();
            };
            var clickStartBind = function (e) {
                el.startAuto();
                e.preventDefault();
            };
            var clickStopBind = function (e) {
                el.stopAuto();
                e.preventDefault();
            };
            var clickPagerBind = function (e) {
                if (slider.settings.auto)
                    el.stopAuto();
                var pagerLink = $(e.currentTarget);
                if (pagerLink.attr('data-slide-index') !== undefined) {
                    var pagerIndex = parseInt(pagerLink.attr('data-slide-index'));
                    if (pagerIndex != slider.active.index)
                        el.goToSlide(pagerIndex);
                    e.preventDefault();
                }
            };
            var updatePagerActive = function (slideIndex) {
                var len = slider.children.length;
                if (slider.settings.pagerType == 'short') {
                    if (slider.settings.maxSlides > 1) {
                        len = Math.ceil(slider.children.length / slider.settings.maxSlides);
                    }
                    slider.pagerEl.html(slideIndex + 1 + slider.settings.pagerShortSeparator + len);
                    return;
                }
                slider.pagerEl.find('a').removeClass('active');
                slider.pagerEl.each(function (i, el) {
                    $(el).find('a').eq(slideIndex).addClass('active');
                });
            };
            var updateAfterSlideTransition = function () {
                if (slider.settings.infiniteLoop) {
                    var position = '';
                    if (slider.active.index == 0) {
                        position = slider.children.eq(0).position();
                    } else if (slider.active.index == getPagerQty() - 1 && slider.carousel) {
                        position = slider.children.eq((getPagerQty() - 1) * getMoveBy()).position();
                    } else if (slider.active.index == slider.children.length - 1) {
                        position = slider.children.eq(slider.children.length - 1).position();
                    }
                    if (position) {
                        if (slider.settings.mode == 'horizontal') {
                            setPositionProperty(-position.left, 'reset', 0);
                        } else if (slider.settings.mode == 'vertical') {
                            setPositionProperty(-position.top, 'reset', 0);
                        }
                    }
                }
                slider.working = false;
                slider.settings.onSlideAfter(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
            };
            var updateAutoControls = function (state) {
                if (slider.settings.autoControlsCombine) {
                    slider.controls.autoEl.html(slider.controls[state]);
                } else {
                    slider.controls.autoEl.find('a').removeClass('active');
                    slider.controls.autoEl.find('a:not(.bx-' + state + ')').addClass('active');
                }
            };
            var updateDirectionControls = function () {
                if (getPagerQty() == 1) {
                    slider.controls.prev.addClass('disabled');
                    slider.controls.next.addClass('disabled');
                } else if (!slider.settings.infiniteLoop && slider.settings.hideControlOnEnd) {
                    if (slider.active.index == 0) {
                        slider.controls.prev.addClass('disabled');
                        slider.controls.next.removeClass('disabled');
                    } else if (slider.active.index == getPagerQty() - 1) {
                        slider.controls.next.addClass('disabled');
                        slider.controls.prev.removeClass('disabled');
                    } else {
                        slider.controls.prev.removeClass('disabled');
                        slider.controls.next.removeClass('disabled');
                    }
                }
            };
            var initAuto = function () {
                if (slider.settings.autoDelay > 0) {
                    var timeout = setTimeout(el.startAuto, slider.settings.autoDelay);
                } else {
                    el.startAuto();
                }
                if (slider.settings.autoHover) {
                    el.hover(function () {
                        if (slider.interval) {
                            el.stopAuto(true);
                            slider.autoPaused = true;
                        }
                    }, function () {
                        if (slider.autoPaused) {
                            el.startAuto(true);
                            slider.autoPaused = null;
                        }
                    });
                }
            };
            var initTicker = function () {
                var startPosition = 0;
                if (slider.settings.autoDirection == 'next') {
                    el.append(slider.children.clone().addClass('bx-clone'));
                } else {
                    el.prepend(slider.children.clone().addClass('bx-clone'));
                    var position = slider.children.first().position();
                    startPosition = slider.settings.mode == 'horizontal' ? -position.left : -position.top;
                }
                setPositionProperty(startPosition, 'reset', 0);
                slider.settings.pager = false;
                slider.settings.controls = false;
                slider.settings.autoControls = false;
                if (slider.settings.tickerHover && !slider.usingCSS) {
                    slider.viewport.hover(function () {
                        el.stop();
                    }, function () {
                        var totalDimens = 0;
                        slider.children.each(function (index) {
                            totalDimens += slider.settings.mode == 'horizontal' ? $(this).outerWidth(true) : $(this).outerHeight(true);
                        });
                        var ratio = slider.settings.speed / totalDimens;
                        var property = slider.settings.mode == 'horizontal' ? 'left' : 'top';
                        var newSpeed = ratio * (totalDimens - Math.abs(parseInt(el.css(property))));
                        tickerLoop(newSpeed);
                    });
                }
                tickerLoop();
            };
            var tickerLoop = function (resumeSpeed) {
                speed = resumeSpeed ? resumeSpeed : slider.settings.speed;
                var position = {
                    left: 0,
                    top: 0
                };
                var reset = {
                    left: 0,
                    top: 0
                };
                if (slider.settings.autoDirection == 'next') {
                    position = el.find('.bx-clone').first().position();
                } else {
                    reset = slider.children.first().position();
                }
                var animateProperty = slider.settings.mode == 'horizontal' ? -position.left : -position.top;
                var resetValue = slider.settings.mode == 'horizontal' ? -reset.left : -reset.top;
                var params = { resetValue: resetValue };
                setPositionProperty(animateProperty, 'ticker', speed, params);
            };
            var initTouch = function () {
                slider.touch = {
                    start: {
                        x: 0,
                        y: 0
                    },
                    end: {
                        x: 0,
                        y: 0
                    }
                };
                slider.viewport.bind('touchstart', onTouchStart);
            };
            var onTouchStart = function (e) {
                if (slider.working) {
                    e.preventDefault();
                } else {
                    slider.touch.originalPos = el.position();
                    var orig = e.originalEvent;
                    slider.touch.start.x = orig.changedTouches[0].pageX;
                    slider.touch.start.y = orig.changedTouches[0].pageY;
                    slider.viewport.bind('touchmove', onTouchMove);
                    slider.viewport.bind('touchend', onTouchEnd);
                }
            };
            var onTouchMove = function (e) {
                var orig = e.originalEvent;
                var xMovement = Math.abs(orig.changedTouches[0].pageX - slider.touch.start.x);
                var yMovement = Math.abs(orig.changedTouches[0].pageY - slider.touch.start.y);
                if (xMovement * 3 > yMovement && slider.settings.preventDefaultSwipeX) {
                    e.preventDefault();
                } else if (yMovement * 3 > xMovement && slider.settings.preventDefaultSwipeY) {
                    e.preventDefault();
                }
                if (slider.settings.mode != 'fade' && slider.settings.oneToOneTouch) {
                    var value = 0;
                    if (slider.settings.mode == 'horizontal') {
                        var change = orig.changedTouches[0].pageX - slider.touch.start.x;
                        value = slider.touch.originalPos.left + change;
                    } else {
                        var change = orig.changedTouches[0].pageY - slider.touch.start.y;
                        value = slider.touch.originalPos.top + change;
                    }
                    setPositionProperty(value, 'reset', 0);
                }
            };
            var onTouchEnd = function (e) {
                slider.viewport.unbind('touchmove', onTouchMove);
                var orig = e.originalEvent;
                var value = 0;
                slider.touch.end.x = orig.changedTouches[0].pageX;
                slider.touch.end.y = orig.changedTouches[0].pageY;
                if (slider.settings.mode == 'fade') {
                    var distance = Math.abs(slider.touch.start.x - slider.touch.end.x);
                    if (distance >= slider.settings.swipeThreshold) {
                        slider.touch.start.x > slider.touch.end.x ? el.goToNextSlide() : el.goToPrevSlide();
                        el.stopAuto();
                    }
                } else {
                    var distance = 0;
                    if (slider.settings.mode == 'horizontal') {
                        distance = slider.touch.end.x - slider.touch.start.x;
                        value = slider.touch.originalPos.left;
                    } else {
                        distance = slider.touch.end.y - slider.touch.start.y;
                        value = slider.touch.originalPos.top;
                    }
                    if (!slider.settings.infiniteLoop && (slider.active.index == 0 && distance > 0 || slider.active.last && distance < 0)) {
                        setPositionProperty(value, 'reset', 200);
                    } else {
                        if (Math.abs(distance) >= slider.settings.swipeThreshold) {
                            distance < 0 ? el.goToNextSlide() : el.goToPrevSlide();
                            el.stopAuto();
                        } else {
                            setPositionProperty(value, 'reset', 200);
                        }
                    }
                }
                slider.viewport.unbind('touchend', onTouchEnd);
            };
            var resizeWindow = function (e) {
                if (!slider.initialized)
                    return;
                var windowWidthNew = $(window).width();
                var windowHeightNew = $(window).height();
                if (windowWidth != windowWidthNew || windowHeight != windowHeightNew) {
                    windowWidth = windowWidthNew;
                    windowHeight = windowHeightNew;
                    el.redrawSlider();
                    slider.settings.onSliderResize.call(el, slider.active.index);
                }
            };
            el.goToSlide = function (slideIndex, direction) {
                if (slider.working || slider.active.index == slideIndex)
                    return;
                slider.working = true;
                slider.oldIndex = slider.active.index;
                if (slideIndex < 0) {
                    slider.active.index = getPagerQty() - 1;
                } else if (slideIndex >= getPagerQty()) {
                    slider.active.index = 0;
                } else {
                    slider.active.index = slideIndex;
                }
                slider.settings.onSlideBefore(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
                if (direction == 'next') {
                    slider.settings.onSlideNext(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
                } else if (direction == 'prev') {
                    slider.settings.onSlidePrev(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
                }
                slider.active.last = slider.active.index >= getPagerQty() - 1;
                if (slider.settings.pager)
                    updatePagerActive(slider.active.index);
                if (slider.settings.controls)
                    updateDirectionControls();
                if (slider.settings.mode == 'fade') {
                    if (slider.settings.adaptiveHeight && slider.viewport.height() != getViewportHeight()) {
                        slider.viewport.animate({ height: getViewportHeight() }, slider.settings.adaptiveHeightSpeed);
                    }
                    slider.children.filter(':visible').fadeOut(slider.settings.speed).css({ zIndex: 0 });
                    slider.children.eq(slider.active.index).css('zIndex', slider.settings.slideZIndex + 1).fadeIn(slider.settings.speed, function () {
                        $(this).css('zIndex', slider.settings.slideZIndex);
                        updateAfterSlideTransition();
                    });
                } else {
                    if (slider.settings.adaptiveHeight && slider.viewport.height() != getViewportHeight()) {
                        slider.viewport.animate({ height: getViewportHeight() }, slider.settings.adaptiveHeightSpeed);
                    }
                    var moveBy = 0;
                    var position = {
                        left: 0,
                        top: 0
                    };
                    if (!slider.settings.infiniteLoop && slider.carousel && slider.active.last) {
                        if (slider.settings.mode == 'horizontal') {
                            var lastChild = slider.children.eq(slider.children.length - 1);
                            position = lastChild.position();
                            moveBy = slider.viewport.width() - lastChild.outerWidth();
                        } else {
                            var lastShowingIndex = slider.children.length - slider.settings.minSlides;
                            position = slider.children.eq(lastShowingIndex).position();
                        }
                    } else if (slider.carousel && slider.active.last && direction == 'prev') {
                        var eq = slider.settings.moveSlides == 1 ? slider.settings.maxSlides - getMoveBy() : (getPagerQty() - 1) * getMoveBy() - (slider.children.length - slider.settings.maxSlides);
                        var lastChild = el.children('.bx-clone').eq(eq);
                        position = lastChild.position();
                    } else if (direction == 'next' && slider.active.index == 0) {
                        position = el.find('> .bx-clone').eq(slider.settings.maxSlides).position();
                        slider.active.last = false;
                    } else if (slideIndex >= 0) {
                        var requestEl = slideIndex * getMoveBy();
                        position = slider.children.eq(requestEl).position();
                    }
                    if ('undefined' !== typeof position) {
                        var value = slider.settings.mode == 'horizontal' ? -(position.left - moveBy) : -position.top;
                        setPositionProperty(value, 'slide', slider.settings.speed);
                    }
                }
            };
            el.goToNextSlide = function () {
                if (!slider.settings.infiniteLoop && slider.active.last)
                    return;
                var pagerIndex = parseInt(slider.active.index) + 1;
                el.goToSlide(pagerIndex, 'next');
            };
            el.goToPrevSlide = function () {
                if (!slider.settings.infiniteLoop && slider.active.index == 0)
                    return;
                var pagerIndex = parseInt(slider.active.index) - 1;
                el.goToSlide(pagerIndex, 'prev');
            };
            el.startAuto = function (preventControlUpdate) {
                if (slider.interval)
                    return;
                slider.interval = setInterval(function () {
                    slider.settings.autoDirection == 'next' ? el.goToNextSlide() : el.goToPrevSlide();
                }, slider.settings.pause);
                if (slider.settings.autoControls && preventControlUpdate != true)
                    updateAutoControls('stop');
            };
            el.stopAuto = function (preventControlUpdate) {
                if (!slider.interval)
                    return;
                clearInterval(slider.interval);
                slider.interval = null;
                if (slider.settings.autoControls && preventControlUpdate != true)
                    updateAutoControls('start');
            };
            el.getCurrentSlide = function () {
                return slider.active.index;
            };
            el.getCurrentSlideElement = function () {
                return slider.children.eq(slider.active.index);
            };
            el.getSlideCount = function () {
                return slider.children.length;
            };
            el.redrawSlider = function () {
                slider.children.add(el.find('.bx-clone')).width(getSlideWidth());
                slider.viewport.css('height', getViewportHeight());
                if (!slider.settings.ticker)
                    setSlidePosition();
                if (slider.active.last)
                    slider.active.index = getPagerQty() - 1;
                if (slider.active.index >= getPagerQty())
                    slider.active.last = true;
                if (slider.settings.pager && !slider.settings.pagerCustom) {
                    populatePager();
                    updatePagerActive(slider.active.index);
                }
            };
            el.destroySlider = function () {
                if (!slider.initialized)
                    return;
                slider.initialized = false;
                $('.bx-clone', this).remove();
                slider.children.each(function () {
                    $(this).data('origStyle') != undefined ? $(this).attr('style', $(this).data('origStyle')) : $(this).removeAttr('style');
                });
                $(this).data('origStyle') != undefined ? this.attr('style', $(this).data('origStyle')) : $(this).removeAttr('style');
                $(this).unwrap().unwrap();
                if (slider.controls.el)
                    slider.controls.el.remove();
                if (slider.controls.next)
                    slider.controls.next.remove();
                if (slider.controls.prev)
                    slider.controls.prev.remove();
                if (slider.pagerEl && slider.settings.controls)
                    slider.pagerEl.remove();
                $('.bx-caption', this).remove();
                if (slider.controls.autoEl)
                    slider.controls.autoEl.remove();
                clearInterval(slider.interval);
                if (slider.settings.responsive)
                    $(window).unbind('resize', resizeWindow);
            };
            el.reloadSlider = function (settings) {
                if (settings != undefined)
                    options = settings;
                el.destroySlider();
                init();
            };
            init();
            return this;
        };
    }(jQuery));
    return;
});
define('ProductDetails.ImageGallery.View', [
    'Backbone.CompositeView',
    'Utilities.ResizeImage',
    'SocialSharing.Flyout.Hover.View',
    'product_details_image_gallery.tpl',
    'Backbone',
    'underscore',
    'Utils',
    'jquery.zoom',
    'jQuery.bxSlider'
], function (BackboneCompositeView, resizeImage, SocialSharingFlyoutHoverView, product_details_image_gallery_tpl, Backbone, _, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: product_details_image_gallery_tpl,
        initialize: function initialize() {
            Backbone.View.prototype.initialize.apply(this, arguments);
            BackboneCompositeView.add(this);
            var self = this;
            this.images = this.model.getImages();
            this.model.on('change', function () {
                var model_images = this.model.getImages();
                if (!_.isEqual(this.images, model_images)) {
                    this.images = model_images;
                    this.render();
                }
            }, this);
            this.on('afterViewRender', function () {
                self.initSlider();
                self.initZoom();
            });
        },
        destroy: function destroy() {
            this.model.off('change', this.render, this);
            this.off('afterViewRender');
            this._destroy();
        },
        initSlider: function initSlider() {
            var self = this;
            if (self.images.length > 1) {
                self.$slider = Utils.initBxSlider(self.$('[data-slider]'), {
                    buildPager: _.bind(self.buildSliderPager, self),
                    startSlide: 0,
                    adaptiveHeight: true,
                    touchEnabled: true,
                    nextText: '<a class="product-details-image-gallery-next-icon" data-action="next-image"></a>',
                    prevText: '<a class="product-details-image-gallery-prev-icon" data-action="prev-image"></a>',
                    controls: true
                });
                self.$('[data-action="next-image"]').off();
                self.$('[data-action="prev-image"]').off();
                self.$('[data-action="next-image"]').click(_.bind(self.nextImageEventHandler, self));
                self.$('[data-action="prev-image"]').click(_.bind(self.previousImageEventHandler, self));
            }
        },
        previousImageEventHandler: function previousImageEventHandler() {
            var self = this, current_index = self.$slider.getCurrentSlide(), next_index = current_index === 0 ? self.$slider.getSlideCount() - 1 : current_index - 1;
            self.model.cancelableTrigger('beforeChangeImage', {
                currentIndex: current_index,
                nextIndex: next_index
            }).then(function () {
                self.$slider.goToPrevSlide();
                self.model.cancelableTrigger('afterChangeImage', next_index);
            });
        },
        nextImageEventHandler: function nextImageEventHandler() {
            var self = this, current_index = self.$slider.getCurrentSlide(), next_index = current_index === self.$slider.getSlideCount() - 1 ? 0 : current_index + 1;
            self.model.cancelableTrigger('beforeChangeImage', {
                currentIndex: current_index,
                nextIndex: next_index
            }).then(function () {
                self.$slider.goToNextSlide();
                self.model.cancelableTrigger('afterChangeImage', next_index);
            });
        },
        childViews: {
            'SocialSharing.Flyout.Hover': function () {
                return new SocialSharingFlyoutHoverView({});
            }
        },
        initZoom: function () {
            if (!SC.ENVIRONMENT.isTouchEnabled) {
                var images = this.images, self = this;
                this.$('[data-zoom]').each(function (slide_index) {
                    self.$(this).zoom({
                        url: resizeImage(images[slide_index].url, 'zoom'),
                        callback: function () {
                            var $this = self.$(this);
                            if ($this.width() <= $this.closest('[data-view="Product.ImageGallery"]').width()) {
                                $this.remove();
                            }
                            return this;
                        }
                    });
                });
            }
        },
        buildSliderPager: function (slide_index) {
            var image = this.images[slide_index];
            return '<img src="' + resizeImage(image.url, 'tinythumb') + '" alt="' + image.altimagetext + '">';
        },
        getContext: function () {
            return {
                imageResizeId: Utils.getViewportWidth() < 768 ? 'thumbnail' : 'main',
                images: this.images || [],
                firstImage: this.images[0] || {},
                showImages: this.images.length > 0,
                showImageSlider: this.images.length > 1
            };
        }
    });
});
define('ProductDetails.AddToProductList.View', [
    'ProductList.Control.View',
    'ProductList.ControlSingle.View',
    'Profile.Model',
    'product_details_add_to_product_list.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore'
], function (ProductListControlView, ProductListControlSingleView, ProfileModel, product_details_add_to_product_list_tpl, Backbone, BackboneCompositeView, _) {
    'use strict';
    return Backbone.View.extend({
        template: product_details_add_to_product_list_tpl,
        initialize: function () {
            Backbone.View.prototype.initialize.apply(this, arguments);
            this.application = this.options.application;
            this.utils = this.application.ProductListModule && this.application.ProductListModule.Utils;
            this.countedClicks = {};
            BackboneCompositeView.add(this);
            var self = this;
            this.first_time_render = true;
            ProfileModel.getPromise().done(function () {
                self.loaded_site_settings = true;
                self.render();
            });
        },
        childViews: {
            'ProductListControl': function () {
                if (this.utils.isSingleList()) {
                    return new ProductListControlSingleView({
                        collection: this.utils.getProductLists(),
                        product: this.model,
                        application: this.application
                    });
                } else {
                    return new ProductListControlView({
                        collection: this.utils.getProductLists(),
                        product: this.model,
                        application: this.application,
                        countedClicks: this.countedClicks
                    });
                }
            }
        },
        render: function () {
            if (this.loaded_site_settings && this.utils && this.utils.isProductListEnabled()) {
                if (this.first_time_render) {
                    this.utils.getProductListsPromise().done(_.bind(this.render, this));
                    this.first_time_render = false;
                    return this.$el.empty();
                }
            } else {
                return this.$el.empty();
            }
            this._render();
        },
        getContext: function () {
            return { isLoading: this.utils.getProductListsPromise().state() === 'pending' };
        }
    }, {
        attributesToValidate: [
            'options',
            'quantity'
        ]
    });
});
define('RecentlyViewedItems.Collection', [
    'Singleton',
    'SC.Configuration',
    'Item.Collection',
    'jQuery',
    'underscore',
    'Utils'
], function (Singleton, Configuration, ItemCollection, jQuery, _) {
    'use strict';
    return ItemCollection.extend({
        initialize: function () {
            this.useCookie = Configuration.recentlyViewedItems && Configuration.recentlyViewedItems.useCookie;
            this.searchApiMasterOptions = Configuration.searchApiMasterOptions.Facets;
            if (this.useCookie) {
                this.promise = this.loadItemsFromCookie();
            } else {
                this.promise = jQuery.Deferred().resolveWith(this);
            }
        },
        addHistoryItem: function (item) {
            if (this.useCookie) {
                var self = this;
                this.promise.done(function () {
                    self.remove(item);
                    self.unshift(item);
                    if (self.useCookie) {
                        var current_items = jQuery.cookie('recentlyViewedIds'), news_items = _.union(self.pluck('internalid'), current_items);
                        jQuery.cookie('recentlyViewedIds', news_items, { path: '/' });
                    }
                });
            }
        },
        loadItemsFromCookie: function () {
            var cookie_ids = jQuery.cookie('recentlyViewedIds') || [];
            if (typeof cookie_ids === 'string') {
                cookie_ids = [cookie_ids.replace(/[\[\]]+/g, '')];
            } else if (!_.isArray(cookie_ids)) {
                cookie_ids = [cookie_ids];
            }
            var items_ids = _.difference(cookie_ids, this.pluck('internalid')).join(',');
            if (items_ids) {
                return this.fetch({ data: { id: items_ids } }, { silent: true });
            } else {
                return jQuery.Deferred().resolveWith(this);
            }
        }
    }, Singleton);
});
define('ProductDetails.Base.View', [
    'Backbone.FormView',
    'GlobalViews.Message.View',
    'Cart.AddToCart.Button.View',
    'ProductLine.Stock.View',
    'ProductViews.Price.View',
    'ProductLine.Sku.View',
    'ProductDetails.Options.Selector.View',
    'ProductDetails.Information.View',
    'ProductDetails.Quantity.View',
    'ProductDetails.ImageGallery.View',
    'ProductDetails.AddToProductList.View',
    'ProductLine.StockDescription.View',
    'Profile.Model',
    'Tracker',
    'SC.Configuration',
    'Backbone.CompositeView',
    'Backbone.Validation.callbacks',
    'RecentlyViewedItems.Collection',
    'Backbone',
    'jQuery',
    'underscore',
    'UrlHelper',
    'jQuery.scPush'
], function (BackboneFormView, GlobalViewsMessageView, CartAddToCartButtonView, ProductLineStockView, ProductViewsPriceView, ProductLineSkuView, ProductDetailsOptionsSelectorView, ProductDetailsInformationView, ProductDetailsQuantityView, ProductDetailsImageGalleryView, ProductDetailsAddToProductListView, ProductLineStockDescriptionView, ProfileModel, Tracker, Configuration, BackboneCompositeView, BackboneValidationCallbacks, RecentlyViewedItemsCollection, Backbone, jQuery, _) {
    'use strict';
    var ProductDetailsBaseView = Backbone.View.extend({
        title: '',
        page_header: '',
        modalClass: 'global-views-modal-large',
        showModalPageHeader: false,
        baseEvents: { 'submit [data-action="submit-form"]': 'mainActionHandler' },
        bindings: {
            '[name="quantity"]': {
                observe: 'quantity',
                setOptions: {
                    validate: true,
                    silent: false
                },
                onSet: function (quantity_str) {
                    return parseInt(quantity_str, 10);
                },
                events: [
                    'blur',
                    'change'
                ]
            },
            '[data-type="product-details-quantity-remove"]': {
                observe: 'quantity',
                update: function ($el, value) {
                    return $el.attr('disabled', value <= 1);
                }
            }
        },
        initialize: function initialize(options) {
            this.events = _.extend(this.events || {}, this.baseEvents);
            Backbone.View.prototype.initialize.apply(this, arguments);
            this.application = options.application;
            this.generateViewBindings();
            BackboneCompositeView.add(this);
            BackboneFormView.add(this, { noCloneModel: true });
            var self = this;
            this.model.areAttributesValid = _.wrap(this.model.areAttributesValid, function (fn, attributes, validators) {
                var are_attr_valid = fn.apply(self.model, [
                        attributes,
                        validators
                    ]), current_validation = _.extend({}, self.model.validation), attribute_validation_result;
                _.extend(self.model.validation, validators);
                if (~_.indexOf(attributes, 'options')) {
                    self.model.get('options').map(function (option) {
                        attributes.push(option.get('cartOptionId'));
                    });
                }
                _.each(attributes, function (attribute) {
                    attribute_validation_result = self.model.preValidate(attribute, self.model.get(attribute));
                    if (attribute_validation_result) {
                        BackboneValidationCallbacks.invalid(self, attribute, attribute_validation_result, 'name');
                    } else {
                        BackboneValidationCallbacks.valid(self, attribute, 'name');
                    }
                });
                self.model.validation = current_validation;
                return are_attr_valid;
            });
            if (ProductDetailsBaseView.mainActionView) {
                this.mainActionViewInstance = new ProductDetailsBaseView.mainActionView({
                    application: this.options.application,
                    model: this.model
                });
            }
        },
        mainActionHandler: function mainActionHandler(e) {
            if (ProductDetailsBaseView.mainActionView) {
                return this.mainActionViewInstance.submitHandler(e);
            } else {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        },
        showContent: function showContent() {
            var self = this;
            return Backbone.View.prototype.showContent.apply(this, arguments).done(function () {
                Tracker.getInstance().trackProductView(self.model);
                RecentlyViewedItemsCollection.getInstance().addHistoryItem(self.model.get('item'));
                self.$('[data-action="pushable"]').scPush();
            });
        },
        generateViewBindings: function generateViewBindings() {
            var self = this, option_bindings = self.model.get('options').reduce(function (bindings, option) {
                    var cart_option_id = option.get('cartOptionId');
                    bindings['[name="' + cart_option_id + '"]'] = {
                        observe: option.get('cartOptionId'),
                        setOptions: {
                            validate: true,
                            silent: true
                        },
                        onSet: function (value, options) {
                            var view = options.view, product_model = view.model, option = product_model.get('options').findWhere({ cartOptionId: options.observe }), current_value = option.get('value') && option.get('value').internalid;
                            if (!option.get('isMandatory') && current_value === value && view.$(options.selector).attr('type') === 'radio') {
                                value = null;
                            }
                            product_model.setOption(options.observe, value);
                            return value;
                        },
                        events: [self.getBindingEventForOption(option)]
                    };
                    bindings['[data-value="' + cart_option_id + '"]'] = {
                        observe: option.get('cartOptionId'),
                        onGet: function () {
                            return option.get('value') ? option.get('value').label : '';
                        }
                    };
                    _.each(option.get('values'), function (value) {
                        if (value.internalid) {
                            bindings['[data-label="label-' + cart_option_id + '"][value="' + value.internalid + '"]'] = {
                                attributes: [{
                                        name: 'class',
                                        observe: option.get('cartOptionId'),
                                        onGet: function () {
                                            if (!_.findWhere(option.get('values'), { internalid: value.internalid }).isAvailable) {
                                                return 'muted';
                                            } else if (value.internalid === (option.get('value') && option.get('value').internalid)) {
                                                return 'active';
                                            } else {
                                                return '';
                                            }
                                        }
                                    }]
                            };
                        }
                    });
                    return bindings;
                }, {});
            _.extend(this.bindings, option_bindings);
        },
        getBindingEventForOption: function getBindingEventForOption(option) {
            return ProductDetailsBaseView.optionBindEventByType[option.get('type').toLowerCase()] || 'blur';
        },
        updateURL: function updateURL() {
            Backbone.history.navigate(this.model.generateURL(), { replace: true });
            Tracker.getInstance().trackProductView(this.model);
        },
        getBreadcrumbPages: function getBreadcrumbPages() {
            return this.model.get('item').get('_breadcrumb');
        },
        render: function render() {
            this.title = this.model.get('item').get('_pageTitle');
            this.page_header = this.model.get('item').get('_pageHeader');
            this._render();
        },
        getMetaKeywords: function getMetaKeywords() {
            return this.getMetaTags().filter('[name="keywords"]').attr('content') || '';
        },
        getMetaTags: function getMetaTags() {
            return jQuery('<head/>').html(jQuery.trim(this.model.get('item').get('_metaTags'))).children('meta');
        },
        getMetaDescription: function getMetaDescription() {
            return this.getMetaTags().filter('[name="description"]').attr('content') || '';
        },
        showOptionsPusher: function showOptionsPusher() {
            return false;
        },
        contextData: {
            'product': function () {
                return this.model;
            },
            'item': function () {
                return this.model.get('item');
            }
        },
        childViews: {
            'Product.Options': function () {
                return new ProductDetailsOptionsSelectorView({
                    model: this.model,
                    application: this.application,
                    show_pusher: this.showOptionsPusher(),
                    show_required_label: this.model.get('item').get('itemtype') === 'GiftCert'
                });
            },
            'Product.Price': function () {
                return new ProductViewsPriceView({
                    model: this.model,
                    origin: this.inModal ? 'PDPQUICK' : 'PDPFULL'
                });
            },
            'MainActionView': function () {
                return this.mainActionViewInstance && this.mainActionViewInstance;
            },
            'Product.Stock.Info': function () {
                return new ProductLineStockView({ model: this.model });
            },
            'Product.Sku': function () {
                return new ProductLineSkuView({ model: this.model });
            },
            'Quantity': function () {
                return new ProductDetailsQuantityView({ model: this.model });
            },
            'Product.ImageGallery': function () {
                return new ProductDetailsImageGalleryView({ model: this.model });
            },
            'GlobalViewsMessageView.WronglyConfigureItem': function () {
                return new GlobalViewsMessageView({
                    message: _.translate('<b>Warning</b>: This item is not properly configured, please contact your administrator.'),
                    type: 'warning'
                });
            },
            'AddToProductList': function () {
                return new ProductDetailsAddToProductListView({
                    model: this.model,
                    application: this.options.application
                });
            },
            'StockDescription': function () {
                return new ProductLineStockDescriptionView({ model: this.model });
            }
        },
        getContext: function () {
            var item_model = this.model.get('item');
            return {
                model: this.model,
                pageHeader: this.page_header,
                itemUrl: item_model.get('_url') + this.model.getQuery(),
                isItemProperlyConfigured: item_model.isProperlyConfigured(),
                isPriceEnabled: !ProfileModel.getInstance().hidePrices()
            };
        }
    }, {
        optionBindEventByType: {
            'select': 'change',
            'text': 'blur',
            'date': 'change'
        },
        addMainActionView: function (main_action_view) {
            ProductDetailsBaseView.mainActionView = main_action_view;
        },
        getMainActionView: function () {
            return ProductDetailsBaseView.mainActionView;
        }
    });
    ProductDetailsBaseView.addMainActionView(CartAddToCartButtonView);
    return ProductDetailsBaseView;
});
define('ItemRelations.RelatedItem.View', [
    'ProductViews.Price.View',
    'GlobalViews.StarRating.View',
    'Backbone.CompositeView',
    'item_relations_related_item.tpl',
    'Backbone'
], function (ProductViewsPriceView, GlobalViewsStarRatingView, BackboneCompositeView, item_relations_related_item_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: item_relations_related_item_tpl,
        initialize: function () {
            Backbone.View.prototype.initialize.apply(this, arguments);
            BackboneCompositeView.add(this);
        },
        contextData: {
            'item': function () {
                return this.model;
            }
        },
        childViews: {
            'Item.Price': function () {
                return new ProductViewsPriceView({
                    model: this.model,
                    origin: 'RELATEDITEM'
                });
            },
            'Global.StarRating': function () {
                return new GlobalViewsStarRatingView({
                    model: this.model,
                    showRatingCount: false
                });
            }
        },
        getContext: function () {
            return {
                itemURL: this.model.getFullLink(),
                itemName: this.model.get('_name') || this.model.Name,
                thumbnail: this.model.getThumbnail(),
                sku: this.model.get('_sku'),
                itemId: this.model.get('_id'),
                model: this.model,
                showRating: SC.ENVIRONMENT.REVIEWS_CONFIG && SC.ENVIRONMENT.REVIEWS_CONFIG.enabled,
                track_productlist_list: this.model.get('track_productlist_list'),
                track_productlist_position: this.model.get('track_productlist_position'),
                track_productlist_category: this.model.get('track_productlist_category')
            };
        }
    });
});
define('ItemRelations.Related.Collection', [
    'SC.Configuration',
    'Item.Collection',
    'underscore',
    'Utils'
], function (Configuration, ItemCollection, _) {
    'use strict';
    return ItemCollection.extend({
        initialize: function (options) {
            this.searchApiMasterOptions = Configuration.searchApiMasterOptions.relatedItems;
            this.itemsIds = _.isArray(options.itemsIds) ? _.sortBy(options.itemsIds, function (id) {
                return id;
            }) : [options.itemsIds];
        },
        fetchItems: function () {
            return this.fetch({ data: { id: this.itemsIds.join(',') } });
        },
        parse: function (response) {
            var original_items = _.compact(response.items);
            if (original_items.length === 0) {
                return [];
            }
            if (original_items.length === 1) {
                return original_items[0].relateditems_detail;
            }
            var self = this, items = {};
            _.each(_.pluck(original_items, 'relateditems_detail'), function (related_items) {
                _.each(related_items, function (related_item) {
                    if (!_.contains(self.itemsIds, related_item.internalid) && !items[related_item.internalid]) {
                        items[related_item.internalid] = related_item;
                    }
                });
            });
            return _.toArray(items);
        }
    });
});
define('ItemRelations.Related.View', [
    'Backbone.CollectionView',
    'ItemRelations.RelatedItem.View',
    'ItemRelations.Related.Collection',
    'SC.Configuration',
    'Tracker',
    'item_relations_related.tpl',
    'item_relations_row.tpl',
    'item_relations_cell.tpl',
    'jQuery',
    'Backbone',
    'underscore',
    'Utils'
], function (BackboneCollectionView, ItemRelationsRelatedItemView, ItemRelationsRelatedCollection, Configuration, Tracker, item_relations_related_tpl, item_relations_row_tpl, item_relations_cell_tpl, jQuery, Backbone, _) {
    'use strict';
    return BackboneCollectionView.extend({
        initialize: function () {
            var is_sca_advance = this.options.application.getConfig('siteSettings.sitetype') === 'ADVANCED', collection = is_sca_advance ? new ItemRelationsRelatedCollection({ itemsIds: this.options.itemsIds }) : new Backbone.Collection(), layout = this.options.application.getLayout(), self = this;
            BackboneCollectionView.prototype.initialize.call(this, {
                collection: collection,
                viewsPerRow: Infinity,
                cellTemplate: item_relations_cell_tpl,
                rowTemplate: item_relations_row_tpl,
                childView: ItemRelationsRelatedItemView,
                template: item_relations_related_tpl
            });
            if (is_sca_advance) {
                layout.once('afterAppendView', self.loadRelatedItem, self);
                layout.currentView && layout.currentView.once('afterCompositeViewRender', self.loadRelatedItem, self);
            }
        },
        loadRelatedItem: function loadRelatedItem() {
            var self = this;
            self.collection.fetchItems().done(function () {
                Tracker.getInstance().trackProductList(self.collection, 'Related Items');
                self.render();
                var carousel = self.$el.find('[data-type="carousel-items"]');
                if (_.isPhoneDevice() === false && self.options.application.getConfig('siteSettings.imagesizes', false)) {
                    var img_min_height = _.where(self.options.application.getConfig('siteSettings.imagesizes', []), { name: self.options.application.getConfig('imageSizeMapping.thumbnail', '') })[0].maxheight;
                    carousel.find('.item-relations-related-item-thumbnail').css('minHeight', img_min_height);
                }
                _.initBxSlider(carousel, Configuration.get('bxSliderDefaults', {}));
            });
        },
        destroy: function destroy() {
            this._destroy();
            var layout = this.options.application.getLayout();
            layout.off('afterAppendView', this.loadRelatedItems, this);
            layout.currentView && layout.currentView.off('afterCompositeViewRender', this.loadRelatedItems, this);
        }
    });
});
define('ItemRelations.Correlated.Collection', [
    'SC.Configuration',
    'Item.Collection',
    'underscore',
    'Utils'
], function (Configuration, ItemCollection, _) {
    'use strict';
    return ItemCollection.extend({
        initialize: function (options) {
            this.searchApiMasterOptions = Configuration.searchApiMasterOptions.correlatedItems;
            this.itemsIds = _.isArray(options.itemsIds) ? _.sortBy(options.itemsIds, function (id) {
                return id;
            }) : [options.itemsIds];
        },
        fetchItems: function () {
            return this.fetch({ data: { id: this.itemsIds.join(',') } });
        },
        parse: function (response) {
            var original_items = _.compact(response.items) || [], self = this, items = {};
            _.each(_.pluck(original_items, 'correlateditems_detail'), function (correlated_items) {
                _.each(correlated_items, function (correlated_item) {
                    if (!_.contains(self.itemsIds, correlated_item.internalid) && !items[correlated_item.internalid]) {
                        items[correlated_item.internalid] = correlated_item;
                    }
                });
            });
            return _.toArray(items);
        }
    });
});
define('ItemRelations.Correlated.View', [
    'Backbone.CollectionView',
    'ItemRelations.RelatedItem.View',
    'ItemRelations.Correlated.Collection',
    'Tracker',
    'item_relations_correlated.tpl',
    'item_relations_row.tpl',
    'item_relations_cell.tpl',
    'SC.Configuration',
    'Backbone',
    'underscore',
    'Utils'
], function (BackboneCollectionView, ItemRelationsRelatedItemView, ItemRelationsCorrelatedCollection, Tracker, item_relations_correlated_tpl, item_relations_row_tpl, item_relations_cell_tpl, Configuration, Backbone, _) {
    'use strict';
    return BackboneCollectionView.extend({
        initialize: function () {
            var is_sca_advanced = Configuration.get('siteSettings.sitetype') === 'ADVANCED', collection = is_sca_advanced ? new ItemRelationsCorrelatedCollection({ itemsIds: this.options.itemsIds }) : new Backbone.Collection(), layout = this.options.application.getLayout(), self = this;
            BackboneCollectionView.prototype.initialize.call(this, {
                collection: collection,
                viewsPerRow: Infinity,
                cellTemplate: item_relations_cell_tpl,
                rowTemplate: item_relations_row_tpl,
                childView: ItemRelationsRelatedItemView,
                template: item_relations_correlated_tpl
            });
            if (is_sca_advanced) {
                layout.once('afterAppendView', self.loadRelatedItems, self);
                layout.currentView && layout.currentView.once('afterCompositeViewRender', self.loadRelatedItems, self);
            }
        },
        loadRelatedItems: function loadRelatedItems() {
            var self = this;
            self.collection.fetchItems().done(function () {
                Tracker.getInstance().trackProductList(self.collection, 'Correlated Items');
                self.render();
                var carousel = self.$el.find('[data-type="carousel-items"]');
                if (_.isPhoneDevice() === false && self.options.application.getConfig('siteSettings.imagesizes')) {
                    var img_min_height = _.where(self.options.application.getConfig('siteSettings.imagesizes'), { name: self.options.application.getConfig('imageSizeMapping.thumbnail') })[0].maxheight;
                    carousel.find('.item-relations-related-item-thumbnail').css('minHeight', img_min_height);
                }
                _.initBxSlider(carousel, Configuration.bxSliderDefaults);
            });
        },
        destroy: function destroy() {
            this._destroy();
            var layout = this.options.application.getLayout();
            layout.off('afterAppendView', this.loadRelatedItems, this);
            layout.currentView && layout.currentView.off('afterCompositeViewRender', this.loadRelatedItems, this);
        }
    });
});
define('SocialSharing.Flyout.View', [
    'social_sharing_flyout.tpl',
    'Backbone'
], function (social_sharing_flyout_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: social_sharing_flyout_tpl,
        getContext: function () {
            return {};
        }
    });
});
define('ProductDetails.Full.View', [
    'ProductDetails.Base.View',
    'SC.Configuration',
    'ItemRelations.Related.View',
    'ItemRelations.Correlated.View',
    'ProductDetails.Information.View',
    'SocialSharing.Flyout.View',
    'product_details_full.tpl',
    'underscore'
], function (ProductDetailsBaseView, Configuration, ItemRelationsRelatedView, ItemRelationsCorrelatedView, ProductDetailsInformationView, SocialSharingFlyoutView, product_details_full_tpl, _) {
    'use strict';
    return ProductDetailsBaseView.extend({
        template: product_details_full_tpl,
        attributes: {
            'id': 'ProductDetails.Full.View',
            'class': 'view product-detail'
        },
        bindings: _.extend({}, ProductDetailsBaseView.prototype.bindings, {}),
        initialize: function initialize() {
            ProductDetailsBaseView.prototype.initialize.apply(this, arguments);
            this.model.on('change', this.updateURL, this);
        },
        childViews: _.extend({}, ProductDetailsBaseView.prototype.childViews, {
            'Correlated.Items': function () {
                return new ItemRelationsCorrelatedView({
                    itemsIds: this.model.get('item').get('internalid'),
                    application: this.application
                });
            },
            'Related.Items': function () {
                return new ItemRelationsRelatedView({
                    itemsIds: this.model.get('item').get('internalid'),
                    application: this.application
                });
            },
            'Product.Information': function () {
                return new ProductDetailsInformationView({ model: this.model });
            },
            'SocialSharing.Flyout': function () {
                return new SocialSharingFlyoutView({});
            }
        }),
        destroy: function destroy() {
            this.model.off('change');
            return this._destroy();
        },
        showOptionsPusher: function showOptionsPusher() {
            var options_values_length = _.reduce(this.model.get('options').map(function (option) {
                if (_.isArray(option.get('values'))) {
                    var invalid_values = _.filter(option.get('values'), function (value) {
                        return !value.internalid;
                    });
                    return option.get('values').length - invalid_values.length;
                }
                return 0;
            }), function (memo, num) {
                return memo + num;
            }, 0);
            return options_values_length > Configuration.get('ItemOptions.maximumOptionValuesQuantityWithoutPusher', 1);
        },
        getContext: function getContext() {
            return _.extend(ProductDetailsBaseView.prototype.getContext.apply(this, arguments), {});
        }
    });
});
define('Cart.QuickAddToCart.View', [
    'SC.Configuration',
    'LiveOrder.Model',
    'Backbone.CompositeView',
    'Cart.AddToCart.Button.View',
    'ProductViews.Price.View',
    'cart_quickaddtocart.tpl',
    'Backbone',
    'underscore'
], function (Configuration, LiveOrderModel, BackboneCompositeView, CartAddToCartButtonView, ProductViewsPriceView, cart_quickaddtocart_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: cart_quickaddtocart_tpl,
        events: { 'blur [data-action="setquantity"]': 'updateQuantity' },
        initialize: function initialize() {
            BackboneCompositeView.add(this);
            this.cart = LiveOrderModel.getInstance();
            this.showQuickAddToCartButton = !!(Configuration.get('addToCartFromFacetsView', false) && this.model.getItem().get('_isPurchasable') && this.model.areAttributesValid(['options']));
        },
        getMinimumQuantity: function getMinimumQuantity() {
            return !this.cart.findLine(this.model) ? this.model.getItem().get('_minimumQuantity') : 1;
        },
        updateQuantity: function updateQuantity(e) {
            var new_quantity = parseInt(this.$(e.target).val(), 10), minimumQuantity = this.getMinimumQuantity();
            if (_.isNaN(new_quantity) || !_.isNumber(new_quantity) || new_quantity < minimumQuantity) {
                new_quantity = minimumQuantity;
            }
            this.model.set('quantity', new_quantity);
            this.render();
        },
        childViews: {
            'AddToCart': function () {
                return new CartAddToCartButtonView({
                    model: this.model,
                    application: this.options.application
                });
            },
            'ProductViewsPrice.Price': function () {
                return new ProductViewsPriceView({
                    model: this.model,
                    origin: 'ITEMCELL'
                });
            }
        },
        getContext: function getContext() {
            var item_model = this.model.get('item');
            return {
                itemId: item_model.get('_id'),
                showQuickAddToCartButton: this.showQuickAddToCartButton,
                minimumQuantity: this.getMinimumQuantity(),
                quantity: this.model.get('quantity')
            };
        }
    });
});
define('Facets.ItemCell.View', [
    'ProductLine.Stock.View',
    'Product.Model',
    'GlobalViews.StarRating.View',
    'Cart.QuickAddToCart.View',
    'ProductViews.Option.View',
    'ProductLine.StockDescription.View',
    'SC.Configuration',
    'Utils',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'underscore'
], function (ProductLineStockView, ProductModel, GlobalViewsStarRating, CartQuickAddToCartView, ProductViewsOptionView, ProductLineStockDescriptionView, Configuration, Utils, Backbone, BackboneCompositeView, BackboneCollectionView, _) {
    'use strict';
    return Backbone.View.extend({
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        contextData: {
            'item': function () {
                return this.model;
            }
        },
        childViews: {
            'ItemViews.Stock': function () {
                return new ProductLineStockView({ model: this.model });
            },
            'GlobalViews.StarRating': function () {
                var view = new GlobalViewsStarRating({
                    model: this.model,
                    showRatingCount: false,
                    queryOptions: Utils.parseUrlOptions(location.href)
                });
                return this.options.showStarRating === false ? null : view;
            },
            'ItemDetails.Options': function () {
                var options_configuration = Configuration.get('ItemOptions.optionsConfiguration', []);
                return new BackboneCollectionView({
                    collection: _.filter(this.model.get('options').sortBy('index'), function (option) {
                        var option_configuration = _.findWhere(options_configuration, { cartOptionId: option.get('cartOptionId') });
                        return option_configuration && option_configuration.showSelectorInList;
                    }),
                    childView: ProductViewsOptionView,
                    viewsPerRow: 1,
                    childViewOptions: {
                        item: this.model,
                        templateName: 'facetCell',
                        showLink: true,
                        hideLabel: true,
                        showSmall: true
                    }
                });
            },
            'Cart.QuickAddToCart': function () {
                var product = new ProductModel({
                    item: this.model,
                    quantity: this.model.get('_minimumQuantity', true)
                });
                return new CartQuickAddToCartView({
                    model: product,
                    application: this.options.application
                });
            },
            'StockDescription': function () {
                return new ProductLineStockDescriptionView({ model: this.model });
            }
        },
        getContext: function () {
            return {
                itemId: this.model.get('_id'),
                name: this.model.get('_name'),
                url: this.model.get('_url'),
                sku: this.model.getSku(),
                isEnvironmentBrowser: SC.ENVIRONMENT.jsEnvironment === 'browser' && !SC.ENVIRONMENT.isTouchEnabled,
                thumbnail: this.model.getThumbnail(),
                itemIsNavigable: !_.isUndefined(this.options.itemIsNavigable) ? !!this.options.itemIsNavigable : true,
                showRating: SC.ENVIRONMENT.REVIEWS_CONFIG && SC.ENVIRONMENT.REVIEWS_CONFIG.enabled,
                rating: this.model.get('_rating'),
                track_productlist_list: this.model.get('track_productlist_list'),
                track_productlist_position: this.model.get('track_productlist_position'),
                track_productlist_category: this.model.get('track_productlist_category')
            };
        }
    });
});
define('StoreLocator.Search.View', [
    'store_locator_search.tpl',
    'AjaxRequestsKiller',
    'underscore',
    'SC.Configuration',
    'Backbone',
    'Backbone.FormView',
    'jQuery',
    'Utils'
], function (store_locator_search_tpl, AjaxRequestsKiller, _, Configuration, Backbone, BackboneFormView, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_search_tpl,
        events: {
            'click [data-action="use-geolocation"]': 'useGeolocation',
            'submit form': 'saveFormCustom',
            'keypress [name="city"]': 'saveFormCustom'
        },
        saveFormCustom: function saveFormCustom(e) {
            if (e.type === 'keypress' && e.keyCode === 13 || e.type === 'submit') {
                e.preventDefault();
                e.stopPropagation();
                var self = this, args = arguments;
                setTimeout(function () {
                    self.saveForm.apply(self, args);
                }, 500);
            }
        },
        initialize: function initialize(options) {
            this.model = new Backbone.Model();
            var view = this;
            this.model.validation = {
                city: {
                    fn: function (value) {
                        var position = view.reference_map.getPosition();
                        if (!value) {
                            return _('Please select an address.').translate();
                        } else if (value && !position) {
                            return _('Address not found.').translate();
                        } else if (position.address !== value) {
                            return _('Please select a valid address.').translate();
                        }
                    }
                }
            };
            this.model.sync = _.bind(this.findStores, this);
            BackboneFormView.add(this, { noCloneModel: true });
            this.application = options.application;
            this.reference_map = options.reference_map;
            this.collection = options.collection;
            this.profileModel = options.profileModel;
            var self = this, position_promise = jQuery.Deferred(), store_locator_last_search = this.profileModel.get('storeLocator_last_search'), position = this.reference_map.getPosition();
            if (!position.refineSearch) {
                if (store_locator_last_search) {
                    this.reference_map.setPosition({
                        latitude: store_locator_last_search.latitude,
                        longitude: store_locator_last_search.longitude,
                        address: store_locator_last_search.address
                    });
                    position_promise.resolve();
                } else if (this.options.useGeolocation) {
                    this.getCurrentPositionGeolocation().done(function () {
                        position_promise.resolve();
                    });
                }
            }
            position_promise.done(function () {
                self.findStores();
            });
            this.collection.on('sync, reset', this.render, this);
            this.reference_map.on('change:position', function () {
                self.setInputValue();
            });
        },
        render: function render() {
            if (!this.options.alwaysVisible && this.collection.length) {
                this.$el.empty();
                return this;
            }
            this._render();
            var self = this;
            this.$input = this.$('[data-type="autocomplete-input"]');
            this.reference_map.load().done(function () {
                self.reference_map.showAutoCompleteInput(self.$input.get(0));
                self.setInputValue();
            });
            return this;
        },
        setInputValue: function setInputValue() {
            var position = this.reference_map.getPosition();
            if (position) {
                this.$input && this.$input.val(position.address);
            }
        },
        getCurrentPositionGeolocation: function getCurrentPositionGeolocation() {
            var promise = jQuery.Deferred(), self = this;
            this.reference_map.getCurrentPositionGeolocation().done(function () {
                self.reference_map.load().done(function () {
                    self.reference_map.getCityGeoCode().done(function () {
                        promise.resolveWith(self, self.reference_map.getPosition());
                    });
                });
            }).fail(function (error) {
                promise.rejectWith(self, arguments);
                self.blockPosition(error);
            });
            return promise;
        },
        useGeolocation: function useGeolocation() {
            this.reference_map.clearPointList();
            var self = this;
            this.$('[data-action="message-warning"]').hide();
            this.getCurrentPositionGeolocation().done(function () {
                self.findStores();
            });
        },
        blockPosition: function blockPosition(error) {
            switch (error.code) {
            case error.PERMISSION_DENIED:
                this.$('[data-action="message-warning"]').html(_('To use this functionality enable geolocation.').translate()).show();
                break;
            case error.POSITION_UNAVAILABLE:
                this.$('[data-action="message-warning"]').html(_('Location information is unavailable.').translate()).show();
                break;
            case error.TIMEOUT:
                this.$('[data-action="message-warning"]').html(_('The request to get user location timed out.').translate()).show();
                break;
            case error.UNKNOWN_ERROR:
                this.$('[data-action="message-warning"]').html(_('An unknown error occurred.').translate()).show();
                break;
            }
        },
        findStores: function findStores(method, model, callbacks) {
            this.collection.reset();
            var position = this.reference_map.getPosition();
            if (position && position.address) {
                this.profileModel.set('storeLocator_last_search', position);
                return this.collection.update({
                    latitude: position.latitude,
                    longitude: position.longitude,
                    radius: this.reference_map.configuration.getRadius(),
                    sort: 'distance',
                    page: 'all',
                    killerId: AjaxRequestsKiller.getKillerId(),
                    reset: true,
                    locationtype: Configuration.get('storeLocator.defaultTypeLocations')
                }, callbacks);
            }
        },
        getContext: function getContext() {
            return {
                showUseCurrentLocationButton: this.options.useGeolocation,
                showResults: !!this.collection.length
            };
        }
    });
});
define('StoreLocator.Model', [
    'Location.Model',
    'Utils'
], function (LocationModel, Utils) {
    'use strict';
    return LocationModel.extend({ urlRoot: Utils.getAbsoluteUrl('services/StoreLocator.Service.ss') });
});
define('StoreLocator.Collection', [
    'Location.Collection',
    'StoreLocator.Model',
    'underscore',
    'Utils'
], function (LocationCollection, StoreLocatorModel, _, Utils) {
    'use strict';
    return LocationCollection.extend({
        model: StoreLocatorModel,
        url: Utils.getAbsoluteUrl('services/StoreLocator.Service.ss')
    });
});
define('Location.VenueDetails.View', [
    'locator_venue_details.tpl',
    'underscore',
    'Backbone.CompositeView',
    'Backbone'
], function (locator_venue_details_tpl, _, BackboneCompositeView, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: locator_venue_details_tpl,
        initialize: function initialize(options) {
            this.model = options.model;
            this.application = options.application;
            this.show_address = options.showAddress;
            this.hide_cutoff_time = options.hideCutoffTime;
            BackboneCompositeView.add(this);
        },
        setOpeningHours: function setOpeningHours() {
            var opening_hours = this.model.get('servicehours'), opening_hours_str_list = [];
            _.each(opening_hours, function (row) {
                var hours = row.starttime + _.translate(' to ') + row.endtime, days_list = [
                        row.monday === 'T',
                        row.tuesday === 'T',
                        row.wednesday === 'T',
                        row.thursday === 'T',
                        row.friday === 'T',
                        row.saturday === 'T',
                        row.sunday === 'T'
                    ], days_name = [
                        _.translate('Monday'),
                        _.translate('Tuesday'),
                        _.translate('Wednesday'),
                        _.translate('Thursday'),
                        _.translate('Friday'),
                        _.translate('Saturday'),
                        _.translate('Sunday')
                    ], days = '', sequence_days = [], discontinuous_days = [], sequence_active = false, sequence_finish = false;
                _.each(days_list, function (day, key) {
                    if (day) {
                        if (sequence_days.length === 0) {
                            sequence_active = true;
                        }
                        if (sequence_active && !sequence_finish) {
                            sequence_days.push(days_name[key]);
                        } else {
                            discontinuous_days.push(days_name[key]);
                        }
                    } else if (sequence_active) {
                        if (sequence_days.length < 3) {
                            sequence_active = false;
                            discontinuous_days = discontinuous_days.concat(sequence_days);
                            sequence_days = [];
                        } else {
                            sequence_finish = true;
                        }
                    }
                });
                if (sequence_days.length < 3) {
                    sequence_active = false;
                    discontinuous_days = discontinuous_days.concat(sequence_days);
                }
                if (sequence_active) {
                    days = sequence_days[0] + _.translate(' to ') + sequence_days[sequence_days.length - 1];
                }
                _.each(discontinuous_days, function (discontinuous_day, key) {
                    if (key === 0 && !sequence_active) {
                        days = days + discontinuous_day;
                    } else if (key === discontinuous_days.length - 1) {
                        days = days + _.translate(' and ') + discontinuous_day;
                    } else {
                        days = days + ', ' + discontinuous_day;
                    }
                });
                var open_hours_row = { row: days + ' - ' + hours };
                opening_hours_str_list.push(open_hours_row);
            });
            return opening_hours_str_list;
        },
        getContext: function getContext() {
            var model = this.model;
            return {
                location: model,
                showAddress: this.show_address,
                showStoreAddress: !!model.get('address1'),
                showCity: !!model.get('city'),
                showZipCode: !!model.get('zip'),
                showStoreState: !!model.get('state'),
                showPhone: !!model.get('phone'),
                showServiceHours: !!(model.get('servicehours') && model.get('servicehours').length),
                serviceHours: this.setOpeningHours(),
                showCutoffTime: !this.hide_cutoff_time && !!model.get('nextpickupday'),
                nextPickupDayIsToday: this.model.get('nextpickupday') === 'today',
                nextPickupDayIsTomorrow: this.model.get('nextpickupday') === 'tomorrow',
                nextPickupDayIsSunday: this.model.get('nextpickupday') === 'sunday',
                nextPickupDayIsMonday: this.model.get('nextpickupday') === 'monday',
                nextPickupDayIsTuesday: this.model.get('nextpickupday') === 'tuesday',
                nextPickupDayIsWednesday: this.model.get('nextpickupday') === 'wednesday',
                nextPickupDayIsThursday: this.model.get('nextpickupday') === 'thursday',
                nextPickupDayIsFriday: this.model.get('nextpickupday') === 'friday',
                nextPickupDayIsSaturday: this.model.get('nextpickupday') === 'saturday'
            };
        }
    });
});
define('PickupInStore.StoreSelector.List.Row.View', [
    'pickup_in_store_store_selector_list_row.tpl',
    'Location.VenueDetails.View',
    'LiveOrder.Model',
    'Backbone.CollectionView',
    'Backbone.CompositeView',
    'Backbone',
    'jQuery',
    'jquery.cookie'
], function (pickup_in_store_store_selector_list_row_tpl, LocationVenueDetailsView, LiveOrderModel, BackboneCollectionView, BackboneCompositeView, Backbone, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: pickup_in_store_store_selector_list_row_tpl,
        events: {
            'click [data-store-id]': 'selectStore',
            'show.bs.dropdown': 'setFlyoutPosition'
        },
        initialize: function initialize(options) {
            this.model = options.model;
            this.product = options.product;
            this.application = options.application;
            this.source = options.source;
            BackboneCompositeView.add(this);
        },
        childViews: {
            'PickupInStore.StoreLocationInfo': function () {
                var self = this;
                return new LocationVenueDetailsView({
                    model: self.model,
                    application: self.application,
                    showAddress: false
                });
            }
        },
        selectStore: function selectStore(e) {
            e.preventDefault();
            this.product.set('location', this.model);
            this.product.set('fulfillmentChoice', 'pickup');
            jQuery.cookie('myStore', this.model.get('internalid'));
            if (this.source && this.source === 'cart') {
                var self = this, cart_promise = LiveOrderModel.getInstance().updateLine(this.product);
                cart_promise.done(function () {
                    self.options.application.getLayout().closeModal();
                });
            }
        },
        setFlyoutPosition: function setFlyoutPosition(e) {
            var element_link = jQuery(e.relatedTarget), element_dropdown = element_link.siblings('[data-type="opening-hours-flyout"]'), element_parent_list = element_link.closest('[data-type="store-row"]'), bottom_distance = element_parent_list.offset().top + element_parent_list.height() - (element_link.offset().top + element_link.height());
            if (bottom_distance < element_dropdown.height()) {
                element_dropdown.addClass('pickup-in-store-store-selector-list-row-opening-hours-flyout-content-up');
            } else {
                element_dropdown.removeClass('pickup-in-store-store-selector-list-row-opening-hours-flyout-content-up');
            }
        },
        getContext: function getContext() {
            var is_store_selected = parseInt(this.product.get('location').get('internalid'), 10) === parseInt(this.model.get('internalid'), 10);
            return {
                location: this.model,
                showStoreAddress: !!this.model.get('address1'),
                areSetCityAndAddress: !!this.model.get('address1') && !!this.model.get('city'),
                showCity: !!this.model.get('city'),
                showStoreState: !!this.model.get('state'),
                showZipCode: !!this.model.get('zip'),
                showServiceHours: !!this.model.get('servicehours') && !!this.model.get('servicehours').length && !!this.model.get('servicehours')[0].starttime,
                showPhone: !!this.model.get('phone'),
                storeHasStock: this.model.get('qtyavailableforstorepickup') > 0,
                isStoreSelected: is_store_selected
            };
        }
    });
});
define('PickupInStore.StoreSelector.ItemDetail.View', [
    'Transaction.Line.Views.Options.Selected.View',
    'Transaction.Line.Views.Price.View',
    'ProductLine.Sku.View',
    'Backbone.CollectionView',
    'Backbone.CompositeView',
    'pickup_in_store_store_selector_item_detail.tpl',
    'Backbone'
], function (TransactionLineViewsOptionsSelectedView, TransactionLineViewsPriceView, ProductLineSkuView, BackboneCollectionView, BackboneCompositeView, transaction_line_views_cell_navigable_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: transaction_line_views_cell_navigable_tpl,
        initialize: function (options) {
            this.options = options;
            this.application = options.application;
            this.model = options.model;
            BackboneCompositeView.add(this);
        },
        childViews: {
            'Item.Price': function () {
                return new TransactionLineViewsPriceView({ model: this.model });
            },
            'Item.Sku': function () {
                return new ProductLineSkuView({ model: this.model });
            }
        },
        getContext: function () {
            var item = this.model.get('item');
            return {
                itemName: item.get('_name'),
                thumbnail: this.model.getThumbnail()
            };
        }
    });
});
define('PickupInStore.StoreSelector.List.View', [
    'pickup_in_store_store_selector_list.tpl',
    'StoreLocator.Search.View',
    'StoreLocator.Collection',
    'PickupInStore.StoreSelector.List.Row.View',
    'PickupInStore.StoreSelector.ItemDetail.View',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Profile.Model',
    'Backbone',
    'GlobalViews.Message.View',
    'underscore'
], function (pickup_in_store_store_selector_list_tpl, StoreLocatorSearchView, StoreLocatorCollection, PickupInStoreStoreSelectorListRowView, PickupInStoreStoreSelectorItemDetailView, BackboneCompositeView, BackboneCollectionView, ProfileModel, Backbone, GlobalViewsMessageView, _) {
    'use strict';
    return Backbone.View.extend({
        template: pickup_in_store_store_selector_list_tpl,
        events: { 'click [data-action="refine-search"]': 'refineSearch' },
        initialize: function initialize(options) {
            this.store_collection = options.store_collection;
            this.model = options.model;
            this.application = options.application;
            this.source = options.source;
            this.reference_map = options.reference_map;
            BackboneCompositeView.add(this);
            this.store_collection.on('reset', this.render, this);
        },
        childViews: {
            'StoresList.Rows': function () {
                return new BackboneCollectionView({
                    collection: this.stores,
                    viewsPerRow: 1,
                    childView: PickupInStoreStoreSelectorListRowView,
                    childViewOptions: {
                        product: this.model,
                        application: this.application,
                        source: this.source
                    }
                });
            },
            'GlobalMessageStoresStockUnavailable': function () {
                return new GlobalViewsMessageView({
                    message: _.translate('We\'re sorry, it looks like the stores nearby that offer pickup are out of stock today.'),
                    type: 'warning',
                    closable: false
                });
            },
            'GlobalMessageStoresUnavailable': function () {
                return new GlobalViewsMessageView({
                    message: _.translate('We\'re sorry, it looks like there are no stores nearby that offer pickup.'),
                    type: 'warning',
                    closable: false
                });
            },
            'Line.Item.Information': function () {
                if (this.source && this.source === 'cart') {
                    return new PickupInStoreStoreSelectorItemDetailView({
                        model: this.model,
                        application: this.application
                    });
                }
            }
        },
        refineSearch: function refineSearch(e) {
            e.preventDefault();
            this.reference_map.myposition = null;
            this.store_collection.reset();
        },
        render: function render() {
            var self = this;
            this.item = this.model.getItem();
            this.stock_information_per_location = this.item.get('_quantityavailableforstorepickup_detail');
            this.stores = _.compact(_.map(this.stock_information_per_location, function (location) {
                var store_information = self.store_collection.get(location.internalid);
                return store_information && store_information.set(location);
            }));
            this.stores.sort(function (store, other_store) {
                if (store.get('qtyavailableforstorepickup') === 0 && other_store.get('qtyavailableforstorepickup') > 0) {
                    return 1;
                } else if (store.get('qtyavailableforstorepickup') > 0 && other_store.get('qtyavailableforstorepickup') === 0) {
                    return -1;
                }
                return store.get('distance') - other_store.get('distance');
            });
            this.stock_pickup = false;
            _.each(this.stores, function (stores) {
                if (stores.get('qtyavailableforstorepickup') > 0) {
                    self.stock_pickup = true;
                    return;
                }
            });
            if (this.stores.length || this.store_collection.length) {
                this._render();
            } else {
                this.$el.empty();
            }
        },
        getContext: function getContext() {
            return {
                stores: this.stores,
                storesLength: this.stores.length,
                isOneStore: this.stores.length === 1,
                isEmptyStores: this.stores.length === 0,
                stockPickup: this.stock_pickup,
                model: this.model,
                maxHeight: window.innerHeight / 2 - 60,
                myPosition: this.reference_map.myposition && this.reference_map.myposition.address ? this.reference_map.myposition.address : ''
            };
        }
    });
});
define('PickupInStore.StoreSelector.View', [
    'pickup_in_store_store_selector.tpl',
    'StoreLocator.Search.View',
    'PickupInStore.StoreSelector.List.View',
    'StoreLocator.Collection',
    'Backbone',
    'Backbone.CompositeView',
    'Profile.Model',
    'Utils'
], function (pickup_in_store_store_selector_tpl, StoreLocatorSearchView, PickupInStoreStoreSelectorListView, StoreLocatorCollection, Backbone, BackboneCompositeView, ProfileModel, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: pickup_in_store_store_selector_tpl,
        title: Utils.translate('Select Store'),
        initialize: function initialize(options) {
            Backbone.View.prototype.initialize.apply(this, arguments);
            BackboneCompositeView.add(this);
            this.model = options.model;
            this.application = options.application;
            this.item = this.model.getItem();
            this.item_pickup_in_store_locations = this.item.get('_quantityavailableforstorepickup_detail');
            this.source = options.source;
            this.reference_map = this.options.reference_map;
            this.store_collection = new StoreLocatorCollection();
        },
        focusFirstInput: function focusFirstInput() {
            return !this.store_collection.length;
        },
        childViews: {
            'StoreSearch': function () {
                return new StoreLocatorSearchView({
                    collection: this.store_collection,
                    application: this.application,
                    reference_map: this.reference_map,
                    profileModel: ProfileModel.getInstance(),
                    alwaysVisible: !Utils.isPhoneDevice(),
                    useGeolocation: window.location.protocol === 'https:'
                });
            },
            'StoreList': function () {
                return new PickupInStoreStoreSelectorListView({
                    store_collection: this.store_collection,
                    application: this.application,
                    reference_map: this.reference_map,
                    profileModel: ProfileModel.getInstance(),
                    model: this.model,
                    source: this.source
                });
            }
        }
    });
});
define('PickupInStore.View', [
    'pickup_in_store.tpl',
    'PickupInStore.StoreSelector.View',
    'Location.VenueDetails.View',
    'LiveOrder.Model',
    'Profile.Model',
    'ReferenceMap',
    'Backbone.CompositeView',
    'Backbone',
    'underscore'
], function (pickup_in_store_tpl, PickupInStoreStoreSelectorView, LocationVenueDetailsView, LiveOrderModel, ProfileModel, ReferenceMap, BackboneCompositeView, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: pickup_in_store_tpl,
        events: {
            'change [data-action="selectShip"]': 'selectShip',
            'change [data-action="selectPickup"]': 'selectPickup',
            'click [data-action="selectPickupLink"]': 'selectPickup',
            'click [data-action="changeStore"]': 'changeStore'
        },
        initialize: function initialize(options) {
            BackboneCompositeView.add(this);
            this.model = options.model;
            this.application = options.application;
            this.source = options.source;
            this.profile_model = ProfileModel.getInstance();
            this.reference_map = new ReferenceMap();
            this.model.on('change:location', this.render, this);
            this.model.on('change:location', this.dismissSelectStore, this);
            this.model.on('change:fulfillmentChoice', this.render, this);
            this.model.get('location').on('change', this.render, this);
            this.model.get('options').on('change', this.render, this);
        },
        render: function render() {
            if (this.model.getItem().get('_isfulfillable')) {
                return this._render();
            }
            return this;
        },
        childViews: {
            'PickupInStore.StoreLocationInfo': function () {
                var self = this;
                if (this.model.get('location')) {
                    return new LocationVenueDetailsView({
                        model: this.model.get('location'),
                        application: self.application,
                        showAddress: true
                    });
                }
            }
        },
        selectShip: function selectShip(e) {
            e.preventDefault();
            this.model.set('fulfillmentChoice', 'ship');
            if (this.source && this.source === 'cart') {
                LiveOrderModel.getInstance().updateLine(this.model);
            }
        },
        selectPickup: function selectPickup(e) {
            e.preventDefault();
            if (this.getLocationStock() > 0) {
                this.model.set('fulfillmentChoice', 'pickup');
                if (this.source && this.source === 'cart') {
                    LiveOrderModel.getInstance().updateLine(this.model);
                }
            } else {
                this.changeStore(e);
            }
        },
        changeStore: function changeStore(e) {
            e.preventDefault();
            var self = this, view = new PickupInStoreStoreSelectorView({
                    model: this.model,
                    application: this.application,
                    reference_map: this.reference_map,
                    source: this.source
                });
            if (_.isPhoneDevice()) {
                this.application.getLayout().showInPush(view);
            } else {
                view.showInModal({ className: 'pickup-in-store-select-store-modal' });
                view.on('modal-close', function () {
                    if (!self.model.get('location').get('internalid')) {
                        self.render();
                    }
                });
            }
        },
        dismissSelectStore: function dismissSelectStore() {
            if (_.isPhoneDevice()) {
                this.application.getLayout().closePush();
            } else {
                this.application.getLayout().closeModal();
            }
        },
        getLocationStock: function getLocationStock() {
            var location = this.model.get('location'), stock_information = this.model.getStockInfo(), location_stock = location ? _.findWhere(stock_information.stockPerLocation, { internalid: parseInt(location.get('internalid'), 10) }) : null;
            return location_stock ? location_stock.qtyavailableforstorepickup : 0;
        },
        getContext: function getContext() {
            var location = this.model.get('location'), item = this.model.getItem(), stock_information = this.model.getStockInfo(), location_stock = this.getLocationStock(), is_available_for_ship = item.get('_isBackorderable') || item.get('_isInStock'), internal_id = this.source && this.source === 'cart' ? this.model.get('internalid') : item.get('internalid');
            return {
                isAvailableForShip: is_available_for_ship,
                isAvailableForPickup: stock_information.isAvailableForPickup,
                getDirectionsUrl: location && !location.isNew() ? this.reference_map.getDirectionsUrl(this.profile_model.get('storeLocator_last_search'), location.get('location')) : '',
                showDividerLines: this.options.source !== 'cart',
                isShipSelected: this.model.get('fulfillmentChoice') !== 'pickup',
                isPickupSelected: this.model.get('fulfillmentChoice') === 'pickup',
                stockInfo: stock_information,
                showQuantityAvailable: stock_information.showQuantityAvailable && !_.isUndefined(stock_information.stock),
                isAvailableForPickupOnly: stock_information.isAvailableForPickup && !is_available_for_ship,
                isAvailableForShipOnly: !stock_information.isAvailableForPickup && is_available_for_ship,
                isAvailable: stock_information.isAvailableForPickup || is_available_for_ship,
                isLocationSelected: location && !location.isNew(),
                locationHasStock: location_stock > 0,
                locationStock: location_stock,
                locationShowNextPickupDay: location && !!location.get('nextpickupcutofftime'),
                location: location,
                model: this.model,
                showCutoffTime: !!location.get('nextpickupday'),
                nextPickupDayIsToday: location.get('nextpickupday') === 'today',
                nextPickupDayIsTomorrow: location.get('nextpickupday') === 'tomorrow',
                nextPickupDayIsSunday: location.get('nextpickupday') === 'sunday',
                nextPickupDayIsMonday: location.get('nextpickupday') === 'monday',
                nextPickupDayIsTuesday: location.get('nextpickupday') === 'tuesday',
                nextPickupDayIsWednesday: location.get('nextpickupday') === 'wednesday',
                nextPickupDayIsThursday: location.get('nextpickupday') === 'thursday',
                nextPickupDayIsFriday: location.get('nextpickupday') === 'friday',
                nextPickupDayIsSaturday: location.get('nextpickupday') === 'saturday',
                itemInternalId: internal_id
            };
        }
    });
});
define('PickupInStore.FulfillmentOptions.View', [
    'pickup_in_store_fulfillment_options.tpl',
    'Backbone.CompositeView',
    'Backbone'
], function (pickup_in_store_fulfillment_options_tpl, BackboneCompositeView, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: pickup_in_store_fulfillment_options_tpl,
        initialize: function initialize(options) {
            BackboneCompositeView.add(this);
            this.model = options.model;
        },
        getContext: function getContext() {
            this.item = this.model;
            var stock_information = this.model.getStockInfo(), is_available_for_ship = this.item.get('_isBackorderable') || this.item.get('_isInStock');
            return {
                isAvailableForShip: is_available_for_ship,
                isAvailableForPickup: stock_information.isAvailableForPickup
            };
        }
    });
});
define('PickupInStore.AddToCart.Button', [
    'Cart.AddToCart.Button.View',
    'SC.Configuration'
], function (CartAddToCartButtonView, Configuration) {
    'use strict';
    if (Configuration.get('siteSettings.isPickupInStoreEnabled')) {
        var original_add_to_cart_fn = CartAddToCartButtonView.prototype.addToCart;
        CartAddToCartButtonView.prototype.addToCart = function () {
            if (!this.model.getItem().get('_isstorepickupallowed') && this.model.get('fulfillmentChoice') === 'pickup') {
                this.model.set('fulfillmentChoice', 'ship');
            }
            return original_add_to_cart_fn.apply(this, arguments);
        };
    }
});
define('PickupInStore', [
    'Location',
    'ProductDetails.Full.View',
    'Cart.Lines.View',
    'Facets.ItemCell.View',
    'PickupInStore.View',
    'PickupInStore.FulfillmentOptions.View',
    'ProductLine.Common.Url',
    'ProductLine.Stock.View',
    'SC.Configuration',
    'underscore',
    'jQuery',
    'jquery.cookie',
    'PickupInStore.AddToCart.Button'
], function (Location, ProductDetailsFullView, CartLinesView, FacetsItemCellView, PickupInStoreView, PickupInStoreFulfillmentOptionsView, ProductLineCommonUrl, ProductLineStockView, Configuration, _, jQuery) {
    'use strict';
    return {
        mountToApp: function mountToApp(application) {
            if (!Configuration.get('siteSettings.isPickupInStoreEnabled')) {
                return;
            }
            ProductLineCommonUrl.attributesReflectedInURL.push('location');
            ProductLineCommonUrl.attributesReflectedInURL.push('fulfillmentChoice');
            ProductDetailsFullView.addChildViews({
                'Product.Stock.Info': function wrapperFunction(options) {
                    return function () {
                        if (options.model.getItem().get('ispurchasable')) {
                            return new PickupInStoreView({
                                model: options.model,
                                application: application
                            });
                        } else {
                            return new ProductLineStockView({ model: options.model });
                        }
                    };
                }
            });
            CartLinesView.addChildViews({
                'Product.Stock.Info': function wrapperFunction(options) {
                    return function () {
                        return new PickupInStoreView({
                            model: options.model,
                            application: application,
                            source: 'cart'
                        });
                    };
                }
            });
            FacetsItemCellView.addChildViews({
                'ItemViews.Stock': function wrapperFunction(options) {
                    return function () {
                        if (options.model.get('ispurchasable') && options.model.get('_isfulfillable')) {
                            return new PickupInStoreFulfillmentOptionsView({
                                model: options.model,
                                application: application
                            });
                        } else {
                            return new ProductLineStockView({ model: options.model });
                        }
                    };
                }
            });
            application.getLayout().on('beforeAppendView', function (view) {
                if (view instanceof ProductDetailsFullView) {
                    var location_id = view.model.get('location').get('internalid') || jQuery.cookie('myStore');
                    if (location_id) {
                        Location.fetchLocations(location_id).done(function () {
                            view.model.set('location', Location.get(location_id));
                        });
                    }
                }
            });
        }
    };
});
define('ProductDetails.QuickView.View', [
    'ProductDetails.Base.View',
    'product_details_quickview.tpl',
    'underscore'
], function (ProductDetailsBaseView, product_details_quickview_tpl, _) {
    'use strict';
    return ProductDetailsBaseView.extend({
        template: product_details_quickview_tpl,
        attributes: {
            'id': 'ProductDetails.QuickView.View',
            'class': 'view product-detail'
        },
        bindings: _.extend({}, ProductDetailsBaseView.prototype.bindings, {}),
        events: _.extend({}, ProductDetailsBaseView.prototype.events, { 'click [data-action="go-to-fullview"]': 'goToFullView' }),
        goToFullView: function goToFullView(e) {
            this.$(e.target).attr('href', this.model.generateURL());
        },
        childViews: _.extend({}, ProductDetailsBaseView.prototype.childViews, {}),
        getExtraChildrenOptions: function getExtraChildrenOptions() {
            return { isModal: true };
        },
        getContext: function () {
            return _.extend(ProductDetailsBaseView.prototype.getContext.apply(this, arguments), {});
        }
    });
});
define('ProductDetails.Router', [
    'Product.Model',
    'ProductDetails.Full.View',
    'ProductDetails.QuickView.View',
    'Backbone',
    'AjaxRequestsKiller',
    'Utils'
], function (ProductModel, ProductDetailsFullView, ProductDetailsQuickView, Backbone, AjaxRequestsKiller, Utils) {
    'use strict';
    return Backbone.Router.extend({
        routes: { ':url': 'productDetailsByUrl' },
        initialize: function initialize(options) {
            this.application = options.application;
            this.route(/^(.*?)$/, 'productDetailsByUrl');
            this.route('product/:id', 'productDetailsById');
            this.route('product/:id?:options', 'productDetailsById');
        },
        getView: function getView() {
            if (this.application.getLayout().isShowContentRewritten) {
                return ProductDetailsQuickView;
            }
            return ProductDetailsFullView;
        },
        productDetailsByUrl: function productDetailsByUrl(url) {
            url = decodeURIComponent(url);
            var options = null;
            if (~url.indexOf('?')) {
                options = Utils.parseUrlOptions(url);
                url = url.split('?')[0];
            }
            if (options) {
                this.productDetails({ url: url }, url, options);
            } else {
                this.productDetails({ url: url }, url);
            }
        },
        productDetailsById: function productDetailsById(id, options) {
            this.productDetails({ id: id }, '/product/' + id, Utils.parseUrlOptions(options));
        },
        productDetails: function productDetails(api_query, base_url, options) {
            var application = this.application, product = new ProductModel(), ViewConstructor = this.getView(), item = product.get('item');
            item.fetch({
                data: api_query,
                killerId: AjaxRequestsKiller.getKillerId(),
                pageGeneratorPreload: true
            }).then(function (data, result, jqXhr) {
                if (!item.isNew()) {
                    product.setOptionsFromURL(options);
                    product.set('source', options && options.source);
                    product.set('internalid', options && options.internalid);
                    if (api_query.id && item.get('urlcomponent') && SC.ENVIRONMENT.jsEnvironment === 'server') {
                        nsglobal.statusCode = 301;
                        nsglobal.location = product.generateURL();
                    }
                    if (data.corrections && data.corrections.length > 0) {
                        if (item.get('urlcomponent') && SC.ENVIRONMENT.jsEnvironment === 'server') {
                            nsglobal.statusCode = 301;
                            nsglobal.location = data.corrections[0].url + product.getQuery();
                        } else {
                            return Backbone.history.navigate('#' + data.corrections[0].url + product.getQuery(), { trigger: true });
                        }
                    }
                    var view = new ViewConstructor({
                        model: product,
                        baseUrl: base_url,
                        application: application
                    });
                    view.showContent();
                } else if (jqXhr.status >= 500) {
                    application.getLayout().internalError();
                } else if (jqXhr.responseJSON.errorCode !== 'ERR_USER_SESSION_TIMED_OUT') {
                    application.getLayout().notFound();
                }
            }, function (jqXhr) {
                try {
                    jqXhr.preventDefault = true;
                } catch (e) {
                    console.log(e.message);
                }
                if (jqXhr.status >= 500) {
                    application.getLayout().internalError();
                } else if (jqXhr.responseJSON.errorCode !== 'ERR_USER_SESSION_TIMED_OUT') {
                    application.getLayout().notFound();
                }
            });
        }
    });
});
define('SC.BaseComponent', [
    'underscore',
    'SC.CancelableEvents',
    'Utils'
], function (_, SCCancelableEvents, Utils) {
    'use strict';
    var base_component = _.extend({
        extend: function extend(child_component) {
            if (!child_component || !child_component.componentName || !child_component.application) {
                return this._reportError('INVALID_PARAM', 'Invalid SC.Component. Property "componentName" and "application" are required.');
            }
            this.application = child_component.application;
            var new_component = _.extend({}, this, child_component);
            new_component.application.getLayout().cancelableOn('beforeAppendView', _.bind(new_component._onApplicationBeforeView, new_component));
            new_component.application.getLayout().on('afterAppendView', _.bind(new_component._onApplicationAfterAppendView, new_component));
            return new_component;
        },
        _onApplicationBeforeView: function _onApplicationBeforeView(view) {
            if (this._isViewFromComponent(view, true)) {
                try {
                    var self = this;
                    this.viewToBeRendered = view;
                    return this.cancelableTrigger('beforeShowContent', this._getViewIdentifier(view)).always(function () {
                        self.viewToBeRendered = null;
                    });
                } catch (e) {
                    this.viewToBeRendered = null;
                    throw e;
                }
            }
        },
        _onApplicationAfterAppendView: function _onApplicationAfterAppendView(view) {
            if (this._isViewFromComponent(view, true)) {
                this.viewToBeRendered = null;
                this.cancelableTrigger('afterShowContent', this._getViewIdentifier(view));
            }
        },
        _getViewIdentifier: function _getViewIdentifier() {
            return 'CURRENT_VIEW';
        },
        _reportError: function _reportError(code, description) {
            var error = new Error(description);
            error.name = code;
            throw error;
        },
        _isViewFromComponent: function _isViewFromComponent() {
            return false;
        },
        setChildViewIndex: function setChildViewIndex(view_id, placeholder_selector, view_name, index) {
            var target_view = Utils.requireModules(view_id);
            this._setChildViewIndex(target_view, placeholder_selector, view_name, index);
        },
        _setChildViewIndex: function _setChildViewIndex(view, placeholder_selector, view_name, index) {
            if (view && _.isFunction(view.setChildViewIndex) && this._isViewFromComponent(view, false)) {
                view.setChildViewIndex(placeholder_selector, view_name, index);
                return null;
            }
            return this._reportError('INVALID_PARAM', 'The specified view_id is not valid for the current component.');
        },
        addChildViews: function addChildViews(view_id, child_views) {
            var target_view = Utils.requireModules(view_id);
            return this._addChildViews(target_view, child_views);
        },
        _addChildViews: function _addChildViews(view, child_views) {
            if (view && _.isFunction(view.addChildViews) && this._isViewFromComponent(view, false)) {
                view.addChildViews(child_views);
                return null;
            }
            this._reportError('INVALID_PARAM', 'The specified view_id is not valid for the current component or the view_constructor is not a function.');
        },
        removeChildView: function removeChildView(view_id, placeholder_selector, view_name) {
            var target_view = Utils.requireModules(view_id);
            this._removeChildView(target_view, placeholder_selector, view_name);
        },
        _removeChildView: function removeChildView(view, placeholder_selector, view_name) {
            if (view && _.isFunction(view.removeChildView) && this._isViewFromComponent(view, false)) {
                view_name = view_name || placeholder_selector;
                view.removeChildView(placeholder_selector, view_name);
                return null;
            }
            return this._reportError('INVALID_PARAM', 'The specified view_id is not valid for the current component.');
        },
        addToViewContextDefinition: function addToViewContextDefinition(view_id, property_name, type, callback) {
            var target_view = Utils.requireModules(view_id);
            if (target_view && _.isFunction(target_view.addExtraContextProperty) && _.isFunction(callback) && this._isViewFromComponent(target_view, false)) {
                target_view.addExtraContextProperty(property_name, type, callback);
            } else {
                return this._reportError('INVALID_PARAM', 'The specified view_id (' + view_id + ') is not valid for the current component or the callback is not a function.');
            }
        },
        removeToViewContextDefinition: function removeToViewContextDefinition(view_id, property_name) {
            var target_view = Utils.requireModules(view_id);
            if (target_view && _.isFunction(target_view.removeExtraContextProperty) && this._isViewFromComponent(target_view, false)) {
                target_view.removeExtraContextProperty(property_name);
            } else {
                return this._reportError('INVALID_PARAM', 'The specified view_id (' + view_id + ') is not valid for the current component or operation.');
            }
        },
        addToViewEventsDefinition: function addToViewEventsDefinition(view_id, event_selector, callback) {
            var target_view = Utils.requireModules(view_id);
            if (!target_view || !_.isFunction(target_view.addExtraEventHandler) || !this._isViewFromComponent(target_view, false) || !_.isFunction(callback)) {
                return this._reportError('INVALID_PARAM', 'The specified view_id (' + view_id + ') is not valid for the current component or operation, or the callback parameter is not a function.');
            } else {
                target_view.addExtraEventHandler(event_selector, callback);
            }
        },
        removeToViewEventsDefinition: function removeToViewEventsDefinition(view_id, event_selector) {
            var target_view = Utils.requireModules(view_id);
            if (!target_view || !_.isFunction(target_view.addExtraEventHandler) || !this._isViewFromComponent(target_view, false)) {
                return this._reportError('INVALID_PARAM', 'The specified view_id (' + view_id + ') is not valid for the current component or operation, or the callback parameter is not a function.');
            } else {
                target_view.removeExtraEventHandler(event_selector);
            }
        }
    }, SCCancelableEvents);
    base_component.on = base_component.cancelableOn;
    base_component.off = base_component.cancelableOff;
    return base_component;
});
define('ProductDetails.Component', [
    'ProductDetails.Base.View',
    'Product.Model',
    'SC.BaseComponent',
    'Utils',
    'underscore',
    'jQuery'
], function (ProductDetailsBaseView, ProductModel, SCBaseComponent, Utils, _, jQuery) {
    'use strict';
    return function ProductDetailsComponentGenerator(application) {
        var privateComponent = SCBaseComponent.extend({
            componentName: 'PDP',
            application: application,
            _isViewFromComponent: function _isViewFromComponent(view) {
                return view && (view instanceof ProductDetailsBaseView || view.prototype instanceof ProductDetailsBaseView);
            },
            _getViewIdentifier: function _getViewIdentifier(view) {
                return view.attributes.id;
            },
            setOption: function setOption(cart_option_id, value) {
                if (!cart_option_id || !_.isString(cart_option_id)) {
                    return this._reportError('INVALID_PARAM', 'Invalid parameter "cart_option_id". It must be a valid string');
                }
                var current_view = this.viewToBeRendered || application.getLayout().getCurrentView();
                if (this._isViewFromComponent(current_view, true)) {
                    return current_view.model.setOption(cart_option_id, value).then(function (operation_result) {
                        return jQuery.Deferred().resolve(!!operation_result);
                    }, function () {
                        return jQuery.Deferred().resolve(false);
                    });
                }
                return jQuery.Deferred().resolve(false);
            },
            setQuantity: function setQuantity(quantity) {
                var current_view;
                if (!_.isNumber(quantity)) {
                    return this._reportError('INVALID_PARAM', 'Invalid parameter "quantity". It must be a valid number');
                } else if (quantity <= 0) {
                    return this._reportError('INVALID_PARAM', 'Parameter "quantity" must be greater than 0');
                }
                current_view = this.viewToBeRendered || application.getLayout().getCurrentView();
                if (this._isViewFromComponent(current_view, true)) {
                    return current_view.model.set('quantity', quantity).then(function () {
                        return jQuery.Deferred().resolve(true);
                    }, function () {
                        return jQuery.Deferred().resolve(false);
                    });
                }
                return jQuery.Deferred().resolve(false);
            },
            getItemInfo: function getItemInfo() {
                var result = null, current_view = this.viewToBeRendered || application.getLayout().getCurrentView();
                if (this._isViewFromComponent(current_view, true)) {
                    result = Utils.deepCopy(current_view.model);
                }
                return result;
            }
        });
        var beforeChangeOptionHandler = function beforeChangeOptionHandler(option_cart_id, value) {
                return privateComponent.cancelableTrigger('beforeOptionSelection', {
                    optionCartId: option_cart_id,
                    value: value
                });
            }, afterChangeOptionHandler = function afterChangeOptionHandler() {
                return privateComponent.cancelableTrigger('afterOptionSelection');
            }, beforeChangeQuantityHandler = function beforeChangeQuantityHandler(quantity) {
                return privateComponent.cancelableTrigger('beforeQuantityChange', quantity);
            }, afterChangeQuantityHandler = function afterChangeQuantityHandler() {
                return privateComponent.cancelableTrigger('afterQuantityChange');
            }, beforeChangeImageHandler = function beforeChangeImageHandler(image_change) {
                return privateComponent.cancelableTrigger('beforeImageChange', image_change);
            }, afterChangeImageHandler = function afterChangeImageHandler() {
                return privateComponent.cancelableTrigger('afterImageChange');
            };
        application.getLayout().on('beforeAppendView', function onApplicationBeforeAppendView(view) {
            if (privateComponent._isViewFromComponent(view, true)) {
                view.model.cancelableOn('beforeChangeOption', beforeChangeOptionHandler);
                view.model.cancelableOn('afterChangeOption', afterChangeOptionHandler);
                view.model.cancelableOn('beforeChangeQuantity', beforeChangeQuantityHandler);
                view.model.cancelableOn('afterChangeQuantity', afterChangeQuantityHandler);
                view.model.cancelableOn('beforeChangeImage', beforeChangeImageHandler);
                view.model.cancelableOn('afterChangeImage', afterChangeImageHandler);
                view.on('destroy', function () {
                    view.model.cancelableOff('beforeChangeOption', beforeChangeOptionHandler);
                    view.model.cancelableOff('afterChangeOption', afterChangeOptionHandler);
                    view.model.cancelableOff('beforeChangeQuantity', beforeChangeQuantityHandler);
                    view.model.cancelableOff('afterChangeQuantity', afterChangeQuantityHandler);
                    view.model.cancelableOff('beforeChangeImage', beforeChangeImageHandler);
                    view.model.cancelableOff('afterChangeImage', afterChangeImageHandler);
                });
            }
        });
        return privateComponent;
    };
});
define('ProductDetails', [
    'ProductDetails.Router',
    'SC.Configuration',
    'ProductDetails.Component'
], function (ProductDetailsRouter, Configuration, ProductDetailsComponent) {
    'use strict';
    return {
        mountToApp: function (application) {
            if (Configuration.get('modulesConfig.ProductDetails.startRouter', false)) {
                new ProductDetailsRouter({ application: application });
            }
            return ProductDetailsComponent(application);
        }
    };
});
define('Shopping.Profile', [
    'Profile.Model',
    'jQuery'
], function (ProfileModel, jQuery) {
    'use strict';
    return {
        mountToApp: function (application) {
            application.getUser = function () {
                var profile_promise = jQuery.Deferred();
                ProfileModel.getPromise().done(function () {
                    profile_promise.resolve(ProfileModel.getInstance());
                }).fail(function () {
                    profile_promise.reject.apply(this, arguments);
                });
                return profile_promise;
            };
        }
    };
});
define('NavigationHelper', [
    'Session',
    'PluginContainer',
    'underscore',
    'jQuery',
    'Utils'
], function (Session, PluginContainer, _, jQuery, Utils) {
    'use strict';
    var NavigationHelper = {
        mountToApp: function (application) {
            var Layout = application.getLayout();
            _.extend(Layout, {
                isTargetBlank: function (e) {
                    return e.ctrlKey || e.metaKey || jQuery(e.currentTarget).attr('target') === '_blank';
                },
                getUrl: function (context) {
                    if (Utils.oldIE()) {
                        return context.target_data.href;
                    }
                    return context.target_href;
                },
                setUrl: function ($element, url) {
                    $element.attr('href', url);
                    if (Utils.oldIE()) {
                        $element.data('href', url);
                    }
                },
                generateNavigationContext: function (e) {
                    var $target = jQuery(e.currentTarget), touchpoints = Session.get('touchpoints'), target_data = $target.data(), target_touchpoint = (touchpoints ? touchpoints[target_data.touchpoint] : '') || '', hashtag = target_data.hashtag, target_href = $target.attr('href'), clean_hashtag = hashtag && hashtag.replace('#', '');
                    return {
                        target_data: target_data,
                        target_href: target_href,
                        target_touchpoint: target_touchpoint,
                        original_touchpoint: target_data.touchpoint,
                        hashtag: hashtag,
                        url: '',
                        clean_hashtag: clean_hashtag,
                        $target: $target
                    };
                },
                touchStart: new PluginContainer(),
                touchMove: new PluginContainer(),
                mouseDown: new PluginContainer(),
                click: new PluginContainer(),
                touchEnd: new PluginContainer(),
                mouseUp: new PluginContainer(),
                executeTouchStart: function (e) {
                    this.touchStart.executeAll(e);
                },
                executeTouchMove: function (e) {
                    this.touchMove.executeAll(e);
                },
                executeMouseUp: function (e) {
                    this.mouseUp.executeAll(e);
                },
                executeTouchEnd: function (e) {
                    this.touchEnd.executeAll(e);
                },
                executeMouseDown: function (e) {
                    this.mouseDown.executeAll(e);
                },
                executeClick: function (e) {
                    this.click.executeAll(e);
                }
            });
            _.extend(Layout.events, {
                'touchstart a:not([data-navigation="ignore-click"])': 'executeTouchStart',
                'mousedown a:not([data-navigation="ignore-click"])': 'executeMouseDown',
                'click a:not([data-navigation="ignore-click"])': 'executeClick',
                'mouseup a:not([data-navigation="ignore-click"])': 'executeMouseUp',
                'touchend a:not([data-navigation="ignore-click"])': 'executeTouchEnd',
                'touchmove a:not([data-navigation="ignore-click"])': 'executeTouchMove'
            });
            Layout.touchMove.install({
                name: 'detectTouchMovement',
                priority: 10,
                execute: function (e) {
                    if (jQuery(e.currentTarget).data('touchpoint')) {
                        Layout.isTouchMoveEvent = true;
                    }
                    return e;
                }
            });
        }
    };
    return NavigationHelper;
});
define('NavigationHelper.Plugins.Standard', [
    'underscore',
    'Backbone',
    'UrlHelper',
    'Utils'
], function (_, Backbone) {
    'use strict';
    var standardPlugins = {
        isNOTURLHashtagPart: function (url) {
            return Backbone.history.options.pushState || url === '#' || url.indexOf('http://') === 0 || url.indexOf('https://') === 0 || url.indexOf('mailto:') === 0 || url.indexOf('tel:') === 0;
        },
        correctURL: function (layout, e) {
            var context = layout.generateNavigationContext(e), window_obj = _.getWindow(), href = layout.getUrl(context) || '#';
            if (!context.target_data.touchpoint && !standardPlugins.isNOTURLHashtagPart(href)) {
                if (context.target_data.toggle === 'show-in-modal' || context.target_data.toggle === 'show-in-pusher') {
                    context.$target.data('original-href', href);
                    href = window_obj.location.href;
                } else if (window_obj.location.hash) {
                    href = window_obj.location.href.replace(/#.*$/, '#' + href);
                } else if (window_obj.location.href.lastIndexOf('#') === window_obj.location.href.length - 1) {
                    href = window_obj.location.href + href;
                } else {
                    href = window_obj.location.href + '#' + href;
                }
                layout.setUrl(context.$target, href);
            }
            return e;
        },
        clickNavigation: function (layout, e) {
            e.preventDefault();
            var context = layout.generateNavigationContext(e), href = layout.getUrl(context) || '', target_is_blank = layout.isTargetBlank(e) || e.button === 1, target_is_modal_or_pusher = context.target_data.toggle === 'show-in-modal' || context.target_data.toggle === 'show-in-pusher' && _.isPhoneDevice(), is_disabled = context.$target.attr('disabled'), is_dropdown = context.target_data.toggle === 'dropdown', is_external;
            if (is_disabled) {
                e.stopPropagation();
                return e;
            }
            if (context.target_data.originalHref && !target_is_blank) {
                href = context.target_data.originalHref;
            }
            layout.$el.removeClass('sc-pushing');
            if (href === '#' || href === '' || is_dropdown) {
                return e;
            }
            if (!target_is_blank) {
                if (layout.$containerModal) {
                    layout.$containerModal.modal('hide');
                }
                if (!target_is_modal_or_pusher) {
                    is_external = ~href.indexOf('http:') || ~href.indexOf('https:') || ~href.indexOf('mailto:') || ~href.indexOf('tel:');
                    if (is_external) {
                        _.getWindow().document.location.href = href;
                    } else {
                        Backbone.history.navigate(href, { trigger: true });
                    }
                }
            } else {
                _.getWindow().open(href, _.uniqueId('window'));
            }
            return e;
        },
        mountToApp: function (application) {
            var layout = application.getLayout();
            layout.mouseDown.install({
                name: 'mouseDownFixHref',
                priority: 10,
                execute: function (e) {
                    return standardPlugins.correctURL(layout, e);
                }
            });
            layout.touchStart.install({
                name: 'touchStartFixHref',
                priority: 10,
                execute: function (e) {
                    return standardPlugins.correctURL(layout, e);
                }
            });
            layout.click.install({
                name: 'standardNavigation',
                priority: 20,
                execute: function (e) {
                    return standardPlugins.clickNavigation(layout, e);
                }
            });
        }
    };
    return standardPlugins;
});
define('NavigationHelper.Plugins.DataTouchPoint', [
    'Tracker',
    'Session',
    'underscore',
    'Backbone',
    'Utils',
    'UrlHelper'
], function (Tracker, Session, _, Backbone, Utils) {
    'use strict';
    var dataTouchPointPlugins = {
        getLocaleHost: function (locale) {
            var available_hosts = SC.ENVIRONMENT.availableHosts, target_host;
            if (available_hosts && available_hosts.length) {
                for (var i = 0; i < available_hosts.length; i++) {
                    var host = available_hosts[i], lang = _(host.languages).findWhere({ locale: locale });
                    if (lang && lang.host) {
                        target_host = lang.host;
                        break;
                    }
                }
            }
            return target_host;
        },
        preserveLanguage: function (context, application) {
            var url = context.url;
            if (Utils.isShoppingDomain()) {
                var locale_host = dataTouchPointPlugins.getLocaleHost(SC.ENVIRONMENT.currentLanguage.locale);
                if (locale_host) {
                    url = url.replace(/(http:\/\/)([^\/?#]*)([^>]*)/gi, function (all, protocol, host, rest) {
                        return protocol + locale_host + rest;
                    });
                }
                if (context.target_data.touchpoint !== application.getConfig('currentTouchpoint')) {
                    url = Utils.addParamsToUrl(url, Utils.getSessionParams(Session.get('touchpoints.login')));
                }
                if (/\?$/.test(url)) {
                    url = url.substring(0, url.length - 1);
                }
                context.url = url;
            } else {
                var current_language = SC.ENVIRONMENT.currentLanguage;
                if (current_language) {
                    context.target_data.parameters = context.target_data.parameters ? context.target_data.parameters + '&lang=' + current_language.locale : 'lang=' + current_language.locale;
                }
            }
            return context;
        },
        addParametersToUrl: function (context) {
            if (context.target_data.parameters) {
                context.url += (~context.url.indexOf('?') ? '&' : '?') + context.target_data.parameters;
            }
            return context;
        },
        addHashtagToTouchPoint: function (context) {
            if (SC.ENVIRONMENT.siteSettings.sitetype === 'ADVANCED' && context.hashtag && context.hashtag !== '#' && context.hashtag !== '#/') {
                context.target_touchpoint += (~context.target_touchpoint.indexOf('?') ? '&' : '?') + 'fragment=' + context.clean_hashtag;
            }
            return context;
        },
        generateUrl: function (context, application, layout) {
            if (context.original_touchpoint === application.getConfig('currentTouchpoint')) {
                var prefix = '#';
                if (Backbone.history.options && Backbone.history.options.pushState) {
                    prefix = context.clean_hashtag.indexOf('/') === 0 ? '' : '/';
                }
                context.url = context.clean_hashtag ? prefix + context.clean_hashtag : layout.getUrl(context);
            } else {
                if (context.clean_hashtag && context.clean_hashtag.indexOf('http') !== -1) {
                    context.url = _.addParamsToUrl(context.clean_hashtag, _.parseUrlOptions(context.target_touchpoint));
                } else {
                    context.url = _.fixUrl(context.target_touchpoint);
                    if (context.url && !(~context.url.indexOf('http:') || ~context.url.indexOf('https:'))) {
                        context.url = location.protocol + '//' + location.host + context.url;
                    }
                }
            }
            return context;
        },
        addCrosDomainParams: function (context) {
            if (Tracker.getInstance().addCrossDomainParameters) {
                context.url = Tracker.getInstance().addCrossDomainParameters(context.url);
            }
            return context;
        },
        getTargetUrl: function (context, application, layout) {
            context = dataTouchPointPlugins.addHashtagToTouchPoint(context);
            context = dataTouchPointPlugins.generateUrl(context, application, layout);
            context = dataTouchPointPlugins.preserveLanguage(context, application);
            context = dataTouchPointPlugins.addParametersToUrl(context);
            context = dataTouchPointPlugins.addCrosDomainParams(context);
            return context.url;
        },
        correctURL: function (layout, application, e) {
            var context = layout.generateNavigationContext(e);
            if (context.target_data.touchpoint) {
                layout.isTouchMoveEvent = false;
                if (e.type === 'touchstart') {
                    e.stopPropagation();
                }
                if (e.which === 2 || e.which === 3) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                var new_url = dataTouchPointPlugins.getTargetUrl(context, application, layout);
                layout.setUrl(context.$target, new_url);
            }
            return e;
        },
        setHashtag: function (layout, application, e) {
            var context = layout.generateNavigationContext(e), target_is_blank = layout.isTargetBlank(e) || e.button && e.button !== 0;
            if (context.target_data.touchpoint) {
                if (!target_is_blank && context.target_data.hashtag && application.getConfig('currentTouchpoint') && application.getConfig('currentTouchpoint') === context.target_data.touchpoint) {
                    var new_url = context.target_data.hashtag;
                    new_url = new_url[0] === '#' ? new_url.substring(1) : new_url;
                    new_url = new_url[0] === '/' ? new_url : '/' + new_url;
                    layout.setUrl(context.$target, new_url);
                }
                if (e.type === 'touchend' && !layout.isTouchMoveEvent) {
                    e.stopPropagation();
                    e.preventDefault();
                    context.$target.trigger('click');
                }
            }
            return e;
        },
        mountToApp: function (application) {
            var layout = application.getLayout();
            layout.mouseDown.install({
                name: 'mouseDownFixHrefDataTouchPoint',
                priority: 10,
                execute: function (e) {
                    return dataTouchPointPlugins.correctURL(layout, application, e);
                }
            });
            layout.touchStart.install({
                name: 'touchStartFixHrefDataTouchPoint',
                priority: 10,
                execute: function (e) {
                    return dataTouchPointPlugins.correctURL(layout, application, e);
                }
            });
            layout.mouseUp.install({
                name: 'correctHashtagsDataTouch',
                priority: 10,
                execute: function (e) {
                    return dataTouchPointPlugins.setHashtag(layout, application, e);
                }
            });
            layout.touchEnd.install({
                name: 'correctHashtagsDataTouch',
                priority: 10,
                execute: function (e) {
                    return dataTouchPointPlugins.setHashtag(layout, application, e);
                }
            });
        }
    };
    return dataTouchPointPlugins;
});
define('NavigationHelper.Plugins.Modals', [
    'underscore',
    'jQuery',
    'Backbone',
    'UrlHelper',
    'Utils'
], function (_, jQuery, Backbone) {
    'use strict';
    var modalsPlugin = {
        showInternalLinkInModal: function (e, href, $target, layout) {
            var current_fragment = Backbone.history.fragment || '/', original_view;
            layout.isShowContentRewritten = true;
            layout.originalShowContent = layout.showContent;
            if (modalsPlugin.ContentEnhancedViews) {
                modalsPlugin.originalOverrideViewSettings = modalsPlugin.ContentEnhancedViews.overrideViewSettings;
            }
            var layout_overlay = jQuery('<div class="layout-overlay"></div>');
            layout.$el.append(layout_overlay);
            layout.showContent = function (view) {
                layout_overlay.remove();
                var promise = jQuery.Deferred();
                if (!original_view) {
                    original_view = view;
                } else if (original_view !== view) {
                    promise = layout.originalShowContent.apply(layout, arguments);
                    original_view && original_view.$containerModal && original_view.$containerModal.modal('hide');
                    return promise;
                }
                if (view && _.isFunction(view.showInModal)) {
                    promise = view.showInModal({ className: $target.data('modal-class-name') });
                    view.$containerModal.on('hide.bs.modal', function () {
                        modalsPlugin.undoNavigationHelperFunctionRewrite(layout);
                    });
                } else {
                    modalsPlugin.undoNavigationHelperFunctionRewrite(layout);
                    Backbone.history.navigate(href, {
                        trigger: false,
                        replace: true
                    });
                }
                return promise;
            };
            Backbone.history.navigate(href, {
                trigger: true,
                replace: true
            });
            Backbone.history.navigate(current_fragment, {
                trigger: false,
                replace: true
            });
        },
        undoNavigationHelperFunctionRewrite: function (layout) {
            if (layout.isShowContentRewritten) {
                layout.showContent = layout.originalShowContent;
                if (modalsPlugin.ContentEnhancedViews) {
                    modalsPlugin.ContentEnhancedViews.overrideViewSettings = modalsPlugin.originalOverrideViewSettings;
                }
                layout.isShowContentRewritten = false;
            }
        },
        showExternalLinkInModal: function (href, context, application) {
            var view = new Backbone.View({ application: application });
            view.template = function () {
                return '<iframe src="' + href + '"></iframe>';
            };
            view.page_header = context.$target.data('page-header') || '';
            view.showInModal({ className: (context.$target.data('modal-class-name') || '') + ' iframe-modal' });
        },
        clickNavigation: function (layout, e, application) {
            var context = layout.generateNavigationContext(e), href = layout.getUrl(context) || '', target_is_blank = layout.isTargetBlank(e) || e.button === 1, target_is_modal = context.target_data.toggle === 'show-in-modal', is_disabled = context.$target.attr('disabled'), is_dropdown = context.target_data.toggle === 'dropdown', is_external;
            if (is_disabled) {
                e.stopPropagation();
                return e;
            }
            if (context.target_data.originalHref && !target_is_blank) {
                href = context.target_data.originalHref;
            }
            if (href === '#' || href === '' || is_dropdown) {
                return e;
            }
            if (!target_is_blank) {
                if (layout.$containerModal) {
                    layout.$containerModal.modal('hide');
                }
                if (target_is_modal) {
                    is_external = ~href.indexOf('http:') || ~href.indexOf('https:') || ~href.indexOf('mailto:') || ~href.indexOf('tel:');
                    if (is_external) {
                        modalsPlugin.showExternalLinkInModal(href, context, application);
                    } else {
                        modalsPlugin.showInternalLinkInModal(e, href, context.$target, layout);
                    }
                }
            }
            return e;
        },
        ContentEnhancedViews: false,
        mountToApp: function (application) {
            var layout = application.getLayout();
            try {
                modalsPlugin.ContentEnhancedViews = require('Content.EnhancedViews');
            } catch (e) {
            }
            layout.click.install({
                name: 'modalNavigation',
                priority: 10,
                execute: function (e) {
                    return modalsPlugin.clickNavigation(layout, e, application);
                }
            });
        }
    };
    return modalsPlugin;
});
define('NavigationHelper.Plugins.Pushers', [
    'underscore',
    'jQuery',
    'Backbone',
    'UrlHelper',
    'Utils'
], function (_, jQuery, Backbone) {
    'use strict';
    var pushersPlugin = {
        showInternalLinkInPusher: function (e, href, $target, layout) {
            var current_fragment = Backbone.history.fragment || '/';
            layout.isShowContentRewritten = true;
            layout.originalShowContent = layout.showContent;
            if (pushersPlugin.ContentEnhancedViews) {
                pushersPlugin.originalOverrideViewSettings = pushersPlugin.ContentEnhancedViews.overrideViewSettings;
            }
            layout.showContent = function (view) {
                var promise = jQuery.Deferred();
                if (view && _.isFunction(view.showInPush)) {
                    promise = view.showInPush({ className: $target.data('pusher-class-name') });
                    layout.$pusher_container.on('beforeClose', function () {
                        pushersPlugin.undoNavigationHelperFunctionRewrite(layout);
                    });
                } else {
                    pushersPlugin.undoNavigationHelperFunctionRewrite(layout);
                    Backbone.history.navigate(href, {
                        trigger: false,
                        replace: true
                    });
                }
                promise.done(function () {
                    Backbone.history.navigate(current_fragment, {
                        trigger: false,
                        replace: true
                    });
                });
                return promise;
            };
            Backbone.history.navigate(href, {
                trigger: true,
                replace: true
            });
        },
        undoNavigationHelperFunctionRewrite: function (layout) {
            if (layout.isShowContentRewritten) {
                layout.showContent = layout.originalShowContent;
                if (pushersPlugin.ContentEnhancedViews) {
                    pushersPlugin.ContentEnhancedViews.overrideViewSettings = pushersPlugin.originalOverrideViewSettings;
                }
                layout.isShowContentRewritten = false;
            }
        },
        showExternalLinkInPusher: function (href, context, application) {
            var view = new Backbone.View({ application: application });
            view.template = function () {
                return '<iframe src="' + href + '"></iframe>';
            };
            view.page_header = context.$target.data('page-header') || '';
            view.showInPush({ className: (context.$target.data('pusher-class-name') || '') + ' iframe-pusher' });
        },
        clickNavigation: function (layout, e, application) {
            if (!_.isPhoneDevice()) {
                return e;
            }
            var context = layout.generateNavigationContext(e), href = layout.getUrl(context) || '', target_is_blank = layout.isTargetBlank(e) || e.button === 1, target_is_pusher = context.target_data.toggle === 'show-in-pusher', is_disabled = context.$target.attr('disabled'), is_dropdown = context.target_data.toggle === 'dropdown', is_external;
            if (is_disabled) {
                e.stopPropagation();
                return e;
            }
            if (context.target_data.originalHref && !target_is_blank) {
                href = context.target_data.originalHref;
            }
            if (href === '#' || href === '' || is_dropdown) {
                return e;
            }
            if (!target_is_blank) {
                if (layout.$containerModal) {
                    layout.$containerModal.modal('hide');
                }
                if (target_is_pusher) {
                    is_external = ~href.indexOf('http:') || ~href.indexOf('https:') || ~href.indexOf('mailto:') || ~href.indexOf('tel:');
                    if (is_external) {
                        pushersPlugin.showExternalLinkInPusher(href, context, application);
                    } else {
                        pushersPlugin.showInternalLinkInPusher(e, href, context.$target, layout);
                    }
                }
            }
            return e;
        },
        ContentEnhancedViews: false,
        mountToApp: function (application) {
            var layout = application.getLayout();
            try {
                pushersPlugin.ContentEnhancedViews = require('Content.EnhancedViews');
            } catch (e) {
            }
            layout.click.install({
                name: 'pusherNavigation',
                priority: 25,
                execute: function (e) {
                    return pushersPlugin.clickNavigation(layout, e, application);
                }
            });
        }
    };
    return pushersPlugin;
});
define('Item', [
    'SC.Configuration',
    'underscore'
], function (Configuration, _) {
    'use strict';
    return {
        mountToApp: function (application) {
            var item_options_with_color = _.filter(Configuration.get('ItemOptions.optionsConfiguration', []), function (item_option_config) {
                    return !!item_option_config.colors;
                }), clean_setting = function (item_option, setting_key) {
                    if (item_option && item_option[setting_key] === '') {
                        delete item_option[setting_key];
                        return true;
                    }
                    return false;
                };
            _.each(item_options_with_color || [], function (item_option) {
                item_option.colors = application.getLayout().getColorPalette(item_option.colors);
            });
            _.each(Configuration.get('ItemOptions.optionsConfiguration', []), function (item_option_configuration) {
                clean_setting(item_option_configuration, 'colors');
                clean_setting(item_option_configuration, 'label');
                clean_setting(item_option_configuration, 'urlParameterName');
                clean_setting(item_option_configuration, 'index');
            });
        }
    };
});
define('ProductViews', [
    'SC.Configuration',
    'product_views_option_color.tpl',
    'product_views_option_dropdown.tpl',
    'product_views_option_radio.tpl',
    'product_views_option_text.tpl',
    'product_views_option_textarea.tpl',
    'product_views_option_email.tpl',
    'product_views_option_phone.tpl',
    'product_views_option_url.tpl',
    'product_views_option_float.tpl',
    'product_views_option_integer.tpl',
    'product_views_option_percent.tpl',
    'product_views_option_currency.tpl',
    'product_views_option_password.tpl',
    'product_views_option_timeofday.tpl',
    'product_views_option_datetimetz.tpl',
    'product_views_option_tile.tpl',
    'product_views_option_checkbox.tpl',
    'product_views_option_date.tpl',
    'product_views_option_facets_color.tpl',
    'product_views_option_facets_tile.tpl',
    'underscore',
    'Utils'
], function (Configuration, product_views_option_color_tpl, product_views_option_dropdown_tpl, product_views_option_radio_tpl, product_views_option_text_tpl, product_views_option_textarea_tpl, product_views_option_email_tpl, product_views_option_phone_tpl, product_views_option_url_tpl, product_views_option_float_tpl, product_views_option_integer_tpl, product_views_option_percent_tpl, product_views_option_currency_tpl, product_views_option_password_tpl, product_views_option_timeofday_tpl, product_views_option_datetimetz_tpl, product_views_option_tile_tpl, product_views_option_checkbox_tpl, product_views_option_date_tpl, product_views_option_facets_color_tpl, product_views_option_facets_tile_tpl, _, Utils) {
    'use strict';
    return {
        mountToApp: function mountToApp() {
            var product_view_options_selector = {
                    'product_views_option_color.tpl': product_views_option_color_tpl,
                    'product_views_option_dropdown.tpl': product_views_option_dropdown_tpl,
                    'product_views_option_radio.tpl': product_views_option_radio_tpl,
                    'product_views_option_text.tpl': product_views_option_text_tpl,
                    'product_views_option_textarea.tpl': product_views_option_textarea_tpl,
                    'product_views_option_email.tpl': product_views_option_email_tpl,
                    'product_views_option_phone.tpl': product_views_option_phone_tpl,
                    'product_views_option_url.tpl': product_views_option_url_tpl,
                    'product_views_option_float.tpl': product_views_option_float_tpl,
                    'product_views_option_integer.tpl': product_views_option_integer_tpl,
                    'product_views_option_percent.tpl': product_views_option_percent_tpl,
                    'product_views_option_currency.tpl': product_views_option_currency_tpl,
                    'product_views_option_password.tpl': product_views_option_password_tpl,
                    'product_views_option_timeofday.tpl': product_views_option_timeofday_tpl,
                    'product_views_option_datetimetz.tpl': product_views_option_datetimetz_tpl,
                    'product_views_option_tile.tpl': product_views_option_tile_tpl,
                    'product_views_option_checkbox.tpl': product_views_option_checkbox_tpl,
                    'product_views_option_date.tpl': product_views_option_date_tpl
                }, product_view_option_facet = {
                    'product_views_option_facets_color.tpl': product_views_option_facets_color_tpl,
                    'product_views_option_facets_tile.tpl': product_views_option_facets_tile_tpl
                }, item_options = Configuration.get('ItemOptions.optionsConfiguration', []), configuration_default_selector_templates = Configuration.get('ItemOptions.defaultTemplates.selectorByType', []), default_selector_templates = {}, default_template_selector = false, configuration_default_facet_templates = Configuration.get('ItemOptions.defaultTemplates.facetCellByType', []), default_facet_templates = {}, default_template_facet = false;
            _.each(item_options, function (item_option) {
                if (item_option.templateFacetCell && product_view_option_facet[item_option.templateFacetCell]) {
                    item_option.templates = item_option.templates || {};
                    item_option.templates.facetCell = product_view_option_facet[item_option.templateFacetCell];
                }
                if (item_option.templateSelector && product_view_options_selector[item_option.templateSelector]) {
                    item_option.templates = item_option.templates || {};
                    item_option.templates.selector = product_view_options_selector[item_option.templateSelector];
                }
            });
            _.each(configuration_default_selector_templates, function (default_selector_template) {
                if (product_view_options_selector[default_selector_template.template]) {
                    default_selector_templates[default_selector_template.type] = product_view_options_selector[default_selector_template.template];
                    default_template_selector = true;
                }
            });
            if (default_template_selector) {
                Utils.setPathFromObject(Configuration, 'ItemOptions.defaultTemplates.selectorByType', default_selector_templates);
            }
            _.each(configuration_default_facet_templates, function (default_facet_template) {
                if (product_view_option_facet[default_facet_template.template]) {
                    default_facet_templates[default_facet_template.type] = product_view_option_facet[default_facet_template.template];
                    default_template_facet = true;
                }
            });
            if (default_template_facet) {
                Utils.setPathFromObject(Configuration, 'ItemOptions.defaultTemplates.facetCellByType', default_facet_templates);
            }
        }
    };
});
define('Transaction.Line.Views', [
    'SC.Configuration',
    'transaction_line_views_selected_option.tpl',
    'transaction_line_views_selected_option_color.tpl',
    'underscore',
    'Utils'
], function (Configuration, transaction_line_views_selected_option_tpl, transaction_line_views_selected_option_color_tpl, _, Utils) {
    'use strict';
    return {
        mountToApp: function () {
            var transaction_line_view_options_selected = {
                    'transaction_line_views_selected_option.tpl': transaction_line_views_selected_option_tpl,
                    'transaction_line_views_selected_option_color.tpl': transaction_line_views_selected_option_color_tpl
                }, item_options = Configuration.get('ItemOptions.optionsConfiguration', []), configuration_default_selected_templates = Configuration.get('ItemOptions.defaultTemplates.selectedByType', []), default_selected_templates = {}, default_template_selected = false;
            _.each(item_options, function (item_option) {
                if (item_option.templateSelected && transaction_line_view_options_selected[item_option.templateSelected]) {
                    item_option.templates = item_option.templates || {};
                    item_option.templates.selected = transaction_line_view_options_selected[item_option.templateSelected];
                }
            });
            _.each(configuration_default_selected_templates, function (default_selected_template) {
                if (transaction_line_view_options_selected[default_selected_template.template]) {
                    default_selected_templates[default_selected_template.type] = transaction_line_view_options_selected[default_selected_template.template];
                    default_template_selected = true;
                }
            });
            if (default_template_selected) {
                Utils.setPathFromObject(Configuration, 'ItemOptions.defaultTemplates.selectedByType', default_selected_templates);
            }
        }
    };
});
define('Cart.Router', [
    'Cart.Detailed.View',
    'LiveOrder.Model',
    'Utils',
    'jQuery',
    'Backbone'
], function (CartDetailedView, LiveOrderModel, Utils, jQuery, Backbone) {
    'use strict';
    return Backbone.Router.extend({
        routes: {
            'cart': 'showCart',
            'cart?*options': 'showCart'
        },
        initialize: function (application) {
            this.application = application;
        },
        showCart: function (options) {
            var self = this, cart = LiveOrderModel.getInstance(), cart_promise = LiveOrderModel.loadCart(), view = new CartDetailedView({
                    model: cart,
                    application: self.application,
                    urlOptions: Utils.parseUrlOptions(options || '')
                });
            cart_promise.done(function () {
                view.showContent();
            });
        }
    });
});
define('Cart', [
    'LiveOrder.Model',
    'Cart.Router',
    'SC.Configuration',
    'Cart.Confirmation.Helpers',
    'jQuery'
], function (LiveOrderModel, CartRouter, Configuration, CartConfirmationHelpers, jQuery) {
    'use strict';
    return {
        mountToApp: function mountToApp(application) {
            this.cart_model = LiveOrderModel.getInstance();
            if (!SC.ENVIRONMENT.CART_BOOTSTRAPED) {
                LiveOrderModel.loadCart();
            } else if (SC.ENVIRONMENT.CART) {
                this.cart_model.set(SC.ENVIRONMENT.CART);
                this.cart_model.cartLoad = this.cart_model.cartLoad || jQuery.Deferred();
                this.cart_model.isLoading = false;
                this.cart_model.cartLoad.resolveWith(SC.ENVIRONMENT.CART);
            }
            var self = this;
            application.getCart = function getCart() {
                console.warn('Using application.getCart is deprecated!');
                var cart_promise = jQuery.Deferred();
                LiveOrderModel.loadCart().done(function () {
                    cart_promise.resolve(self.cart_model);
                }).fail(function () {
                    cart_promise.reject.apply(this, arguments);
                });
                return cart_promise;
            };
            application.getLayout().goToCart = function () {
                return CartConfirmationHelpers._goToCart(this.application.getCart());
            };
            application.getLayout().showMiniCart = function () {
                return CartConfirmationHelpers._showMiniCart(this.application.getCart(), null, this.application);
            };
            application.getLayout().showCartConfirmationModal = function () {
                return CartConfirmationHelpers._showCartConfirmationModal(this.application.getCart(), null, this.application);
            };
            if (Configuration.get('modulesConfig.Cart.startRouter', true)) {
                new CartRouter(application);
            }
        }
    };
});
define('Content.DataModels', [
    'Singleton',
    'Backbone',
    'underscore',
    'jQuery',
    'Utils',
    'AjaxRequestsKiller',
    'Backbone.CachedModel',
    'Backbone.CachedCollection'
], function (Singleton, Backbone, _, jQuery, Utils, AjaxRequestsKiller) {
    'use strict';
    var Pages = {};
    Pages.Model = Backbone.CachedModel.extend({ urlRoot: Utils.getAbsoluteUrl('../cds/services/page.ss') });
    Pages.Collection = Backbone.CachedCollection.extend({
        url: Utils.getAbsoluteUrl('../cds/services/page.ss'),
        model: Pages.Model
    }, Singleton);
    var Urls = {};
    Urls.Model = Backbone.Model.extend({ urlRoot: Utils.getAbsoluteUrl('../cds/services/url.ss') });
    Urls.Collection = Backbone.Collection.extend({
        url: Utils.getAbsoluteUrl('../cds/services/url.ss'),
        model: Urls.Model,
        initialize: function () {
            this.regExpGraphRoot = new Urls.Model({ childs: [] });
            this.regExpGraphHelper = [];
            this.landingPages = [];
            this.exactMatchHash = {};
            this.on('reset', this.reseter);
        },
        reseter: function () {
            this.regExpGraphRoot = new Urls.Model({ childs: [] });
            this.regExpGraphHelper = [];
            this.landingPages = [];
            this.exactMatchHash = {};
            var self = this;
            this.each(function (model) {
                if (model.get('query') === '*' && model.get('type') !== '1') {
                    if (!Urls.Collection.defaultModel) {
                        Urls.Collection.defaultModel = model;
                    }
                } else if (~model.get('query').indexOf('*') && model.get('type') !== '1') {
                    var regular_expresion = new RegExp('^' + _.map(model.get('query').split('*'), function (token) {
                        return token.replace(/\//gi, '\\/').replace(/\?/gi, '\\?');
                    }).join('(.*?)') + '$');
                    model.set({
                        regexp: regular_expresion,
                        childs: []
                    });
                    self.insertInGraph(model, self.regExpGraphRoot);
                    _.each(self.regExpGraphHelper, function (currentNode) {
                        if (!_.contains(model.get('childs'), currentNode) && model.get('regexp').test(currentNode.get('query'))) {
                            model.get('childs').push(currentNode);
                        }
                    });
                    self.regExpGraphHelper.push(model);
                } else {
                    self.exactMatchHash[model.get('query')] = model;
                    if (model.get('type') === '1') {
                        self.landingPages.push(model);
                    }
                }
            });
        },
        insertInGraph: function (node, root) {
            var isParent = true, self = this;
            _.each(root.get('childs'), function (branch) {
                if (branch.get('query') !== node.get('query')) {
                    if (branch.get('regexp').test(node.get('query'))) {
                        isParent = false;
                        self.insertInGraph(node, branch);
                    } else if (node.get('regexp').test(branch.get('query'))) {
                        node.get('childs').push(branch);
                        root.set('childs', _.without(root.get('childs'), branch));
                    }
                }
            });
            if (isParent && !~_.indexOf(root.get('childs'), node)) {
                root.get('childs').push(node);
            }
        },
        findUrl: function (url) {
            var exact_match = this.exactMatchHash[url];
            if (exact_match) {
                return exact_match;
            } else {
                this.candidates = {};
                this.walkRegExpGraph(url, this.regExpGraphRoot, 1);
                var result = _.max(_.pairs(this.candidates), function (candidate) {
                    return candidate[1];
                });
                return result && typeof result === 'object' ? this.get(result[0]) : false;
            }
        },
        walkRegExpGraph: function (url, branch, deepth) {
            var self = this;
            _.each(branch.get('childs'), function (new_branch) {
                if (new_branch.get('regexp').test(url)) {
                    self.candidates[new_branch.cid] = self.candidates[new_branch.cid] ? self.candidates[new_branch.cid] + deepth : deepth;
                    self.walkRegExpGraph(url, new_branch, deepth + 1);
                }
            });
        }
    }, Singleton);
    var currentRequests = [];
    function loadPage(url, donefn) {
        donefn = donefn || jQuery.noop;
        if (url) {
            var foundUrl = Urls.Collection.getInstance().findUrl(url);
            if (foundUrl) {
                var page_id = foundUrl.get('pageid'), page = Pages.Collection.getInstance().get(page_id);
                if (page) {
                    donefn(page);
                } else {
                    new Pages.Model({
                        internalid: page_id,
                        id: page_id
                    }).fetch({
                        data: {
                            cache: this.Application.getConfig('cache.contentPageCdn'),
                            ttl: this.Application.getConfig('cache.contentPageTtl')
                        },
                        killerId: AjaxRequestsKiller.getKillerId(),
                        reset: true
                    }).done(function (loaded_page) {
                        Pages.Collection.getInstance().add(loaded_page);
                        page = Pages.Collection.getInstance().get(page_id);
                        donefn(page);
                    });
                }
            } else {
                donefn(false);
            }
        } else {
            donefn(false);
        }
    }
    return {
        Urls: Urls,
        Pages: Pages,
        currentRequests: currentRequests,
        loadPage: loadPage
    };
});
define('Content.EnhancedViews', [
    'Content.DataModels',
    'underscore',
    'jQuery',
    'Backbone.View',
    'Backbone.View.render',
    'Backbone.View.Plugins'
], function (DataModels, _, jQuery) {
    'use strict';
    var EnhancedViews = { previousPlaceholders: [] };
    _.extend(EnhancedViews, {
        overrideViewSettings: function (view, page) {
            view.contentZones = view.contentZones || [];
            if (page) {
                view.title = page.get('title') || view.getTitle();
                view.page_header = page.get('pageheader') || view.page_header;
                view.description = page.get('description') || view.description;
                view.metaDescription = page.get('metadescription') || view.getMetaDescription();
                view.metaKeywords = page.get('metakeywords') || view.getMetaKeywords();
                view.template = page.get('template') || view.template;
                view.addToHead = page.get('metaextra') || view.getAddToHead() || '';
                view.contentZones = _.union(view.contentZones, page.get('pagecontent'));
            }
            var default_url = DataModels.Urls.Collection.defaultModel, default_page = default_url && DataModels.Pages.Collection.getInstance().get(default_url.get('pageid'));
            if (default_page) {
                view.contentZones = _.union(view.contentZones, default_page.get('pagecontent'));
            }
            return view;
        },
        initalizeHead: function () {
            return jQuery('head').not(':has(title)').append('<title/>').end().not(':has(link[rel="canonical"])').append('<link rel="canonical"/>').end().not(':has(meta[name="keywords"])').append('<meta name="keywords"/>').end().not(':has(meta[name="description"])').append('<meta name="description"/>').end();
        },
        enhanceHead: function (view) {
            var title = view.getTitle();
            if (title) {
                document.title = title;
            }
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                this.$head.find('title').text(title);
            }
            return this.enhanceMetaTags(view).enhanceCanonicalLinks(view);
        },
        enhanceMetaTags: function (view) {
            this.$head.find('meta[name="description"]').attr('content', view.metaDescription || view.getMetaDescription() || '').end().find('meta[name="keywords"]').attr('content', view.metaKeywords || view.getMetaKeywords() || '').end().append(view.getMetaTags().not('[name="description"]').not('[name="keywords"]'));
            var remove_element = false;
            jQuery('head').children().each(function () {
                var $element = jQuery(this), element_id = $element.attr('id');
                if (element_id === 'enhanceMetaTagsStart') {
                    remove_element = true;
                }
                if (remove_element) {
                    $element.remove();
                }
                if (remove_element && element_id === 'enhanceMetaTagsEnd') {
                    remove_element = false;
                }
            });
            var addToHead = view.getAddToHead();
            if (addToHead) {
                jQuery('<script id="enhanceMetaTagsStart"></script>' + addToHead + '<script id="enhanceMetaTagsEnd"></script>').appendTo(this.$head);
            }
            return this;
        },
        enhanceCanonicalLinks: function (view) {
            this.$head.find('link[rel="canonical"]').attr('href', view.getCanonical()).end().find('link[rel="next"], link[rel="prev"]').remove();
            this.setLinkRel('prev', view.getRelPrev());
            this.setLinkRel('next', view.getRelNext());
            return this;
        },
        setLinkRel: function (rel, link) {
            link && jQuery('<link />', {
                rel: rel,
                href: link
            }).appendTo(this.$head);
        },
        enhancePage: function (view, Layout) {
            this.$head = this.$head || this.initalizeHead();
            this.enhanceHead(view);
            EnhancedViews.clearPlaceholders();
            _.each(view.contentZones || [], function (content_zone) {
                if (view.$(content_zone.target).length === 0) {
                    if (jQuery(content_zone.target + ':empty').length === 0) {
                        return;
                    }
                }
                Layout.trigger('renderEnhancedPageContent', view, content_zone);
            });
        },
        renderHTMLContent: function (view, content_zone) {
            var target = content_zone.target, layout = view.options.application.getLayout();
            if (view.$(target).length) {
                view.$(target).html(content_zone.content);
                EnhancedViews.previousPlaceholders.push(content_zone.target);
                layout.trigger('afterAppendView', view);
            } else {
                layout.$(target).filter(':empty').each(function (index, element) {
                    jQuery(element).html(content_zone.content);
                    EnhancedViews.previousPlaceholders.push(content_zone.target);
                });
                layout.trigger('afterAppendView', layout);
            }
        },
        clearPlaceholders: function () {
            _.each(EnhancedViews.previousPlaceholders, function (previous_placeholder) {
                jQuery(previous_placeholder).empty();
            });
            EnhancedViews.previousPlaceholders = [];
        }
    });
    return EnhancedViews;
});
define('Content.LandingPages.View', [
    'Content.DataModels',
    'Content.EnhancedViews',
    'SC.Configuration',
    'landing_page.tpl',
    'landing_page_my_account.tpl',
    'Backbone',
    'underscore'
], function (DataModels, EnhancedViews, Configuration, landing_page_tpl, landing_page_my_account_tpl, Backbone) {
    'use strict';
    var Categories = false;
    try {
        Categories = require('Categories');
    } catch (e) {
    }
    return Backbone.View.extend({
        template: Configuration.get('currentTouchpoint') === 'customercenter' ? landing_page_my_account_tpl : landing_page_tpl,
        title: '',
        page_header: '',
        attributes: {
            'id': 'landing-page',
            'class': 'landing-page'
        },
        events: {},
        initialize: function () {
            this.url = Backbone.history && Backbone.history.fragment;
        },
        showContent: function (page) {
            this.page_header = page.get('pageheader');
            this.page = page;
            this.options.layout.showContent(this);
        },
        getBreadcrumbPages: function () {
            var breadcrumb = [];
            breadcrumb.push({
                href: this.url,
                text: this.page_header
            });
            return breadcrumb;
        },
        getContext: function () {
            return {
                pageHeaderAndNotInModal: this.page_header && !this.inModal,
                pageHeader: this.page_header,
                pageAndPageContent: this.page && this.page.get('content'),
                pageContent: this.page.get('content')
            };
        }
    });
});
define('Content.LandingPages.Router', [
    'Content.DataModels',
    'Content.EnhancedViews',
    'Content.LandingPages.View',
    'Backbone'
], function (DataModels, EnhancedViews, View, Backbone) {
    'use strict';
    return Backbone.Router.extend({
        routes: {},
        initialize: function (Application) {
            this.Application = Application;
        },
        displayLandingPage: function (option) {
            var self = this, page_url = option ? unescape(Backbone.history.fragment).replace('?' + option, '') : Backbone.history.fragment, view = new View({
                    application: this.Application,
                    layout: this.Application.getLayout()
                });
            DataModels.loadPage('/' + page_url, function (page) {
                if (page) {
                    EnhancedViews.overrideViewSettings(view, page);
                    view.showContent(page);
                } else {
                    self.Application.getLayout().notFound();
                }
            });
        }
    });
});
define('Content', [
    'Content.DataModels',
    'Content.EnhancedViews',
    'Content.LandingPages.Router',
    'Content.LandingPages.View',
    'SC.Configuration',
    'Tracker',
    'underscore',
    'jQuery',
    'Backbone',
    'Utils'
], function (DataModels, EnhancedViews, LandingPagesRouter, LandingPagesView, Configuration, Tracker, _, jQuery, Backbone) {
    'use strict';
    return {
        mountToApp: function (Application) {
            if (!Configuration.get('cms.useCMS')) {
                if (SC.ENVIRONMENT.CONTENT) {
                    DataModels.Urls.Collection.getInstance().reset(SC.ENVIRONMENT.CONTENT);
                    delete SC.ENVIRONMENT.CONTENT;
                    if (SC.ENVIRONMENT.DEFAULT_PAGE) {
                        DataModels.Pages.Collection.getInstance().reset(SC.ENVIRONMENT.DEFAULT_PAGE);
                        delete SC.ENVIRONMENT.DEFAULT_PAGE;
                    }
                }
                DataModels.Application = Application;
                var Layout = Application.getLayout(), show_content_wrapper = function (fn, view) {
                        var promise = jQuery.Deferred();
                        var args = arguments;
                        DataModels.loadPage('/' + Backbone.history.fragment, function (page) {
                            EnhancedViews.overrideViewSettings(view, page);
                            view.enhancedPage = true;
                            Tracker.getInstance().trackPageview('/' + Backbone.history.fragment);
                            fn.apply(Layout, Array.prototype.slice.call(args, 1)).done(function () {
                                EnhancedViews.enhancePage(view, Layout);
                                promise.resolveWith(this, arguments);
                            });
                        });
                        return promise;
                    };
                Layout.showContent = _.wrap(Layout.showContent, show_content_wrapper);
                Layout.showInModal = _.wrap(Layout.showInModal, show_content_wrapper);
                Layout.on('renderEnhancedPageContent', function (view, content_zone) {
                    if (content_zone.contenttype === 'html') {
                        EnhancedViews.renderHTMLContent(view, content_zone);
                    } else if (content_zone.contenttype === 'merchandising') {
                        EnhancedViews.previousPlaceholders.push(content_zone.target);
                    }
                });
                Application.on('afterModulesLoaded', function () {
                    var query = '';
                    _.each(DataModels.Urls.Collection.getInstance().landingPages, function (landing_page) {
                        query = landing_page.get('query')[0] === '/' ? landing_page.get('query').substring(1) : landing_page.get('query');
                        LandingPagesRouter.prototype.routes[query + '?*options'] = 'displayLandingPage';
                        LandingPagesRouter.prototype.routes[query] = 'displayLandingPage';
                    });
                    return new LandingPagesRouter(Application);
                });
                Application.on('afterStart', function () {
                    Backbone.history && Backbone.history.on('all', function () {
                        DataModels.loadPage('/' + Backbone.history.fragment);
                    });
                    Backbone.history && DataModels.loadPage('/' + Backbone.history.fragment);
                });
            }
        }
    };
});
define('Categories', [
    'SC.Configuration',
    'underscore'
], function (Configuration, _) {
    'use strict';
    return {
        topLevelCategories: [],
        makeNavigationTab: function (categories) {
            var result = [], self = this;
            _.each(categories, function (category) {
                var href = category.fullurl, tab = {
                        'href': href,
                        'text': category.name,
                        'data': {
                            hashtag: '#' + href,
                            touchpoint: 'home'
                        },
                        'class': 'header-menu-level' + category.level + '-anchor',
                        'data-type': 'commercecategory'
                    };
                if (category.categories) {
                    tab.categories = self.makeNavigationTab(category.categories);
                }
                result.push(tab);
            });
            return result;
        },
        addToNavigationTabs: function (categories) {
            if (Configuration.get('categories.addToNavigationTabs')) {
                var self = this, navigationData = Configuration.get('navigationData'), index = -1;
                var lastIndex = navigationData.length;
                while (lastIndex--) {
                    if (navigationData[lastIndex]['data-type'] === 'commercecategory') {
                        navigationData.splice(lastIndex, 1);
                    }
                }
                for (var i = 0; i < navigationData.length; i++) {
                    if (navigationData[i].placeholder === 'Categories') {
                        index = i;
                        break;
                    }
                }
                if (index !== -1) {
                    var tabs = self.makeNavigationTab(categories);
                    _.each(tabs, function (tab, position) {
                        navigationData.splice(index + position, 0, tab);
                    });
                }
                this.application.trigger('Configuration.navigationData');
            }
        },
        getTopLevelCategoriesUrlComponent: function () {
            return this.topLevelCategories;
        },
        mountToApp: function (application) {
            if (Configuration.get('categories')) {
                var self = this, categories = SC.CATEGORIES;
                this.application = application;
                _.each(categories, function (category) {
                    self.topLevelCategories.push(category.fullurl);
                });
                this.addToNavigationTabs(categories);
            }
        }
    };
});
define('Facets.Translator', [
    'underscore',
    'jQuery',
    'SC.Configuration',
    'Utils',
    'UrlHelper'
], function (_, jQuery, Configuration) {
    'use strict';
    var default_config = {
        fallbackUrl: 'search',
        defaultShow: null,
        defaultOrder: null,
        defaultDisplay: null,
        facets: [],
        facetDelimiters: {
            betweenFacetNameAndValue: '/',
            betweenDifferentFacets: '/',
            betweenDifferentFacetsValues: ',',
            betweenRangeFacetsValues: 'to',
            betweenFacetsAndOptions: '?',
            betweenOptionNameAndValue: '=',
            betweenDifferentOptions: '&'
        }
    };
    function FacetsTranslator(facets, options, configuration, category) {
        if (!(this instanceof FacetsTranslator)) {
            return new FacetsTranslator(facets, options, configuration, category);
        }
        this.facets = [];
        this.options = {};
        this.configuration = configuration || default_config;
        var facets_data = Configuration.get('siteSettings.facetfield'), facets_to_include = [];
        _.each(facets_data, function (facet) {
            if (facet.facetfieldid !== 'commercecategory') {
                facets_to_include.push(facet.facetfieldid);
                facet.urlcomponent && facets_to_include.push(facet.urlcomponent);
                _.each(facet.urlcomponentaliases, function (facet_alias) {
                    facets_to_include.push(facet_alias.urlcomponent);
                });
            }
        });
        facets_to_include = _.union(facets_to_include, _.pluck(Configuration.get('facets'), 'id'));
        facets_to_include = _.uniq(facets_to_include);
        this.facetsToInclude = facets_to_include;
        this.isCategoryPage = !!category;
        if (_.isBoolean(category) && category) {
            var index = facets.length, facetsToInclude = this.facetsToInclude.slice(0);
            facetsToInclude.push(this.configuration.facetDelimiters.betweenFacetsAndOptions);
            _.each(facetsToInclude, function (facetname) {
                var i = facets.indexOf(facetname);
                if (i !== -1 && i < index) {
                    index = i;
                }
            });
            var categoryUrl = facets.substring(0, index);
            facets = facets.substring(index);
            if (categoryUrl[0] !== '/') {
                categoryUrl = '/' + categoryUrl;
            }
            if (categoryUrl[categoryUrl.length - 1] === '/') {
                categoryUrl = categoryUrl.substring(0, categoryUrl.length - 1);
            }
            this.categoryUrl = categoryUrl;
        } else if (_.isString(category)) {
            this.categoryUrl = category;
        }
        if (facets && options) {
            this.facets = facets;
            this.options = options;
        } else if (_.isString(facets)) {
            this.parseUrl(facets);
        } else if (facets) {
            this.parseOptions(facets);
        }
    }
    _.extend(FacetsTranslator.prototype, {
        defaultFacetConfig: {
            behavior: 'single',
            max: 5
        },
        getFacetsToInclude: function getFacetsToInclude() {
            return this.facetsToInclude;
        },
        parseUrl: function parseUrl(url) {
            url = url[0] === '/' ? url.substr(1) : url;
            var facets_n_options = url.split(this.configuration.facetDelimiters.betweenFacetsAndOptions), facets = facets_n_options[0] && facets_n_options[0] !== this.configuration.fallbackUrl ? facets_n_options[0] : '', options = facets_n_options[1] || '';
            if (this.isCategoryPage) {
                facets = facets.replace(this.categoryUrl, '');
                facets = facets[0] === '/' ? facets.substr(1) : facets;
            }
            var facet_tokens = facets.split(new RegExp('[\\' + this.configuration.facetDelimiters.betweenDifferentFacets + '\\' + this.configuration.facetDelimiters.betweenFacetNameAndValue + ']+', 'ig'));
            while (facet_tokens.length > 0) {
                var facet_name = facet_tokens.shift(), facet_value = facet_tokens.shift();
                if (!this.facetIsParameter(facet_name)) {
                    this.parseUrlFacet(facet_name, facet_value);
                }
            }
            var options_tokens = options.split(new RegExp('[\\' + this.configuration.facetDelimiters.betweenOptionNameAndValue + '\\' + this.configuration.facetDelimiters.betweenDifferentOptions + ']+', 'ig')), tmp_options = {};
            while (options_tokens.length > 0) {
                var option_name = options_tokens.shift(), option_value = options_tokens.shift(), option_is_facet = _.contains(this.facetsToInclude, option_name);
                if (option_is_facet && this.facetIsParameter(option_name)) {
                    this.parseUrlFacet(option_name, option_value);
                }
                tmp_options[option_name] = option_value;
            }
            this.parseUrlOptions(tmp_options);
        },
        facetIsParameter: function facetIsParameter(facet_name) {
            var facet_config = this.getFacetConfig(facet_name);
            return _.isUndefined(facet_config.isParameter) ? this.configuration.facetsAsUrlParameters : facet_config.isParameter;
        },
        sanitizeValue: function sanitizeValue(value, behavior) {
            var parsed_value;
            switch (behavior) {
            case 'range':
                if (_.isString(value)) {
                    if (value.indexOf(this.configuration.facetDelimiters.betweenRangeFacetsValues) !== -1) {
                        var tokens = value.split(this.configuration.facetDelimiters.betweenRangeFacetsValues);
                        parsed_value = {
                            from: tokens[0],
                            to: tokens[1]
                        };
                    } else {
                        parsed_value = {
                            from: '0',
                            to: value
                        };
                    }
                } else {
                    parsed_value = value;
                }
                break;
            case 'multi':
                if (value.indexOf(this.configuration.facetDelimiters.betweenDifferentFacetsValues) !== -1) {
                    parsed_value = value.split(this.configuration.facetDelimiters.betweenDifferentFacetsValues);
                } else {
                    parsed_value = [value];
                }
                break;
            default:
                parsed_value = value;
            }
            return parsed_value;
        },
        getUrlFacetValue: function getUrlFacetValue(facet_url) {
            return (_.find(this.facets, function (facet) {
                return facet.url === facet_url;
            }) || {}).value;
        },
        getFacetValue: function getFacetValue(facet_id) {
            return (_.find(this.facets, function (facet) {
                return facet.id === facet_id;
            }) || {}).value;
        },
        getAllFacets: function getAllFacets() {
            return this.facets.slice(0);
        },
        getOptionValue: function getOptionValue(option_id) {
            return this.options[option_id] || null;
        },
        parseUrlFacet: function parseUrlFacet(name, value) {
            var config = this.getFacetConfig(name, 'id');
            if (config.id === 'commercecategoryname' || config.id === 'category' || !name) {
                return;
            }
            this.facets.push({
                config: config,
                id: config.id,
                url: config.id,
                value: this.sanitizeValue(value, config.behavior),
                isParameter: config.isParameter
            });
        },
        parseFacet: function parseFacet(facet_id, value) {
            var config = this.getFacetConfig(facet_id, 'id');
            this.facets.push({
                config: config,
                id: config.id,
                url: config.id,
                value: this.sanitizeValue(value, config.behavior),
                isParameter: config.isParameter
            });
        },
        parseUrlOptions: function parseUrlOptions(options) {
            this.options.show = options.show || this.configuration.defaultShow;
            this.options.order = options.order || this.configuration.defaultOrder;
            this.options.page = parseInt(options.page, 10) || 1;
            this.options.display = options.display || this.configuration.defaultDisplay;
            this.options.keywords = options.keywords ? decodeURIComponent(options.keywords) : this.configuration.defaultKeywords;
        },
        getFacetConfig: function getFacetConfig(name) {
            var result = _.find(this.configuration.facets, function (facet) {
                return facet.id === name;
            });
            result = result || _.find(this.configuration.facets, function (facet) {
                return facet.url === name;
            });
            return result || _.extend({
                id: name,
                name: name,
                url: name,
                isParameter: undefined
            }, this.defaultFacetConfig);
        },
        getUrl: function getUrl() {
            var url = this.categoryUrl || '', self = this;
            var facets_seo_limits = {};
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                facets_seo_limits = {
                    numberOfFacetsGroups: this.configuration.facetsSeoLimits && this.configuration.facetsSeoLimits.numberOfFacetsGroups || false,
                    numberOfFacetsValues: this.configuration.facetsSeoLimits && this.configuration.facetsSeoLimits.numberOfFacetsValues || false,
                    options: this.configuration.facetsSeoLimits && this.configuration.facetsSeoLimits.options || false
                };
            }
            if (facets_seo_limits.numberOfFacetsGroups && this.facets.length > facets_seo_limits.numberOfFacetsGroups) {
                return '#';
            }
            var sorted_facets = _.sortBy(this.facets, 'url'), facets_as_options = [];
            for (var i = 0; i < sorted_facets.length; i++) {
                var facet = sorted_facets[i];
                if (facet.id === 'commercecategoryname' || facet.id === 'category') {
                    break;
                }
                var name = facet.url || facet.id, value = '';
                switch (facet.config.behavior) {
                case 'range':
                    facet.value = typeof facet.value === 'object' ? facet.value : {
                        from: 0,
                        to: facet.value
                    };
                    value = facet.value.from + self.configuration.facetDelimiters.betweenRangeFacetsValues + facet.value.to;
                    break;
                case 'multi':
                    value = facet.value.sort().join(self.configuration.facetDelimiters.betweenDifferentFacetsValues);
                    if (facets_seo_limits.numberOfFacetsValues && facet.value.length > facets_seo_limits.numberOfFacetsValues) {
                        return '#';
                    }
                    break;
                default:
                    value = facet.value;
                }
                if (self.facetIsParameter(name)) {
                    facets_as_options.push({
                        facetName: name,
                        facetValue: value
                    });
                } else {
                    if (url !== '') {
                        url += self.configuration.facetDelimiters.betweenDifferentFacets;
                    }
                    url += name + self.configuration.facetDelimiters.betweenFacetNameAndValue + value;
                }
            }
            url = url !== '' ? url : '/' + this.configuration.fallbackUrl;
            var tmp_options = {}, separator = this.configuration.facetDelimiters.betweenOptionNameAndValue;
            if (this.options.order && this.options.order !== this.configuration.defaultOrder) {
                tmp_options.order = 'order' + separator + this.options.order;
            }
            if (this.options.page && parseInt(this.options.page, 10) !== 1) {
                tmp_options.page = 'page' + separator + encodeURIComponent(this.options.page);
            }
            if (this.options.show && parseInt(this.options.show, 10) !== this.configuration.defaultShow) {
                tmp_options.show = 'show' + separator + encodeURIComponent(this.options.show);
            }
            if (this.options.display && this.options.display !== this.configuration.defaultDisplay) {
                tmp_options.display = 'display' + separator + encodeURIComponent(this.options.display);
            }
            if (this.options.keywords && this.options.keywords !== this.configuration.defaultKeywords) {
                tmp_options.keywords = 'keywords' + separator + encodeURIComponent(this.options.keywords);
            }
            for (i = 0; i < facets_as_options.length; i++) {
                var facet_option_obj = facets_as_options[i];
                tmp_options[facet_option_obj.facetName] = facet_option_obj.facetName + separator + facet_option_obj.facetValue;
            }
            var tmp_options_keys = _.keys(tmp_options), tmp_options_vals = _.values(tmp_options);
            if (facets_seo_limits.options && _.difference(tmp_options_keys, facets_seo_limits.options).length) {
                return '#';
            }
            url += tmp_options_vals.length ? this.configuration.facetDelimiters.betweenFacetsAndOptions + tmp_options_vals.join(this.configuration.facetDelimiters.betweenDifferentOptions) : '';
            return _(url).fixUrl();
        },
        getCategoryUrl: function getCategoryUrl() {
            return this.categoryUrl;
        },
        getApiParams: function getApiParams() {
            var params = {};
            _.each(this.facets, function (facet) {
                switch (facet.config.behavior) {
                case 'range':
                    var value = typeof facet.value === 'object' ? facet.value : {
                        from: 0,
                        to: facet.value
                    };
                    params[facet.id + '.from'] = value.from;
                    params[facet.id + '.to'] = value.to;
                    break;
                case 'multi':
                    params[facet.id] = facet.value.sort().join(',');
                    break;
                default:
                    params[facet.id] = facet.value;
                }
            });
            params.sort = this.options.order;
            params.limit = this.options.show;
            params.offset = this.options.show * this.options.page - this.options.show;
            params.q = this.options.keywords;
            if (this.isCategoryPage) {
                params.commercecategoryurl = this.categoryUrl;
                params.sort = params.sort.replace('relevance', 'commercecategory');
            }
            return params;
        },
        cloneForFacetId: function cloneForFacetId(facet_id, facet_value) {
            var facets = _.toArray(jQuery.extend(true, {}, this.facets)), options = jQuery.extend(true, {}, this.options), current_facet = _.find(facets, function (facet) {
                    return facet.id === facet_id;
                });
            if (current_facet) {
                if (current_facet.config.behavior === 'multi') {
                    if (_.indexOf(current_facet.value, facet_value) === -1) {
                        current_facet.value.push(facet_value);
                    } else {
                        current_facet.value = _.without(current_facet.value, facet_value);
                    }
                    if (current_facet.value.length === 0) {
                        facets = _.without(facets, current_facet);
                    }
                } else {
                    if (!_.isEqual(current_facet.value, facet_value)) {
                        current_facet.value = facet_value;
                    } else {
                        facets = _.without(facets, current_facet);
                    }
                }
            }
            options.page = 1;
            var translator = new FacetsTranslator(facets, options, this.configuration, this.categoryUrl);
            if (!current_facet) {
                translator.parseFacet(facet_id, facet_value);
            }
            return translator;
        },
        cloneWithoutFacetId: function cloneWithoutFacetId(facet_id) {
            var facets = _.toArray(jQuery.extend(true, {}, this.facets)), options = jQuery.extend(true, {}, this.options);
            facets = _.without(facets, _.find(facets, function (facet) {
                return facet.id === facet_id;
            }));
            return new FacetsTranslator(facets, options, this.configuration, this.categoryUrl);
        },
        cloneWithoutFacets: function cloneWithoutFacets() {
            var translator = new FacetsTranslator(this.facets, this.options, this.configuration, this.categoryUrl);
            _.each(translator.getAllFacets(), function (facet) {
                if (facet.id !== 'commercecategoryname' && facet.id !== 'category') {
                    translator = translator.cloneWithoutFacetId(facet.id);
                }
            });
            return translator;
        },
        cloneForOption: function cloneForOption(option_id, option_value) {
            var facets = _.toArray(jQuery.extend(true, {}, this.facets)), options = jQuery.extend(true, {}, this.options);
            options[option_id] = option_value;
            return new FacetsTranslator(facets, options, this.configuration, this.categoryUrl);
        },
        cloneForOptions: function cloneForOptions(object) {
            var facets = _.toArray(jQuery.extend(true, {}, this.facets)), options = jQuery.extend(true, {}, this.options, object);
            return new FacetsTranslator(facets, options, this.configuration, this.categoryUrl);
        },
        cloneWithoutOption: function cloneWithoutOption(option_id) {
            var facets = _.toArray(jQuery.extend(true, {}, this.facets)), options = jQuery.extend(true, {}, this.options);
            delete options[option_id];
            return new FacetsTranslator(facets, options, this.configuration, this.categoryUrl);
        },
        resetAll: function resetAll() {
            return new FacetsTranslator([], {}, this.configuration, false);
        },
        setLabelsFromFacets: function setLabelsFromFacets(facets_labels) {
            this.facetsLabels = facets_labels;
        },
        getLabelForValue: function getLabelForValue(id, value) {
            var facet = _.filter(this.facetsLabels || [], function (facet_label) {
                return facet_label.id === id || facet_label.url === id;
            });
            if (facet.length) {
                var label = _.where(facet[0].values || [], { name: value });
                if (!label.length) {
                    label = _.where(facet[0].values || [], { url: value });
                }
                if (label.length && label[0].label) {
                    return label[0].label;
                }
            }
            return value;
        }
    });
    return FacetsTranslator;
});
define('Facets.Model', [
    'Backbone.CachedModel',
    'Item.Collection',
    'Session',
    'Profile.Model',
    'SC.Configuration',
    'underscore',
    'Utils'
], function (BackboneCachedModel, ItemCollection, Session, ProfileModel, Configuration, _) {
    'use strict';
    var original_fetch = BackboneCachedModel.prototype.fetch;
    return BackboneCachedModel.extend({
        options: {},
        searchApiMasterOptions: Configuration.get('searchApiMasterOptions.Facets', {}),
        url: function () {
            var profile = ProfileModel.getInstance(), url = _.addParamsToUrl(profile.getSearchApiUrl(), _.extend(Configuration.get('matrixchilditems.enabled') && Configuration.get('matrixchilditems.fieldset') ? { matrixchilditems_fieldset: Configuration.get('matrixchilditems.fieldset') } : {}, this.searchApiMasterOptions, Session.getSearchApiParams()), profile.isAvoidingDoubleRedirect());
            return url;
        },
        initialize: function (options) {
            if (options && options.searchApiMasterOptions) {
                this.searchApiMasterOptions = options.searchApiMasterOptions;
            }
            this.on('change:items', function (model, items) {
                if (!(items instanceof ItemCollection)) {
                    model.set('items', new ItemCollection(_.compact(items)));
                }
            });
        },
        fetch: function (options) {
            options = _.extend(options || {}, this.options);
            options.cache = true;
            return original_fetch.apply(this, arguments);
        }
    });
});
define('Facets.Helper', ['Facets.Translator'], function (Translator) {
    'use strict';
    return {
        settings_stack: [],
        parseUrl: function (fullurl, configuration, isCategoryPage) {
            return new Translator(fullurl, null, configuration, isCategoryPage);
        },
        setCurrent: function (settings) {
            this.settings_stack.push(settings);
        },
        getCurrent: function () {
            return this.settings_stack[this.settings_stack.length - 1];
        },
        getPrevious: function () {
            return this.settings_stack[this.settings_stack.length - 2];
        }
    };
});
define('Facets.FacetedNavigationItem.View', [
    'SC.Configuration',
    'facets_faceted_navigation_item.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'underscore',
    'jQuery',
    'Bootstrap.Slider'
], function (Configuration, facets_faceted_navigation_item_tpl, Backbone, BackboneCompositeView, BackboneCollectionView, _, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: facets_faceted_navigation_item_tpl,
        events: {
            'click [data-action="see-more"]': 'toggleSeeMoreLess',
            'slide div[data-toggle="slider"]': 'updateRangeValues',
            'stop div[data-toggle="slider"]': 'updateRangeSelection'
        },
        initialize: function () {
            this.facetId = this.model.get('url') || this.model.get('id');
            this.facet_config = this.options.translator.getFacetConfig(this.facetId);
            if (this.facet_config.template) {
                this.template = this.facet_config.template;
            }
            this.on('afterViewRender', this.renderFacets, this);
        },
        renderFacets: function () {
            this.sliders = this.$('[data-toggle="slider"]').slider();
            this.$('[data-collapsed="true"]').hide();
        },
        destroy: function () {
            if (this.sliders.data('slider')) {
                this.sliders.data('slider').stopListen();
            }
            Backbone.View.prototype.destroy.apply(this, arguments);
        },
        toggleSeeMoreLess: function (event) {
            var target = jQuery(event.currentTarget), target_see_more = target.find('[data-type="see-more"]'), target_see_less = target.find('[data-type="see-less"]'), target_was_expanded = !!target.data('collapsed');
            if (target_was_expanded) {
                target_see_more.show();
                target_see_less.hide();
            } else {
                target_see_more.hide();
                target_see_less.show();
            }
            target.data('collapsed', !target_was_expanded);
        },
        updateRangeValues: function (e, slider) {
            var parser = this.options.translator.getFacetConfig(this.facetId).parser, start = _.isFunction(parser) ? parser(slider.values.low, true) : slider.values.low, end = _.isFunction(parser) ? parser(slider.values.high, false) : slider.values.high;
            this.$el.find('span[data-range-indicator="start"]').html(start).end().find('span[data-range-indicator="end"]').html(end);
        },
        updateRangeSelection: function (e, slider) {
            var translator = this.options.translator, slider_values = slider.values, facet_values = translator.getFacetValue(this.facetId), values = _.map(this.model.get('values'), function (item) {
                    return parseFloat(item.url);
                });
            if (_.min(values) === slider_values.low && _.max(values) === slider_values.high) {
                Backbone.history.navigate(translator.cloneWithoutFacetId(this.facetId).getUrl(), { trigger: true });
            } else if (!facet_values || parseFloat(facet_values.from) !== slider_values.low || parseFloat(facet_values.to) !== slider_values.high) {
                Backbone.history.navigate(translator.cloneForFacetId(this.facetId, {
                    from: slider_values.low.toFixed(2),
                    to: slider_values.high.toFixed(2)
                }).getUrl(), { trigger: true });
            }
        },
        getContext: function () {
            var facet_id = this.facetId, translator = this.options.translator, facet_config = this.facet_config, values = [], range_min = 0, range_max = 0, range_from = 0, range_from_label = '', range_to = 0, range_to_label = '', range_values = [], max_items, display_values, extra_values = [], show_facet, show_remove_link, selected_values = this.options.translator.getFacetValue(facet_id) || [];
            selected_values = _.isArray(selected_values) ? selected_values : [selected_values];
            show_remove_link = !!selected_values.length;
            var original_values = _.isArray(this.model.get('values')) ? this.model.get('values') : [this.model.get('values')];
            if (facet_config.behavior !== 'range') {
                _.each(original_values, function (value) {
                    if (value.url !== '') {
                        value.isActive = _.contains(selected_values, value.url);
                        value.link = translator.cloneForFacetId(facet_id, value.url).getUrl();
                        value.displayName = value.label || decodeURIComponent(value.url) || _('(none)').translate();
                        value.color = '';
                        value.isColorTile = false;
                        value.image = {};
                        value.isImageTile = false;
                        if (facet_config.colors) {
                            value.color = facet_config.colors[value.label] || facet_config.colors.defaultColor;
                            if (_.isObject(value.color)) {
                                value.image = value.color;
                                value.color = '';
                                value.isImageTile = true;
                            } else {
                                value.isColorTile = true;
                            }
                        }
                        values.push(value);
                    }
                });
                max_items = facet_config.max || values.length;
                display_values = _.first(values, max_items);
                _(display_values).each(function (value) {
                    value.isLightColor = _.contains(Configuration.get('layout.lightColors', []), value.label);
                });
                extra_values = _.rest(values, max_items);
                show_facet = !!values.length;
            } else {
                range_values = _.map(original_values, function (item) {
                    return parseFloat(item.url);
                });
                range_min = _.min(range_values);
                range_max = _.max(range_values);
                show_facet = range_max > range_min;
                show_remove_link = this.model.get('max') !== range_max || this.model.get('min') !== range_min;
                var translator_value = translator.getFacetValue(facet_id) || {
                    from: range_min,
                    to: range_max
                };
                range_from = translator_value.from;
                range_to = translator_value.to;
                range_to_label = _.isFunction(facet_config.parser) ? facet_config.parser(range_to, false) : range_to;
                range_from_label = _.isFunction(facet_config.parser) ? facet_config.parser(range_from, false) : range_from;
            }
            var context = {
                htmlId: _.uniqueId('facetList_'),
                facetId: facet_id,
                showFacet: show_facet,
                showHeading: _.isBoolean(facet_config.showHeading) ? facet_config.showHeading : true,
                isUncollapsible: !!facet_config.uncollapsible,
                isCollapsed: !this.facet_config.uncollapsible && this.facet_config.collapsed,
                isMultiSelect: facet_config.behavior === 'multi',
                showRemoveLink: show_remove_link,
                removeLink: translator.cloneWithoutFacetId(facet_id).getUrl(),
                facetDisplayName: facet_config.name || facet_id,
                values: values,
                displayValues: display_values,
                extraValues: extra_values,
                showExtraValues: !!extra_values.length,
                isRange: facet_config.behavior === 'range',
                rangeValues: range_values,
                rangeMin: range_min,
                rangeMax: range_max,
                rangeFrom: range_from,
                rangeFromLabel: range_from_label,
                rangeTo: range_to,
                rangeToLabel: range_to_label
            };
            return context;
        }
    });
});
define('Facets.FacetedNavigation.View', [
    'Facets.Helper',
    'Facets.FacetedNavigationItem.View',
    'Profile.Model',
    'facets_faceted_navigation.tpl',
    'SC.Configuration',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'underscore'
], function (FacetsHelper, FacetsFacetedNavigationItemView, ProfileModel, facets_faceted_navigation_tpl, Configuration, Backbone, BackboneCompositeView, BackboneCollectionView, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_faceted_navigation_tpl,
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.categoryItemId = options.categoryItemId;
            this.clearAllFacetsLink = options.clearAllFacetsLink;
            this.hasCategories = options.hasCategories;
            this.hasItems = options.hasItems;
            this.hasFacets = options.hasFacets;
            this.hasCategoriesAndFacets = options.hasCategoriesAndFacets;
            this.appliedFacets = options.appliedFacets;
            this.hasFacetsOrAppliedFacets = options.hasFacetsOrAppliedFacets;
            this.keywords = options.keywords;
            this.totalProducts = options.totalProducts;
        },
        childViews: {
            'Facets.FacetedNavigationItems': function () {
                var translator = this.options.translator, ordered_facets = this.options.facets && this.options.facets.sort(function (a, b) {
                        return (translator.getFacetConfig(b.url || b.id).priority || 0) - (translator.getFacetConfig(a.url || a.id).priority || 0);
                    });
                var hidden_facet_names = Configuration.get('loginToSeePrices.hiddenFacetNames', []);
                if (ProfileModel.getInstance().hidePrices()) {
                    ordered_facets = _.reject(ordered_facets, function (item) {
                        return _.indexOf(hidden_facet_names, item.id) >= 0;
                    });
                }
                return new BackboneCollectionView({
                    childView: FacetsFacetedNavigationItemView,
                    viewsPerRow: 1,
                    collection: new Backbone.Collection(ordered_facets),
                    childViewOptions: { translator: translator }
                });
            }
        },
        getContext: function () {
            return {
                totalProducts: this.totalProducts,
                isTotalProductsOne: this.totalProducts === 1,
                keywords: this.keywords,
                categoryItemId: this.categoryItemId,
                clearAllFacetsLink: this.clearAllFacetsLink,
                hasCategories: this.hasCategories,
                hasItems: this.hasItems,
                hasFacets: this.hasFacets,
                hasCategoriesAndFacets: this.hasCategoriesAndFacets,
                appliedFacets: this.appliedFacets,
                hasAppliedFacets: this.appliedFacets && this.appliedFacets.length > 0,
                hasFacetsOrAppliedFacets: this.hasFacetsOrAppliedFacets
            };
        }
    });
});
define('Facets.FacetsDisplay.View', [
    'Backbone.CollectionView',
    'facets_facets_display.tpl',
    'Backbone',
    'underscore'
], function (BackboneCollectionView, facets_facets_display_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_facets_display_tpl,
        getContext: function () {
            var facets = this.options.facets, translator = this.options.translator;
            _.each(facets, function (facet) {
                facet.value = _.isArray(facet.value) ? facet.value : [facet.value];
            });
            var facet_values = [];
            _.each(facets, function (facet) {
                _.each(facet.value, function (value) {
                    var value_data = {
                        facetValueIsObject: _.isObject(value),
                        from: _.isObject(value) ? _.formatCurrency(value.from) : '',
                        to: _.isObject(value) ? _.formatCurrency(value.to) : '',
                        valueLabel: translator.getLabelForValue(facet.id, value),
                        facetValueUrl: translator.cloneForFacetId(facet.id, value).getUrl(),
                        facetValue: facet.value
                    };
                    facet_values.push(value_data);
                });
            });
            return {
                hasFacets: facets.length > 0,
                clearAllFacetsLink: translator.cloneWithoutFacets().getUrl(),
                values: facet_values
            };
        }
    });
});
define('Facets.FacetValue.View', [
    'facets_facet_value.tpl',
    'Backbone',
    'underscore'
], function (facets_facet_value_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_facet_value_tpl,
        getContext: function () {
            return {
                isActive: _.contains(this.selected, this.options.isActiveByLabel ? this.model.label : this.model.url),
                facetValueUrl: this.options.translator.cloneForFacetId(this.options.facetId, this.model.url).getUrl(),
                label: this.model.label,
                formattedLabel: this.options.model.label || this.model.url || _('(none)').translate(),
                value: this.model.value,
                url: this.model.url,
                behaviorIsMulti: this.options.config.behavior === 'multi'
            };
        }
    });
});
define('Facets.FacetList.View', [
    'Backbone.CollectionView',
    'Facets.FacetValue.View',
    'facets_facet_list.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore'
], function (BackboneCollectionView, FacetsFacetValueView, facets_facet_list_tpl, Backbone, BackboneCompositeView, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_facet_list_tpl,
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.translator = options.translator;
            this.facet = options.facet;
            this.config = options.config;
            var selected = this.translator.getFacetValue(this.facet.id) || [], facet_values = this.facet.values;
            this.selected = _.isArray(selected) ? selected : [selected];
            this.values = _.reject(_.isArray(facet_values) ? facet_values : [facet_values], function (filter) {
                return filter.url === '';
            });
        },
        childViews: {
            'Facets.FacetValue.Values': function () {
                return new BackboneCollectionView({
                    childView: FacetsFacetValueView,
                    collection: _.first(this.values, this.config.max),
                    childViewOptions: {
                        selected: this.selected,
                        translator: this.translator,
                        facetId: this.facet.id,
                        isActiveByLabel: false
                    }
                });
            },
            'Facets.FacetValue.Extra': function () {
                var self = this;
                return new BackboneCollectionView({
                    childView: FacetsFacetValueView,
                    collection: _.rest(self.values, this.config.max),
                    childViewOptions: {
                        selected: this.selected,
                        translator: this.translator,
                        facetId: this.facet.id,
                        isActiveByLabel: true
                    }
                });
            }
        },
        getContext: function () {
            var facet_html_id = _.uniqueId('facetList_'), config_max = this.config.max || this.values.length;
            return {
                facetUrl: this.translator.cloneWithoutFacetId(this.facet.id).getUrl(),
                facetName: this.config.name || this.facet.id,
                hasValues: !!(this.values && this.values.length),
                showHeading: !this.config.hideHeading,
                unCollapsible: this.config.uncollapsible,
                facetSelected: this.translator.getFacetValue(this.facet.id) || [],
                facetHtmlId: facet_html_id,
                facetId: this.facet.id,
                hasSelectedFacetValues: !!this.selected.length,
                configMax: config_max,
                hasMoreValuesThanConfigMax: this.values.length > config_max,
                isCollapsed: !this.config.uncollapsible && this.config.collapsed
            };
        }
    });
});
define('Facets.ItemListDisplaySelector.View', [
    'facets_item_list_display_selector.tpl',
    'Backbone',
    'underscore'
], function (facets_item_list_display_selector_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_item_list_display_selector_tpl,
        getContext: function () {
            var option_items = this.options.options, translator = this.options.translator, processed_option_items = [];
            _.each(option_items, function (option_item) {
                var processed_option_item = {
                    configOptionUrl: translator.cloneForOption('display', option_item.id).getUrl(),
                    isActive: translator.getOptionValue('display') === option_item.id,
                    isGrid: option_item.id === 'grid',
                    name: option_item.name,
                    icon: option_item.icon
                };
                processed_option_items.push(processed_option_item);
            });
            return {
                configClasses: this.options.configClasses,
                options: processed_option_items
            };
        }
    });
});
define('Facets.ItemListSortSelector.View', [
    'facets_item_list_sort_selector.tpl',
    'Profile.Model',
    'Backbone',
    'underscore'
], function (facets_item_list_sort_selector_tpl, ProfileModel, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_item_list_sort_selector_tpl,
        getContext: function () {
            var option_items = this.options.options, translator = this.options.translator, processed_option_items = [];
            if (ProfileModel.getInstance().hidePrices()) {
                option_items = _.filter(option_items, function (item) {
                    return item.id.search('price') === -1;
                });
            }
            _.each(option_items, function (option_item) {
                var processed_option_item = {
                    configOptionUrl: translator.cloneForOptions({
                        order: option_item.id,
                        page: 1
                    }).getUrl(),
                    isSelected: translator.getOptionValue('order') === option_item.id ? 'selected' : '',
                    name: option_item.name,
                    className: option_item.id.replace(':', '-')
                };
                processed_option_items.push(processed_option_item);
            });
            return { options: processed_option_items };
        }
    });
});
define('Facets.ItemListShowSelector.View', [
    'facets_item_list_show_selector.tpl',
    'Backbone',
    'underscore'
], function (facets_item_list_show_selector_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_item_list_show_selector_tpl,
        getContext: function () {
            var option_items = this.options.options, translator = this.options.translator, processed_option_items = [];
            _.each(option_items, function (option_item) {
                var processed_option_item = {
                    configOptionUrl: translator.cloneForOptions({
                        show: option_item.items,
                        page: 1
                    }).getUrl(),
                    isSelected: parseInt(translator.getOptionValue('show'), 10) === option_item.items,
                    name: _(option_item.name).translate(option_item.items),
                    className: option_item.items
                };
                processed_option_items.push(processed_option_item);
            });
            return { options: processed_option_items };
        }
    });
});
define('Facets.Empty.View', [
    'SC.Configuration',
    'facets_empty.tpl',
    'Utils',
    'Backbone'
], function (Configuration, facets_empty_tpl, Utils, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: facets_empty_tpl,
        getContext: function () {
            return { keywords: this.options.keywords };
        }
    });
});
define('Facets.Browse.CategoryHeading.View', [
    'Backbone',
    'facets_browse_category_heading.tpl'
], function (Backbone, facetsBrowseCategoryHeadingTpl) {
    'use strict';
    return Backbone.View.extend({
        template: facetsBrowseCategoryHeadingTpl,
        getContext: function () {
            return {
                name: this.model.get('name'),
                banner: this.model.get('pagebannerurl'),
                description: this.model.get('description'),
                pageheading: this.model.get('pageheading') || this.model.get('name'),
                hasBanner: !!this.model.get('pagebannerurl'),
                showDescription: !!this.options.showDescription
            };
        }
    });
});
define('Facets.CategoryCell.View', [
    'facets_category_cell.tpl',
    'Backbone'
], function (facets_category_cell_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: facets_category_cell_tpl,
        getContext: function () {
            return {
                name: this.model.get('name'),
                url: this.model.get('fullurl'),
                image: this.model.get('thumbnailurl'),
                hasImage: !!this.model.get('thumbnailurl')
            };
        }
    });
});
define('Facets.FacetedNavigationItemCategory.View', [
    'SC.Configuration',
    'facets_faceted_navigation_item_category.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore'
], function (Configuration, facets_faceted_navigation_item_category_tpl, Backbone, BackboneCompositeView, _) {
    'use strict';
    return Backbone.View.extend({
        template: facets_faceted_navigation_item_category_tpl,
        events: { 'click [data-action="see-more"]': 'toggleSeeMoreLess' },
        initialize: function () {
            this.categories = this.model && (this.model.get('siblings') || this.model.get('categories')) || [];
            this.categoryUrl = this.options.categoryUrl;
            this.on('afterViewRender', this.renderCategories, this);
        },
        renderCategories: function () {
            this.$('[data-collapsed="true"]').hide();
        },
        toggleSeeMoreLess: function (event) {
            var target = this.$(event.currentTarget), target_see_more = target.find('[data-type="see-more"]'), target_see_less = target.find('[data-type="see-less"]'), target_was_expanded = !!target.data('collapsed');
            if (target_was_expanded) {
                target_see_more.show();
                target_see_less.hide();
            } else {
                target_see_more.hide();
                target_see_less.show();
            }
            target.data('collapsed', !target_was_expanded);
        },
        getContext: function () {
            var showFacet = this.categories.length, values = [], self = this, showMax = Configuration.get('categories.sideMenu.showMax'), uncollapsible = Configuration.get('categories.sideMenu.uncollapsible'), collapsed = Configuration.get('categories.sideMenu.collapsed');
            _.each(this.categories, function (category) {
                values.push({
                    displayName: category.name,
                    label: category.name,
                    link: category.fullurl,
                    isActive: category.fullurl === self.categoryUrl
                });
            });
            var max = showMax || values.length, displayValues = _.first(values, max), extraValues = _.rest(values, max);
            var breadcrumb = this.model && (this.model.get('breadcrumb') || []), parentName = '';
            if (breadcrumb && breadcrumb.length) {
                var index = breadcrumb.length > 1 ? breadcrumb.length - 2 : breadcrumb.length - 1;
                parentName = breadcrumb[index].name;
            }
            return {
                htmlId: _.uniqueId('commercecategory_'),
                facetId: 'commercecategory',
                showFacet: !!showFacet,
                values: values,
                displayValues: displayValues,
                extraValues: extraValues,
                showExtraValues: !!extraValues.length,
                isUncollapsible: !!uncollapsible,
                isCollapsed: !uncollapsible && collapsed,
                parentName: parentName
            };
        }
    });
});
define('Facets.Browse.View', [
    'SC.Configuration',
    'LiveOrder.Model',
    'Facets.Helper',
    'Categories',
    'Facets.FacetedNavigation.View',
    'Facets.FacetedNavigationItem.View',
    'Facets.FacetsDisplay.View',
    'Facets.FacetList.View',
    'Facets.ItemListDisplaySelector.View',
    'Facets.ItemListSortSelector.View',
    'Facets.ItemListShowSelector.View',
    'Facets.ItemCell.View',
    'Facets.Empty.View',
    'Facets.Browse.CategoryHeading.View',
    'Facets.CategoryCell.View',
    'Facets.FacetedNavigationItemCategory.View',
    'GlobalViews.Pagination.View',
    'Tracker',
    'facets_facet_browse.tpl',
    'facets_items_collection.tpl',
    'facets_items_collection_view_cell.tpl',
    'facets_items_collection_view_row.tpl',
    'Backbone',
    'Backbone.CollectionView',
    'Backbone.CompositeView',
    'underscore',
    'jQuery',
    'Bootstrap.Slider',
    'Utils'
], function (Configuration, LiveOrderModel, Helper, Categories, FacetsFacetedNavigationView, FacetsFacetedNavigationItemView, FacetsFacetsDisplayView, FacetsFacetListView, FacetsItemListDisplaySelectorView, FacetsItemListSortSelectorView, FacetsItemListShowSelectorView, FacetsItemCellView, FacetsEmptyView, FacetsBrowseCategoryHeadingView, FacetsCategoryCellView, FacetsFacetedNavigationItemCategoryView, GlobalViewsPaginationView, Tracker, facets_facet_browse_tpl, facets_items_collection_tpl, facets_items_collection_view_cell_tpl, facets_items_collection_view_row_tpl, Backbone, BackboneCollectionView, BackboneCompositeView, _, jQuery) {
    'use strict';
    var statuses = window.statuses = {}, collapsable_elements = window.collapsable_elements = {};
    return Backbone.View.extend({
        template: facets_facet_browse_tpl,
        description: _('This is a description').translate(),
        attributes: {
            'id': 'facet-browse',
            'class': 'view facet-browse'
        },
        events: {
            'click [data-toggle="facet-navigation"]': 'toggleFacetNavigation',
            'click [data-action="toggle-filters"]': 'toggleFilters'
        },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.statuses = statuses;
            this.collapsable_elements = collapsable_elements;
            this.translator = this.setOptionsTranslator(options.translator);
            this.application = options.application;
            this.cart = LiveOrderModel.getInstance();
            this.collapsable_elements['facet-header'] = this.collapsable_elements['facet-header'] || {
                selector: 'this.collapsable_elements["facet-header"]',
                collapsed: false
            };
        },
        toggleFilters: function (e) {
            e.preventDefault();
            var current_target = jQuery(e.currentTarget);
            this.collapsable_elements['facet-header'].collapsed = !this.collapsable_elements['facet-header'].collapsed;
            current_target.find('.filter-icon').toggleClass('icon-chevron-up');
            current_target.parents('[data-type="accordion"]').toggleClass('well').toggleClass('facet-header-white-well').find('[data-type="accordion-body"]').stop().slideToggle();
        },
        getPath: function () {
            var base_url = window.location.protocol + '//' + window.location.hostname;
            if (this.model.get('category')) {
                var category_canonical = this.model.get('category').get('canonical') || this.model.get('category').get('fullurl');
                return (category_canonical.indexOf('/') === 0 ? base_url : '') + category_canonical;
            } else {
                var canonical = base_url + '/' + Backbone.history.fragment, index_of_query = canonical.indexOf('?');
                return !~index_of_query ? canonical : canonical.substring(0, index_of_query);
            }
        },
        getCanonical: function () {
            var canonical_url = this.getPath(), current_page = this.translator.getOptionValue('page');
            if (current_page > 1) {
                canonical_url += '?page=' + current_page;
            }
            return canonical_url;
        },
        getRelPrev: function () {
            var previous_page_url = this.getPath(), current_page = this.translator.getOptionValue('page');
            if (current_page > 1) {
                if (current_page === 2) {
                    return previous_page_url;
                }
                if (current_page > 2) {
                    return previous_page_url += '?page=' + (current_page - 1);
                }
            }
            return null;
        },
        getRelNext: function () {
            var next_page_url = this.getPath(), current_page = this.translator.getOptionValue('page');
            if (current_page < this.totalPages) {
                return next_page_url += '?page=' + (current_page + 1);
            }
            return null;
        },
        formatFacetTitle: function (facet) {
            var defaults = {
                range: '$(2): $(0) to $(1)',
                multi: '$(1): $(0)',
                single: '$(1): $(0)'
            };
            if (!facet.config.titleToken) {
                facet.config.titleToken = defaults[facet.config.behavior] || defaults.single;
            }
            if (_.isFunction(facet.config.titleToken)) {
                return facet.config.titleToken(facet);
            } else if (facet.config.behavior === 'range') {
                return _(facet.config.titleToken).translate(facet.value.to, facet.value.from, facet.config.name);
            } else if (facet.config.behavior === 'multi') {
                var buffer = [];
                _.each(facet.value, function (val) {
                    buffer.push(val);
                });
                return _(facet.config.titleToken).translate(buffer.join(', '), facet.config.name);
            } else {
                var value = this.translator.getLabelForValue(facet.config.id, facet.value);
                return _(facet.config.titleToken).translate(value, facet.config.name);
            }
        },
        getTitle: function () {
            var facets = this.options.translator.facets, category = this.model.get('category'), title = category ? category.get('pagetitle') || _.pluck(this.getBreadcrumbPages(), 'text').join(' > ') : this.title;
            if (facets && facets.length) {
                var buffer = [], facet = null;
                for (var i = 0; i < facets.length; i++) {
                    facet = facets[i];
                    buffer.push(this.formatFacetTitle(facet));
                    if (i < facets.length - 1) {
                        buffer.push(facet.config.titleSeparator || ', ');
                    }
                }
                title = title ? title + ' - ' : '';
                title = this.application.getConfig('searchTitlePrefix', '') + buffer.join('') + this.application.getConfig('searchTitleSuffix', '');
            } else if (this.translator.getOptionValue('keywords')) {
                title = _('Search results for "$(0)"').translate(this.translator.getOptionValue('keywords'));
            } else {
                title = title || this.application.getConfig('defaultSearchTitle', '');
            }
            this.setMetaTwitterTitle(title);
            return title;
        },
        getMetaDescription: function () {
            var category = this.model.get('category');
            return category && category.get('metadescription') || this.metaDescription;
        },
        getMetaKeywords: function () {
            var category = this.model.get('category');
            return category && category.get('metakeywords') || this.metaKeywords;
        },
        getAddToHead: function () {
            var category = this.model.get('category');
            return category && category.get('addtohead') || this.addToHead;
        },
        setMetaTwitterTitle: function (title) {
            var seo_twitter_title = jQuery('meta[name="twitter:title"]');
            seo_twitter_title && seo_twitter_title.attr('content', title);
        },
        setOptionsTranslator: function (translator) {
            if (translator.options.display === 'grid' && _.isPhoneDevice()) {
                translator.options.display = 'table';
            }
            return translator;
        },
        showContent: function () {
            var self = this, keywords = this.translator.getOptionValue('keywords'), resultCount = this.model.get('total');
            if (keywords) {
                keywords = decodeURIComponent(keywords);
                if (resultCount > 0) {
                    this.subtitle = resultCount > 1 ? _('Results for "$(0)"').translate(keywords) : _('Result for "$(0)"').translate(keywords);
                } else {
                    this.subtitle = _('We couldn\'t find any items that match "$(0)"').translate(keywords);
                }
            }
            this.totalPages = Math.ceil(resultCount / this.translator.getOptionValue('show'));
            this.application.getLayout().showContent(this).done(function () {
                if (jQuery.fn.scPush) {
                    self.$el.find('[data-action="pushable"]').scPush({ target: 'tablet' });
                }
                Tracker.getInstance().trackEvent({
                    category: 'SearchItem-end',
                    action: 'render',
                    value: 1
                });
            });
        },
        render: function () {
            Tracker.getInstance().trackProductList(this.model.get('items'));
            this._render();
        },
        getBreadcrumbPages: function () {
            var breadcrumb = [];
            if (this.model.get('category')) {
                var list = this.model.get('category').get('breadcrumb');
                _.each(list, function (bread) {
                    breadcrumb.push({
                        'text': bread.name,
                        'href': bread.fullurl
                    });
                });
                return breadcrumb;
            } else if (this.translator.getOptionValue('keywords')) {
                breadcrumb.push({
                    href: '#',
                    text: _('Search Results').translate()
                });
            } else {
                breadcrumb.push({
                    href: '#',
                    text: _('Shop').translate()
                });
            }
            return breadcrumb;
        },
        toggleFacetNavigation: function () {
            this.$el.toggleClass('narrow-by');
            this.toggleNavigationListener(this.$el.hasClass('narrow-by'));
        },
        toggleNavigationListener: function (isOn) {
            var self = this, touch_started = null;
            if (isOn) {
                jQuery('html').on('touchstart.narrow-by', function () {
                    touch_started = new Date().getTime();
                }).on('touchend.narrow-by mousedown.narrow-by', function (e) {
                    if (!touch_started || new Date().getTime() - touch_started < 200) {
                        var $target = jQuery(e.target);
                        if (!$target.closest('[data-toggle="facet-navigation"]').length && !$target.closest('#faceted-navigation').length) {
                            self.toggleFacetNavigation();
                        }
                    }
                });
            } else {
                jQuery('html').off('mousedown.narrow-by touchstart.narrow-by touchend.narrow-by');
            }
        },
        contextData: {
            'itemList': function () {
                return this.model.get('items');
            },
            'category': function () {
                return this.model.get('category');
            }
        },
        childViews: {
            'Facets.FacetedNavigation': function (options) {
                var exclude = _.map((options.excludeFacets || '').split(','), function (facet_id_to_exclude) {
                        return jQuery.trim(facet_id_to_exclude);
                    }), has_categories = !!(this.category && this.category.categories), has_items = this.model.get('items').length, has_facets = has_items && this.model.get('facets').length, applied_facets = this.translator.cloneWithoutFacetId('category').facets, has_applied_facets = applied_facets.length;
                return new FacetsFacetedNavigationView({
                    categoryItemId: this.category && this.category.itemid,
                    clearAllFacetsLink: this.translator.cloneWithoutFacets().getUrl(),
                    hasCategories: has_categories,
                    hasItems: has_items,
                    hasFacets: has_facets,
                    hasCategoriesAndFacets: has_categories && has_facets,
                    appliedFacets: applied_facets,
                    hasFacetsOrAppliedFacets: has_facets || has_applied_facets,
                    translator: this.translator,
                    facets: _.filter(this.model.get('facets'), function (facet) {
                        return !_.contains(exclude, facet.id);
                    }),
                    totalProducts: this.model.get('total'),
                    keywords: this.translator.getOptionValue('keywords')
                });
            },
            'Facets.FacetsDisplay': function () {
                var facets = this.translator.cloneWithoutFacetId('category').getAllFacets().sort(function (a, b) {
                    return b.config.priority - a.config.priority;
                });
                return new FacetsFacetsDisplayView({
                    facets: facets,
                    translator: this.translator
                });
            },
            'Facets.ItemListDisplaySelector': function () {
                return new FacetsItemListDisplaySelectorView({
                    configClasses: 'pull-right',
                    options: this.options.application.getConfig('itemsDisplayOptions'),
                    translator: this.translator
                });
            },
            'Facets.ItemListSortSelector': function () {
                return new FacetsItemListSortSelectorView({
                    options: this.options.application.getConfig('sortOptions'),
                    translator: this.translator
                });
            },
            'Facets.ItemListShowSelector': function () {
                return new FacetsItemListShowSelectorView({
                    options: this.options.application.getConfig('resultsPerPage'),
                    translator: this.translator
                });
            },
            'Facets.FacetedNavigation.Item': function (options) {
                var facet_config = this.translator.getFacetConfig(options.facetId), contructor_options = {
                        model: new Backbone.Model(_.findWhere(this.model.get('facets'), { id: options.facetId })),
                        translator: this.translator
                    };
                if (facet_config.template) {
                    contructor_options.template = facet_config.template;
                }
                return new FacetsFacetedNavigationItemView(contructor_options);
            },
            'Facets.Items': function () {
                var self = this, display_option = _.find(this.options.application.getConfig('itemsDisplayOptions'), function (option) {
                        return option.id === self.options.translator.getOptionValue('display');
                    });
                return new BackboneCollectionView({
                    childTemplate: display_option.template,
                    childView: FacetsItemCellView,
                    childViewOptions: { application: this.application },
                    viewsPerRow: parseInt(display_option.columns, 10),
                    collection: this.model.get('items'),
                    cellTemplate: facets_items_collection_view_cell_tpl,
                    rowTemplate: facets_items_collection_view_row_tpl,
                    template: facets_items_collection_tpl,
                    context: { keywords: this.translator.getOptionValue('keywords') }
                });
            },
            'Facets.Items.Empty': function () {
                return new FacetsEmptyView({ keywords: this.translator.getOptionValue('keywords') });
            },
            'GlobalViews.Pagination': function () {
                var translator = this.translator;
                return new GlobalViewsPaginationView(_.extend({
                    currentPage: translator.getOptionValue('page'),
                    totalPages: this.totalPages,
                    pager: function (page) {
                        return translator.cloneForOption('page', page).getUrl();
                    }
                }, Configuration.defaultPaginationSettings));
            },
            'Facets.Browse.CategoryHeading': function () {
                return new FacetsBrowseCategoryHeadingView({
                    model: this.model.get('category'),
                    showDescription: this.translator.cloneWithoutFacetId('category').getAllFacets().length === 0
                });
            },
            'Facets.CategoryCells': function () {
                return new BackboneCollectionView({
                    childView: FacetsCategoryCellView,
                    collection: this.model.get('category') ? this.model.get('category').get('categories') : []
                });
            },
            'Facets.CategorySidebar': function () {
                return new FacetsFacetedNavigationItemCategoryView({
                    model: this.model.get('category'),
                    categoryUrl: this.translator.getCategoryUrl()
                });
            }
        },
        getContext: function () {
            var hasSelectedFacets = this.translator.cloneWithoutFacetId('category').getAllFacets().length, hasSubcategories = this.model.get('category') ? this.model.get('category').get('categories').length : false, hasItems = _.result(this.model.get('items'), 'length', 0);
            return {
                total: this.model.get('total'),
                isTotalProductsOne: this.model.get('total') === 1,
                title: this.getTitle(),
                hasItemsAndFacets: !!(hasItems && this.model.get('facets').length),
                collapseHeader: !!this.collapsable_elements['facet-header'].collapsed,
                keywords: this.translator.getOptionValue('keywords'),
                showResults: _.isNull(this.translator.getOptionValue('keywords')) ? true : this.model.get('total') > 0,
                isEmptyList: this.model.get('total') <= 0,
                isCategory: !!this.model.get('category'),
                showItems: hasItems || !hasItems && hasSelectedFacets || !(!hasItems && !hasSelectedFacets && hasSubcategories)
            };
        }
    });
});
define('Categories.Model', [
    'Backbone.CachedModel',
    'underscore',
    'Utils'
], function (BackboneCachedModel, _, Utils) {
    'use strict';
    var original_fetch = BackboneCachedModel.prototype.fetch;
    return BackboneCachedModel.extend({
        url: Utils.getAbsoluteUrl('services/Categories.Service.ss'),
        options: {},
        initialize: function () {
        },
        fetch: function (options) {
            options = _.extend(options || {}, this.options);
            options.cache = true;
            return original_fetch.apply(this, arguments);
        }
    });
});
define('Facets.Router', [
    'Facets.Browse.View',
    'Facets.Helper',
    'Facets.Model',
    'Categories',
    'Categories.Model',
    'AjaxRequestsKiller',
    'Profile.Model',
    'underscore',
    'Backbone',
    'jQuery',
    'SC.Configuration'
], function (BrowseView, Helper, Model, Categories, CategoriesModel, AjaxRequestsKiller, ProfileModel, _, Backbone, jQuery, Configuration) {
    'use strict';
    return Backbone.Router.extend({
        initialize: function (application) {
            this.application = application;
            this.translatorConfig = application.translatorConfig;
        },
        addUrl: function (urls, functionToCall) {
            if (urls.length) {
                urls = _.map(urls, function (url) {
                    return url.replace(/^\//, '');
                });
                var rootRegex = '^\\b(' + urls.join('|') + ')\\b$', regex = '^\\b(' + urls.join('|') + ')\\b[\\' + Configuration.get('facetDelimiters.betweenFacetNameAndValue') + '\\?].*$';
                this.route(new RegExp(rootRegex), functionToCall);
                this.route(new RegExp(regex), functionToCall);
            }
        },
        getFacetsAliasesMapping: function (corrections) {
            var facets_aliases_mapping = {};
            _.each(corrections, function (correction) {
                facets_aliases_mapping[correction.usedAlias] = {
                    url: correction.url,
                    type: correction.type ? correction.type : ''
                };
            });
            return facets_aliases_mapping;
        },
        unaliasUrlHelper: function (facet_tokens, facets_aliases_mapping, separator_between_facets, separator_between_facet_name_and_value) {
            var translated_facets = '';
            while (facet_tokens.length > 0) {
                var facet_name = facet_tokens.shift(), facet_value = facet_tokens.shift();
                if (_.isUndefined(facet_name) || _.isUndefined(facet_value)) {
                    continue;
                }
                var facet_name_correction = facets_aliases_mapping[facet_name], facet_value_correction = facets_aliases_mapping[facet_value], facet_name_correction_url = facet_name_correction && facet_name_correction.type.toUpperCase() === 'FACET' ? facet_name_correction.url : null, facet_value_correction_url = facet_value_correction && facet_value_correction.type.toUpperCase() === 'FACET_VALUE' ? facet_value_correction.url : null;
                if (facet_name_correction_url && facet_value_correction_url) {
                    translated_facets += facet_name_correction_url + separator_between_facet_name_and_value + facet_value_correction_url;
                } else if (facet_name_correction_url && !facet_value_correction_url) {
                    translated_facets += facet_name_correction_url + separator_between_facet_name_and_value + facet_value;
                } else if (!facet_name_correction_url && facet_value_correction_url) {
                    translated_facets += facet_name + separator_between_facet_name_and_value + facet_value_correction_url;
                } else {
                    translated_facets += facet_name + separator_between_facet_name_and_value + facet_value;
                }
                if (facet_tokens.length > 0) {
                    translated_facets += separator_between_facets;
                }
            }
            return translated_facets;
        },
        unaliasUrl: function (aliased_url, corrections) {
            if (aliased_url.indexOf('http://') === 0 || aliased_url.indexOf('https://') === 0) {
                throw new Error('URL must be relative');
            }
            aliased_url = aliased_url[0] === '/' ? aliased_url.substr(1) : aliased_url;
            var facet_delimiters = this.translatorConfig.facetDelimiters, facets_n_options = aliased_url.split(facet_delimiters.betweenFacetsAndOptions), facets = facets_n_options[0] && facets_n_options[0] !== this.translatorConfig.fallbackUrl ? facets_n_options[0] : '', options = facets_n_options[1] || '', facet_tokens = facets.split(new RegExp('[\\' + facet_delimiters.betweenDifferentFacets + '\\' + facet_delimiters.betweenFacetNameAndValue + ']+', 'ig')), facets_aliases_mapping = this.getFacetsAliasesMapping(corrections), unaliased_url = this.unaliasUrlHelper(facet_tokens, facets_aliases_mapping, facet_delimiters.betweenDifferentFacets, facet_delimiters.betweenFacetNameAndValue);
            if (options) {
                var option_tokens = [];
                options.replace(new RegExp('([^' + facet_delimiters.betweenFacetsAndOptions + facet_delimiters.betweenOptionNameAndValue + facet_delimiters.betweenDifferentOptions + ']+)(' + facet_delimiters.betweenOptionNameAndValue + '([^' + facet_delimiters.betweenDifferentOptions + ']*))?', 'ig'), function ($0, $1, $2, $3) {
                    option_tokens.push($1);
                    option_tokens.push($3);
                });
                var unaliased_options = this.unaliasUrlHelper(option_tokens, facets_aliases_mapping, facet_delimiters.betweenDifferentOptions, facet_delimiters.betweenOptionNameAndValue);
                unaliased_url = unaliased_url !== '' ? unaliased_url : this.translatorConfig.fallbackUrl;
                unaliased_url += facet_delimiters.betweenFacetsAndOptions + unaliased_options;
            }
            return unaliased_url;
        },
        showPage: function (isCategoryPage) {
            var self = this, facetModel = new Model(), fullurl = Backbone.history.fragment, models = [facetModel], translator = Helper.parseUrl(fullurl, this.translatorConfig, isCategoryPage);
            facetModel.options = {
                data: translator.getApiParams(),
                killerId: AjaxRequestsKiller.getKillerId(),
                pageGeneratorPreload: true
            };
            if (ProfileModel.getInstance().hidePrices()) {
                translator = translator.cloneWithoutFacetId('onlinecustomerprice');
                Backbone.history.navigate(translator.getUrl());
            }
            if (isCategoryPage) {
                var categoryModel = new CategoriesModel();
                categoryModel.options = {
                    data: { 'fullurl': translator.getCategoryUrl() },
                    killerId: AjaxRequestsKiller.getKillerId()
                };
                facetModel.set('category', categoryModel);
                models.push(categoryModel);
            }
            jQuery.when.apply(null, _.invoke(models, 'fetch', {})).then(function (facetResponse) {
                facetResponse = isCategoryPage ? facetResponse[0] : facetResponse;
                if (facetResponse.corrections && facetResponse.corrections.length > 0) {
                    var unaliased_url = self.unaliasUrl(fullurl, facetResponse.corrections);
                    if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                        nsglobal.statusCode = 301;
                        nsglobal.location = '/' + unaliased_url;
                    } else {
                        Backbone.history.navigate('#' + unaliased_url, { trigger: true });
                    }
                } else {
                    var view = new BrowseView({
                        translator: translator,
                        translatorConfig: self.translatorConfig,
                        application: self.application,
                        model: facetModel
                    });
                    translator.setLabelsFromFacets(facetModel.get('facets') || []);
                    view.showContent();
                }
            });
        },
        categoryLoading: function () {
            this.showPage(true);
        },
        facetLoading: function () {
            this.showPage();
        }
    });
});
define('Facets', [
    'Facets.Translator',
    'Facets.Model',
    'Facets.Router',
    'Categories',
    'underscore',
    'Utils',
    'facets_item_cell_grid.tpl',
    'facets_item_cell_table.tpl',
    'facets_item_cell_list.tpl',
    'facets_faceted_navigation_item.tpl',
    'facets_faceted_navigation_item_color.tpl',
    'facets_faceted_navigation_item_range.tpl'
], function (Translator, Model, Router, Categories, _, Utils) {
    'use strict';
    function prepareRouter(application, router) {
        var facets_to_include = new Translator().getFacetsToInclude();
        var components = _.compact(_.union([application.translatorConfig.fallbackUrl], facets_to_include || []));
        router.addUrl(components, 'facetLoading');
        var categoriesTopLevelUrl = Categories.getTopLevelCategoriesUrlComponent();
        router.addUrl(categoriesTopLevelUrl, 'categoryLoading');
    }
    function setTranslatorConfig(application) {
        application.translatorConfig = {
            fallbackUrl: application.getConfig('defaultSearchUrl'),
            defaultShow: _.result(_.find(application.getConfig('resultsPerPage'), function (show) {
                return show.isDefault;
            }) || application.getConfig('resultsPerPage')[0], 'items'),
            defaultOrder: _.result(_.find(application.getConfig('sortOptions'), function (sort) {
                return sort.isDefault;
            }) || application.getConfig('sortOptions')[0], 'id'),
            defaultDisplay: _.result(_.find(application.getConfig('itemsDisplayOptions'), function (display) {
                return display.isDefault;
            }) || application.getConfig('itemsDisplayOptions')[0], 'id'),
            facets: application.getConfig('facets'),
            facetsAsUrlParameters: application.getConfig('facetsAsUrlParameters'),
            facetDelimiters: application.getConfig('facetDelimiters'),
            facetsSeoLimits: application.getConfig('facetsSeoLimits')
        };
    }
    function prepareItemDisplayOptions(application) {
        if (!Utils.isPageGenerator()) {
            var screenType = Utils.getDeviceType();
            if (screenType === 'phone') {
                application.Configuration.itemsDisplayOptions = application.Configuration.itemsDisplayOptionsPhone;
                application.Configuration.sortOptions = application.Configuration.sortOptionsPhone;
                application.Configuration.defaultPaginationSettings = application.Configuration.defaultPaginationSettingsPhone;
            } else if (screenType === 'tablet') {
                application.Configuration.itemsDisplayOptions = application.Configuration.itemsDisplayOptionsTablet;
                application.Configuration.sortOptions = application.Configuration.sortOptionsTablet;
                application.Configuration.defaultPaginationSettings = application.Configuration.defaultPaginationSettingsTablet;
            }
        }
    }
    return {
        Translator: Translator,
        Model: Model,
        Router: Router,
        setTranslatorConfig: setTranslatorConfig,
        prepareRouter: prepareRouter,
        facetConfigParsers: {
            currency: function (value) {
                return Utils.formatCurrency(value);
            },
            quantity: function (value) {
                return Utils.formatQuantity(value);
            },
            'default': function (value) {
                return value;
            }
        },
        mountToApp: function (application) {
            application.Configuration.facets = application.Configuration.facets || [];
            prepareItemDisplayOptions(application);
            var facets = application.Configuration.get('facets');
            facets = _.sortBy(facets, function (facet1, facet2) {
                return facet1.priority > facet2.priority ? 0 : 1;
            });
            _.each(facets, function (facet) {
                facet.colors = application.getLayout().getColorPalette(facet.colors);
            });
            setTranslatorConfig(application);
            var routerInstance = new Router(application);
            prepareRouter(application, routerInstance);
            var self = this;
            _.each(application.Configuration.get('facets'), function (facet) {
                if (facet.parser) {
                    facet.parser = self.facetConfigParsers[facet.parser];
                }
                if (!facet.parser) {
                    facet.parser = self.facetConfigParsers['default'];
                }
            });
            return routerInstance;
        }
    };
});
(function (win, name) {
    'use strict';
    win.GoogleAnalyticsObject = name;
    win[name] = win[name] || function () {
        (win[name].q = win[name].q || []).push(arguments);
    };
    win[name].l = 1 * new Date();
    define('GoogleUniversalAnalytics', [
        'Tracker',
        'underscore',
        'jQuery',
        'Backbone',
        'Utils',
        'SC.Configuration'
    ], function (Tracker, _, jQuery, Backbone, Utils, Configuration) {
        var GoogleUniversalAnalytics = {
            doCallback: function () {
                return !win[name].q;
            },
            trackPageview: function (url) {
                if (_.isString(url)) {
                    win[name]('send', 'pageview', url);
                }
                return this;
            },
            trackEvent: function (event) {
                if (event && event.category && event.action) {
                    win[name]('send', 'event', event.category, event.action, event.label, parseFloat(event.value) || 0, {
                        'hitCallback': event.callback,
                        'page': event.page || '/' + Backbone.history.fragment
                    });
                }
                return this;
            },
            addItem: function (item) {
                if (item && item.id && item.name) {
                    win[name]('ecommerce:addItem', item);
                }
                return this;
            },
            addTrans: function (transaction) {
                if (transaction && transaction.id) {
                    win[name]('ecommerce:addTransaction', transaction);
                }
                return this;
            },
            trackTrans: function () {
                win[name]('ecommerce:send');
                return this;
            },
            trackTransaction: function (transaction) {
                var transaction_id = transaction.get('confirmationNumber');
                GoogleUniversalAnalytics.addTrans({
                    id: transaction_id,
                    revenue: transaction.get('subTotal'),
                    shipping: transaction.get('shippingCost') + transaction.get('handlingCost'),
                    tax: transaction.get('taxTotal'),
                    currency: SC.ENVIRONMENT.currentCurrency && SC.ENVIRONMENT.currentCurrency.code || '',
                    page: '/' + Backbone.history.fragment
                });
                transaction.get('products').each(function (product) {
                    GoogleUniversalAnalytics.addItem({
                        id: transaction_id,
                        affiliation: Configuration.get('siteSettings.displayname'),
                        sku: product.get('sku'),
                        name: product.get('name'),
                        category: product.get('category') || '',
                        price: product.get('rate'),
                        quantity: product.get('quantity')
                    });
                });
                return GoogleUniversalAnalytics.trackTrans();
            },
            setAccount: function (config) {
                if (!config) {
                    return this;
                }
                var domainName = Utils.isCheckoutDomain() ? config.domainNameSecure : config.domainName;
                if (_.isString(config.propertyID) && _.isString(domainName)) {
                    this.propertyID = config.propertyID;
                    this.domainName = domainName;
                    win[name]('create', this.propertyID, {
                        'cookieDomain': this.domainName,
                        'allowLinker': true
                    });
                }
                return this;
            },
            addCrossDomainParameters: function (url) {
                if (_.isString(url) && !~url.indexOf(this.domainName)) {
                    win[name](function (tracker) {
                        win.linker = win.linker || new win.gaplugins.Linker(tracker);
                        var track_url = win.linker.decorate(url);
                        if (typeof track_url === 'string') {
                            url = track_url;
                        }
                    });
                }
                return url;
            },
            loadScript: function () {
                return SC.ENVIRONMENT.jsEnvironment === 'browser' && jQuery.getScript('//www.google-analytics.com/analytics.js');
            },
            mountToApp: function (application) {
                var tracking = application.getConfig('tracking.googleUniversalAnalytics');
                if (tracking && tracking.propertyID) {
                    GoogleUniversalAnalytics.setAccount(tracking);
                    Tracker.getInstance().trackers.push(GoogleUniversalAnalytics);
                    application.getLayout().once('afterAppendView', jQuery.proxy(GoogleUniversalAnalytics, 'loadScript'));
                    win[name]('require', 'ecommerce', 'ecommerce.js');
                }
            }
        };
        return GoogleUniversalAnalytics;
    });
}(window, 'ga'));
define('GoogleTagManager.NavigationHelper.Plugins.Standard', [
    'Tracker',
    'jQuery',
    'Backbone'
], function (Tracker, jQuery, Backbone) {
    'use strict';
    var trackerPlugins = {
        mouseDownNavigation: function (layout, e) {
            var $item = jQuery(e.currentTarget).closest('[itemprop="itemListElement"]');
            if ($item.length) {
                var category = $item.data('track-productlist-category');
                if (category) {
                    var item = {
                        category: category,
                        position: $item.data('track-productlist-position'),
                        list: $item.data('track-productlist-list'),
                        sku: $item.data('sku'),
                        itemId: $item.data('item-id'),
                        name: $item.find('[itemprop="name"]').text()
                    };
                    Tracker.getInstance().trackProductClick(new Backbone.Model(item));
                }
            }
            return e;
        }
    };
    return trackerPlugins;
});
define('GoogleTagManager', [
    'Tracker',
    'GoogleTagManager.NavigationHelper.Plugins.Standard',
    'underscore',
    'jQuery',
    'Backbone',
    'SC.Configuration'
], function (Tracker, GoogleTagManagerNavigationHelper, _, jQuery, Backbone, Configuration) {
    'use strict';
    var win = window, GoogleTagManager = {
            doCallback: function () {
                return !!win.google_tag_manager;
            },
            trackPageview: function (url) {
                if (_.isString(url)) {
                    var eventName = 'pageView', eventData = {
                            'event': eventName,
                            'data': { 'page': url }
                        };
                    Tracker.trigger(eventName, eventData, url);
                    this.pushData(eventData);
                }
                return this;
            },
            trackEvent: function (event) {
                if (event && event.category && event.action) {
                    var eventName = 'action', eventData = {
                            'event': eventName,
                            'data': {
                                'category': event.category,
                                'action': event.action,
                                'label': event.label,
                                'value': parseFloat(event.value) || 0,
                                'page': event.page || '/' + Backbone.history.fragment
                            },
                            'eventCallback': event.callback
                        };
                    Tracker.trigger(eventName, eventData, event);
                    this.pushData(eventData);
                }
                return this;
            },
            trackGenericEvent: function () {
                var eventName = 'genericEvent', eventData = {
                        'event': eventName,
                        'data': {}
                    };
                Tracker.trigger(eventName, eventData, arguments);
                this.pushData(eventData);
                return this;
            },
            trackAddToCart: function (line) {
                if (line) {
                    var eventName = 'addToCart', eventData = {
                            'event': eventName,
                            'data': {}
                        };
                    Tracker.trigger(eventName, eventData, line);
                    this.pushData(eventData);
                }
                return this;
            },
            trackTransaction: function (transaction) {
                var eventName = 'transaction', eventData = {
                        'event': eventName,
                        'data': {
                            'transactionId': transaction.get('confirmationNumber'),
                            'transactionAffiliation': Configuration.get('siteSettings.displayname'),
                            'transactionSubTotal': transaction.get('subTotal'),
                            'transactionTotal': transaction.get('total'),
                            'transactionTax': transaction.get('taxTotal'),
                            'transactionShipping': transaction.get('shippingCost') + transaction.get('handlingCost'),
                            'transactionCurrency': SC.ENVIRONMENT.currentCurrency && SC.ENVIRONMENT.currentCurrency.code || 'USD',
                            'transactionProducts': []
                        }
                    };
                transaction.get('products').each(function (product) {
                    eventData.data.transactionProducts.push({
                        'sku': product.get('sku'),
                        'name': product.get('name'),
                        'category': product.get('category') || '',
                        'price': product.get('rate'),
                        'quantity': product.get('quantity'),
                        'variant': product.get('options')
                    });
                });
                Tracker.trigger(eventName, eventData, transaction);
                this.pushData(eventData);
                return this;
            },
            trackProductList: function (items, listName) {
                var self = this, eventName = 'productList', eventData = {
                        'event': eventName,
                        'data': {
                            'currencyCode': SC.ENVIRONMENT.currentCurrency && SC.ENVIRONMENT.currentCurrency.code || 'USD',
                            'items': [],
                            'page': this.getCategory(),
                            'list': listName
                        }
                    };
                _.each(items.models, function (item, index) {
                    item.set('track_productlist_position', index + 1);
                    item.set('track_productlist_category', self.getCategory());
                    item.set('track_productlist_list', listName);
                    eventData.data.items.push({
                        'name': item.get('_name'),
                        'sku': item.get('_sku', true),
                        'price': item.get('_price') && item.get('_price').toFixed(2) || 0,
                        'list': item.get('track_productlist_list'),
                        'position': item.get('track_productlist_position'),
                        'category': item.get('track_productlist_category')
                    });
                });
                Tracker.trigger(eventName, eventData, items);
                this.pushData(eventData);
                return this;
            },
            trackProductClick: function (item) {
                var eventName = 'productClick', eventData = {
                        'event': eventName,
                        'data': {
                            'category': item.get('category'),
                            'position': item.get('position'),
                            'list': item.get('list'),
                            'sku': item.get('sku', true),
                            'name': item.get('name'),
                            'page': this.getCategory(),
                            'label': item.get('name')
                        }
                    };
                this.item = item;
                Tracker.trigger(eventName, eventData, item);
                this.pushData(eventData);
                return this;
            },
            trackProductView: function (product) {
                var item = product.getItem();
                if (this.item && this.item.get('itemId') === item.get('_id')) {
                    item.set('category', this.item.get('category'), { silent: true });
                    item.set('list', this.item.get('list'), { silent: true });
                }
                var eventName = 'productView', selected_options = product.get('options').filter(function (option) {
                        return option.get('value') && option.get('value').label;
                    }), price = product.getPrice(), eventData = {
                        'event': eventName,
                        'data': {
                            'sku': product.getSku(),
                            'name': item.get('_name'),
                            'variant': _.map(selected_options, function (option) {
                                return option.get('value').label;
                            }).join(', '),
                            'price': (price.price ? price.price : 0).toFixed(2),
                            'category': item.get('category') || '',
                            'list': item.get('list') || '',
                            'page': this.getCategory()
                        }
                    };
                this.item = null;
                Tracker.trigger(eventName, eventData, item);
                this.pushData(eventData);
                return this;
            },
            pushData: function (data) {
                win[this.configuration.dataLayerName].push({
                    'event': undefined,
                    'data': undefined,
                    'eventCallback': undefined
                });
                win[this.configuration.dataLayerName].push(data);
            },
            getCategory: function () {
                var options = _.parseUrlOptions(Backbone.history.fragment), page = options.page || '';
                return '/' + Backbone.history.fragment.split('?')[0] + (page ? '?page=' + page : '');
            },
            loadScript: function () {
                return !SC.isPageGenerator() && jQuery.getScript('//www.googletagmanager.com/gtm.js?id=' + this.configuration.id + '&l=' + this.configuration.dataLayerName);
            },
            mountToApp: function (application) {
                this.configuration = Configuration.get('tracking.googleTagManager');
                if (this.configuration && this.configuration.id) {
                    var layout = application.getLayout();
                    layout.mouseDown.install({
                        name: 'googleTagManagerStandardNavigation',
                        priority: 20,
                        execute: function (e) {
                            return GoogleTagManagerNavigationHelper.mouseDownNavigation(layout, e);
                        }
                    });
                    this.configuration.dataLayerName = this.configuration.dataLayerName || 'dataLayer';
                    win[this.configuration.dataLayerName] = win[this.configuration.dataLayerName] || [];
                    win[this.configuration.dataLayerName].push({
                        'gtm.start': new Date().getTime(),
                        'event': 'gtm.js'
                    });
                    Tracker.getInstance().trackers.push(GoogleTagManager);
                    application.getLayout().once('afterAppendView', jQuery.proxy(GoogleTagManager, 'loadScript'));
                }
            }
        };
    return GoogleTagManager;
});
define('Home.View', [
    'SC.Configuration',
    'Utilities.ResizeImage',
    'home.tpl',
    'Backbone',
    'jQuery',
    'underscore',
    'Utils'
], function (Configuration, resizeImage, home_tpl, Backbone, jQuery, _, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: home_tpl,
        title: _('Welcome to the store').translate(),
        page_header: _('Welcome to the store').translate(),
        attributes: {
            'id': 'home-page',
            'class': 'home-page'
        },
        events: { 'click [data-action=slide-carousel]': 'carouselSlide' },
        initialize: function () {
            var self = this;
            this.windowWidth = jQuery(window).width();
            this.on('afterViewRender', function () {
                _.initBxSlider(self.$('[data-slider]'), {
                    nextText: '<a class="home-gallery-next-icon"></a>',
                    prevText: '<a class="home-gallery-prev-icon"></a>'
                });
            });
            var windowResizeHandler = _.throttle(function () {
                if (_.getDeviceType(this.windowWidth) === _.getDeviceType(jQuery(window).width())) {
                    return;
                }
                this.showContent();
                _.resetViewportWidth();
                this.windowWidth = jQuery(window).width();
            }, 1000);
            this._windowResizeHandler = _.bind(windowResizeHandler, this);
            jQuery(window).on('resize', this._windowResizeHandler);
        },
        destroy: function () {
            Backbone.View.prototype.destroy.apply(this, arguments);
            jQuery(window).off('resize', this._windowResizeHandler);
        },
        getContext: function () {
            var carouselImages = _.map(Configuration.get('home.carouselImages', []), function (url) {
                return Utils.getAbsoluteUrlOfNonManagedResources(url);
            });
            var bottomBannerImages = _.map(Configuration.get('home.bottomBannerImages', []), function (url) {
                return Utils.getAbsoluteUrlOfNonManagedResources(url);
            });
            return {
                imageHomeSize: Utils.getViewportWidth() < 768 ? 'homeslider' : 'main',
                imageHomeSizeBottom: Utils.getViewportWidth() < 768 ? 'homecell' : 'main',
                carouselImages: carouselImages,
                bottomBannerImages: bottomBannerImages
            };
        }
    });
});
define('Home.Router', [
    'Home.View',
    'Backbone'
], function (HomeView, Backbone) {
    'use strict';
    return Backbone.Router.extend({
        routes: {
            '': 'homePage',
            '?*params': 'homePage'
        },
        initialize: function (Application) {
            this.application = Application;
        },
        homePage: function () {
            var view = new HomeView({ application: this.application });
            view.showContent();
        }
    });
});
define('Home', ['Home.Router'], function (HomeRouter) {
    'use strict';
    return {
        mountToApp: function (application) {
            return new HomeRouter(application);
        }
    };
});
define('PromocodeSupport', [
    'UrlHelper',
    'LiveOrder.Model',
    'Backbone'
], function (UrlHelper, LiveOrderModel, Backbone) {
    'use strict';
    return {
        mountToApp: function () {
            UrlHelper.addTokenListener('promocode', function (value) {
                value = unescape(value.replace(/[+]/g, ' '));
                var liveorder = LiveOrderModel.getInstance(), promocodes = liveorder.get('promocodes') || [], new_promocodes = promocodes.concat({ code: value }), url;
                liveorder.save({ promocodes: new_promocodes }).always(function savePromocodeEnded() {
                    liveorder.trigger('promocodeUpdated', 'applied');
                });
                url = Backbone.history.fragment.replace('&promocode=' + value, '').replace('?promocode=' + value, '');
                Backbone.history.navigate(url, {
                    trigger: false,
                    replace: true
                });
                return false;
            });
        }
    };
});
define('ItemRelations', [
    'ItemRelations.Related.View',
    'ItemRelations.Correlated.View',
    'Cart.Detailed.View'
], function (ItemRelationsRelatedView, ItemRelationsCorrelatedView, CartDetailedView) {
    'use strict';
    return {
        mountToApp: function (application) {
            CartDetailedView.addChildViews({
                'Correlated.Items': function wrapperFunction(options) {
                    return function () {
                        return new ItemRelationsCorrelatedView({
                            itemsIds: options.model.getItemsIds(),
                            application: application
                        });
                    };
                },
                'Related.Items': function wrapperFunction(options) {
                    return function () {
                        return new ItemRelationsRelatedView({
                            itemsIds: options.model.getItemsIds(),
                            application: application
                        });
                    };
                }
            });
        }
    };
});
define('RecentlyViewedItems.View', [
    'Backbone.CollectionView',
    'ItemRelations.RelatedItem.View',
    'RecentlyViewedItems.Collection',
    'SC.Configuration',
    'Tracker',
    'recently_viewed_items.tpl',
    'recently_viewed_row.tpl',
    'recently_viewed_cell.tpl',
    'jQuery',
    'Backbone',
    'underscore',
    'Utils'
], function (BackboneCollectionView, ItemRelationsRelatedItemView, RecentlyViewedItemsCollection, Configuration, Tracker, recently_viewed_items_tpl, recently_viewed_row_tpl, recently_viewed_cell_tpl, jQuery, Backbone, _) {
    'use strict';
    return BackboneCollectionView.extend({
        initialize: function () {
            var application = this.options.application, layout = application.getLayout(), collection = application.getConfig('siteSettings.sitetype') === 'ADVANCED' ? RecentlyViewedItemsCollection.getInstance() : new Backbone.Collection(), self = this;
            BackboneCollectionView.prototype.initialize.call(this, {
                collection: collection,
                viewsPerRow: Infinity,
                cellTemplate: recently_viewed_cell_tpl,
                rowTemplate: recently_viewed_row_tpl,
                childView: ItemRelationsRelatedItemView,
                template: recently_viewed_items_tpl
            });
            layout.once('afterAppendView', self.loadRecentlyViewedItem, self);
        },
        loadRecentlyViewedItem: function loadRecentlyViewedItem() {
            var self = this;
            this.collection.promise && this.collection.promise.done(function () {
                var application = self.options.application, number_of_items_displayed = application.getConfig('recentlyViewedItems.numberOfItemsDisplayed');
                Tracker.getInstance().trackProductList(self.collection, 'Recently Viewed Items');
                self.collection = self.collection.first(number_of_items_displayed);
                self.render();
                var carousel = self.$el.find('[data-type="carousel-items"]');
                if (_.isPhoneDevice() === false && application.getConfig('siteSettings.imagesizes')) {
                    var img_min_height = _.where(application.getConfig('siteSettings.imagesizes'), { name: application.getConfig('imageSizeMapping.thumbnail') })[0].maxheight;
                    carousel.find('.item-relations-related-item-thumbnail').css('minHeight', img_min_height);
                }
                _.initBxSlider(carousel, Configuration.bxSliderDefaults);
            });
        }
    });
});
define('RecentlyViewedItems', [
    'RecentlyViewedItems.View',
    'Cart.Detailed.View'
], function (RecentlyViewedItemsView, CartDetailedView) {
    'use strict';
    return {
        mountToApp: function (application) {
            CartDetailedView.addChildViews({
                'RecentlyViewed.Items': function wrapperFunction() {
                    return function () {
                        return new RecentlyViewedItemsView({ application: application });
                    };
                }
            });
        }
    };
});
define('SocialSharing', [
    'SC.Configuration',
    'PluginContainer',
    'Facets.Browse.View',
    'jQuery',
    'underscore',
    'Utils'
], function (Configuration, PluginContainer, BrowseView, jQuery, _, Utils) {
    'use strict';
    var SocialSharing = {
        getPopupOptionsStringFromObject: function (popup_options) {
            var popup_options_string = '';
            _.each(popup_options, function (value, name) {
                popup_options_string += ',' + name + '=' + value;
            });
            return popup_options_string.substring(1);
        },
        setMetaTagsByConfiguration: function (self, meta_tag_configuration) {
            _.each(meta_tag_configuration, function (fn, name) {
                var content = fn(self);
                jQuery('<meta />', {
                    name: name,
                    content: content || ''
                }).appendTo(jQuery('head'));
            });
        },
        setLinkTagsByConfiguration: function (self, link_tag_configuration) {
            _.each(link_tag_configuration, function (fn, rel) {
                var href = fn(self);
                if (href) {
                    jQuery('<link />', {
                        rel: rel,
                        href: href
                    }).appendTo(jQuery('head'));
                }
            });
        },
        clearMetaTagsByConfiguration: function (meta_tag_configuration) {
            var meta_tag;
            _.each(meta_tag_configuration, function (fn, name) {
                meta_tag = jQuery('meta[name="' + name + '"]');
                meta_tag && meta_tag.remove();
            });
        },
        clearLinkTagsByConfiguration: function (self, link_tag_configuration) {
            var link_tag;
            _.each(link_tag_configuration, function (fn, rel) {
                if (fn(self)) {
                    link_tag = jQuery('link[rel="' + rel + '"]');
                    link_tag && link_tag.remove();
                }
            });
        },
        setMetaTags: function () {
            var self = this, application = this.getApplication(), current_view = application.getLayout().currentView, meta_tag_mapping_og = Configuration.metaTagMappingOg, meta_tag_mapping_twitter_product_card = Configuration.metaTagMappingTwitterProductCard, meta_tag_mapping_twitter_gallery_card = Configuration.metaTagMappingTwitterGalleryCard, link_tag_google_plus_authorship = Configuration.linkTagGooglePlusAuthorship;
            this.clearMetaTagsByConfiguration(meta_tag_mapping_og);
            this.clearMetaTagsByConfiguration(meta_tag_mapping_twitter_product_card);
            this.clearMetaTagsByConfiguration(meta_tag_mapping_twitter_gallery_card);
            if (current_view instanceof BrowseView) {
                this.setMetaTagsByConfiguration(self, meta_tag_mapping_twitter_gallery_card);
            }
            this.clearLinkTagsByConfiguration(self, link_tag_google_plus_authorship);
            this.setLinkTagsByConfiguration(self, link_tag_google_plus_authorship);
        },
        afterAppendView: new PluginContainer(),
        afterAppendToDom: new PluginContainer(),
        mountToApp: function (application) {
            var self = this, layout = application.getLayout();
            _.extend(layout, {
                getPopupOptionsStringFromObject: this.getPopupOptionsStringFromObject,
                setMetaTags: this.setMetaTags,
                clearLinkTagsByConfiguration: this.clearLinkTagsByConfiguration,
                clearMetaTagsByConfiguration: this.clearMetaTagsByConfiguration,
                setLinkTagsByConfiguration: this.setLinkTagsByConfiguration,
                setMetaTagsByConfiguration: this.setMetaTagsByConfiguration
            });
            layout.on('afterAppendView', function () {
                this.$el.find('[data-type="social-share-icons"]').empty();
                this.setMetaTags();
                if (!Utils.isPageGenerator()) {
                    self.afterAppendView.executeAll(application);
                }
            });
            layout.on('afterAppendToDom', function () {
                if (!Utils.isPageGenerator()) {
                    self.afterAppendToDom.executeAll(application);
                }
            });
        }
    };
    return SocialSharing;
});
define('SocialSharing.Plugins.Facebook', [
    'SC.Configuration',
    'SocialSharing',
    'UrlHelper',
    'Utils',
    'jQuery',
    'underscore'
], function (Configuration, SocialSharing, UrlHelper, Utils, jQuery, _) {
    'use strict';
    var facebookPlugin = {
        shareInFacebookEventListener: function () {
            var url = window.location.href, popup_options_string = this.getPopupOptionsStringFromObject(Configuration.get('facebook.popupOptions')), target_url = 'https://www.facebook.com/dialog/share?display=popup&app_id=' + Configuration.get('facebook.appId') + '&href=' + encodeURIComponent(url) + '&redirect_uri=' + encodeURIComponent(_.addParamsToUrl(url, { closeFBPopup: 1 }));
            window.open(target_url, _.uniqueId('window'), popup_options_string);
        },
        mountToApp: function (application) {
            UrlHelper.addTokenListener('closeFBPopup', function () {
                window.close();
            });
            if (Configuration.get('facebook.enable')) {
                var layout = application.getLayout();
                _.extend(layout.events, { 'click [data-action="share-in-facebook"]': this.shareInFacebookEventListener });
                var plugin = {
                    name: 'facebookPlugin',
                    priority: 10,
                    execute: function (application) {
                        var layout = application.getLayout();
                        if (!jQuery('[data-type="like-in-facebook"]').size()) {
                            layout.$el.find('[data-type="social-share-icons"]').append('<a href="#" class="social-sharing-flyout-content-social-facebook" data-action="share-in-facebook"><i class="social-sharing-flyout-content-social-facebook-icon"></i> <span>Share</span></a>');
                        }
                    }
                };
                SocialSharing.afterAppendView.install(plugin);
                SocialSharing.afterAppendToDom.install(plugin);
            }
        }
    };
    return facebookPlugin;
});
define('SocialSharing.Plugins.Twitter', [
    'SC.Configuration',
    'SocialSharing',
    'underscore'
], function (Configuration, SocialSharing, _) {
    'use strict';
    var twitterPlugin = {
        shareInTwitter: function (url, description, via, popup_options) {
            var popup_options_string = this.getPopupOptionsStringFromObject(popup_options || Configuration.get('twitter.popupOptions')), target_url = 'https://twitter.com/intent/tweet?original_referer=' + encodeURIComponent(url) + '&source=tweetbutton&text=' + encodeURIComponent(description) + '&url=' + encodeURIComponent(url) + '&via=' + encodeURIComponent(via);
            window.open(target_url, _.uniqueId('window'), popup_options_string);
        },
        shareInTwitterEventListener: function (e) {
            e.preventDefault();
            var metaTagMappingOg = Configuration.get('metaTagMappingOg'), url = metaTagMappingOg['og:url'](this), title = metaTagMappingOg['og:title'](this), via = Configuration.get('twitter.via') ? Configuration.get('twitter.via').replace('@', '') : '';
            this.shareInTwitter(url, title, via);
        },
        mountToApp: function (application) {
            if (Configuration.get('twitter.enable')) {
                var layout = application.getLayout();
                _.extend(layout, { shareInTwitter: this.shareInTwitter });
                _.extend(layout.events, { 'click [data-action="share-in-twitter"]': this.shareInTwitterEventListener });
                SocialSharing.afterAppendView.install({
                    name: 'twitterPlugin',
                    priority: 10,
                    execute: function (application) {
                        var layout = application.getLayout();
                        layout.$el.find('[data-type="social-share-icons"]').append('<a href="#" class="social-sharing-flyout-content-social-twitter" data-action="share-in-twitter"><i class="social-sharing-flyout-content-social-twitter-icon"></i> <span>Tweet</span></a>');
                    }
                });
            }
        }
    };
    return twitterPlugin;
});
define('SocialSharing.Plugins.GooglePlus', [
    'SC.Configuration',
    'SocialSharing',
    'underscore'
], function (Configuration, SocialSharing, _) {
    'use strict';
    var googleplusPlugin = {
        shareInGooglePlus: function (url, popup_options) {
            var popup_options_string = this.getPopupOptionsStringFromObject(popup_options || Configuration.get('googlePlus.popupOptions')), target_url = 'https://plus.google.com/share?url=' + encodeURIComponent(url);
            window.open(target_url, _.uniqueId('window'), popup_options_string);
        },
        shareInGooglePlusEventListener: function (e) {
            e.preventDefault();
            var metaTagMappingOg = Configuration.get('metaTagMappingOg'), url = metaTagMappingOg['og:url'](this);
            this.shareInGooglePlus(url);
        },
        mountToApp: function (application) {
            if (Configuration.get('googlePlus.enable')) {
                var layout = application.getLayout();
                _.extend(layout, { shareInGooglePlus: this.shareInGooglePlus });
                _.extend(layout.events, { 'click [data-action="share-in-google-plus"]': this.shareInGooglePlusEventListener });
                SocialSharing.afterAppendView.install({
                    name: 'googleplusPlugin',
                    priority: 10,
                    execute: function (application) {
                        var layout = application.getLayout();
                        layout.$el.find('[data-type="social-share-icons"]').append('<a href="#" class="social-sharing-flyout-content-social-google" data-action="share-in-google-plus"><i class="social-sharing-flyout-content-social-google-icon"></i> <span>Google +</span></a>');
                    }
                });
            }
        }
    };
    return googleplusPlugin;
});
define('SocialSharing.Plugins.Pinterest', [
    'SC.Configuration',
    'SocialSharing',
    'jQuery',
    'underscore'
], function (Configuration, SocialSharing, jQuery, _) {
    'use strict';
    var pinterestPlugin = {
        shareInPinterest: function (url, image, description, popup_options) {
            var popup_options_string = this.getPopupOptionsStringFromObject(popup_options || Configuration.get('pinterest.popupOptions')), target_url = 'http://pinterest.com/pin/create/button/?url=' + encodeURIComponent(url) + '&media=' + encodeURIComponent(image) + '&description=' + encodeURIComponent(description);
            window.open(target_url, _.uniqueId('window'), popup_options_string);
        },
        shareInPinterestEventListener: function (e) {
            e.preventDefault();
            var metaTagMappingOg = Configuration.get('metaTagMappingOg'), url = metaTagMappingOg['og:url'](this), image = metaTagMappingOg['og:image'](this), title = metaTagMappingOg['og:title'](this);
            this.shareInPinterest(url, image, title);
        },
        mountToApp: function (application) {
            if (Configuration.get('pinterest.enableButton')) {
                var layout = application.getLayout();
                _.extend(layout, { shareInPinterest: this.shareInPinterest });
                _.extend(layout.events, { 'click [data-action="share-in-pinterest"]': this.shareInPinterestEventListener });
                SocialSharing.afterAppendView.install({
                    name: 'pinterestPlugin',
                    priority: 10,
                    execute: function (application) {
                        var layout = application.getLayout();
                        layout.$el.find('[data-type="social-share-icons"]').append('<a href="#" class="social-sharing-flyout-content-social-pinterest" data-action="share-in-pinterest"><i class="social-sharing-flyout-content-social-pinterest-icon"></i> <span>Pinit</span></a>');
                    }
                });
            }
        }
    };
    return pinterestPlugin;
});
define('SocialSharing.Plugins.Pinterest.Hover', [
    'SC.Configuration',
    'SocialSharing',
    'Backbone.View',
    'jQuery',
    'underscore'
], function (Configuration, SocialSharing, BackboneView, jQuery, _) {
    'use strict';
    var pinterestPluginHover = {
        shareInPinterest: function (url, image, description, popup_options) {
            var popup_options_string = this.getPopupOptionsStringFromObject(popup_options || Configuration.get('pinterest.popupOptions')), target_url = 'http://pinterest.com/pin/create/button/?url=' + encodeURIComponent(url) + '&media=' + encodeURIComponent(image) + '&description=' + encodeURIComponent(description);
            window.open(target_url, _.uniqueId('window'), popup_options_string);
        },
        shareInPinterestHoverEventListener: function (e) {
            e.preventDefault();
            var image_size = Configuration.get('pinterest.imageSize'), metaTagMappingOg = Configuration.get('metaTagMappingOg'), url = metaTagMappingOg['og:url'](this), image = jQuery('a.bx-pager-link.active').find('img').attr('src') || jQuery('a.bx-pager-link').eq(0).find('img').attr('src'), title = metaTagMappingOg['og:title'](this);
            if (!image) {
                image = jQuery('.product-details-image-gallery-detailed-image').find('img').attr('src');
            }
            image = this.getApplication().resizeImage(image.split('?')[0], image_size);
            this.shareInPinterest(url, image, title);
        },
        mountToApp: function (application) {
            if (Configuration.get('pinterest.enableHover')) {
                var layout = application.getLayout();
                _.extend(layout, { shareInPinterest: this.shareInPinterest });
                _.extend(layout.events, { 'click [data-action="share-in-pinterest-hover"]': this.shareInPinterestHoverEventListener });
                BackboneView.postRender.install({
                    name: 'pinterestPluginHover',
                    priority: 10,
                    execute: function ($el) {
                        if (!$el.find('[data-action="share-in-pinterest-hover"]').length) {
                            $el.find('[data-type="social-share-icons-hover"]').append('<a href="#" class="social-sharing-flyout-content-social-pinterest" data-action="share-in-pinterest-hover"><i class="social-sharing-flyout-content-social-pinterest-icon"></i> Pinit</a>');
                        }
                    }
                });
            }
        }
    };
    return pinterestPluginHover;
});
define('SocialSharing.Plugins.AddThis', [
    'SC.Configuration',
    'SocialSharing',
    'jQuery',
    'underscore'
], function (Configuration, SocialSharing, jQuery, _) {
    'use strict';
    var addthisPlugin = {
        refreshAddThisElements: function () {
            if (typeof addthis === 'undefined' || !jQuery('[data-type="share-in-add-this"]').size()) {
                return;
            }
            var metaTagMappingOg = Configuration.get('metaTagMappingOg'), innerHTML = '';
            _.each(Configuration.get('addThis.servicesToShow'), function (name, code) {
                innerHTML += '<a class="addthis_button_' + code + '">' + name + '</a>';
            });
            var share_options = {
                url: metaTagMappingOg['og:url'](this),
                title: metaTagMappingOg['og:title'](this),
                description: metaTagMappingOg['og:description'](this)
            };
            jQuery('[data-type="share-in-add-this"]').each(function () {
                if (this) {
                    var $this = jQuery(this);
                    $this.html(innerHTML).addClass(Configuration.get('addThis.toolboxClass'));
                    addthis.toolbox(this, Configuration.get('addThis.options'), share_options);
                }
            });
        },
        mountToApp: function (application) {
            if (Configuration.get('addThis.enable')) {
                var layout = application.getLayout();
                _.extend(layout, {
                    refreshAddThisElements: this.refreshAddThisElements,
                    addthis_script_loaded: false
                });
                var plugin = {
                    name: 'addthisPlugin',
                    priority: 10,
                    execute: function (application) {
                        var layout = application.getLayout();
                        if (!jQuery('[data-type="share-in-add-this"]').size()) {
                            layout.$el.find('[data-type="social-share-icons"]').append('<div href="#" class="add-this-btn" data-type="share-in-add-this"></div>');
                        }
                        if (jQuery('[data-type="share-in-add-this"]').size()) {
                            if (!layout.addthis_script_loaded) {
                                layout.addthis_script_loaded = true;
                                var addthis_script_url = ('https:' === document.location.protocol ? 'https://' : 'http://') + 's7.addthis.com/js/300/addthis_widget.js#domready=1';
                                SC.ENVIRONMENT.jsEnvironment === 'browser' && jQuery.getScript(addthis_script_url, function () {
                                    layout.refreshAddThisElements();
                                });
                            } else {
                                layout.refreshAddThisElements();
                            }
                        }
                    }
                };
                SocialSharing.afterAppendView.install(plugin);
                SocialSharing.afterAppendToDom.install(plugin);
            }
        }
    };
    return addthisPlugin;
});
define('ProductReviews.Model', [
    'Backbone.CachedModel',
    'underscore',
    'jQuery',
    'Utils'
], function (BackboneCachedModel, _, jQuery) {
    'use strict';
    return BackboneCachedModel.extend({
        urlRoot: _.getAbsoluteUrl('services/ProductReviews.Service.ss'),
        validation: {
            rating: {
                required: true,
                msg: _('Rating is required').translate()
            },
            title: {
                fn: function (value) {
                    if (!value) {
                        return _('Title is required').translate();
                    }
                    if (value.length >= 199) {
                        return _('The field name cannot contain more than the maximum number (199) of characters allowed.').translate();
                    }
                }
            },
            text: {
                fn: function (value) {
                    if (!value) {
                        return _('Text is required').translate();
                    }
                    if (value.length > 1000) {
                        return _('The review field cannot contain more than the maximum number (1000) of characters allowed.').translate();
                    }
                }
            },
            writerName: {
                required: true,
                msg: _('Writer is required').translate()
            }
        },
        parse: function (response) {
            response.rated = JSON.parse(jQuery.cookie('votedReviewsId') || '{}')[response.internalid];
            return response;
        }
    });
});
define('ProductReviews.Collection', [
    'ProductReviews.Model',
    'Backbone.CachedCollection',
    'SC.Configuration',
    'underscore'
], function (Model, BackboneCachedCollection, Configuration, _) {
    'use strict';
    return BackboneCachedCollection.extend({
        url: _.addParamsToUrl(_.getAbsoluteUrl('services/ProductReviews.Service.ss'), { 'no-cache': new Date().getTime() }),
        model: Model,
        parse: function (data) {
            this.page = data.page;
            this.recordsPerPage = data.recordsPerPage;
            this.totalRecordsFound = data.totalRecordsFound;
            this.totalPages = Math.ceil(this.totalRecordsFound / this.recordsPerPage);
            return data.records;
        },
        parseOptions: function (options) {
            if (options) {
                if (options.filter) {
                    options.filter = options.filter.id;
                }
                if (options.sort) {
                    options.sort = options.sort.id;
                }
                options.itemid = this.itemid;
            }
            return options;
        },
        getReviewParams: function (options) {
            var sort, filter, reviews_params = {};
            if (options) {
                if (options.itemid) {
                    reviews_params.itemid = options.itemid;
                }
                if (options.filter) {
                    filter = _.find(Configuration.get('productReviews.filterOptions'), function (i) {
                        return i.id === options.filter;
                    }) || {};
                } else {
                    filter = _.find(Configuration.get('productReviews.filterOptions'), function (i) {
                        return i.isDefault;
                    }) || {};
                }
                reviews_params = _.extend(reviews_params, filter.params);
                if (options.sort) {
                    sort = _.find(Configuration.get('productReviews.sortOptions'), function (i) {
                        return i.id === options.sort;
                    }) || {};
                } else {
                    sort = _.find(Configuration.get('productReviews.sortOptions'), function (i) {
                        return i.isDefault;
                    }) || {};
                }
                reviews_params = _.extend(reviews_params, sort.params);
            }
            reviews_params = _.extend(reviews_params, { page: options && options.page || 1 });
            return reviews_params;
        },
        update: function (options) {
            var data = this.getReviewParams(this.parseOptions(options));
            if (data.order) {
                data.order = options.order && options.order < 0 ? data.order.replace('ASC', 'DESC') : data.order.replace('DESC', 'ASC');
            }
            this.fetch({
                data: data,
                reset: true,
                killerId: options.killerId
            });
        }
    });
});
define('ProductReviews.FormConfirmation.View', [
    'Facets.ItemCell.View',
    'GlobalViews.StarRating.View',
    'product_reviews_form_confirmation.tpl',
    'underscore',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Utils'
], function (FacetsItemCellView, GlobalViewsStarRatingView, product_reviews_form_confirmation, _, Backbone, BackboneCompositeView, BackboneCollectionView) {
    'use strict';
    return Backbone.View.extend({
        template: product_reviews_form_confirmation,
        attributes: {
            'id': 'product-review-form-confirmation',
            'class': 'product-review-form-confirmation'
        },
        title: _('Confirmation').translate(),
        confirmation_message: _('<h2>Thank You!</h2><p>Your review has been submitted.</p>').translate(),
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.product = options.product;
            this.item = this.product.get('item');
        },
        getBreadcrumb: function () {
            var result = this.item.get('_breadcrumb').slice(0);
            result.push({
                href: this.item.get('_url') + '/reviews',
                text: _('Reviews').translate()
            });
            result.push({
                href: this.item.get('_url') + '/reviews/new',
                text: _('Thank you').translate()
            });
            return result;
        },
        childViews: {
            'Global.StarRating': function () {
                return new GlobalViewsStarRatingView({
                    model: this.model,
                    showRatingCount: false,
                    showLabelRating: true
                });
            },
            'Global.StarRatingAttribute': function () {
                var collection = new Backbone.Collection(_.map(this.model.get('rating_per_attribute'), function (value, key) {
                    return {
                        label: key,
                        rating: value
                    };
                }));
                return new BackboneCollectionView({
                    collection: collection,
                    childView: GlobalViewsStarRatingView,
                    childViewOptions: {
                        showRatingCount: false,
                        className: 'pegs text-center'
                    },
                    viewsPerRow: 1
                });
            },
            'Facets.ItemCell': function () {
                return new FacetsItemCellView({
                    model: this.product,
                    itemIsNavigable: false
                });
            }
        },
        getContext: function () {
            return {
                header: this.title,
                confirmationMessage: this.confirmation_message,
                productTitle: this.item.get('_name'),
                itemUrl: this.item.get('_url'),
                reviewCreatedOn: this.model.get('created_on') || new Date().toDateString(),
                reviewTitle: this.model.get('title'),
                reviewAuthor: this.model.get('writer').name || _('anonymous').translate(),
                isReviewVerified: !!this.model.get('isVerified'),
                reviewText: this.model.get('text')
            };
        }
    });
});
define('ProductReviews.Preview.View', [
    'SC.Configuration',
    'ProductReviews.Collection',
    'product_reviews_preview_review.tpl',
    'GlobalViews.StarRating.View',
    'GlobalViews.Message.View',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Utils'
], function (Configuration, ProductReviewsCollection, product_reviews_preview_review, GlobalViewsStarRatingView, GlobalViewsMessageView, _, jQuery, Backbone, BackboneCompositeView, BackboneCollectionView) {
    'use strict';
    return Backbone.View.extend({
        template: product_reviews_preview_review,
        events: { 'click [data-action="vote"]': 'markReview' },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.collection = options.collection;
            this.showActionButtons = options.showActionButtons;
        },
        childViews: {
            'Global.StarRating': function () {
                return new GlobalViewsStarRatingView({
                    model: this.model,
                    showRatingCount: false,
                    showLabelRating: true
                });
            },
            'Global.StarRatingAttribute': function () {
                var collection = new Backbone.Collection(_.map(this.model.get('rating_per_attribute'), function (value, key) {
                    return {
                        label: key,
                        rating: value
                    };
                }));
                return new BackboneCollectionView({
                    collection: collection,
                    childView: GlobalViewsStarRatingView,
                    childViewOptions: {
                        showRatingCount: false,
                        className: 'pegs text-center'
                    },
                    viewsPerRow: 1
                });
            }
        },
        getContext: function () {
            var rated = this.model.get('rated') || {};
            rated.voted = rated['mark-as-useful'] || rated['mark-as-not-useful'];
            return {
                reviewCreatedOn: this.model.get('created_on') || new Date().toDateString(),
                reviewTitle: this.model.get('title'),
                reviewAuthor: this.model.get('writer').name || _('anonymous').translate(),
                isReviewVerified: !!this.model.get('isVerified'),
                reviewText: this.model.get('text').replace(/\n/g, '<br>'),
                isReviewRatingPerAttributesLegthGreaterThan0: !!_.values(this.model.get('rating_per_attribute')).length,
                showActionButtons: this.showActionButtons,
                usefulButtonClass: rated.voted ? 'disabled' + (rated['mark-as-useful'] ? ' btn-success' : '') : '',
                reviewId: this.model.get('internalid'),
                usefulCountGreaterThan0: this.model.get('useful_count') > 0,
                usefulCount: this.model.get('useful_count'),
                notUsefulButtonClass: rated.voted ? 'disabled' + (rated['mark-as-not-useful'] ? ' btn-success' : '') : '',
                notusefulCountGreater: this.model.get('not_useful_count') > 0,
                notUsefulCount: this.model.get('not_useful_count')
            };
        },
        handleMarkSuccess: function (review_id, action, review, $container) {
            var currentReviewedItems = JSON.parse(jQuery.cookie('votedReviewsId') || '{}');
            if (!currentReviewedItems[review_id]) {
                currentReviewedItems[review_id] = {};
                currentReviewedItems[review_id][action] = true;
                jQuery.cookie('votedReviewsId', JSON.stringify(currentReviewedItems));
                var rated = {};
                rated[action] = true;
                rated.voted = true;
                review.set('rated', rated);
            }
            var global_view_message = new GlobalViewsMessageView({
                message: _('<strong>Thank You!</strong> We love your feedback.').translate(),
                type: 'success',
                closable: true
            });
            this.model = review;
            this.render();
            $container.find('[data-id="' + review_id + '"] [data-type="alert-placeholder"]').html(global_view_message.render().$el.html());
        },
        handleMarkError: function ($container) {
            var global_view_message = new GlobalViewsMessageView({
                message: _('<b>We are sorry!</b> There has been an error, please try again later.').translate(),
                type: 'warning',
                closable: true
            });
            $container.find('[data-action="vote"]').removeClass('disabled').end().find('[data-type="alert-placeholder"]').html(global_view_message.render().$el.html());
        },
        markReview: function (e) {
            var $element = jQuery(e.target);
            if (!$element.hasClass('disabled')) {
                var rated = {}, proxy = jQuery.proxy, action = $element.data('type'), $container = $element.closest('.review-container'), review_id = $element.data('review-id'), review = this.collection.get(review_id);
                $element.addClass('disabled');
                rated[action] = true;
                review.set({
                    action: action,
                    rated: rated
                });
                review.save().then(proxy(this.handleMarkSuccess, this, review_id, action, review, $container), proxy(this.handleMarkError, this, $container));
            }
        }
    });
});
define('ProductReviews.FormPreview.View', [
    'ProductReviews.FormConfirmation.View',
    'ProductReviews.Preview.View',
    'Facets.ItemCell.View',
    'product_reviews_form_preview.tpl',
    'underscore',
    'Backbone',
    'Backbone.CompositeView'
], function (ProductReviewsFormConfirmationView, ProductReviewsPreview, FacetsItemCellView, product_reviews_form_preview, _, Backbone, BackboneCompositeView) {
    'use strict';
    return Backbone.View.extend({
        template: product_reviews_form_preview,
        attributes: {
            'id': 'product-review-form-preview',
            'class': 'product-review-form-preview'
        },
        title: _('Submit your Review').translate(),
        page_header: _('Submit your Review').translate(),
        events: {
            'click [data-action="edit"]': 'edit',
            'click [data-action="save"]': 'save'
        },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.product = options.product;
            this.item = this.product.get('item');
            this.formView = options.formView;
        },
        childViews: {
            'Facets.ItemCell': function () {
                return new FacetsItemCellView({
                    model: this.product,
                    itemIsNavigable: false
                });
            },
            'ProductReviews.Preview': function () {
                return new ProductReviewsPreview({ model: this.model });
            }
        },
        edit: function () {
            this.formView.showContent();
        },
        save: function (e) {
            e && e.preventDefault();
            var self = this;
            this.model.set('itemid', this.item.get('internalid')).save(null, {
                statusCode: {
                    '401': function () {
                    }
                }
            }).done(function () {
                var preview_review = new ProductReviewsFormConfirmationView({
                    model: self.model,
                    product: self.product,
                    application: self.options.application
                });
                preview_review.showContent();
            });
        },
        getContext: function () {
            return {
                header: this.page_header,
                itemUrl: this.item.get('_url')
            };
        }
    });
});
define('ProductReviews.Form.View', [
    'SC.Configuration',
    'Profile.Model',
    'ProductReviews.FormPreview.View',
    'ProductReviews.FormConfirmation.View',
    'Facets.ItemCell.View',
    'GlobalViews.StarRating.View',
    'product_reviews_form.tpl',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Backbone.FormView',
    'Utils'
], function (Configuration, ProfileModel, ProductReviewsFormPreviewView, ProductReviewsFormConfirmationView, FacetsItemCellView, GlobalViewsStarRatingView, product_reviews_form, _, jQuery, Backbone, BackboneCompositeView, BackboneCollectionView, BackboneFormView) {
    'use strict';
    var ProductReviewsFormView = Backbone.View.extend({
        template: product_reviews_form,
        attributes: {
            'id': 'product-review-form',
            'class': 'product-review-form'
        },
        title: _('Write your Review').translate(),
        page_header: _('Write your Review').translate(),
        events: {
            'submit form': 'customSaveForm',
            'rate [data-toggle="rater"]': 'rate',
            'click [data-action="preview"]': 'preview'
        },
        bindings: {
            '[name="text"]': 'text',
            '[name="title"]': 'title',
            '[name="writerName"]': 'writerName'
        },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.product = options.product;
            this.item = this.product.get('item');
            this.tmpRatingPerAtribute = {};
            this.application = options.application;
            this.profileModel = ProfileModel.getInstance();
            this.isLoggedIn = this.profileModel.get('isLoggedIn') === 'T';
            this.updateMetaTags();
            if (this.isLoggedIn && !(this.model.get('writer') && this.model.get('writer').name)) {
                var writer_name = this.profileModel.get('firstname');
                this.model.set('writerName', writer_name);
                this.model.set('writer', { name: writer_name });
            }
            BackboneFormView.add(this);
        },
        initializeDynamicFields: function () {
            if (_.isEmpty(this.model.get('rating_per_attribute'))) {
                _.each(this.item.get('_attributesToRateOn'), _.bind(function (attributes) {
                    this.model.set(attributes, 0);
                }, this));
            }
        },
        addDynamicRatingFields: function () {
            var self = this;
            _.each(this.item.get('_attributesToRateOn'), function (dyn_attributes) {
                self.model.validation[dyn_attributes] = function (value) {
                    if (value === 0) {
                        return _('Attribute is required').translate();
                    }
                };
            });
        },
        showContent: function () {
            var self = this;
            if (this.model.get('text')) {
                this.model.set('text', this.model.get('text').replace(/<br>/g, '\n'));
            }
            this.initializeDynamicFields();
            this.addDynamicRatingFields();
            this.application.getLayout().showContent(this).done(function () {
                self.$('[data-toggle="rater"]').rater();
            });
        },
        rate: function (e, rater) {
            var attributes_to_rate_on = this.item.get('_attributesToRateOn');
            if (~_.indexOf(attributes_to_rate_on, rater.name)) {
                this.tmpRatingPerAtribute[rater.name] = rater.value;
                this.model.set(rater.name, rater.value);
            } else if (rater.name === '__overall__') {
                this.tmpRating = rater.value;
                this.rateTouched = true;
                this.model.set('rating', this.tmpRating);
            }
            if (!this.rateTouched && Configuration.get('productReviews.computeOverall')) {
                var average = Math.round(_.reduce(_.values(this.tmpRatingPerAtribute), function (memo, num) {
                    return memo + num;
                }, 0) / attributes_to_rate_on.length);
                this.$('[data-toggle="rater"][data-name="__overall__"]').data('rater').setValue(average, true);
                this.model.set('rating', average);
            }
        },
        sanitize: function (text) {
            return jQuery.trim(text).replace(/</g, '&lt;').replace(/\>/g, '&gt;');
        },
        preview: function (e) {
            e && e.preventDefault();
            this.prepareItem();
            Backbone.Validation.bind(this, { selector: 'id' });
            this.$savingForm = jQuery(e.target).closest('form');
            if (this.model.isValid(true)) {
                new ProductReviewsFormPreviewView({
                    formView: new ProductReviewsFormView({
                        product: this.product,
                        application: this.application,
                        model: this.model
                    }),
                    product: this.product,
                    application: this.application,
                    model: this.model
                }).showContent();
            }
        },
        prepareItem: function () {
            var sanitized_writer_name = this.sanitize(this.$('#writerName').val());
            this.model.set({
                title: this.sanitize(this.$('#title').val()),
                rating: this.tmpRating || this.model.get('rating'),
                rating_per_attribute: this.tmpRatingPerAtribute || this.model.get('rating_per_attribute'),
                writer: { name: sanitized_writer_name },
                writerName: sanitized_writer_name,
                text: this.sanitize(this.$('#text').val())
            });
        },
        customSaveForm: function (e) {
            e && e.preventDefault();
            this.prepareItem();
            this.model.set('itemid', this.item.get('internalid'));
            this.selector = 'id';
            var promise = BackboneFormView.saveForm.apply(this, arguments), self = this;
            promise && promise.done(function () {
                var preview_review = new ProductReviewsFormConfirmationView({
                    model: self.model,
                    product: self.product,
                    application: self.application
                });
                preview_review.showContent();
            });
            return promise;
        },
        updateMetaTags: function () {
            var $head = jQuery('head');
            jQuery('<meta/>', {
                name: 'robots',
                content: 'noindex, nofollow'
            }).appendTo($head);
        },
        childViews: {
            'Facets.ItemCell': function () {
                return new FacetsItemCellView({
                    model: this.product.get('item'),
                    itemIsNavigable: false,
                    showStarRating: false
                });
            },
            'Global.StarRatingAttribute': function () {
                var self = this, collection = new Backbone.Collection(_.map(this.item.get('_attributesToRateOn'), function (value) {
                        return {
                            label: value,
                            name: value,
                            rating: !_.isUndefined(self.model.get('rating_per_attribute')) ? self.model.get('rating_per_attribute')[value] : 0
                        };
                    }));
                return new BackboneCollectionView({
                    collection: collection,
                    childView: GlobalViewsStarRatingView,
                    childViewOptions: {
                        showRatingCount: false,
                        className: 'pegs',
                        isWritable: true
                    },
                    viewsPerRow: 1
                });
            },
            'Global.StarRating': function () {
                this.model.set('label', 'Overall');
                this.model.set('name', '__overall__');
                return new GlobalViewsStarRatingView({
                    showRatingCount: false,
                    isWritable: true,
                    value: this.model.get('_rating') || this.model.get('rating') || 0,
                    ratingCount: this.model.get('_ratingsCount'),
                    label: this.model.get('label'),
                    name: this.model.get('name')
                });
            }
        },
        getContext: function () {
            return {
                header: this.page_header,
                isLoginRequiredAndIsNotLoggedIn: Configuration.get('productReviews.loginRequired') && !this.isLoggedIn,
                writer: this.model.get('writer') && this.model.get('writer').name || '',
                title: this.model.get('title') || '',
                text: this.model.get('text') || '',
                itemUrl: this.item.get('_url'),
                showStarRatingAttributes: !!this.item.get('_attributesToRateOn').length
            };
        }
    });
    return ProductReviewsFormView;
});
define('ProductReviews.Router', [
    'ProductReviews.Model',
    'ProductReviews.Collection',
    'ProductReviews.Form.View',
    'Product.Model',
    'AjaxRequestsKiller',
    'Backbone',
    'underscore'
], function (ProductReviewsModel, Collection, ProductReviewsFormView, ProductModel, AjaxRequestsKiller, Backbone, _) {
    'use strict';
    return Backbone.Router.extend({
        routes: {
            'product/:id/newReview': 'createReviewById',
            ':url/newReview': 'createReviewByUrl'
        },
        initialize: function (Application) {
            this.application = Application;
        },
        createReviewByUrl: function (url) {
            if (~url.indexOf('?')) {
                url = url.split('?')[0];
            }
            this.createReview({ url: url });
        },
        createReviewById: function (id) {
            this.createReview({ id: id });
        },
        createReview: function (api_params) {
            var product = new ProductModel();
            product.get('item').fetch({
                data: api_params,
                killerId: AjaxRequestsKiller.getKillerId()
            }).done(_.bind(function () {
                var model = new ProductReviewsModel(), view = new ProductReviewsFormView({
                        product: product,
                        model: model,
                        application: this.application
                    });
                view.showContent();
            }, this));
        }
    });
});
define('ProductReviews.Review.View', [
    'GlobalViews.StarRating.View',
    'GlobalViews.Message.View',
    'product_reviews_review.tpl',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Utils'
], function (GlobalViewsStarRatingView, GlobalViewsMessageView, product_reviews_review, _, jQuery, Backbone, BackboneCompositeView, BackboneCollectionView) {
    'use strict';
    return Backbone.View.extend({
        template: product_reviews_review,
        events: { 'click button[data-action="vote"]': 'markReview' },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.collection = options.collection;
            this.showActionButtons = options.showActionButtons;
            this.voted = false;
        },
        handleMarkSuccess: function (review_id, action, review, $container) {
            var currentReviewedItems = JSON.parse(jQuery.cookie('votedReviewsId') || '{}'), target_button = $container.context;
            if (!currentReviewedItems[review_id]) {
                currentReviewedItems[review_id] = {};
                currentReviewedItems[review_id][action] = true;
                jQuery.cookie('votedReviewsId', JSON.stringify(currentReviewedItems));
                var rated = {};
                rated[action] = true;
                rated.voted = true;
                review.set('rated', rated);
            }
            this.model = review;
            var global_view_message = new GlobalViewsMessageView({
                message: _('<strong>Thank You!</strong> We love your feedback.').translate(),
                type: 'success',
                closable: true
            });
            target_button.innerText = action === 'mark-as-useful' ? _('Yes ($(0))').translate(this.model.get('useful_count')) : _('No ($(0))').translate(this.model.get('not_useful_count'));
            this.$el.find(target_button).addClass('product-reviews-review-voted');
            this.$el.find('[data-type="alert-placeholder"]').html(global_view_message.render().$el.html());
        },
        handleMarkError: function ($container) {
            var global_view_message = new GlobalViewsMessageView({
                message: _('<b>We are sorry!</b> There has been an error, please try again later.').translate(),
                type: 'warning',
                closable: true
            });
            $container.find('[data-action="vote"]').removeClass('disabled').end().find('[data-type="alert-placeholder"]').html(global_view_message.render().$el.html());
        },
        markReview: function (e) {
            var $element = jQuery(e.target);
            if (!$element.hasClass('disabled') && !this.voted) {
                var rated = {}, proxy = jQuery.proxy, action = $element.data('type'), $container = $element.closest('.review-container'), review_id = $element.data('review-id'), review = this.collection.get(review_id);
                $element.addClass('disabled');
                this.voted = true;
                review.set({
                    action: action,
                    rated: rated
                });
                review.save().then(proxy(this.handleMarkSuccess, this, review_id, action, review, $container), proxy(this.handleMarkError, this, $container));
            }
        },
        childViews: {
            'ProductReview.Review.Global.StarRating': function () {
                return new GlobalViewsStarRatingView({
                    model: this.model,
                    showRatingCount: false
                });
            },
            'Global.StarRatingAttribute': function () {
                var collection = new Backbone.Collection(_.map(this.model.get('rating_per_attribute'), function (value, key) {
                    return {
                        label: key,
                        rating: value
                    };
                }));
                return new BackboneCollectionView({
                    collection: collection,
                    childView: GlobalViewsStarRatingView,
                    childViewOptions: {
                        showRatingCount: false,
                        className: 'pegs text-center'
                    },
                    viewsPerRow: 1
                });
            }
        },
        getContext: function () {
            var rated = this.model.get('rated') || {};
            rated.voted = this.voted;
            return {
                reviewCreatedOn: this.model.get('created_on') || new Date().toDateString(),
                reviewTitle: this.model.get('title'),
                reviewAuthor: this.model.get('writer').name || _('anonymous').translate(),
                isReviewVerified: !!this.model.get('isVerified'),
                reviewText: this.model.get('text'),
                isReviewRatingPerAttributesLegthGreaterThan0: !!_.values(this.model.get('rating_per_attribute')).length,
                showActionButtons: this.showActionButtons,
                usefulButtonClass: rated.voted ? 'disabled' + (rated['mark-as-useful'] ? ' btn-success' : '') : '',
                reviewId: this.model.get('internalid'),
                usefulCountGreaterThan0: this.model.get('useful_count') > 0,
                usefulCount: this.model.get('useful_count'),
                notUsefulButtonClass: rated.voted ? 'disabled' + (rated['mark-as-not-useful'] ? ' btn-success' : '') : '',
                notusefulCountGreater: this.model.get('not_useful_count') > 0,
                notUsefulCount: this.model.get('not_useful_count')
            };
        }
    });
});
define('GlobalViews.RatingByStar.View', [
    'SC.Configuration',
    'global_views_rating_by_star.tpl',
    'Backbone',
    'jQuery'
], function (Configuration, global_views_rating_by_star_tpl, Backbone, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: global_views_rating_by_star_tpl,
        initialize: function (options) {
            this.showPercentage = options.showPercentage;
            this.showCount = options.showCount;
            this.queryOptions = options.queryOptions;
            this.baseUrl = options.baseUrl;
        },
        getContext: function () {
            var maxRate = Configuration.get('productReviews.maxRate'), ratingsCountsByRate = this.model.get('_ratingsCountsByRate'), count, percentage, rates = [];
            for (var i = maxRate; i > 0; i--) {
                count = ratingsCountsByRate[i] ? ratingsCountsByRate[i] : 0;
                percentage = count * 100 / this.model.get('_ratingsCount');
                rates.push({
                    count: count,
                    percentage: percentage,
                    percentageRound: Math.round(percentage),
                    index: i,
                    showLink: count ? true : false,
                    url: this.getUrlForOption({ filter: i + 'star' }),
                    isOneReview: count === '1'
                });
            }
            return {
                showCount: this.showCount,
                showPercentage: this.showPercentage,
                rates: rates
            };
        },
        getUrlForOption: function (option) {
            var options = {}, sort = option && option.sort || this.queryOptions.sort, filter = option && option.filter || this.queryOptions.filter;
            if (filter) {
                options.filter = filter;
            }
            if (sort) {
                options.sort = sort;
            }
            return this.baseUrl + '?' + jQuery.param(options);
        }
    });
});
define('ProductReviews.Center.View', [
    'SC.Configuration',
    'ListHeader.View',
    'ProductReviews.Collection',
    'ProductReviews.Review.View',
    'GlobalViews.StarRating.View',
    'GlobalViews.RatingByStar.View',
    'GlobalViews.Pagination.View',
    'product_reviews_center.tpl',
    'underscore',
    'jQuery',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Utils',
    'jQuery.scPush'
], function (Configuration, ListHeaderView, ProductReviewsCollection, ProductReviewsReviewView, GlobalViewsStarRatingView, GlobalViewsRatingByStarView, GlobalViewsPaginationView, product_reviews_center, _, jQuery, Backbone, BackboneCompositeView, BackboneCollectionView, Utils) {
    'use strict';
    return Backbone.View.extend({
        template: product_reviews_center,
        attributes: {
            'id': 'item-product-reviews',
            'class': 'item-product-reviews item-detailed-reviews'
        },
        initialize: function (options) {
            BackboneCompositeView.add(this);
            this.item = options.item;
            this.baseUrl = 'product/' + options.item.get('internalid');
            this.queryOptions = Utils.parseUrlOptions(location.href);
            this.application = options.application;
            this.collection = new ProductReviewsCollection();
            this.collection.itemid = this.item.get('internalid');
            var self = this, reviews_params = this.collection.getReviewParams(this.queryOptions);
            reviews_params.itemid = this.item.get('internalid');
            this.collection.fetch({
                data: reviews_params,
                killerId: this.killerId
            }).done(function () {
                self.updateCannonicalLinks();
                self.render();
                self.collection.on('reset', function () {
                    self.render();
                });
            });
        },
        render: function () {
            this._render();
            this.$('[data-action="pushable"]').scPush();
        },
        getRelPrev: function () {
            var current_page = this.queryOptions && parseInt(this.queryOptions.page) || 1;
            if (current_page > 1) {
                if (current_page === 2) {
                    return this.baseUrl;
                }
                if (current_page > 2) {
                    return this.baseUrl + '?page=' + (current_page - 1);
                }
            }
            return null;
        },
        getRelNext: function () {
            var current_page = this.queryOptions && this.queryOptions.page || 1;
            if (current_page < this.collection.totalPages) {
                return this.baseUrl += '?page=' + (current_page + 1);
            }
            return null;
        },
        getUrlForOption: function (option) {
            var options = {}, sort = option && option.sort || this.queryOptions.sort, filter = option && option.filter || this.queryOptions.filter;
            if (filter) {
                options.filter = filter;
            }
            if (sort) {
                options.sort = sort;
            }
            return this.baseUrl + '?' + jQuery.param(options);
        },
        setupListHeader: function (collection) {
            var sorts = _(Configuration.get('productReviews.sortOptions')).map(function (sort) {
                sort.value = sort.id;
                return sort;
            });
            var filters = _(Configuration.get('productReviews.filterOptions')).map(function (filter) {
                filter.value = filter.id;
                return filter;
            });
            return {
                view: this,
                application: this.application,
                collection: collection,
                sorts: sorts,
                filters: filters,
                avoidFirstFetch: true,
                totalCount: this.item.get('_ratingsCount'),
                customFilterHandler: this.filterOptionsHandler
            };
        },
        updateCannonicalLinks: function () {
            var $head = jQuery('head'), previous_page = this.getRelPrev(), next_page = this.getRelNext();
            $head.find('link[rel="next"], link[rel="prev"]').remove();
            if (previous_page) {
                jQuery('<link/>', {
                    rel: 'prev',
                    href: previous_page
                }).appendTo($head);
            }
            if (next_page) {
                jQuery('<link/>', {
                    rel: 'next',
                    href: next_page
                }).appendTo($head);
            }
        },
        filterOptionsHandler: function (element, elem_sort) {
            if (element.id !== 'all') {
                elem_sort.find('option[value="date"]').prop('selected', true);
                elem_sort.prop('disabled', true);
            } else {
                elem_sort.prop('disabled', false);
            }
        },
        childViews: {
            'ProductReviews.Review': function () {
                return new BackboneCollectionView({
                    collection: this.collection,
                    childView: ProductReviewsReviewView,
                    childViewOptions: _.extend({
                        showActionButtons: true,
                        collection: this.collection
                    }, Configuration.get('productReviews')),
                    viewsPerRow: 1
                });
            },
            'Global.StarRating': function () {
                return new GlobalViewsStarRatingView({
                    model: this.item,
                    showRatingCount: false,
                    showValue: true
                });
            },
            'Global.RatingByStar': function () {
                return new GlobalViewsRatingByStarView({
                    model: this.item,
                    queryOptions: this.queryOptions,
                    baseUrl: this.baseUrl,
                    showPercentage: true,
                    showCount: true
                });
            },
            'GlobalViews.Pagination': function () {
                return new GlobalViewsPaginationView(_.extend({
                    currentPage: this.collection.page || 0,
                    totalPages: this.collection.totalPages || 0,
                    pager: function (page) {
                        return '/' + (page > 1 ? _.setUrlParameter(Backbone.history.fragment, 'page', page) : _.removeUrlParameter(Backbone.history.fragment, 'page'));
                    },
                    extraClass: 'pull-right no-margin-top no-margin-bottom'
                }, Configuration.get('defaultPaginationSettings')));
            },
            'ListHeader.View': function () {
                return new ListHeaderView(this.setupListHeader(this.collection));
            }
        },
        getContext: function () {
            return {
                itemCount: this.item.get('_ratingsCount'),
                hasOneReview: this.item.get('_ratingsCount') === 1,
                itemUrl: this.item.get('_url'),
                pageHeader: this.page_header,
                totalRecords: this.collection.totalRecordsFound
            };
        }
    });
});
define('ProductReviews', [
    'ProductReviews.Router',
    'ProductReviews.Center.View',
    'GlobalViews.StarRating.View',
    'ProductDetails.Full.View'
], function (Router, ProductReviewsCenterView, GlobalViewsStarRatingView, ProductDetailsFullView) {
    'use strict';
    var ProductReviewsModule = {
        mountToApp: function (application) {
            if (SC.ENVIRONMENT.REVIEWS_CONFIG && SC.ENVIRONMENT.REVIEWS_CONFIG.enabled) {
                ProductDetailsFullView.addChildViews({
                    'ProductReviews.Center': function wrapperFunction(options) {
                        return function () {
                            return new ProductReviewsCenterView({
                                item: options.model.get('item'),
                                application: options.application
                            });
                        };
                    }
                });
                ProductDetailsFullView.addChildViews({
                    'Global.StarRating': function wrapperFunction(options) {
                        return function () {
                            return new GlobalViewsStarRatingView({
                                model: options.model.get('item'),
                                showRatingCount: true,
                                showSchemaInfo: true
                            });
                        };
                    }
                });
            }
            return new Router(application);
        }
    };
    return ProductReviewsModule;
});
define('CookieWarningBanner.View', [
    'SC.Configuration',
    'cookie_warning_banner_view.tpl',
    'jQuery',
    'Backbone',
    'jquery.cookie'
], function (Configuration, cookie_warning_banner_view_tpl, jQuery, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: cookie_warning_banner_view_tpl,
        events: { 'click [data-action="close-message"]': 'closeMessage' },
        initialize: function initialize() {
            Backbone.View.prototype.initialize.apply(this, arguments);
            jQuery.cookie.json = true;
        },
        closeMessage: function closeMessage() {
            jQuery.cookie('isCookieWarningClosed', true);
        },
        showBanner: function showBanner() {
            return Configuration.get('siteSettings.showcookieconsentbanner') === 'T' && !(Configuration.get('cookieWarningBanner.saveInCookie', false) && jQuery.cookie('isCookieWarningClosed'));
        },
        getContext: function getContext() {
            return {
                showBanner: this.showBanner(),
                cookieMessage: Configuration.get('cookieWarningBanner.message', ''),
                showLink: !!Configuration.get('siteSettings.cookiepolicy', false),
                linkHref: Configuration.get('siteSettings.cookiepolicy', false),
                linkContent: Configuration.get('cookieWarningBanner.anchorText', ''),
                closable: Configuration.get('cookieWarningBanner.closable', true)
            };
        }
    });
});
define('CookieWarningBanner', [
    'CookieWarningBanner.View',
    'Header.View'
], function (CookieWarningBannerView, HeaderView) {
    'use strict';
    return {
        mountToApp: function (application) {
            HeaderView.addChildViews({
                'Message.Placeholder': function wrapperFunction() {
                    return function () {
                        return new CookieWarningBannerView({ application: application });
                    };
                }
            });
        }
    };
});
define('ImageNotAvailable', [
    'jQuery',
    'Utils'
], function (jQuery, Utils) {
    'use strict';
    return {
        mountToApp: function (application) {
            application.getLayout().on('afterAppendView', function (view) {
                view.$('img').on('error', function () {
                    if (!this.errorCounter) {
                        var $this = jQuery(this), src = application.resizeImage(Utils.getThemeAbsoluteUrlOfNonManagedResources('img/no_image_available.jpeg', application.getConfig('imageNotAvailable')), Utils.getViewportWidth() < 768 ? 'thumbnail' : 'zoom');
                        $this.attr('src', src).attr('data-image-status', 'done');
                        $this.parent('[data-zoom]').length && $this.parent('[data-zoom]').zoom();
                        this.errorCounter = true;
                    }
                });
            });
        }
    };
});
define('Merchandising.Item.Collection', [
    'Item.Collection',
    'Session',
    'underscore',
    'Profile.Model',
    'Utils'
], function (ItemCollection, Session, _, ProfileModel) {
    'use strict';
    return ItemCollection.extend({
        url: function () {
            var profile = ProfileModel.getInstance();
            return _.addParamsToUrl(profile.getSearchApiUrl(), _.extend({}, this.searchApiMasterOptions, Session.getSearchApiParams()), profile.isAvoidingDoubleRedirect());
        }
    });
});
define('Merchandising.Rule', [
    'Singleton',
    'Backbone',
    'Backbone.CachedCollection'
], function (Singleton, Backbone, BackboneCachedCollection) {
    'use strict';
    var MerchandisingRule = {};
    MerchandisingRule.Model = Backbone.Model.extend({});
    MerchandisingRule.Collection = BackboneCachedCollection.extend({
        url: '/dls/services/merchandising.ss',
        model: MerchandisingRule.Model
    }, Singleton);
    return MerchandisingRule;
});
define('Merchandising.Context', ['underscore'], function (_) {
    'use strict';
    var MerchandisingContext = function MerchandisingContext(view) {
        if (view.MerchandisingContext) {
            return view.MerchandisingContext;
        }
        this.view = view;
        view.MerchandisingContext = this;
    };
    _.extend(MerchandisingContext, {
        handlers: [],
        registerHandlers: function (view_constructor, methods) {
            if (view_constructor) {
                var new_handler = _.extend(MerchandisingContext.removeHandler(view_constructor), methods);
                new_handler.viewConstructor = view_constructor;
                MerchandisingContext.handlers.unshift(new_handler);
            }
            return MerchandisingContext;
        },
        removeHandler: function (view_constructor) {
            var removed = {};
            MerchandisingContext.handlers = _.reject(MerchandisingContext.handlers, function (handler) {
                if (handler.viewConstructor === view_constructor) {
                    removed = handler;
                    return true;
                }
            });
            return removed;
        },
        getHandlerForView: function (view) {
            return _.find(MerchandisingContext.handlers, function (handler) {
                return view instanceof handler.viewConstructor;
            });
        },
        escapeValue: function (value) {
            return value ? value.toString().replace(/\s/g, '-') : '';
        },
        callHandler: function (callback_key, context, parameters) {
            var handler = MerchandisingContext.getHandlerForView(context.view);
            return handler && _.isFunction(handler[callback_key]) && handler[callback_key].apply(context, parameters);
        },
        appendFilterValue: function (filters, key, value) {
            if (_.isObject(value) && 'to' in value && 'from' in value) {
                delete filters[key];
                filters[key + '.to'] = value.to;
                filters[key + '.from'] = value.from;
            } else {
                if (_.isUndefined(filters[key])) {
                    filters[key] = '';
                }
                var comma = '';
                if (filters[key]) {
                    comma = ',';
                }
                filters[key] += comma + value;
            }
        }
    });
    _.extend(MerchandisingContext.prototype, {
        callHandler: function (callback_key) {
            return MerchandisingContext.callHandler(callback_key, this, _.toArray(arguments).slice(1));
        },
        getFilters: function (filters, isWithin) {
            var parsed_filters = this.callHandler('getFilters', filters, isWithin);
            if (!parsed_filters) {
                parsed_filters = {};
                _.each(filters, function (values, key) {
                    values = _.without(values, '$current');
                    if (values.length) {
                        _.each(values, function (value) {
                            MerchandisingContext.appendFilterValue(parsed_filters, key, value);
                        });
                    }
                });
            }
            return parsed_filters;
        },
        getIdItemsToExclude: function () {
            return this.callHandler('getIdItemsToExclude') || [];
        }
    });
    return MerchandisingContext;
});
define('Merchandising.View', [
    'merchandising_zone.tpl',
    'merchandising_zone_cell_template.tpl',
    'merchandising_zone_row_template.tpl',
    'SC.Configuration',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'ItemRelations.RelatedItem.View',
    'underscore',
    'Utils',
    'jQuery.bxSlider'
], function (merchandising_zone_tpl, merchandising_zone_cell_template_tpl, merchandising_zone_row_template_tpl, Configuration, Backbone, BackboneCompositeView, BackboneCollectionView, ItemRelationsRelatedItemView, _) {
    'use strict';
    return Backbone.View.extend({
        template: merchandising_zone_tpl,
        initialize: function (options) {
            this.model = options.model;
            this.items = options.items;
            Backbone.View.prototype.initialize.apply(this, arguments);
            BackboneCompositeView.add(this);
            var self = this;
            this.on('afterMerchandAppendToDOM', _.bind(this.initSlider, self));
        },
        childViews: {
            'Zone.Items': function () {
                var itemsCollectionView = new BackboneCollectionView({
                    childView: ItemRelationsRelatedItemView,
                    viewsPerRow: Infinity,
                    cellTemplate: merchandising_zone_cell_template_tpl,
                    rowTemplate: merchandising_zone_row_template_tpl,
                    collection: _.first(this.items.models, this.model.get('show'))
                });
                return itemsCollectionView;
            }
        },
        initSlider: function () {
            var element = this.$el.find('[data-type="carousel-items"]');
            this.$slider = _.initBxSlider(element, Configuration.bxSliderDefaults);
        },
        getContext: function () {
            return {
                zoneTitle: this.model.get('title'),
                isZoneDescription: !!this.model.get('description'),
                zoneDescription: this.model.get('description')
            };
        }
    });
});
define('Merchandising.Zone', [
    'Merchandising.Item.Collection',
    'Merchandising.Rule',
    'Merchandising.Context',
    'Merchandising.View',
    'LiveOrder.Model',
    'underscore',
    'jQuery'
], function (MerchandisingItemCollection, MerchandisingRule, MerchandisingContext, MerchandisingView, LiveOrderModel, _, jQuery) {
    'use strict';
    var MerchandisingZone = function MerchandisingZone(element, options) {
        var application = options && options.application, layout = application && application.getLayout && application.getLayout();
        if (!element || !layout) {
            return;
        }
        this.$element = jQuery(element).empty();
        this.model = MerchandisingRule.Collection.getInstance().get(options.id || this.$element.data('id'));
        if (this.model && this.$element.length && !this.$element.hasClass(this.loadingClassNames)) {
            this.options = options;
            this.application = application;
            this.items = new MerchandisingItemCollection();
            this.context = new MerchandisingContext(layout.modalCurrentView || layout.currentView || layout);
            this.initialize();
        }
    };
    _.extend(MerchandisingZone.prototype, {
        initialize: function () {
            this.addLoadingClass();
            this.addListeners();
            this.items.fetch({
                cache: true,
                data: this.getApiParams()
            });
        },
        addListeners: function () {
            var proxy = jQuery.proxy;
            this.items.on({
                sync: proxy(this.excludeItems, this),
                excluded: proxy(this.appendItems, this),
                appended: proxy(this.removeLoadingClass, this),
                error: proxy(this.handleRequestError, this)
            });
        },
        getApiParams: function () {
            var filters = this.parseApiFilterOptions(), sorting = this.parseApiSortingOptions();
            if (sorting.length) {
                filters.sort = sorting.join(',');
            }
            return _.extend({
                limit: this.getLimit(),
                fieldset: this.model.get('fieldset')
            }, filters);
        },
        parseApiFilterOptions: function () {
            var filters = {};
            _.each(this.model.get('filter'), function (rule_filter) {
                filters[rule_filter.field_id] = rule_filter.field_value;
            });
            return this.context.getFilters(filters, this.model.get('within'));
        },
        parseApiSortingOptions: function () {
            return _.map(this.model.get('sort'), function (value) {
                return value.field_id + ':' + value.dir;
            });
        },
        getLimit: function () {
            var model = this.model, limit = model.get('show'), exclude = model.get('exclude');
            if (exclude.length) {
                if (_.contains(exclude, '$cart')) {
                    limit += LiveOrderModel.getInstance().get('lines').length;
                }
                if (_.contains(exclude, '$current')) {
                    limit += this.context.getIdItemsToExclude().length;
                }
            }
            return limit <= 100 ? limit : 100;
        },
        excludeItems: function () {
            var self = this;
            _.each(this.model.get('exclude'), function (filter) {
                self.applyFilterToItems(filter);
            });
            this.items.trigger('excluded');
            return this;
        },
        applyFilterToItems: function (filter) {
            var items = this.items;
            switch (filter) {
            case '$cart':
                var item = null;
                LiveOrderModel.getInstance().get('lines').each(function (line) {
                    item = line.get('item');
                    items.remove(items.get(item.get('_matrixParent').get('_id') || item.get('_id')));
                });
                break;
            case '$current':
                _.each(this.context.getIdItemsToExclude(), function (id) {
                    items.remove(items.get(id));
                });
                break;
            }
            return this;
        },
        appendItems: function () {
            var items = this.items;
            if (items.length) {
                if (this.model.get('template')) {
                    var amd_optimize_trick_for_require = require;
                    MerchandisingView.prototype.template = amd_optimize_trick_for_require(this.model.get('template'));
                }
                var view = new MerchandisingView({
                    model: this.model,
                    items: items,
                    application: this.application
                });
                view.render();
                this.$element.append(view.$el);
                view.trigger('afterMerchandAppendToDOM');
            }
            items.trigger('appended');
            this.options && this.options.application && this.options.application.getLayout().trigger('afterRender');
            return this;
        },
        loadingClassNames: 'loading loading-merchandising-zone',
        addLoadingClass: function () {
            this.$element.addClass(this.loadingClassNames);
        },
        removeLoadingClass: function () {
            this.$element.removeClass(this.loadingClassNames);
        },
        handleRequestError: function () {
            this.removeLoadingClass();
            console.error('Merchandising Zone - Request Error', arguments);
        }
    });
    return MerchandisingZone;
});
define('Merchandising.jQueryPlugin', [
    'Merchandising.Zone',
    'jQuery'
], function (MerchandisingZone, jQuery) {
    'use strict';
    jQuery.fn.merchandisingZone = function (options) {
        return this.each(function () {
            new MerchandisingZone(this, options);
        });
    };
});
define('Merchandising', [
    'Merchandising.Item.Collection',
    'Merchandising.Rule',
    'Merchandising.jQueryPlugin',
    'underscore'
], function (MerchandisingItemCollection, Rule, jQueryPlugin, _) {
    'use strict';
    return {
        reRenderMerchandizing: function reRenderMerchandizing(application, view) {
            view.$('[data-type="merchandising-zone"]').merchandisingZone({ application: application });
        },
        mountToApp: function (application) {
            if (SC.ENVIRONMENT.MERCHANDISING) {
                var definitions = _.map(SC.ENVIRONMENT.MERCHANDISING, function (value, key) {
                    value.internalid = key;
                    return value;
                });
                Rule.Collection.getInstance().reset(definitions);
                delete SC.ENVIRONMENT.MERCHANDISING;
            }
            MerchandisingItemCollection.prototype.searchApiMasterOptions = application.getConfig('searchApiMasterOptions.merchandisingZone');
            var current_selected_view, self = this;
            application.getLayout().on('afterAppendView', function (view) {
                if (!current_selected_view) {
                    current_selected_view = view;
                } else {
                    current_selected_view.off('afterViewRender', self.reRenderMerchandizing);
                    current_selected_view.off('afterCompositeViewRender', self.reRenderMerchandizing);
                    current_selected_view = view;
                }
                current_selected_view.on(view.childViews ? 'afterCompositeViewRender' : 'afterViewRender', _.bind(self.reRenderMerchandizing, self, application));
                self.reRenderMerchandizing(application, current_selected_view);
            }).on('renderEnhancedPageContent', function (view, content_zone) {
                if (content_zone.contenttype === 'merchandising') {
                    var target = content_zone.target, $view_target = view.$(target), merchandising_zone_options = {
                            application: application,
                            id: content_zone.content
                        };
                    if ($view_target.length) {
                        $view_target.merchandisingZone(merchandising_zone_options);
                    } else {
                        this.$(target).filter(':empty').merchandisingZone(merchandising_zone_options);
                    }
                }
            });
            application.getMerchandisingRules = function getMerchandisingRules() {
                return Rule.Collection.getInstance();
            };
        }
    };
});
define('Merchandising.Context.DefaultHandlers', [
    'Merchandising.Context',
    'Facets.Browse.View',
    'ProductDetails.Base.View',
    'Cart.Detailed.View',
    'Cart.Confirmation.View',
    'underscore'
], function (MerchandisingContext, FacetsBrowseView, ProductDetailsBaseView, CartDetailedView, CartConfirmationView, _) {
    'use strict';
    var DefaultContextHandlers = {
        mergeFilterValues: function (current_values, facet_values) {
            return _.union(_.reject(current_values, function (value) {
                return value === '$current';
            }), facet_values || []);
        },
        parseValues: function (filters, callback) {
            _.each(filters, function (values, key) {
                values = DefaultContextHandlers.mergeFilterValues(values, callback(values, key));
                if (values.length) {
                    _.each(values, function (value) {
                        MerchandisingContext.appendFilterValue(filters, key, value);
                    });
                } else {
                    delete filters[key];
                }
            });
            return filters;
        },
        includeFacetsToFilters: function (facets, filters) {
            var facet_id = '', facet_values = [];
            _.each(facets, function (facet) {
                facet_id = facet.id;
                facet_values = facet.value;
                facet_values = _.isArray(facet_values) ? facet_values : [facet_values];
                if (filters.hasOwnProperty(facet_id)) {
                    facet_values = _.union(filters[facet_id], facet_values);
                }
                filters[facet_id] = facet_values;
            });
            return filters;
        },
        itemListHandlers: {
            getFilters: function (filters, isWithin) {
                var facets = this.view.translator.facets;
                if (isWithin) {
                    filters = DefaultContextHandlers.includeFacetsToFilters(facets, filters);
                }
                return DefaultContextHandlers.parseValues(filters, function (values, key) {
                    var facet_values = [];
                    if (_.contains(values, '$current')) {
                        var current_facet = _.findWhere(facets, { id: key });
                        facet_values = current_facet && current_facet.value || [];
                        if (!_.isArray(facet_values)) {
                            facet_values = [facet_values];
                        }
                    }
                    return facet_values;
                });
            },
            getIdItemsToExclude: function () {
                return this.view.model.get('items').pluck('internalid');
            }
        },
        getItemValues: function (facets, field_id) {
            return _.pluck(_.findWhere(facets, { id: field_id }).values, 'url');
        },
        productDetailsHandlers: {
            getFilters: function (filters, isWithin) {
                var facets = this.view.model.get('facets');
                return DefaultContextHandlers.parseValues(filters, function (values, key) {
                    if (isWithin || _.contains(values, '$current')) {
                        return DefaultContextHandlers.getItemValues(facets, key);
                    }
                });
            },
            getIdItemsToExclude: function () {
                return [this.view.model.getItemId()];
            }
        },
        getCartLineItemValue: function (line, filter_id) {
            var value = line.get('item').get(filter_id), selected_option = line.get('options').findWhere({ itemOptionId: filter_id });
            if (!value) {
                value = selected_option ? selected_option.get('label') : null;
            }
            return value;
        },
        getCartItemValues: function (lines, filter_id) {
            return _.compact(lines.map(function (line) {
                return MerchandisingContext.escapeValue(DefaultContextHandlers.getCartLineItemValue(line, filter_id));
            }));
        },
        cartDetailedHandlers: {
            getFilters: function (filters, isWithin) {
                var lines = this.view.model.get('lines');
                return DefaultContextHandlers.parseValues(filters, function (values, key) {
                    if (isWithin || _.contains(values, '$current')) {
                        return DefaultContextHandlers.getCartItemValues(lines, key);
                    }
                });
            },
            getIdItemsToExclude: function () {
                var item = null;
                return this.view.model.get('lines').map(function (line) {
                    item = line.get('item');
                    return item.get('_matrixParent').get('_id') || item.get('_id');
                });
            }
        },
        cartConfirmationHandlers: {
            getFilters: function (filters, isWithin) {
                var line = this.view.model;
                return DefaultContextHandlers.parseValues(filters, function (values, key) {
                    if (isWithin || _.contains(values, '$current')) {
                        return MerchandisingContext.escapeValue(DefaultContextHandlers.getCartLineItemValue(line, key));
                    }
                });
            },
            getIdItemsToExclude: function () {
                var item = this.view.model.get('item');
                return [item.get('_matrixParent').get('_id') || item.get('_id')];
            }
        },
        mountToApp: function () {
            MerchandisingContext.registerHandlers(FacetsBrowseView, this.itemListHandlers).registerHandlers(ProductDetailsBaseView, this.productDetailsHandlers).registerHandlers(CartDetailedView, this.cartDetailedHandlers).registerHandlers(CartConfirmationView, this.cartConfirmationHandlers);
            return this;
        }
    };
    return DefaultContextHandlers;
});
define('ProductList.Router', [
    'ProductList.Model',
    'ProductList.Details.View',
    'ProductList.Lists.View',
    'ProductList.Item.Collection',
    'underscore',
    'Backbone',
    'Utils'
], function (ProductListModel, ProductListDetailsView, ProductListListsView, ProductListItemCollection, _, Backbone) {
    'use strict';
    return Backbone.Router.extend({
        routes: {
            'wishlist': 'showProductListsList',
            'wishlist/?*options': 'showProductListsList',
            'wishlist/:id': 'showProductListDetails',
            'wishlist/:id/?*options': 'showProductListDetails'
        },
        initialize: function (application) {
            this.application = application;
        },
        showProductListDetails: function (id, options) {
            var prefix = 'tmpl_', self = this, index_of_question = id.indexOf('?'), internalid;
            if (index_of_question !== -1) {
                options = id.substring(index_of_question);
                internalid = parseInt(id, 10);
                if (!isNaN(internalid)) {
                    id = internalid + '';
                }
            }
            var utils = self.application.ProductListModule.Utils;
            if (id.indexOf(prefix) === 0) {
                var template_id = id.substring(prefix.length, index_of_question !== -1 ? index_of_question : id.length), product_lists_promise = utils.getProductLists().fetch();
                product_lists_promise.done(function () {
                    var template_product_list = utils.getProductLists().findWhere({ templateId: template_id }), items = template_product_list.get('items');
                    if (_.isArray(items)) {
                        template_product_list.set('items', new ProductListItemCollection(items));
                    }
                    self.doShowProductListDetails(template_product_list, options);
                });
            } else {
                utils.getProductList(id).done(function (model) {
                    self.doShowProductListDetails(new ProductListModel(model), options);
                });
            }
        },
        doShowProductListDetails: function (model, options) {
            var params_options = _.parseUrlOptions(options), view = new ProductListDetailsView({
                    application: this.application,
                    params: params_options,
                    model: model,
                    includeSortingFilteringHeader: true
                });
            view.showContent();
        },
        showProductListsList: function (options) {
            var self = this;
            this.application.ProductListModule.Utils.getProductListsPromise().done(function () {
                var params_options = _.parseUrlOptions(options), view = new ProductListListsView({
                        application: self.application,
                        params: params_options,
                        collection: self.application.ProductListModule.Utils.getProductLists()
                    });
                view.showContent();
            });
        }
    });
});
define('ProductList', [
    'ProductList.Router',
    'Profile.Model',
    'ProductList.Utils',
    'underscore',
    'Utils'
], function (ProductListRouter, ProfileModel, ProductListUtils, _) {
    'use strict';
    var ProductListModule = function () {
        return {
            mountToApp: function (application) {
                application.ProductListModule = ProductListModule;
                application.ProductListModule.Utils = new ProductListUtils(application);
                ProfileModel.getPromise().done(application.ProductListModule.Utils.profileModelPromiseDone);
                return new ProductListRouter(application);
            },
            MenuItems: function (application) {
                if (!application.ProductListModule.Utils.isProductListEnabled()) {
                    return undefined;
                }
                var loadingList = _('Loading list...').translate();
                var loadingLists = _('Loading lists...').translate();
                return {
                    id: 'product_list_dummy',
                    name: application.ProductListModule.Utils.isSingleList() ? loadingList : loadingLists,
                    url: '',
                    index: 2
                };
            }
        };
    }();
    return ProductListModule;
});
define('CMSadapter.Landing.View', [
    'cms_landing_page.tpl',
    'Backbone'
], function (cms_landing_page_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: cms_landing_page_tpl,
        title: '',
        page_header: '',
        attributes: {
            'id': 'cms-landing-page',
            'class': 'cms-landing-page'
        },
        initialize: function initialize(options) {
            Backbone.View.prototype.initialize.apply(this, arguments);
            this.model = options.model;
        },
        getBreadcrumbPages: function getBreadcrumbPages() {
            var url = this.model.get('url'), path = url[0] === '/' ? url : '/' + url;
            return [{
                    href: path,
                    text: this.model.get('page_title')
                }];
        },
        getContext: function getContext() {
            return {
                inModal: this.inModal,
                title: this.title,
                pageHeader: this.page_header,
                model: this.model
            };
        }
    });
});
define('CMSadapter.Page.Model', ['Backbone'], function (Backbone) {
    'use strict';
    return Backbone.Model.extend({});
});
define('CMSadapter.Page.Collection', [
    'CMSadapter.Page.Model',
    'Backbone'
], function (CMSadapterPageModel, Backbone) {
    'use strict';
    return Backbone.Collection.extend({ model: CMSadapterPageModel });
});
define('CMSadapter.Page.Router', [
    'CMSadapter.Landing.View',
    'CMSadapter.Page.Collection',
    'Backbone'
], function (CMSadapterLandingView, CMSadapterPageCollection, Backbone) {
    'use strict';
    return Backbone.Router.extend({
        routes: {},
        initialize: function initialize(application, collection) {
            this.application = application;
            this.allPages = collection;
            this.landingPages = new CMSadapterPageCollection(collection.filter(function (page) {
                return page.get('type') === 1;
            }) || []);
            var self = this;
            this.landingPages.each(function (landing_page) {
                self.route(landing_page.get('url') + '?*options', 'displayLandingPage');
                self.route(landing_page.get('url'), 'displayLandingPage');
            });
        },
        displayLandingPage: function displayLandingPage(options) {
            var page = this.getPageForFragment();
            var view = new CMSadapterLandingView({
                application: this.application,
                model: page,
                options: options
            });
            view.showContent();
            Backbone.Events.trigger('adapter:page:changed');
        },
        getPageForFragment: function getPageForFragment(fragment, allPages) {
            fragment = fragment || Backbone.history.fragment || '/';
            fragment = fragment.split('?')[0];
            var collection = allPages ? this.allPages : this.landingPages;
            return collection.find(function (page) {
                return page.get('url') === fragment;
            });
        },
        addLandingRoute: function addLandingRoute(page, originalUrl) {
            var originalPage = this.getPageForFragment(originalUrl || page.url);
            if (originalPage) {
                this.landingPages.remove(originalPage);
            }
            this.route(page.url, 'displayLandingPage');
            this.landingPages.add(page);
        }
    });
});
define('CMSadapter.Impl.Enhanced', [
    'Tracker',
    'underscore',
    'Backbone',
    'jQuery'
], function (Tracker, _, Backbone, jQuery) {
    'use strict';
    function AdapterEnhanced(application, router) {
        this.application = application;
        this.router = router;
        var self = this, layout = application.getLayout(), show_content_wrapper = function (fn, view) {
                var promise = jQuery.Deferred();
                var args = arguments;
                var page = router && router.getPageForFragment(Backbone.history.fragment, true);
                view.enhancedPage = true;
                Tracker.getInstance().trackPageview('/' + Backbone.history.fragment);
                fn.apply(layout, Array.prototype.slice.call(args, 1)).done(function () {
                    self.enhancePage(view, layout, page);
                    promise.resolveWith(this, arguments);
                });
                return promise;
            };
        layout.showContent = _.wrap(layout.showContent, show_content_wrapper);
        layout.showInModal = _.wrap(layout.showInModal, show_content_wrapper);
    }
    _.extend(AdapterEnhanced.prototype, {
        enhancePage: function (view, layout, page) {
            var $head = jQuery('head');
            $head.not(':has(title)').append('<title/>').end().not(':has(link[rel="canonical"])').append('<link rel="canonical"/>').end().not(':has(meta[name="keywords"])').append('<meta name="keywords"/>').end().not(':has(meta[name="description"])').append('<meta name="description"/>').end();
            view.title = page && page.get('page_title') || view.getTitle();
            view.metaDescription = page && page.get('meta_description') || view.getMetaDescription();
            view.metaKeywords = page && page.get('meta_keywords') || view.getMetaKeywords();
            var title = view.getTitle();
            if (title) {
                document.title = title;
            }
            if (SC.ENVIRONMENT.jsEnvironment === 'server') {
                $head.find('title').text(title);
            }
            $head.find('meta[name="description"]').attr('content', view.metaDescription || view.getMetaDescription()).end().find('meta[name="keywords"]').attr('content', view.metaKeywords || view.getMetaKeywords()).end().append(view.getMetaTags().not('[name="description"]').not('[name="keywords"]'));
            $head.find('link[rel="canonical"]').attr('href', view.getCanonical()).end().find('link[rel="next"], link[rel="prev"]').remove();
            this.setLinkRel('prev', view.getRelPrev(), $head);
            this.setLinkRel('next', view.getRelNext(), $head);
            var additionToHead = page && page.get('addition_to_head') || view.getAddToHead();
            view.enhancedNodes = [];
            if (additionToHead && jQuery.trim(additionToHead + '')) {
                var $additionToHead = jQuery(additionToHead);
                $additionToHead.each(function () {
                    var $node = jQuery(this);
                    $head.append($node);
                    view.enhancedNodes.push($node);
                });
            }
            view.destroy = _.wrap(view.destroy, function (fn) {
                var args = Array.prototype.slice.call(arguments, 1);
                fn.apply(this, args);
                _.each(this.enhancedNodes, function ($node) {
                    $node.remove();
                });
            });
        },
        setLinkRel: function (rel, link, $head) {
            link && jQuery('<link />', {
                rel: rel,
                href: link
            }).appendTo($head);
        }
    });
    return AdapterEnhanced;
});
define('CMSadapter', [
    'Backbone',
    'CMSadapter.Page.Router',
    'CMSadapter.Page.Collection',
    'CMSadapter.Impl.Enhanced',
    'SC.Configuration',
    'jQuery'
], function (Backbone, CMSadapterPagePageRouter, CMSadapterPagePageCollection, CMSadapterImplEnhanced, Configuration, jQuery) {
    'use strict';
    return {
        mountAdapter: function (application) {
            if (Configuration.get('cms.useCMS')) {
                var router = this.initPageRouter(application), self = this;
                if (typeof CMS === 'undefined' || !CMS.on) {
                    Backbone.Events.on('cms:load', function () {
                        self.initAdapter(application, router);
                    });
                } else {
                    this.initAdapter(application, router);
                }
                this.adapterEnhanced = new CMSadapterImplEnhanced(application, router);
                this.installBackboneViewPlugins();
            }
            return this.postMountAdapter();
        },
        initAdapter: function initAdapter(application, landingRouter) {
            if (typeof CMS === 'undefined') {
                return;
            }
            this.initAdapterImpls(application, CMS, landingRouter);
        },
        initPageRouter: function initPageRouter(application) {
            if (!SC.ENVIRONMENT.CMS || !SC.ENVIRONMENT.CMS.pages) {
                return;
            }
            var collection = new CMSadapterPagePageCollection(SC.ENVIRONMENT.CMS.pages.pages || []);
            return new CMSadapterPagePageRouter(application, collection);
        },
        installBackboneViewPlugins: jQuery.noop,
        initAdapterImpls: jQuery.noop,
        postMountAdapter: jQuery.noop
    };
});
define('CMSadapter.Impl.Core', [
    'underscore',
    'Backbone',
    'jQuery'
], function (_, Backbone, jQuery) {
    'use strict';
    var AdapterCore = function (application, CMS) {
        this.CMS = CMS;
        this.application = application;
        this.init();
        this.listenForCMS();
    };
    AdapterCore.prototype.init = jQuery.noop;
    AdapterCore.prototype.listenForCMS = jQuery.noop;
    AdapterCore.prototype.getSetupOptions = jQuery.noop;
    AdapterCore.prototype.getCmsContext = function getCmsContext() {
        var url = Backbone.history.fragment.split('?')[0], path = url[0] === '/' ? url : '/' + url;
        var context = {
            path: path,
            site_id: this.application.getConfig('siteSettings.siteid'),
            page_type: this.application.getLayout().currentView ? this.application.getLayout().currentView.el.id : ''
        };
        return context;
    };
    return AdapterCore;
});
define('CMSadapter.Impl.Core.v2', [
    'CMSadapter.Impl.Core',
    'SC.Configuration'
], function (CMSadapterImplCore, Configuration) {
    'use strict';
    var CMSadapterImplCore2 = function (application, CMS) {
        CMSadapterImplCore.call(this, application, CMS);
    };
    CMSadapterImplCore2.prototype = Object.create(CMSadapterImplCore.prototype);
    CMSadapterImplCore2.prototype.init = function init() {
        var self = this;
        this.application.getLayout().on('afterAppendView', function () {
            self.CMS.trigger('adapter:page:changed');
        });
        this.CMS.trigger('adapter:ready');
    };
    CMSadapterImplCore2.prototype.listenForCMS = function listenForCMS() {
        var self = this;
        self.CMS.on('adapter:get:setup', function () {
            var setup = self.getSetupOptions();
            CMS.trigger('adapter:got:setup', setup);
        });
        self.CMS.on('adapter:get:context', function () {
            var context = self.getCmsContext();
            self.CMS.trigger('adapter:got:context', context);
        });
    };
    CMSadapterImplCore2.prototype.getSetupOptions = function getSetupOptions() {
        return {
            esc_to_login_disabled: Configuration.get('cms.escToLoginDisabled', false),
            features: [
                'landingPages',
                'categories'
            ]
        };
    };
    return CMSadapterImplCore2;
});
define('CMSadapter.Impl.Landing', [
    'underscore',
    'Backbone',
    'jQuery'
], function (_, Backbone, jQuery) {
    'use strict';
    function AdapterLanding(application, CMS, pageRouter) {
        this.CMS = CMS;
        this.application = application;
        this.pageRouter = pageRouter;
        if (pageRouter) {
            this.listenForCMS();
        }
    }
    AdapterLanding.prototype.listenForCMS = jQuery.noop;
    AdapterLanding.prototype.realoadLandingPages = function (data) {
        var self = this;
        _.each(data.pages, function (page) {
            if (page.type === 1) {
                self.pageRouter.addLandingRoute(page);
            }
        });
    };
    AdapterLanding.prototype.addLandingPages = function (data) {
        this.pageRouter.addLandingRoute(data.page);
        if (data.trigger) {
            Backbone.history.navigate(data.page.url, { trigger: true });
        } else {
            this.CMS.trigger('adapter:page:changed');
        }
    };
    AdapterLanding.prototype.navigateLandingPage = function (data) {
        Backbone.history.navigate(data.url, { trigger: true });
    };
    AdapterLanding.prototype.updateLandingPage = function (data) {
        if (data.saving) {
            if (data.page.type === 1) {
                this.pageRouter.addLandingRoute(data.page, data.original_url);
            }
            if (data.trigger) {
                Backbone.history.navigate(data.page.url, { trigger: false });
                Backbone.history.loadUrl(data.page.url);
            } else {
                this.CMS.trigger('adapter:page:changed');
            }
        }
    };
    return AdapterLanding;
});
define('CMSadapter.Impl.Landing.v2', ['CMSadapter.Impl.Landing'], function (CMSadapterImplLanding) {
    'use strict';
    var CMSadapterImplLanding2 = function (application, CMS, pageRouter) {
        CMSadapterImplLanding.call(this, application, CMS, pageRouter);
    };
    CMSadapterImplLanding2.prototype = Object.create(CMSadapterImplLanding.prototype);
    CMSadapterImplLanding2.prototype.listenForCMS = function listenForCMS() {
        var self = this;
        self.CMS.on('adapter:landing:pages:reload', function (data, callback) {
            callback(self.realoadLandingPages(data));
        });
        self.CMS.on('adapter:landing:pages:add', function (data, callback) {
            callback(self.addLandingPages(data));
        });
        self.CMS.on('adapter:landing:page:navigate', function (data, callback) {
            callback(self.navigateLandingPage(data));
        });
        self.CMS.on('adapter:landing:page:update', function (data, callback) {
            callback(self.updateLandingPage(data));
        });
    };
    return CMSadapterImplLanding2;
});
define('Categories.Collection', [
    'Backbone',
    'underscore',
    'Utils',
    'SC.Configuration'
], function (Backbone, _, Utils, Configuration) {
    'use strict';
    return Backbone.Collection.extend({
        url: function () {
            var url = _.addParamsToUrl(Utils.getAbsoluteUrl('services/Categories.Service.ss'), { 'menuLevel': Configuration.get('categories.menuLevel') });
            return url;
        },
        initialize: function () {
        }
    });
});
define('CMSadapter.Impl.Categories', [
    'Facets.Model',
    'Facets.Helper',
    'Facets.Browse.View',
    'Facets.Router',
    'Categories',
    'Categories.Model',
    'Categories.Collection',
    'AjaxRequestsKiller',
    'jQuery',
    'underscore',
    'Backbone'
], function (FacetsModel, FacetsHelper, FacetsBrowseView, FacetsRouter, Categories, CategoriesModel, CategoriesCollection, AjaxRequestsKiller, jQuery, _, Backbone) {
    'use strict';
    function AdapterCategories(application, CMS) {
        this.CMS = CMS;
        this.application = application;
        this.listenForCMS();
    }
    AdapterCategories.prototype.listenForCMS = jQuery.noop;
    AdapterCategories.prototype._convertToCategory = function _convertToCategory(categoryData) {
        return {
            'name': categoryData.name,
            'description': categoryData.description,
            'pagetitle': categoryData.page_title,
            'pageheading': categoryData.page_header,
            'pagebanner': '',
            'addtohead': categoryData.add_to_head,
            'metakeywords': categoryData.meta_keywords,
            'metadescription': categoryData.meta_description,
            'categories': [],
            'breadcrumb': [{
                    'name': categoryData.name,
                    'fullurl': ''
                }]
        };
    };
    AdapterCategories.prototype.showCategory = function (categoryData, functionToCallback) {
        var self = this;
        var translatorConfig = this.application.translatorConfig;
        var fullurl = categoryData.urls && categoryData.urls.length && categoryData.urls[0] === 'temp_cms_new_category_url' ? '' : Backbone.history.fragment;
        var translator = FacetsHelper.parseUrl(fullurl, translatorConfig, true);
        var categoryModel = new CategoriesModel(this._convertToCategory(categoryData));
        var facetsModel = new FacetsModel({
            'items': [],
            'facets': [],
            'total': 0
        });
        facetsModel.set('category', categoryModel);
        facetsModel.fetch({
            data: translator.getApiParams(),
            killerId: AjaxRequestsKiller.getKillerId()
        }).done(function () {
            var view = new FacetsBrowseView({
                translator: translator,
                translatorConfig: translatorConfig,
                application: self.application,
                model: facetsModel
            });
            translator.setLabelsFromFacets(facetsModel.get('facets') || []);
            view.showContent();
            functionToCallback();
        });
    };
    AdapterCategories.prototype.updateCategory = function (data, application, functionToCallback) {
        if (data.saving) {
            var collection = new CategoriesCollection();
            collection.fetch().done(function (menu) {
                Categories.addToNavigationTabs(menu);
                if (!data.category.parents.length && (!data.category.last_modified || data.original_url !== data.category.urls[0])) {
                    var router = new FacetsRouter(application);
                    router.addUrl(data.category.urls, 'categoryLoading');
                }
                functionToCallback();
            });
        } else {
            this.showCategory(data.category, functionToCallback);
        }
    };
    AdapterCategories.prototype.removeCategory = function (functionToCallback) {
        var collection = new CategoriesCollection();
        collection.fetch().done(function (menu) {
            Categories.addToNavigationTabs(menu);
            Backbone.history.navigate('/', { trigger: true });
            functionToCallback();
        });
    };
    AdapterCategories.prototype.navigate = function (data, functionToCallback) {
        var categoryModel = new CategoriesModel();
        categoryModel.options = {
            data: { 'fullurl': data.url[0] !== '/' ? '/' + data.url : data.url },
            killerId: AjaxRequestsKiller.getKillerId()
        };
        var self = this;
        categoryModel.fetch({}).done(function (cat) {
            self.category = cat;
            Backbone.history.navigate(data.url, { trigger: false });
            Backbone.history.loadUrl(data.url);
            functionToCallback();
        });
    };
    AdapterCategories.prototype.getItems = function (filters, cmsFieldset, functionToCallback) {
        var model = new FacetsModel(cmsFieldset);
        model.fetch({
            data: _.extend(filters, {}),
            killerId: AjaxRequestsKiller.getKillerId()
        }).done(function () {
            var items = [];
            model.get('items').each(function (item) {
                items.push({
                    name: item.get('_name'),
                    internal_id: item.get('internalid'),
                    unique_identifier: '' + item.get('internalid'),
                    price: item.get('_price_formatted'),
                    image_url: item.get('_thumbnail').url
                });
            });
            functionToCallback(items);
        });
    };
    return AdapterCategories;
});
define('CMSadapter.Impl.Categories.v2', [
    'CMSadapter.Impl.Categories',
    'SC.Configuration'
], function (CMSadapterImplCategories, Configuration) {
    'use strict';
    var CMSadapterImplCategories2 = function (application, CMS) {
        CMSadapterImplCategories.call(this, application, CMS);
    };
    CMSadapterImplCategories2.prototype = Object.create(CMSadapterImplCategories.prototype);
    CMSadapterImplCategories2.prototype.listenForCMS = function listenForCMS() {
        var self = this;
        self.CMS.on('adapter:category:add', function (data, callback) {
            self.showCategory(data.category, callback);
        });
        self.CMS.on('adapter:category:item:update', function (data, callback) {
            callback();
        });
        self.CMS.on('adapter:category:update', function (data, callback) {
            self.updateCategory(data, self.application, callback);
        });
        self.CMS.on('adapter:category:hierarchy:change', function (data, callback) {
            callback();
        });
        self.CMS.on('adapter:category:remove', function (data, callback) {
            self.removeCategory(callback);
        });
        self.CMS.on('adapter:category:reload', function (data, callback) {
            callback();
        });
        self.CMS.on('adapter:category:navigate', function (data, callback) {
            self.navigate(data, callback);
        });
        self.CMS.on('adapter:get:items', function (filters) {
            var facet_model_params = { searchApiMasterOptions: Configuration.get('searchApiMasterOptions.CmsAdapterSearch') };
            self.getItems(filters, facet_model_params, function (items) {
                self.CMS.trigger('adapter:got:items', items);
            });
        });
    };
    return CMSadapterImplCategories2;
});
define('CMSadapter.v2', [
    'CMSadapter',
    'CMSadapter.Impl.Core.v2',
    'CMSadapter.Impl.Landing.v2',
    'CMSadapter.Impl.Categories.v2',
    'underscore'
], function (CMSadapter, CMSadapterImplCore2, CMSadapterImplLanding2, CMSadapterImplCategories2, _) {
    'use strict';
    return _.extend({}, CMSadapter, {
        initAdapterImpls: function initAdapterImpls(application, cmsObject, landingRouter) {
            this.adapterCore = new CMSadapterImplCore2(application, cmsObject);
            this.adapterLanding = new CMSadapterImplLanding2(application, cmsObject, landingRouter);
            this.adapterCategories = new CMSadapterImplCategories2(application, cmsObject);
        }
    });
});
define('CMSadapter.Impl.Core.v3', [
    'CMSadapter.Impl.Core',
    'SC.Configuration'
], function (CMSadapterImplCore, Configuration) {
    'use strict';
    var CMSadapterImplCore3 = function (application, CMS) {
        CMSadapterImplCore.call(this, application, CMS);
    };
    CMSadapterImplCore3.prototype = Object.create(CMSadapterImplCore.prototype);
    CMSadapterImplCore3.prototype.init = function init() {
        var self = this;
        this.application.getLayout().on('afterAppendView', function () {
            self.CMS.trigger('app:page:changed');
        });
        this.CMS.trigger('app:ready');
    };
    CMSadapterImplCore3.prototype.listenForCMS = function listenForCMS() {
        var self = this;
        self.CMS.on('config:get', function (promise) {
            promise.resolve(self.getSetupOptions());
        });
        self.CMS.on('context:get', function (promise) {
            var context = self.getCmsContext();
            promise.resolve(context);
        });
    };
    CMSadapterImplCore3.prototype.getSetupOptions = function getSetupOptions() {
        return {
            esc_to_login_disabled: Configuration.get('cms.escToLoginDisabled', false),
            features: [
                'landingPages',
                'categories',
                'customContentTypes'
            ],
            app_content_override: [
                'html',
                'image',
                'text',
                'merchzone'
            ]
        };
    };
    return CMSadapterImplCore3;
});
define('CMSadapter.Impl.Landing.v3', ['CMSadapter.Impl.Landing'], function (CMSadapterImplLanding) {
    'use strict';
    var CMSadapterImplLanding3 = function (application, CMS, pageRouter) {
        CMSadapterImplLanding.call(this, application, CMS, pageRouter);
    };
    CMSadapterImplLanding3.prototype = Object.create(CMSadapterImplLanding.prototype);
    CMSadapterImplLanding3.prototype.listenForCMS = function listenForCMS() {
        var self = this;
        self.CMS.on('landing-pages:reload', function (promise, data) {
            self.realoadLandingPages(data);
            promise.resolve();
        });
        self.CMS.on('landing-pages:add', function (promise, data) {
            self.addLandingPages(data);
            promise.resolve();
        });
        self.CMS.on('landing-pages:navigate', function (promise, data) {
            self.navigateLandingPage(data);
            promise.resolve();
        });
        self.CMS.on('landing-pages:update', function (promise, data) {
            self.updateLandingPage(data);
            promise.resolve();
        });
        self.CMS.on('landing-pages:remove', function (promise) {
            promise.resolve();
        });
    };
    return CMSadapterImplLanding3;
});
define('CMSadapter.Impl.Categories.v3', ['CMSadapter.Impl.Categories'], function (CMSadapterImplCategories) {
    'use strict';
    var CMSadapterImplCategories3 = function (application, CMS) {
        CMSadapterImplCategories.call(this, application, CMS);
    };
    CMSadapterImplCategories3.prototype = Object.create(CMSadapterImplCategories.prototype);
    CMSadapterImplCategories3.prototype.listenForCMS = function listenForCMS() {
        var self = this;
        self.CMS.on('categories:add', function (promise, data) {
            self.showCategory(data.category, promise);
        });
        self.CMS.on('categories:item:update', function (promise) {
            promise.resolve();
        });
        self.CMS.on('categories:update', function (promise, data) {
            self.updateCategory(data, self.application, function () {
                promise.resolve();
            });
        });
        self.CMS.on('categories:hierarchy:change', function (promise) {
            promise.resolve();
        });
        self.CMS.on('categories:remove', function (promise) {
            self.removeCategory(function () {
                promise.resolve();
            });
        });
        self.CMS.on('categories:reload', function (promise) {
            promise.resolve();
        });
        self.CMS.on('categories:navigate', function (promise, data) {
            self.navigate(data, function () {
                promise.resolve();
            });
        });
        self.CMS.on('items:search', function (promise, filters) {
            self.getItems(filters, null, function (items) {
                promise.resolve(items);
            });
        });
    };
    return CMSadapterImplCategories3;
});
define('CustomContentType.Container.View', [
    'custom_content_type_container.tpl',
    'Backbone'
], function (custom_content_type_container_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: custom_content_type_container_tpl,
        childViews: {
            'CCT-View': function () {
                return this.options.innerCustomContentType;
            }
        },
        getContext: function getContext() {
            return {
                instanceId: this.options.instanceId,
                classes: this.options.classes
            };
        }
    });
});
define('CMSadapter.Component', [
    'CustomContentType.Container.View',
    'Utils',
    'underscore',
    'jQuery'
], function (CustomContentTypeContainerView, Utils, _, jQuery) {
    'use strict';
    var placeholder_views = {};
    var view_ccts_to_rerender = {};
    return {
        componentName: 'CMS',
        _customContentTypes: {},
        _customContentTypesInstances: {},
        _createError: function _createError(error_code, error_message) {
            return {
                title: error_code,
                message: error_message
            };
        },
        _installContent: function _installContent(cct, cct_settings, context_data) {
            var self = this;
            return jQuery.when(cct.install(cct_settings, context_data)).then(function () {
                return jQuery.Deferred().resolve();
            }, function (e) {
                var message = e && _.isFunction(e.toString) && e.toString() || _('Unknown error installing CCT. CCT Instance Id: $(0)').translate(cct.instanceId);
                return jQuery.Deferred().reject(self._createError('ERR_INSTALLING_CCT', message));
            });
        },
        _updateSettings: function _updateSettings(cct, cct_settings) {
            var self = this;
            return jQuery.when(cct.update(cct_settings)).then(function () {
                return jQuery.Deferred().resolve();
            }, function (e) {
                var message = e && _.isFunction(e.toString) && e.toString() || _('Unknown error updating CCT. CCT Instance Id: $(0)').translate(cct.instanceId);
                return jQuery.Deferred().reject(self._createError('ERR_UPDATING_CCT', message));
            });
        },
        _addViewCctsToRerender: function _addViewCctsToRerender(view, cctGenerator) {
            if (view.template && view.template.Name) {
                if (_.isUndefined(view_ccts_to_rerender[view.template.Name])) {
                    view_ccts_to_rerender[view.template.Name] = [];
                }
                view_ccts_to_rerender[view.template.Name].push(cctGenerator);
            }
        },
        placeholderViews: function placeholderViews() {
            return placeholder_views;
        },
        resetPlaceholderViews: function resetPlaceholderViews() {
            placeholder_views = {};
        },
        registerCustomContentType: function registerCustomContentType(cct) {
            this._customContentTypes[cct.id.toLowerCase()] = cct.view;
        },
        addContents: function addContents(ccts) {
            var self = this, old_instances = _.keys(this._customContentTypesInstances), async_operations = [];
            view_ccts_to_rerender = {};
            ccts = self._sortCCTs(ccts);
            _.each(_.keys(this._customContentTypesInstances), function (old_instance_id) {
                var selector = self._customContentTypesInstances[old_instance_id].length && self._customContentTypesInstances[old_instance_id][0].selector, views = selector && self.getPlaceholderViews(selector), old_instance = self._customContentTypesInstances[old_instance_id];
                if (old_instance && old_instance.length > 1 || views && views.length > 1) {
                    self.removeContent(old_instance_id, true);
                    old_instances.splice(_.indexOf(old_instances, old_instance_id), 1);
                } else {
                    self.removeContent(old_instance_id, false);
                }
            });
            _.each(ccts, function (cct) {
                if (_.indexOf(old_instances, cct.instance_id) >= 0) {
                    _.each(self._customContentTypesInstances[cct.instance_id], function (cct_container) {
                        var generator = {}, container_name = cct_container.selector['data-cms-area'];
                        generator[container_name] = {};
                        generator[container_name][cct.instance_id] = {
                            childViewIndex: 1000 + parseInt(cct.render_settings.position, 10),
                            childViewConstructor: null,
                            childViewInstance: cct_container.container,
                            childViewSelector: cct_container.selector
                        };
                        var parent_view_instance = cct_container.parent;
                        parent_view_instance.addChildViewInstances(generator, true);
                        self._addViewCctsToRerender(parent_view_instance, generator);
                    });
                    old_instances.splice(_.indexOf(old_instances, cct.instance_id), 1);
                } else {
                    async_operations.push(self.addContent(cct.id, cct.instance_id, cct.selector, cct.settings, cct.render_settings));
                }
            });
            _.each(old_instances, function (old_instance_id) {
                async_operations.push(self.removeContent(old_instance_id, true));
            });
            return jQuery.when.apply(jQuery, async_operations);
        },
        addContent: function addContent(cct_id, cct_instance_id, cct_selector, cct_settings, render_settings) {
            var self = this, selector = this.getPlaceholder(cct_selector), container = selector ? this.getPlaceholderViews(self.selectorToString(selector)) : null, async_operations = [];
            cct_id = cct_id.toLowerCase();
            if (!selector || !container.views || !container.views.length) {
                return jQuery.Deferred().resolve();
            } else if (!self._customContentTypes[cct_id]) {
                return jQuery.Deferred().resolve();
            } else if (self._customContentTypesInstances[cct_instance_id] && self._customContentTypesInstances[cct_instance_id].length) {
                return jQuery.Deferred().reject(self._createError('ERR_INVALID_INSTANCE_ID', _('There is already a CCT with the Instance Id $(0). Unable to add CCT: Id: $(1). CCT Instance Id: $(2). Placeholder: $(3)').translate(cct_instance_id, cct_id, cct_instance_id, self.selectorToString(cct_selector))));
            } else {
                if (!self._customContentTypesInstances[cct_instance_id]) {
                    self._customContentTypesInstances[cct_instance_id] = [];
                }
                _.each(container.views, function (parent_view_instance) {
                    var cct_constructor = self._customContentTypes[cct_id], cct_instance = new cct_constructor({
                            id: cct_id,
                            instanceId: cct_instance_id
                        }), cct_container_instance = new CustomContentTypeContainerView({
                            innerCustomContentType: cct_instance,
                            instanceId: cct_instance_id,
                            classes: render_settings.classes
                        });
                    var contextData = parent_view_instance.getContextData(cct_instance.getContextDataRequest());
                    if (cct_instance.validateContextDataRequest(contextData)) {
                        self._customContentTypesInstances[cct_instance_id].push({
                            cct: cct_instance,
                            parent: parent_view_instance,
                            container: cct_container_instance,
                            selector: container.selector,
                            render_settings: render_settings
                        });
                        async_operations.push(self._installContent(cct_instance, cct_settings, contextData));
                        var generator = {}, container_name = container.selector['data-cms-area'];
                        cct_container_instance.isCCT = true;
                        generator[container_name] = {};
                        generator[container_name][cct_instance_id] = {
                            childViewIndex: 1000 + parseInt(render_settings.position, 10),
                            childViewConstructor: null,
                            childViewInstance: cct_container_instance,
                            childViewSelector: container.selector
                        };
                        parent_view_instance.addChildViewInstances(generator, true);
                        self._addViewCctsToRerender(parent_view_instance, generator);
                    } else {
                        async_operations.push(jQuery.Deferred().reject(self._createError('ERR_CONTEXTNOTFOUND_CCT', _('Context for CCT not found. CCT Instance Id: $(0)').translate(cct_instance_id))));
                    }
                });
                return jQuery.when.apply(jQuery, async_operations);
            }
        },
        updateContent: function updateContent(cct_instance_id, cct_selector, cct_settings, render_settings) {
            var self = this, cct_views_container = self._customContentTypesInstances[cct_instance_id], selector = self.getPlaceholder(cct_selector), async_operations = [];
            if (cct_views_container) {
                var first_cct_container = cct_views_container[0];
                if (!_.isEqual(first_cct_container.selector, cct_selector)) {
                    if (!selector) {
                        return jQuery.Deferred().reject(self._createError('ERR_INVALID_SELECTOR', _('Invalid selector. The current view does not contains the specified selector: $(0)').translate(self.selectorToString(cct_selector))));
                    } else {
                        var cct_id = first_cct_container.cct.id;
                        self.removeContent(cct_instance_id, true);
                        return self.addContent(cct_id, cct_instance_id, cct_selector, cct_settings, render_settings);
                    }
                } else {
                    _.each(cct_views_container, function (cct_container) {
                        var cct_container_instance = cct_container.container, parent_view_instance = cct_container.parent;
                        async_operations.push(self._updateSettings(cct_container.cct, cct_settings));
                        if (!_.isEqual(first_cct_container.render_settings, render_settings)) {
                            var generator = {}, container_name = cct_container.selector['data-cms-area'];
                            generator[container_name] = {};
                            generator[container_name][cct_instance_id] = {
                                childViewIndex: 1000 + parseInt(render_settings.position, 10),
                                childViewConstructor: null,
                                childViewInstance: cct_container_instance,
                                childViewSelector: cct_container.selector
                            };
                            parent_view_instance.updateChildViewInstances(generator, true);
                            cct_container.render_settings = render_settings;
                        } else {
                            cct_container.cct.render();
                        }
                    });
                    return jQuery.when.apply(jQuery, async_operations);
                }
            }
            return jQuery.Deferred().reject(self._createError('ERR_INVALID_INSTANCE_ID', _('Invalid content type instance id: $(0)').translate(cct_instance_id)));
        },
        _sortCCTs: function _sortCCTs(ccts) {
            var self = this;
            ccts.sort(function (cct_a, cct_b) {
                var cct_a_selector = self.getPlaceholder(cct_a.selector), cct_b_selector = self.getPlaceholder(cct_b.selector);
                var cct_a_key = cct_a_selector ? self.selectorToString(cct_a_selector) : '', cct_b_key = cct_b_selector ? self.selectorToString(cct_b_selector) : '';
                if (cct_a_key === cct_b_key) {
                    return parseInt(cct_a.render_settings.position, 10) - parseInt(cct_b.render_settings.position, 10);
                } else {
                    return cct_a_key < cct_b_key ? 1 : 0;
                }
            });
            return ccts;
        },
        removeContent: function removeContent(cct_instance_id, destroy_call) {
            var cct_views_generator = this._customContentTypesInstances[cct_instance_id], async_operations = [];
            if (cct_views_generator) {
                _.each(cct_views_generator, function (cct_generator) {
                    async_operations.push(cct_generator.parent.removeChildViewInstance(cct_generator.selector['data-cms-area'], cct_generator.cct.instanceId, destroy_call));
                });
                if (destroy_call) {
                    delete this._customContentTypesInstances[cct_instance_id];
                }
                return jQuery.when.apply(jQuery, async_operations);
            }
            return jQuery.Deferred().reject(this._createError('ERR_INVALID_INSTANCE_ID', _('The specified instance id is not registered. Instance Id: $(0)').translate(cct_instance_id)));
        },
        getContentIds: function getContentIds() {
            return _.keys(this._customContentTypes);
        },
        selectorToString: function selectorToString(placeholder) {
            var str = '';
            _.each(placeholder, function (value, key) {
                str += '[' + key + '="' + value + '"]';
            });
            return str;
        },
        getPlaceholder: function getPlaceholder(placeholder) {
            var selector_data = _.find(placeholder_views, function (obj) {
                return _.isEqual(placeholder, obj.selector);
            });
            if (selector_data) {
                return selector_data.selector;
            } else {
                return selector_data;
            }
        },
        registerViewForPlaceholder: function registerViewForPlaceholder(placeholders, view) {
            var self = this;
            _.each(placeholders, function (selector) {
                var existent_selector = self.getPlaceholder(selector);
                if (existent_selector) {
                    var key_existent = self.selectorToString(existent_selector);
                    if (_.indexOf(placeholder_views[key_existent].views, view) < 0) {
                        placeholder_views[key_existent].views.push(view);
                    }
                } else {
                    var key = self.selectorToString(selector);
                    placeholder_views[key] = {
                        selector: selector,
                        views: [view]
                    };
                }
            });
        },
        unregisterViewForPlaceholders: function unregisterViewForPlaceholders(view) {
            _.each(placeholder_views, function (placeholder, key, selector_views_context) {
                selector_views_context[key].views = _.without(placeholder.views, view);
            });
        },
        getPlaceholderViews: function getPlaceholderViews(placeholder) {
            return placeholder_views[placeholder] || null;
        },
        getViewCctsToRerender: function getViewCctsToRerender(view) {
            if (view.template && view.template.Name) {
                var cct_generators = view_ccts_to_rerender[view.template.Name];
                return _.isUndefined(cct_generators) ? [] : cct_generators;
            }
            return [];
        }
    };
});
define('CMSadapter.Impl.CustomContentType', [
    'CMSadapter.Component',
    'underscore'
], function (CMSadapterComponent, _) {
    'use strict';
    function AdapterCustomContentType(application, CMS) {
        this.CMS = CMS;
        this.application = application;
        this.listenForCMS();
    }
    _.extend(AdapterCustomContentType.prototype, {
        listenForCMS: function listenForCMS() {
            var self = this;
            self.CMS.on('page:content:set', function (promise, ccts) {
                CMSadapterComponent.addContents(_.map(ccts, function (cct) {
                    return {
                        id: cct.type,
                        instance_id: cct.instance_id,
                        selector: { 'data-cms-area': cct.context.area },
                        settings: cct.settings,
                        render_settings: {
                            position: cct.context.sequence,
                            classes: cct.classes
                        }
                    };
                })).then(promise.resolve, promise.reject);
            });
            self.CMS.on('content:types:get', function (promise) {
                var content_types = _.map(CMSadapterComponent.getContentIds(), function (cct_id) {
                    return { type: cct_id };
                });
                promise.resolve(content_types);
            });
            self.CMS.on('content:add', function (promise, cct) {
                CMSadapterComponent.addContent(cct.type, cct.instance_id, { 'data-cms-area': cct.context.area }, cct.settings, {
                    position: cct.context.sequence,
                    classes: cct.classes
                }).then(promise.resolve, promise.reject);
            });
            self.CMS.on('content:update', function (promise, cct) {
                CMSadapterComponent.updateContent(cct.instance_id, { 'data-cms-area': cct.context.area }, cct.settings, {
                    position: cct.context.sequence,
                    classes: cct.classes
                }).then(promise.resolve, promise.reject);
            });
            self.CMS.on('content:remove', function (promise, cct) {
                CMSadapterComponent.removeContent(cct.instance_id, true).then(promise.resolve, promise.reject);
            });
        }
    });
    return AdapterCustomContentType;
});
define('CMSadapter.Plugin.RecollectCMSSelectors', ['underscore'], function (_) {
    'use strict';
    return function CMSadapterPluginRecollectCMSSelectorsGenerator(component) {
        return {
            name: 'recollectCMSSelectors',
            priority: 10,
            execute: function (tmpl_str, view) {
                var unregister = function () {
                    component.unregisterViewForPlaceholders(view);
                };
                view.off('destroy', unregister).on('destroy', unregister);
                var regex = /<[^\/>]*(data-cms-area)=\"([^"\s]+)\"[^\/>]*>/g, match = regex.exec(tmpl_str), selectors_on_ui = [], selector, isEqual = function (obj) {
                        return _.isEqual(obj, selector);
                    };
                component.unregisterViewForPlaceholders(view);
                while (match !== null) {
                    selector = { 'data-cms-area': match[2] };
                    if (!_.find(selectors_on_ui, isEqual)) {
                        selectors_on_ui.push(selector);
                    } else {
                        console.warn('Repeated selector ' + component.selectorToString(selector) + ' in template ' + view.template.Name);
                    }
                    match = regex.exec(tmpl_str);
                }
                if (selectors_on_ui.length > 0) {
                    component.registerViewForPlaceholder(selectors_on_ui, view);
                }
                return tmpl_str;
            }
        };
    };
});
define('CMSadapter.Plugin.PostRender', ['underscore'], function (_) {
    'use strict';
    return function CMSadapterPluginPostRender(component) {
        return {
            name: 'cmsPostRender',
            priority: 10,
            execute: function (tmpl_str, view) {
                var cct_generators = component.getViewCctsToRerender(view);
                _.each(cct_generators, function (cct_generator) {
                    view.addChildViewInstances(cct_generator, true);
                });
            }
        };
    };
});
define('CMSadapter.v3', [
    'Backbone',
    'CMSadapter',
    'CMSadapter.Impl.Core.v3',
    'CMSadapter.Impl.Landing.v3',
    'CMSadapter.Impl.Categories.v3',
    'CMSadapter.Impl.CustomContentType',
    'CMSadapter.Plugin.RecollectCMSSelectors',
    'CMSadapter.Plugin.PostRender',
    'CMSadapter.Component',
    'underscore'
], function (Backbone, CMSadapter, CMSadapterImplCore3, CMSadapterImplLanding3, CMSadapterImplCategories3, CMSadapterImplCustomContentType, CMSadapterPluginRecollectCMSSelectors, CMSadapterPluginPostRender, CMSadapterComponent, _) {
    'use strict';
    return _.extend({}, CMSadapter, {
        installBackboneViewPlugins: function installBackboneViewPlugins() {
            Backbone.View.postCompile.install(CMSadapterPluginRecollectCMSSelectors(CMSadapterComponent));
            Backbone.View.postRender.install(CMSadapterPluginPostRender(CMSadapterComponent));
        },
        initAdapterImpls: function initAdapterImpls(application, cmsObject, landingRouter) {
            this.adapterCore = new CMSadapterImplCore3(application, CMS);
            this.adapterLanding = new CMSadapterImplLanding3(application, CMS, landingRouter);
            this.adapterCategories = new CMSadapterImplCategories3(application, CMS);
            this.adapterCustomContentTypes = new CMSadapterImplCustomContentType(application, cmsObject);
        },
        postMountAdapter: function postMountAdapter() {
            return CMSadapterComponent;
        }
    });
});
define('CMSadapterInstaller', [
    'CMSadapter',
    'CMSadapter.v2',
    'CMSadapter.v3',
    'SC.Configuration'
], function (CMSadapter, CMSadapter2, CMSadapter3, Configuration) {
    'use strict';
    return {
        mountToApp: function (application) {
            var cms_adapter_version = Configuration.get('cms.adapterVersion'), cms_adapter = null;
            switch (cms_adapter_version) {
            case '2':
                cms_adapter = CMSadapter2;
                break;
            case '3':
                cms_adapter = CMSadapter3;
                break;
            }
            if (cms_adapter) {
                return cms_adapter.mountAdapter(application);
            }
        }
    };
});
define('RequestQuoteAccessPoints.HeaderLink.View', [
    'requestquote_accesspoints_headerlink.tpl',
    'Backbone'
], function (requestquote_accesspoints_headerlink_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: requestquote_accesspoints_headerlink_tpl,
        getContext: function () {
            return {
                hasClass: !!this.options.className,
                className: this.options.className
            };
        }
    });
});
define('RequestQuoteAccessPoints', [
    'RequestQuoteAccessPoints.HeaderLink.View',
    'Header.View',
    'Header.Menu.View'
], function (RequestQuoteWizardHeaderLinkView, HeaderView, HeaderMenuView) {
    'use strict';
    return {
        mountToApp: function () {
            HeaderView.addChildViews && HeaderView.addChildViews({
                'RequestQuoteWizardHeaderLink': function wrapperFunction() {
                    return function () {
                        return new RequestQuoteWizardHeaderLinkView({});
                    };
                }
            });
            HeaderMenuView.addChildViews && HeaderMenuView.addChildViews({
                'RequestQuoteWizardHeaderLink': function wrapperFunction() {
                    return function () {
                        return new RequestQuoteWizardHeaderLinkView({ className: ' ' });
                    };
                }
            });
            return void 0;
        }
    };
});
define('QuickOrderAccessPoints.HeaderLink.View', [
    'Backbone',
    'underscore',
    'SC.Configuration',
    'quickorder_accesspoints_headerlink.tpl'
], function (Backbone, _, Configuration, quickorder_accesspoints_headerlink_tpl) {
    'use strict';
    return Backbone.View.extend({
        template: quickorder_accesspoints_headerlink_tpl,
        getContext: function () {
            return {
                hasClass: !!this.options.className,
                className: this.options.className,
                cartTouchPoint: _.getPathFromObject(Configuration, 'modulesConfig.Cart.startRouter', false) ? Configuration.currentTouchpoint : 'viewcart'
            };
        }
    });
});
define('QuickOrderAccessPoints', [
    'QuickOrderAccessPoints.HeaderLink.View',
    'Header.View',
    'Header.Menu.View'
], function (QuickOrderHeaderLinkView, HeaderView, HeaderMenuView) {
    'use strict';
    return {
        mountToApp: function () {
            HeaderView.addChildViews && HeaderView.addChildViews({
                'QuickOrderHeaderLink': function wrapperFunction() {
                    return function () {
                        return new QuickOrderHeaderLinkView({});
                    };
                }
            });
            HeaderMenuView.addChildViews && HeaderMenuView.addChildViews({
                'QuickOrderHeaderLink': function wrapperFunction() {
                    return function () {
                        return new QuickOrderHeaderLinkView({ className: ' ' });
                    };
                }
            });
            return void 0;
        }
    };
});
define('BrontoIntegration', [
    'SC.Configuration',
    'jQuery'
], function (Configuration, jQuery) {
    'use strict';
    return {
        instanceId: '',
        adapterUrl: '',
        loadScript: function () {
            jQuery('body').append(jQuery('<script src="' + this.adapterUrl + '" data-bronto-integrations="' + this.instanceId + '"></script>'));
        },
        mountToApp: function (application) {
            if (SC.ENVIRONMENT.jsEnvironment === 'browser') {
                var bronto_config = Configuration.bronto;
                if (bronto_config && bronto_config.accountId) {
                    this.instanceId = bronto_config.accountId;
                    this.adapterUrl = bronto_config.adapterUrl;
                    application.getLayout().once('afterAppendView', jQuery.proxy(this, 'loadScript'));
                }
            }
        }
    };
});
define('Sensors.DataExtractor', [
    'Profile.Model',
    'Session',
    'Backbone',
    'jQuery',
    'underscore',
    'Utils'
], function (ProfileModel, Session, Backbone, jQuery, _, Utils) {
    'use strict';
    return {
        site: {
            once: false,
            extract: function (application) {
                var site_data = {
                        sitePage: '',
                        siteUrl: '',
                        siteFragment: ''
                    }, layout = application.getLayout(), site_data_promise = jQuery.Deferred(), view_id = layout.getCurrentView() && layout.getCurrentView().getPageDescription();
                if (view_id) {
                    site_data.sitePage = view_id;
                }
                site_data.siteUrl = window.location.href;
                site_data.siteFragment = Backbone.history.fragment;
                return site_data_promise.resolve(site_data);
            }
        },
        cart: {
            once: false,
            extract: function (application) {
                var cart_data = { cartLines: '' }, cart_data_promise = jQuery.Deferred();
                application.getCart().done(function (cart) {
                    cart_data.cartLines = cart.get('lines').length + '';
                    cart_data_promise.resolve(cart_data);
                }).fail(function () {
                    cart_data_promise.resolve(cart_data);
                });
                return cart_data_promise;
            }
        },
        bundle: {
            once: true,
            extract: function () {
                var bundle_data_promise = jQuery.Deferred(), bundle_metadata = {}, release_metadata = SC.ENVIRONMENT.RELEASE_METADATA || {};
                bundle_metadata.bundleId = release_metadata.bundle_id || '';
                bundle_metadata.bundleName = release_metadata.name || '';
                bundle_metadata.bundleVersion = release_metadata.version || '';
                bundle_metadata.buildNo = release_metadata.buildno || '';
                bundle_metadata.dateLabel = release_metadata.datelabel || '';
                bundle_metadata.baseLabel = release_metadata.baselabel || '';
                return bundle_data_promise.resolve(bundle_metadata);
            }
        },
        customer: {
            once: false,
            extract: function () {
                var profile_model = ProfileModel.getInstance(), isGuest = profile_model.get('isGuest') === 'T', isLoggedIn = !isGuest && profile_model.get('isLoggedIn') === 'T', isRecognized = !isGuest && profile_model.get('isRecognized') === 'T', isReturning = !isGuest && isLoggedIn, isNew = !isGuest && !isRecognized && !isLoggedIn, customer_data = {};
                customer_data.customerSessionStatus = isNew ? 'New' : isReturning ? 'Returning' : isGuest ? 'Guest' : isRecognized ? 'Recognized' : '';
                var regex = new RegExp('[; ]NLVisitorId=([^\\s;]*)');
                var sMatch = (' ' + document.cookie).match(regex);
                customer_data.visitorId = sMatch ? unescape(sMatch[1]) : '';
                return jQuery.Deferred().resolve(customer_data);
            }
        },
        shopper: {
            once: false,
            extract: function () {
                var shopper_data = {
                        shopperInternalId: '',
                        currencyCode: ''
                    }, profile_instance = ProfileModel.getInstance();
                var shopper_id = profile_instance.get('internalid');
                if (shopper_id && shopper_id !== '0') {
                    shopper_data.shopperInternalId = shopper_id;
                }
                shopper_data.currencyCode = Session.get('currency.code') || '';
                return jQuery.Deferred().resolve(shopper_data);
            }
        },
        device: {
            once: false,
            extract: function () {
                return jQuery.Deferred().resolve({ device: Utils.getDeviceType() });
            }
        },
        error_status: {
            once: false,
            extract: function (application) {
                var current_view = application.getLayout().getCurrentView(), errorData = current_view.isErrorView && (current_view.getPageDescription() || 'error');
                return jQuery.Deferred().resolve({ errorStatus: errorData });
            }
        }
    };
});
define('Sensors', [
    'Sensors.DataExtractor',
    'SC.Configuration',
    'jQuery',
    'underscore',
    'Backbone'
], function (SensorsDataExtractor, Configuration, jQuery, _, Backbone) {
    'use strict';
    var sensors_module = {
        nlrum: null,
        dataExtractor: SensorsDataExtractor,
        loadScript: function () {
            var self = this;
            window.NLRUM = window.NLRUM || {};
            window.NLRUM.bSendBeacon = 0;
            window.NLRUM.bResourceTimingDataCollection = 1;
            jQuery.getScript('/nlrum/nlRUM.js').done(function () {
                if (!window.NLRUM.addSCData) {
                    console.log('NLRUM has not defined addSCData');
                    return;
                }
                self.nlrum = window.NLRUM;
                self.sendData(true);
            }).fail(function () {
                console.log('nlRUM.js failed to load');
            });
        },
        getMetadata: function (isFirstLoad) {
            var data = {}, data_promises = [], metadata_promise = jQuery.Deferred(), self = this;
            _.each(this.dataExtractor, function (extractor) {
                if (extractor.extract && (isFirstLoad || !extractor.once)) {
                    data_promises.push(extractor.extract(self.application));
                }
            });
            jQuery.when.apply(jQuery, data_promises).done(function () {
                _.each(arguments, function (argument) {
                    if (argument) {
                        _.extend(data, argument);
                    }
                });
                metadata_promise.resolve(data);
            });
            return metadata_promise;
        },
        sendData: function (isFirstLoad) {
            var promise = jQuery.Deferred();
            if (this.nlrum && this.nlrum.addSCData) {
                var self = this;
                this.getMetadata(isFirstLoad).done(function (data) {
                    data.linkType = isFirstLoad ? 'direct' : 'indirect';
                    self.nlrum.addSCData(data);
                    self.trigger('nlrum:sendData', data, self);
                    promise.resolve(data);
                });
            }
            return promise;
        },
        mountToApp: function (application) {
            if (!(SC.ENVIRONMENT.jsEnvironment === 'browser' && SC.ENVIRONMENT.SENSORS_ENABLED)) {
                return;
            }
            this.application = application;
            var self = this;
            application.getLayout().on('afterAppendView', function (view) {
                self.handleAfterAppendView(application, view);
                if (!self.nlrum) {
                    self.loadScript();
                } else {
                    self.sendData(false);
                }
            });
            self.registerNavigationEvents(application);
            if (self.debug) {
                self.on('nlrum:sendData', _.bind(self.debugLog, self));
            }
        },
        registerNavigationEvents: function (application) {
            var self = this;
            Backbone.history.on('all', _.bind(this.handleNavigationEventStart, this));
            application.getLayout().mouseDown && application.getLayout().mouseDown.install({
                execute: function () {
                    self.handleNavigationEventStart();
                }
            });
            application.getLayout().on('afterAppendView', function (view) {
                view && view.$el.on('mousedown', function () {
                    self.handleNavigationEventStart();
                });
            });
        },
        handleNavigationEventStart: function () {
            this.userNavigateEventLastTime = new Date().getTime();
            window.NLRUM && window.NLRUM.markIndirectStart && window.NLRUM.markIndirectStart();
            this.handleAfterAppendViewCounter = 0;
        },
        userNavigateEventLastTime: new Date().getTime(),
        handleAfterAppendViewCounter: 0,
        handleAfterAppendView: function () {
            var showContentTime = new Date().getTime() - this.userNavigateEventLastTime;
            var extractor = {
                once: false,
                value: { showContentTime: showContentTime },
                extract: function () {
                    return jQuery.Deferred().resolve(this.value);
                }
            };
            this.dataExtractor.showContentTime = extractor;
            this.handleAfterAppendViewCounter++;
            if (this.handleAfterAppendViewCounter > 1) {
                delete this.dataExtractor.showContentTime;
            }
        },
        debug: false,
        debugRows: [
            'siteFragment',
            'sitePage',
            'showContentTime',
            'errorStatus'
        ],
        debugLog: function (data) {
            data = _.isArray(data) ? data : [data];
            var self = this, filteredData = _.map(data, function (entry) {
                    return _.pick.apply(_, [entry].concat(self.debugRows));
                });
            console.table(filteredData);
        }
    };
    _.extend(sensors_module, Backbone.Events);
    return sensors_module;
});
define('QuantityPricing.Utils', ['underscore'], function (_) {
    'use strict';
    return {
        rearrangeQuantitySchedule: function rearrangeQuantitySchedule(item, children_selection) {
            var price_schedule_exists_in_matrix_child = _.find(children_selection, function (child_item) {
                    return child_item.get('_priceDetails').priceschedule;
                }), price_schedule_exists_in_matrix_parent = item && item.get('_priceDetails') && item.get('_priceDetails').priceschedule && item.get('_priceDetails').priceschedule.length;
            if (price_schedule_exists_in_matrix_parent || price_schedule_exists_in_matrix_child) {
                var parent_quantity_schedule = item.get('_priceDetails').priceschedule, result_quantity_pricing = [];
                if (children_selection && children_selection.length === 1) {
                    result_quantity_pricing = _.first(children_selection).get('_priceDetails').priceschedule;
                } else if (children_selection && children_selection.length > 1) {
                    var children_quantity_pricing = _.map(children_selection, function (child) {
                            return child.get('_priceDetails') && child.get('_priceDetails').priceschedule || [];
                        }), reference_quantity_pricing = _.first(children_quantity_pricing), self = this, all_children_are_equal = _.every(children_quantity_pricing, function (child_quantity_pricing) {
                            return self.areQuantityPricingEqual(reference_quantity_pricing, child_quantity_pricing);
                        });
                    result_quantity_pricing = all_children_are_equal ? self.computeRanges(children_quantity_pricing) : false;
                } else {
                    result_quantity_pricing = parent_quantity_schedule;
                }
                if (result_quantity_pricing) {
                    result_quantity_pricing = _.map(result_quantity_pricing, function (price_range) {
                        return {
                            maximumquantity: price_range.maximumquantity ? price_range.maximumquantity - 1 : price_range.maximumquantity,
                            minimumquantity: price_range.minimumquantity,
                            price: price_range.price,
                            price_formatted: price_range.price_formatted,
                            price_range: price_range.price_range,
                            is_range: !!price_range.is_range
                        };
                    });
                    _.first(result_quantity_pricing).minimumquantity = _.first(result_quantity_pricing).minimumquantity || 1;
                }
                return result_quantity_pricing;
            }
            return false;
        },
        computeRanges: function computeRanges(quantity_pricings) {
            var ranges = [];
            _.each(quantity_pricings, function (quantity_pricing) {
                ranges = ranges.concat(quantity_pricing);
            });
            var grouped_ranges = _.groupBy(ranges, function (range) {
                return range.minimumquantity;
            });
            var result = [];
            _.each(grouped_ranges, function (ranges) {
                var max = _.max(_.pluck(ranges, 'price')), min = _.min(_.pluck(ranges, 'price')), is_range = min !== max, range = {
                        maximumquantity: _.first(ranges).maximumquantity,
                        minimumquantity: _.first(ranges).minimumquantity,
                        price: is_range ? -1 : _.first(ranges).price,
                        price_formatted: is_range ? '' : _.first(ranges).price_formatted,
                        is_range: is_range,
                        price_range: is_range ? {
                            max: max,
                            min: min,
                            max_formatted: _.findWhere(ranges, { price: max }).price_formatted,
                            min_formatted: _.findWhere(ranges, { price: min }).price_formatted
                        } : null
                    };
                result.push(range);
            });
            return result;
        },
        areQuantityPricingEqual: function areQuantityPricingEqual(quantity_pricing_original, quantity_pricing_to_compare) {
            if (quantity_pricing_to_compare && quantity_pricing_original && quantity_pricing_original.length === quantity_pricing_to_compare.length) {
                var are_equal = true;
                for (var i = 0; i < quantity_pricing_original.length; i++) {
                    if (quantity_pricing_original[i].maximumquantity !== quantity_pricing_to_compare[i].maximumquantity || quantity_pricing_original[i].minimumquantity !== quantity_pricing_to_compare[i].minimumquantity) {
                        are_equal = false;
                    }
                }
                return are_equal;
            }
            return false;
        }
    };
});
define('QuantityPricing.View', [
    'QuantityPricing.Utils',
    'SC.Configuration',
    'Profile.Model',
    'quantity_pricing.tpl',
    'Backbone',
    'underscore'
], function (QuantityPricingUtils, Configuration, ProfileModel, quantity_pricing_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: quantity_pricing_tpl,
        events: { 'click [data-action="toggle"]': 'toggleAccordion' },
        initialize: function () {
            this.profileModel = ProfileModel.getInstance();
            this._isEnabled = !(Configuration.getRegistrationType() !== 'disabled' && SC.getSessionInfo('loginToSeePrices') && this.profileModel.get('isLoggedIn') !== 'T');
            this.price_schedule = QuantityPricingUtils.rearrangeQuantitySchedule(this.model.get('item'), _.isFunction(this.model.getSelectedMatrixChilds) ? this.model.getSelectedMatrixChilds() : []);
            this.model.on('change', function () {
                var new_price_schedule = QuantityPricingUtils.rearrangeQuantitySchedule(this.model.get('item'), _.isFunction(this.model.getSelectedMatrixChilds) ? this.model.getSelectedMatrixChilds() : []);
                if (!_.isEqual(this.price_schedule, new_price_schedule)) {
                    this.price_schedule = new_price_schedule;
                    this.render();
                }
            }, this);
            this.item_key = this.model.get('item').id + '' + new Date().getMilliseconds();
        },
        _isEnabled: false,
        _isOpen: false,
        toggleAccordion: function () {
            this._isOpen = !this._isOpen;
        },
        getContext: function () {
            return {
                isAccordion: !this.options.notUseAccordion,
                showContent: this._isEnabled && !!this.price_schedule,
                priceSchedule: this.price_schedule,
                isOpen: this._isOpen,
                isModal: this.options.isModal,
                itemKey: this.item_key
            };
        }
    });
});
define('RequestQuoteWizard.Module.Items.Line.Quantity.View', [
    'requestquote_wizard_module_items_line_quantity.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'underscore'
], function (requestquote_wizard_module_items_line_quantity_tpl, Backbone, BackboneCompositeView, _) {
    'use strict';
    return Backbone.View.extend({
        template: requestquote_wizard_module_items_line_quantity_tpl,
        events: {
            'click [data-action="plus"]': 'addQuantity',
            'click [data-action="minus"]': 'subQuantity',
            'change [data-type="quantity-input"]': 'changeQuantity',
            'keypress [data-type="quantity-input"]': 'submitOnEnter'
        },
        initialize: function () {
            BackboneCompositeView.add(this);
        },
        submitOnEnter: function (e) {
            if (e.keyCode === 13) {
                e.preventDefault(e);
            }
        },
        addQuantity: function (e) {
            e.preventDefault();
            var newQuantity = parseInt(this.$('[data-type="quantity-input"]').val(), 10) + 1;
            this.$('[data-type="quantity-input"]').val(newQuantity);
            this.setQuantity();
        },
        subQuantity: function (e) {
            e.preventDefault();
            var newQuantity = parseInt(this.$('[data-type="quantity-input"]').val(), 10) - 1;
            if (newQuantity) {
                this.$('[data-type="quantity-input"]').val(newQuantity);
                this.setQuantity();
            }
        },
        changeQuantity: _.debounce(function () {
            this.setQuantity();
        }, 500),
        setQuantity: function () {
            var str_quantity = this.$('[data-type="quantity-input"]').val(), line_pricing, quantity = parseInt(str_quantity, 10);
            if (!_.isNaN(quantity) && _.isNumber(quantity)) {
                quantity < this.model.get('item').get('_minimumQuantity', true) && (quantity = this.model.get('item').get('_minimumQuantity', true), this.$('[data-type="quantity-input"]').val(quantity));
                this.model.set('quantity', quantity, { silent: true });
                line_pricing = this.model.getPrice();
                this.model.set('rate_formatted', line_pricing.price_formatted);
                quantity > 1 ? this.$('[data-action="minus"]').removeAttr('disabled') : this.$('[data-action="minus"]').attr('disabled', true);
            } else {
                this.render();
            }
        },
        getContext: function () {
            var minimum_quantity = this.model.get('item').get('_minimumQuantity', true);
            return {
                model: this.model,
                lineId: this.model.get('internalid'),
                isMinusButtonDisabled: this.model.get('quantity') <= minimum_quantity || this.model.get('quantity') === 1,
                showMinimumQuantity: minimum_quantity > 1,
                minimumQuantity: minimum_quantity
            };
        }
    });
});
define('ReorderItems.Actions.Quantity.View', [
    'reorder_items_actions_quantity.tpl',
    'Backbone',
    'Backbone.CompositeView',
    'jQuery'
], function (reorder_items_actions_quantity_tpl, Backbone, BackboneCompositeView, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: reorder_items_actions_quantity_tpl,
        initialize: function (options) {
            this.line = options.model;
            BackboneCompositeView.add(this);
        },
        events: {
            'click [data-action="plus"]': 'addQuantity',
            'click [data-action="minus"]': 'subQuantity'
        },
        addQuantity: function (e) {
            e.preventDefault();
            var $element = jQuery(e.target), oldValue = $element.parent().find('input').val(), newVal = parseFloat(oldValue) + 1;
            $element.parent().find('input').val(newVal);
        },
        subQuantity: function (e) {
            e.preventDefault();
            var $element = jQuery(e.target), oldValue = $element.parent().find('input').val(), newVal = parseFloat(oldValue) - 1;
            newVal = Math.max(1, newVal);
            $element.parent().find('input').val(newVal);
        },
        getContext: function () {
            var item = this.line.get('item'), minimum_quantity = item.get('_minimumQuantity', true) || 1, itemQuantity = this.line.get('quantity') > minimum_quantity ? this.line.get('quantity') : minimum_quantity;
            return {
                line: this.line,
                showQuantityInput: !!item.get('_isPurchasable'),
                lineId: this.line.get('internalid'),
                itemQuantity: itemQuantity,
                showLastPurchased: !!this.line.get('trandate'),
                showMinimumQuantity: minimum_quantity > 1,
                minimumQuantity: minimum_quantity
            };
        }
    });
});
define('QuantityPricing', [
    'QuantityPricing.View',
    'ProductDetails.Full.View',
    'RequestQuoteWizard.Module.Items.Line.Quantity.View',
    'ReorderItems.Actions.Quantity.View',
    'ProductDetails.QuickView.View',
    'Cart.Item.Summary.View'
], function (QuantityPricingView, ProductDetailsFullView, RequestQuoteWizardModuleItemsLineQuantityView, ReorderItemsActionsQuantityView, ProductDetailsQuickViewView, CartItemSummaryView) {
    'use strict';
    return {
        mountToApp: function () {
            if (SC.ENVIRONMENT.siteSettings.quantitypricing) {
                ProductDetailsFullView.addChildViews && ProductDetailsFullView.addChildViews({
                    'Quantity.Pricing': function wrapperFunction(options) {
                        return function () {
                            return new QuantityPricingView({
                                notUseAccordion: false,
                                model: options.model
                            });
                        };
                    }
                });
                RequestQuoteWizardModuleItemsLineQuantityView.addChildViews && RequestQuoteWizardModuleItemsLineQuantityView.addChildViews({
                    'Quantity.Pricing': function wrapperFunction(options) {
                        return function () {
                            return new QuantityPricingView({
                                notUseAccordion: true,
                                model: options.model
                            });
                        };
                    }
                });
                ReorderItemsActionsQuantityView.addChildViews && ReorderItemsActionsQuantityView.addChildViews({
                    'Quantity.Pricing': function wrapperFunction(options) {
                        return function () {
                            return new QuantityPricingView({
                                notUseAccordion: true,
                                model: options.model
                            });
                        };
                    }
                });
                ProductDetailsQuickViewView.addChildViews && ProductDetailsQuickViewView.addChildViews({
                    'Quantity.Pricing': function wrapperFunction(options) {
                        return function () {
                            return new QuantityPricingView({
                                notUseAccordion: false,
                                model: options.model
                            });
                        };
                    }
                });
                CartItemSummaryView.addChildViews && CartItemSummaryView.addChildViews({
                    'Quantity.Pricing': function wrapperFunction(options) {
                        return function () {
                            return new QuantityPricingView({
                                notUseAccordion: false,
                                model: options.model
                            });
                        };
                    }
                });
            }
        }
    };
});
define('QuickAdd.Model', [
    'SC.Configuration',
    'Transaction.Line.Model',
    'underscore'
], function (Configuration, TransactionLineModel, _) {
    'use strict';
    var QuickAddModel = TransactionLineModel.extend({
        initialize: function () {
            TransactionLineModel.prototype.initialize.apply(this, arguments);
            this.options = {};
        },
        setOptions: function (options) {
            this.options = options || this.options;
            return this;
        },
        setItemQuantityGetter: function (get_item_quantity_set) {
            this.options.getItemQuantitySet = get_item_quantity_set;
        },
        clone: function () {
            var result = new QuickAddModel(this.toJSON());
            result.setOptions(this.options);
            return result;
        },
        validation: {
            quickaddSearch: {
                fn: function (val) {
                    var product = this.get('selectedProduct'), item = product && product.get('item');
                    if (!(product && (product.getSku() === val || item.get('_name') === val))) {
                        return _('Begin typing SKU to select an item').translate();
                    }
                }
            },
            quantity: {
                fn: function (val) {
                    if (!val) {
                        return _('Enter quantity').translate();
                    }
                    var product = this.get('selectedProduct'), selectedItem = product && product.getItem();
                    if (selectedItem) {
                        var already_set_quantity = _.isFunction(this.options.getItemQuantitySet) ? this.options.getItemQuantitySet(selectedItem.id) : 0;
                        if (already_set_quantity + this.get('quantity') < selectedItem.get('_minimumQuantity', true)) {
                            return _('The minimum quantity for this item is $(0).').translate(selectedItem.get('_minimumQuantity', true));
                        }
                    }
                }
            }
        }
    });
    return QuickAddModel;
});
define('QuickAdd.Item.View', [
    'ItemsSearcher.Item.View',
    'underscore'
], function (ItemsSearcherItemView, _) {
    'use strict';
    return ItemsSearcherItemView.extend({
        getContext: function getContext() {
            return _.extend(ItemsSearcherItemView.prototype.getContext.apply(this, arguments), this.options.areResults ? { thumbnail: this.model.getThumbnail() } : {});
        }
    });
});
define('QuickAdd.ItemsSearcher.Plugins', [
    'Item.Model',
    'Product.Model',
    'Product.Collection',
    'underscore'
], function (ItemModel, ProductModel, ProductCollection, _) {
    'use strict';
    return {
        flatItemsMatrixResult: {
            name: 'flatItemsMatrixResult',
            priotity: 10,
            execute: function (collection, configuration) {
                var products = [], new_product, item_options, internalid_counter = 1;
                collection.each(function (item) {
                    if (item.get('isinstock') || (item.get('isbackorderable') || configuration.showBackorderables)) {
                        if (item.get('_matrixChilds') && item.get('_matrixChilds').length) {
                            item_options = item.get('options').where({ isMatrixDimension: true });
                            item.get('_matrixChilds').each(function (child_item) {
                                new_product = new ProductModel({ item: new ItemModel(_.extend({}, item.attributes)) });
                                _.each(item_options, function (option) {
                                    var selected_child_item_option_label = child_item.get(option.get('itemOptionId')), selected_option_value_object = _.findWhere(option.get('values'), { label: selected_child_item_option_label });
                                    new_product.setOption(option.get('cartOptionId'), selected_option_value_object.internalid);
                                });
                                new_product.getItem().set('itemimages_detail', item.get('itemimages_detail'));
                                new_product.set('isfulfillable', item.get('isfulfillable'));
                                new_product.set('internalid', internalid_counter++);
                                products.push(new_product);
                            });
                        } else {
                            products.push(new ProductModel({
                                item: item,
                                internalid: internalid_counter++
                            }));
                        }
                    }
                });
                products = _.filter(products, function (product) {
                    var query_on_sku = (product.getSku() ? product.getSku().toUpperCase() : '').indexOf(configuration.query.toUpperCase()) >= 0, query_on_name = (product.get('item').get('_name') ? product.get('item').get('_name').toUpperCase() : '').indexOf(configuration.query.toUpperCase()) >= 0, item_not_gift_certificate = product.get('item').get('itemtype') !== 'GiftCert';
                    return item_not_gift_certificate && (query_on_name || query_on_sku);
                });
                return new ProductCollection(_.first(products, configuration.limit));
            }
        }
    };
});
define('QuickAdd.View', [
    'SC.Configuration',
    'ItemsSearcher.View',
    'QuickAdd.Model',
    'QuickAdd.Item.View',
    'Backbone.FormView',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'Transaction.Line.Views.Options.Selected.View',
    'ProductViews.Price.View',
    'ProductLine.Stock.View',
    'QuickAdd.ItemsSearcher.Plugins',
    'Transaction.Line.Model',
    'ProductLine.Sku.View',
    'quick_add.tpl',
    'quick_add_item.tpl',
    'Backbone',
    'underscore',
    'Utils'
], function (Configuration, ItemsSearcherView, QuickAddModel, QuickAddItemView, BackboneFormView, BackboneCompositeView, BackboneCollectionView, TransactionLineViewsOptionsSelectedView, ProductViewsPriceView, ProductLineStockView, QuickAddItemsSearcherPlugins, TransactionLineModel, ProductLineSkuView, quick_add_tpl, quick_add_item_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: quick_add_tpl,
        events: {
            'click [data-type="quick-add-reset"]': 'resetHandle',
            'submit form': 'saveForm',
            'click [data-action="plus"]': 'addQuantity',
            'click [data-action="minus"]': 'subQuantity',
            'change [data-type="quantity-input"]': 'setQuantity',
            'click [data-type="quantity-input"]': 'selectAll',
            'keypress [name="quantity"]': 'submitOnEnter',
            'keydown [name="quantity"]': 'onKeyDown'
        },
        initialize: function () {
            this.itemsSearcherComponent = new ItemsSearcherView({
                placeholderLabel: _('Enter SKU or Item Name').translate(),
                showBackorderables: this.options.showBackorderable,
                minLength: Configuration.get('typeahead.minLength', 3),
                maxLength: Configuration.get('searchPrefs.maxLength', 0),
                limit: Configuration.get('typeahead.maxResults', 10),
                sort: Configuration.get('typeahead.sort', 'relevance:asc'),
                highlight: Configuration.get('typeahead.highlight', true),
                componentId: 'quickaddSearch',
                componentName: 'quickaddSearch',
                showMenuOnClick: true,
                showSeeAll: false,
                collectionOptions: { searcherAPIConfiguration: 'searchApiMasterOptions.itemsSearcher' },
                itemView: QuickAddItemView,
                itemViewOptions: {
                    template: quick_add_item_tpl,
                    childViews: {
                        'Item.Options': function (options) {
                            return function () {
                                return new TransactionLineViewsOptionsSelectedView({ model: options.model });
                            };
                        },
                        'Item.Price': function (options) {
                            return function () {
                                return new ProductViewsPriceView({ model: options.model });
                            };
                        },
                        'Item.Stock': function (options) {
                            return function () {
                                return new ProductLineStockView({ model: options.model });
                            };
                        },
                        'Item.Sku': function (options) {
                            return function () {
                                return new ProductLineSkuView({ model: options.model });
                            };
                        }
                    }
                },
                getItemDisplayName: function (item, query) {
                    return item ? item.getSku() : query;
                }
            });
            this.itemsSearcherComponent.postItemsSuggestionObtained.install(QuickAddItemsSearcherPlugins.flatItemsMatrixResult);
            this.model = new QuickAddModel();
            this.model.setItemQuantityGetter(this.options.getItemQuantitySet);
            this.itemsSearcherComponent.on('itemSelected', this.onItemSelected, this);
            this.itemsSearcherComponent.on('keyUp', this.showReset, this);
            this.itemsSearcherComponent.on('keyDown', this.cleanSearchOnEnter, this);
            var original_save_form = this.saveForm;
            BackboneCompositeView.add(this);
            BackboneFormView.add(this);
            this.saveForm = original_save_form;
        },
        saveForm: function (e) {
            e.preventDefault();
            Backbone.Validation.bind(this);
            this.model.set(this.$('form').serializeObject());
            var product = this.model.get('selectedProduct');
            if (this.model.isValid(true) && product) {
                product.set('quantity', parseInt(this.model.get('quantity'), 10));
                var selected_line = new TransactionLineModel(product.toJSON());
                selected_line.set('internalid', _.uniqueId('item_line'));
                selected_line.set('item', product.getItem().clone());
                selected_line.set('options', product.get('options').clone());
                if (product.get('item').get('_matrixChilds').length) {
                    selected_line.get('item').set('_matrixParent', product.get('item'));
                }
                selected_line.unset('selectedProduct');
                selected_line.unset('quickaddSearch');
                this.trigger('selectedLine', { selectedLine: selected_line });
                this.$('[name="quantity"]').val('');
                this.$('[name="quantity"]').attr({ 'min': 1 });
                this.$('[data-type="quick-add-reset"]').hide();
                this.itemsSearcherComponent.cleanSearch();
                this.itemsSearcherComponent.setFocus();
            }
        },
        setQuantity: function (e) {
            if (this.model.get('selectedProduct')) {
                var str_quantity = this.$(e.target).val(), quantity = parseInt(str_quantity, 10), minimum_quantity = this.model.get('selectedProduct').get('item').get('_minimumQuantity', true), quantity_already_set = 0;
                if (_.isFunction(this.options.getItemQuantitySet)) {
                    quantity_already_set = this.options.getItemQuantitySet(this.model.get('selectedProduct').getItemId()) || 0;
                }
                if (!_.isNaN(quantity) && _.isNumber(quantity)) {
                    if (quantity_already_set + quantity < minimum_quantity) {
                        this.$('[data-type="quantity-input"]').val(minimum_quantity);
                    }
                }
            }
        },
        addQuantity: function (e) {
            e.preventDefault();
            var $element = this.$(e.target), quantity_input = $element.parent().find('input'), old_value = quantity_input.val(), new_val = parseFloat(old_value) + 1;
            quantity_input.val(new_val);
            quantity_input.change();
        },
        subQuantity: function (e) {
            e.preventDefault();
            var $element = this.$(e.target), quantity_input = $element.parent().find('input'), old_value = quantity_input.val(), new_val = parseFloat(old_value) - 1;
            new_val = Math.max(this.model.get('selectedProduct').get('item').get('_minimumQuantity', true), new_val);
            quantity_input.val(new_val);
            quantity_input.change();
        },
        showReset: function (event_properties) {
            if (event_properties.currentQuery) {
                this.$('[data-type="quick-add-reset"]').show();
            } else {
                this.$('[data-type="quick-add-reset"]').hide();
            }
        },
        cleanSearchOnEnter: function (event_properties) {
            if (event_properties.eventObject.keyCode === 27) {
                this.$('[data-type="quick-add-reset"]').hide();
                this.itemsSearcherComponent.cleanSearch();
            }
        },
        onKeyDown: function (e) {
            var key_code = e.which ? e.which : event.keyCode;
            if (key_code > 31 && (key_code < 48 || key_code > 57) && !(key_code >= 37 || key_code <= 40)) {
                e.preventDefault();
            }
        },
        submitOnEnter: function (e) {
            if (e.keyCode === 13) {
                this.itemsSearcherComponent.setFocus();
            }
        },
        resetHandle: function () {
            this.$('[data-type="quick-add-reset"]').hide();
            this.itemsSearcherComponent.cleanSearch();
            this.$('[name="quantity"]').val('');
        },
        selectAll: function () {
            this.$('[name="quantity"]').select();
        },
        onItemSelected: function (result) {
            var product = result.selectedItem, item;
            if (product) {
                item = product.getItem();
                this.model.set('quickaddSearch', item.get('_name'));
                this.model.set('selectedProduct', product);
                this.setDefaultQuantity(item.get('_minimumQuantity', true), item.get('internalid'));
                this.$('[name="quantity"]').focus();
                this.selectAll();
                var minimum_quantity = item.get('_minimumQuantity', true);
                if (minimum_quantity > 1) {
                    this.$('[data-type="minimum-quantity"]').html(_('Minimum of $(0) required').translate(minimum_quantity));
                }
                this.$('[data-validation-error="block"]').remove();
            } else {
                this.model.unset('selectedProduct');
                this.$('[data-type="minimum-quantity"]').empty();
            }
        },
        setDefaultQuantity: function (minimum_quantity, item_id) {
            var current_quantity = parseInt(this.$('[name="quantity"]').val(), 10);
            this.$('[name="quantity"]').select();
            if (_.isFunction(this.options.getItemQuantitySet)) {
                minimum_quantity -= this.options.getItemQuantitySet(item_id) || 0;
            }
            minimum_quantity = minimum_quantity <= 0 ? 1 : minimum_quantity;
            if (!_.isNumber(current_quantity) || _.isNaN(current_quantity) || current_quantity < minimum_quantity) {
                this.model.set('quantity', minimum_quantity);
                this.$('[name="quantity"]').val(minimum_quantity);
                this.$('[name="quantity"]').attr('min', minimum_quantity);
            }
        },
        childViews: {
            'ItemsSearcher': function () {
                return this.itemsSearcherComponent;
            }
        },
        getContext: function () {
            return {
                itemTitle: this.options.itemTitle || _('Which item(s) would you like to add?').translate(),
                quantityTitle: this.options.quantityTitle || _('Quantity').translate()
            };
        }
    });
});
define('QuickOrder.View', [
    'QuickAdd.View',
    'Backbone.CompositeView',
    'LiveOrder.Model',
    'quick_order.tpl',
    'Backbone',
    'underscore'
], function (QuickAddView, BackboneCompositeView, LiveOrderModel, quick_order_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: quick_order_tpl,
        initialize: function () {
            BackboneCompositeView.add(this);
            this.cart = LiveOrderModel.getInstance();
            this.quickAddViewComponent = new QuickAddView({
                getItemQuantitySet: _.bind(this.getItemQuantitySet, this),
                showBackorderable: false
            });
            this.quickAddViewComponent.on('selectedLine', this.addNewLine, this);
        },
        getItemQuantitySet: function (item_id) {
            var selected_line = this.cart.get('lines').find(function (line) {
                return line.get('item').id === item_id;
            });
            return selected_line ? parseInt(selected_line.get('quantity'), 10) : 0;
        },
        addNewLine: function (options) {
            this.cart.addLine(options.selectedLine);
        },
        childViews: {
            'QuickAddView': function () {
                return this.quickAddViewComponent;
            }
        },
        destroy: function () {
            this.quickAddViewComponent.off('selectedLine');
            this._destroy();
        },
        getContext: function () {
            return { showOpenedAccordion: !!this.options.openQuickOrder };
        }
    });
});
define('QuickOrder.EmptyCart.View', [
    'quick_order_empty_cart.tpl',
    'Backbone'
], function (quick_order_empty_cart_tpl, Backbone) {
    'use strict';
    return Backbone.View.extend({ template: quick_order_empty_cart_tpl });
});
define('QuickOrder', [
    'QuickOrder.View',
    'Cart.Detailed.View',
    'QuickOrder.EmptyCart.View'
], function (QuickOrderView, CartDetailedView, QuickOrderEmptyCartView) {
    'use strict';
    return {
        mountToApp: function () {
            CartDetailedView.addChildViews && CartDetailedView.addChildViews({
                'Quick.Order': function wrapperFunction(options) {
                    options = options || {};
                    options.urlOptions = options.urlOptions || {};
                    return function () {
                        return new QuickOrderView({ openQuickOrder: options.urlOptions.openQuickOrder === 'true' });
                    };
                }
            });
            CartDetailedView.addChildViews && CartDetailedView.addChildViews({
                'Quick.Order.EmptyCart': function wrapperFunction() {
                    return function () {
                        return new QuickOrderEmptyCartView({});
                    };
                }
            });
        }
    };
});
define('StoreLocatorAccessPoints.HeaderLink.View', [
    'ReferenceMap.Configuration',
    'storelocator_accesspoints_headerlink.tpl',
    'Backbone',
    'SC.Configuration'
], function (ReferenceConfiguration, storelocator_accesspoints_headerlink_tpl, Backbone, Configuration) {
    'use strict';
    return Backbone.View.extend({
        template: storelocator_accesspoints_headerlink_tpl,
        getContext: function () {
            return {
                title: ReferenceConfiguration.title(),
                hasClass: !!this.options.className,
                className: this.options.className,
                touchpoint: Configuration.get('siteSettings.isHttpsSupported') ? 'home' : 'storelocator'
            };
        }
    });
});
define('StoreLocatorAccessPoints', [
    'ReferenceMap.Configuration',
    'StoreLocatorAccessPoints.HeaderLink.View',
    'Header.View',
    'Header.Menu.View'
], function (ReferenceConfiguration, StoreLocatorWizardHeaderLinkView, HeaderView, HeaderMenuView) {
    'use strict';
    return {
        mountToApp: function () {
            if (!ReferenceConfiguration.isEnabled()) {
                return;
            }
            HeaderView.addChildViews && HeaderView.addChildViews({
                'StoreLocatorHeaderLink': function wrapperFunction() {
                    return function () {
                        return new StoreLocatorWizardHeaderLinkView({});
                    };
                }
            });
            HeaderMenuView.addChildViews && HeaderMenuView.addChildViews({
                'StoreLocatorHeaderLink': function wrapperFunction() {
                    return function () {
                        return new StoreLocatorWizardHeaderLinkView({ className: ' ' });
                    };
                }
            });
        }
    };
});
define('Newsletter.Model', [
    'underscore',
    'Backbone',
    'Utils'
], function (_, Backbone, Utils) {
    'use strict';
    return Backbone.Model.extend({
        urlRoot: Utils.getAbsoluteUrl('services/Newsletter.Service.ss'),
        email: '',
        validation: {
            email: [
                {
                    required: true,
                    msg: 'Enter an email address to subscribe'
                },
                {
                    pattern: 'email',
                    msg: 'Valid email address is required'
                }
            ]
        }
    });
});
define('Newsletter.View', [
    'Newsletter.Model',
    'SC.Configuration',
    'Backbone.FormView',
    'Backbone.CompositeView',
    'GlobalViews.Message.View',
    'newsletter.tpl',
    'Backbone',
    'underscore',
    'jQuery',
    'Utils'
], function (NewsletterModel, Configuration, BackboneFormView, BackboneCompositeView, GlobalViewsMessageView, newsletter_tpl, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: newsletter_tpl,
        events: { 'submit form': 'newsletterSubscribe' },
        bindings: { '[name="email"]': 'email' },
        feedback: {
            'OK': {
                'type': 'success',
                'message': _('Thank you! Welcome to our newsletter').translate()
            },
            'ERR_USER_STATUS_ALREADY_SUBSCRIBED': {
                'type': 'warning',
                'message': _('Sorry, the specified email is already subscribed.').translate()
            },
            'ERR_USER_STATUS_DISABLED': {
                'type': 'error',
                'message': _('Sorry, the specified email cannot be subscribed.').translate()
            },
            'ERROR': {
                'type': 'error',
                'message': _('Sorry, subscription cannot be done. Try again later.').translate()
            }
        },
        initialize: function initialize(options) {
            this.state = {
                'code': '',
                'message': '',
                'messageType': ''
            };
            this.application = options.application;
            BackboneCompositeView.add(this);
            BackboneFormView.add(this);
        },
        newsletterSubscribe: function newsletterSubscribe(e) {
            e.preventDefault();
            var self = this, promise = this.saveForm(e);
            if (promise) {
                promise.fail(function (jqXhr) {
                    jqXhr.preventDefault = true;
                    var errorCode = jqXhr && jqXhr.responseJSON && jqXhr.responseJSON.errorCode && self.feedback[jqXhr.responseJSON.errorCode] ? jqXhr.responseJSON.errorCode : 'ERROR';
                    self.state.code = errorCode;
                    self.state.message = self.feedback[errorCode].message;
                    self.state.messageType = self.feedback[errorCode].type;
                }).done(function () {
                    self.state.code = self.model.get('code');
                    self.state.message = self.feedback[self.model.get('code')].message;
                    self.state.messageType = self.feedback[self.model.get('code')].type;
                    self.model.set('email', '');
                }).always(_.bind(self.render, self));
            }
        },
        childViews: {
            'GlobalMessageFeedback': function () {
                return new GlobalViewsMessageView({
                    message: this.state.message,
                    type: this.state.messageType,
                    closable: true
                });
            }
        },
        getContext: function getContext() {
            return {
                isFeedback: !!this.state.code,
                model: this.model
            };
        }
    });
});
define('Newsletter', [
    'Footer.View',
    'Newsletter.Model',
    'Newsletter.View'
], function (FooterView, NewsletterModel, NewsletterView) {
    'use strict';
    return {
        mountToApp: function mountToApp(application) {
            FooterView.addChildViews && FooterView.addChildViews({
                'FooterContent': function wrapperFunction() {
                    return function () {
                        return new NewsletterView({
                            'model': new NewsletterModel(),
                            'application': application
                        });
                    };
                }
            });
        }
    };
});
define('ProductDetailToQuote.View', [
    'SC.Configuration',
    'Utils',
    'GlobalViews.Message.View',
    'ProductList.Model',
    'ProductList.Item.Model',
    'Profile.Model',
    'Session',
    'product_detail_to_quote.tpl',
    'Backbone.CompositeView',
    'Backbone',
    'underscore'
], function (Configuration, Utils, GlobalViewsMessageView, ProductListModel, ProductListItemModel, ProfileModel, Session, productDetailToQuote_tpl, BackboneCompositeView, Backbone, _) {
    'use strict';
    return Backbone.View.extend({
        template: productDetailToQuote_tpl,
        events: { 'click [data-type="add-to-quote"]': 'itemToQuote' },
        initialize: function initialize(options) {
            this.application = options.application;
            this.profile_promise = ProfileModel.getPromise();
            BackboneCompositeView.add(this);
            this.state = {
                feedbackMessage: '',
                quote_permissions: false,
                feedbackMessageType: 'warning'
            };
            this.model.on('change', this.render, this);
            this.once('afterViewRender', this.attachOnProfileModelEvents, this);
        },
        attachOnProfileModelEvents: function attachOnProfileModelEvents() {
            var self = this;
            this.profile_promise.done(function user_profile_done_loading() {
                self.profile_model = ProfileModel.getInstance();
                self.state.quote_permissions = SC.ENVIRONMENT.permissions.transactions.tranEstimate >= 2;
                self.render();
            });
        },
        destroy: function destroy() {
            this.model.off('change');
            return this._destroy();
        },
        itemToQuote: function itemToQuote(e) {
            var self = this;
            e.preventDefault();
            this.state.feedbackMessage = '';
            if (this.profile_model.get('isLoggedIn') === 'T' && !this.state.quote_permissions) {
                var phone = Configuration.get('quote.defaultPhone', ''), email = Configuration.get('quote.defaultEmail', '');
                this.state.feedbackMessageType = 'warning';
                this.state.feedbackMessage = _('Sorry, you don\'t have sufficient permissions to request a quote online. <br/> For immediate assistance <strong>call us at $(0)</strong> or email us to <strong>$(1)</strong>').translate(phone, email);
                this.render();
            } else {
                if (this.model.isSelectionComplete() && this.isQuotable() && this.validateLogin()) {
                    this.application.ProductListModule.Utils.getRequestAQuoteProductList().done(function (product_list_json) {
                        var product_list_line = ProductListItemModel.createFromProduct(self.model);
                        if (!product_list_json.internalid) {
                            var product_list_model = new ProductListModel(product_list_json);
                            product_list_model.save().done(function (product_list_json) {
                                self.addItemToQuote(product_list_json, product_list_line, self.model);
                            });
                        } else {
                            var product_list_line_json = product_list_line.toJSON(), item_present_in_list = _.find(product_list_json.items, function (product_list_line_aux) {
                                    return parseInt(product_list_line_aux.item.internalid) === product_list_line_json.item.internalid && _.isEqual(product_list_line_json.options, product_list_line_aux.options);
                                });
                            if (item_present_in_list) {
                                self.updateItemInQuote(item_present_in_list);
                            } else {
                                self.addItemToQuote(product_list_json, product_list_line, self.model);
                            }
                        }
                    });
                }
            }
        },
        addItemToQuote: function (product_list, product_list_line, product) {
            var quantity_to_add, self = this, show_enforced_quantity_message = false;
            if (product.get('item').get('_matrixParent').id) {
                product_list_line.set('item', product.get('item').get('_matrixParent'), { silent: true });
            }
            if (product.get('quantity') < product.get('_minimumQuantity')) {
                quantity_to_add = product.get('_minimumQuantity');
                show_enforced_quantity_message = true;
            } else {
                quantity_to_add = product.get('quantity');
            }
            product_list_line.set('productList', { id: product_list.internalid });
            product_list_line.set('quantity', quantity_to_add);
            product_list_line.save(null, { validate: false }).done(function (obj) {
                self.state.feedbackMessageType = 'success';
                var product_name = self.model.get('item').get('_name');
                product.set('pl_item_internalid', obj.internalid, { silent: true });
                if (show_enforced_quantity_message) {
                    self.state.feedbackMessage = _('$(0) has been added to your <a href="#" data-hashtag="#request-a-quote" data-touchpoint="customercenter" data-trigger="go-to-quote">Quote Request</a><br>Quantity: $(1). (Enforced minimum quantity)').translate(product_name, quantity_to_add);
                } else {
                    self.state.feedbackMessage = _('$(0) has been added to your <a href="#" data-hashtag="#request-a-quote" data-touchpoint="customercenter" data-trigger="go-to-quote">Quote Request</a><br>Quantity: $(1)').translate(product_name, quantity_to_add);
                }
                self.render();
            });
        },
        updateItemInQuote: function (item_in_list) {
            var self = this, quantity_to_add = this.model.get('quantity'), new_quantity = parseInt(item_in_list.quantity, 10) + parseInt(quantity_to_add, 10), product_list_item_model = new ProductListItemModel({ 'internalid': item_in_list.internalid });
            product_list_item_model.set('quantity', new_quantity);
            product_list_item_model.set('options', this.model.get('options'));
            product_list_item_model.save().done(function () {
                var product_name = self.model.get('item').get('_name');
                self.state.feedbackMessageType = 'success';
                self.state.feedbackMessage = _('$(0) has been added to your <a href="#" data-hashtag="#request-a-quote" data-touchpoint="customercenter" data-trigger="go-to-quote">Quote Request</a><br>Quantity: $(1)').translate(product_name, quantity_to_add);
                self.render();
            });
        },
        isQuotable: function () {
            return !(this.model.get('_itemType') === 'GiftCert' || this.model.get('_itemType') === 'Discount') && this.application.ProductListModule.Utils.isProductListEnabled();
        },
        validateLogin: function validateLogin() {
            if (this.profile_model.get('isLoggedIn') === 'T') {
                return true;
            }
            var params = {
                'origin': this.application.getConfig('currentTouchpoint'),
                'origin_hash': encodeURIComponent(this.model.generateURL())
            };
            window.location.href = Utils.addParamsToUrl(Session.get('touchpoints.login'), params);
            return false;
        },
        childViews: {
            'GlobalViews.FeedbackMessage': function () {
                var message = this.state.feedbackMessage;
                this.state.feedbackMessage = '';
                return new GlobalViewsMessageView({
                    message: message,
                    type: this.state.feedbackMessageType || 'success',
                    closable: true
                });
            }
        },
        getContext: function getContext() {
            return {
                isQuotable: this.isQuotable(),
                isLoading: this.profile_promise.state() === 'pending',
                isReadyForQuote: this.model.isSelectionComplete(),
                showMessage: !!this.state.feedbackMessage
            };
        }
    });
});
define('ProductDetailToQuote', [
    'ProductDetails.Full.View',
    'ProductDetails.QuickView.View',
    'ProductDetailToQuote.View'
], function (ProductDetailsFullView, ProductDetailsQuickViewView, ProductDetailToQuoteView) {
    'use strict';
    return {
        mountToApp: function mountToApp(application) {
            if (!SC.isPageGenerator()) {
                ProductDetailsFullView.addChildViews({
                    'ProductDetails.AddToQuote': function wrapperFunction(options) {
                        return function () {
                            return new ProductDetailToQuoteView({
                                'model': options.model,
                                'application': application
                            });
                        };
                    }
                });
                ProductDetailsQuickViewView.addChildViews({
                    'ProductDetails.AddToQuote': function wrapperFunction(options) {
                        return function () {
                            return new ProductDetailToQuoteView({
                                'model': options.model,
                                'application': application
                            });
                        };
                    }
                });
            }
        }
    };
});
define('StoreLocator.Map.View', [
    'underscore',
    'Backbone',
    'store_locator_map.tpl'
], function (_, Backbone, store_locator_map_tpl) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_map_tpl,
        initialize: function initialize(options) {
            this.application = options.application;
            this.reference_map = options.reference_map;
            this.model = options.model;
            this.collection = options.collection;
        },
        destroy: function destroy() {
            if (this.collection) {
                this.collection.off('sync, reset', this.updateMap, this);
            } else if (this.model) {
                this.model.off('change', this.updateMapDetails, this);
            }
            this.reference_map.off('change:position', this.updateMap, this);
            return this._destroy();
        },
        updateMap: function updateMap() {
            this.reference_map.clearPointList(this.map);
            var position = this.reference_map.getPosition();
            if (position && _.size(position) && !position.refineSearch) {
                this.reference_map.showMyPosition(position, this.map);
            } else {
                this.reference_map.centerMapToDefault(this.map);
            }
            if (this.collection.length) {
                this.reference_map.showPointList(this.collection, this.map);
                this.reference_map.fitBounds(this.map);
            }
        },
        updateMapDetails: function updateMapDetails() {
            this.reference_map.showPointWithoutInfoWindow(this.model, this.map);
        },
        render: function render() {
            if (this.reference_map) {
                this._render();
                var self = this;
                this.reference_map.load().done(function () {
                    self.mapInit();
                });
            }
        },
        mapInit: function mapInit() {
            this.map = this.reference_map.showMap(this.$('[data-type="map"]').get(0));
            if (this.model) {
                this.model.on('change', this.updateMapDetails, this);
                this.updateMapDetails();
            } else if (this.collection) {
                this.collection.on('sync, reset', this.updateMap, this);
                this.updateMap();
            }
            this.reference_map.on('change:position', this.updateMap, this);
        }
    });
});
define('StoreLocator.List.View', [
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'store_locator_list.tpl',
    'Backbone',
    'underscore',
    'SC.Configuration'
], function storeLocatorList(BackboneCompositeView, BackboneCollectionView, store_locator_list_tpl, Backbone, _, Configuration) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_list_tpl,
        events: { 'mouseover li': 'openMapInfoWindow' },
        initialize: function initialize(options) {
            this.reference_map = options.reference_map;
            this.index = options.index + 1;
            this.events = this.events || {};
            BackboneCompositeView.add(this);
        },
        openMapInfoWindow: function openMapInfoWindow() {
            if (this.reference_map.configuration.openPopupOnMouseOver() && !_.isPhoneDevice() && !_.isTabletDevice()) {
                var marker = _.findWhere(this.reference_map.points, { store_id: this.model.get('internalid') });
                this.reference_map.showInfoWindow(marker, this.model, this.index);
            }
        },
        getContext: function getContext() {
            return {
                storeName: this.model.get('name'),
                storeDistance: this.model.get('distance'),
                distanceUnit: this.model.get('distanceunit'),
                storeAddress: this.model.get('address1'),
                storeId: this.model.get('internalid'),
                index: this.index,
                model: this.model,
                touchpoint: Configuration.get('siteSettings.isHttpsSupported') ? 'home' : 'storelocator'
            };
        }
    });
});
define('StoreLocator.Results.View', [
    'store_locator_results.tpl',
    'StoreLocator.List.View',
    'StoreLocator.Map.View',
    'AjaxRequestsKiller',
    'SC.Configuration',
    'underscore',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'jQuery',
    'jQuery.scPush'
], function (store_locator_results_tpl, StoreLocatorListView, StoreLocatorMapView, AjaxRequestsKiller, Configuration, _, Backbone, BackboneCompositeView, BackboneCollectionView, jQuery) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_results_tpl,
        events: {
            'click [data-action="show-map"]': 'toggleView',
            'click [data-action="show-list"]': 'toggleView',
            'click [data-action="sc-pusher-dismiss"]': 'refineSearch'
        },
        initialize: function initialize(options) {
            this.application = options.application;
            this.reference_map = options.reference_map;
            this.collection = options.collection;
            this.isDevice = !!_.isPhoneDevice() || _.isTabletDevice();
            BackboneCompositeView.add(this);
            this.collection.on('reset', this.render, this);
            this.collection.on('reset', this.showPush, this);
        },
        refineSearch: function refineSearch(e) {
            e.preventDefault();
            this.collection.reset();
            this.reference_map.setPosition(null);
        },
        showPush: function showPush() {
            this.render();
            if (this.isDevice) {
                if (this.collection.length) {
                    this.$el.trigger('open');
                } else {
                    this.$el.trigger('close');
                }
            }
        },
        render: function render() {
            if (this.collection.length) {
                this._render();
                if (this.isDevice) {
                    this.$el.scPush();
                    this.toggleView();
                }
            } else {
                this.$el.empty();
            }
        },
        toggleView: function toggleView(e) {
            var $list_view = this.$('[data-type="list-view"]'), $map_view = this.$('[data-type="map-view"]'), $target = e && this.$(e.target);
            if ($target && $target.data('action') === 'show-map') {
                $list_view.hide();
                $map_view.show();
                this.$('[data-action="show-list"]').removeClass('active');
                this.$('[data-action="show-map"]').addClass('active');
                this.mapViewInstance.render();
                var $map = this.mapViewInstance.$('[data-type="map"]');
                $map.css('height', jQuery(window).innerHeight() - $map.position().top);
            } else {
                $map_view.hide();
                $list_view.show();
                this.$('[data-action="show-map"]').removeClass('active');
                this.$('[data-action="show-list"]').addClass('active');
            }
        },
        childViews: {
            'LocatorList': function () {
                return new BackboneCollectionView({
                    collection: this.collection,
                    childView: StoreLocatorListView,
                    childViewOptions: {
                        reference_map: this.reference_map,
                        isDevice: this.isDevice
                    }
                });
            },
            'ResultStoreLocatorMap': function () {
                this.mapViewInstance = new StoreLocatorMapView({
                    collection: this.collection,
                    application: this.application,
                    reference_map: this.reference_map
                });
                return this.mapViewInstance;
            }
        },
        getContext: function getContext() {
            var position = this.reference_map.getPosition();
            return {
                myposition: position && position.address ? position.address : '',
                totalStores: this.collection.length,
                showLocalizationMap: this.isDevice && this.reference_map.configuration.showLocalizationMap(),
                showMap: this.isDevice,
                touchpoint: Configuration.get('siteSettings.isHttpsSupported') ? 'home' : 'storelocator'
            };
        }
    });
});
define('StoreLocator.Main.View', [
    'Profile.Model',
    'StoreLocator.Map.View',
    'StoreLocator.Search.View',
    'StoreLocator.Results.View',
    'SC.Configuration',
    'store_locator_main.tpl',
    'underscore',
    'Backbone.CompositeView',
    'Backbone'
], function (ProfileModel, StoreLocatorMapView, StoreLocatorSearchView, StoreLocatorResultsView, Configuration, store_locator_main_tpl, _, BackboneCompositeView, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_main_tpl,
        events: { 'click [data-action="refine-search"]': 'refineSearch' },
        initialize: function initialize(options) {
            this.application = options.application;
            this.reference_map = options.reference_map;
            this.reference_map.collection = this.collection;
            this.profileModel = ProfileModel.getInstance();
            this.title = this.reference_map.configuration.title();
            BackboneCompositeView.add(this);
        },
        destroy: function destroy() {
            if (Backbone.history.getFragment().split('/')[1] !== 'details') {
                this.profileModel.unset('storeLocator_last_search');
            }
            this._destroy();
        },
        childViews: {
            'StoreLocatorMap': function () {
                return new StoreLocatorMapView({
                    collection: this.collection,
                    application: this.application,
                    reference_map: this.reference_map
                });
            },
            'StoreLocatorResults': function () {
                return new StoreLocatorResultsView({
                    collection: this.collection,
                    application: this.application,
                    reference_map: this.reference_map,
                    profileModel: this.profileModel
                });
            },
            'StoreLocatorSearch': function () {
                return new StoreLocatorSearchView({
                    collection: this.collection,
                    application: this.application,
                    reference_map: this.reference_map,
                    profileModel: this.profileModel,
                    useGeolocation: window.location.protocol === 'https:'
                });
            }
        },
        getContext: function getContext() {
            return {
                title: this.reference_map.configuration.title,
                touchpoint: Configuration.get('siteSettings.isHttpsSupported') ? 'home' : 'storelocator'
            };
        }
    });
});
define('StoreLocator.Details.View', [
    'StoreLocator.Map.View',
    'Location.VenueDetails.View',
    'ReferenceMap',
    'store_locator_details.tpl',
    'underscore',
    'Backbone.CompositeView',
    'Backbone',
    'Profile.Model'
], function (StoreLocatorMapView, LocationVenueDetailsView, ReferenceMap, store_locator_details_tpl, _, BackboneCompositeView, Backbone, ProfileModel) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_details_tpl,
        initialize: function initialize(options) {
            this.reference_map = options.reference_map;
            this.model = options.model;
            this.reference_map.model = this.model;
            this.application = options.application;
            this.profile_model = ProfileModel.getInstance();
            this.title = this.reference_map.configuration.title();
            BackboneCompositeView.add(this);
        },
        childViews: {
            'LocatorMap': function () {
                return new StoreLocatorMapView({
                    application: this.application,
                    reference_map: this.reference_map,
                    model: this.model
                });
            },
            'StoreLocationInfo': function () {
                return new LocationVenueDetailsView({
                    application: this.application,
                    model: this.model,
                    showAddress: true
                });
            }
        },
        getContext: function getContext() {
            var last_navigation = this.profile_model.get('storeLocator_last_search'), direction_url = this.reference_map.getDirectionsUrl(last_navigation, this.model.get('location'));
            return {
                title: this.reference_map.configuration.title,
                directionUrl: direction_url,
                redirectUrl: !!last_navigation ? 'stores' : 'stores/all'
            };
        }
    });
});
define('StoreLocator.List.All.Store.View', [
    'Backbone.CompositeView',
    'Backbone.CollectionView',
    'store_locator_list_all_store.tpl',
    'SC.Configuration',
    'Backbone'
], function (BackboneCompositeView, BackboneCollectionView, store_locator_list_all_store_tpl, Configuration, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_list_all_store_tpl,
        initialize: function initialize(options) {
            this.index = options.index;
            BackboneCompositeView.add(this);
        },
        getContext: function getContext() {
            return {
                name: this.model.get('name'),
                storeId: this.model.get('internalid'),
                touchpoint: Configuration.get('siteSettings.isHttpsSupported') ? 'home' : 'storelocator'
            };
        }
    });
});
define('StoreLocator.List.All.View', [
    'store_locator_list_all.tpl',
    'StoreLocator.List.All.Store.View',
    'GlobalViews.Pagination.View',
    'underscore',
    'Backbone',
    'Backbone.CompositeView',
    'Backbone.CollectionView'
], function (store_locator_list_all_tpl, StoreLocatorListAllStore, GlobalViewsPaginationView, _, Backbone, BackboneCompositeView, BackboneCollectionView) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_list_all_tpl,
        initialize: function initialize(options) {
            this.configuration = options.configuration;
            this.collection = options.collection;
            this.title = this.configuration.title();
            BackboneCompositeView.add(this);
            this.collection.on('reset', this.render, this);
        },
        childViews: {
            'StoreLocatorListAllStoreView': function () {
                return new BackboneCollectionView({
                    collection: this.collection,
                    childView: StoreLocatorListAllStore
                });
            },
            'GlobalViews.Pagination': function () {
                return new GlobalViewsPaginationView(_.extend({ totalPages: Math.ceil(this.collection.totalRecordsFound / this.configuration.showAllStoresRecordsPerPage()) || 0 }));
            }
        },
        getContext: function getContext() {
            return { showList: !!this.collection.length };
        }
    });
});
define('StoreLocator.Upgrade.View', [
    'store_locator_upgrade.tpl',
    'Backbone'
], function (store_locator_upgrade, Backbone) {
    'use strict';
    return Backbone.View.extend({
        template: store_locator_upgrade,
        initialize: function initialize(options) {
            this.application = options.application;
        }
    });
});
define('StoreLocator.Router', [
    'AjaxRequestsKiller',
    'Backbone',
    'Profile.Model',
    'StoreLocator.Model',
    'StoreLocator.Collection',
    'StoreLocator.Main.View',
    'StoreLocator.Details.View',
    'StoreLocator.List.All.View',
    'StoreLocator.Upgrade.View',
    'SC.Configuration',
    'ReferenceMap',
    'ReferenceMap.Configuration',
    'Utils'
], function (AjaxRequestsKiller, Backbone, ProfileModel, StoreLocatorModel, StoreLocatorCollection, StoreLocatorMainView, StoreLocatorDetaisView, StoreLocatorListAllView, StoreLocatorUpgradeView, Configuration, ReferenceMap, ReferenceConfiguration, Utils) {
    'use strict';
    return Backbone.Router.extend({
        routes: function routes() {
            if (Utils.oldIE(8)) {
                return {
                    'stores': 'browserUpgrade',
                    'stores/details/:id': 'browserUpgrade',
                    'stores/all': 'browserUpgrade',
                    'stores/all?:options': 'browserUpgrade'
                };
            } else {
                return {
                    'stores': 'storeLocatorStores',
                    'stores/details/:id': 'storeLocatorDetails',
                    'stores/all': 'storeLocatorListAll',
                    'stores/all?:options': 'storeLocatorListAll'
                };
            }
        },
        initialize: function initialize(application) {
            this.application = application;
        },
        storeLocatorStores: function storeLocatorStores() {
            var view = new StoreLocatorMainView({
                application: this.application,
                collection: new StoreLocatorCollection(),
                reference_map: new ReferenceMap()
            });
            view.showContent();
        },
        storeLocatorListAll: function storeLocatorListAll(options) {
            options = options ? SC.Utils.parseUrlOptions(options) : { page: 1 };
            options.page = options.page || 1;
            var collection = new StoreLocatorCollection(), view = new StoreLocatorListAllView({
                    application: this.application,
                    collection: collection,
                    configuration: ReferenceConfiguration
                });
            collection.update({
                sort: 'namenohierarchy',
                page: options.page,
                results_per_page: ReferenceConfiguration.showAllStoresRecordsPerPage(),
                killerId: AjaxRequestsKiller.getKillerId(),
                reset: true,
                locationtype: Configuration.get('storeLocator.defaultTypeLocations')
            });
            view.showContent();
        },
        storeLocatorDetails: function storeLocatorDetails(id) {
            var model = new StoreLocatorModel(), reference_map = new ReferenceMap(), view = new StoreLocatorDetaisView({
                    application: this.application,
                    model: model,
                    reference_map: reference_map
                });
            model.fetch({
                data: { internalid: id },
                killerId: AjaxRequestsKiller.getKillerId()
            }).done(function () {
                view.showContent();
            });
        },
        browserUpgrade: function browserUpgrade() {
            var view = new StoreLocatorUpgradeView({ application: this.application });
            view.showContent();
        }
    });
});
define('StoreLocator', [
    'ReferenceMap.Configuration',
    'StoreLocator.Router',
    'SC.Configuration',
    'Utils',
    'underscore'
], function (ReferenceConfiguration, Router, Configuration, Utils, _) {
    'use strict';
    return {
        mountToApp: function mountToApp(application) {
            var configurationIcons = [
                'storeLocator.icons.stores',
                'storeLocator.icons.position',
                'storeLocator.icons.autocomplete'
            ];
            _.each(configurationIcons, function (property) {
                if (Utils.getPathFromObject(Configuration, property, '')) {
                    Utils.setPathFromObject(Configuration, property, _.getAbsoluteUrlOfNonManagedResources(Utils.getPathFromObject(Configuration, property, '')));
                }
            });
            if (ReferenceConfiguration.isEnabled() && window.location.protocol === 'https:') {
                return new Router(application);
            }
        }
    };
});
define('CustomContentType.Base.View', [
    'Backbone',
    'underscore',
    'jQuery'
], function (Backbone, _, jQuery) {
    'use strict';
    var CustomContentTypeBaseView = Backbone.View.extend({
        contextDataRequest: [],
        initialize: function initialize(options) {
            this._initialize(options);
        },
        install: function install(settings, context_data) {
            return this._install(settings, context_data);
        },
        _install: function _install(settings, context_data) {
            this.settings = settings;
            this.contextData = context_data;
            return jQuery.Deferred().resolve();
        },
        validateContextDataRequest: function (context_data) {
            return _.keys(context_data).length === this.contextDataRequest.length;
        },
        getContextDataRequest: function () {
            return this.contextDataRequest.slice();
        },
        update: function update(settings) {
            return this._update(settings);
        },
        _update: function _update(settings) {
            this.settings = settings;
            return jQuery.Deferred().resolve();
        },
        destroy: function destroy() {
            this._destroy();
            return jQuery.Deferred().resolve();
        },
        getContext: function getContext() {
            return { settings: this.settings };
        }
    });
    CustomContentTypeBaseView.beforeInitialize.install({
        name: 'customContentTypeBaseViewInit',
        priority: 1,
        execute: function () {
            this.settings = {};
            this.instanceId = this.options.instanceId;
            this.id = this.options.id;
        }
    });
    return CustomContentTypeBaseView;
});
define('SC.CCT.Html.View', [
    'CustomContentType.Base.View',
    'sc_cct_html.tpl'
], function (CustomContentTypeBaseView, sc_cct_html_tpl) {
    'use strict';
    return CustomContentTypeBaseView.extend({
        template: sc_cct_html_tpl,
        getContext: function getContext() {
            return {
                htmlString: this.settings.html_string,
                hasHtmlString: !!this.settings.html_string
            };
        }
    });
});
define('SC.CCT.Html', ['SC.CCT.Html.View'], function (SCCCTHtmlView) {
    'use strict';
    return {
        mountToApp: function mountToApp(application) {
            var component = application.getComponent('CMS');
            if (!component) {
                return;
            }
            component.registerCustomContentType({
                id: 'CMS',
                view: SCCCTHtmlView
            });
        }
    };
});
define('CaseBucket.View', [
    'Backbone',
    'casebucket.tpl'
], function (Backbone, casebucket_tpl) {
    'use strict';
    return Backbone.View.extend({ template: casebucket_tpl });
});
define('CaseBucket.Details.View', [
    'Backbone',
    'casebucket_details.tpl'
], function (Backbone, Template) {
    'use strict';
    return Backbone.View.extend({
        template: Template,
        getContext: function () {
            debugger;
            return {
                name: this.model.get('name'),
                email: this.model.get('email')
            };
        }
    });
});
define('CaseBucket.List.View', [
    'Backbone',
    'Backbone.CollectionView',
    'GlobalViews.Confirmation.View',
    'CaseBucket.Details.View',
    'casebucket_list.tpl'
], function (Backbone, CollectionView, ConfirmationView, DetailsView, Template) {
    'use strict';
    return Backbone.View.extend({
        attributes: { 'class': 'casebucket-container' },
        childViews: {
            'CaseBucket.Collection': function () {
                return new CollectionView({
                    'childView': DetailsView,
                    'collection': this.collection,
                    'viewsPerRow': 1
                });
            }
        },
        events: { 'click button[data-action="remove"]': 'removeRecord' },
        getBreadcrumbPages: function () {
            return [{
                    text: _('Example SuiteScript').translate(),
                    href: '/casebucket'
                }];
        },
        initialize: function (options) {
            this.options = options;
            this.application = options.application;
            var self = this;
            this.collection.on('reset sync add remove change destroy', function () {
                self.render();
            });
        },
        removeModel: function (options) {
            var model = options.context.collection.get(options.id);
            model.destroy();
        },
        removeRecord: function (e) {
            e.preventDefault();
            var view = new ConfirmationView({
                title: _.translate('Remove Favorite Thing'),
                body: _.translate('Are you sure you want to remove this favorite thing?'),
                callBack: this.removeModel,
                callBackParameters: {
                    context: this,
                    id: jQuery(e.target).data('id')
                },
                autohide: true
            });
            this.application.getLayout().showInModal(view);
        },
        template: Template,
        title: _('Example SuiteScript Page').translate()
    });
});
define('CaseBucket.Model', [
    'Backbone',
    'underscore',
    'Utils'
], function (Backbone, _) {
    'use strict';
    return Backbone.Model.extend({ urlRoot: _.getAbsoluteUrl('services/CaseBucket.Service.ss') });
});
define('CaseBucket.Collection', [
    'Backbone',
    'CaseBucket.Model',
    'Utils'
], function (Backbone, Model, Utils) {
    'use strict';
    console.log(Model);
    return Backbone.Collection.extend({
        url: Utils.getAbsoluteUrl('services/CaseBucket.Service.ss'),
        model: Model
    });
});
define('CaseBucket.Router', [
    'CaseBucket.View',
    'CaseBucket.List.View',
    'Backbone',
    'CaseBucket.Model',
    'CaseBucket.Collection'
], function (CaseBucketView, CaseBucketListView, Backbone, CaseBucketModel, CaseBucketCollection) {
    'use strict';
    return Backbone.Router.extend({
        routes: {
            'casebucket': 'caseBucket',
            'casebucketlist': 'caseBucketList'
        },
        initialize: function (application) {
            this.application = application;
            this.options = options;
        },
        caseBucket: function () {
            new CaseBucketView({ application: this.application }).showContent();
        },
        caseBucketList: function () {
            var collection = new CaseBucketCollection(), view = new CaseBucketListView({
                    collection: collection,
                    application: this.application
                });
            collection.fetch().done(function () {
                view.showContent();
            });
        }
    });
});
define('CaseBucket', [
    'CaseBucket.Router',
    'underscore'
], function (Router, _) {
    'use strict';
    return {
        mountToApp: function (application) {
            return new Router(application);
        }
    };
});
define('SC.Shopping.Starter.Dependencies', [
    'GoogleMap',
    'GoogleMap.Configuration',
    'Backbone.View.Plugins',
    'Location',
    'jQuery.html',
    'PickupInStore',
    'ProductDetails',
    'Shopping.Profile',
    'NavigationHelper',
    'NavigationHelper.Plugins.Standard',
    'NavigationHelper.Plugins.DataTouchPoint',
    'NavigationHelper.Plugins.Modals',
    'NavigationHelper.Plugins.Pushers',
    'Item',
    'ProductViews',
    'Transaction.Line.Views',
    'Cart',
    'Content',
    'Categories',
    'Facets',
    'GoogleUniversalAnalytics',
    'GoogleTagManager',
    'Home',
    'PromocodeSupport',
    'ItemRelations',
    'RecentlyViewedItems',
    'SocialSharing',
    'SocialSharing.Plugins.Facebook',
    'SocialSharing.Plugins.Twitter',
    'SocialSharing.Plugins.GooglePlus',
    'SocialSharing.Plugins.Pinterest',
    'SocialSharing.Plugins.Pinterest.Hover',
    'SocialSharing.Plugins.AddThis',
    'ProductReviews',
    'AjaxRequestsKiller',
    'CookieWarningBanner',
    'ImageNotAvailable',
    'ErrorManagement',
    'Merchandising',
    'Merchandising.Context.DefaultHandlers',
    'ProductList',
    'UrlHelper',
    'CMSadapterInstaller',
    'RequestQuoteAccessPoints',
    'QuickOrderAccessPoints',
    'BrontoIntegration',
    'Sensors',
    'QuantityPricing',
    'QuickOrder',
    'StoreLocatorAccessPoints',
    'Newsletter',
    'ProductDetailToQuote',
    'StoreLocator',
    'SC.CCT.Html',
    'CaseBucket',
    'CaseBucket.List.View',
    'CaseBucket.Details.View'
], function (a0, a1, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12, a13, a14, a15, a16, a17, a18, a19, a20, a21, a22, a23, a24, a25, a26, a27, a28, a29, a30, a31, a32, a33, a34, a35, a36, a37, a38, a39, a40, a41, a42, a43, a44, a45, a46, a47, a48, a49, a50, a51, a52, a53, a54, a55, a56) {
    return Array.prototype.slice.call(arguments);
});
define('SC.Extensions', ['underscore'], function (_) {
    'use strict';
    if (SC && SC.extensionModules) {
        return _.map(SC.extensionModules, function (appModuleName) {
            try {
                return require(appModuleName);
            } catch (error) {
                console.error(error);
            }
        });
    }
    return [];
});
define('SC.Shopping.Starter', [
    'SC.Shopping',
    'jQuery',
    'underscore',
    'Backbone',
    'SC.Shopping.Starter.Dependencies',
    'SC.Extensions'
], function (Shopping, jQuery, _, Backbone, entryPointModules, entryPointExtensionsModules) {
    'use strict';
    entryPointModules = entryPointModules.concat(entryPointExtensionsModules);
    function startShopping() {
        if (SC.isCrossOrigin()) {
            jQuery('noscript').each(function () {
                jQuery(this).parent().append(jQuery(this).text());
            });
            return;
        }
        Shopping.getConfig().siteSettings = SC.ENVIRONMENT.siteSettings || {};
        if (SC.isPageGenerator()) {
            jQuery.ajaxSetup({ async: false });
        }
        jQuery.fn.modal.Constructor.BACKDROP_TRANSITION_DURATION = 0;
        Shopping.start(entryPointModules, function () {
            if (SC.ENVIRONMENT.contextError) {
                Shopping.getLayout().$('#site-header').hide();
                Shopping.getLayout().$('#site-footer').hide();
                Shopping.getLayout().internalError(SC.ENVIRONMENT.contextError.errorMessage, 'Error ' + SC.ENVIRONMENT.contextError.errorStatusCode + ': ' + SC.ENVIRONMENT.contextError.errorCode);
            } else {
                var fragment = _.parseUrlOptions(location.search).fragment;
                if (fragment && !location.hash) {
                    location.hash = decodeURIComponent(fragment);
                }
                if (Shopping.getUser) {
                    Shopping.getUser().done(function () {
                        Backbone.history.start({ pushState: !SC.isDevelopment && SC.ENVIRONMENT.jsEnvironment === 'browser' });
                    });
                } else {
                    Backbone.history.start({ pushState: !SC.isDevelopment && SC.ENVIRONMENT.jsEnvironment === 'browser' });
                }
            }
            Shopping.getLayout().appendToDom();
        });
    }
    jQuery(document).ready(startShopping);
});
require.config({
    'paths': {
        'jQuery': 'jquery-1.11.1.custom',
        'jasmine-ajax': 'mock-ajax',
        'Backbone': 'backbone.custom',
        'Backbone.Validation': 'backbone-validation',
        'jQuery.bxSlider': 'jquery.bxslider.custom',
        'Handlebars': 'handlebars.runtime-v4.0.10',
        'typeahead': 'typeahead.bundle'
    },
    'shim': {
        'jQuery': { 'exports': 'jQuery' },
        'json2': { 'exports': 'JSON' },
        'jquery.zoom': { 'deps': ['jQuery'] },
        'jQuery.bxSlider': { 'deps': ['jQuery'] },
        'bootstrap': { 'deps': ['jQuery'] },
        'bootstrap-datepicker': {
            'deps': [
                'jQuery',
                'bootstrap'
            ]
        },
        'Backbone.Validation': { 'deps': ['Backbone'] },
        'typeahead': { 'deps': ['jQuery'] }
    },
    'map': { 'jquery.cookie': { 'jquery': 'jQuery' } },
    'findNestedDependencies': true
});
require(['SC.Shopping.Starter']);
define('SC.Shopping.Starter.index', ['SC.Shopping.Starter'], function () {
    return;
});